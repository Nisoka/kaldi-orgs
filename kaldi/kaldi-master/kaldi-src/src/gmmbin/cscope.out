cscope 15 /nwork/svn/ai/sr/kaldi/src/gmmbin               0000290750
	@gmm-acc-mllt-global.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
	~"ŒªsfÜm/mÎt.h
"

28 
	~"hmm/po¡”iÜ.h
"

31 
	$maš
(
¬gc
, *
¬gv
[]) {

32 
usšg
 
Çme¥aû
 
k®di
;

33 
Œy
 {

34 cÚ¡ *
u§ge
 =

41 
P¬£O±iÚs
 
	`po
(
u§ge
);

42 
boŞ
 
bš¬y
 = 
Œue
;

43 
Ba£Flßt
 
¿nd_´uÃ
 = 0.25;

44 
¡d
::
¡ršg
 
g£Ëù_r¥ecif›r
;

45 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

46 
po
.
	`Regi¡”
("¿nd-´uÃ", &
¿nd_´uÃ
, "Randomized…runing…arametero speed up "

48 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "Rspecifier for Gaussian selection "

50 
po
.
	`R—d
(
¬gc
, 
¬gv
);

52 ià(
po
.
	`NumArgs
() != 3) {

53 
po
.
	`PrštU§ge
();

54 
	`ex™
(1);

57 
¡d
::
¡ršg
 
gmm_f’ame
 = 
po
.
	`G‘Arg
(1),

58 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

59 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(3);

61 
usšg
 
Çme¥aû
 
k®di
;

62 
k®di
::
	tšt32
 int32;

64 
DŸgGmm
 
gmm
;

65 
	`R—dK®diObjeù
(
gmm_f’ame
, &
gmm
);

67 
MÎtAccs
 
	`mÎt_accs
(
gmm
.
	`Dim
(), 
¿nd_´uÃ
);

69 
tÙ_like
 = 0.0;

70 
tÙ_t
 = 0.0;

72 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

73 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

75 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

76 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

77 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

78 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

80 
num_dÚe
++;

81 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0, 
tÙ_weight
 = 0.0;

83 ià(
g£Ëù_r¥ecif›r
 == "") {

84 
št32
 
i
 = 0; i < 
m©
.
	`NumRows
(); i++) {

85 
tÙ_like_this_fe
 +ğ
mÎt_accs
.
	`AccumuÏ‹FromGmm
(
gmm
, 
m©
.
	`Row
(
i
), 1.0);

86 
tÙ_weight
 += 1.0;

89 ià(!
g£Ëù_»ad”
.
	`HasKey
(
u‰
)) {

90 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
u‰
;

91 
num_”r
++;

94 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
ğ
g£Ëù_»ad”
.
	`V®ue
(
u‰
);

95 ià(
¡©ic_ÿ¡
<
št32
>(
g£Ëù
.
	`size
()è!ğ
m©
.
	`NumRows
()) {

96 
KALDI_WARN
 << "Gselect information has wrong size for utterance "

97 << 
u‰
 << ", " << 
g£Ëù
.
	`size
() << " vs. "

98 << 
m©
.
	`NumRows
();

99 
num_”r
++;

103 
št32
 
i
 = 0; i < 
m©
.
	`NumRows
(); i++) {

104 
tÙ_like_this_fe
 +ğ
mÎt_accs
.
	`AccumuÏ‹FromGmmP»£Ëù
(

105 
gmm
, 
g£Ëù
[
i
], 
m©
.
	`Row
(i), 1.0);

106 
tÙ_weight
 += 1.0;

109 
KALDI_LOG
 << "Average†ike forhis file is "

110 << (
tÙ_like_this_fe
/
tÙ_weight
) << " over "

111 << 
tÙ_weight
 << " frames.";

112 
tÙ_like
 +ğ
tÙ_like_this_fe
;

113 
tÙ_t
 +ğ
tÙ_weight
;

114 ià(
num_dÚe
 % 10 == 0)

115 
KALDI_LOG
 << "Avg†ike…er frame so far is "

116 << (
tÙ_like
/
tÙ_t
);

119 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " files. ";

121 
KALDI_LOG
 << "Overall‡vg†ike…er frame (Gaussian only) = "

122 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

124 
	`Wr™eK®diObjeù
(
mÎt_accs
, 
accs_wxf’ame
, 
bš¬y
);

125 
KALDI_LOG
 << "Written‡ccs.";

126  (
num_dÚe
 != 0 ? 0 : 1);

127 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

128 
¡d
::
û¼
 << 
e
.
	`wh©
();

131 
	}
}

	@gmm-acc-mllt.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"ŒªsfÜm/mÎt.h
"

27 
	~"hmm/po¡”iÜ.h
"

30 
	$maš
(
¬gc
, *
¬gv
[]) {

31 
usšg
 
Çme¥aû
 
k®di
;

32 
Œy
 {

33 cÚ¡ *
u§ge
 =

39 
P¬£O±iÚs
 
	`po
(
u§ge
);

40 
boŞ
 
bš¬y
 = 
Œue
;

41 
Ba£Flßt
 
¿nd_´uÃ
 = 0.25;

42 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

43 
po
.
	`Regi¡”
("¿nd-´uÃ", &
¿nd_´uÃ
, "Randomized…runing…arametero speed up "

45 
po
.
	`R—d
(
¬gc
, 
¬gv
);

47 ià(
po
.
	`NumArgs
() != 4) {

48 
po
.
	`PrštU§ge
();

49 
	`ex™
(1);

52 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

53 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

54 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

55 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(4);

57 
usšg
 
Çme¥aû
 
k®di
;

58 
k®di
::
	tšt32
 int32;

60 
AmDŸgGmm
 
am_gmm
;

61 
T¿ns™iÚMod–
 
Œªs_mod–
;

63 
boŞ
 
bš¬y
;

64 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

65 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

66 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

69 
MÎtAccs
 
	`mÎt_accs
(
am_gmm
.
	`Dim
(), 
¿nd_´uÃ
);

71 
tÙ_like
 = 0.0;

72 
tÙ_t
 = 0.0;

74 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

75 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

77 
št32
 
num_dÚe
 = 0, 
num_no_po¡”iÜ
 = 0, 
num_Ùh”_”rÜ
 = 0;

78 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

79 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

80 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

81 
num_no_po¡”iÜ
++;

83 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

84 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

86 ià(
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
()è!ğ
m©
.
	`NumRows
()) {

87 
KALDI_WARN
 << "Po¡”iÜ veùÜ ha wrÚg siz"<< (
po¡”iÜ
.
	`size
()è<< " vs. "<< (
m©
.
	`NumRows
());

88 
num_Ùh”_”rÜ
++;

92 
num_dÚe
++;

93 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0, 
tÙ_weight
 = 0.0;

95 
Po¡”iÜ
 
pdf_po¡”iÜ
;

96 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

97 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

98 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

99 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

100 
Ba£Flßt
 
weight
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

102 
tÙ_like_this_fe
 +ğ
mÎt_accs
.
	`AccumuÏ‹FromGmm
(
am_gmm
.
	`G‘Pdf
(
pdf_id
),

103 
m©
.
	`Row
(
i
),

104 
weight
) * weight;

105 
tÙ_weight
 +ğ
weight
;

108 
KALDI_LOG
 << "Average†ike forhis file is "

109 << (
tÙ_like_this_fe
/
tÙ_weight
) << " over "

110 << 
tÙ_weight
 << " frames.";

111 
tÙ_like
 +ğ
tÙ_like_this_fe
;

112 
tÙ_t
 +ğ
tÙ_weight
;

113 ià(
num_dÚe
 % 10 == 0)

114 
KALDI_LOG
 << "Avg†ike…er frame so far is "

115 << (
tÙ_like
/
tÙ_t
);

119 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡”iÜ


120 << " w™h‚Øpo¡”iÜs, " << 
num_Ùh”_”rÜ


123 
KALDI_LOG
 << "Overall‡vg†ike…er frame (Gaussian only) = "

124 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

126 
	`Wr™eK®diObjeù
(
mÎt_accs
, 
accs_wxf’ame
, 
bš¬y
);

127 
KALDI_LOG
 << "Written‡ccs.";

128  (
num_dÚe
 != 0 ? 0 : 1);

129 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

130 
¡d
::
û¼
 << 
e
.
	`wh©
();

133 
	}
}

	@gmm-acc-stats-ali.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/mË-am-dŸg-gmm.h
"

30 
	$maš
(
¬gc
, *
¬gv
[]) {

31 
usšg
 
Çme¥aû
 
k®di
;

32 
k®di
::
	tšt32
 int32;

33 
Œy
 {

34 cÚ¡ *
u§ge
 =

40 
P¬£O±iÚs
 
	`po
(
u§ge
);

41 
boŞ
 
bš¬y
 = 
Œue
;

42 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

43 
po
.
	`R—d
(
¬gc
, 
¬gv
);

45 ià(
po
.
	`NumArgs
() != 4) {

46 
po
.
	`PrštU§ge
();

47 
	`ex™
(1);

50 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

51 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

52 
®ignm’ts_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

53 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(4);

55 
AmDŸgGmm
 
am_gmm
;

56 
T¿ns™iÚMod–
 
Œªs_mod–
;

58 
boŞ
 
bš¬y
;

59 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

60 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

61 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

64 
VeùÜ
<> 
Œªs™iÚ_accs
;

65 
Œªs_mod–
.
	`In™Sts
(&
Œªs™iÚ_accs
);

66 
AccumAmDŸgGmm
 
gmm_accs
;

67 
gmm_accs
.
	`In™
(
am_gmm
, 
kGmmAÎ
);

69 
tÙ_like
 = 0.0;

70 
k®di
::
št64
 
tÙ_t
 = 0;

72 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

73 
RªdomAcûssIÁ32VeùÜR—d”
 
	`®ignm’ts_»ad”
(
®ignm’ts_r¥ecif›r
);

75 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

76 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

77 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

78 ià(!
®ignm’ts_»ad”
.
	`HasKey
(
key
)) {

79 
KALDI_WARN
 << "NØ®ignm’ˆfÜ u‰”ªû " << 
key
;

80 
num_”r
++;

82 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

83 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
®ignm’t
 = 
®ignm’ts_»ad”
.
	`V®ue
(
key
);

85 ià(
®ignm’t
.
	`size
(è!ğ
m©
.
	`NumRows
()) {

86 
KALDI_WARN
 << "Alignm’t ha wrÚg siz" << (
®ignm’t
.
	`size
())

87 << " vs. " << (
m©
.
	`NumRows
());

88 
num_”r
++;

92 
num_dÚe
++;

93 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0;

95 
size_t
 
i
 = 0; i < 
®ignm’t
.
	`size
(); i++) {

96 
št32
 
tid
 = 
®ignm’t
[
i
],

97 
pdf_id
 = 
Œªs_mod–
.
	`T¿ns™iÚIdToPdf
(
tid
);

98 
Œªs_mod–
.
	`AccumuÏ‹
(1.0, 
tid
, &
Œªs™iÚ_accs
);

99 
tÙ_like_this_fe
 +ğ
gmm_accs
.
	`AccumuÏ‹FÜGmm
(
am_gmm
, 
m©
.
	`Row
(
i
),

100 
pdf_id
, 1.0);

102 
tÙ_like
 +ğ
tÙ_like_this_fe
;

103 
tÙ_t
 +ğ
®ignm’t
.
	`size
();

104 ià(
num_dÚe
 % 50 == 0) {

105 
KALDI_LOG
 << "Proûs£d " << 
num_dÚe
 << " utterances; for utterance "

106 << 
key
 << "‡vg.†ike is "

107 << (
tÙ_like_this_fe
/
®ignm’t
.
	`size
())

108 << " ov” " << 
®ignm’t
.
	`size
() <<" frames.";

112 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


115 
KALDI_LOG
 << "Overall‡vg†ike…er frame (Gaussian only) = "

116 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

119 
Ouut
 
	`ko
(
accs_wxf’ame
, 
bš¬y
);

120 
Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

121 
gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

123 
KALDI_LOG
 << "Written‡ccs.";

124 ià(
num_dÚe
 != 0)

128 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

129 
¡d
::
û¼
 << 
e
.
	`wh©
();

132 
	}
}

	@gmm-acc-stats-twofeats.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
	~"gmm/mË-am-dŸg-gmm.h
"

28 
	~"hmm/po¡”iÜ.h
"

31 
	$maš
(
¬gc
, *
¬gv
[]) {

32 
usšg
 
Çme¥aû
 
k®di
;

33 
Œy
 {

34 cÚ¡ *
u§ge
 =

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

43 
boŞ
 
bš¬y
 = 
Œue
;

44 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

45 
po
.
	`R—d
(
¬gc
, 
¬gv
);

47 ià(
po
.
	`NumArgs
() != 5) {

48 
po
.
	`PrštU§ge
();

49 
	`ex™
(1);

52 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

53 
ã©u»1_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

54 
ã©u»2_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

55 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

56 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(5);

58 
usšg
 
Çme¥aû
 
k®di
;

59 
k®di
::
	tšt32
 int32;

61 
AmDŸgGmm
 
am_gmm
;

62 
T¿ns™iÚMod–
 
Œªs_mod–
;

64 
boŞ
 
bš¬y
;

65 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

66 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

67 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

70 
VeùÜ
<> 
Œªs™iÚ_accs
;

71 
Œªs_mod–
.
	`In™Sts
(&
Œªs™iÚ_accs
);

72 
št32
 
Ãw_dim
 = 0;

73 
AccumAmDŸgGmm
 
gmm_accs
;

76 
tÙ_like
 = 0.0;

77 
tÙ_t
 = 0.0;

79 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»1_»ad”
(
ã©u»1_r¥ecif›r
);

80 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»2_»ad”
(
ã©u»2_r¥ecif›r
);

81 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

83 
št32
 
num_dÚe
 = 0, 
num_no2ndã©s
 = 0, 
num_no_po¡”iÜ
 = 0, 
num_Ùh”_”rÜ
 = 0;

84 ; !
ã©u»1_»ad”
.
	`DÚe
(); f—tu»1_»ad”.
	`Next
()) {

85 
¡d
::
¡ršg
 
key
 = 
ã©u»1_»ad”
.
	`Key
();

86 ià(!
ã©u»2_»ad”
.
	`HasKey
(
key
)) {

87 
KALDI_WARN
 << "FÜ u‰”ªû " << 
key
 << ", second features‚ot…resent.";

88 
num_no2ndã©s
 ++;

89 } ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

90 
num_no_po¡”iÜ
++;

92 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©1
 = 
ã©u»1_»ad”
.
	`V®ue
();

93 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©2
 = 
ã©u»2_»ad”
.
	`V®ue
(
key
);

94 
	`KALDI_ASSERT
(
m©1
.
	`NumRows
(è=ğ
m©2
.NumRows());

95 ià(
Ãw_dim
 == 0) {

96 
Ãw_dim
 = 
m©2
.
	`NumCŞs
();

97 
gmm_accs
.
	`In™
(
am_gmm
, 
Ãw_dim
, 
kGmmAÎ
);

99 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

101 ià(
po¡”iÜ
.
	`size
(è!ğ
m©1
.
	`NumRows
()) {

102 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz"<< (
po¡”iÜ
.
	`size
()è<< " vs. "<< (
m©1
.
	`NumRows
());

103 
num_Ùh”_”rÜ
++;

106 ià(
m©1
.
	`NumRows
(è!ğ
m©2
.NumRows()) {

107 
KALDI_WARN
 << "Features have mismatched‚umbers of frames "

108 << 
m©1
.
	`NumRows
(è<< " vs. " << 
m©2
.NumRows();

109 
num_Ùh”_”rÜ
++;

113 
num_dÚe
++;

114 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0,

115 
tÙ_weight_this_fe
 = 0.0;

117 
Po¡”iÜ
 
pdf_po¡”iÜ
;

118 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

119 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

121 
size_t
 
j
 = 0; j <
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

122 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

123 
Ba£Flßt
 
weight
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

124 
tÙ_like_this_fe
 +ğ
weight
 *

125 
gmm_accs
.
	`AccumuÏ‹FÜGmmTwoã©s
(
am_gmm
,

126 
m©1
.
	`Row
(
i
),

127 
m©2
.
	`Row
(
i
),

128 
pdf_id
,

129 
weight
);

130 
tÙ_weight_this_fe
 +ğ
weight
;

134 
size_t
 
j
 = 0; j < 
po¡”iÜ
[
i
].
	`size
(); j++) {

135 
št32
 
tid
 = 
po¡”iÜ
[
i
][
j
].
fœ¡
;

136 
Ba£Flßt
 
weight
 = 
po¡”iÜ
[
i
][
j
].
£cÚd
;

137 
Œªs_mod–
.
	`AccumuÏ‹
(
weight
, 
tid
, &
Œªs™iÚ_accs
);

140 
KALDI_LOG
 << "Average†ike forhis file is "

141 << (
tÙ_like_this_fe
/
tÙ_weight_this_fe
) << " over "

142 << 
tÙ_weight_this_fe
 <<" frames.";

143 
tÙ_like
 +ğ
tÙ_like_this_fe
;

144 
tÙ_t
 +ğ
tÙ_weight_this_fe
;

145 ià(
num_dÚe
 % 10 == 0)

146 
KALDI_LOG
 << "Avg†ik³¸äamsØç¸i " << (
tÙ_like
/
tÙ_t
);

150 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡”iÜ


151 << " w™h‚Øpo¡”iÜs, " << 
num_no2ndã©s


152 << " w™h‚Ø£cÚd f—tu»s, " << 
num_Ùh”_”rÜ


155 
KALDI_LOG
 << "Overall‡vg†ike…er frame (Gaussian only) = "

156 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

159 
Ouut
 
	`ko
(
accs_wxf’ame
, 
bš¬y
);

160 
Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

161 
gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

163 
KALDI_LOG
 << "Written‡ccs.";

164 ià(
num_dÚe
 != 0)  0;

166 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

167 
¡d
::
û¼
 << 
e
.
	`wh©
();

170 
	}
}

	@gmm-acc-stats.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"gmm/mË-am-dŸg-gmm.h
"

27 
	~"hmm/po¡”iÜ.h
"

30 
	$maš
(
¬gc
, *
¬gv
[]) {

31 
usšg
 
Çme¥aû
 
k®di
;

32 
k®di
::
	tšt32
 int32;

33 
Œy
 {

34 cÚ¡ *
u§ge
 =

41 
P¬£O±iÚs
 
	`po
(
u§ge
);

42 
boŞ
 
bš¬y
 = 
Œue
;

43 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvwt";

45 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

46 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameters will be "

48 
po
.
	`R—d
(
¬gc
, 
¬gv
);

50 ià(
po
.
	`NumArgs
() != 4) {

51 
po
.
	`PrštU§ge
();

52 
	`ex™
(1);

55 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

56 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

57 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

58 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(4);

61 
AmDŸgGmm
 
am_gmm
;

62 
T¿ns™iÚMod–
 
Œªs_mod–
;

64 
boŞ
 
bš¬y
;

65 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

66 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

67 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

70 
VeùÜ
<> 
Œªs™iÚ_accs
;

71 
Œªs_mod–
.
	`In™Sts
(&
Œªs™iÚ_accs
);

72 
AccumAmDŸgGmm
 
gmm_accs
;

73 
gmm_accs
.
	`In™
(
am_gmm
, 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
));

75 
tÙ_like
 = 0.0;

76 
tÙ_t
 = 0.0;

78 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

79 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

81 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

82 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

83 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

84 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

85 
KALDI_WARN
 << "Could‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
key
;

86 
num_”r
++;

88 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

89 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

91 ià(
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
()è!ğ
m©
.
	`NumRows
()) {

92 
KALDI_WARN
 << "Posterior vector has wrong size "

93 << (
po¡”iÜ
.
	`size
()) << " vs. "

94 << (
m©
.
	`NumRows
());

95 
num_”r
++;

99 
num_dÚe
++;

100 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0, 
tÙ_weight
 = 0.0;

102 
Po¡”iÜ
 
pdf_po¡”iÜ
;

103 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

104 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

106 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

107 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

108 
Ba£Flßt
 
weight
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

109 
tÙ_like_this_fe
 +ğ
gmm_accs
.
	`AccumuÏ‹FÜGmm
(
am_gmm
, 
m©
.
	`Row
(
i
), 
pdf_id
, 
weight
)

110 * 
weight
;

111 
tÙ_weight
 +ğ
weight
;

115 
size_t
 
j
 = 0; j < 
po¡”iÜ
[
i
].
	`size
(); j++) {

116 
št32
 
tid
 = 
po¡”iÜ
[
i
][
j
].
fœ¡
;

117 
Ba£Flßt
 
weight
 = 
po¡”iÜ
[
i
][
j
].
£cÚd
;

118 
Œªs_mod–
.
	`AccumuÏ‹
(
weight
, 
tid
, &
Œªs™iÚ_accs
);

121 ià(
num_dÚe
 % 50 == 0) {

122 
KALDI_LOG
 << "Proûs£d " << 
num_dÚe
 << " utterances; for utterance "

123 << 
key
 << "‡vg.†iki " << (
tÙ_like_this_fe
/
tÙ_weight
)

124 << " ov” " << 
tÙ_weight
 <<" frames.";

126 
tÙ_like
 +ğ
tÙ_like_this_fe
;

127 
tÙ_t
 +ğ
tÙ_weight
;

131 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


134 
KALDI_LOG
 << "Overall‡vg†ike…er frame (Gaussian only) = "

135 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

138 
Ouut
 
	`ko
(
accs_wxf’ame
, 
bš¬y
);

139 
Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

140 
gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

142 
KALDI_LOG
 << "Written‡ccs.";

143  (
num_dÚe
 != 0 ? 0 : 1);

144 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

145 
¡d
::
û¼
 << 
e
.
	`wh©
();

148 
	}
}

	@gmm-acc-stats2.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/mË-am-dŸg-gmm.h
"

26 
	~"hmm/po¡”iÜ.h
"

29 
	$maš
(
¬gc
, *
¬gv
[]) {

30 
usšg
 
Çme¥aû
 
k®di
;

31 
k®di
::
	tšt32
 int32;

32 
k®di
::
	tšt64
 int64;

33 
Œy
 {

34 cÚ¡ *
u§ge
 =

43 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
boŞ
 
bš¬y
 = 
Œue
;

45 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvwt";

47 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write stats in binary mode");

48 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameterso "

50 
po
.
	`R—d
(
¬gc
, 
¬gv
);

52 ià(
po
.
	`NumArgs
() != 5) {

53 
po
.
	`PrštU§ge
();

54 
	`ex™
(1);

57 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

58 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

59 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

60 
num_accs_wxf’ame
 = 
po
.
	`G‘Arg
(4),

61 
d’_accs_wxf’ame
 = 
po
.
	`G‘Arg
(5);

64 
AmDŸgGmm
 
am_gmm
;

65 
T¿ns™iÚMod–
 
Œªs_mod–
;

67 
boŞ
 
bš¬y
;

68 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

69 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

70 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

73 
VeùÜ
<> 
num_Œªs_accs
, 
d’_Œªs_accs
;

74 
Œªs_mod–
.
	`In™Sts
(&
num_Œªs_accs
);

75 
Œªs_mod–
.
	`In™Sts
(&
d’_Œªs_accs
);

76 
AccumAmDŸgGmm
 
num_gmm_accs
, 
d’_gmm_accs
;

77 
num_gmm_accs
.
	`In™
(
am_gmm
, 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
));

78 
d’_gmm_accs
.
	`In™
(
am_gmm
, 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
));

80 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

81 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

84 
Ba£Flßt
 
tÙ_like
 = 0.0, 
tÙ_weight
 = 0.0;

88 
št64
 
tÙ_äames
 = 0.0;

90 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

91 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

92 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

93 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

94 
num_”r
++;

96 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

97 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

99 ià(
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
()è!ğ
m©
.
	`NumRows
()) {

100 
KALDI_WARN
 << "Posterior vector has wrong size "

101 << (
po¡”iÜ
.
	`size
()) << " vs. "

102 << (
m©
.
	`NumRows
());

103 
num_”r
++;

107 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0, 
tÙ_weight_this_fe
 = 0.0;

109 
num_dÚe
++;

110 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

111 
size_t
 
j
 = 0; j < 
po¡”iÜ
[
i
].
	`size
(); j++) {

112 
št32
 
tid
 = 
po¡”iÜ
[
i
][
j
].
fœ¡
,

113 
pdf_id
 = 
Œªs_mod–
.
	`T¿ns™iÚIdToPdf
(
tid
);

114 
Ba£Flßt
 
weight
 = 
po¡”iÜ
[
i
][
j
].
£cÚd
;

115 
Œªs_mod–
.
	`AccumuÏ‹
(
	`çbs
(
weight
), 
tid
,

116 (
weight
 > 0.0 ?

117 &
num_Œªs_accs
 : &
d’_Œªs_accs
));

118 
tÙ_like_this_fe
 +=

119 (
weight
 > 0.0 ? &
num_gmm_accs
 : &
d’_gmm_accs
) ->

120 
	`AccumuÏ‹FÜGmm
(
am_gmm
, 
m©
.
	`Row
(
i
), 
pdf_id
, 
	`çbs
(
weight
)) * weight;

121 
tÙ_weight_this_fe
 +ğ
weight
;

124 
tÙ_like
 +ğ
tÙ_like_this_fe
;

125 
tÙ_weight
 +ğ
tÙ_weight_this_fe
;

126 
tÙ_äames
 +ğ
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
());

130 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


133 
KALDI_LOG
 << "Overall weighted‡coustic†ikelihood…er frame was "

134 << (
tÙ_like
/
tÙ_äames
) << " over " <<ot_frames << " frames;"

135 << "‡v”agweighˆ³¸äamwa " << (
tÙ_weight
 / 
tÙ_äames
);

138 
Ouut
 
	`ko
(
num_accs_wxf’ame
, 
bš¬y
);

139 
num_Œªs_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

140 
num_gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

143 
Ouut
 
	`ko
(
d’_accs_wxf’ame
, 
bš¬y
);

144 
d’_Œªs_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

145 
d’_gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

147 
KALDI_LOG
 << "Written‡ccs.";

148  (
num_dÚe
 != 0 ? 0 : 1);

149 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

150 
¡d
::
û¼
 << 
e
.
	`wh©
();

153 
	}
}

	@gmm-adapt-map.cc

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"ba£/k®di-commÚ.h
"

26 
	~"ut/commÚ-uts.h
"

27 
	~"gmm/am-dŸg-gmm.h
"

28 
	~"hmm/Œªs™iÚ-mod–.h
"

29 
	~"gmm/mË-am-dŸg-gmm.h
"

30 
	~"hmm/po¡”iÜ.h
"

32 
	$maš
(
¬gc
, *
¬gv
[]) {

33 
Œy
 {

34 
k®di
::
	tšt32
 int32;

35 
usšg
 
Çme¥aû
 
k®di
;

36 cÚ¡ *
u§ge
 =

44 
P¬£O±iÚs
 
	`po
(
u§ge
);

45 
¡d
::
¡ršg
 
¥k2u‰_r¥ecif›r
;

46 
boŞ
 
bš¬y
 = 
Œue
;

47 
M­DŸgGmmO±iÚs
 
m­_cÚfig
;

48 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mw";

50 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

52 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

53 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameters will be "

55 
m­_cÚfig
.
	`Regi¡”
(&
po
);

57 
po
.
	`R—d
(
¬gc
, 
¬gv
);

59 ià(
po
.
	`NumArgs
() != 4) {

60 
po
.
	`PrštU§ge
();

61 
	`ex™
(1);

64 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

65 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

66 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

67 
m­_am_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

69 
GmmFÏgsTy³
 
upd©e_æags
 = 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
);

71 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

72 
M­AmDŸgGmmWr™”
 
	`m­_am_wr™”
(
m­_am_w¥ecif›r
);

74 
AmDŸgGmm
 
am_gmm
;

75 
T¿ns™iÚMod–
 
Œªs_mod–
;

77 
boŞ
 
bš¬y
;

78 
IÅut
 
	`is
(
mod–_f’ame
, &
bš¬y
);

79 
Œªs_mod–
.
	`R—d
(
is
.
	`SŒ—m
(), 
bš¬y
);

80 
am_gmm
.
	`R—d
(
is
.
	`SŒ—m
(), 
bš¬y
);

83 
tÙ_like
 = 0.0, 
tÙ_like_chªge
 = 0.0, 
tÙ_t
 = 0.0,

84 
tÙ_t_check
 = 0.0;

85 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

87 ià(
¥k2u‰_r¥ecif›r
 != "") {

88 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

89 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

90 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

91 
¡d
::
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

92 
AmDŸgGmm
 
cİy_am_gmm
;

93 
cİy_am_gmm
.
	`CİyFromAmDŸgGmm
(
am_gmm
);

94 
AccumAmDŸgGmm
 
m­_accs
;

95 
m­_accs
.
	`In™
(
am_gmm
, 
upd©e_æags
);

97 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

100 
¡d
::
veùÜ
<¡d::
¡ršg
>::
cÚ¡_™”©Ü
 
™”
 = 
u‰li¡
.
	`begš
(),

101 
’d
 = 
u‰li¡
.
	`’d
();

102 ; 
™”
 !ğ
’d
; ++iter) {

103 
¡d
::
¡ršg
 
u‰
 = *
™”
;

104 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

105 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

108 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
u‰
)) {

109 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

110 
num_”r
++;

113 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

114 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
u‰
);

115 ià(
po¡”iÜ
.
	`size
(è!ğ
ã©s
.
	`NumRows
()) {

116 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡”iÜ
.
	`size
())

117 << " vs. " << (
ã©s
.
	`NumRows
());

118 
num_”r
++;

122 
Ba£Flßt
 
fe_like
 = 0.0, 
fe_t
 = 0.0;

123 
Po¡”iÜ
 
pdf_po¡”iÜ
;

124 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

125  
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++ ) {

126  
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++ ) {

127 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

128 
Ba£Flßt
 
weight
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

129 
fe_like
 +ğ
m­_accs
.
	`AccumuÏ‹FÜGmm
(
cİy_am_gmm
,

130 
ã©s
.
	`Row
(
i
),

131 
pdf_id
, 
weight
);

132 
fe_t
 +ğ
weight
;

136 
	`KALDI_VLOG
(2è<< "Av”aglikfÜ u‰”ªû " << 
u‰
 << " is "

137 << (
fe_like
/
fe_t
) << " over " << file_t << " frames.";

139 
tÙ_like
 +ğ
fe_like
;

140 
tÙ_t
 +ğ
fe_t
;

141 
num_dÚe
++;

143 ià(
num_dÚe
 % 10 == 0)

144 
	`KALDI_VLOG
(1) << "Avg†ike…er frame so far is "

145 << (
tÙ_like
 / 
tÙ_t
);

149 
Ba£Flßt
 
¥k_objf_chªge
 = 0.0, 
¥k_äames
 = 0.0;

150 
	`M­AmDŸgGmmUpd©e
(
m­_cÚfig
, 
m­_accs
, 
upd©e_æags
, &
cİy_am_gmm
,

151 &
¥k_objf_chªge
, &
¥k_äames
);

152 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ", objective function change "

153 << "äom MAP wa " << (
¥k_objf_chªge
 / 
¥k_äames
)

154 << " ov” " << 
¥k_äames
 << " frames.";

155 
tÙ_like_chªge
 +ğ
¥k_objf_chªge
;

156 
tÙ_t_check
 +ğ
¥k_äames
;

159 
m­_am_wr™”
.
	`Wr™e
(
¥k
,
cİy_am_gmm
);

162 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

163  ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
() ) {

164 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

165 
AmDŸgGmm
 
cİy_am_gmm
;

166 
cİy_am_gmm
.
	`CİyFromAmDŸgGmm
(
am_gmm
);

167 
AccumAmDŸgGmm
 
m­_accs
;

168 
m­_accs
.
	`In™
(
am_gmm
, 
upd©e_æags
);

169 
m­_accs
.
	`S‘Z”o
(
upd©e_æags
);

171 iàĞ!
po¡”iÜs_»ad”
.
	`HasKey
(
u‰
) ) {

172 
KALDI_WARN
 << "Did‚ot find‡lignedranscription for utterance "

173 << 
u‰
;

174 
num_”r
++;

177 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

178 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
u‰
);

180 iàĞ
po¡”iÜ
.
	`size
(è!ğ
ã©s
.
	`NumRows
() ) {

181 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡”iÜ
.
	`size
())

182 << " vs. " << (
ã©s
.
	`NumRows
());

183 
num_”r
++;

186 
num_dÚe
++;

187 
Ba£Flßt
 
fe_like
 = 0.0, 
fe_t
 = 0.0;

188 
Po¡”iÜ
 
pdf_po¡”iÜ
;

189 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

190  
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++ ) {

191  
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++ ) {

192 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

193 
Ba£Flßt
 
´ob
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

194 
fe_like
 +ğ
m­_accs
.
	`AccumuÏ‹FÜGmm
(
cİy_am_gmm
,
ã©s
.
	`Row
(
i
),

195 
pdf_id
, 
´ob
);

196 
fe_t
 +ğ
´ob
;

199 
	`KALDI_VLOG
(2è<< "Av”aglikfÜ u‰”ªû " << 
u‰
 << " is "

200 << (
fe_like
/
fe_t
) << " over " << file_t << " frames.";

201 
tÙ_like
 +ğ
fe_like
;

202 
tÙ_t
 +ğ
fe_t
;

203 iàĞ
num_dÚe
 % 10 == 0 )

204 
	`KALDI_VLOG
(1) << "Avg†ike…er frame so far is "

205 << (
tÙ_like
 / 
tÙ_t
);

208 
Ba£Flßt
 
u‰_objf_chªge
 = 0.0, 
u‰_äames
 = 0.0;

209 
	`M­AmDŸgGmmUpd©e
(
m­_cÚfig
, 
m­_accs
, 
upd©e_æags
, &
cİy_am_gmm
,

210 &
u‰_objf_chªge
, &
u‰_äames
);

211 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ", objective function change "

212 << "äom MAP wa " << (
u‰_objf_chªge
 / 
u‰_äames
)

213 << " ov” " << 
u‰_äames
 << " frames.";

214 
tÙ_like_chªge
 +ğ
u‰_objf_chªge
;

215 
tÙ_t_check
 +ğ
u‰_äames
;

218 
m­_am_wr™”
.
	`Wr™e
(
ã©u»_»ad”
.
	`Key
(), 
cİy_am_gmm
);

221 
	`KALDI_ASSERT
(
	`AµroxEqu®
(
tÙ_t
, 
tÙ_t_check
));

222 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


224 
KALDI_LOG
 << "Ov”®Èacou¡iølik–ihood wa " << (
tÙ_like
 / 
tÙ_t
)

226 << (
tÙ_like_chªge
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

227  (
num_dÚe
 != 0 ? 0 : 1);

228 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

229 
¡d
::
û¼
 << 
e
.
	`wh©
();

232 
	}
}

	@gmm-align-compiled.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"hmm/hmm-uts.h
"

27 
	~"f¡ext/f¡ext-lib.h
"

28 
	~"decod”/decod”-w¿µ”s.h
"

29 
	~"gmm/decodabË-am-dŸg-gmm.h
"

30 
	~"Ït/k®di-Ï‰iû.h
"

32 
	$maš
(
¬gc
, *
¬gv
[]) {

33 
Œy
 {

34 
usšg
 
Çme¥aû
 
k®di
;

35 
k®di
::
	tšt32
 int32;

36 
usšg
 
f¡
::
SymbŞTabË
;

37 
usšg
 
f¡
::
VeùÜF¡
;

38 
usšg
 
f¡
::
StdArc
;

40 cÚ¡ *
u§ge
 =

50 
P¬£O±iÚs
 
	`po
(
u§ge
);

51 
AlignCÚfig
 
®ign_cÚfig
;

52 
Ba£Flßt
 
acou¡ic_sÿË
 = 1.0;

53 
Ba£Flßt
 
Œªs™iÚ_sÿË
 = 1.0;

54 
Ba£Flßt
 
£lf_loİ_sÿË
 = 1.0;

55 
¡d
::
¡ršg
 
³r_äame_acwt_w¥ecif›r
;

57 
®ign_cÚfig
.
	`Regi¡”
(&
po
);

58 
po
.
	`Regi¡”
("Œªs™iÚ-sÿË", &
Œªs™iÚ_sÿË
,

60 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

62 
po
.
	`Regi¡”
("£lf-loİ-sÿË", &
£lf_loİ_sÿË
,

64 
po
.
	`Regi¡”
("wr™e-³r-äame-acou¡ic-loglikes", &
³r_äame_acwt_w¥ecif›r
,

67 
po
.
	`R—d
(
¬gc
, 
¬gv
);

69 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 5) {

70 
po
.
	`PrštU§ge
();

71 
	`ex™
(1);

74 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

75 
f¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

76 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

77 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘Arg
(4),

78 
scÜes_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(5);

80 
T¿ns™iÚMod–
 
Œªs_mod–
;

81 
AmDŸgGmm
 
am_gmm
;

83 
boŞ
 
bš¬y
;

84 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

85 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

86 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

89 
Sequ’tŸlTabËR—d”
<
f¡
::
VeùÜF¡HŞd”
> 
	`f¡_»ad”
(
f¡_r¥ecif›r
);

90 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

91 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

92 
Ba£FlßtWr™”
 
	`scÜes_wr™”
(
scÜes_w¥ecif›r
);

93 
Ba£FlßtVeùÜWr™”
 
	`³r_äame_acwt_wr™”
(
³r_äame_acwt_w¥ecif›r
);

95 
num_dÚe
 = 0, 
num_”r
 = 0, 
num_»Œy
 = 0;

96 
tÙ_like
 = 0.0;

97 
k®di
::
št64
 
äame_couÁ
 = 0;

99 ; !
f¡_»ad”
.
	`DÚe
(); f¡_»ad”.
	`Next
()) {

100 
¡d
::
¡ršg
 
u‰
 = 
f¡_»ad”
.
	`Key
();

101 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

102 
num_”r
++;

103 
KALDI_WARN
 << "NØã©u» fÜ u‰”ªû " << 
u‰
;

105 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©u»s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

106 
VeùÜF¡
<
StdArc
> 
	`decode_f¡
(
f¡_»ad”
.
	`V®ue
());

107 
f¡_»ad”
.
	`F»eCu¼’t
();

111 ià(
ã©u»s
.
	`NumRows
() == 0) {

112 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

113 
num_”r
++;

118 
¡d
::
veùÜ
<
št32
> 
di§mbig_syms
;

119 
	`AddT¿ns™iÚProbs
(
Œªs_mod–
, 
di§mbig_syms
,

120 
Œªs™iÚ_sÿË
, 
£lf_loİ_sÿË
,

121 &
decode_f¡
);

124 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

125 
acou¡ic_sÿË
);

127 
KALDI_LOG
 << 
u‰
;

128 
	`AlignU‰”ªûW¿µ”
(
®ign_cÚfig
, 
u‰
,

129 
acou¡ic_sÿË
, &
decode_f¡
, &
gmm_decodabË
,

130 &
®ignm’t_wr™”
, &
scÜes_wr™”
,

131 &
num_dÚe
, &
num_”r
, &
num_»Œy
,

132 &
tÙ_like
, &
äame_couÁ
, &
³r_äame_acwt_wr™”
);

135 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
)

136 << " ov” " << 
äame_couÁ
<< " frames.";

137 
KALDI_LOG
 << "R‘r›d " << 
num_»Œy
 << " out of "

138 << (
num_dÚe
 + 
num_”r
) << " utterances.";

139 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << ",ƒ¼Ü Ú " << 
num_”r
;

140  (
num_dÚe
 != 0 ? 0 : 1);

141 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

142 
¡d
::
û¼
 << 
e
.
	`wh©
();

145 
	}
}

	@gmm-align.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"f¡ext/f¡ext-uts.h
"

26 
	~"decod”/decod”-w¿µ”s.h
"

27 
	~"decod”/Œaššg-g¿ph-comp”.h
"

28 
	~"gmm/decodabË-am-dŸg-gmm.h
"

29 
	~"Ït/k®di-Ï‰iû.h
"

32 
	$maš
(
¬gc
, *
¬gv
[]) {

33 
Œy
 {

34 
usšg
 
Çme¥aû
 
k®di
;

35 
k®di
::
	tšt32
 int32;

36 
usšg
 
f¡
::
SymbŞTabË
;

37 
usšg
 
f¡
::
VeùÜF¡
;

38 
usšg
 
f¡
::
StdArc
;

40 cÚ¡ *
u§ge
 =

47 
P¬£O±iÚs
 
	`po
(
u§ge
);

48 
AlignCÚfig
 
®ign_cÚfig
;

49 
Ba£Flßt
 
acou¡ic_sÿË
 = 1.0;

50 
¡d
::
¡ršg
 
di§mbig_rxf’ame
;

51 
T¿ššgG¿phComp”O±iÚs
 
gİts
;

53 
®ign_cÚfig
.
	`Regi¡”
(&
po
);

54 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
, "Scaling factor for‡coustic†ikelihoods");

55 
po
.
	`Regi¡”
("»ad-di§mbig-syms", &
di§mbig_rxf’ame
, "File containing "

58 
gİts
.
	`Regi¡”
(&
po
);

59 
po
.
	`R—d
(
¬gc
, 
¬gv
);

61 ià(
po
.
	`NumArgs
() != 6) {

62 
po
.
	`PrštU§ge
();

63 
	`ex™
(1);

66 
¡d
::
¡ršg
 
Œ“_š_f’ame
 = 
po
.
	`G‘Arg
(1);

67 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(2);

68 
¡d
::
¡ršg
 
Ëx_š_f’ame
 = 
po
.
	`G‘Arg
(3);

69 
¡d
::
¡ršg
 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(4);

70 
¡d
::
¡ršg
 
Œªsüt_r¥ecif›r
 = 
po
.
	`G‘Arg
(5);

71 
¡d
::
¡ršg
 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘Arg
(6);

73 
CÚ‹xtD•’d’cy
 
ùx_d•
;

74 
	`R—dK®diObjeù
(
Œ“_š_f’ame
, &
ùx_d•
);

76 
T¿ns™iÚMod–
 
Œªs_mod–
;

77 
AmDŸgGmm
 
am_gmm
;

79 
boŞ
 
bš¬y
;

80 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

81 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

82 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

86 
VeùÜF¡
<
StdArc
> *
Ëx_f¡
 = 
f¡
::
	`R—dF¡K®di
(
Ëx_š_f’ame
);

88 
¡d
::
veùÜ
<
št32
> 
di§mbig_syms
;

89 ià(
di§mbig_rxf’ame
 != "")

90 ià(!
	`R—dIÁeg”VeùÜSim¶e
(
di§mbig_rxf’ame
, &
di§mbig_syms
))

91 
KALDI_ERR
 << "fstcomposecontext: Could‚ot„ead disambiguation symbols from "

92 << 
di§mbig_rxf’ame
;

94 
T¿ššgG¿phComp”
 
	`gc
(
Œªs_mod–
, 
ùx_d•
, 
Ëx_f¡
, 
di§mbig_syms
,

95 
gİts
);

97 
Ëx_f¡
 = 
NULL
;

99 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

100 
RªdomAcûssIÁ32VeùÜR—d”
 
	`Œªsüt_»ad”
(
Œªsüt_r¥ecif›r
);

101 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

103 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0, 
num_»Œy
 = 0;

104 
tÙ_like
 = 0.0;

105 
k®di
::
št64
 
äame_couÁ
 = 0;

106 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

107 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

108 ià(!
Œªsüt_»ad”
.
	`HasKey
(
u‰
)) {

109 
KALDI_WARN
 << "NØŒªsüˆfound fÜ u‰”ªû " << 
u‰
;

110 
num_”r
++;

114 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©u»s
 = 
ã©u»_»ad”
.
	`V®ue
();

115 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
Œªsüt
 = 
Œªsüt_»ad”
.
	`V®ue
(
u‰
);

117 
VeùÜF¡
<
StdArc
> 
decode_f¡
;

118 ià(!
gc
.
	`CompeG¿phFromText
(
Œªsüt
, &
decode_f¡
)) {

119 
KALDI_WARN
 << "Problem creating decoding graph for utterance "

120 << 
u‰
 <<" [seriousƒrror]";

121 
num_”r
++;

124 ià(
ã©u»s
.
	`NumRows
() == 0) {

125 
KALDI_WARN
 << "Z”o-Ëngth f—tu» fÜ u‰”ªû: " << 
u‰
;

126 
num_”r
++;

130 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

131 
acou¡ic_sÿË
);

134 
	`AlignU‰”ªûW¿µ”
(
®ign_cÚfig
, 
u‰
,

135 
acou¡ic_sÿË
, &
decode_f¡
, &
gmm_decodabË
,

136 &
®ignm’t_wr™”
, 
NULL
,

137 &
num_dÚe
, &
num_”r
, &
num_»Œy
,

138 &
tÙ_like
, &
äame_couÁ
);

140 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
)

141 << " ov” " << 
äame_couÁ
<< " frames.";

142 
KALDI_LOG
 << "R‘r›d " << 
num_»Œy
 << " out of "

143 << (
num_dÚe
 + 
num_”r
) << " utterances.";

144 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << ",ƒ¼Ü Ú " << 
num_”r
;

145  (
num_dÚe
 != 0 ? 0 : 1);

146 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

147 
¡d
::
û¼
 << 
e
.
	`wh©
();

150 
	}
}

	@gmm-basis-fmllr-accs-gpost.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
	~"ŒªsfÜm/basis-fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

34 
Çme¥aû
 
	gk®di
 {

35 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

36 cÚ¡ 
GaussPo¡
 &
gpo¡
,

37 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

38 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

39 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

40 
size_t
 
	gi
 = 0; i < 
	ggpo¡
.
size
(); i++) {

41 
size_t
 
	gj
 = 0; j < 
	ggpo¡
[
i
].
size
(); j++) {

42 
št32
 
	gpdf_id
 = 
gpo¡
[
i
][
j
].
fœ¡
;

43 cÚ¡ 
	gVeùÜ
<
	gBa£Flßt
> & 
po¡”iÜ
(
gpo¡
[
i
][
j
].
£cÚd
);

44 
	g¥k_¡©s
->
AccumuÏ‹FromPo¡”iÜs
(
am_gmm
.
G‘Pdf
(
pdf_id
),

45 
ã©s
.
Row
(
i
), 
po¡”iÜ
);

53 
	$maš
(
¬gc
, *
¬gv
[]) {

54 
Œy
 {

55 
k®di
::
	tšt32
 int32;

56 
usšg
 
Çme¥aû
 
k®di
;

57 cÚ¡ *
u§ge
 =

65 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

66 
¡ršg
 
¥k2u‰_r¥ecif›r
;

67 
P¬£O±iÚs
 
	`po
(
u§ge
);

68 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

69 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

72 
po
.
	`R—d
(
¬gc
, 
¬gv
);

73 ià(
po
.
	`NumArgs
() != 4) {

74 
po
.
	`PrštU§ge
();

75 
	`ex™
(1);

78 
¡ršg


79 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

80 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

81 
gpo¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

82 
accs_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

84 
T¿ns™iÚMod–
 
Œªs_mod–
;

85 
AmDŸgGmm
 
am_gmm
;

87 
boŞ
 
bš¬y
;

88 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

89 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

90 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

93 
RªdomAcûssGaussPo¡R—d”
 
	`gpo¡_»ad”
(
gpo¡_r¥ecif›r
);

94 
BasisFmÎrAccus
 
	`basis_accs
(
am_gmm
.
	`Dim
());

96 
št32
 
num_dÚe
 = 0, 
num_no_po¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

97 ià(
¥k2u‰_r¥ecif›r
 != "") {

98 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

99 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

101 
št32
 
num_¥k
 = 0;

102 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

103 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

104 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

105 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

106 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

107 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

108 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

109 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

110 
num_Ùh”_”rÜ
++;

113 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

114 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

115 
num_no_po¡
++;

118 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

119 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

120 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

121 
KALDI_WARN
 << "GaussPo¡ ha wrÚg siz" << (
gpo¡
.
	`size
())

122 << " vs. " << (
ã©s
.
	`NumRows
());

123 
num_Ùh”_”rÜ
++;

127 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

129 
num_dÚe
++;

131 
basis_accs
.
	`AccuG¿d›ÁSÿ‰”
(
¥k_¡©s
);

132 
num_¥k
++;

134 
KALDI_LOG
 << "AccumuÏ‹ sti¡ic äom " << 
num_¥k
 << " speakers";

137 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

138 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

139 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

140 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

141 
KALDI_WARN
 << "Did‚ot find…osts for utterance "

142 << 
u‰
;

143 
num_no_po¡
++;

146 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

147 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

149 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

150 
KALDI_WARN
 << "GaussPo¡ ha wrÚg siz" << (
gpo¡
.
	`size
())

151 << " vs. " << (
ã©s
.
	`NumRows
());

152 
num_Ùh”_”rÜ
++;

156 
FmÎrDŸgGmmAccs
 
	`u‰_¡©s
(
am_gmm
.
	`Dim
());

157 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
Œªs_mod–
, 
am_gmm
, &
u‰_¡©s
);

158 
num_dÚe
++;

160 
basis_accs
.
	`AccuG¿d›ÁSÿ‰”
(
u‰_¡©s
);

165 
Ouut
 
	`ko
(
accs_w¥ecif›r
, 
bš¬y_wr™e
);

166 
basis_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

168 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡


169 << " w™h‚Øpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

170 
KALDI_LOG
 << "Wr™‹Àg¿d›Á sÿ‰”Ø" << 
accs_w¥ecif›r
;

171  (
num_dÚe
 != 0 ? 0 : 1);

172 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

173 
¡d
::
û¼
 << 
e
.
	`wh©
();

176 
	}
}

	@gmm-basis-fmllr-accs.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
	~"ŒªsfÜm/basis-fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

34 
Çme¥aû
 
	gk®di
 {

35 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

36 cÚ¡ 
Po¡”iÜ
 &
po¡
,

37 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

38 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

39 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

40 
Po¡”iÜ
 
	gpdf_po¡
;

41 
CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡
, &
pdf_po¡
);

42 
size_t
 
	gi
 = 0; i < 
	gpo¡
.
size
(); i++) {

43 
size_t
 
	gj
 = 0; j < 
	gpdf_po¡
[
i
].
size
(); j++) {

44 
št32
 
	gpdf_id
 = 
pdf_po¡
[
i
][
j
].
fœ¡
;

45 
	g¥k_¡©s
->
AccumuÏ‹FÜGmm
(
am_gmm
.
G‘Pdf
(
pdf_id
),

46 
ã©s
.
Row
(
i
),

47 
pdf_po¡
[
i
][
j
].
£cÚd
);

55 
	$maš
(
¬gc
, *
¬gv
[]) {

56 
Œy
 {

57 
k®di
::
	tšt32
 int32;

58 
usšg
 
Çme¥aû
 
k®di
;

59 cÚ¡ *
u§ge
 =

66 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

67 
¡ršg
 
¥k2u‰_r¥ecif›r
;

68 
P¬£O±iÚs
 
	`po
(
u§ge
);

69 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

70 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

73 
po
.
	`R—d
(
¬gc
, 
¬gv
);

74 ià(
po
.
	`NumArgs
() != 4) {

75 
po
.
	`PrštU§ge
();

76 
	`ex™
(1);

79 
¡ršg


80 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

81 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

82 
po¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

83 
accs_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

85 
T¿ns™iÚMod–
 
Œªs_mod–
;

86 
AmDŸgGmm
 
am_gmm
;

88 
boŞ
 
bš¬y
;

89 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

90 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

91 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

94 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡_r¥ecif›r
);

95 
BasisFmÎrAccus
 
	`basis_accs
(
am_gmm
.
	`Dim
());

97 
št32
 
num_dÚe
 = 0, 
num_no_po¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

98 ià(
¥k2u‰_r¥ecif›r
 != "") {

99 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

100 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

102 
št32
 
num_¥k
 = 0;

103 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

104 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

105 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

106 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

107 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

108 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

109 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

110 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

111 
num_Ùh”_”rÜ
++;

114 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

115 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

116 
num_no_po¡
++;

119 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

120 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

121 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

122 
KALDI_WARN
 << "Po¡”iÜ veùÜ ha wrÚg siz" << (
po¡
.
	`size
())

123 << " vs. " << (
ã©s
.
	`NumRows
());

124 
num_Ùh”_”rÜ
++;

128 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

130 
num_dÚe
++;

132 
basis_accs
.
	`AccuG¿d›ÁSÿ‰”
(
¥k_¡©s
);

133 
num_¥k
++;

135 
KALDI_LOG
 << "AccumuÏ‹ sti¡ic äom " << 
num_¥k
 << " speakers";

138 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

139 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

140 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

141 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

142 
KALDI_WARN
 << "Did‚ot find…osts for utterance "

143 << 
u‰
;

144 
num_no_po¡
++;

147 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

148 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

150 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

151 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡
.
	`size
())

152 << " vs. " << (
ã©s
.
	`NumRows
());

153 
num_Ùh”_”rÜ
++;

157 
FmÎrDŸgGmmAccs
 
	`u‰_¡©s
(
am_gmm
.
	`Dim
());

158 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
Œªs_mod–
, 
am_gmm
, &
u‰_¡©s
);

159 
num_dÚe
++;

161 
basis_accs
.
	`AccuG¿d›ÁSÿ‰”
(
u‰_¡©s
);

166 
Ouut
 
	`ko
(
accs_w¥ecif›r
, 
bš¬y_wr™e
);

167 
basis_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

169 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡


170 << " w™h‚Øpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

171 
KALDI_LOG
 << "Wr™‹Àg¿d›Á sÿ‰”Ø" << 
accs_w¥ecif›r
;

172  (
num_dÚe
 != 0 ? 0 : 1);

173 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

174 
¡d
::
û¼
 << 
e
.
	`wh©
();

177 
	}
}

	@gmm-basis-fmllr-training.cc

20 
	~<¡ršg
>

21 
usšg
 
	g¡d
::
¡ršg
;

22 
	~<veùÜ
>

23 
usšg
 
	g¡d
::
veùÜ
;

25 
	~"ba£/k®di-commÚ.h
"

26 
	~"ut/commÚ-uts.h
"

27 
	~"gmm/am-dŸg-gmm.h
"

28 
	~"hmm/Œªs™iÚ-mod–.h
"

29 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

30 
	~"ŒªsfÜm/basis-fmÎr-dŸg-gmm.h
"

32 
	$maš
(
¬gc
, *
¬gv
[]) {

33 
Œy
 {

34 
k®di
::
	tšt32
 int32;

35 
usšg
 
Çme¥aû
 
k®di
;

36 cÚ¡ *
u§ge
 =

42 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

43 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

46 
po
.
	`R—d
(
¬gc
, 
¬gv
);

47 ià(
po
.
	`NumArgs
() < 3) {

48 
po
.
	`PrštU§ge
();

49 
	`ex™
(1);

52 
¡ršg


53 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

54 
basis_w¥ecif›r
 = 
po
.
	`G‘Arg
(2);

56 
T¿ns™iÚMod–
 
Œªs_mod–
;

57 
AmDŸgGmm
 
am_gmm
;

59 
boŞ
 
bš¬y
;

60 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

61 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

62 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

65 
BasisFmÎrAccus
 
	`basis_accs
(
am_gmm
.
	`Dim
());

66 
num_accs
 = 
po
.
	`NumArgs
() - 2;

68 
i
 = 3, 
max
 = 
po
.
	`NumArgs
(); i <= max; ++i) {

69 
¡d
::
¡ršg
 
accs_š_f’ame
 = 
po
.
	`G‘Arg
(
i
);

70 
boŞ
 
bš¬y_»ad
;

71 
k®di
::
IÅut
 
	`ki
(
accs_š_f’ame
, &
bš¬y_»ad
);

72 
basis_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
Œue
 );

76 
BasisFmÎrE¡im©e
 
	`basis_e¡
(
am_gmm
.
	`Dim
());

77 
basis_e¡
.
	`E¡im©eFmÎrBasis
(
am_gmm
, 
basis_accs
);

78 
	`Wr™eK®diObjeù
(
basis_e¡
, 
basis_w¥ecif›r
, 
bš¬y_wr™e
);

80 
KALDI_LOG
 << "Summed " << 
num_accs
 << " gradient scatter stats";

81 
KALDI_LOG
 << "G’”©" << 
basis_e¡
.
	`BasisSize
() << " bases, writteno "

82 << 
basis_w¥ecif›r
;

84 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

85 
¡d
::
û¼
 << 
e
.
	`wh©
();

88 
	}
}

	@gmm-boost-silence.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"hmm/Œªs™iÚ-mod–.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

30 cÚ¡ *
u§ge
 =

41 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

42 
Ba£Flßt
 
boo¡
 = 1.5;

44 
P¬£O±iÚs
 
	`po
(
u§ge
);

45 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

46 
po
.
	`Regi¡”
("boo¡", &
boo¡
, "Factor by whicho boost silence…robs");

48 
po
.
	`R—d
(
¬gc
, 
¬gv
);

50 ià(
po
.
	`NumArgs
() != 3) {

51 
po
.
	`PrštU§ge
();

52 
	`ex™
(1);

55 
¡d
::
¡ršg


56 
s’û_phÚes_¡ršg
 = 
po
.
	`G‘Arg
(1),

57 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(2),

58 
mod–_wxf’ame
 = 
po
.
	`G‘Arg
(3);

60 
¡d
::
veùÜ
<
št32
> 
s’û_phÚes
;

61 ià(
s’û_phÚes_¡ršg
 != "") {

62 
	`S¶™SŒšgToIÁeg”s
(
s’û_phÚes_¡ršg
, ":", 
çl£
, &
s’û_phÚes
);

63 
¡d
::
	`sÜt
(
s’û_phÚes
.
	`begš
(), s’û_phÚes.
	`’d
());

64 
	`KALDI_ASSERT
(
	`IsSÜ‹dAndUniq
(
s’û_phÚes
) && "Silence…hones‚on-unique.");

66 
KALDI_WARN
 << "gmm-boost-silence:‚o silence…hones specified, doing‚othing.";

69 
AmDŸgGmm
 
am_gmm
;

70 
T¿ns™iÚMod–
 
Œªs_mod–
;

72 
boŞ
 
bš¬y_»ad
;

73 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y_»ad
);

74 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

75 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

79 
¡d
::
veùÜ
<
št32
> 
pdfs
;

80 
boŞ
 
ªs
 = 
	`G‘PdfsFÜPhÚes
(
Œªs_mod–
, 
s’û_phÚes
, &
pdfs
);

81 ià(!
ªs
) {

82 
KALDI_WARN
 << "The…dfs forhe silence…hones may be shared by other…hones "

85 
size_t
 
i
 = 0; i < 
pdfs
.
	`size
(); i++) {

86 
št32
 
pdf
 = 
pdfs
[
i
];

87 
DŸgGmm
 &
gmm
 = 
am_gmm
.
	`G‘Pdf
(
pdf
);

88 
VeùÜ
<
Ba£Flßt
> 
	`weights
(
gmm
.weights());

89 
weights
.
	`SÿË
(
boo¡
);

90 
gmm
.
	`S‘Weights
(
weights
);

91 
gmm
.
	`Compu‹GcÚ¡s
();

93 
KALDI_LOG
 << "Boo¡ed weight fÜ " << 
pdfs
.
	`size
()

94 << "…dfs, by faùÜ oà" << 
boo¡
;

98 
Ouut
 
	`ko
(
mod–_wxf’ame
, 
bš¬y_wr™e
);

99 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

100 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

103 
KALDI_LOG
 << "WrÙmod–Ø" << 
mod–_wxf’ame
;

104 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

105 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

108 
	}
}

	@gmm-compute-likes.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"f¡ext/f¡ext-lib.h
"

26 
	~"ba£/tim”.h
"

30 
	$maš
(
¬gc
, *
¬gv
[]) {

31 
Œy
 {

32 
usšg
 
Çme¥aû
 
k®di
;

33 
k®di
::
	tšt32
 int32;

34 
usšg
 
f¡
::
SymbŞTabË
;

35 
usšg
 
f¡
::
VeùÜF¡
;

36 
usšg
 
f¡
::
StdArc
;

38 cÚ¡ *
u§ge
 =

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
po
.
	`R—d
(
¬gc
, 
¬gv
);

46 ià(
po
.
	`NumArgs
() != 3) {

47 
po
.
	`PrštU§ge
();

48 
	`ex™
(1);

51 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

52 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

53 
loglikes_w¥ecif›r
 = 
po
.
	`G‘Arg
(3);

55 
AmDŸgGmm
 
am_gmm
;

57 
boŞ
 
bš¬y
;

58 
T¿ns™iÚMod–
 
Œªs_mod–
;

59 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

60 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

61 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

64 
Ba£FlßtM©rixWr™”
 
	`loglikes_wr™”
(
loglikes_w¥ecif›r
);

65 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

67 
št32
 
num_dÚe
 = 0;

68 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

69 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

70 cÚ¡ 
M©rix
<
Ba£Flßt
> &
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

71 
M©rix
<
Ba£Flßt
> 
	`loglikes
(
ã©u»s
.
	`NumRows
(), 
am_gmm
.
	`NumPdfs
());

72 
št32
 
i
 = 0; i < 
ã©u»s
.
	`NumRows
(); i++) {

73 
št32
 
j
 = 0; j < 
am_gmm
.
	`NumPdfs
(); j++) {

74 
SubVeùÜ
<
Ba£Flßt
> 
	`ã©_row
(
ã©u»s
, 
i
);

75 
	`loglikes
(
i
, 
j
èğ
am_gmm
.
	`LogLik–ihood
(j, 
ã©_row
);

78 
loglikes_wr™”
.
	`Wr™e
(
key
, 
loglikes
);

79 
num_dÚe
++;

82 
KALDI_LOG
 << "gmm-compu‹-likes: compu‹d†ik–ihood fÜ " << 
num_dÚe


85 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

86 
¡d
::
û¼
 << 
e
.
	`wh©
();

89 
	}
}

	@gmm-copy.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

30 cÚ¡ *
u§ge
 =

37 
boŞ
 
bš¬y_wr™e
 = 
Œue
,

38 
cİy_am
 = 
Œue
,

39 
cİy_tm
 = 
Œue
;

41 
P¬£O±iÚs
 
	`po
(
u§ge
);

42 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

43 
po
.
	`Regi¡”
("cİy-am", &
cİy_am
, "Copyhe‡coustic model (AmDiagGmm object)");

44 
po
.
	`Regi¡”
("cİy-tm", &
cİy_tm
, "Copyheransition model");

46 
po
.
	`R—d
(
¬gc
, 
¬gv
);

48 ià(
po
.
	`NumArgs
() != 2) {

49 
po
.
	`PrštU§ge
();

50 
	`ex™
(1);

53 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

54 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(2);

56 
AmDŸgGmm
 
am_gmm
;

57 
T¿ns™iÚMod–
 
Œªs_mod–
;

59 
boŞ
 
bš¬y_»ad
;

60 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

61 ià(
cİy_tm
)

62 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

63 ià(
cİy_am
)

64 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

68 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y_wr™e
);

69 ià(
cİy_tm
)

70 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

71 ià(
cİy_am
)

72 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

75 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

76 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

77 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

80 
	}
}

	@gmm-decode-biglm-faster.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"f¡ext/f¡ext-lib.h
"

26 
	~"decod”/biglm-ç¡”-decod”.h
"

27 
	~"gmm/decodabË-am-dŸg-gmm.h
"

28 
	~"ba£/tim”.h
"

30 
Çme¥aû
 
	gk®di
 {

32 
	gf¡
::
F¡
<
f¡
::
StdArc
> *
R—dN‘wÜk
(
¡d
::
¡ršg
 
f’ame
) {

34 
IÅut
 
ki
(
f’ame
);

35 ià(!
	gki
.
SŒ—m
().
good
()è
	gKALDI_ERR
 << "Could‚ot open decoding-graph FST "

36 << 
	gf’ame
;

38 
	gf¡
::
F¡H—d”
 
hdr
;

39 ià(!
	ghdr
.
R—d
(
ki
.
SŒ—m
(), "<unknown>")) {

40 
	gKALDI_ERR
 << "Reading FST:ƒrror„eading FST header.";

42 ià(
	ghdr
.
ArcTy³
(è!ğ
f¡
::
StdArc
::
Ty³
()) {

43 
KALDI_ERR
 << "FST w™h‡røty³ " << 
hdr
.
ArcTy³
() << "‚ot supported.";

45 
	gf¡
::
F¡R—dO±iÚs
 
rİts
("<un¥ecif›d>", &
hdr
);

47 
	gf¡
::
F¡
<
f¡
::
StdArc
> *
decode_f¡
 = 
NULL
;

49 ià(
	ghdr
.
F¡Ty³
() == "vector") {

50 
decode_f¡
 = 
f¡
::
VeùÜF¡
<f¡::
StdArc
>::
R—d
(
ki
.
SŒ—m
(), 
rİts
);

51 } ià(
	ghdr
.
F¡Ty³
() == "const") {

52 
decode_f¡
 = 
f¡
::
CÚ¡F¡
<f¡::
StdArc
>::
R—d
(
ki
.
SŒ—m
(), 
rİts
);

54 
	gKALDI_ERR
 << "R—dšg FST: unsuµÜ‹d FSTy³: " << 
	ghdr
.
F¡Ty³
();

56 ià(
	gdecode_f¡
 =ğ
NULL
) {

57 
KALDI_ERR
 << "Error„eading FST (after„eading header).";

58  
	gNULL
;

60  
	gdecode_f¡
;

68 
	$maš
(
¬gc
, *
¬gv
[])

70 
Œy
 {

71 
usšg
 
Çme¥aû
 
k®di
;

72 
k®di
::
	tšt32
 int32;

73 
usšg
 
f¡
::
SymbŞTabË
;

74 
usšg
 
f¡
::
VeùÜF¡
;

75 
usšg
 
f¡
::
F¡
;

76 
usšg
 
f¡
::
StdArc
;

77 
usšg
 
f¡
::
R—dF¡K®di
;

79 cÚ¡ *
u§ge
 =

84 
P¬£O±iÚs
 
	`po
(
u§ge
);

85 
boŞ
 
®low_·¹Ÿl
 = 
Œue
;

86 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

88 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

89 
BiglmFa¡”Decod”O±iÚs
 
decod”_İts
;

90 
decod”_İts
.
	`Regi¡”
(&
po
, 
Œue
);

91 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

93 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

95 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

98 
po
.
	`R—d
(
¬gc
, 
¬gv
);

100 ià(
po
.
	`NumArgs
() < 6 ||…o.NumArgs() > 8) {

101 
po
.
	`PrštU§ge
();

102 
	`ex™
(1);

105 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

106 
f¡_rxf’ame
 = 
po
.
	`G‘Arg
(2),

107 
Şd_lm_f¡_rxf’ame
 = 
po
.
	`G‘Arg
(3),

108 
Ãw_lm_f¡_rxf’ame
 = 
po
.
	`G‘Arg
(4),

109 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

110 
wÜds_w¥ecif›r
 = 
po
.
	`G‘Arg
(6),

111 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(7),

112 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(8);

114 
T¿ns™iÚMod–
 
Œªs_mod–
;

115 
AmDŸgGmm
 
am_gmm
;

117 
boŞ
 
bš¬y
;

118 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

119 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

120 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

123 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

125 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

127 
Com·ùL©tiûWr™”
 
	`ş©_wr™”
(
Ï‰iû_w¥ecif›r
);

129 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

130 ià(
wÜd_syms_f’ame
 != "") {

131 
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
);

132 ià(!
wÜd_syms
)

133 
KALDI_ERR
 << "Could‚Ù„—d symbŞabË from f"<<
wÜd_syms_f’ame
;

136 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

144 
F¡
<
StdArc
> *
decode_f¡
 = 
	`R—dN‘wÜk
(
f¡_rxf’ame
);

146 
VeùÜF¡
<
StdArc
> *
Şd_lm_f¡
 = 
	`R—dF¡K®di
(
Şd_lm_f¡_rxf’ame
);

147 
	`AµlyProbab™ySÿË
(-1.0, 
Şd_lm_f¡
);

149 
VeùÜF¡
<
StdArc
> *
Ãw_lm_f¡
 = 
	`R—dF¡K®di
(
Ãw_lm_f¡_rxf’ame
);

152 
Ba£Flßt
 
tÙ_like
 = 0.0;

153 
k®di
::
št64
 
äame_couÁ
 = 0;

154 
num_sucûss
 = 0, 
num_ç
 = 0;

156 
Tim”
 
tim”
;

158 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

159 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

160 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

161 
ã©u»_»ad”
.
	`F»eCu¼’t
();

162 ià(
ã©u»s
.
	`NumRows
() == 0) {

163 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
key
;

164 
num_ç
++;

167 
f¡
::
BackoffD‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`Şd_lm_df¡
(*
Şd_lm_f¡
);

168 
f¡
::
BackoffD‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`Ãw_lm_df¡
(*
Ãw_lm_f¡
);

169 
f¡
::
Compo£D‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`compo£_df¡
(&
Şd_lm_df¡
,

170 &
Ãw_lm_df¡
);

171 
f¡
::
CacheD‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`ÿche_df¡
(&
compo£_df¡
);

173 
BiglmFa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
decod”_İts
, &
ÿche_df¡
);

175 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

176 
acou¡ic_sÿË
);

177 
decod”
.
	`Decode
(&
gmm_decodabË
);

179 
¡d
::
û¼
 << "L’gth oàfi "<<
ã©u»s
.
	`NumRows
()<<'\n';

181 
f¡
::
VeùÜF¡
<
L©tiûArc
> 
decoded
;

183 iàĞ(
®low_·¹Ÿl
 || 
decod”
.
	`R—chedFš®
())

184 && 
decod”
.
	`G‘Be¡P©h
(&
decoded
) ) {

185 ià(!
decod”
.
	`R—chedFš®
())

186 
KALDI_WARN
 << "Decoder did‚ot„eachƒnd-state, "

188 
num_sucûss
++;

189 ià(!
decod”
.
	`R—chedFš®
())

190 
KALDI_WARN
 << "Decoder did‚ot„eachƒnd-state, outputting…artialraceback.";

191 
¡d
::
veùÜ
<
št32
> 
®ignm’t
;

192 
¡d
::
veùÜ
<
št32
> 
wÜds
;

193 
L©tiûWeight
 
weight
;

194 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

196 
	`G‘Lš—rSymbŞSequ’û
(
decoded
, &
®ignm’t
, &
wÜds
, &
weight
);

198 
wÜds_wr™”
.
	`Wr™e
(
key
, 
wÜds
);

199 ià(
®ignm’t_wr™”
.
	`IsO³n
())

200 
®ignm’t_wr™”
.
	`Wr™e
(
key
, 
®ignm’t
);

202 ià(
Ï‰iû_w¥ecif›r
 != "") {

203 ià(
acou¡ic_sÿË
 != 0.0)

204 
f¡
::
	`SÿËL©tiû
(f¡::
	`Acou¡icL©tiûSÿË
(1.0 / 
acou¡ic_sÿË
), &
decoded
);

205 
f¡
::
VeùÜF¡
<
Com·ùL©tiûArc
> 
ş©
;

206 
	`CÚv”tL©tiû
(
decoded
, &
ş©
, 
Œue
);

207 
ş©_wr™”
.
	`Wr™e
(
key
, 
ş©
);

210 ià(
wÜd_syms
 !ğ
NULL
) {

211 
¡d
::
û¼
 << 
key
 << ' ';

212 
size_t
 
i
 = 0; i < 
wÜds
.
	`size
(); i++) {

213 
¡d
::
¡ršg
 
s
 = 
wÜd_syms
->
	`Fšd
(
wÜds
[
i
]);

214 ià(
s
 == "")

215 
KALDI_ERR
 << "WÜd-id " << 
wÜds
[
i
] <<"‚ot in symbolable.";

216 
¡d
::
û¼
 << 
s
 << ' ';

218 
¡d
::
û¼
 << '\n';

220 
Ba£Flßt
 
like
 = -
weight
.
	`V®ue1
(è-weight.
	`V®ue2
();

221 
tÙ_like
 +ğ
like
;

222 
KALDI_LOG
 << "Log-lik³¸äamfÜ u‰”ªû " << 
key
 << " is "

223 << (
like
 / 
ã©u»s
.
	`NumRows
()) << " over "

224 << 
ã©u»s
.
	`NumRows
() << " frames.";

225 
	`KALDI_VLOG
(2è<< "Co¡ fÜ u‰”ªû " << 
key
 << " is "

226 << 
weight
.
	`V®ue1
(è<< " + " << weight.
	`V®ue2
();

228 
num_ç
++;

229 
KALDI_WARN
 << "Did‚Ù sucûssfuÎy decodu‰”ªû " << 
key


230 << ",†’ = " << 
ã©u»s
.
	`NumRows
();

234 
–­£d
 = 
tim”
.
	`EÏp£d
();

235 
KALDI_LOG
 << "Timk’ [exşudšg in™Ÿliz©iÚ] "<< 
–­£d


237 << (
–­£d
*100.0/
äame_couÁ
);

238 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

239 << 
num_ç
;

240 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

241 << 
äame_couÁ
<<" frames.";

243 
d–‘e
 
wÜd_syms
;

244 
d–‘e
 
decode_f¡
;

245 
d–‘e
 
Şd_lm_f¡
;

246 
d–‘e
 
Ãw_lm_f¡
;

247  (
num_sucûss
 != 0 ? 0 : 1);

248 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

249 
¡d
::
û¼
 << 
e
.
	`wh©
();

252 
	}
}

	@gmm-decode-faster-regtree-fmllr.cc

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~"ba£/k®di-commÚ.h
"

25 
	~"ut/commÚ-uts.h
"

26 
	~"gmm/am-dŸg-gmm.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"ŒªsfÜm/»g»ssiÚ-Œ“.h
"

29 
	~"ŒªsfÜm/»gŒ“-fmÎr-dŸg-gmm.h
"

30 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
	~"f¡ext/f¡ext-lib.h
"

32 
	~"decod”/ç¡”-decod”.h
"

33 
	~"ŒªsfÜm/decodabË-am-dŸg-gmm-»gŒ“.h
"

34 
	~"ba£/tim”.h
"

35 
	~"Ït/k®di-Ï‰iû.h
"

37 
usšg
 
	gf¡
::
SymbŞTabË
;

38 
usšg
 
	gf¡
::
VeùÜF¡
;

39 
usšg
 
	gf¡
::
StdArc
;

40 
usšg
 
	gk®di
::
Ba£Flßt
;

41 
usšg
 
	g¡d
::
¡ršg
;

42 
usšg
 
	g¡d
::
veùÜ
;

43 
usšg
 
	gk®di
::
L©tiûWeight
;

44 
usšg
 
	gk®di
::
L©tiûArc
;

46 
	sDecodeInfo
 {

47 
	mpublic
:

48 
DecodeInfo
(cÚ¡ 
k®di
::
AmDŸgGmm
 &
am
,

49 cÚ¡ 
k®di
::
T¿ns™iÚMod–
 &
tm
, k®di::
Fa¡”Decod”
 *
decod”
,

50 
Ba£Flßt
 
sÿË
, 
boŞ
 
®low_·¹Ÿl
,

51 cÚ¡ 
k®di
::
IÁ32VeùÜWr™”
 &
wwr™”
,

52 cÚ¡ 
k®di
::
IÁ32VeùÜWr™”
 &
awr™”
, 
f¡
::
SymbŞTabË
 *
wsyms
)

53 : 
acou¡ic_mod–
(
am
), 
Œªs_mod–
(
tm
), 
decod”
(decoder),

54 
acou¡ic_sÿË
(
sÿË
), 
®low_·¹Ÿl
×Îow_·¹Ÿl), 
wÜds_wr™”
(
wwr™”
),

55 
®ignm’t_wr™”
(
awr™”
), 
wÜd_syms
(
wsyms
) {}

57 cÚ¡ 
	mk®di
::
AmDŸgGmm
 &
acou¡ic_mod–
;

58 cÚ¡ 
	mk®di
::
T¿ns™iÚMod–
 &
Œªs_mod–
;

59 
	mk®di
::
Fa¡”Decod”
 *
decod”
;

60 
Ba£Flßt
 
	macou¡ic_sÿË
;

61 
boŞ
 
	m®low_·¹Ÿl
;

62 cÚ¡ 
	mk®di
::
IÁ32VeùÜWr™”
 &
wÜds_wr™”
;

63 cÚ¡ 
	mk®di
::
IÁ32VeùÜWr™”
 &
®ignm’t_wr™”
;

64 
	mf¡
::
SymbŞTabË
 *
wÜd_syms
;

66 
	m´iv©e
:

67 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
DecodeInfo
);

70 
boŞ
 
	$DecodeU‰”ªû
(
k®di
::
Fa¡”Decod”
 *
decod”
,

71 
k®di
::
DecodabËIÁ”çû
 *
decodabË
,

72 
DecodeInfo
 *
šfo
,

73 cÚ¡ 
¡ršg
 &
u‰id
,

74 
št32
 
num_äames
,

75 
Ba£Flßt
 *
tÙ®_like
) {

76 
decod”
->
	`Decode
(
decodabË
);

77 
KALDI_LOG
 << "L’gth oàfi " << 
num_äames
;

79 
VeùÜF¡
<
L©tiûArc
> 
decoded
;

80 iàĞ(
šfo
->
®low_·¹Ÿl
 || 
decod”
->
	`R—chedFš®
())

81 && 
decod”
->
	`G‘Be¡P©h
(&
decoded
) ) {

82 ià(!
decod”
->
	`R—chedFš®
())

83 
KALDI_WARN
 << "Decoder did‚ot„eachƒnd-state, outputting…artial "

86 
veùÜ
<
k®di
::
št32
> 
®ignm’t
, 
wÜds
;

87 
L©tiûWeight
 
weight
;

88 
	`G‘Lš—rSymbŞSequ’û
(
decoded
, &
®ignm’t
, &
wÜds
, &
weight
);

90 
šfo
->
wÜds_wr™”
.
	`Wr™e
(
u‰id
, 
wÜds
);

91 ià(
šfo
->
®ignm’t_wr™”
.
	`IsO³n
())

92 
šfo
->
®ignm’t_wr™”
.
	`Wr™e
(
u‰id
, 
®ignm’t
);

93 ià(
šfo
->
wÜd_syms
 !ğ
NULL
) {

94 
¡d
::
o¡ršg¡»am
 
ss
;

95 
ss
 << 
u‰id
 << ' ';

96 
size_t
 
i
 = 0; i < 
wÜds
.
	`size
(); i++) {

97 
¡ršg
 
s
 = 
šfo
->
wÜd_syms
->
	`Fšd
(
wÜds
[
i
]);

98 ià(
s
 == "")

99 
KALDI_ERR
 << "WÜd-id " << 
wÜds
[
i
] << "‚ot in symbolable.";

100 
ss
 << 
s
 << ' ';

102 
ss
 << '\n';

103 
KALDI_LOG
 << 
ss
.
	`¡r
();

106 
Ba£Flßt
 
like
 = -
weight
.
	`V®ue1
(è-weight.
	`V®ue2
();

107 
KALDI_LOG
 << "Log-lik³¸äamğ" << (
like
/
num_äames
);

108 (*
tÙ®_like
è+ğ
like
;

109  
Œue
;

111 
KALDI_WARN
 << "Did‚ot successfully decode utterance,†ength = "

112 << 
num_äames
;

113  
çl£
;

115 
	}
}

117 
	$maš
(
¬gc
, *
¬gv
[]) {

118 
Œy
 {

119 
usšg
 
Çme¥aû
 
k®di
;

120 
k®di
::
	tšt32
 int32;

122 cÚ¡ *
u§ge
 = "Decode features using GMM-based model.\n"

126 
P¬£O±iÚs
 
	`po
(
u§ge
);

127 
boŞ
 
bš¬y
 = 
Œue
;

128 
boŞ
 
®low_·¹Ÿl
 = 
Œue
;

129 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

131 
¡d
::
¡ršg
 
wÜd_syms_f’ame
, 
u‰2¥k_r¥ecif›r
;

132 
Fa¡”Decod”O±iÚs
 
decod”_İts
;

133 
decod”_İts
.
	`Regi¡”
(&
po
, 
Œue
);

134 
po
.
	`Regi¡”
("u‰2¥k", &
u‰2¥k_r¥ecif›r
, "rspecifier for utteranceo "

136 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

137 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

139 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

141 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

143 
po
.
	`R—d
(
¬gc
, 
¬gv
);

145 ià(
po
.
	`NumArgs
() < 6 ||…o.NumArgs() > 7) {

146 
po
.
	`PrštU§ge
();

147 
	`ex™
(1);

150 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

151 
f¡_š_f’ame
 = 
po
.
	`G‘Arg
(2),

152 
»gŒ“_f’ame
 = 
po
.
	`G‘Arg
(3),

153 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

154 
xfÜms_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

155 
wÜds_w¥ecif›r
 = 
po
.
	`G‘Arg
(6),

156 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(7);

158 
T¿ns™iÚMod–
 
Œªs_mod–
;

159 
AmDŸgGmm
 
am_gmm
;

161 
boŞ
 
bš¬y_»ad
;

162 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

163 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

164 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

167 
VeùÜF¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®di
(
f¡_š_f’ame
);

169 
Reg»ssiÚT»e
 
»gŒ“
;

171 
boŞ
 
bš¬y_»ad
;

172 
IÅut
 
	`š
(
»gŒ“_f’ame
, &
bš¬y_»ad
);

173 
»gŒ“
.
	`R—d
(
š
.
	`SŒ—m
(), 
bš¬y_»ad
, 
am_gmm
);

176 
RªdomAcûssRegŒ“FmÎrDŸgGmmR—d”M­³d
 
	`fmÎr_»ad”
(
xfÜms_r¥ecif›r
,

177 
u‰2¥k_r¥ecif›r
);

179 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

181 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

183 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

184 ià(
wÜd_syms_f’ame
 != "") {

185 
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
);

186 ià(!
wÜd_syms
) {

187 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

188 << 
wÜd_syms_f’ame
;

192 
Ba£Flßt
 
tÙ_like
 = 0.0;

193 
k®di
::
št64
 
äame_couÁ
 = 0;

194 
num_sucûss
 = 0, 
num_ç
 = 0;

195 
Fa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
decod”_İts
);

197 
Tim”
 
tim”
;

199 
DecodeInfo
 
	`decode_šfo
(
am_gmm
, 
Œªs_mod–
, &
decod”
, 
acou¡ic_sÿË
,

200 
®low_·¹Ÿl
, 
wÜds_wr™”
, 
®ignm’t_wr™”
,

201 
wÜd_syms
);

203 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

204 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

205 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

207 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
(
ã©u»_»ad”
.
	`V®ue
());

208 
ã©u»_»ad”
.
	`F»eCu¼’t
();

209 ià(
ã©u»s
.
	`NumRows
() == 0) {

210 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

211 
num_ç
++;

215 ià(!
fmÎr_»ad”
.
	`HasKey
(
u‰
)) {

216 
KALDI_WARN
 << "NØFMLLR¿nsfÜm fÜ key " << 
u‰
 <<

218 
k®di
::
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

219 
ã©u»s
,

220 
acou¡ic_sÿË
);

221 ià(
	`DecodeU‰”ªû
(&
decod”
, &
gmm_decodabË
, &
decode_šfo
,

222 
u‰
, 
ã©u»s
.
	`NumRows
(), &
tÙ_like
)) {

223 
äame_couÁ
 +ğ
gmm_decodabË
.
	`NumF¿mesR—dy
();

224 
num_sucûss
++;

226 
num_ç
++;

232 
RegŒ“FmÎrDŸgGmm
 
	`fmÎr
(
fmÎr_»ad”
.
	`V®ue
(
u‰
));

233 ià(
fmÎr
.
	`NumRegCÏs£s
() == 1) {

234 
M©rix
<
Ba£Flßt
> 
	`xfÜmed_ã©u»s
(
ã©u»s
);

235 
M©rix
<
Ba£Flßt
> 
fmÎr_m©rix
;

236 
fmÎr
.
	`G‘XfÜmM©rix
(0, &
fmÎr_m©rix
);

237 
št32
 
i
 = 0; i < 
xfÜmed_ã©u»s
.
	`NumRows
(); i++) {

238 
SubVeùÜ
<
Ba£Flßt
> 
	`row
(
xfÜmed_ã©u»s
, 
i
);

239 
	`AµlyAffšeT¿nsfÜm
(
fmÎr_m©rix
, &
row
);

241 
k®di
::
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

242 
xfÜmed_ã©u»s
,

243 
acou¡ic_sÿË
);

245 ià(
	`DecodeU‰”ªû
(&
decod”
, &
gmm_decodabË
, &
decode_šfo
,

246 
u‰
, 
xfÜmed_ã©u»s
.
	`NumRows
(), &
tÙ_like
)) {

247 
äame_couÁ
 +ğ
gmm_decodabË
.
	`NumF¿mesR—dy
();

248 
num_sucûss
++;

250 
num_ç
++;

253 
k®di
::
DecodabËAmDŸgGmmRegŒ“FmÎr
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

254 
ã©u»s
, 
fmÎr
,

255 
»gŒ“
,

256 
acou¡ic_sÿË
);

257 ià(
	`DecodeU‰”ªû
(&
decod”
, &
gmm_decodabË
, &
decode_šfo
,

258 
u‰
, 
ã©u»s
.
	`NumRows
(), &
tÙ_like
)) {

259 
äame_couÁ
 +ğ
gmm_decodabË
.
	`NumF¿mesR—dy
();

260 
num_sucûss
++;

262 
num_ç
++;

267 
KALDI_LOG
 << "Av”aglog-lik–ihood…” f¿mi " << (
tÙ_like


268 / 
äame_couÁ
) << " over " << frame_count << " frames.";

270 
–­£d
 = 
tim”
.
	`EÏp£d
();

271 
KALDI_LOG
 << "Timk’ [exşudšg in™Ÿliz©iÚ] " << 
–­£d


273 << (
–­£d
 * 100.0 / 
äame_couÁ
);

274 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

275 << 
num_ç
;

277 
d–‘e
 
wÜd_syms
;

278 
d–‘e
 
decode_f¡
;

279 ià(
num_sucûss
 != 0)

284 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

285 
¡d
::
û¼
 << 
e
.
	`wh©
();

288 
	}
}

	@gmm-decode-faster-regtree-mllr.cc

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~"ba£/k®di-commÚ.h
"

25 
	~"ut/commÚ-uts.h
"

26 
	~"gmm/am-dŸg-gmm.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"ŒªsfÜm/»g»ssiÚ-Œ“.h
"

29 
	~"ŒªsfÜm/»gŒ“-mÎr-dŸg-gmm.h
"

30 
	~"f¡ext/f¡ext-lib.h
"

31 
	~"decod”/ç¡”-decod”.h
"

32 
	~"ŒªsfÜm/decodabË-am-dŸg-gmm-»gŒ“.h
"

33 
	~"ba£/tim”.h
"

34 
	~"Ït/k®di-Ï‰iû.h
"

36 
usšg
 
	gf¡
::
SymbŞTabË
;

37 
usšg
 
	gf¡
::
VeùÜF¡
;

38 
usšg
 
	gf¡
::
StdArc
;

39 
usšg
 
	gk®di
::
Ba£Flßt
;

40 
usšg
 
	g¡d
::
¡ršg
;

41 
usšg
 
	g¡d
::
veùÜ
;

42 
usšg
 
	gk®di
::
L©tiûWeight
;

43 
usšg
 
	gk®di
::
L©tiûArc
;

45 
	sDecodeInfo
 {

46 
	mpublic
:

47 
DecodeInfo
(cÚ¡ 
k®di
::
AmDŸgGmm
 &
am
,

48 cÚ¡ 
k®di
::
T¿ns™iÚMod–
 &
tm
, k®di::
Fa¡”Decod”
 *
decod”
,

49 
Ba£Flßt
 
sÿË
, 
boŞ
 
®low_·¹Ÿl
,

50 cÚ¡ 
k®di
::
IÁ32VeùÜWr™”
 &
wwr™”
,

51 cÚ¡ 
k®di
::
IÁ32VeùÜWr™”
 &
awr™”
, 
f¡
::
SymbŞTabË
 *
wsyms
)

52 : 
acou¡ic_mod–
(
am
), 
Œªs_mod–
(
tm
), 
decod”
(decoder),

53 
acou¡ic_sÿË
(
sÿË
), 
®low_·¹Ÿl
×Îow_·¹Ÿl), 
wÜds_wr™”
(
wwr™”
),

54 
®ignm’t_wr™”
(
awr™”
), 
wÜd_syms
(
wsyms
) {}

56 cÚ¡ 
	mk®di
::
AmDŸgGmm
 &
acou¡ic_mod–
;

57 cÚ¡ 
	mk®di
::
T¿ns™iÚMod–
 &
Œªs_mod–
;

58 
	mk®di
::
Fa¡”Decod”
 *
decod”
;

59 
Ba£Flßt
 
	macou¡ic_sÿË
;

60 
boŞ
 
	m®low_·¹Ÿl
;

61 cÚ¡ 
	mk®di
::
IÁ32VeùÜWr™”
 &
wÜds_wr™”
;

62 cÚ¡ 
	mk®di
::
IÁ32VeùÜWr™”
 &
®ignm’t_wr™”
;

63 
	mf¡
::
SymbŞTabË
 *
wÜd_syms
;

65 
	m´iv©e
:

66 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
DecodeInfo
);

69 
boŞ
 
	$DecodeU‰”ªû
(
k®di
::
Fa¡”Decod”
 *
decod”
,

70 
k®di
::
DecodabËIÁ”çû
 *
decodabË
,

71 
DecodeInfo
 *
šfo
,

72 cÚ¡ 
¡ršg
 &
u‰id
,

73 
št32
 
num_äames
,

74 
Ba£Flßt
 *
tÙ®_like
) {

75 
decod”
->
	`Decode
(
decodabË
);

76 
KALDI_LOG
 << "L’gth oàfi " << 
num_äames
;;

78 
VeùÜF¡
<
L©tiûArc
> 
decoded
;

79 iàĞ(
šfo
->
®low_·¹Ÿl
 || 
decod”
->
	`R—chedFš®
())

80 && 
decod”
->
	`G‘Be¡P©h
(&
decoded
) ) {

81 ià(!
decod”
->
	`R—chedFš®
())

82 
KALDI_WARN
 << "Decoder did‚ot„eachƒnd-state, outputting…artial "

85 
veùÜ
<
k®di
::
št32
> 
®ignm’t
, 
wÜds
;

86 
L©tiûWeight
 
weight
;

87 
	`G‘Lš—rSymbŞSequ’û
(
decoded
, &
®ignm’t
, &
wÜds
, &
weight
);

89 
šfo
->
wÜds_wr™”
.
	`Wr™e
(
u‰id
, 
wÜds
);

90 ià(
šfo
->
®ignm’t_wr™”
.
	`IsO³n
())

91 
šfo
->
®ignm’t_wr™”
.
	`Wr™e
(
u‰id
, 
®ignm’t
);

92 ià(
šfo
->
wÜd_syms
 !ğ
NULL
) {

93 
¡d
::
o¡ršg¡»am
 
ss
;

94 
ss
 << 
u‰id
 << ' ';

95 
size_t
 
i
 = 0; i < 
wÜds
.
	`size
(); i++) {

96 
¡ršg
 
s
 = 
šfo
->
wÜd_syms
->
	`Fšd
(
wÜds
[
i
]);

97 ià(
s
 == "")

98 
KALDI_ERR
 << "WÜd-id " << 
wÜds
[
i
] << "‚ot in symbolable.";

99 
ss
 << 
s
 << ' ';

101 
ss
 << '\n';

102 
KALDI_LOG
 << 
ss
.
	`¡r
();

105 
Ba£Flßt
 
like
 = -
weight
.
	`V®ue1
(è-weight.
	`V®ue2
();

106 
KALDI_LOG
 << "Log-lik³¸äamğ" << (
like
/
num_äames
);

107 (*
tÙ®_like
è+ğ
like
;

108  
Œue
;

110 
KALDI_WARN
 << "Did‚ot successfully decode utterance,†ength = "

111 << 
num_äames
;

112  
çl£
;

114 
	}
}

116 
	$maš
(
¬gc
, *
¬gv
[]) {

117 
Œy
 {

118 
usšg
 
Çme¥aû
 
k®di
;

119 
k®di
::
	tšt32
 int32;

121 cÚ¡ *
u§ge
 = "Decode features using GMM-based model.\n"

125 
P¬£O±iÚs
 
	`po
(
u§ge
);

126 
boŞ
 
bš¬y
 = 
Œue
;

127 
boŞ
 
®low_·¹Ÿl
 = 
Œue
;

128 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

130 
¡d
::
¡ršg
 
wÜd_syms_f’ame
, 
u‰2¥k_r¥ecif›r
;

131 
Fa¡”Decod”O±iÚs
 
decod”_İts
;

132 
decod”_İts
.
	`Regi¡”
(&
po
, 
Œue
);

133 
po
.
	`Regi¡”
("u‰2¥k", &
u‰2¥k_r¥ecif›r
, "rspecifier for utteranceo "

135 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

136 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

138 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

140 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

142 
po
.
	`R—d
(
¬gc
, 
¬gv
);

144 ià(
po
.
	`NumArgs
() < 6 ||…o.NumArgs() > 7) {

145 
po
.
	`PrštU§ge
();

146 
	`ex™
(1);

149 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

150 
f¡_š_f’ame
 = 
po
.
	`G‘Arg
(2),

151 
»gŒ“_f’ame
 = 
po
.
	`G‘Arg
(3),

152 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

153 
xfÜms_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

154 
wÜds_w¥ecif›r
 = 
po
.
	`G‘Arg
(6),

155 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(7);

157 
T¿ns™iÚMod–
 
Œªs_mod–
;

158 
AmDŸgGmm
 
am_gmm
;

160 
boŞ
 
bš¬y_»ad
;

161 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

162 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

163 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

166 
VeùÜF¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®di
(
f¡_š_f’ame
);

168 
Reg»ssiÚT»e
 
»gŒ“
;

170 
boŞ
 
bš¬y_»ad
;

171 
IÅut
 
	`š
(
»gŒ“_f’ame
, &
bš¬y_»ad
);

172 
»gŒ“
.
	`R—d
(
š
.
	`SŒ—m
(), 
bš¬y_»ad
, 
am_gmm
);

175 
RªdomAcûssRegŒ“MÎrDŸgGmmR—d”M­³d
 
	`mÎr_»ad”
(
xfÜms_r¥ecif›r
,

176 
u‰2¥k_r¥ecif›r
);

178 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

180 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

182 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

183 ià(
wÜd_syms_f’ame
 != "") {

184 
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
);

185 ià(!
wÜd_syms
) {

186 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

187 << 
wÜd_syms_f’ame
;

191 
Ba£Flßt
 
tÙ_like
 = 0.0;

192 
k®di
::
št64
 
äame_couÁ
 = 0;

193 
num_sucûss
 = 0, 
num_ç
 = 0;

194 
Fa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
decod”_İts
);

196 
Tim”
 
tim”
;

198 
DecodeInfo
 
	`decode_šfo
(
am_gmm
, 
Œªs_mod–
, &
decod”
, 
acou¡ic_sÿË
,

199 
®low_·¹Ÿl
, 
wÜds_wr™”
, 
®ignm’t_wr™”
,

200 
wÜd_syms
);

202 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

203 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

204 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

206 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
(
ã©u»_»ad”
.
	`V®ue
());

207 
ã©u»_»ad”
.
	`F»eCu¼’t
();

208 ià(
ã©u»s
.
	`NumRows
() == 0) {

209 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

210 
num_ç
++;

214 ià(!
mÎr_»ad”
.
	`HasKey
(
u‰
)) {

215 
KALDI_WARN
 << "NØMLLR¿nsfÜm fÜ key " << 
u‰
 <<

217 
k®di
::
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

218 
ã©u»s
,

219 
acou¡ic_sÿË
);

220 ià(
	`DecodeU‰”ªû
(&
decod”
, &
gmm_decodabË
, &
decode_šfo
,

221 
u‰
, 
ã©u»s
.
	`NumRows
(), &
tÙ_like
)) {

222 
äame_couÁ
 +ğ
gmm_decodabË
.
	`NumF¿mesR—dy
();

223 
num_sucûss
++;

225 
num_ç
++;

231 cÚ¡ 
RegŒ“MÎrDŸgGmm
 &
mÎr
 = 
mÎr_»ad”
.
	`V®ue
(
u‰
);

232 
k®di
::
DecodabËAmDŸgGmmRegŒ“MÎr
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

233 
ã©u»s
, 
mÎr
,

234 
»gŒ“
,

235 
acou¡ic_sÿË
);

236 ià(
	`DecodeU‰”ªû
(&
decod”
, &
gmm_decodabË
, &
decode_šfo
,

237 
u‰
, 
ã©u»s
.
	`NumRows
(), &
tÙ_like
)) {

238 
äame_couÁ
 +ğ
gmm_decodabË
.
	`NumF¿mesR—dy
();

239 
num_sucûss
++;

241 
num_ç
++;

245 
–­£d
 = 
tim”
.
	`EÏp£d
();

246 
KALDI_LOG
 << "Timk’ [exşudšg in™Ÿliz©iÚ] " << 
–­£d


248 << (
–­£d
 * 100.0 / 
äame_couÁ
);

249 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

250 << 
num_ç
;

251 
KALDI_LOG
 << "Overall†og-likelihood…er frame is "

252 << (
tÙ_like
 / 
äame_couÁ
) << " over " << frame_count

255 
d–‘e
 
decode_f¡
;

256 ià(
num_sucûss
 != 0)

261 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

262 
¡d
::
û¼
 << 
e
.
	`wh©
();

265 
	}
}

	@gmm-decode-faster.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"f¡ext/f¡ext-lib.h
"

27 
	~"decod”/ç¡”-decod”.h
"

28 
	~"gmm/decodabË-am-dŸg-gmm.h
"

29 
	~"ba£/tim”.h
"

30 
	~"Ït/k®di-Ï‰iû.h
"

32 
Çme¥aû
 
	gk®di
 {

34 
	gf¡
::
F¡
<
f¡
::
StdArc
> *
R—dN‘wÜk
(
¡d
::
¡ršg
 
f’ame
) {

36 
IÅut
 
ki
(
f’ame
);

37 ià(!
	gki
.
SŒ—m
().
good
()è
	gKALDI_ERR
 << "Could‚ot open decoding-graph FST "

38 << 
	gf’ame
;

39 
	gf¡
::
F¡H—d”
 
hdr
;

40 ià(!
	ghdr
.
R—d
(
ki
.
SŒ—m
(), "<unknown>")) {

41 
	gKALDI_ERR
 << "Reading FST:ƒrror„eading FST header.";

43 ià(
	ghdr
.
ArcTy³
(è!ğ
f¡
::
StdArc
::
Ty³
()) {

44 
KALDI_ERR
 << "FST w™h‡røty³ " << 
hdr
.
ArcTy³
() << "‚ot supported.";

46 
	gf¡
::
F¡R—dO±iÚs
 
rİts
("<un¥ecif›d>", &
hdr
);

48 
	gf¡
::
F¡
<
f¡
::
StdArc
> *
decode_f¡
 = 
NULL
;

50 ià(
	ghdr
.
F¡Ty³
() == "vector") {

51 
decode_f¡
 = 
f¡
::
VeùÜF¡
<f¡::
StdArc
>::
R—d
(
ki
.
SŒ—m
(), 
rİts
);

52 } ià(
	ghdr
.
F¡Ty³
() == "const") {

53 
decode_f¡
 = 
f¡
::
CÚ¡F¡
<f¡::
StdArc
>::
R—d
(
ki
.
SŒ—m
(), 
rİts
);

55 
	gKALDI_ERR
 << "R—dšg FST: unsuµÜ‹d FSTy³: " << 
	ghdr
.
F¡Ty³
();

57 ià(
	gdecode_f¡
 =ğ
NULL
) {

58 
KALDI_ERR
 << "Error„eading FST (after„eading header).";

59  
	gNULL
;

61  
	gdecode_f¡
;

67 
	$maš
(
¬gc
, *
¬gv
[]) {

68 
Œy
 {

69 
usšg
 
Çme¥aû
 
k®di
;

70 
k®di
::
	tšt32
 int32;

72 cÚ¡ *
u§ge
 =

77 
P¬£O±iÚs
 
	`po
(
u§ge
);

78 
boŞ
 
®low_·¹Ÿl
 = 
Œue
;

79 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

81 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

82 
Fa¡”Decod”O±iÚs
 
decod”_İts
;

83 
decod”_İts
.
	`Regi¡”
(&
po
, 
Œue
);

84 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

86 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

88 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

90 
po
.
	`R—d
(
¬gc
, 
¬gv
);

92 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 6) {

93 
po
.
	`PrštU§ge
();

94 
	`ex™
(1);

97 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

98 
f¡_rxf’ame
 = 
po
.
	`G‘Arg
(2),

99 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

100 
wÜds_w¥ecif›r
 = 
po
.
	`G‘Arg
(4),

101 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(5),

102 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

104 
T¿ns™iÚMod–
 
Œªs_mod–
;

105 
AmDŸgGmm
 
am_gmm
;

107 
boŞ
 
bš¬y
;

108 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

109 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

110 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

113 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

115 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

117 
Com·ùL©tiûWr™”
 
	`ş©_wr™”
(
Ï‰iû_w¥ecif›r
);

119 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

120 ià(
wÜd_syms_f’ame
 != "")

121 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

122 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

123 << 
wÜd_syms_f’ame
;

125 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

132 
f¡
::
F¡
<f¡::
StdArc
> *
decode_f¡
 = 
	`R—dN‘wÜk
(
f¡_rxf’ame
);

134 
Ba£Flßt
 
tÙ_like
 = 0.0;

135 
k®di
::
št64
 
äame_couÁ
 = 0;

136 
num_sucûss
 = 0, 
num_ç
 = 0;

137 
Fa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
decod”_İts
);

139 
Tim”
 
tim”
;

141 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

142 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

143 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

144 
ã©u»_»ad”
.
	`F»eCu¼’t
();

145 ià(
ã©u»s
.
	`NumRows
() == 0) {

146 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
key
;

147 
num_ç
++;

151 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

152 
acou¡ic_sÿË
);

153 
decod”
.
	`Decode
(&
gmm_decodabË
);

155 
f¡
::
VeùÜF¡
<
L©tiûArc
> 
decoded
;

157 iàĞ(
®low_·¹Ÿl
 || 
decod”
.
	`R—chedFš®
())

158 && 
decod”
.
	`G‘Be¡P©h
(&
decoded
) ) {

159 ià(!
decod”
.
	`R—chedFš®
())

160 
KALDI_WARN
 << "Decoder did‚ot„eachƒnd-state, "

162 
num_sucûss
++;

163 
¡d
::
veùÜ
<
št32
> 
®ignm’t
;

164 
¡d
::
veùÜ
<
št32
> 
wÜds
;

165 
L©tiûWeight
 
weight
;

166 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

168 
	`G‘Lš—rSymbŞSequ’û
(
decoded
, &
®ignm’t
, &
wÜds
, &
weight
);

170 
wÜds_wr™”
.
	`Wr™e
(
key
, 
wÜds
);

171 ià(
®ignm’t_wr™”
.
	`IsO³n
())

172 
®ignm’t_wr™”
.
	`Wr™e
(
key
, 
®ignm’t
);

174 ià(
Ï‰iû_w¥ecif›r
 != "") {

176 ià(
acou¡ic_sÿË
 != 0.0)

177 
f¡
::
	`SÿËL©tiû
(f¡::
	`Acou¡icL©tiûSÿË
(1.0 / 
acou¡ic_sÿË
),

178 &
decoded
);

179 
f¡
::
VeùÜF¡
<
Com·ùL©tiûArc
> 
ş©
;

180 
	`CÚv”tL©tiû
(
decoded
, &
ş©
, 
Œue
);

181 
ş©_wr™”
.
	`Wr™e
(
key
, 
ş©
);

184 ià(
wÜd_syms
 !ğ
NULL
) {

185 
¡d
::
û¼
 << 
key
 << ' ';

186 
size_t
 
i
 = 0; i < 
wÜds
.
	`size
(); i++) {

187 
¡d
::
¡ršg
 
s
 = 
wÜd_syms
->
	`Fšd
(
wÜds
[
i
]);

188 ià(
s
 == "")

189 
KALDI_ERR
 << "WÜd-id " << 
wÜds
[
i
] <<"‚ot in symbolable.";

190 
¡d
::
û¼
 << 
s
 << ' ';

192 
¡d
::
û¼
 << '\n';

194 
Ba£Flßt
 
like
 = -
weight
.
	`V®ue1
(è-weight.
	`V®ue2
();

195 
tÙ_like
 +ğ
like
;

196 
KALDI_LOG
 << "Log-lik³¸äamfÜ u‰”ªû " << 
key
 << " is "

197 << (
like
 / 
ã©u»s
.
	`NumRows
()) << " over "

198 << 
ã©u»s
.
	`NumRows
() << " frames.";

199 
	`KALDI_VLOG
(2è<< "Co¡ fÜ u‰”ªû " << 
key
 << " is "

200 << 
weight
.
	`V®ue1
(è<< " + " << weight.
	`V®ue2
();

202 
num_ç
++;

203 
KALDI_WARN
 << "Did‚Ù sucûssfuÎy decodu‰”ªû " << 
key


204 << ",†’ = " << 
ã©u»s
.
	`NumRows
();

208 
–­£d
 = 
tim”
.
	`EÏp£d
();

209 
KALDI_LOG
 << "Timk’ [exşudšg in™Ÿliz©iÚ] "<< 
–­£d


211 << (
–­£d
*100.0/
äame_couÁ
);

212 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

213 << 
num_ç
;

214 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

215 << 
äame_couÁ
<<" frames.";

217 
d–‘e
 
wÜd_syms
;

218 
d–‘e
 
decode_f¡
;

219  (
num_sucûss
 != 0 ? 0 : 1);

220 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

221 
¡d
::
û¼
 << 
e
.
	`wh©
();

224 
	}
}

	@gmm-decode-simple.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"Œ“/cÚ‹xt-d•.h
"

26 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
	~"f¡ext/f¡ext-lib.h
"

28 
	~"decod”/sim¶e-decod”.h
"

29 
	~"gmm/decodabË-am-dŸg-gmm.h
"

30 
	~"f¡ext/Ï‰iû-uts.h
"

31 
	~"Ït/k®di-Ï‰iû.h
"

32 
	~"ba£/tim”.h
"

35 
	$maš
(
¬gc
, *
¬gv
[]) {

36 
Œy
 {

37 
usšg
 
Çme¥aû
 
k®di
;

38 
k®di
::
	tšt32
 int32;

39 
usšg
 
f¡
::
SymbŞTabË
;

40 
usšg
 
f¡
::
VeùÜF¡
;

41 
usšg
 
f¡
::
StdArc
;

42 
usšg
 
f¡
::
R—dF¡K®di
;

44 cÚ¡ *
u§ge
 =

52 
P¬£O±iÚs
 
	`po
(
u§ge
);

53 
Tim”
 
tim”
;

54 
boŞ
 
®low_·¹Ÿl
 = 
Œue
;

55 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

57 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

58 
Ba£Flßt
 
b—m
 = 16.0;

59 
po
.
	`Regi¡”
("b—m", &
b—m
, "Decoding†og-likelihood beam");

60 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

62 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

64 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

66 
po
.
	`R—d
(
¬gc
, 
¬gv
);

68 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 6) {

69 
po
.
	`PrštU§ge
();

70 
	`ex™
(1);

73 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

74 
f¡_š_f’ame
 = 
po
.
	`G‘Arg
(2),

75 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

76 
wÜds_w¥ecif›r
 = 
po
.
	`G‘Arg
(4),

77 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(5),

78 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

80 
T¿ns™iÚMod–
 
Œªs_mod–
;

81 
AmDŸgGmm
 
am_gmm
;

83 
boŞ
 
bš¬y
;

84 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

85 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

86 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

89 
VeùÜF¡
<
StdArc
> *
decode_f¡
 = 
	`R—dF¡K®di
(
f¡_š_f’ame
);

91 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

93 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

95 
Com·ùL©tiûWr™”
 
	`ş©_wr™”
(
Ï‰iû_w¥ecif›r
);

97 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

98 ià(
wÜd_syms_f’ame
 != "")

99 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

100 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

101 << 
wÜd_syms_f’ame
;

103 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

105 
Ba£Flßt
 
tÙ_like
 = 0.0;

106 
k®di
::
št64
 
äame_couÁ
 = 0;

107 
num_sucûss
 = 0, 
num_ç
 = 0;

108 
Sim¶eDecod”
 
	`decod”
(*
decode_f¡
, 
b—m
);

110 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

111 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

112 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

113 
ã©u»_»ad”
.
	`F»eCu¼’t
();

114 ià(
ã©u»s
.
	`NumRows
() == 0) {

115 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

116 
num_ç
++;

120 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

121 
acou¡ic_sÿË
);

122 
decod”
.
	`Decode
(&
gmm_decodabË
);

124 
VeùÜF¡
<
L©tiûArc
> 
decoded
;

126 iàĞ(
®low_·¹Ÿl
 || 
decod”
.
	`R—chedFš®
())

127 && 
decod”
.
	`G‘Be¡P©h
(&
decoded
) ) {

128 ià(!
decod”
.
	`R—chedFš®
())

129 
KALDI_WARN
 << "Decoder did‚ot„eachƒnd-state, "

131 
num_sucûss
++;

133 
¡d
::
veùÜ
<
št32
> 
®ignm’t
;

134 
¡d
::
veùÜ
<
št32
> 
wÜds
;

135 
L©tiûWeight
 
weight
;

136 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

138 
	`G‘Lš—rSymbŞSequ’û
(
decoded
, &
®ignm’t
, &
wÜds
, &
weight
);

140 
wÜds_wr™”
.
	`Wr™e
(
u‰
, 
wÜds
);

141 ià(
®ignm’t_w¥ecif›r
 != "")

142 
®ignm’t_wr™”
.
	`Wr™e
(
u‰
, 
®ignm’t
);

143 ià(
Ï‰iû_w¥ecif›r
 != "") {

145 ià(
acou¡ic_sÿË
 != 0.0)

146 
f¡
::
	`SÿËL©tiû
(f¡::
	`Acou¡icL©tiûSÿË
(1.0 / 
acou¡ic_sÿË
),

147 &
decoded
);

148 
f¡
::
VeùÜF¡
<
Com·ùL©tiûArc
> 
ş©
;

149 
	`CÚv”tL©tiû
(
decoded
, &
ş©
, 
Œue
);

150 
ş©_wr™”
.
	`Wr™e
(
u‰
, 
ş©
);

152 ià(
wÜd_syms
 !ğ
NULL
) {

153 
¡d
::
û¼
 << 
u‰
 << ' ';

154 
size_t
 
i
 = 0; i < 
wÜds
.
	`size
(); i++) {

155 
¡d
::
¡ršg
 
s
 = 
wÜd_syms
->
	`Fšd
(
wÜds
[
i
]);

156 ià(
s
 == "")

157 
KALDI_ERR
 << "WÜd-id " << 
wÜds
[
i
] <<"‚ot in symbolable.";

158 
¡d
::
û¼
 << 
s
 << ' ';

160 
¡d
::
û¼
 << '\n';

162 
Ba£Flßt
 
like
 = -
	`CÚv”tToCo¡
(
weight
);

163 
tÙ_like
 +ğ
like
;

164 
KALDI_LOG
 << "Log-lik³¸äamfÜ u‰”ªû " << 
u‰
 << " is "

165 << (
like
 / 
ã©u»s
.
	`NumRows
()) << " over "

166 << 
ã©u»s
.
	`NumRows
() << " frames.";

168 
num_ç
++;

169 
KALDI_WARN
 << "Did‚Ù sucûssfuÎy decodu‰”ªû " << 
u‰


170 << ",†’ = " << 
ã©u»s
.
	`NumRows
();

174 
–­£d
 = 
tim”
.
	`EÏp£d
();

175 
KALDI_LOG
 << "Timk’ "<< 
–­£d


177 << (
–­£d
*100.0/
äame_couÁ
);

178 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

179 << 
num_ç
;

180 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

181 << 
äame_couÁ
<<" frames.";

183 
d–‘e
 
wÜd_syms
;

184 
d–‘e
 
decode_f¡
;

185 ià(
num_sucûss
 != 0)  0;

187 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

188 
¡d
::
û¼
 << 
e
.
	`wh©
();

191 
	}
}

	@gmm-est-basis-fmllr-gpost.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
	~"ŒªsfÜm/basis-fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

34 
Çme¥aû
 
	gk®di
 {

35 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

36 cÚ¡ 
GaussPo¡
 &
gpo¡
,

37 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

38 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

39 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

40 
size_t
 
	gi
 = 0; i < 
	ggpo¡
.
size
(); i++) {

41 
size_t
 
	gj
 = 0; j < 
	ggpo¡
[
i
].
size
(); j++) {

42 
št32
 
	gpdf_id
 = 
gpo¡
[
i
][
j
].
fœ¡
;

43 cÚ¡ 
	gVeùÜ
<
	gBa£Flßt
> & 
po¡”iÜ
(
gpo¡
[
i
][
j
].
£cÚd
);

44 
	g¥k_¡©s
->
AccumuÏ‹FromPo¡”iÜs
(
am_gmm
.
G‘Pdf
(
pdf_id
),

45 
ã©s
.
Row
(
i
), 
po¡”iÜ
);

53 
	$maš
(
¬gc
, *
¬gv
[]) {

54 
Œy
 {

55 
k®di
::
	tšt32
 int32;

56 
usšg
 
Çme¥aû
 
k®di
;

57 cÚ¡ *
u§ge
 =

65 
P¬£O±iÚs
 
	`po
(
u§ge
);

66 
BasisFmÎrO±iÚs
 
basis_fmÎr_İts
;

67 
¡ršg
 
¥k2u‰_r¥ecif›r
;

68 
¡ršg
 
weights_out_f’ame
;

70 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "Rspecifier for speakero "

72 
po
.
	`Regi¡”
("wr™e-weights", &
weights_out_f’ame
, "Fileo write base "

75 
basis_fmÎr_İts
.
	`Regi¡”
(&
po
);

77 
po
.
	`R—d
(
¬gc
, 
¬gv
);

78 ià(
po
.
	`NumArgs
() != 5) {

79 
po
.
	`PrštU§ge
();

80 
	`ex™
(1);

83 
¡ršg


84 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

85 
basis_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

86 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

87 
gpo¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

88 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

90 
T¿ns™iÚMod–
 
Œªs_mod–
;

91 
AmDŸgGmm
 
am_gmm
;

93 
boŞ
 
bš¬y
;

94 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

95 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

96 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

99 
BasisFmÎrE¡im©e
 
basis_e¡
;

100 
	`R—dK®diObjeù
(
basis_r¥ecif›r
, &
basis_e¡
);

102 
RªdomAcûssGaussPo¡R—d”
 
	`gpo¡_»ad”
(
gpo¡_r¥ecif›r
);

104 
tÙ_im´
 = 0.0, 
tÙ_t
 = 0.0;

106 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

107 
Ba£FlßtVeùÜWr™”
 
weights_wr™”
;

108 ià(!
weights_out_f’ame
.
	`em±y
()) {

109 
weights_wr™”
.
	`O³n
(
weights_out_f’ame
);

112 
št32
 
num_dÚe
 = 0, 
num_no_po¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

113 ià(
¥k2u‰_r¥ecif›r
 != "") {

114 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

115 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

117 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

118 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

119 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

120 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

121 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

122 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

123 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

124 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

125 
num_Ùh”_”rÜ
++;

128 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

129 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

130 
num_no_po¡
++;

133 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

134 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

135 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

136 
KALDI_WARN
 << "GaussPo¡ ha wrÚg siz" << (
gpo¡
.
	`size
())

137 << " vs. " << (
ã©s
.
	`NumRows
());

138 
num_Ùh”_”rÜ
++;

142 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

143 
num_dÚe
++;

146 
im´
, 
¥k_tÙ_t
; 
št32
 
wgt_size
;

149 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim() + 1);

150 
ŒªsfÜm
.
	`S‘Un™
();

151 
VeùÜ
<
Ba£Flßt
> 
weights
;

152 
im´
 = 
basis_e¡
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
, &
ŒªsfÜm
,

153 &
weights
, 
basis_fmÎr_İts
);

154 
¥k_tÙ_t
 = 
¥k_¡©s
.
b‘a_
;

155 
wgt_size
 = 
weights
.
	`Dim
();

156 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

158 ià(!
weights_out_f’ame
.
	`em±y
(è&& 
weights
.
	`Dim
() > 0)

159 
weights_wr™”
.
	`Wr™e
(
¥k
, 
weights
);

162 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from Basis fMLLR is "

163 << (
im´
 / 
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames, "

164 << "thtİ " << 
wgt_size
 << " basisƒlements have been used";

165 
tÙ_im´
 +ğ
im´
;

166 
tÙ_t
 +ğ
¥k_tÙ_t
;

169 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

170 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

171 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

172 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

173 
KALDI_WARN
 << "Did‚Ù fšd…o¡ fÜ u‰”ªû " << 
u‰
;

174 
num_no_po¡
++;

177 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

178 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

180 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

181 
KALDI_WARN
 << "GaussPo¡ ha wrÚg siz" << (
gpo¡
.
	`size
())

182 << " vs. " << (
ã©s
.
	`NumRows
());

183 
num_Ùh”_”rÜ
++;

187 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

188 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

189 
num_dÚe
++;

191 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
; 
št32
 
wgt_size
;

193 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim()+1);

194 
ŒªsfÜm
.
	`S‘Un™
();

195 
VeùÜ
<
Ba£Flßt
> 
weights
;

196 
im´
 = 
basis_e¡
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
, &
ŒªsfÜm
,

197 &
weights
, 
basis_fmÎr_İts
);

198 
u‰_tÙ_t
 = 
¥k_¡©s
.
b‘a_
;

199 
wgt_size
 = 
weights
.
	`Dim
();

200 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

202 ià(!
weights_out_f’ame
.
	`em±y
(è&& 
weights
.
	`Dim
() > 0)

203 
weights_wr™”
.
	`Wr™e
(
u‰
, 
weights
);

205 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from Basis fMLLR is "

206 << (
im´
 / 
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames, "

207 << "thtİ " << 
wgt_size
 << " basisƒlements have been used";

208 
tÙ_im´
 +ğ
im´
;

209 
tÙ_t
 +ğ
u‰_tÙ_t
;

213 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡


214 << " w™h‚Øpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

215 
KALDI_LOG
 << "Overall fMLLR‡uxf-impr…er frame is "

216 << (
tÙ_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

217  (
num_dÚe
 != 0 ? 0 : 1);

218 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

219 
¡d
::
û¼
 << 
e
.
	`wh©
();

222 
	}
}

	@gmm-est-basis-fmllr.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
	~"ŒªsfÜm/basis-fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

34 
Çme¥aû
 
	gk®di
 {

35 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

36 cÚ¡ 
Po¡”iÜ
 &
po¡
,

37 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

38 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

39 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

40 
Po¡”iÜ
 
	gpdf_po¡
;

41 
CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡
, &
pdf_po¡
);

42 
size_t
 
	gi
 = 0; i < 
	gpo¡
.
size
(); i++) {

43 
size_t
 
	gj
 = 0; j < 
	gpdf_po¡
[
i
].
size
(); j++) {

44 
št32
 
	gpdf_id
 = 
pdf_po¡
[
i
][
j
].
fœ¡
;

45 
	g¥k_¡©s
->
AccumuÏ‹FÜGmm
(
am_gmm
.
G‘Pdf
(
pdf_id
),

46 
ã©s
.
Row
(
i
),

47 
pdf_po¡
[
i
][
j
].
£cÚd
);

55 
	$maš
(
¬gc
, *
¬gv
[]) {

56 
Œy
 {

57 
k®di
::
	tšt32
 int32;

58 
usšg
 
Çme¥aû
 
k®di
;

59 cÚ¡ *
u§ge
 =

67 
P¬£O±iÚs
 
	`po
(
u§ge
);

68 
BasisFmÎrO±iÚs
 
basis_fmÎr_İts
;

69 
¡ršg
 
¥k2u‰_r¥ecif›r
;

70 
¡ršg
 
weights_out_f’ame
;

72 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "Rspecifier for speakero "

74 
po
.
	`Regi¡”
("wr™e-weights", &
weights_out_f’ame
, "Fileo write base "

77 
basis_fmÎr_İts
.
	`Regi¡”
(&
po
);

79 
po
.
	`R—d
(
¬gc
, 
¬gv
);

80 ià(
po
.
	`NumArgs
() != 5) {

81 
po
.
	`PrštU§ge
();

82 
	`ex™
(1);

85 
¡ršg


86 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

87 
basis_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

88 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

89 
po¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

90 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

92 
T¿ns™iÚMod–
 
Œªs_mod–
;

93 
AmDŸgGmm
 
am_gmm
;

95 
boŞ
 
bš¬y
;

96 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

97 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

98 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

101 
BasisFmÎrE¡im©e
 
basis_e¡
;

102 
	`R—dK®diObjeù
(
basis_r¥ecif›r
, &
basis_e¡
);

104 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡_r¥ecif›r
);

106 
tÙ_im´
 = 0.0, 
tÙ_t
 = 0.0;

108 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

109 
Ba£FlßtVeùÜWr™”
 
weights_wr™”
;

110 ià(!
weights_out_f’ame
.
	`em±y
()) {

111 
weights_wr™”
.
	`O³n
(
weights_out_f’ame
);

114 
št32
 
num_dÚe
 = 0, 
num_no_po¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

115 ià(
¥k2u‰_r¥ecif›r
 != "") {

116 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

117 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

119 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

120 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

121 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

122 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

123 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

124 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

125 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

126 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

127 
num_Ùh”_”rÜ
++;

130 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

131 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

132 
num_no_po¡
++;

135 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

136 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

137 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

138 
KALDI_WARN
 << "Po¡”iÜ veùÜ ha wrÚg siz" << (
po¡
.
	`size
())

139 << " vs. " << (
ã©s
.
	`NumRows
());

140 
num_Ùh”_”rÜ
++;

144 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

145 
num_dÚe
++;

148 
im´
, 
¥k_tÙ_t
; 
št32
 
wgt_size
;

151 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim() + 1);

152 
ŒªsfÜm
.
	`S‘Un™
();

153 
VeùÜ
<
Ba£Flßt
> 
weights
;

154 
im´
 = 
basis_e¡
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
, &
ŒªsfÜm
,

155 &
weights
, 
basis_fmÎr_İts
);

156 
¥k_tÙ_t
 = 
¥k_¡©s
.
b‘a_
;

157 
wgt_size
 = 
weights
.
	`Dim
();

158 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

160 ià(!
weights_out_f’ame
.
	`em±y
(è&& 
weights
.
	`Dim
() > 0)

161 
weights_wr™”
.
	`Wr™e
(
¥k
, 
weights
);

163 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from Basis fMLLR is "

164 << (
im´
 / 
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames, "

165 << "thtİ " << 
wgt_size
 << " basisƒlements have been used";

166 
tÙ_im´
 +ğ
im´
;

167 
tÙ_t
 +ğ
¥k_tÙ_t
;

170 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

171 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

172 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

173 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

174 
KALDI_WARN
 << "Did‚Ù fšd…o¡ fÜ u‰”ªû " << 
u‰
;

175 
num_no_po¡
++;

178 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

179 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

181 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

182 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡
.
	`size
())

183 << " vs. " << (
ã©s
.
	`NumRows
());

184 
num_Ùh”_”rÜ
++;

188 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

189 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

190 
num_dÚe
++;

192 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
; 
št32
 
wgt_size
;

194 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim()+1);

195 
ŒªsfÜm
.
	`S‘Un™
();

196 
VeùÜ
<
Ba£Flßt
> 
	`weights
(
am_gmm
.
	`Dim
() * (am_gmm.Dim() + 1));

197 
im´
 = 
basis_e¡
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
, &
ŒªsfÜm
,

198 &
weights
, 
basis_fmÎr_İts
);

199 
u‰_tÙ_t
 = 
¥k_¡©s
.
b‘a_
;

200 
wgt_size
 = 
weights
.
	`Dim
();

201 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

203 ià(!
weights_out_f’ame
.
	`em±y
(è&& 
weights
.
	`Dim
() > 0)

204 
weights_wr™”
.
	`Wr™e
(
u‰
, 
weights
);

206 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from Basis fMLLR is "

207 << (
im´
 / 
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames, "

208 << "thtİ " << 
wgt_size
 << " basisƒlements have been used";

209 
tÙ_im´
 +ğ
im´
;

210 
tÙ_t
 +ğ
u‰_tÙ_t
;

214 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡


215 << " w™h‚Øpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

216 
KALDI_LOG
 << "Overall fMLLR‡uxf-impr…er frame is "

217 << (
tÙ_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

218  (
num_dÚe
 != 0 ? 0 : 1);

219 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

220 
¡d
::
û¼
 << 
e
.
	`wh©
();

223 
	}
}

	@gmm-est-fmllr-global.cc

22 
	~<¡ršg
>

23 
usšg
 
	g¡d
::
¡ršg
;

24 
	~<veùÜ
>

25 
usšg
 
	g¡d
::
veùÜ
;

27 
	~"ba£/k®di-commÚ.h
"

28 
	~"ut/commÚ-uts.h
"

29 
	~"gmm/am-dŸg-gmm.h
"

30 
	~"hmm/Œªs™iÚ-mod–.h
"

31 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

36 
	$maš
(
¬gc
, *
¬gv
[]) {

37 
Œy
 {

38 
k®di
::
	tšt32
 int32;

39 
usšg
 
Çme¥aû
 
k®di
;

40 cÚ¡ *
u§ge
 =

48 
P¬£O±iÚs
 
	`po
(
u§ge
);

49 
FmÎrO±iÚs
 
fmÎr_İts
;

50 
¡ršg
 
¥k2u‰_r¥ecif›r
;

51 
¡ršg
 
g£Ëù_r¥ecif›r
;

52 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

54 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "rspecifier for "

56 
fmÎr_İts
.
	`Regi¡”
(&
po
);

58 
po
.
	`R—d
(
¬gc
, 
¬gv
);

60 ià(
po
.
	`NumArgs
() != 3) {

61 
po
.
	`PrštU§ge
();

62 
	`ex™
(1);

65 
¡ršg
 
gmm_rxf’ame
 = 
po
.
	`G‘Arg
(1),

66 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

67 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(3);

69 
DŸgGmm
 
gmm
;

70 
	`R—dK®diObjeù
(
gmm_rxf’ame
, &
gmm
);

72 
tÙ_im´
 = 0.0, 
tÙ_t
 = 0.0;

74 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

75 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

77 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

78 ià(
¥k2u‰_r¥ecif›r
 != "") {

79 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

80 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

82 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

83 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
gmm
.
	`Dim
(), 
fmÎr_İts
);

84 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

85 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

86 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

87 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

88 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

89 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

90 
num_”r
++;

93 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

95 ià(
g£Ëù_r¥ecif›r
 == "") {

96 
size_t
 
i
 = 0; i < 
ã©s
.
	`NumRows
(); i++)

97 
¥k_¡©s
.
	`AccumuÏ‹FÜGmm
(
gmm
, 
ã©s
.
	`Row
(
i
), 1.0);

99 ià(!
g£Ëù_»ad”
.
	`HasKey
(
u‰
) ||

100 
g£Ëù_»ad”
.
	`V®ue
(
u‰
).
	`size
(è!ğ
ã©s
.
	`NumRows
()) {

101 
KALDI_LOG
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
u‰


103 
num_”r
++;

106 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
 =

107 
g£Ëù_»ad”
.
	`V®ue
(
u‰
);

108 
size_t
 
i
 = 0; i < 
ã©s
.
	`NumRows
(); i++)

109 
¥k_¡©s
.
	`AccumuÏ‹FÜGmmP»£Ëù
(
gmm
, 
g£Ëù
[
i
],

110 
ã©s
.
	`Row
(
i
), 1.0);

112 
num_dÚe
++;

115 
Ba£Flßt
 
im´
, 
¥k_tÙ_t
;

117 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
gmm
.
	`Dim
(), gmm.Dim()+1);

118 
ŒªsfÜm
.
	`S‘Un™
();

119 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
¥k_tÙ_t
);

120 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

122 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from fMLLR is "

123 << (
im´
/
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames.";

124 
tÙ_im´
 +ğ
im´
;

125 
tÙ_t
 +ğ
¥k_tÙ_t
;

128 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

129 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

130 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

131 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

133 
num_dÚe
++;

135 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
gmm
.
	`Dim
(), 
fmÎr_İts
);

137 ià(
g£Ëù_r¥ecif›r
 == "") {

138 
size_t
 
i
 = 0; i < 
ã©s
.
	`NumRows
(); i++)

139 
¥k_¡©s
.
	`AccumuÏ‹FÜGmm
(
gmm
, 
ã©s
.
	`Row
(
i
), 1.0);

141 ià(!
g£Ëù_»ad”
.
	`HasKey
(
u‰
) ||

142 
g£Ëù_»ad”
.
	`V®ue
(
u‰
).
	`size
(è!ğ
ã©s
.
	`NumRows
()) {

143 
KALDI_LOG
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
u‰


145 
num_”r
++;

148 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
 =

149 
g£Ëù_»ad”
.
	`V®ue
(
u‰
);

150 
size_t
 
i
 = 0; i < 
ã©s
.
	`NumRows
(); i++)

151 
¥k_¡©s
.
	`AccumuÏ‹FÜGmmP»£Ëù
(
gmm
, 
g£Ëù
[
i
],

152 
ã©s
.
	`Row
(
i
), 1.0);

154 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
;

156 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
gmm
.
	`Dim
(), gmm.Dim()+1);

157 
ŒªsfÜm
.
	`S‘Un™
();

158 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
u‰_tÙ_t
);

159 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

161 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from fMLLR is "

162 << (
im´
/
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames.";

163 
tÙ_im´
 +ğ
im´
;

164 
tÙ_t
 +ğ
u‰_tÙ_t
;

167 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " files, "

168 << 
num_”r
 << " withƒrrors.";

169 
KALDI_LOG
 << "Overall fMLLR‡uxf impr…er frame is "

170 << (
tÙ_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

171  (
num_dÚe
 != 0 ? 0 : 1);

172 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

173 
¡d
::
û¼
 << 
e
.
	`wh©
();

176 
	}
}

	@gmm-est-fmllr-gpost.cc

22 
	~<¡ršg
>

23 
usšg
 
	g¡d
::
¡ršg
;

24 
	~<veùÜ
>

25 
usšg
 
	g¡d
::
veùÜ
;

27 
	~"ba£/k®di-commÚ.h
"

28 
	~"ut/commÚ-uts.h
"

29 
	~"gmm/am-dŸg-gmm.h
"

30 
	~"hmm/Œªs™iÚ-mod–.h
"

31 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

34 
Çme¥aû
 
	gk®di
 {

35 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

36 cÚ¡ 
GaussPo¡
 &
gpo¡
,

37 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

38 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

39 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

40 
size_t
 
	gi
 = 0; i < 
	ggpo¡
.
size
(); i++) {

41 
size_t
 
	gj
 = 0; j < 
	ggpo¡
[
i
].
size
(); j++) {

42 
št32
 
	gpdf_id
 = 
gpo¡
[
i
][
j
].
fœ¡
;

43 cÚ¡ 
	gVeùÜ
<
	gBa£Flßt
> & 
po¡”iÜ
(
gpo¡
[
i
][
j
].
£cÚd
);

44 
	g¥k_¡©s
->
AccumuÏ‹FromPo¡”iÜs
(
am_gmm
.
G‘Pdf
(
pdf_id
),

45 
ã©s
.
Row
(
i
), 
po¡”iÜ
);

53 
	$maš
(
¬gc
, *
¬gv
[]) {

54 
Œy
 {

55 
k®di
::
	tšt32
 int32;

56 
usšg
 
Çme¥aû
 
k®di
;

57 cÚ¡ *
u§ge
 =

64 
P¬£O±iÚs
 
	`po
(
u§ge
);

65 
FmÎrO±iÚs
 
fmÎr_İts
;

66 
¡ršg
 
¥k2u‰_r¥ecif›r
;

67 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

69 
fmÎr_İts
.
	`Regi¡”
(&
po
);

71 
po
.
	`R—d
(
¬gc
, 
¬gv
);

73 ià(
po
.
	`NumArgs
() != 4) {

74 
po
.
	`PrštU§ge
();

75 
	`ex™
(1);

78 
¡ršg


79 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

80 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

81 
gpo¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

82 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

84 
T¿ns™iÚMod–
 
Œªs_mod–
;

85 
AmDŸgGmm
 
am_gmm
;

87 
boŞ
 
bš¬y
;

88 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

89 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

90 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

93 
RªdomAcûssGaussPo¡R—d”
 
	`gpo¡_»ad”
(
gpo¡_r¥ecif›r
);

95 
tÙ_im´
 = 0.0, 
tÙ_t
 = 0.0;

97 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

99 
št32
 
num_dÚe
 = 0, 
num_no_gpo¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

100 ià(
¥k2u‰_r¥ecif›r
 != "") {

101 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

102 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

104 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

105 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

106 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

107 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

108 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

109 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

110 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

111 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

112 
num_Ùh”_”rÜ
++;

115 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

116 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

117 
num_no_gpo¡
++;

120 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

121 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

122 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

123 
KALDI_WARN
 << "GaussPo¡ veùÜ ha wrÚg siz" << (
gpo¡
.
	`size
())

124 << " vs. " << (
ã©s
.
	`NumRows
());

125 
num_Ùh”_”rÜ
++;

129 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

131 
num_dÚe
++;

134 
Ba£Flßt
 
im´
, 
¥k_tÙ_t
;

136 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim()+1);

137 
ŒªsfÜm
.
	`S‘Un™
();

138 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
¥k_tÙ_t
);

139 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

141 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from fMLLR is "

142 << (
im´
/
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames.\n";

143 
tÙ_im´
 +ğ
im´
;

144 
tÙ_t
 +ğ
¥k_tÙ_t
;

147 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

148 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

149 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

150 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

151 
KALDI_WARN
 << "Did‚ot find gposts for utterance "

152 << 
u‰
;

153 
num_no_gpo¡
++;

156 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

157 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

159 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

160 
KALDI_WARN
 << "GaussPo¡ ha wrÚg siz" << (
gpo¡
.
	`size
())

161 << " vs. " << (
ã©s
.
	`NumRows
());

162 
num_Ùh”_”rÜ
++;

165 
num_dÚe
++;

167 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
());

169 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
Œªs_mod–
, 
am_gmm
,

170 &
¥k_¡©s
);

172 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
;

174 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim()+1);

175 
ŒªsfÜm
.
	`S‘Un™
();

176 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
u‰_tÙ_t
);

177 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

179 
KALDI_LOG
 << "FÜ u‰”ªû¸" << 
u‰
 << ",‡uxf-impr from fMLLR is "

180 << (
im´
/
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames.";

181 
tÙ_im´
 +ğ
im´
;

182 
tÙ_t
 +ğ
u‰_tÙ_t
;

186 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_gpo¡


187 << " w™h‚Øgpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

188 
KALDI_LOG
 << "Overall fMLLR‡uxf impr…er frame is "

189 << (
tÙ_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

190  (
num_dÚe
 != 0 ? 0 : 1);

191 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

192 
¡d
::
û¼
 << 
e
.
	`wh©
();

195 
	}
}

	@gmm-est-fmllr-raw-gpost.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ŒªsfÜm/fmÎr-¿w.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"ut/commÚ-uts.h
"

26 
	~"hmm/po¡”iÜ.h
"

28 
Çme¥aû
 
	gk®di
 {

31 
AccStsFÜU‰”ªû
(cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

32 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

33 cÚ¡ 
GaussPo¡
 &
gpo¡
,

34 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

35 
FmÎrRawAccs
 *
accs
) {

36 
size_t
 
	gt
 = 0; < 
	ggpo¡
.
size
();++) {

37 
size_t
 
	gi
 = 0; i < 
	ggpo¡
[
t
].
size
(); i++) {

38 
št32
 
	gpdf
 = 
gpo¡
[
t
][
i
].
fœ¡
;

39 cÚ¡ 
	gVeùÜ
<
	gBa£Flßt
> &
po¡”iÜ
(
gpo¡
[
t
][
i
].
£cÚd
);

40 
	gaccs
->
AccumuÏ‹FromPo¡”iÜs
(
am_gmm
.
G‘Pdf
(
pdf
),

41 
ã©s
.
Row
(
t
), 
po¡”iÜ
);

49 
	$maš
(
¬gc
, *
¬gv
[]) {

50 
Œy
 {

51 
k®di
::
	tšt32
 int32;

52 
usšg
 
Çme¥aû
 
k®di
;

53 cÚ¡ *
u§ge
 =

63 
št32
 
¿w_ã©_dim
 = 13;

64 
P¬£O±iÚs
 
	`po
(
u§ge
);

65 
FmÎrRawO±iÚs
 
İts
;

66 
¡d
::
¡ršg
 
¥k2u‰_r¥ecif›r
;

67 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

69 
po
.
	`Regi¡”
("¿w-ã©-dim", &
¿w_ã©_dim
, "Dimension of„aw features "

71 
İts
.
	`Regi¡”
(&
po
);

73 
po
.
	`R—d
(
¬gc
, 
¬gv
);

75 ià(
po
.
	`NumArgs
() != 5) {

76 
po
.
	`PrštU§ge
();

77 
	`ex™
(1);

80 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

81 
fuÎ_lda_m©_rxf’ame
 = 
po
.
	`G‘Arg
(2),

82 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

83 
gpo¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

84 
ŒªsfÜm_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

86 
AmDŸgGmm
 
am_gmm
;

87 
T¿ns™iÚMod–
 
Œªs_mod–
;

89 
boŞ
 
bš¬y
;

90 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

91 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

92 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

95 
M©rix
<
Ba£Flßt
> 
fuÎ_lda_m©
;

96 
	`R—dK®diObjeù
(
fuÎ_lda_m©_rxf’ame
, &
fuÎ_lda_m©
);

98 
RªdomAcûssGaussPo¡R—d”
 
	`gpo¡_»ad”
(
gpo¡_r¥ecif›r
);

99 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
ŒªsfÜm_w¥ecif›r
);

101 
tÙ_auxf_im´
 = 0.0, 
tÙ_couÁ
 = 0.0;

103 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

104 ià(!
¥k2u‰_r¥ecif›r
.
	`em±y
()) {

105 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

106 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

108 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

109 
FmÎrRawAccs
 
	`accs
(
¿w_ã©_dim
, 
am_gmm
.
	`Dim
(), 
fuÎ_lda_m©
);

110 
¡d
::
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

111 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

112 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

113 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

114 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

115 
KALDI_WARN
 << "F—tu» nÙ found fÜ u‰”ªû " << 
u‰
;

116 
num_”r
++;

119 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

120 
KALDI_WARN
 << "GaussŸn-Ëv–…o¡”iÜ nÙ found fÜ u‰”ªû " << 
u‰
;

121 
num_”r
++;

124 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

125 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

126 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

127 
KALDI_WARN
 << "Sizmism©ch b‘w“Àgpo¡”iÜ " << 
gpo¡
.
	`size
()

128 << "‡nd f—tu» " << 
ã©s
.
	`NumRows
();

129 
num_”r
++;

133 
	`AccStsFÜU‰”ªû
(
Œªs_mod–
, 
am_gmm
, 
gpo¡
, 
ã©s
, &
accs
);

134 
num_dÚe
++;

137 
Ba£Flßt
 
auxf_im´
, 
couÁ
;

139 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
¿w_ã©_dim
,„aw_feat_dim + 1);

140 
ŒªsfÜm
.
	`S‘Un™
();

141 
accs
.
	`Upd©e
(
İts
, &
ŒªsfÜm
, &
auxf_im´
, &
couÁ
);

142 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

144 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from„aw fMLLR is "

145 << (
auxf_im´
/
couÁ
) << " over " << count << " frames.";

146 
tÙ_auxf_im´
 +ğ
auxf_im´
;

147 
tÙ_couÁ
 +ğ
couÁ
;

150 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

151 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

152 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

153 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

154 
KALDI_WARN
 << "GaussŸn-Ëv–…o¡”iÜ nÙ found fÜ u‰”ªû " << 
u‰
;

155 
num_”r
++;

158 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

159 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

161 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

162 
KALDI_WARN
 << "Sizmism©ch b‘w“Àpo¡”iÜ " << 
gpo¡
.
	`size
()

163 << "‡nd f—tu» " << 
ã©s
.
	`NumRows
();

164 
num_”r
++;

168 
FmÎrRawAccs
 
	`accs
(
¿w_ã©_dim
, 
am_gmm
.
	`Dim
(), 
fuÎ_lda_m©
);

170 
	`AccStsFÜU‰”ªû
(
Œªs_mod–
, 
am_gmm
, 
gpo¡
, 
ã©s
, &
accs
);

172 
Ba£Flßt
 
auxf_im´
, 
couÁ
;

174 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
¿w_ã©_dim
,„aw_feat_dim + 1);

175 
ŒªsfÜm
.
	`S‘Un™
();

176 
accs
.
	`Upd©e
(
İts
, &
ŒªsfÜm
, &
auxf_im´
, &
couÁ
);

177 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

179 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from„aw fMLLR is "

180 << (
auxf_im´
/
couÁ
) << " over " << count << " frames.";

181 
tÙ_auxf_im´
 +ğ
auxf_im´
;

182 
tÙ_couÁ
 +ğ
couÁ
;

183 
num_dÚe
++;

187 
KALDI_LOG
 << "Proûs£d " << 
num_dÚe
 << " utterances, "

188 << 
num_”r
 << " hadƒrrors.";

189 
KALDI_LOG
 << "Overall„aw-fMLLR‡uxf impr…er frame is "

190 << (
tÙ_auxf_im´
 / 
tÙ_couÁ
) << " over " <<ot_count

192  (
num_dÚe
 != 0 ? 0 : 1);

193 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

194 
¡d
::
û¼
 << 
e
.
	`wh©
();

197 
	}
}

	@gmm-est-fmllr-raw.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ŒªsfÜm/fmÎr-¿w.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"ut/commÚ-uts.h
"

26 
	~"hmm/po¡”iÜ.h
"

28 
Çme¥aû
 
	gk®di
 {

31 
AccStsFÜU‰”ªû
(cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

32 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

33 cÚ¡ 
Po¡”iÜ
 &
po¡
,

34 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

35 
FmÎrRawAccs
 *
accs
) {

36 
Po¡”iÜ
 
	gpdf_po¡
;

37 
CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡
, &
pdf_po¡
);

38 
size_t
 
	gt
 = 0; < 
	gpo¡
.
size
();++) {

39 
size_t
 
	gi
 = 0; i < 
	gpdf_po¡
[
t
].
size
(); i++) {

40 
št32
 
	gpdf
 = 
pdf_po¡
[
t
][
i
].
fœ¡
;

41 
Ba£Flßt
 
	gweight
 = 
pdf_po¡
[
t
][
i
].
£cÚd
;

42 
	gaccs
->
AccumuÏ‹FÜGmm
(
am_gmm
.
G‘Pdf
(
pdf
),

43 
ã©s
.
Row
(
t
), 
weight
);

51 
	$maš
(
¬gc
, *
¬gv
[]) {

52 
Œy
 {

53 
k®di
::
	tšt32
 int32;

54 
usšg
 
Çme¥aû
 
k®di
;

55 cÚ¡ *
u§ge
 =

64 
št32
 
¿w_ã©_dim
 = 13;

65 
P¬£O±iÚs
 
	`po
(
u§ge
);

66 
FmÎrRawO±iÚs
 
İts
;

67 
¡d
::
¡ršg
 
¥k2u‰_r¥ecif›r
;

68 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

70 
po
.
	`Regi¡”
("¿w-ã©-dim", &
¿w_ã©_dim
, "Dimension of„aw features "

72 
İts
.
	`Regi¡”
(&
po
);

74 
po
.
	`R—d
(
¬gc
, 
¬gv
);

76 ià(
po
.
	`NumArgs
() != 5) {

77 
po
.
	`PrštU§ge
();

78 
	`ex™
(1);

81 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

82 
fuÎ_lda_m©_rxf’ame
 = 
po
.
	`G‘Arg
(2),

83 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

84 
po¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

85 
ŒªsfÜm_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

87 
AmDŸgGmm
 
am_gmm
;

88 
T¿ns™iÚMod–
 
Œªs_mod–
;

90 
boŞ
 
bš¬y
;

91 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

92 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

93 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

96 
M©rix
<
Ba£Flßt
> 
fuÎ_lda_m©
;

97 
	`R—dK®diObjeù
(
fuÎ_lda_m©_rxf’ame
, &
fuÎ_lda_m©
);

99 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡_r¥ecif›r
);

100 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
ŒªsfÜm_w¥ecif›r
);

102 
tÙ_auxf_im´
 = 0.0, 
tÙ_couÁ
 = 0.0;

104 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

105 ià(!
¥k2u‰_r¥ecif›r
.
	`em±y
()) {

106 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

107 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

109 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

110 
FmÎrRawAccs
 
	`accs
(
¿w_ã©_dim
, 
am_gmm
.
	`Dim
(), 
fuÎ_lda_m©
);

111 
¡d
::
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

112 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

113 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

114 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

115 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

116 
KALDI_WARN
 << "F—tu» nÙ found fÜ u‰”ªû " << 
u‰
;

117 
num_”r
++;

120 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

121 
KALDI_WARN
 << "Po¡”iÜ nÙ found fÜ u‰”ªû " << 
u‰
;

122 
num_”r
++;

125 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

126 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

127 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

128 
KALDI_WARN
 << "Sizmism©ch b‘w“Àpo¡”iÜ " << 
po¡
.
	`size
()

129 << "‡nd f—tu» " << 
ã©s
.
	`NumRows
();

130 
num_”r
++;

134 
	`AccStsFÜU‰”ªû
(
Œªs_mod–
, 
am_gmm
, 
po¡
, 
ã©s
, &
accs
);

135 
num_dÚe
++;

138 
Ba£Flßt
 
auxf_im´
, 
couÁ
;

140 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
¿w_ã©_dim
,„aw_feat_dim + 1);

141 
ŒªsfÜm
.
	`S‘Un™
();

142 
accs
.
	`Upd©e
(
İts
, &
ŒªsfÜm
, &
auxf_im´
, &
couÁ
);

143 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

145 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from„aw fMLLR is "

146 << (
auxf_im´
/
couÁ
) << " over " << count << " frames.";

147 
tÙ_auxf_im´
 +ğ
auxf_im´
;

148 
tÙ_couÁ
 +ğ
couÁ
;

151 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

152 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

153 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

154 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

155 
KALDI_WARN
 << "Po¡”iÜ nÙ found fÜ u‰”ªû " << 
u‰
;

156 
num_”r
++;

159 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

160 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

162 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

163 
KALDI_WARN
 << "Sizmism©ch b‘w“Àpo¡”iÜ " << 
po¡
.
	`size
()

164 << "‡nd f—tu» " << 
ã©s
.
	`NumRows
();

165 
num_”r
++;

169 
FmÎrRawAccs
 
	`accs
(
¿w_ã©_dim
, 
am_gmm
.
	`Dim
(), 
fuÎ_lda_m©
);

171 
	`AccStsFÜU‰”ªû
(
Œªs_mod–
, 
am_gmm
, 
po¡
, 
ã©s
, &
accs
);

173 
Ba£Flßt
 
auxf_im´
, 
couÁ
;

175 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
¿w_ã©_dim
,„aw_feat_dim + 1);

176 
ŒªsfÜm
.
	`S‘Un™
();

177 
accs
.
	`Upd©e
(
İts
, &
ŒªsfÜm
, &
auxf_im´
, &
couÁ
);

178 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

180 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from„aw fMLLR is "

181 << (
auxf_im´
/
couÁ
) << " over " << count << " frames.";

182 
tÙ_auxf_im´
 +ğ
auxf_im´
;

183 
tÙ_couÁ
 +ğ
couÁ
;

184 
num_dÚe
++;

188 
KALDI_LOG
 << "Proûs£d " << 
num_dÚe
 << " utterances, "

189 << 
num_”r
 << " hadƒrrors.";

190 
KALDI_LOG
 << "Overall„aw-fMLLR‡uxf impr…er frame is "

191 << (
tÙ_auxf_im´
 / 
tÙ_couÁ
) << " over " <<ot_count

193  (
num_dÚe
 != 0 ? 0 : 1);

194 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

195 
¡d
::
û¼
 << 
e
.
	`wh©
();

198 
	}
}

	@gmm-est-fmllr.cc

22 
	~<¡ršg
>

23 
usšg
 
	g¡d
::
¡ršg
;

24 
	~<veùÜ
>

25 
usšg
 
	g¡d
::
veùÜ
;

27 
	~"ba£/k®di-commÚ.h
"

28 
	~"ut/commÚ-uts.h
"

29 
	~"gmm/am-dŸg-gmm.h
"

30 
	~"hmm/Œªs™iÚ-mod–.h
"

31 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

32 
	~"hmm/po¡”iÜ.h
"

34 
Çme¥aû
 
	gk®di
 {

35 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

36 cÚ¡ 
Po¡”iÜ
 &
po¡
,

37 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

38 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

39 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

40 
Po¡”iÜ
 
	gpdf_po¡
;

41 
CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡
, &
pdf_po¡
);

42 
size_t
 
	gi
 = 0; i < 
	gpo¡
.
size
(); i++) {

43 
size_t
 
	gj
 = 0; j < 
	gpdf_po¡
[
i
].
size
(); j++) {

44 
št32
 
	gpdf_id
 = 
pdf_po¡
[
i
][
j
].
fœ¡
;

45 
	g¥k_¡©s
->
AccumuÏ‹FÜGmm
(
am_gmm
.
G‘Pdf
(
pdf_id
),

46 
ã©s
.
Row
(
i
),

47 
pdf_po¡
[
i
][
j
].
£cÚd
);

55 
	$maš
(
¬gc
, *
¬gv
[]) {

56 
Œy
 {

57 
k®di
::
	tšt32
 int32;

58 
usšg
 
Çme¥aû
 
k®di
;

59 cÚ¡ *
u§ge
 =

66 
P¬£O±iÚs
 
	`po
(
u§ge
);

67 
FmÎrO±iÚs
 
fmÎr_İts
;

68 
¡ršg
 
¥k2u‰_r¥ecif›r
;

69 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

71 
fmÎr_İts
.
	`Regi¡”
(&
po
);

73 
po
.
	`R—d
(
¬gc
, 
¬gv
);

75 ià(
po
.
	`NumArgs
() != 4) {

76 
po
.
	`PrštU§ge
();

77 
	`ex™
(1);

80 
¡ršg


81 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

82 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

83 
po¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

84 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

86 
T¿ns™iÚMod–
 
Œªs_mod–
;

87 
AmDŸgGmm
 
am_gmm
;

89 
boŞ
 
bš¬y
;

90 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

91 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

92 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

95 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡_r¥ecif›r
);

97 
tÙ_im´
 = 0.0, 
tÙ_t
 = 0.0;

99 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

101 
št32
 
num_dÚe
 = 0, 
num_no_po¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

102 ià(
¥k2u‰_r¥ecif›r
 != "") {

103 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

104 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

106 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

107 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
(), 
fmÎr_İts
);

108 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

109 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

110 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

111 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

112 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

113 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

114 
num_Ùh”_”rÜ
++;

117 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

118 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

119 
num_no_po¡
++;

122 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

123 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

124 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

125 
KALDI_WARN
 << "Po¡”iÜ veùÜ ha wrÚg siz" << (
po¡
.
	`size
())

126 << " vs. " << (
ã©s
.
	`NumRows
());

127 
num_Ùh”_”rÜ
++;

131 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
Œªs_mod–
, 
am_gmm
, &
¥k_¡©s
);

133 
num_dÚe
++;

136 
Ba£Flßt
 
im´
, 
¥k_tÙ_t
;

138 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim()+1);

139 
ŒªsfÜm
.
	`S‘Un™
();

140 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
¥k_tÙ_t
);

141 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

143 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from fMLLR is "

144 << (
im´
/
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames.";

145 
tÙ_im´
 +ğ
im´
;

146 
tÙ_t
 +ğ
¥k_tÙ_t
;

149 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

150 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

151 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

152 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

153 
KALDI_WARN
 << "Did‚ot find…osts for utterance "

154 << 
u‰
;

155 
num_no_po¡
++;

158 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

159 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

161 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

162 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡
.
	`size
())

163 << " vs. " << (
ã©s
.
	`NumRows
());

164 
num_Ùh”_”rÜ
++;

167 
num_dÚe
++;

169 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
am_gmm
.
	`Dim
(), 
fmÎr_İts
);

171 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
Œªs_mod–
, 
am_gmm
,

172 &
¥k_¡©s
);

174 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
;

176 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
am_gmm
.
	`Dim
(),‡m_gmm.Dim()+1);

177 
ŒªsfÜm
.
	`S‘Un™
();

178 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
u‰_tÙ_t
);

179 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

181 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from fMLLR is "

182 << (
im´
/
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames.";

183 
tÙ_im´
 +ğ
im´
;

184 
tÙ_t
 +ğ
u‰_tÙ_t
;

188 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡


189 << " w™h‚Øpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

190 
KALDI_LOG
 << "Overall fMLLR‡uxf impr…er frame is "

191 << (
tÙ_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

192  (
num_dÚe
 != 0 ? 0 : 1);

193 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

194 
¡d
::
û¼
 << 
e
.
	`wh©
();

197 
	}
}

	@gmm-est-gaussians-ebw.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/ebw-dŸg-gmm.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

38 
boŞ
 
bš¬y_wr™e
 = 
çl£
;

39 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mv";

41 
EbwO±iÚs
 
ebw_İts
;

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

43 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

44 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameterso "

47 
ebw_İts
.
	`Regi¡”
(&
po
);

49 
po
.
	`R—d
(
¬gc
, 
¬gv
);

51 ià(
po
.
	`NumArgs
() != 4) {

52 
po
.
	`PrštU§ge
();

53 
	`ex™
(1);

56 
k®di
::
GmmFÏgsTy³
 
upd©e_æags
 =

57 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
);

59 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

60 
num_¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

61 
d’_¡©s_f’ame
 = 
po
.
	`G‘Arg
(3),

62 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(4);

64 
AmDŸgGmm
 
am_gmm
;

65 
T¿ns™iÚMod–
 
Œªs_mod–
;

67 
boŞ
 
bš¬y_»ad
;

68 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

69 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

70 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

73 
VeùÜ
<> 
num_Œªs™iÚ_accs
;

74 
VeùÜ
<> 
d’_Œªs™iÚ_accs
;

76 
AccumAmDŸgGmm
 
num_¡©s
;

77 
AccumAmDŸgGmm
 
d’_¡©s
;

79 
boŞ
 
bš¬y
;

80 
IÅut
 
	`ki
(
num_¡©s_f’ame
, &
bš¬y
);

81 
num_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

82 
num_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

86 
boŞ
 
bš¬y
;

87 
IÅut
 
	`ki
(
d’_¡©s_f’ame
, &
bš¬y
);

88 
num_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

89 
d’_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

94 
Ba£Flßt
 
auxf_im´
, 
couÁ
;

95 
št32
 
num_æoÜed
;

96 
	`Upd©eEbwAmDŸgGmm
(
num_¡©s
, 
d’_¡©s
, 
upd©e_æags
, 
ebw_İts
, &
am_gmm
,

97 &
auxf_im´
, &
couÁ
, &
num_æoÜed
);

98 
KALDI_LOG
 << "Num couÁ " << 
num_¡©s
.
	`TÙStsCouÁ
() << ", den count "

99 << 
d’_¡©s
.
	`TÙStsCouÁ
();

100 
KALDI_LOG
 << "Ov”®Èauxàim´/äamäom GaussŸÀupd©i " << (
auxf_im´
/
couÁ
)

101 << " ov” " << 
couÁ
 << " frames; floored D for "

102 << 
num_æoÜed
 << " Gaussians.";

106 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y_wr™e
);

107 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

108 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

111 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

113 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

114 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

117 
	}
}

	@gmm-est-lvtln-trans.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/lvn.h
"

31 
	~"hmm/po¡”iÜ.h
"

33 
Çme¥aû
 
	gk®di
 {

34 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

35 cÚ¡ 
GaussPo¡
 &
gpo¡
,

36 cÚ¡ 
AmDŸgGmm
 &
am_gmm
,

37 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

38 
size_t
 
	gi
 = 0; i < 
	ggpo¡
.
size
(); i++) {

39 
size_t
 
	gj
 = 0; j < 
	ggpo¡
[
i
].
size
(); j++) {

40 
št32
 
	gpdf_id
 = 
gpo¡
[
i
][
j
].
fœ¡
;

41 cÚ¡ 
	gVeùÜ
<
	gBa£Flßt
> &
po¡”iÜ
(
gpo¡
[
i
][
j
].
£cÚd
);

42 
	g¥k_¡©s
->
AccumuÏ‹FromPo¡”iÜs
(
am_gmm
.
G‘Pdf
(
pdf_id
),

43 
ã©s
.
Row
(
i
), 
po¡”iÜ
);

51 
	$maš
(
¬gc
, *
¬gv
[]) {

52 
Œy
 {

53 
k®di
::
	tšt32
 int32;

54 
usšg
 
Çme¥aû
 
k®di
;

55 cÚ¡ *
u§ge
 =

61 
P¬£O±iÚs
 
	`po
(
u§ge
);

62 
¡ršg
 
¥k2u‰_r¥ecif›r
;

63 
Ba£Flßt
 
logd‘_sÿË
 = 1.0;

64 
¡d
::
¡ršg
 
nÜm_ty³
 = "offset";

65 
po
.
	`Regi¡”
("nÜm-ty³", &
nÜm_ty³
, "type of fMLLR‡pplied (\"offset\"|\"none\"|\"diag\")");

66 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

68 
po
.
	`Regi¡”
("logd‘-sÿË", &
logd‘_sÿË
, "Scale on†og-determinanterm in‡uxiliary function");

70 
po
.
	`R—d
(
¬gc
, 
¬gv
);

72 ià(
po
.
	`NumArgs
() < 5 ||…o.NumArgs() > 6) {

73 
po
.
	`PrštU§ge
();

74 
	`ex™
(1);

77 
¡ršg


78 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

79 
lvn_rxf’ame
 = 
po
.
	`G‘Arg
(2),

80 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

81 
gpo¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

82 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(5),

83 
w¬p_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

85 
AmDŸgGmm
 
am_gmm
;

87 
boŞ
 
bš¬y
;

88 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

89 
T¿ns™iÚMod–
 
Œªs_mod–
;

90 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

91 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

93 
Lš—rVn
 
lvn
;

94 
	`R—dK®diObjeù
(
lvn_rxf’ame
, &
lvn
);

97 
RªdomAcûssGaussPo¡R—d”
 
	`gpo¡_»ad”
(
gpo¡_r¥ecif›r
);

99 
tÙ_lvn_im´
 = 0.0, 
tÙ_t
 = 0.0;

101 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

103 
Ba£FlßtWr™”
 
	`w¬p_wr™”
(
w¬p_w¥ecif›r
);

105 
¡d
::
veùÜ
<
št32
> 
	`şass_couÁs
(
lvn
.
	`NumCÏs£s
(), 0);

106 
št32
 
num_dÚe
 = 0, 
num_no_gpo¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

107 ià(
¥k2u‰_r¥ecif›r
 != "") {

108 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

109 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

111 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

112 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
lvn
.
	`Dim
());

113 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

114 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

115 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

116 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

117 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

118 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

121 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

122 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

123 
num_no_gpo¡
++;

126 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

127 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

128 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

129 
KALDI_WARN
 << "GauPo¡ veùÜ ha wrÚg siz" << 
gpo¡
.
	`size
()

130 << " vs. " << 
ã©s
.
	`NumRows
();

131 
num_Ùh”_”rÜ
++;

135 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
am_gmm
, &
¥k_¡©s
);

137 
num_dÚe
++;

140 
Ba£Flßt
 
im´
, 
¥k_tÙ_t
;

142 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
lvn
.
	`Dim
(),†vtln.Dim()+1);

143 
št32
 
şass_idx
;

144 
lvn
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
,

145 
nÜm_ty³
,

146 
logd‘_sÿË
,

147 &
ŒªsfÜm
,

148 &
şass_idx
,

149 
NULL
,

150 &
im´
,

151 &
¥k_tÙ_t
);

152 
şass_couÁs
[
şass_idx
]++;

153 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

154 ià(
w¬p_w¥ecif›r
 != "")

155 
w¬p_wr™”
.
	`Wr™e
(
¥k
, 
lvn
.
	`G‘W¬p
(
şass_idx
));

157 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from LVTLN is "

158 << (
im´
/
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames.";

159 
tÙ_lvn_im´
 +ğ
im´
;

160 
tÙ_t
 +ğ
¥k_tÙ_t
;

163 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

164 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

165 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

166 ià(!
gpo¡_»ad”
.
	`HasKey
(
u‰
)) {

167 
KALDI_WARN
 << "Did‚ot find gposts for utterance "

168 << 
u‰
;

169 
num_no_gpo¡
++;

172 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

173 cÚ¡ 
GaussPo¡
 &
gpo¡
 = 
gpo¡_»ad”
.
	`V®ue
(
u‰
);

175 ià(
¡©ic_ÿ¡
<
št32
>(
gpo¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

176 
KALDI_WARN
 << "GauPo¡ ha wrÚg siz" << 
gpo¡
.
	`size
()

177 << " vs. " << 
ã©s
.
	`NumRows
();

178 
num_Ùh”_”rÜ
++;

181 
num_dÚe
++;

183 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
lvn
.
	`Dim
());

185 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
gpo¡
, 
am_gmm
,

186 &
¥k_¡©s
);

187 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
 = 
¥k_¡©s
.
b‘a_
;

189 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
lvn
.
	`Dim
(),†vtln.Dim()+1);

190 
št32
 
şass_idx
;

191 
lvn
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
,

192 
nÜm_ty³
,

193 
logd‘_sÿË
,

194 &
ŒªsfÜm
,

195 &
şass_idx
,

196 
NULL
,

197 &
im´
,

198 &
u‰_tÙ_t
);

199 
şass_couÁs
[
şass_idx
]++;

200 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

201 ià(
w¬p_w¥ecif›r
 != "")

202 
w¬p_wr™”
.
	`Wr™e
(
u‰
, 
lvn
.
	`G‘W¬p
(
şass_idx
));

205 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from LVTLN is "

206 << (
im´
/
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames.";

207 
tÙ_lvn_im´
 +ğ
im´
;

208 
tÙ_t
 +ğ
u‰_tÙ_t
;

213 
¡d
::
o¡ršg¡»am
 
s
;

214 
size_t
 
i
 = 0; i < 
şass_couÁs
.
	`size
(); i++)

215 
s
 << ' ' << 
şass_couÁs
[
i
];

216 
KALDI_LOG
 << "Di¡ributiÚ oàşas£ is: " << 
s
.
	`¡r
();

219 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_gpo¡


220 << " w™h‚Øgpo¡s, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

221 
KALDI_LOG
 << "Overall LVTLN‡uxf impr…er frame is "

222 << (
tÙ_lvn_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

223  (
num_dÚe
 == 0 ? 1 : 0);

224 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

225 
¡d
::
û¼
 << 
e
.
	`wh©
();

228 
	}
}

	@gmm-est-map.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"Œ“/cÚ‹xt-d•.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"gmm/mË-am-dŸg-gmm.h
"

28 
	$maš
(
¬gc
, *
¬gv
[]) {

29 
Œy
 {

30 
usšg
 
Çme¥aû
 
k®di
;

31 
k®di
::
	tšt32
 int32;

33 cÚ¡ *
u§ge
 =

38 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

39 
M­T¿ns™iÚUpd©eCÚfig
 
tcfg
;

40 
M­DŸgGmmO±iÚs
 
gmm_İts
;

41 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvwt";

42 
¡d
::
¡ršg
 
occs_out_f’ame
;

44 
P¬£O±iÚs
 
	`po
(
u§ge
);

45 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

46 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameterso "

48 
po
.
	`Regi¡”
("wr™e-occs", &
occs_out_f’ame
, "Fileo write state "

50 
tcfg
.
	`Regi¡”
(&
po
);

51 
gmm_İts
.
	`Regi¡”
(&
po
);

53 
po
.
	`R—d
(
¬gc
, 
¬gv
);

55 ià(
po
.
	`NumArgs
() != 3) {

56 
po
.
	`PrštU§ge
();

57 
	`ex™
(1);

60 
k®di
::
GmmFÏgsTy³
 
upd©e_æags
 =

61 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
);

63 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

64 
¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

65 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(3);

67 
AmDŸgGmm
 
am_gmm
;

68 
T¿ns™iÚMod–
 
Œªs_mod–
;

70 
boŞ
 
bš¬y_»ad
;

71 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

72 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

73 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

76 
VeùÜ
<> 
Œªs™iÚ_accs
;

77 
AccumAmDŸgGmm
 
gmm_accs
;

79 
boŞ
 
bš¬y
;

80 
IÅut
 
	`ki
(
¡©s_f’ame
, &
bš¬y
);

81 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

82 
gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

85 ià(
upd©e_æags
 & 
kGmmT¿ns™iÚs
) {

86 
Ba£Flßt
 
objf_im´
, 
couÁ
;

87 
Œªs_mod–
.
	`M­Upd©e
(
Œªs™iÚ_accs
, 
tcfg
, &
objf_im´
, &
couÁ
);

88 
KALDI_LOG
 << "T¿ns™iÚ mod– upd©e: Ov”®È" << (
objf_im´
/
couÁ
)

89 << "†og-likim´ovem’ˆ³¸äamov” " << (
couÁ
)

94 
Ba£Flßt
 
objf_im´
, 
couÁ
;

95 
Ba£Flßt
 
tÙ_like
 = 
gmm_accs
.
	`TÙLogLike
(),

96 
tÙ_t
 = 
gmm_accs
.
	`TÙCouÁ
();

97 
	`M­AmDŸgGmmUpd©e
(
gmm_İts
, 
gmm_accs
, 
upd©e_æags
, &
am_gmm
,

98 &
objf_im´
, &
couÁ
);

99 
KALDI_LOG
 << "GMM upd©e: Ov”®È" << (
objf_im´
/
couÁ
)

101 << 
couÁ
 << " frames";

102 
KALDI_LOG
 << "GMM update: Overall‡vg†ike…er frame = "

103 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

106 ià(!
occs_out_f’ame
.
	`em±y
()) {

107 
VeùÜ
<
Ba£Flßt
> 
¡©e_occs
;

108 
¡©e_occs
.
	`Resize
(
gmm_accs
.
	`NumAccs
());

109 
i
 = 0; i < 
gmm_accs
.
	`NumAccs
(); i++)

110 
	`¡©e_occs
(
i
èğ
gmm_accs
.
	`G‘Acc
(i).
	`occu·ncy
().
	`Sum
();

111 
boŞ
 
bš¬y
 = 
çl£
;

112 
	`Wr™eK®diObjeù
(
¡©e_occs
, 
occs_out_f’ame
, 
bš¬y
);

116 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y_wr™e
);

117 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

118 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

120 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

122 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

123 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

126 
	}
}

	@gmm-est-regtree-fmllr-ali.cc

20 
	~<¡ršg
>

21 
usšg
 
	g¡d
::
¡ršg
;

22 
	~<veùÜ
>

23 
usšg
 
	g¡d
::
veùÜ
;

25 
	~"ba£/k®di-commÚ.h
"

26 
	~"ut/commÚ-uts.h
"

27 
	~"gmm/am-dŸg-gmm.h
"

28 
	~"hmm/Œªs™iÚ-mod–.h
"

29 
	~"ŒªsfÜm/»gŒ“-fmÎr-dŸg-gmm.h
"

31 
	$maš
(
¬gc
, *
¬gv
[]) {

32 
Œy
 {

33 
k®di
::
	tšt32
 int32;

34 
usšg
 
Çme¥aû
 
k®di
;

35 cÚ¡ *
u§ge
 =

41 
P¬£O±iÚs
 
	`po
(
u§ge
);

42 
¡ršg
 
¥k2u‰_r¥ecif›r
;

43 
boŞ
 
bš¬y
 = 
Œue
;

44 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

46 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

48 
RegŒ“FmÎrO±iÚs
 
İts
;

49 
İts
.
	`Regi¡”
(&
po
);

51 
po
.
	`R—d
(
¬gc
, 
¬gv
);

53 ià(
po
.
	`NumArgs
() != 5) {

54 
po
.
	`PrštU§ge
();

55 
	`ex™
(1);

58 
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

59 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

60 
®ignm’ts_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

61 
»gŒ“_f’ame
 = 
po
.
	`G‘Arg
(4),

62 
xfÜms_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

64 
RªdomAcûssIÁ32VeùÜR—d”
 
	`®ignm’ts_»ad”
(
®ignm’ts_r¥ecif›r
);

65 
RegŒ“FmÎrDŸgGmmWr™”
 
	`fmÎr_wr™”
(
xfÜms_w¥ecif›r
);

67 
AmDŸgGmm
 
am_gmm
;

68 
T¿ns™iÚMod–
 
Œªs_mod–
;

70 
boŞ
 
bš¬y
;

71 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

72 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

73 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

75 
Reg»ssiÚT»e
 
»gŒ“
;

77 
boŞ
 
bš¬y
;

78 
IÅut
 
	`š
(
»gŒ“_f’ame
, &
bš¬y
);

79 
»gŒ“
.
	`R—d
(
š
.
	`SŒ—m
(), 
bš¬y
, 
am_gmm
);

82 
RegŒ“FmÎrDŸgGmm
 
fmÎr_xfÜms
;

83 
RegŒ“FmÎrDŸgGmmAccs
 
fmÎr_accs
;

84 
fmÎr_accs
.
	`In™
(
»gŒ“
.
	`NumBa£şas£s
(), 
am_gmm
.
	`Dim
());

86 
tÙ_like
 = 0.0;

87 
k®di
::
št64
 
tÙ_t
 = 0;

89 
št32
 
num_dÚe
 = 0, 
num_no_®ignm’t
 = 0, 
num_Ùh”_”rÜ
 = 0;

90 
tÙ_objf_im´
 = 0.0, 
tÙ_t_objf
 = 0.0;

91 ià(
¥k2u‰_r¥ecif›r
 != "") {

92 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

93 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

94 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

95 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

96 
fmÎr_accs
.
	`S‘Z”o
();

97 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

98 
veùÜ
<
¡ršg
>::
cÚ¡_™”©Ü
 
u‰_™r
 = 
u‰li¡
.
	`begš
(),

99 
™r_’d
 = 
u‰li¡
.
	`’d
(); 
u‰_™r
 != itr_end; ++utt_itr) {

100 ià(!
ã©u»_»ad”
.
	`HasKey
(*
u‰_™r
)) {

101 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << *
u‰_™r
;

104 ià(!
®ignm’ts_»ad”
.
	`HasKey
(*
u‰_™r
)) {

105 
KALDI_WARN
 << "Did‚ot find‡lignedranscription for utterance "

106 << *
u‰_™r
;

107 
num_no_®ignm’t
++;

110 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(*
u‰_™r
);

111 cÚ¡ 
veùÜ
<
št32
> &
®ignm’t
 = 
®ignm’ts_»ad”
.
	`V®ue
(*
u‰_™r
);

112 ià(
¡©ic_ÿ¡
<
št32
>(
®ignm’t
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

113 
KALDI_WARN
 << "Alignm’t ha wrÚg siz" << (
®ignm’t
.
	`size
())

114 << " vs. " << (
ã©s
.
	`NumRows
());

115 
num_Ùh”_”rÜ
++;

119 
Ba£Flßt
 
fe_like
 = 0.0;

120 
size_t
 
i
 = 0; i < 
®ignm’t
.
	`size
(); i++) {

121 
št32
 
pdf_id
 = 
Œªs_mod–
.
	`T¿ns™iÚIdToPdf
(
®ignm’t
[
i
]);

122 
fe_like
 +ğ
fmÎr_accs
.
	`AccumuÏ‹FÜGmm
(
»gŒ“
, 
am_gmm
,

123 
ã©s
.
	`Row
(
i
), 
pdf_id
, 1.0);

125 
	`KALDI_VLOG
(2è<< "Av”aglikfÜhi fi " << (
fe_like


126 / 
®ignm’t
.
	`size
()) << " over " <<‡lignment.size()

128 
tÙ_like
 +ğ
fe_like
;

129 
tÙ_t
 +ğ
®ignm’t
.
	`size
();

130 
num_dÚe
++;

131 ià(
num_dÚe
 % 10 =ğ0è
	`KALDI_VLOG
(1)

132 << "Avg†ik³¸äamsØç¸i " << (
tÙ_like
 / 
tÙ_t
) << '\n';

134 
Ba£Flßt
 
objf_im´
, 
t
;

135 
fmÎr_accs
.
	`Upd©e
(
»gŒ“
, 
İts
, &
fmÎr_xfÜms
, &
objf_im´
, &
t
);

136 
KALDI_LOG
 << "fMLLR objàim´ovem’ˆfÜ s³ak” " << 
¥k
 << " is "

137 << (
objf_im´
/(
t
+1.0e-10)) << "…er frame over " <<

139 
tÙ_objf_im´
 +ğ
objf_im´
;

140 
tÙ_t_objf
 +ğ
t
;

141 
fmÎr_wr™”
.
	`Wr™e
(
¥k
, 
fmÎr_xfÜms
);

144 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

145 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

146 
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

147 ià(!
®ignm’ts_»ad”
.
	`HasKey
(
key
)) {

148 
KALDI_WARN
 << "Did‚ot find‡lignedranscription for utterance "

149 << 
key
;

150 
num_no_®ignm’t
++;

153 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

154 cÚ¡ 
veùÜ
<
št32
> &
®ignm’t
 = 
®ignm’ts_»ad”
.
	`V®ue
(
key
);

156 ià(
¡©ic_ÿ¡
<
št32
>(
®ignm’t
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

157 
KALDI_WARN
 << "Alignm’t ha wrÚg siz" << (
®ignm’t
.
	`size
())

158 << " vs. " << (
ã©s
.
	`NumRows
());

159 
num_Ùh”_”rÜ
++;

163 
num_dÚe
++;

164 
Ba£Flßt
 
fe_like
 = 0.0;

165 
fmÎr_accs
.
	`S‘Z”o
();

166 
size_t
 
i
 = 0; i < 
®ignm’t
.
	`size
(); i++) {

167 
št32
 
pdf_id
 = 
Œªs_mod–
.
	`T¿ns™iÚIdToPdf
(
®ignm’t
[
i
]);

168 
fe_like
 +ğ
fmÎr_accs
.
	`AccumuÏ‹FÜGmm
(
»gŒ“
, 
am_gmm
,

169 
ã©s
.
	`Row
(
i
), 
pdf_id
, 1.0);

171 
	`KALDI_VLOG
(2è<< "Av”aglikfÜhi fi " << (
fe_like


172 / 
®ignm’t
.
	`size
()) << " over " <<‡lignment.size() << " frames.";

173 
tÙ_like
 +ğ
fe_like
;

174 
tÙ_t
 +ğ
®ignm’t
.
	`size
();

175 ià(
num_dÚe
 % 10 =ğ0è
	`KALDI_VLOG
(1)

176 << "Avg†ik³¸äamsØç¸i " << (
tÙ_like
 / 
tÙ_t
);

177 
Ba£Flßt
 
objf_im´
, 
t
;

178 
fmÎr_accs
.
	`Upd©e
(
»gŒ“
, 
İts
, &
fmÎr_xfÜms
, &
objf_im´
, &
t
);

179 
KALDI_LOG
 << "fMLLR objàim´ovem’ˆfÜ u‰”ªû " << 
key
 << " is "

180 << (
objf_im´
/(
t
+1.0e-10)) << "…er frame over " <<

182 
tÙ_objf_im´
 +ğ
objf_im´
;

183 
tÙ_t_objf
 +ğ
t
;

184 
fmÎr_wr™”
.
	`Wr™e
(
ã©u»_»ad”
.
	`Key
(), 
fmÎr_xfÜms
);

188 
KALDI_LOG
 << "Overall objf improvement from fMLLR is "

189 << (
tÙ_objf_im´
/
tÙ_t_objf
)

190 << "…” f¿mov” " << 
tÙ_t_objf
 << " frames.";

191 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_®ignm’t


192 << " w™h‚Ø®ignm’ts, " << 
num_Ùh”_”rÜ


194 
KALDI_LOG
 << "Ov”®Èacou¡iølik³¸äamğ" << (
tÙ_like
 / 
tÙ_t
)

195 << " ov” " << 
tÙ_t
 << " frames.";

197 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

198 
¡d
::
û¼
 << 
e
.
	`wh©
();

201 
	}
}

	@gmm-est-regtree-fmllr.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"hmm/po¡”iÜ.h
"

31 
	~"ŒªsfÜm/»gŒ“-fmÎr-dŸg-gmm.h
"

33 
	$maš
(
¬gc
, *
¬gv
[]) {

34 
Œy
 {

35 
k®di
::
	tšt32
 int32;

36 
usšg
 
Çme¥aû
 
k®di
;

37 cÚ¡ *
u§ge
 =

43 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
¡ršg
 
¥k2u‰_r¥ecif›r
;

45 
boŞ
 
bš¬y
 = 
Œue
;

46 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

48 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

50 
RegŒ“FmÎrO±iÚs
 
İts
;

51 
İts
.
	`Regi¡”
(&
po
);

53 
po
.
	`R—d
(
¬gc
, 
¬gv
);

55 ià(
po
.
	`NumArgs
() != 5) {

56 
po
.
	`PrštU§ge
();

57 
	`ex™
(1);

60 
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

61 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

62 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

63 
»gŒ“_f’ame
 = 
po
.
	`G‘Arg
(4),

64 
xfÜms_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

66 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

67 
RegŒ“FmÎrDŸgGmmWr™”
 
	`fmÎr_wr™”
(
xfÜms_w¥ecif›r
);

69 
AmDŸgGmm
 
am_gmm
;

70 
T¿ns™iÚMod–
 
Œªs_mod–
;

72 
boŞ
 
bš¬y
;

73 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

74 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

75 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

77 
Reg»ssiÚT»e
 
»gŒ“
;

79 
boŞ
 
bš¬y
;

80 
IÅut
 
	`š
(
»gŒ“_f’ame
, &
bš¬y
);

81 
»gŒ“
.
	`R—d
(
š
.
	`SŒ—m
(), 
bš¬y
, 
am_gmm
);

84 
RegŒ“FmÎrDŸgGmm
 
fmÎr_xfÜms
;

85 
RegŒ“FmÎrDŸgGmmAccs
 
fmÎr_accs
;

86 
fmÎr_accs
.
	`In™
(
»gŒ“
.
	`NumBa£şas£s
(), 
am_gmm
.
	`Dim
());

88 
tÙ_like
 = 0.0, 
tÙ_t
 = 0;

90 
št32
 
num_dÚe
 = 0, 
num_no_po¡”iÜ
 = 0, 
num_Ùh”_”rÜ
 = 0;

91 
tÙ_objf_im´
 = 0.0, 
tÙ_t_objf
 = 0.0;

92 ià(
¥k2u‰_r¥ecif›r
 != "") {

93 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

94 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

95 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

96 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

97 
fmÎr_accs
.
	`S‘Z”o
();

98 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

99 
veùÜ
<
¡ršg
>::
cÚ¡_™”©Ü
 
u‰_™r
 = 
u‰li¡
.
	`begš
(),

100 
™r_’d
 = 
u‰li¡
.
	`’d
(); 
u‰_™r
 != itr_end; ++utt_itr) {

101 ià(!
ã©u»_»ad”
.
	`HasKey
(*
u‰_™r
)) {

102 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << *
u‰_™r
;

105 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(*
u‰_™r
)) {

106 
KALDI_WARN
 << "Did‚ot find…osteriors for utterance "

107 << *
u‰_™r
;

108 
num_no_po¡”iÜ
++;

111 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(*
u‰_™r
);

112 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(*
u‰_™r
);

113 ià(
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

114 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡”iÜ
.
	`size
())

115 << " vs. " << (
ã©s
.
	`NumRows
());

116 
num_Ùh”_”rÜ
++;

120 
Ba£Flßt
 
fe_like
 = 0.0, 
fe_t
 = 0.0;

121 
Po¡”iÜ
 
pdf_po¡”iÜ
;

122 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

123 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

124 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

125 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

126 
Ba£Flßt
 
´ob
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

127 
fe_like
 +ğ
fmÎr_accs
.
	`AccumuÏ‹FÜGmm
(
»gŒ“
, 
am_gmm
,

128 
ã©s
.
	`Row
(
i
), 
pdf_id
,

129 
´ob
);

130 
fe_t
 +ğ
´ob
;

133 
	`KALDI_VLOG
(2è<< "Av”aglikfÜhi fi " << (
fe_like
/
fe_t
)

134 << " ov” " << 
fe_t
 << " frames.";

135 
tÙ_like
 +ğ
fe_like
;

136 
tÙ_t
 +ğ
fe_t
;

137 
num_dÚe
++;

138 ià(
num_dÚe
 % 10 == 0)

139 
	`KALDI_VLOG
(1) << "Avg†ike…er frame so far is "

140 << (
tÙ_like
 / 
tÙ_t
);

142 
Ba£Flßt
 
objf_im´
, 
t
;

143 
fmÎr_accs
.
	`Upd©e
(
»gŒ“
, 
İts
, &
fmÎr_xfÜms
, &
objf_im´
, &
t
);

144 
KALDI_LOG
 << "fMLLR objàim´ovem’ˆfÜ s³ak” " << 
¥k
 << " is "

145 << (
objf_im´
/(
t
+1.0e-10)) << "…er frame over " <<

147 
tÙ_objf_im´
 +ğ
objf_im´
;

148 
tÙ_t_objf
 +ğ
t
;

149 
fmÎr_wr™”
.
	`Wr™e
(
¥k
, 
fmÎr_xfÜms
);

152 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

153 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

154 
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

155 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

156 
KALDI_WARN
 << "Did‚ot find…osteriors for utterance "

157 << 
key
;

158 
num_no_po¡”iÜ
++;

161 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

162 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

164 ià(
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

165 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡”iÜ
.
	`size
())

166 << " vs. " << (
ã©s
.
	`NumRows
());

167 
num_Ùh”_”rÜ
++;

171 
num_dÚe
++;

172 
Ba£Flßt
 
fe_like
 = 0.0, 
fe_t
 = 0.0;

173 
fmÎr_accs
.
	`S‘Z”o
();

174 
Po¡”iÜ
 
pdf_po¡”iÜ
;

175 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

176 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

177 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

178 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

179 
Ba£Flßt
 
´ob
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

180 
fe_like
 +ğ
fmÎr_accs
.
	`AccumuÏ‹FÜGmm
(
»gŒ“
, 
am_gmm
,

181 
ã©s
.
	`Row
(
i
), 
pdf_id
,

182 
´ob
);

183 
fe_t
 +ğ
´ob
;

186 
	`KALDI_VLOG
(2è<< "Av”aglikfÜhi fi " << (
fe_like
/
fe_t
)

187 << " ov” " << 
fe_t
 << " frames.";

188 
tÙ_like
 +ğ
fe_like
;

189 
tÙ_t
 +ğ
fe_t
;

190 ià(
num_dÚe
 % 10 == 0)

191 
	`KALDI_VLOG
(1) << "Avg†ike…er frame so far is "

192 << (
tÙ_like
 / 
tÙ_t
);

193 
Ba£Flßt
 
objf_im´
, 
t
;

194 
fmÎr_accs
.
	`Upd©e
(
»gŒ“
, 
İts
, &
fmÎr_xfÜms
, &
objf_im´
, &
t
);

195 
KALDI_LOG
 << "fMLLR objàim´ovem’ˆfÜ u‰”ªû " << 
key
 << " is "

196 << (
objf_im´
/(
t
+1.0e-10)) << "…er frame over " <<

198 
tÙ_objf_im´
 +ğ
objf_im´
;

199 
tÙ_t_objf
 +ğ
t
;

200 
fmÎr_wr™”
.
	`Wr™e
(
ã©u»_»ad”
.
	`Key
(), 
fmÎr_xfÜms
);

203 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡”iÜ


204 << " w™h‚Øpo¡”iÜs, " << 
num_Ùh”_”rÜ


206 
KALDI_LOG
 << "Ov”®Èobjàim´ovem’ˆäom MLLR i " << (
tÙ_objf_im´
/
tÙ_t_objf
)

207 << "…” f¿m" << " ov” " << 
tÙ_t_objf
 << " frames.";

208 
KALDI_LOG
 << "Ov”®Èacou¡iølik–ihood wa " << (
tÙ_like
/
tÙ_t
)

209 << " ov” " << 
tÙ_t
 << " frames.";

211 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

212 
¡d
::
û¼
 << 
e
.
	`wh©
();

215 
	}
}

	@gmm-est-regtree-mllr.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/»gŒ“-mÎr-dŸg-gmm.h
"

31 
	~"hmm/po¡”iÜ.h
"

33 
	$maš
(
¬gc
, *
¬gv
[]) {

34 
Œy
 {

35 
k®di
::
	tšt32
 int32;

36 
usšg
 
Çme¥aû
 
k®di
;

37 cÚ¡ *
u§ge
 =

43 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
¡ršg
 
¥k2u‰_r¥ecif›r
;

45 
boŞ
 
bš¬y
 = 
Œue
;

46 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

48 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

50 
RegŒ“MÎrO±iÚs
 
İts
;

51 
İts
.
	`Regi¡”
(&
po
);

53 
po
.
	`R—d
(
¬gc
, 
¬gv
);

55 ià(
po
.
	`NumArgs
() != 5) {

56 
po
.
	`PrštU§ge
();

57 
	`ex™
(1);

60 
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

61 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

62 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

63 
»gŒ“_f’ame
 = 
po
.
	`G‘Arg
(4),

64 
xfÜms_w¥ecif›r
 = 
po
.
	`G‘Arg
(5);

66 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

67 
RegŒ“MÎrDŸgGmmWr™”
 
	`mÎr_wr™”
(
xfÜms_w¥ecif›r
);

69 
AmDŸgGmm
 
am_gmm
;

70 
T¿ns™iÚMod–
 
Œªs_mod–
;

72 
boŞ
 
bš¬y
;

73 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

74 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

75 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

77 
Reg»ssiÚT»e
 
»gŒ“
;

79 
boŞ
 
bš¬y
;

80 
IÅut
 
	`š
(
»gŒ“_f’ame
, &
bš¬y
);

81 
»gŒ“
.
	`R—d
(
š
.
	`SŒ—m
(), 
bš¬y
, 
am_gmm
);

84 
RegŒ“MÎrDŸgGmm
 
mÎr_xfÜms
;

85 
RegŒ“MÎrDŸgGmmAccs
 
mÎr_accs
;

86 
mÎr_accs
.
	`In™
(
»gŒ“
.
	`NumBa£şas£s
(), 
am_gmm
.
	`Dim
());

88 
tÙ_like
 = 0.0, 
tÙ_t
 = 0;

90 
št32
 
num_dÚe
 = 0, 
num_no_po¡”iÜ
 = 0, 
num_Ùh”_”rÜ
 = 0;

91 
tÙ_objf_im´
 = 0.0, 
tÙ_t_objf
 = 0.0;

92 ià(
¥k2u‰_r¥ecif›r
 != "") {

93 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

94 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

95 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

96 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

97 
mÎr_accs
.
	`S‘Z”o
();

98 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

99 
veùÜ
<
¡ršg
>::
cÚ¡_™”©Ü
 
u‰_™r
 = 
u‰li¡
.
	`begš
(),

100 
™r_’d
 = 
u‰li¡
.
	`’d
(); 
u‰_™r
 != itr_end; ++utt_itr) {

101 ià(!
ã©u»_»ad”
.
	`HasKey
(*
u‰_™r
)) {

102 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << *
u‰_™r
;

105 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(*
u‰_™r
)) {

106 
KALDI_WARN
 << "Did‚ot find…osteriors for utterance "

107 << *
u‰_™r
;

108 
num_no_po¡”iÜ
++;

111 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(*
u‰_™r
);

112 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(*
u‰_™r
);

113 ià(
po¡”iÜ
.
	`size
(è!ğ
ã©s
.
	`NumRows
()) {

114 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡”iÜ
.
	`size
())

115 << " vs. " << (
ã©s
.
	`NumRows
());

116 
num_Ùh”_”rÜ
++;

120 
Ba£Flßt
 
fe_like
 = 0.0, 
fe_t
 = 0.0;

121 
Po¡”iÜ
 
pdf_po¡”iÜ
;

122 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

123 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

124 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

125 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

126 
Ba£Flßt
 
´ob
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

127 
fe_like
 +ğ
mÎr_accs
.
	`AccumuÏ‹FÜGmm
(
»gŒ“
, 
am_gmm
,

128 
ã©s
.
	`Row
(
i
), 
pdf_id
,

129 
´ob
);

130 
fe_t
 +ğ
´ob
;

133 
	`KALDI_VLOG
(2è<< "Av”aglikfÜhi fi " << (
fe_like
/
fe_t
)

134 << " ov” " << 
fe_t
 << " frames.";

135 
tÙ_like
 +ğ
fe_like
;

136 
tÙ_t
 +ğ
fe_t
;

137 
num_dÚe
++;

138 ià(
num_dÚe
 % 10 == 0)

139 
	`KALDI_VLOG
(1) << "Avg†ike…er frame so far is "

140 << (
tÙ_like
 / 
tÙ_t
);

142 
Ba£Flßt
 
objf_im´
, 
t
;

143 
mÎr_accs
.
	`Upd©e
(
»gŒ“
, 
İts
, &
mÎr_xfÜms
, &
objf_im´
, &
t
);

144 
KALDI_LOG
 << "MLLR objàim´ovem’ˆfÜ s³ak” " << 
¥k
 << " is "

145 << (
objf_im´
/(
t
+1.0e-10)) << "…er frame over " <<

147 
tÙ_objf_im´
 +ğ
objf_im´
;

148 
tÙ_t_objf
 +ğ
t
;

149 
mÎr_wr™”
.
	`Wr™e
(
¥k
, 
mÎr_xfÜms
);

152 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

153 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

154 
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

155 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

156 
KALDI_WARN
 << "Did‚ot find‡lignedranscription for utterance "

157 << 
key
;

158 
num_no_po¡”iÜ
++;

161 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

162 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

164 ià(
po¡”iÜ
.
	`size
(è!ğ
ã©s
.
	`NumRows
()) {

165 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << (
po¡”iÜ
.
	`size
())

166 << " vs. " << (
ã©s
.
	`NumRows
());

167 
num_Ùh”_”rÜ
++;

171 
num_dÚe
++;

172 
Ba£Flßt
 
fe_like
 = 0.0, 
fe_t
 = 0.0;

173 
mÎr_accs
.
	`S‘Z”o
();

174 
Po¡”iÜ
 
pdf_po¡”iÜ
;

175 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

176 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

177 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

178 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

179 
Ba£Flßt
 
´ob
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

180 
fe_like
 +ğ
mÎr_accs
.
	`AccumuÏ‹FÜGmm
(
»gŒ“
, 
am_gmm
,

181 
ã©s
.
	`Row
(
i
), 
pdf_id
,

182 
´ob
);

183 
fe_t
 +ğ
´ob
;

186 
	`KALDI_VLOG
(2è<< "Av”aglikfÜhi fi " << (
fe_like
/
fe_t
)

187 << " ov” " << 
fe_t
 << " frames.";

188 
tÙ_like
 +ğ
fe_like
;

189 
tÙ_t
 +ğ
fe_t
;

190 ià(
num_dÚe
 % 10 == 0)

191 
	`KALDI_VLOG
(1è<< "Avg†ik³¸äamsØç¸i " << (
tÙ_like
 / 
tÙ_t
);

192 
Ba£Flßt
 
objf_im´
, 
t
;

193 
mÎr_accs
.
	`Upd©e
(
»gŒ“
, 
İts
, &
mÎr_xfÜms
, &
objf_im´
, &
t
);

194 
KALDI_LOG
 << "MLLR objàim´ovem’ˆfÜ u‰”ªû " << 
key
 << " is "

195 << (
objf_im´
/(
t
+1.0e-10)) << "…er frame over " <<

197 
tÙ_objf_im´
 +ğ
objf_im´
;

198 
tÙ_t_objf
 +ğ
t
;

199 
mÎr_wr™”
.
	`Wr™e
(
ã©u»_»ad”
.
	`Key
(), 
mÎr_xfÜms
);

202 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡”iÜ


203 << " w™h‚Øpo¡”iÜs, " << 
num_Ùh”_”rÜ


205 
KALDI_LOG
 << "Ov”®Èobjàim´ovem’ˆäom MLLR i " << (
tÙ_objf_im´
/
tÙ_t_objf
)

206 << "…” f¿m" << " ov” " << 
tÙ_t_objf
 << " frames.";

207 
KALDI_LOG
 << "Ov”®Èacou¡iølik–ihood wa " << (
tÙ_like
/
tÙ_t
)

208 << " ov” " << 
tÙ_t
 << " frames.";

210 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

211 
¡d
::
û¼
 << 
e
.
	`wh©
();

214 
	}
}

	@gmm-est-rescale.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/šdœeù-diff-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	$maš
(
¬gc
, *
¬gv
[]) {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

29 
Œy
 {

30 cÚ¡ *
u§ge
 =

39 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

40 
MËDŸgGmmO±iÚs
 
İts
;

42 
Ba£Flßt
 
mš_v¬Ÿnû
 = 
İts
.min_variance;

43 
Ba£Flßt
 
mš_gaussŸn_occu·ncy
 = 
İts
.min_gaussian_occupancy;

45 
P¬£O±iÚs
 
	`po
(
u§ge
);

46 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

47 
po
.
	`Regi¡”
("mš-v¬Ÿnû", &
mš_v¬Ÿnû
,

49 
po
.
	`Regi¡”
("mš-gaussŸn-occu·ncy", &
mš_gaussŸn_occu·ncy
,

52 
po
.
	`R—d
(
¬gc
, 
¬gv
);

54 ià(
po
.
	`NumArgs
() != 4) {

55 
po
.
	`PrštU§ge
();

56 
	`ex™
(1);

59 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

60 
Şd_¡©s_rxf’ame
 = 
po
.
	`G‘Arg
(2),

61 
Ãw_¡©s_rxf’ame
 = 
po
.
	`G‘Arg
(3),

62 
mod–_wxf’ame
 = 
po
.
	`G‘Arg
(4);

64 
AmDŸgGmm
 
am_gmm
;

65 
T¿ns™iÚMod–
 
Œªs_mod–
;

67 
boŞ
 
bš¬y_»ad
;

68 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y_»ad
);

69 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

70 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

73 
AccumAmDŸgGmm
 
Şd_gmm_accs
, 
Ãw_gmm_accs
;

75 
VeùÜ
<> 
Œªs™iÚ_accs
;

76 
boŞ
 
bš¬y
;

77 
IÅut
 
	`ki
(
Şd_¡©s_rxf’ame
, &
bš¬y
);

78 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

79 
Şd_gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

82 
VeùÜ
<> 
Œªs™iÚ_accs
;

83 
boŞ
 
bš¬y
;

84 
IÅut
 
	`ki
(
Ãw_¡©s_rxf’ame
, &
bš¬y
);

85 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

86 
Ãw_gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

89 
	`DoResÿlšgUpd©e
(
Şd_gmm_accs
, 
Ãw_gmm_accs
,

90 
mš_v¬Ÿnû
, 
mš_gaussŸn_occu·ncy
,

91 &
am_gmm
);

94 
Ouut
 
	`ko
(
mod–_wxf’ame
, 
bš¬y_wr™e
);

95 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

96 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

99 
KALDI_LOG
 << "ResÿËd mod–‡nd wrÙtØ" << 
mod–_wxf’ame
;

101 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

102 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

105 
	}
}

	@gmm-est-weights-ebw.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/ebw-dŸg-gmm.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

38 
boŞ
 
bš¬y_wr™e
 = 
çl£
;

39 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "w";

41 
EbwWeightO±iÚs
 
ebw_weight_İts
;

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

43 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

44 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameterso "

47 
ebw_weight_İts
.
	`Regi¡”
(&
po
);

49 
po
.
	`R—d
(
¬gc
, 
¬gv
);

51 ià(
po
.
	`NumArgs
() != 4) {

52 
po
.
	`PrštU§ge
();

53 
	`ex™
(1);

56 
k®di
::
GmmFÏgsTy³
 
upd©e_æags
 =

57 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
);

59 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

60 
num_¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

61 
d’_¡©s_f’ame
 = 
po
.
	`G‘Arg
(3),

62 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(4);

64 
AmDŸgGmm
 
am_gmm
;

65 
T¿ns™iÚMod–
 
Œªs_mod–
;

67 
boŞ
 
bš¬y_»ad
;

68 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

69 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

70 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

73 
VeùÜ
<> 
num_Œªs™iÚ_accs
;

74 
VeùÜ
<> 
d’_Œªs™iÚ_accs
;

76 
AccumAmDŸgGmm
 
num_¡©s
;

77 
AccumAmDŸgGmm
 
d’_¡©s
;

79 
boŞ
 
bš¬y
;

80 
IÅut
 
	`ki
(
num_¡©s_f’ame
, &
bš¬y
);

81 
num_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

82 
num_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

86 
boŞ
 
bš¬y
;

87 
IÅut
 
	`ki
(
d’_¡©s_f’ame
, &
bš¬y
);

88 
num_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

89 
d’_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

92 ià(
upd©e_æags
 & 
kGmmWeights
) {

93 
Ba£Flßt
 
auxf_im´
, 
couÁ
;

94 
	`Upd©eEbwWeightsAmDŸgGmm
(
num_¡©s
, 
d’_¡©s
, 
ebw_weight_İts
, &
am_gmm
,

95 &
auxf_im´
, &
couÁ
);

96 
KALDI_LOG
 << "Num couÁ " << 
num_¡©s
.
	`TÙCouÁ
() << ", den count "

97 << 
d’_¡©s
.
	`TÙCouÁ
();

98 
KALDI_LOG
 << "Ov”®Èauxàim´/äamäom weighˆupd©i " << (
auxf_im´
/
couÁ
)

99 << " ov” " << 
couÁ
 << " frames.";

101 
KALDI_LOG
 << "Doing‚othing because flags do‚ot specifyo updatehe weights.";

105 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y_wr™e
);

106 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

107 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

110 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

112 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

113 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

116 
	}
}

	@gmm-est.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/mË-am-dŸg-gmm.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

37 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

38 
MËT¿ns™iÚUpd©eCÚfig
 
tcfg
;

39 
MËDŸgGmmO±iÚs
 
gmm_İts
;

40 
št32
 
mixup
 = 0;

41 
št32
 
mixdown
 = 0;

42 
Ba£Flßt
 
³¹urb_çùÜ
 = 0.01;

43 
Ba£Flßt
 
pow”
 = 0.2;

44 
Ba£Flßt
 
mš_couÁ
 = 20.0;

45 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvwt";

46 
¡d
::
¡ršg
 
occs_out_f’ame
;

48 
P¬£O±iÚs
 
	`po
(
u§ge
);

49 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

50 
po
.
	`Regi¡”
("mix-up", &
mixup
, "Increase‚umber of mixture componentso "

52 
po
.
	`Regi¡”
("mš-couÁ", &
mš_couÁ
,

54 
po
.
	`Regi¡”
("mix-down", &
mixdown
, "If‚onzero, merge mixture componentsohis "

56 
po
.
	`Regi¡”
("pow”", &
pow”
, "If mixing up,…owero‡llocate Gaussianso"

58 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameterso "

60 
po
.
	`Regi¡”
("³¹urb-çùÜ", &
³¹urb_çùÜ
, "While mixing up,…erturb "

62 
po
.
	`Regi¡”
("wr™e-occs", &
occs_out_f’ame
, "Fileo write…df "

64 
tcfg
.
	`Regi¡”
(&
po
);

65 
gmm_İts
.
	`Regi¡”
(&
po
);

67 
po
.
	`R—d
(
¬gc
, 
¬gv
);

69 ià(
po
.
	`NumArgs
() != 3) {

70 
po
.
	`PrštU§ge
();

71 
	`ex™
(1);

74 
k®di
::
GmmFÏgsTy³
 
upd©e_æags
 =

75 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
);

77 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

78 
¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

79 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(3);

81 
AmDŸgGmm
 
am_gmm
;

82 
T¿ns™iÚMod–
 
Œªs_mod–
;

84 
boŞ
 
bš¬y_»ad
;

85 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

86 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

87 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

90 
VeùÜ
<> 
Œªs™iÚ_accs
;

91 
AccumAmDŸgGmm
 
gmm_accs
;

93 
boŞ
 
bš¬y
;

94 
IÅut
 
	`ki
(
¡©s_f’ame
, &
bš¬y
);

95 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

96 
gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

99 ià(
upd©e_æags
 & 
kGmmT¿ns™iÚs
) {

100 
Ba£Flßt
 
objf_im´
, 
couÁ
;

101 
Œªs_mod–
.
	`MËUpd©e
(
Œªs™iÚ_accs
, 
tcfg
, &
objf_im´
, &
couÁ
);

102 
KALDI_LOG
 << "T¿ns™iÚ mod– upd©e: Ov”®È" << (
objf_im´
/
couÁ
)

103 << "†og-likim´ovem’ˆ³¸äamov” " << (
couÁ
)

108 
Ba£Flßt
 
objf_im´
, 
couÁ
;

109 
Ba£Flßt
 
tÙ_like
 = 
gmm_accs
.
	`TÙLogLike
(),

110 
tÙ_t
 = 
gmm_accs
.
	`TÙCouÁ
();

111 
	`MËAmDŸgGmmUpd©e
(
gmm_İts
, 
gmm_accs
, 
upd©e_æags
, &
am_gmm
,

112 &
objf_im´
, &
couÁ
);

113 
KALDI_LOG
 << "GMM upd©e: Ov”®È" << (
objf_im´
/
couÁ
)

115 << 
couÁ
 << " frames";

116 
KALDI_LOG
 << "GMM update: Overall‡vg†ike…er frame = "

117 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

120 ià(
mixup
 !ğ0 || 
mixdown
 !ğ0 || !
occs_out_f’ame
.
	`em±y
()) {

122 
VeùÜ
<
Ba£Flßt
> 
pdf_occs
;

123 
pdf_occs
.
	`Resize
(
gmm_accs
.
	`NumAccs
());

124 
i
 = 0; i < 
gmm_accs
.
	`NumAccs
(); i++)

125 
	`pdf_occs
(
i
èğ
gmm_accs
.
	`G‘Acc
(i).
	`occu·ncy
().
	`Sum
();

127 ià(
mixdown
 != 0)

128 
am_gmm
.
	`M”geByCouÁ
(
pdf_occs
, 
mixdown
, 
pow”
, 
mš_couÁ
);

130 ià(
mixup
 != 0)

131 
am_gmm
.
	`S¶™ByCouÁ
(
pdf_occs
, 
mixup
, 
³¹urb_çùÜ
,

132 
pow”
, 
mš_couÁ
);

134 ià(!
occs_out_f’ame
.
	`em±y
()) {

135 
boŞ
 
bš¬y
 = 
çl£
;

136 
	`Wr™eK®diObjeù
(
pdf_occs
, 
occs_out_f’ame
, 
bš¬y
);

141 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y_wr™e
);

142 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

143 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

146 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

148 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

149 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

152 
	}
}

	@gmm-fmpe-acc-stats.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"ŒªsfÜm/fm³.h
"

28 
	$maš
(
¬gc
, *
¬gv
[]) {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
usšg
 
k®di
::
št32
;

31 
Œy
 {

32 cÚ¡ *
u§ge
 =

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

43 
boŞ
 
bš¬y
 = 
Œue
;

44 
¡d
::
¡ršg
 
mod–_d”iv©ive_rxf’ame
;

45 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Ifrue, write stats in binary mode.");

46 
po
.
	`Regi¡”
("mod–-d”iv©ive", &
mod–_d”iv©ive_rxf’ame
,

48 
po
.
	`R—d
(
¬gc
, 
¬gv
);

50 ià(
po
.
	`NumArgs
() != 6) {

51 
po
.
	`PrštU§ge
();

52 
	`ex™
(1);

55 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

56 
fm³_rxf’ame
 = 
po
.
	`G‘Arg
(2),

57 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

58 
g£Ëù_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

59 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

60 
¡©s_wxf’ame
 = 
po
.
	`G‘Arg
(6);

62 
AmDŸgGmm
 
am_gmm
;

63 
T¿ns™iÚMod–
 
Œªs_mod–
;

65 
boŞ
 
bš¬y
;

66 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y
);

67 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

68 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

71 
Fm³
 
fm³
;

72 
	`R—dK®diObjeù
(
fm³_rxf’ame
, &
fm³
);

75 
boŞ
 
have_šdœeù
 = (
mod–_d”iv©ive_rxf’ame
 != "");

76 
AccumAmDŸgGmm
 
mod–_d”iv©ive
;

77 ià(
have_šdœeù
)

78 
	`R—dK®diObjeù
(
mod–_d”iv©ive_rxf’ame
, &
mod–_d”iv©ive
);

80 
Fm³Sts
 
	`fm³_¡©s
(
fm³
);

82 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

83 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

84 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

86 
Ba£Flßt
 
tÙ_like
 = 0.0;

87 
št32
 
num_äames
 = 0;

88 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

90 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

91 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

92 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

93 
num_”r
++;

94 
KALDI_WARN
 << "NØpo¡”iÜ fÜ u‰”ªû " << 
key
;

97 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©_š
 = 
ã©u»_»ad”
.
	`V®ue
();

98 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

100 ià(
¡©ic_ÿ¡
<
št32
>(
po¡”iÜ
.
	`size
()è!ğ
ã©_š
.
	`NumRows
()) {

101 
KALDI_WARN
 << "Posterior vector has wrong size " <<

102 (
po¡”iÜ
.
	`size
()è<< " vs. "<< (
ã©_š
.
	`NumRows
());

103 
num_”r
++;

107 ià(!
g£Ëù_»ad”
.
	`HasKey
(
key
)) {

108 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ key " << 
key
;

109 
num_”r
++;

112 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
 =

113 
g£Ëù_»ad”
.
	`V®ue
(
key
);

114 ià(
¡©ic_ÿ¡
<
št32
>(
g£Ëù
.
	`size
()è!ğ
ã©_š
.
	`NumRows
()) {

115 
KALDI_WARN
 << "gselect information has wrong size";

116 
num_”r
++;

120 
num_dÚe
++;

121 
M©rix
<
Ba£Flßt
> 
	`fm³_ã©
(
ã©_š
.
	`NumRows
(), f—t_š.
	`NumCŞs
());

122 
fm³
.
	`Compu‹F—tu»s
(
ã©_š
, 
g£Ëù
, &
fm³_ã©
);

123 
fm³_ã©
.
	`AddM©
(1.0, 
ã©_š
);

125 
M©rix
<
Ba£Flßt
> 
dœeù_d”iv
, 
šdœeù_d”iv
;

127 
tÙ_like
 +ğ
	`Compu‹AmGmmF—tu»D”iv
(
am_gmm
, 
Œªs_mod–
, 
po¡”iÜ
,

128 
fm³_ã©
, &
dœeù_d”iv
,

129 (
have_šdœeù
 ? &
mod–_d”iv©ive
 : 
NULL
),

130 (
have_šdœeù
 ? &
šdœeù_d”iv
 : 
NULL
));

131 
num_äames
 +ğ
ã©_š
.
	`NumRows
();

133 
fm³
.
	`AccSts
(
ã©_š
, 
g£Ëù
, 
dœeù_d”iv
,

134 (
have_šdœeù
 ? &
šdœeù_d”iv
 : 
NULL
), &
fm³_¡©s
);

136 ià(
num_dÚe
 % 100 == 0)

137 
KALDI_LOG
 << "Proûs£d " << 
num_dÚe
 << " utterances.";

140 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


142 
KALDI_LOG
 << "Overall weighted‡coustic†ikelihood…er frame is "

143 << (
tÙ_like
/
num_äames
) << " over " <<‚um_frames << " frames.";

145 
Ouut
 
	`ko
(
¡©s_wxf’ame
, 
bš¬y
);

146 
fm³_¡©s
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

148  (
num_dÚe
 != 0 ? 0 : 1);

149 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

150 
¡d
::
û¼
 << 
e
.
	`wh©
();

153 
	}
}

	@gmm-get-stats-deriv.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/šdœeù-diff-dŸg-gmm.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

31 
MËDŸgGmmO±iÚs
 
gmm_İts
;

33 cÚ¡ *
u§ge
 =

40 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

41 
MËDŸgGmmO±iÚs
 
İts
;

43 
Ba£Flßt
 
mš_v¬Ÿnû
 = 
İts
.min_variance;

44 
Ba£Flßt
 
mš_gaussŸn_occu·ncy
 = 
İts
.min_gaussian_occupancy;

46 
P¬£O±iÚs
 
	`po
(
u§ge
);

47 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

48 
po
.
	`Regi¡”
("mš-v¬Ÿnû", &
mš_v¬Ÿnû
,

50 
po
.
	`Regi¡”
("mš-gaussŸn-occu·ncy", &
mš_gaussŸn_occu·ncy
,

53 
po
.
	`R—d
(
¬gc
, 
¬gv
);

55 ià(
po
.
	`NumArgs
() != 5) {

56 
po
.
	`PrštU§ge
();

57 
	`ex™
(1);

60 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

61 
num_¡©s_rxf’ame
 = 
po
.
	`G‘Arg
(2),

62 
d’_¡©s_rxf’ame
 = 
po
.
	`G‘Arg
(3),

63 
ml_¡©s_rxf’ame
 = 
po
.
	`G‘Arg
(4),

64 
d”iv_wxf’ame
 = 
po
.
	`G‘Arg
(5);

66 
AmDŸgGmm
 
am_gmm
;

67 
T¿ns™iÚMod–
 
Œªs_mod–
;

69 
boŞ
 
bš¬y_»ad
;

70 
IÅut
 
	`ki
(
mod–_rxf’ame
, &
bš¬y_»ad
);

71 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

72 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

75 
VeùÜ
<> 
Œªs™iÚ_accs
;

77 
AccumAmDŸgGmm
 
num_¡©s
, 
d’_¡©s
, 
ml_¡©s
;

79 
boŞ
 
bš¬y_»ad
;

80 
IÅut
 
	`ki
(
num_¡©s_rxf’ame
, &
bš¬y_»ad
);

81 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

82 
num_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
çl£
);

85 
boŞ
 
bš¬y_»ad
;

86 
IÅut
 
	`ki
(
d’_¡©s_rxf’ame
, &
bš¬y_»ad
);

87 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

88 
d’_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
çl£
);

91 
boŞ
 
bš¬y_»ad
;

92 
IÅut
 
	`ki
(
ml_¡©s_rxf’ame
, &
bš¬y_»ad
);

93 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

94 
ml_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
çl£
);

97 
AccumAmDŸgGmm
 
mod–_d”iv
;

101 
	`G‘StsD”iv©ive
(
am_gmm
, 
num_¡©s
, 
d’_¡©s
, 
ml_¡©s
,

102 
mš_v¬Ÿnû
, 
mš_gaussŸn_occu·ncy
,

103 &
mod–_d”iv
);

105 
	`Wr™eK®diObjeù
(
mod–_d”iv
, 
d”iv_wxf’ame
, 
bš¬y_wr™e
);

107 
KALDI_LOG
 << "Computed model derivative‡nd wrote ito "

108 << 
d”iv_wxf’ame
;

111 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

112 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

115 
	}
}

	@gmm-global-acc-stats-twofeats.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/mod–-commÚ.h
"

25 
	~"gmm/fuÎ-gmm.h
"

26 
	~"gmm/dŸg-gmm.h
"

27 
	~"gmm/mË-fuÎ-gmm.h
"

30 
	$maš
(
¬gc
, *
¬gv
[]) {

31 
Œy
 {

32 
usšg
 
Çme¥aû
 
k®di
;

34 cÚ¡ *
u§ge
 =

41 
P¬£O±iÚs
 
	`po
(
u§ge
);

42 
boŞ
 
bš¬y
 = 
Œue
;

43 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvw";

44 
¡d
::
¡ršg
 
g£Ëù_r¥ecif›r
, 
weights_r¥ecif›r
;

45 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

46 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameters will be "

48 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "rspecifier for gselect objects "

50 
po
.
	`Regi¡”
("weights", &
weights_r¥ecif›r
, "rspecifier for‡ vector of floats "

52 
po
.
	`R—d
(
¬gc
, 
¬gv
);

54 ià(
po
.
	`NumArgs
() != 4) {

55 
po
.
	`PrštU§ge
();

56 
	`ex™
(1);

59 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

60 
ã©u»1_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

61 
ã©u»2_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

62 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(4);

64 
DŸgGmm
 
gmm
;

66 
boŞ
 
bš¬y_»ad
;

67 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y_»ad
);

68 
gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

71 
št32
 
Ãw_dim
 = 0;

72 
AccumDŸgGmm
 
gmm_accs
;

76 
tÙ_like
 = 0.0, 
tÙ_weight
 = 0.0;

78 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»1_»ad”
(
ã©u»1_r¥ecif›r
);

79 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»2_»ad”
(
ã©u»2_r¥ecif›r
);

80 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

81 
RªdomAcûssBa£FlßtVeùÜR—d”
 
	`weights_»ad”
(
weights_r¥ecif›r
);

82 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

84 ; !
ã©u»1_»ad”
.
	`DÚe
(); f—tu»1_»ad”.
	`Next
()) {

85 
¡d
::
¡ršg
 
key
 = 
ã©u»1_»ad”
.
	`Key
();

86 ià(!
ã©u»2_»ad”
.
	`HasKey
(
key
)) {

87 
KALDI_WARN
 << "FÜ u‰”ªû " << 
key
 << ", second features‚ot…resent.";

88 
num_”r
++;

91 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©1
 = 
ã©u»1_»ad”
.
	`V®ue
();

92 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©2
 = 
ã©u»2_»ad”
.
	`V®ue
(
key
);

93 
št32
 
fe_äames
 = 
m©1
.
	`NumRows
();

94 
	`KALDI_ASSERT
(
m©1
.
	`NumRows
(è=ğ
m©2
.NumRows());

95 ià(
Ãw_dim
 == 0) {

96 
Ãw_dim
 = 
m©2
.
	`NumCŞs
();

97 
gmm_accs
.
	`Resize
(
gmm
.
	`NumGauss
(), 
Ãw_dim
,

98 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
));

100 
Ba£Flßt
 
fe_like
 = 0.0,

101 
fe_weight
 = 0.0;

103 
VeùÜ
<
Ba£Flßt
> 
weights
;

104 ià(
weights_r¥ecif›r
 != "") {

105 ià(!
weights_»ad”
.
	`HasKey
(
key
)) {

106 
KALDI_WARN
 << "NØ³r-äamweight avaabË fÜ u‰”ªû " << 
key
;

107 
num_”r
++;

110 
weights
 = 
weights_»ad”
.
	`V®ue
(
key
);

111 ià(
weights
.
	`Dim
(è!ğ
fe_äames
) {

112 
KALDI_WARN
 << "Weight fÜ u‰”ªû " << 
key
 << " have wrong dim "

113 << 
weights
.
	`Dim
(è<< " vs. " << 
fe_äames
;

114 
num_”r
++;

118 ià(
g£Ëù_r¥ecif›r
 != "") {

119 ià(!
g£Ëù_»ad”
.
	`HasKey
(
key
)) {

120 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
key
;

121 
num_”r
++;

124 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
 =

125 
g£Ëù_»ad”
.
	`V®ue
(
key
);

126 ià(
g£Ëù
.
	`size
(è!ğ
¡©ic_ÿ¡
<
size_t
>(
fe_äames
)) {

127 
KALDI_WARN
 << "g£Ëù infÜm©iÚ fÜ u‰”ªû " << 
key


128 << " ha wrÚg siz" << 
g£Ëù
.
	`size
() << " vs. "

129 << 
fe_äames
;

130 
num_”r
++;

134 
št32
 
i
 = 0; i < 
fe_äames
; i++) {

135 
Ba£Flßt
 
weight
 = (
weights
.
	`Dim
(è!ğ0è? 
	`weights
(
i
) : 1.0;

136 ià(
weight
 == 0.0) ;

137 
fe_weight
 +ğ
weight
;

138 
SubVeùÜ
<
Ba£Flßt
> 
	`d©a1
(
m©1
, 
i
), 
	`d©a2
(
m©2
, i);

139 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
this_g£Ëù
 = 
g£Ëù
[
i
];

140 
št32
 
g£Ëù_size
 = 
this_g£Ëù
.
	`size
();

141 
	`KALDI_ASSERT
(
g£Ëù_size
 > 0);

142 
VeùÜ
<
Ba£Flßt
> 
loglikes
;

143 
gmm
.
	`LogLik–ihoodsP»£Ëù
(
d©a1
, 
this_g£Ëù
, &
loglikes
);

144 
fe_like
 +ğ
weight
 * 
loglikes
.
	`AµlySoáMax
();

145 
loglikes
.
	`SÿË
(
weight
);

146 
št32
 
j
 = 0; j < 
loglikes
.
	`Dim
(); j++)

147 
gmm_accs
.
	`AccumuÏ‹FÜCompÚ’t
(
d©a2
, 
this_g£Ëù
[
j
], 
	`loglikes
(j));

150 
VeùÜ
<
Ba£Flßt
> 
po¡”iÜs
;

151 
št32
 
i
 = 0; i < 
fe_äames
; i++) {

152 
Ba£Flßt
 
weight
 = (
weights
.
	`Dim
(è!ğ0è? 
	`weights
(
i
) : 1.0;

153 ià(
weight
 == 0.0) ;

154 
fe_weight
 +ğ
weight
;

155 
fe_like
 +ğ
weight
 * 
gmm
.
	`CompÚ’tPo¡”iÜs
(
m©1
.
	`Row
(
i
), &
po¡”iÜs
);

156 
po¡”iÜs
.
	`SÿË
(
weight
);

157 
gmm_accs
.
	`AccumuÏ‹FromPo¡”iÜs
(
m©2
.
	`Row
(
i
), 
po¡”iÜs
);

160 
	`KALDI_VLOG
(2è<< "F'" << 
key
 << "': Average†ikelihood = "

161 << (
fe_like
/
fe_weight
) << " over "

162 << 
fe_weight
 <<" frames.";

163 
tÙ_like
 +ğ
fe_like
;

164 
tÙ_weight
 +ğ
fe_weight
;

165 
num_dÚe
++;

167 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " files; "

168 << 
num_”r
 << " withƒrrors.";

169 
KALDI_LOG
 << "Overall†ikelihood…er "

170 << "äamğ" << (
tÙ_like
/
tÙ_weight
) << " over " <<ot_weight

173 
	`Wr™eK®diObjeù
(
gmm_accs
, 
accs_wxf’ame
, 
bš¬y
);

174 
KALDI_LOG
 << "Wr™‹Àacc tØ" << 
accs_wxf’ame
;

175  (
num_dÚe
 != 0 ? 0 : 1);

176 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

177 
¡d
::
û¼
 << 
e
.
	`wh©
();

180 
	}
}

	@gmm-global-acc-stats.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/mod–-commÚ.h
"

24 
	~"gmm/fuÎ-gmm.h
"

25 
	~"gmm/dŸg-gmm.h
"

26 
	~"gmm/mË-fuÎ-gmm.h
"

29 
	$maš
(
¬gc
, *
¬gv
[]) {

30 
Œy
 {

31 
usšg
 
Çme¥aû
 
k®di
;

33 cÚ¡ *
u§ge
 =

39 
P¬£O±iÚs
 
	`po
(
u§ge
);

40 
boŞ
 
bš¬y
 = 
Œue
;

41 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvw";

42 
¡d
::
¡ršg
 
g£Ëù_r¥ecif›r
, 
weights_r¥ecif›r
;

43 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

44 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameters will be "

46 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "rspecifier for gselect objects "

48 
po
.
	`Regi¡”
("weights", &
weights_r¥ecif›r
, "rspecifier for‡ vector of floats "

50 
po
.
	`R—d
(
¬gc
, 
¬gv
);

52 ià(
po
.
	`NumArgs
() != 3) {

53 
po
.
	`PrštU§ge
();

54 
	`ex™
(1);

57 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

58 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

59 
accs_wxf’ame
 = 
po
.
	`G‘Arg
(3);

61 
DŸgGmm
 
gmm
;

63 
boŞ
 
bš¬y_»ad
;

64 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y_»ad
);

65 
gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

68 
AccumDŸgGmm
 
gmm_accs
;

69 
gmm_accs
.
	`Resize
(
gmm
, 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
));

71 
tÙ_like
 = 0.0, 
tÙ_weight
 = 0.0;

73 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

74 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

75 
RªdomAcûssBa£FlßtVeùÜR—d”
 
	`weights_»ad”
(
weights_r¥ecif›r
);

76 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

78 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

79 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

80 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

81 
št32
 
fe_äames
 = 
m©
.
	`NumRows
();

82 
Ba£Flßt
 
fe_like
 = 0.0,

83 
fe_weight
 = 0.0;

85 
VeùÜ
<
Ba£Flßt
> 
weights
;

86 ià(
weights_r¥ecif›r
 != "") {

87 ià(!
weights_»ad”
.
	`HasKey
(
key
)) {

88 
KALDI_WARN
 << "NØ³r-äamweight avaabË fÜ u‰”ªû " << 
key
;

89 
num_”r
++;

92 
weights
 = 
weights_»ad”
.
	`V®ue
(
key
);

93 ià(
weights
.
	`Dim
(è!ğ
fe_äames
) {

94 
KALDI_WARN
 << "Weight fÜ u‰”ªû " << 
key
 << " have wrong dim "

95 << 
weights
.
	`Dim
(è<< " vs. " << 
fe_äames
;

96 
num_”r
++;

101 ià(
g£Ëù_r¥ecif›r
 != "") {

102 ià(!
g£Ëù_»ad”
.
	`HasKey
(
key
)) {

103 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
key
;

104 
num_”r
++;

107 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
 =

108 
g£Ëù_»ad”
.
	`V®ue
(
key
);

109 ià(
g£Ëù
.
	`size
(è!ğ
¡©ic_ÿ¡
<
size_t
>(
fe_äames
)) {

110 
KALDI_WARN
 << "g£Ëù infÜm©iÚ fÜ u‰”ªû " << 
key


111 << " ha wrÚg siz" << 
g£Ëù
.
	`size
() << " vs. "

112 << 
fe_äames
;

113 
num_”r
++;

117 
št32
 
i
 = 0; i < 
fe_äames
; i++) {

118 
Ba£Flßt
 
weight
 = (
weights
.
	`Dim
(è!ğ0è? 
	`weights
(
i
) : 1.0;

119 ià(
weight
 == 0.0) ;

120 
fe_weight
 +ğ
weight
;

121 
SubVeùÜ
<
Ba£Flßt
> 
	`d©a
(
m©
, 
i
);

122 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
this_g£Ëù
 = 
g£Ëù
[
i
];

123 
št32
 
g£Ëù_size
 = 
this_g£Ëù
.
	`size
();

124 
	`KALDI_ASSERT
(
g£Ëù_size
 > 0);

125 
VeùÜ
<
Ba£Flßt
> 
loglikes
;

126 
gmm
.
	`LogLik–ihoodsP»£Ëù
(
d©a
, 
this_g£Ëù
, &
loglikes
);

127 
fe_like
 +ğ
weight
 * 
loglikes
.
	`AµlySoáMax
();

128 
loglikes
.
	`SÿË
(
weight
);

129 
št32
 
j
 = 0; j < 
loglikes
.
	`Dim
(); j++)

130 
gmm_accs
.
	`AccumuÏ‹FÜCompÚ’t
(
d©a
, 
this_g£Ëù
[
j
], 
	`loglikes
(j));

133 
št32
 
i
 = 0; i < 
fe_äames
; i++) {

134 
Ba£Flßt
 
weight
 = (
weights
.
	`Dim
(è!ğ0è? 
	`weights
(
i
) : 1.0;

135 ià(
weight
 == 0.0) ;

136 
fe_weight
 +ğ
weight
;

137 
fe_like
 +ğ
weight
 *

138 
gmm_accs
.
	`AccumuÏ‹FromDŸg
(
gmm
, 
m©
.
	`Row
(
i
), 
weight
);

141 
	`KALDI_VLOG
(2è<< "F'" << 
key
 << "': Average†ikelihood = "

142 << (
fe_like
/
fe_weight
) << " over "

143 << 
fe_weight
 <<" frames.";

144 
tÙ_like
 +ğ
fe_like
;

145 
tÙ_weight
 +ğ
fe_weight
;

146 
num_dÚe
++;

148 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " files; "

149 << 
num_”r
 << " withƒrrors.";

150 
KALDI_LOG
 << "Overall†ikelihood…er "

151 << "äamğ" << (
tÙ_like
/
tÙ_weight
) << " over " <<ot_weight

154 
	`Wr™eK®diObjeù
(
gmm_accs
, 
accs_wxf’ame
, 
bš¬y
);

155 
KALDI_LOG
 << "Wr™‹Àacc tØ" << 
accs_wxf’ame
;

156  (
num_dÚe
 != 0 ? 0 : 1);

157 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

158 
¡d
::
û¼
 << 
e
.
	`wh©
();

161 
	}
}

	@gmm-global-copy.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/dŸg-gmm.h
"

24 
	$maš
(
¬gc
, *
¬gv
[]) {

25 
Œy
 {

26 
usšg
 
Çme¥aû
 
k®di
;

27 
k®di
::
	tšt32
 int32;

29 cÚ¡ *
u§ge
 =

34 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

35 
P¬£O±iÚs
 
	`po
(
u§ge
);

36 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

38 
po
.
	`R—d
(
¬gc
, 
¬gv
);

40 ià(
po
.
	`NumArgs
() != 2) {

41 
po
.
	`PrštU§ge
();

42 
	`ex™
(1);

45 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

46 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(2);

48 
DŸgGmm
 
gmm
;

50 
boŞ
 
bš¬y_»ad
;

51 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

52 
gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

54 
	`Wr™eK®diObjeù
(
gmm
, 
mod–_out_f’ame
, 
bš¬y_wr™e
);

56 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

57 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

58 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

61 
	}
}

	@gmm-global-est-fmllr.cc

20 
	~<¡ršg
>

21 
usšg
 
	g¡d
::
¡ršg
;

22 
	~<veùÜ
>

23 
usšg
 
	g¡d
::
veùÜ
;

25 
	~"ba£/k®di-commÚ.h
"

26 
	~"ut/commÚ-uts.h
"

27 
	~"gmm/am-dŸg-gmm.h
"

28 
	~"hmm/Œªs™iÚ-mod–.h
"

29 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
Çme¥aû
 
	gk®di
 {

32 
boŞ
 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

33 cÚ¡ 
DŸgGmm
 &
gmm
,

34 cÚ¡ 
¡d
::
¡ršg
 &
key
,

35 
RªdomAcûssBa£FlßtVeùÜR—d”
 *
weights_»ad”
,

36 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 *
g£Ëù_»ad”
,

37 
AccumFuÎGmm
 *
fuÎcov_¡©s
) {

38 
	gVeùÜ
<
	gBa£Flßt
> 
	gweights
;

39 ià(
	gweights_»ad”
->
IsO³n
()) {

40 ià(!
	gweights_»ad”
->
HasKey
(
key
)) {

41 
	gKALDI_WARN
 << "NØweight ´e£Á fÜ u‰”ªû " << 
	gkey
;

42  
	gçl£
;

44 
	gweights
 = 
weights_»ad”
->
V®ue
(
key
);

46 
št32
 
	gnum_äames
 = 
ã©s
.
NumRows
();

47 ià(
	gg£Ëù_»ad”
->
IsO³n
()) {

48 ià(!
	gg£Ëù_»ad”
->
HasKey
(
key
)) {

49 
	gKALDI_WARN
 << "NØg£Ëù infÜm©iÚ…»£Á fÜ u‰”ªû " << 
	gkey
;

50  
	gçl£
;

52 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
št32
> > &
g£Ëù
(
g£Ëù_»ad”
->
V®ue
(
key
));

53 ià(
	gg£Ëù
.
size
(è!ğ
num_äames
) {

54 
KALDI_WARN
 << "g£Ëù infÜm©iÚ ha wrÚg sizfÜ u‰”ªû " << 
key
;

55  
	gçl£
;

57 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

58 cÚ¡ 
	g¡d
::
veùÜ
<
št32
> &
this_g£Ëù
(
g£Ëù
[
t
]);

59 
Ba£Flßt
 
	gweight
 = (
weights
.
Dim
(è!ğ0 ? weights(
t
) : 1.0);

60 ià(
	gweight
 != 0.0) {

61 
VeùÜ
<
Ba£Flßt
> 
po¡
(
this_g£Ëù
.
size
());

62 
	ggmm
.
LogLik–ihoodsP»£Ëù
(
ã©s
.
Row
(
t
), 
this_g£Ëù
, &
po¡
);

63 
	gpo¡
.
AµlySoáMax
();

64 
	gpo¡
.
SÿË
(
weight
);

65 
size_t
 
	gi
 = 0; i < 
	gthis_g£Ëù
.
size
(); i++)

66 
	gfuÎcov_¡©s
->
AccumuÏ‹FÜCompÚ’t
(
ã©s
.
Row
(
t
),

67 
this_g£Ëù
[
i
], 
po¡
(i));

71 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

72 
Ba£Flßt
 
	gweight
 = (
weights
.
Dim
(è!ğ0 ? weights(
t
) : 1.0);

73 ià(
	gweight
 != 0.0)

74 
fuÎcov_¡©s
->
AccumuÏ‹FromDŸg
(
gmm
, 
ã©s
.
Row
(
t
), 
weight
);

77  
	gŒue
;

83 
	$maš
(
¬gc
, *
¬gv
[]) {

84 
Œy
 {

85 
k®di
::
	tšt32
 int32;

86 
usšg
 
Çme¥aû
 
k®di
;

87 cÚ¡ *
u§ge
 =

93 
P¬£O±iÚs
 
	`po
(
u§ge
);

94 
FmÎrO±iÚs
 
fmÎr_İts
;

95 
¡ršg
 
¥k2u‰_r¥ecif›r
, 
g£Ëù_r¥ecif›r
, 
weights_r¥ecif›r
,

96 
®ignm’t_mod–
;

99 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

101 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "rspecifier for gselect objects "

103 
po
.
	`Regi¡”
("weights", &
weights_r¥ecif›r
, "rspecifier for‡ vector of floats "

105 
po
.
	`Regi¡”
("®ign-mod–", &
®ignm’t_mod–
, "rxfilename for‡ model inhe "

108 
fmÎr_İts
.
	`Regi¡”
(&
po
);

110 
po
.
	`R—d
(
¬gc
, 
¬gv
);

112 ià(
po
.
	`NumArgs
() != 3) {

113 
po
.
	`PrštU§ge
();

114 
	`ex™
(1);

117 
¡ršg
 
gmm_rxf’ame
 = 
po
.
	`G‘Arg
(1),

118 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

119 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(3);

121 
DŸgGmm
 
gmm
;

122 
	`R—dK®diObjeù
(
gmm_rxf’ame
, &
gmm
);

123 
DŸgGmm
 
®i_gmm_»ad
;

124 ià(
®ignm’t_mod–
 != "") {

125 
boŞ
 
bš¬y
;

126 
IÅut
 
	`ki
(
gmm_rxf’ame
, &
bš¬y
);

127 
®i_gmm_»ad
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

129 
DŸgGmm
 &
®i_gmm
 = (
®ignm’t_mod–
 !ğ"" ? 
®i_gmm_»ad
 : 
gmm
);

131 
RªdomAcûssBa£FlßtVeùÜR—d”
 
	`weights_»ad”
(
weights_r¥ecif›r
);

132 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

134 
tÙ_im´
 = 0.0, 
tÙ_t
 = 0.0;

136 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

138 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

140 ià(
¥k2u‰_r¥ecif›r
 != "") {

141 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

142 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

144 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

145 
AccumFuÎGmm
 
	`fuÎcov_¡©s
(
gmm
.
	`NumGauss
(), gmm.
	`Dim
(), 
kGmmAÎ
);

146 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

147 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

148 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

149 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

150 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

151 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

154 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

156 ià(
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
®i_gmm
, 
u‰
, &
weights_»ad”
,

157 &
g£Ëù_»ad”
, &
fuÎcov_¡©s
)è
num_dÚe
++;

158 
num_”r
++;

161 
Ba£Flßt
 
im´
, 
¥k_tÙ_t
;

163 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
gmm
.
	`Dim
(), gmm.Dim()+1);

164 
ŒªsfÜm
.
	`S‘Un™
();

165 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
gmm
, 
fuÎcov_¡©s
);

166 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
¥k_tÙ_t
);

167 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

169 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from fMLLR is "

170 << (
im´
/
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames.";

171 
tÙ_im´
 +ğ
im´
;

172 
tÙ_t
 +ğ
¥k_tÙ_t
;

175 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

176 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

177 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

179 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

181 
AccumFuÎGmm
 
	`fuÎcov_¡©s
(
gmm
.
	`NumGauss
(), gmm.
	`Dim
(), 
kGmmAÎ
);

183 ià(
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
®i_gmm
, 
u‰
, &
weights_»ad”
,

184 &
g£Ëù_»ad”
, &
fuÎcov_¡©s
)) {

185 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
;

187 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
gmm
.
	`Dim
(), gmm.Dim()+1);

188 
ŒªsfÜm
.
	`S‘Un™
();

189 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
gmm
, 
fuÎcov_¡©s
);

190 
¥k_¡©s
.
	`Upd©e
(
fmÎr_İts
, &
ŒªsfÜm
, &
im´
, &
u‰_tÙ_t
);

191 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

193 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from fMLLR is "

194 << (
im´
/
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames.";

195 
tÙ_im´
 +ğ
im´
;

196 
tÙ_t
 +ğ
u‰_tÙ_t
;

197 
num_dÚe
++;

198 } 
num_”r
++;

203 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


205 
KALDI_LOG
 << "Overall fMLLR‡uxf impr…er frame is "

206 << (
tÙ_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

207  (
num_dÚe
 != 0 ? 0 : 1);

208 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

209 
¡d
::
û¼
 << 
e
.
	`wh©
();

212 
	}
}

	@gmm-global-est-lvtln-trans.cc

21 
	~<¡ršg
>

22 
usšg
 
	g¡d
::
¡ršg
;

23 
	~<veùÜ
>

24 
usšg
 
	g¡d
::
veùÜ
;

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"ut/commÚ-uts.h
"

28 
	~"gmm/am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/lvn.h
"

31 
	~"hmm/po¡”iÜ.h
"

33 
Çme¥aû
 
	gk®di
 {

34 
AccumuÏ‹FÜU‰”ªû
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

35 cÚ¡ 
Po¡”iÜ
 &
po¡
,

36 cÚ¡ 
DŸgGmm
 &
gmm
,

37 
FmÎrDŸgGmmAccs
 *
¥k_¡©s
) {

38 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
št32
>(
po¡
.
size
()è=ğ
ã©s
.
NumRows
());

39 
size_t
 
	gi
 = 0; i < 
	gpo¡
.
size
(); i++) {

40 
	g¡d
::
veùÜ
<
št32
> 
g£Ëù
(
po¡
[
i
].
size
());

41 
	gVeùÜ
<
	gBa£Flßt
> 
this_po¡
(
po¡
[
i
].
size
());

42 
size_t
 
	gj
 = 0; j < 
	gpo¡
[
i
].
size
(); j++) {

43 
št32
 
	gg
 = 
po¡
[
i
][
j
].
fœ¡
;

44 
Ba£Flßt
 
	gweight
 = 
po¡
[
i
][
j
].
£cÚd
;

45 
	gg£Ëù
[
j
] = 
g
;

46 
this_po¡
(
j
èğ
weight
;

48 
	g¥k_¡©s
->
AccumuÏ‹FromPo¡”iÜsP»£Ëù
(
gmm
, 
g£Ëù
,

49 
ã©s
.
Row
(
i
),

50 
this_po¡
);

57 
	$maš
(
¬gc
, *
¬gv
[]) {

58 
Œy
 {

59 
k®di
::
	tšt32
 int32;

60 
usšg
 
Çme¥aû
 
k®di
;

61 cÚ¡ *
u§ge
 =

73 
P¬£O±iÚs
 
	`po
(
u§ge
);

74 
¡ršg
 
¥k2u‰_r¥ecif›r
;

75 
Ba£Flßt
 
logd‘_sÿË
 = 1.0;

76 
¡d
::
¡ršg
 
nÜm_ty³
 = "offset";

77 
po
.
	`Regi¡”
("nÜm-ty³", &
nÜm_ty³
, "type of fMLLR‡pplied (\"offset\"|\"none\"|\"diag\")");

78 
po
.
	`Regi¡”
("¥k2u‰", &
¥k2u‰_r¥ecif›r
, "rspecifier for speakero "

80 
po
.
	`Regi¡”
("logd‘-sÿË", &
logd‘_sÿË
, "Scale on†og-determinanterm in‡uxiliary function");

82 
po
.
	`R—d
(
¬gc
, 
¬gv
);

84 ià(
po
.
	`NumArgs
() < 5 ||…o.NumArgs() > 6) {

85 
po
.
	`PrštU§ge
();

86 
	`ex™
(1);

89 
¡ršg


90 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

91 
lvn_rxf’ame
 = 
po
.
	`G‘Arg
(2),

92 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

93 
po¡_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

94 
Œªs_w¥ecif›r
 = 
po
.
	`G‘Arg
(5),

95 
w¬p_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

97 
DŸgGmm
 
gmm
;

98 
	`R—dK®diObjeù
(
mod–_rxf’ame
, &
gmm
);

99 
Lš—rVn
 
lvn
;

100 
	`R—dK®diObjeù
(
lvn_rxf’ame
, &
lvn
);

103 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡_r¥ecif›r
);

105 
tÙ_lvn_im´
 = 0.0, 
tÙ_t
 = 0.0;

107 
Ba£FlßtM©rixWr™”
 
	`ŒªsfÜm_wr™”
(
Œªs_w¥ecif›r
);

109 
Ba£FlßtWr™”
 
	`w¬p_wr™”
(
w¬p_w¥ecif›r
);

111 
¡d
::
veùÜ
<
št32
> 
	`şass_couÁs
(
lvn
.
	`NumCÏs£s
(), 0);

112 
št32
 
num_dÚe
 = 0, 
num_no_po¡
 = 0, 
num_Ùh”_”rÜ
 = 0;

113 ià(
¥k2u‰_r¥ecif›r
 != "") {

114 
Sequ’tŸlTok’VeùÜR—d”
 
	`¥k2u‰_»ad”
(
¥k2u‰_r¥ecif›r
);

115 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

117 ; !
¥k2u‰_»ad”
.
	`DÚe
(); spk2u‰_»ad”.
	`Next
()) {

118 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
lvn
.
	`Dim
());

119 
¡ršg
 
¥k
 = 
¥k2u‰_»ad”
.
	`Key
();

120 cÚ¡ 
veùÜ
<
¡ršg
> &
u‰li¡
 = 
¥k2u‰_»ad”
.
	`V®ue
();

121 
size_t
 
i
 = 0; i < 
u‰li¡
.
	`size
(); i++) {

122 
¡d
::
¡ršg
 
u‰
 = 
u‰li¡
[
i
];

123 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

124 
KALDI_WARN
 << "Did‚Ù fšd f—tu» fÜ u‰”ªû " << 
u‰
;

127 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

128 
KALDI_WARN
 << "Did‚Ù fšd…o¡”iÜ fÜ u‰”ªû " << 
u‰
;

129 
num_no_po¡
++;

132 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

133 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

134 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

135 
KALDI_WARN
 << "Po¡”iÜ veùÜ ha wrÚg siz" << 
po¡
.
	`size
()

136 << " vs. " << 
ã©s
.
	`NumRows
();

137 
num_Ùh”_”rÜ
++;

141 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
gmm
, &
¥k_¡©s
);

143 
num_dÚe
++;

146 
Ba£Flßt
 
im´
, 
¥k_tÙ_t
;

148 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
lvn
.
	`Dim
(),†vtln.Dim()+1);

149 
št32
 
şass_idx
;

150 
lvn
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
,

151 
nÜm_ty³
,

152 
logd‘_sÿË
,

153 &
ŒªsfÜm
,

154 &
şass_idx
,

155 
NULL
,

156 &
im´
,

157 &
¥k_tÙ_t
);

158 
şass_couÁs
[
şass_idx
]++;

159 
ŒªsfÜm_wr™”
.
	`Wr™e
(
¥k
, 
ŒªsfÜm
);

160 ià(
w¬p_w¥ecif›r
 != "")

161 
w¬p_wr™”
.
	`Wr™e
(
¥k
, 
lvn
.
	`G‘W¬p
(
şass_idx
));

163 
KALDI_LOG
 << "FÜ s³ak” " << 
¥k
 << ",‡uxf-impr from LVTLN is "

164 << (
im´
/
¥k_tÙ_t
) << ", over " << spk_tot_t << " frames.";

165 
tÙ_lvn_im´
 +ğ
im´
;

166 
tÙ_t
 +ğ
¥k_tÙ_t
;

169 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

170 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

171 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

172 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

173 
KALDI_WARN
 << "Did‚ot find…osterior for utterance "

174 << 
u‰
;

175 
num_no_po¡
++;

178 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

179 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

181 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
ã©s
.
	`NumRows
()) {

182 
KALDI_WARN
 << "Po¡”iÜ ha wrÚg siz" << 
po¡
.
	`size
()

183 << " vs. " << 
ã©s
.
	`NumRows
();

184 
num_Ùh”_”rÜ
++;

187 
num_dÚe
++;

189 
FmÎrDŸgGmmAccs
 
	`¥k_¡©s
(
lvn
.
	`Dim
());

191 
	`AccumuÏ‹FÜU‰”ªû
(
ã©s
, 
po¡
, 
gmm
,

192 &
¥k_¡©s
);

193 
Ba£Flßt
 
im´
, 
u‰_tÙ_t
 = 
¥k_¡©s
.
b‘a_
;

195 
M©rix
<
Ba£Flßt
> 
	`ŒªsfÜm
(
lvn
.
	`Dim
(),†vtln.Dim()+1);

196 
št32
 
şass_idx
;

197 
lvn
.
	`Compu‹T¿nsfÜm
(
¥k_¡©s
,

198 
nÜm_ty³
,

199 
logd‘_sÿË
,

200 &
ŒªsfÜm
,

201 &
şass_idx
,

202 
NULL
,

203 &
im´
,

204 &
u‰_tÙ_t
);

205 
şass_couÁs
[
şass_idx
]++;

206 
ŒªsfÜm_wr™”
.
	`Wr™e
(
u‰
, 
ŒªsfÜm
);

207 ià(
w¬p_w¥ecif›r
 != "")

208 
w¬p_wr™”
.
	`Wr™e
(
u‰
, 
lvn
.
	`G‘W¬p
(
şass_idx
));

211 
KALDI_LOG
 << "FÜ u‰”ªû " << 
u‰
 << ",‡uxf-impr from LVTLN is "

212 << (
im´
/
u‰_tÙ_t
) << ", over " << utt_tot_t << " frames.";

213 
tÙ_lvn_im´
 +ğ
im´
;

214 
tÙ_t
 +ğ
u‰_tÙ_t
;

219 
¡d
::
o¡ršg¡»am
 
s
;

220 
size_t
 
i
 = 0; i < 
şass_couÁs
.
	`size
(); i++)

221 
s
 << ' ' << 
şass_couÁs
[
i
];

222 
KALDI_LOG
 << "Di¡ributiÚ oàşas£ is: " << 
s
.
	`¡r
();

225 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡


226 << " w™h‚Øpo¡”iÜs, " << 
num_Ùh”_”rÜ
 << " with otherƒrrors.";

227 
KALDI_LOG
 << "Overall LVTLN‡uxf impr…er frame is "

228 << (
tÙ_lvn_im´
 / 
tÙ_t
) << " over " <<ot_t << " frames.";

229  (
num_dÚe
 == 0 ? 1 : 0);

230 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

231 
¡d
::
û¼
 << 
e
.
	`wh©
();

234 
	}
}

	@gmm-global-est.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/dŸg-gmm.h
"

23 
	~"gmm/mË-dŸg-gmm.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

30 
MËDŸgGmmO±iÚs
 
gmm_İts
;

32 cÚ¡ *
u§ge
 =

36 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

37 
št32
 
mixup
 = 0;

38 
Ba£Flßt
 
³¹urb_çùÜ
 = 0.01;

39 
¡d
::
¡ršg
 
upd©e_æags_¡r
 = "mvw";

40 
P¬£O±iÚs
 
	`po
(
u§ge
);

41 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

42 
po
.
	`Regi¡”
("upd©e-æags", &
upd©e_æags_¡r
, "Which GMM…arameters will be "

44 
po
.
	`Regi¡”
("mix-up", &
mixup
, "Increase‚umber of mixture componentso "

46 
po
.
	`Regi¡”
("³¹urb-çùÜ", &
³¹urb_çùÜ
, "While mixing up,…erturb "

48 
gmm_İts
.
	`Regi¡”
(&
po
);

50 
po
.
	`R—d
(
¬gc
, 
¬gv
);

52 ià(
po
.
	`NumArgs
() != 3) {

53 
po
.
	`PrštU§ge
();

54 
	`ex™
(1);

57 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

58 
¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

59 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(3);

61 
DŸgGmm
 
gmm
;

63 
boŞ
 
bš¬y_»ad
;

64 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

65 
gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

68 
AccumDŸgGmm
 
gmm_accs
;

70 
boŞ
 
bš¬y
;

71 
IÅut
 
	`ki
(
¡©s_f’ame
, &
bš¬y
);

72 
gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
 );

76 
Ba£Flßt
 
objf_im´
, 
couÁ
;

77 
	`MËDŸgGmmUpd©e
(
gmm_İts
, 
gmm_accs
,

78 
	`SŒšgToGmmFÏgs
(
upd©e_æags_¡r
),

79 &
gmm
, &
objf_im´
, &
couÁ
);

80 
KALDI_LOG
 << "Overall objective function improvement is "

81 << (
objf_im´
/
couÁ
) << "…er frame over "

82 << (
couÁ
) << " frames.";

85 ià(
mixup
 != 0)

86 
gmm
.
	`S¶™
(
mixup
, 
³¹urb_çùÜ
);

88 
	`Wr™eK®diObjeù
(
gmm
, 
mod–_out_f’ame
, 
bš¬y_wr™e
);

90 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

91 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

92 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

95 
	}
}

	@gmm-global-get-frame-likes.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/mod–-commÚ.h
"

24 
	~"gmm/fuÎ-gmm.h
"

25 
	~"gmm/dŸg-gmm.h
"

26 
	~"gmm/mË-fuÎ-gmm.h
"

29 
	$maš
(
¬gc
, *
¬gv
[]) {

30 
Œy
 {

31 
usšg
 
Çme¥aû
 
k®di
;

33 cÚ¡ *
u§ge
 =

41 
P¬£O±iÚs
 
	`po
(
u§ge
);

42 
boŞ
 
av”age
 = 
çl£
;

43 
¡d
::
¡ršg
 
g£Ëù_r¥ecif›r
;

44 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "rspecifier for gselect objects "

46 
po
.
	`Regi¡”
("av”age", &
av”age
, "Ifrue,…rint outhe‡verage…er-frame "

48 
po
.
	`R—d
(
¬gc
, 
¬gv
);

50 ià(
po
.
	`NumArgs
() != 3) {

51 
po
.
	`PrštU§ge
();

52 
	`ex™
(1);

55 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

56 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

57 
likes_w¥ecif›r
 = 
po
.
	`G‘Arg
(3);

59 
DŸgGmm
 
gmm
;

61 
boŞ
 
bš¬y_»ad
;

62 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y_»ad
);

63 
gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

66 
tÙ_like
 = 0.0, 
tÙ_äames
 = 0.0;

68 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

69 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

70 
Ba£FlßtVeùÜWr™”
 
	`likes_wr™”
(
av”age
 ? "" : 
likes_w¥ecif›r
);

71 
Ba£FlßtWr™”
 
	`av”age_likes_wr™”
(
av”age
 ? 
likes_w¥ecif›r
 : "");

72 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

74 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

75 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

76 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

77 
št32
 
fe_äames
 = 
m©
.
	`NumRows
();

78 
VeùÜ
<
Ba£Flßt
> 
	`likes
(
fe_äames
);

80 ià(
g£Ëù_r¥ecif›r
 != "") {

81 ià(!
g£Ëù_»ad”
.
	`HasKey
(
key
)) {

82 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
key
;

83 
num_”r
++;

86 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
g£Ëù
 =

87 
g£Ëù_»ad”
.
	`V®ue
(
key
);

88 ià(
g£Ëù
.
	`size
(è!ğ
¡©ic_ÿ¡
<
size_t
>(
fe_äames
)) {

89 
KALDI_WARN
 << "g£Ëù infÜm©iÚ fÜ u‰”ªû " << 
key


90 << " ha wrÚg siz" << 
g£Ëù
.
	`size
() << " vs. "

91 << 
fe_äames
;

92 
num_”r
++;

96 
št32
 
i
 = 0; i < 
fe_äames
; i++) {

97 
SubVeùÜ
<
Ba£Flßt
> 
	`d©a
(
m©
, 
i
);

98 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
this_g£Ëù
 = 
g£Ëù
[
i
];

99 
št32
 
g£Ëù_size
 = 
this_g£Ëù
.
	`size
();

100 
	`KALDI_ASSERT
(
g£Ëù_size
 > 0);

101 
VeùÜ
<
Ba£Flßt
> 
loglikes
;

102 
gmm
.
	`LogLik–ihoodsP»£Ëù
(
d©a
, 
this_g£Ëù
, &
loglikes
);

103 
	`likes
(
i
èğ
loglikes
.
	`LogSumExp
();

106 
št32
 
i
 = 0; i < 
fe_äames
; i++)

107 
	`likes
(
i
èğ
gmm
.
	`LogLik–ihood
(
m©
.
	`Row
(i));

110 
tÙ_like
 +ğ
likes
.
	`Sum
();

111 
tÙ_äames
 +ğ
fe_äames
;

112 ià(
av”age
)

113 
av”age_likes_wr™”
.
	`Wr™e
(
key
, 
likes
.
	`Sum
(è/ 
fe_äames
);

115 
likes_wr™”
.
	`Wr™e
(
key
, 
likes
);

116 
num_dÚe
++;

118 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes; " << 
num_”r


120 
KALDI_LOG
 << "Overall†ikelihood…er "

121 << "äamğ" << (
tÙ_like
/
tÙ_äames
) << " over " <<ot_frames

123  (
num_dÚe
 != 0 ? 0 : 1);

124 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

125 
¡d
::
û¼
 << 
e
.
	`wh©
();

128 
	}
}

	@gmm-global-get-post.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/dŸg-gmm.h
"

25 
	~"hmm/po¡”iÜ.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
usšg
 
¡d
::
veùÜ
;

31 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

43 
št32
 
num_po¡
 = 50;

44 
Ba£Flßt
 
mš_po¡
 = 0.0;

45 
po
.
	`Regi¡”
("n", &
num_po¡
, "Number of Gaussianso keep…er frame\n");

46 
po
.
	`Regi¡”
("mš-po¡", &
mš_po¡
, "Minimum…osterior we will output "

48 
po
.
	`R—d
(
¬gc
, 
¬gv
);

50 ià(
po
.
	`NumArgs
() != 3) {

51 
po
.
	`PrštU§ge
();

52 
	`ex™
(1);

55 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

56 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

57 
po¡_w¥ecif›r
 = 
po
.
	`G‘Arg
(3);

59 
DŸgGmm
 
gmm
;

60 
	`R—dK®diObjeù
(
mod–_f’ame
, &
gmm
);

61 
	`KALDI_ASSERT
(
num_po¡
 > 0);

62 
	`KALDI_ASSERT
(
mš_po¡
 < 1.0);

63 
št32
 
num_gauss
 = 
gmm
.
	`NumGauss
();

64 ià(
num_po¡
 > 
num_gauss
) {

65 
KALDI_WARN
 << "You‡sked fÜ " << 
num_po¡
 << " Gaussians but GMM "

66 << "Úly ha " << 
num_gauss
 << ",„eturninghis many. ";

67 
num_po¡
 = 
num_gauss
;

70 
tÙ_like
 = 0.0;

71 
k®di
::
št64
 
tÙ_t
 = 0;

73 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

74 
Po¡”iÜWr™”
 
	`po¡_wr™”
(
po¡_w¥ecif›r
);

76 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

77 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

78 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

79 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

80 
št32
 
T
 = 
ã©s
.
	`NumRows
();

81 ià(
T
 == 0) {

82 
KALDI_WARN
 << "Em±y f—tu» fÜ u‰”ªû " << 
u‰
;

83 
num_”r
++;

86 ià(
ã©s
.
	`NumCŞs
(è!ğ
gmm
.
	`Dim
()) {

87 
KALDI_WARN
 << "Dim’siÚ mism©ch fÜ u‰”ªû " << 
u‰


88 << ": gÙ " << 
ã©s
.
	`NumCŞs
(è<< ",ƒx³ùed " << 
gmm
.
	`Dim
();

89 
num_”r
++;

92 
veùÜ
<veùÜ<
št32
> > 
	`g£Ëù
(
T
);

94 
M©rix
<
Ba£Flßt
> 
loglikes
;

96 
gmm
.
	`LogLik–ihoods
(
ã©s
, &
loglikes
);

98 
Po¡”iÜ
 
	`po¡
(
T
);

100 
log_like_this_fe
 = 0.0;

101 
št32
 
t
 = 0; < 
T
;++) {

102 
log_like_this_fe
 +=

103 
	`VeùÜToPo¡”iÜEÁry
(
loglikes
.
	`Row
(
t
), 
num_po¡
,

104 
mš_po¡
, &(
po¡
[
t
]));

106 
	`KALDI_VLOG
(1è<< "Proûs£d u‰”ªû " << 
u‰
 << ",‡verage†ikelihood "

107 << (
log_like_this_fe
 / 
T
) << " over " << T << " frames";

108 
tÙ_like
 +ğ
log_like_this_fe
;

109 
tÙ_t
 +ğ
T
;

111 
po¡_wr™”
.
	`Wr™e
(
u‰
, 
po¡
);

112 
num_dÚe
++;

115 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


117 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

119 ià(
num_dÚe
 != 0)  0;

121 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

122 
¡d
::
û¼
 << 
e
.
	`wh©
();

125 
	}
}

	@gmm-global-gselect-to-post.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/dŸg-gmm.h
"

24 
	~"hmm/po¡”iÜ.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

31 
k®di
::
	tšt64
 int64;

33 cÚ¡ *
u§ge
 =

45 
P¬£O±iÚs
 
	`po
(
u§ge
);

47 
Ba£Flßt
 
mš_po¡
 = 0.0;

48 
po
.
	`Regi¡”
("mš-po¡", &
mš_po¡
, "If‚onzero,…osteriors belowhis "

52 
po
.
	`R—d
(
¬gc
, 
¬gv
);

54 ià(
po
.
	`NumArgs
() != 4) {

55 
po
.
	`PrštU§ge
();

56 
	`ex™
(1);

59 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1),

60 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

61 
g£Ëù_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

62 
po¡_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

64 
DŸgGmm
 
gmm
;

65 
	`R—dK®diObjeù
(
mod–_rxf’ame
, &
gmm
);

67 
tÙ_loglike
 = 0.0, 
tÙ_äames
 = 0.0;

68 
št64
 
tÙ_po¡s
 = 0;

70 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

71 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

72 
Po¡”iÜWr™”
 
	`po¡_wr™”
(
po¡_w¥ecif›r
);

73 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

75 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

76 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

77 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

79 
št32
 
num_äames
 = 
m©
.
	`NumRows
();

81 
Po¡”iÜ
 
	`po¡
(
num_äames
);

83 ià(!
g£Ëù_»ad”
.
	`HasKey
(
u‰
)) {

84 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
u‰
;

85 
num_”r
++;

88 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
	`g£Ëù
(
g£Ëù_»ad”
.
	`V®ue
(
u‰
));

89 ià(
¡©ic_ÿ¡
<
št32
>(
g£Ëù
.
	`size
()è!ğ
num_äames
) {

90 
KALDI_WARN
 << "g£Ëù infÜm©iÚ fÜ u‰”ªû " << 
u‰


91 << " ha wrÚg siz" << 
g£Ëù
.
	`size
() << " vs. "

92 << 
num_äames
;

93 
num_”r
++;

97 
this_tÙ_loglike
 = 0;

98 
boŞ
 
u‰_ok
 = 
Œue
;

100 
št32
 
t
 = 0; < 
num_äames
;++) {

101 
SubVeùÜ
<
Ba£Flßt
> 
	`äame
(
m©
, 
t
);

102 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
this_g£Ëù
 = 
g£Ëù
[
t
];

103 
	`KALDI_ASSERT
(!
g£Ëù
[
t
].
	`em±y
());

104 
VeùÜ
<
Ba£Flßt
> 
loglikes
;

105 
gmm
.
	`LogLik–ihoodsP»£Ëù
(
äame
, 
this_g£Ëù
, &
loglikes
);

106 
this_tÙ_loglike
 +ğ
loglikes
.
	`AµlySoáMax
();

108 ià(
	`çbs
(
loglikes
.
	`Sum
() - 1.0) > 0.01) {

109 
u‰_ok
 = 
çl£
;

111 ià(
mš_po¡
 != 0.0) {

112 
št32
 
max_šdex
 = 0;

113 
loglikes
.
	`Max
(&
max_šdex
);

114 
št32
 
i
 = 0; i < 
loglikes
.
	`Dim
(); i++)

115 ià(
	`loglikes
(
i
è< 
mš_po¡
)

116 
	`loglikes
(
i
) = 0.0;

117 
Ba£Flßt
 
sum
 = 
loglikes
.
	`Sum
();

118 ià(
sum
 == 0.0) {

119 
	`loglikes
(
max_šdex
) = 1.0;

121 
loglikes
.
	`SÿË
(1.0 / 
sum
);

124 
št32
 
i
 = 0; i < 
loglikes
.
	`Dim
(); i++) {

125 ià(
	`loglikes
(
i
) != 0.0) {

126 
po¡
[
t
].
	`push_back
(
¡d
::
	`make_·œ
(
this_g£Ëù
[
i
], 
	`loglikes
(i)));

127 
tÙ_po¡s
++;

130 
	`KALDI_ASSERT
(!
po¡
[
t
].
	`em±y
());

133 ià(!
u‰_ok
) {

134 
KALDI_WARN
 << "Skpšg u‰”ªû " << 
u‰


136 
num_”r
++;

138 
po¡_wr™”
.
	`Wr™e
(
u‰
, 
po¡
);

139 
num_dÚe
++;

140 
	`KALDI_VLOG
(2è<< "Like/äamfÜ u‰ " << 
u‰
 << " was "

141 << (
this_tÙ_loglike
/
num_äames
) << "…er frame over "

142 << 
num_äames
 << " frames.";

143 
tÙ_loglike
 +ğ
this_tÙ_loglike
;

144 
tÙ_äames
 +ğ
num_äames
;

148 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes; " << 
num_”r
 << " hadƒrrors.";

149 
KALDI_LOG
 << "Ov”®Èloglik³¸äami " << (
tÙ_loglike
 / 
tÙ_äames
)

150 << " w™h " << (
tÙ_po¡s
 / 
tÙ_äames
) << "ƒntries…er frame, "

151 << " ov” " << 
tÙ_äames
 << " frames";

152  (
num_dÚe
 != 0 ? 0 : 1);

153 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

154 
¡d
::
û¼
 << 
e
.
	`wh©
();

157 
	}
}

	@gmm-global-info.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/dŸg-gmm.h
"

23 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

30 cÚ¡ *
u§ge
 =

38 
P¬£O±iÚs
 
	`po
(
u§ge
);

40 
po
.
	`R—d
(
¬gc
, 
¬gv
);

42 ià(
po
.
	`NumArgs
() != 1) {

43 
po
.
	`PrštU§ge
();

44 
	`ex™
(1);

47 
¡d
::
¡ršg
 
mod–_rxf’ame
 = 
po
.
	`G‘Arg
(1);

49 
DŸgGmm
 
gmm
;

50 
	`R—dK®diObjeù
(
mod–_rxf’ame
, &
gmm
);

52 
¡d
::
cout
 << "numb” oàgaussŸn " << 
gmm
.
	`NumGauss
() << '\n';

53 
¡d
::
cout
 << "ã©u» dim’siÚ " << 
gmm
.
	`Dim
() << '\n';

55 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

56 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

59 
	}
}

	@gmm-global-init-from-feats.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/mod–-commÚ.h
"

24 
	~"gmm/fuÎ-gmm.h
"

25 
	~"gmm/dŸg-gmm.h
"

26 
	~"gmm/mË-fuÎ-gmm.h
"

28 
Çme¥aû
 
	gk®di
 {

32 
In™GmmFromRªdomF¿mes
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
, 
DŸgGmm
 *
gmm
) {

33 
št32
 
	gnum_gauss
 = 
gmm
->
NumGauss
(), 
	gnum_äames
 = 
ã©s
.
NumRows
(),

34 
	gdim
 = 
ã©s
.
NumCŞs
();

35 
KALDI_ASSERT
(
num_äames
 >ğ10 * 
num_gauss
 && "Too few framesorain on");

36 
	gVeùÜ
<> 
m—n
(
dim
), 
v¬
(dim);

37 
št32
 
	gi
 = 0; i < 
	gnum_äames
; i++) {

38 
	gm—n
.
AddVec
(1.0 / 
num_äames
, 
ã©s
.
Row
(
i
));

39 
	gv¬
.
AddVec2
(1.0 / 
num_äames
, 
ã©s
.
Row
(
i
));

41 
	gv¬
.
AddVec2
(-1.0, 
m—n
);

42 ià(
	gv¬
.
Max
() <= 0.0)

43 
KALDI_ERR
 << "F—tu» dØnÙ havpos™ivv¬Ÿnû " << 
v¬
;

45 
DŸgGmmNÜm®
 
gmm_nÜm®
(*
gmm
);

47 
	g¡d
::
£t
<
št32
> 
u£d_äames
;

48 
št32
 
	gg
 = 0; g < 
	gnum_gauss
; g++) {

49 
št32
 
	g¿ndom_äame
 = 
RªdIÁ
(0, 
num_äames
 - 1);

50 
	gu£d_äames
.
couÁ
(
¿ndom_äame
) != 0)

51 
¿ndom_äame
 = 
RªdIÁ
(0, 
num_äames
 - 1);

52 
	gu£d_äames
.
š£¹
(
¿ndom_äame
);

53 
	ggmm_nÜm®
.
weights_
(
g
èğ1.0 / 
num_gauss
;

54 
	ggmm_nÜm®
.
	gm—ns_
.
Row
(
g
).
CİyFromVec
(
ã©s
.Row(
¿ndom_äame
));

55 
	ggmm_nÜm®
.
	gv¬s_
.
Row
(
g
).
CİyFromVec
(
v¬
);

57 
	ggmm
->
CİyFromNÜm®
(
gmm_nÜm®
);

58 
	ggmm
->
Compu‹GcÚ¡s
();

61 
T¿šOÃI‹r
(cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

62 cÚ¡ 
MËDŸgGmmO±iÚs
 &
gmm_İts
,

63 
št32
 
™”
,

64 
št32
 
num_th»ads
,

65 
DŸgGmm
 *
gmm
) {

66 
AccumDŸgGmm
 
gmm_acc
(*
gmm
, 
kGmmAÎ
);

68 
	gVeùÜ
<
	gBa£Flßt
> 
äame_weights
(
ã©s
.
NumRows
(), 
kUndefšed
);

69 
	gäame_weights
.
S‘
(1.0);

71 
	gtÙ_like
;

72 
	gtÙ_like
 = 
gmm_acc
.
AccumuÏ‹FromDŸgMuÉiTh»aded
(*
gmm
, 
ã©s
, 
äame_weights
,

73 
num_th»ads
);

75 
	gKALDI_LOG
 << "Lik–ihood…” f¿mÚ i‹¿tiÚ " << 
	g™”


76 << " wa " << (
	gtÙ_like
 / 
	gã©s
.
NumRows
()) << " over "

77 << 
	gã©s
.
NumRows
() << " frames.";

79 
Ba£Flßt
 
	gobjf_chªge
, 
	gcouÁ
;

80 
MËDŸgGmmUpd©e
(
gmm_İts
, 
gmm_acc
, 
kGmmAÎ
, 
gmm
, &
objf_chªge
, &
couÁ
);

82 
	gKALDI_LOG
 << "Objeùive-funùiÚ chªgÚ i‹¿tiÚ " << 
	g™”
 << " was "

83 << (
	gobjf_chªge
 / 
	gcouÁ
) << " over " << count << " frames.";

88 
	$maš
(
¬gc
, *
¬gv
[]) {

89 
Œy
 {

90 
usšg
 
Çme¥aû
 
k®di
;

92 cÚ¡ *
u§ge
 =

98 
P¬£O±iÚs
 
	`po
(
u§ge
);

99 
MËDŸgGmmO±iÚs
 
gmm_İts
;

101 
boŞ
 
bš¬y
 = 
Œue
;

102 
št32
 
num_gauss
 = 100;

103 
št32
 
num_gauss_š™
 = 0;

104 
št32
 
num_™”s
 = 50;

105 
št32
 
num_äames
 = 200000;

106 
št32
 
¤ªd_£ed
 = 0;

107 
št32
 
num_th»ads
 = 4;

109 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

110 
po
.
	`Regi¡”
("num-gauss", &
num_gauss
, "Number of Gaussians inhe model");

111 
po
.
	`Regi¡”
("num-gauss-š™", &
num_gauss_š™
, "Number of Gaussians in "

114 
po
.
	`Regi¡”
("num-™”s", &
num_™”s
, "Number of iterations ofraining");

115 
po
.
	`Regi¡”
("num-äames", &
num_äames
, "Number of feature vectorso store in "

117 
po
.
	`Regi¡”
("¤ªd", &
¤ªd_£ed
, "Seed for„andom‚umber generator ");

118 
po
.
	`Regi¡”
("num-th»ads", &
num_th»ads
, "Number ofhreads used for "

121 
gmm_İts
.
	`Regi¡”
(&
po
);

123 
po
.
	`R—d
(
¬gc
, 
¬gv
);

125 
	`¤ªd
(
¤ªd_£ed
);

127 ià(
po
.
	`NumArgs
() != 2) {

128 
po
.
	`PrštU§ge
();

129 
	`ex™
(1);

132 
¡d
::
¡ršg
 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(1),

133 
mod–_wxf’ame
 = 
po
.
	`G‘Arg
(2);

135 
M©rix
<
Ba£Flßt
> 
ã©s
;

137 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

140 
	`KALDI_ASSERT
(
num_äames
 > 0);

142 
št64
 
num_»ad
 = 0, 
dim
 = 0;

144 
KALDI_LOG
 << "R—dšg f—tu» (wÈk“°" << 
num_äames
 << " frames.)";

146 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

147 cÚ¡ 
M©rix
<
Ba£Flßt
> &
this_ã©s
 = 
ã©u»_»ad”
.
	`V®ue
();

148 
št32
 
t
 = 0; < 
this_ã©s
.
	`NumRows
();++) {

149 
num_»ad
++;

150 ià(
dim
 == 0) {

151 
dim
 = 
this_ã©s
.
	`NumCŞs
();

152 
ã©s
.
	`Resize
(
num_äames
, 
dim
);

153 } ià(
this_ã©s
.
	`NumCŞs
(è!ğ
dim
) {

154 
KALDI_ERR
 << "Features have inconsistent dims "

155 << 
this_ã©s
.
	`NumCŞs
(è<< " vs. " << 
dim


156 << " (cu¼’ˆu‰ isè" << 
ã©u»_»ad”
.
	`Key
();

158 ià(
num_»ad
 <ğ
num_äames
) {

159 
ã©s
.
	`Row
(
num_»ad
 - 1).
	`CİyFromVec
(
this_ã©s
.Row(
t
));

161 
Ba£Flßt
 
k“p_´ob
 = 
num_äames
 / 
¡©ic_ÿ¡
<Ba£Flßt>(
num_»ad
);

162 ià(
	`W™hProb
(
k“p_´ob
)) {

163 
ã©s
.
	`Row
(
	`RªdIÁ
(0, 
num_äames
 - 1)).
	`CİyFromVec
(
this_ã©s
.Row(
t
));

169 ià(
num_»ad
 < 
num_äames
) {

170 
KALDI_WARN
 << "Numb” oàäame »ad " << 
num_»ad
 << " was†esshan "

171 << "rg‘‚umb” " << 
num_äames
 << ", using‡ll we„ead.";

172 
ã©s
.
	`Resize
(
num_»ad
, 
dim
, 
kCİyD©a
);

174 
Ba£Flßt
 
³rûÁ
 = 
num_äames
 * 100.0 / 
num_»ad
;

175 
KALDI_LOG
 << "K•ˆ" << 
num_äames
 << " ouˆoà" << 
num_»ad


176 << " iÅuˆäame ğ" << 
³rûÁ
 << "%.";

179 ià(
num_gauss_š™
 <ğ0 ||‚um_gauss_š™ > 
num_gauss
)

180 
num_gauss_š™
 = 
num_gauss
;

182 
DŸgGmm
 
	`gmm
(
num_gauss_š™
, 
dim
);

184 
KALDI_LOG
 << "Initializing GMM means from„andom frameso "

185 << 
num_gauss_š™
 << " Gaussians.";

186 
	`In™GmmFromRªdomF¿mes
(
ã©s
, &
gmm
);

190 
št32
 
cur_num_gauss
 = 
num_gauss_š™
,

191 
gauss_šc
 = (
num_gauss
 - 
num_gauss_š™
è/ (
num_™”s
 / 2);

193 
št32
 
™”
 = 0; i‹¸< 
num_™”s
; iter++) {

194 
	`T¿šOÃI‹r
(
ã©s
, 
gmm_İts
, 
™”
, 
num_th»ads
, &
gmm
);

196 
št32
 
Ãxt_num_gauss
 = 
¡d
::
	`mš
(
num_gauss
, 
cur_num_gauss
 + 
gauss_šc
);

197 ià(
Ãxt_num_gauss
 > 
gmm
.
	`NumGauss
()) {

198 
KALDI_LOG
 << "S¶™tšgØ" << 
Ãxt_num_gauss
 << " Gaussians.";

199 
gmm
.
	`S¶™
(
Ãxt_num_gauss
, 0.1);

200 
cur_num_gauss
 = 
Ãxt_num_gauss
;

204 
	`Wr™eK®diObjeù
(
gmm
, 
mod–_wxf’ame
, 
bš¬y
);

205 
KALDI_LOG
 << "WrÙmod–Ø" << 
mod–_wxf’ame
;

207 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

208 
¡d
::
û¼
 << 
e
.
	`wh©
();

211 
	}
}

	@gmm-global-sum-accs.cc

19 
	~"ut/commÚ-uts.h
"

20 
	~"gmm/fuÎ-gmm.h
"

21 
	~"gmm/mË-fuÎ-gmm.h
"

24 
	$maš
(
¬gc
, *
¬gv
[]) {

25 
Œy
 {

26 
k®di
::
	tšt32
 int32;

28 cÚ¡ *
u§ge
 =

33 
boŞ
 
bš¬y
 = 
Œue
;

34 
k®di
::
P¬£O±iÚs
 
	`po
(
u§ge
);

35 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

36 
po
.
	`R—d
(
¬gc
, 
¬gv
);

38 ià(
po
.
	`NumArgs
() < 2) {

39 
po
.
	`PrštU§ge
();

40 
	`ex™
(1);

43 
¡d
::
¡ršg
 
¡©s_out_f’ame
 = 
po
.
	`G‘Arg
(1);

44 
k®di
::
AccumDŸgGmm
 
gmm_accs
;

46 
i
 = 2, 
max
 = 
po
.
	`NumArgs
(); i <= max; i++) {

47 
¡d
::
¡ršg
 
¡©s_š_f’ame
 = 
po
.
	`G‘Arg
(
i
);

48 
boŞ
 
bš¬y_»ad
;

49 
k®di
::
IÅut
 
	`ki
(
¡©s_š_f’ame
, &
bš¬y_»ad
);

50 
gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
Œue
 );

55 
k®di
::
Ouut
 
	`ko
(
¡©s_out_f’ame
, 
bš¬y
);

56 
gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

59 
KALDI_LOG
 << "Wr™‹À¡© tØ" << 
¡©s_out_f’ame
;

60 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

61 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

64 
	}
}

	@gmm-global-to-fgmm.cc

20 
	~"ut/commÚ-uts.h
"

21 
	~"gmm/fuÎ-gmm.h
"

22 
	~"gmm/mË-fuÎ-gmm.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

30 cÚ¡ *
u§ge
 =

34 
boŞ
 
bš¬y
 = 
Œue
;

35 
P¬£O±iÚs
 
	`po
(
u§ge
);

36 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

37 
po
.
	`R—d
(
¬gc
, 
¬gv
);

39 ià(
po
.
	`NumArgs
() != 2) {

40 
po
.
	`PrštU§ge
();

41 
	`ex™
(1);

44 
¡d
::
¡ršg
 
gmm_rxf’ame
 = 
po
.
	`G‘Arg
(1),

45 
fgmm_wxf’ame
 = 
po
.
	`G‘Arg
(2);

47 
DŸgGmm
 
gmm
;

50 
boŞ
 
bš¬y_»ad
;

51 
IÅut
 
	`ki
(
gmm_rxf’ame
, &
bš¬y_»ad
);

52 
gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

55 
FuÎGmm
 
fgmm
;

56 
fgmm
.
	`CİyFromDŸgGmm
(
gmm
);

57 
	`Wr™eK®diObjeù
(
fgmm
, 
fgmm_wxf’ame
, 
bš¬y
);

58 
KALDI_LOG
 << "Wr™‹ÀfuÎ GMMØ" << 
fgmm_wxf’ame
;

59 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

60 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

63 
	}
}

	@gmm-gselect.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
usšg
 
¡d
::
veùÜ
;

31 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

44 
P¬£O±iÚs
 
	`po
(
u§ge
);

45 
št32
 
num_g£Ëù
 = 50;

46 
¡d
::
¡ršg
 
g£Ëù_r¥ecif›r
;

47 
¡d
::
¡ršg
 
lik–ihood_w¥ecif›r
;

48 
po
.
	`Regi¡”
("n", &
num_g£Ëù
, "Number of Gaussianso keep…er frame\n");

49 
po
.
	`Regi¡”
("wr™e-likes", &
lik–ihood_w¥ecif›r
, "rspecifier for†ikelihoods…er "

51 
po
.
	`Regi¡”
("g£Ëù", &
g£Ëù_r¥ecif›r
, "rspecifier for gselect objects "

53 
po
.
	`R—d
(
¬gc
, 
¬gv
);

55 ià(
po
.
	`NumArgs
() != 3) {

56 
po
.
	`PrštU§ge
();

57 
	`ex™
(1);

60 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

61 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

62 
g£Ëù_w¥ecif›r
 = 
po
.
	`G‘Arg
(3);

64 
DŸgGmm
 
gmm
;

65 
	`R—dK®diObjeù
(
mod–_f’ame
, &
gmm
);

66 
	`KALDI_ASSERT
(
num_g£Ëù
 > 0);

67 
št32
 
num_gauss
 = 
gmm
.
	`NumGauss
();

68 ià(
num_g£Ëù
 > 
num_gauss
) {

69 
KALDI_WARN
 << "You‡sked fÜ " << 
num_g£Ëù
 << " Gaussians but GMM "

70 << "Úly ha " << 
num_gauss
 << ",„eturninghis many. "

72 
num_g£Ëù
 = 
num_gauss
;

75 
tÙ_like
 = 0.0;

76 
k®di
::
št64
 
tÙ_t
 = 0;

78 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

79 
IÁ32VeùÜVeùÜWr™”
 
	`g£Ëù_wr™”
(
g£Ëù_w¥ecif›r
);

80 
RªdomAcûssIÁ32VeùÜVeùÜR—d”
 
	`g£Ëù_»ad”
(
g£Ëù_r¥ecif›r
);

81 
Ba£FlßtWr™”
 
	`lik–ihood_wr™”
(
lik–ihood_w¥ecif›r
);

83 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

84 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

85 
št32
 
tÙ_t_this_fe
 = 0; 
tÙ_like_this_fe
 = 0;

86 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

87 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

88 
veùÜ
<veùÜ<
št32
> > 
	`g£Ëù
(
m©
.
	`NumRows
());

89 
tÙ_t_this_fe
 +ğ
m©
.
	`NumRows
();

90 if(
g£Ëù_r¥ecif›r
 != "") {

91 ià(!
g£Ëù_»ad”
.
	`HasKey
(
u‰
)) {

92 
KALDI_WARN
 << "NØg£Ëù infÜm©iÚ fÜ u‰”ªû " << 
u‰
;

93 
num_”r
++;

96 cÚ¡ 
veùÜ
<veùÜ<
št32
> > &
´e£Ëù
 = 
g£Ëù_»ad”
.
	`V®ue
(
u‰
);

97 ià(
´e£Ëù
.
	`size
(è!ğ
¡©ic_ÿ¡
<
size_t
>(
m©
.
	`NumRows
())) {

98 
KALDI_WARN
 << "IÅuˆg£Ëù fÜ u‰”ªû " << 
u‰
 << " has wrong size "

99 << 
´e£Ëù
.
	`size
(è<< " vs. " << 
m©
.
	`NumRows
();

100 
num_”r
++;

103 
št32
 
i
 = 0; i < 
m©
.
	`NumRows
(); i++)

104 
tÙ_like_this_fe
 +=

105 
gmm
.
	`GaussŸnS–eùiÚP»£Ëù
(
m©
.
	`Row
(
i
), 
´e£Ëù
[i],

106 
num_g£Ëù
, &(
g£Ëù
[
i
]));

108 
tÙ_like_this_fe
 =

109 
gmm
.
	`GaussŸnS–eùiÚ
(
m©
, 
num_g£Ëù
, &
g£Ëù
);

112 
g£Ëù_wr™”
.
	`Wr™e
(
u‰
, 
g£Ëù
);

113 ià(
num_dÚe
 % 10 == 0)

114 
KALDI_LOG
 << "FÜ " << 
num_dÚe
 << "'th file,‡verage UBM†ikelihood over "

115 << 
tÙ_t_this_fe
 << " frames is "

116 << (
tÙ_like_this_fe
/
tÙ_t_this_fe
);

117 
tÙ_t
 +ğ
tÙ_t_this_fe
;

118 
tÙ_like
 +ğ
tÙ_like_this_fe
;

120 if(
lik–ihood_w¥ecif›r
 != "")

121 
lik–ihood_wr™”
.
	`Wr™e
(
u‰
, 
tÙ_like_this_fe
);

122 
num_dÚe
++;

125 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_”r


127 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

129 ià(
num_dÚe
 != 0)  0;

131 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

132 
¡d
::
û¼
 << 
e
.
	`wh©
();

135 
	}
}

	@gmm-info.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
usšg
 
Çme¥aû
 
k®di
;

28 
k®di
::
	tšt32
 int32;

30 cÚ¡ *
u§ge
 =

37 
P¬£O±iÚs
 
	`po
(
u§ge
);

39 
po
.
	`R—d
(
¬gc
, 
¬gv
);

41 ià(
po
.
	`NumArgs
() != 1) {

42 
po
.
	`PrštU§ge
();

43 
	`ex™
(1);

46 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1);

48 
AmDŸgGmm
 
am_gmm
;

49 
T¿ns™iÚMod–
 
Œªs_mod–
;

51 
boŞ
 
bš¬y_»ad
;

52 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

53 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

54 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

57 
¡d
::
cout
 << "numb” oàphÚe " << 
Œªs_mod–
.
	`G‘PhÚes
().
	`size
() << '\n';

58 
¡d
::
cout
 << "numb” oàpdf " << 
Œªs_mod–
.
	`NumPdfs
() << '\n';

59 
¡d
::
cout
 << "numb” oàŒªs™iÚ-id " << 
Œªs_mod–
.
	`NumT¿ns™iÚIds
()

61 
¡d
::
cout
 << "number ofransition-states "

62 << 
Œªs_mod–
.
	`NumT¿ns™iÚS‹s
() << '\n';

63 
¡d
::
cout
 << "ã©u» dim’siÚ " << 
am_gmm
.
	`Dim
() << '\n';

64 
¡d
::
cout
 << "numb” oàgaussŸn " << 
am_gmm
.
	`NumGauss
() << '\n';

66 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

67 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

70 
	}
}

	@gmm-init-lvtln.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"ŒªsfÜm/lvn.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
usšg
 
k®di
::
št32
;

32 cÚ¡ *
u§ge
 =

38 
boŞ
 
bš¬y
 = 
Œue
;

39 
št32
 
dim
 = 13;

40 
št32
 
deçuÉ_şass
 = 10;

41 
št32
 
num_şas£s
 = 21;

43 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

45 
po
.
	`Regi¡”
("dim", &
dim
, "feature dimension");

46 
po
.
	`Regi¡”
("num-şas£s", &
num_şas£s
, "Number ofransformso berained");

47 
po
.
	`Regi¡”
("deçuÉ-şass", &
deçuÉ_şass
, "Index of defaultransform, "

50 
po
.
	`R—d
(
¬gc
, 
¬gv
);

52 ià(
po
.
	`NumArgs
() != 1) {

53 
po
.
	`PrštU§ge
();

54 
	`ex™
(1);

57 
¡d
::
¡ršg
 
lvn_wxf’ame
 = 
po
.
	`G‘Arg
(1);

60 
Lš—rVn
 
	`lvn
(
dim
, 
num_şas£s
, 
deçuÉ_şass
);

61 
	`Wr™eK®diObjeù
(
lvn
, 
lvn_wxf’ame
, 
bš¬y
);

63 
KALDI_LOG
 << "Initialized LVTLN object‡nd wrote ito "

64 << 
	`PršbËWxf’ame
(
lvn_wxf’ame
);

66 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

67 
¡d
::
û¼
 << 
e
.
	`wh©
();

70 
	}
}

	@gmm-init-model-flat.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/mË-am-dŸg-gmm.h
"

26 
	~"Œ“/bud-Œ“-uts.h
"

27 
	~"Œ“/cÚ‹xt-d•.h
"

28 
	~"Œ“/şu¡”abË-şas£s.h
"

29 
	~"ut/‹xt-uts.h
"

31 
Çme¥aû
 
	gk®di
 {

33 
G‘F—tu»M—nAndV¬Ÿnû
(cÚ¡ 
¡d
::
¡ršg
 &
ã©_r¥ecif›r
,

34 
VeùÜ
<
Ba£Flßt
> *
šv_v¬_out
,

35 
VeùÜ
<
Ba£Flßt
> *
m—n_out
) {

36 
	gcouÁ
 = 0.0;

37 
	gVeùÜ
<> 
	gx_¡©s
, 
	gx2_¡©s
;

39 
Sequ’tŸlDoubËM©rixR—d”
 
ã©_»ad”
(
ã©_r¥ecif›r
);

40 ; !
	gã©_»ad”
.
DÚe
(); f—t_»ad”.
Next
()) {

41 cÚ¡ 
	gM©rix
<> &
	gm©
 = 
ã©_»ad”
.
V®ue
();

42 ià(
	gx_¡©s
.
Dim
() == 0) {

43 
št32
 
dim
 = 
m©
.
NumCŞs
();

44 
	gx_¡©s
.
Resize
(
dim
);

45 
	gx2_¡©s
.
Resize
(
dim
);

47 
št32
 
	gi
 = 0; i < 
	gm©
.
NumRows
(); i++) {

48 
	gcouÁ
 += 1.0;

49 
	gx_¡©s
.
AddVec
(1.0, 
m©
.
Row
(
i
));

50 
	gx2_¡©s
.
AddVec2
(1.0, 
m©
.
Row
(
i
));

53 ià(
	gcouÁ
 =ğ0è{ 
KALDI_ERR
 << "No features were„ead!"; }

54 
	gx_¡©s
.
SÿË
(1.0/
couÁ
);

55 
	gx2_¡©s
.
SÿË
(1.0/
couÁ
);

56 
	gx2_¡©s
.
AddVec2
(-1.0, 
x_¡©s
);

57 ià(
	gx2_¡©s
.
Mš
() <= 0.0)

58 
KALDI_ERR
 << "Variance is zero or‚egative!";

59 
	gx2_¡©s
.
Inv”tEËm’ts
();

60 
št32
 
	gdim
 = 
x_¡©s
.
Dim
();

61 
	gšv_v¬_out
->
Resize
(
dim
);

62 
	gm—n_out
->
Resize
(
dim
);

63 
	gšv_v¬_out
->
CİyFromVec
(
x2_¡©s
);

64 
	gm—n_out
->
CİyFromVec
(
x_¡©s
);

70 
	$maš
(
¬gc
, *
¬gv
[]) {

71 
usšg
 
Çme¥aû
 
k®di
;

72 
Œy
 {

73 
usšg
 
Çme¥aû
 
k®di
;

74 
k®di
::
	tšt32
 int32;

76 cÚ¡ *
u§ge
 =

84 
boŞ
 
bš¬y
 = 
Œue
;

85 
št32
 
dim
 = 40;

87 
P¬£O±iÚs
 
	`po
(
u§ge
);

88 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

89 
po
.
	`Regi¡”
("dim", &
dim
, "Dimension of model (this matters only if‚ot…roviding features).");

91 
po
.
	`R—d
(
¬gc
, 
¬gv
);

93 ià(
po
.
	`NumArgs
() < 3 ||…o.NumArgs() > 4) {

94 
po
.
	`PrštU§ge
();

95 
	`ex™
(1);

98 
¡d
::
¡ršg


99 
Œ“_f’ame
 = 
po
.
	`G‘Arg
(1),

100 
tİo_f’ame
 = 
po
.
	`G‘Arg
(2),

101 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(3),

102 
ã©s_r¥ecif›r
 = 
po
.
	`G‘O±Arg
(4);

104 
CÚ‹xtD•’d’cy
 
ùx_d•
;

105 
	`R—dK®diObjeù
(
Œ“_f’ame
, &
ùx_d•
);

107 
HmmTİŞogy
 
tİo
;

108 
	`R—dK®diObjeù
(
tİo_f’ame
, &
tİo
);

110 
VeùÜ
<
Ba£Flßt
> 
glob®_šv”£_v¬
, 
glob®_m—n
;

111 ià(
po
.
	`NumArgs
() == 4) {

112 
	`G‘F—tu»M—nAndV¬Ÿnû
(
ã©s_r¥ecif›r
,

113 &
glob®_šv”£_v¬
,

114 &
glob®_m—n
);

115 
dim
 = 
glob®_m—n
.
	`Dim
();

117 
glob®_šv”£_v¬
.
	`Resize
(
dim
);

118 
glob®_šv”£_v¬
.
	`S‘
(1.0);

119 
glob®_m—n
.
	`Resize
(
dim
);

122 
št32
 
num_pdfs
 = 
ùx_d•
.
	`NumPdfs
();

124 
AmDŸgGmm
 
am_gmm
;

125 
DŸgGmm
 
gmm
;

126 
gmm
.
	`Resize
(1, 
dim
);

128 
M©rix
<
Ba£Flßt
> 
	`šv_v¬
(1, 
dim
);

129 
šv_v¬
.
	`Row
(0).
	`CİyFromVec
(
glob®_šv”£_v¬
);

130 
M©rix
<
Ba£Flßt
> 
	`mu
(1, 
dim
);

131 
mu
.
	`Row
(0).
	`CİyFromVec
(
glob®_m—n
);

132 
VeùÜ
<
Ba£Flßt
> 
	`weights
(1);

133 
weights
.
	`S‘
(1.0);

134 
gmm
.
	`S‘InvV¬sAndM—ns
(
šv_v¬
, 
mu
);

135 
gmm
.
	`S‘Weights
(
weights
);

136 
gmm
.
	`Compu‹GcÚ¡s
();

138 
i
 = 0; i < 
num_pdfs
; i++)

139 
am_gmm
.
	`AddPdf
(
gmm
);

141 
T¿ns™iÚMod–
 
	`Œªs_mod–
(
ùx_d•
, 
tİo
);

144 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y
);

145 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

146 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

148 
KALDI_LOG
 << "Wrote model.";

149 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

150 
¡d
::
û¼
 << 
e
.
	`wh©
();

153 
	}
}

	@gmm-init-model.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"gmm/mË-am-dŸg-gmm.h
"

27 
	~"Œ“/bud-Œ“-uts.h
"

28 
	~"Œ“/cÚ‹xt-d•.h
"

29 
	~"Œ“/şu¡”abË-şas£s.h
"

30 
	~"ut/‹xt-uts.h
"

32 
Çme¥aû
 
	gk®di
 {

35 
In™AmGmm
(cÚ¡ 
BudT»eStsTy³
 &
¡©s
,

36 cÚ¡ 
Ev’tM­
 &
to_pdf_m­
,

37 
AmDŸgGmm
 *
am_gmm
,

38 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

39 
Ba£Flßt
 
v¬_æoÜ
) {

41 
	g¡d
::
veùÜ
<
BudT»eStsTy³
> 
¥l™_¡©s
;

42 
S¶™StsByM­
(
¡©s
, 
to_pdf_m­
, &
¥l™_¡©s
);

44 
	g¥l™_¡©s
.
»size
(
to_pdf_m­
.
MaxResuÉ
() + 1);

48 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡©s
.
size
(); i++) {

49 ià(
	g¥l™_¡©s
[
i
].
em±y
()) {

50 
	g¡d
::
veùÜ
<
št32
> 
bad_pdfs
(1, 
i
), 
	gbad_phÚes
;

51 
G‘PhÚesFÜPdfs
(
Œªs_mod–
, 
bad_pdfs
, &
bad_phÚes
);

52 
	g¡d
::
o¡ršg¡»am
 
ss
;

53 
št32
 
	gidx
 = 0; idx < 
	gbad_phÚes
.
size
(); idx ++)

54 
	gss
 << 
	gbad_phÚes
[
idx
] << ' ';

55 
	gKALDI_WARN
 << "T»ha pdf-id " << 
	gi


56 << " w™h‚Ø¡©s; cÜ»¥Údšg…hÚli¡: " << 
	gss
.
¡r
();

67 
	g¡d
::
veùÜ
<
Clu¡”abË
*> 
summed_¡©s
;

68 
SumStsVec
(
¥l™_¡©s
, &
summed_¡©s
);

69 
Clu¡”abË
 *
	gavg_¡©s
 = 
SumClu¡”abË
(
summed_¡©s
);

70 
KALDI_ASSERT
(
avg_¡©s
 !ğ
NULL
 && "No stats‡vailable in gmm-init-model.");

71 
size_t
 
	gi
 = 0; i < 
	gsummed_¡©s
.
size
(); i++) {

72 
GaussClu¡”abË
 *
	gc
 =

73 
¡©ic_ÿ¡
<
GaussClu¡”abË
*>(
summed_¡©s
[
i
] !ğ
NULL
 ? summed_¡©s[i] : 
avg_¡©s
);

74 
DŸgGmm
 
gmm
(*
c
, 
v¬_æoÜ
);

75 
	gam_gmm
->
AddPdf
(
gmm
);

76 
Ba£Flßt
 
	gcouÁ
 = 
c
->
couÁ
();

77 ià(
	gcouÁ
 < 100) {

78 
	g¡d
::
veùÜ
<
št32
> 
bad_pdfs
(1, 
i
), 
	gbad_phÚes
;

79 
G‘PhÚesFÜPdfs
(
Œªs_mod–
, 
bad_pdfs
, &
bad_phÚes
);

80 
	g¡d
::
o¡ršg¡»am
 
ss
;

81 
št32
 
	gidx
 = 0; idx < 
	gbad_phÚes
.
size
(); idx ++)

82 
	gss
 << 
	gbad_phÚes
[
idx
] << ' ';

83 
	gKALDI_WARN
 << "V”y sm®ÈcouÁ fÜ s‹ " << 
	gi
 << ": "

84 << 
	gcouÁ
 << "; cÜ»¥Údšg…hÚli¡: " << 
	gss
.
¡r
();

87 
D–‘ePoš‹rs
(&
summed_¡©s
);

88 
d–‘e
 
	gavg_¡©s
;

92 
G‘Occs
(cÚ¡ 
BudT»eStsTy³
 &
¡©s
,

93 cÚ¡ 
Ev’tM­
 &
to_pdf_m­
,

94 
VeùÜ
<
Ba£Flßt
> *
occs
) {

97 
	g¡d
::
veùÜ
<
BudT»eStsTy³
> 
¥l™_¡©s
;

98 
S¶™StsByM­
(
¡©s
, 
to_pdf_m­
, &
¥l™_¡©s
);

99 ià(
	g¥l™_¡©s
.
size
(è!ğ
to_pdf_m­
.
MaxResuÉ
()+1) {

100 
KALDI_ASSERT
(
¥l™_¡©s
.
size
(è< 
to_pdf_m­
.
MaxResuÉ
()+1);

101 
	g¥l™_¡©s
.
»size
(
to_pdf_m­
.
MaxResuÉ
()+1);

103 
	goccs
->
Resize
(
¥l™_¡©s
.
size
());

104 
št32
 
	gpdf
 = 0;…dà< 
	goccs
->
Dim
();…df++)

105 (*
	goccs
)(
	gpdf
èğ
SumNÜm®iz”
(
¥l™_¡©s
[
pdf
]);

116 
In™AmGmmFromOld
(cÚ¡ 
BudT»eStsTy³
 &
¡©s
,

117 cÚ¡ 
Ev’tM­
 &
to_pdf_m­
,

118 
št32
 
N
,

119 
št32
 
P
,

120 cÚ¡ 
¡d
::
¡ršg
 &
Şd_Œ“_rxf’ame
,

121 cÚ¡ 
¡d
::
¡ršg
 &
Şd_mod–_rxf’ame
,

122 
Ba£Flßt
 
v¬_æoÜ
,

123 
AmDŸgGmm
 *
am_gmm
) {

125 
AmDŸgGmm
 
	gŞd_am_gmm
;

126 
CÚ‹xtD•’d’cy
 
	gŞd_Œ“
;

128 
boŞ
 
	gbš¬y_š
;

129 
T¿ns™iÚMod–
 
	gŞd_Œªs_mod–
;

130 
IÅut
 
ki
(
Şd_mod–_rxf’ame
, &
bš¬y_š
);

131 
	gŞd_Œªs_mod–
.
R—d
(
ki
.
SŒ—m
(), 
bš¬y_š
);

132 
	gŞd_am_gmm
.
R—d
(
ki
.
SŒ—m
(), 
bš¬y_š
);

135 
boŞ
 
	gbš¬y_š
;

136 
IÅut
 
ki
(
Şd_Œ“_rxf’ame
, &
bš¬y_š
);

137 
	gŞd_Œ“
.
R—d
(
ki
.
SŒ—m
(), 
bš¬y_š
);

142 
	g¡d
::
veùÜ
<
BudT»eStsTy³
> 
¥l™_¡©s
;

143 
S¶™StsByM­
(
¡©s
, 
to_pdf_m­
, &
¥l™_¡©s
);

145 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡©s
.
size
(); i++) {

146 ià(
	g¥l™_¡©s
[
i
].
em±y
()) {

147 
	gKALDI_WARN
 << "L—à" << 
	gi
 << " of‚ewree has‚o stats.";

150 ià(
	g¡©ic_ÿ¡
<
	gšt32
>(
	g¥l™_¡©s
.
size
()è!ğ
to_pdf_m­
.
MaxResuÉ
() + 1) {

151 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
št32
>(
¥l™_¡©s
.
size
()) <

152 
to_pdf_m­
.
MaxResuÉ
() + 1);

153 
	gKALDI_WARN
 << "Tree may have final†eaf with‚o stats.";

154 
	g¥l™_¡©s
.
»size
(
to_pdf_m­
.
MaxResuÉ
() + 1);

158 
št32
 
	gŞdN
 = 
Şd_Œ“
.
CÚ‹xtWidth
(), 
	gŞdP
 = old_Œ“.
C’Œ®Pos™iÚ
();

161 
Clu¡”abË
 *
	gavg_¡©s
 = 
SumSts
(
¡©s
);

162 
GaussClu¡”abË
 *
	gavg_¡©s_gc
 = 
dyÇmic_ÿ¡
<GaussClu¡”abË*>(
avg_¡©s
);

163 
KALDI_ASSERT
(
avg_¡©s_gc
 !ğ
NULL
 && "Empty stats input.");

164 
DŸgGmm
 
avg_gmm
(*
avg_¡©s_gc
, 
v¬_æoÜ
);

165 
d–‘e
 
	gavg_¡©s
;

166 
	gavg_¡©s
 = 
NULL
;

167 
	gavg_¡©s_gc
 = 
NULL
;

169 cÚ¡ 
	gEv’tM­
 &
	gŞd_m­
 = 
Şd_Œ“
.
ToPdfM­
();

171 
KALDI_ASSERT
(
am_gmm
->
NumPdfs
() == 0);

172 
št32
 
	gnum_pdfs
 = 
¡©ic_ÿ¡
<št32>(
¥l™_¡©s
.
size
());

173 
št32
 
	gpdf
 = 0;…dà< 
	gnum_pdfs
;…df++) {

174 
	gBudT»eStsTy³
 &
	gmy_¡©s
 = 
¥l™_¡©s
[
pdf
];

179 
boŞ
 
	g»t
 = 
CÚv”tSts
(
N
, 
P
, 
ŞdN
, 
ŞdP
, &
my_¡©s
);

180 ià(!
	g»t
)

181 
	gKALDI_ERR
 << "InitAmGmmFromOld: old system has wider context "

186 
	g¡d
::
m­
<
št32
, 
	gBa£Flßt
> 
	gŞdpdf_to_couÁ
;

187 
size_t
 
	gi
 = 0; i < 
	gmy_¡©s
.
size
(); i++) {

188 
Ev’tTy³
 
	gevec
 = 
my_¡©s
[
i
].
fœ¡
;

189 
Ev’tAnsw”Ty³
 
	gªs
;

190 
boŞ
 
	g»t
 = 
Şd_m­
.
M­
(
evec
, &
ªs
);

191 ià(!
	g»t
è{ 
	gKALDI_ERR
 << "Could‚ot map context using oldree."; }

192 
KALDI_ASSERT
(
my_¡©s
[
i
].
£cÚd
 !ğ
NULL
);

193 
Ba£Flßt
 
	g¡©s_couÁ
 = 
my_¡©s
[
i
].
£cÚd
->
NÜm®iz”
();

194 ià(
	gŞdpdf_to_couÁ
.
couÁ
(
ªs
è=ğ0è
Şdpdf_to_couÁ
[ªs] = 
¡©s_couÁ
;

195 
	gŞdpdf_to_couÁ
[
ªs
] +ğ
¡©s_couÁ
;

197 
Ba£Flßt
 
	gmax_couÁ
 = 0; 
št32
 
	gmax_Şd_pdf
 = -1;

198 
	g¡d
::
m­
<
št32
, 
	gBa£Flßt
>::
cÚ¡_™”©Ü
 
™”
 = 
Şdpdf_to_couÁ
.
begš
();

199 
	g™”
 !ğ
Şdpdf_to_couÁ
.
’d
();

200 ++
	g™”
) {

201 ià(
	g™”
->
	g£cÚd
 > 
	gmax_couÁ
) {

202 
	gmax_couÁ
 = 
™”
->
£cÚd
;

203 
	gmax_Şd_pdf
 = 
™”
->
fœ¡
;

206 ià(
	gmax_couÁ
 == 0) {

207 
KALDI_WARN
 << "L—à" << 
pdf
 << " of‚ewree being initialized with "

209 
	gam_gmm
->
AddPdf
(
avg_gmm
);

211 
	gam_gmm
->
AddPdf
(
Şd_am_gmm
.
G‘Pdf
(
max_Şd_pdf
));

220 
	$maš
(
¬gc
, *
¬gv
[]) {

221 
usšg
 
Çme¥aû
 
k®di
;

222 
Œy
 {

223 
usšg
 
Çme¥aû
 
k®di
;

224 
k®di
::
	tšt32
 int32;

226 cÚ¡ *
u§ge
 =

234 
boŞ
 
bš¬y
 = 
Œue
;

235 
v¬_æoÜ
 = 0.01;

236 
¡d
::
¡ršg
 
occs_out_f’ame
;

239 
P¬£O±iÚs
 
	`po
(
u§ge
);

240 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

241 
po
.
	`Regi¡”
("wr™e-occs", &
occs_out_f’ame
, "Fileo write state "

243 
po
.
	`Regi¡”
("v¬-æoÜ", &
v¬_æoÜ
, "Variance floor used while "

246 
po
.
	`R—d
(
¬gc
, 
¬gv
);

248 ià(
po
.
	`NumArgs
() != 4 &&…o.NumArgs() != 6) {

249 
po
.
	`PrštU§ge
();

250 
	`ex™
(1);

253 
¡d
::
¡ršg


254 
Œ“_f’ame
 = 
po
.
	`G‘Arg
(1),

255 
¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

256 
tİo_f’ame
 = 
po
.
	`G‘Arg
(3),

257 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(4),

258 
Şd_Œ“_f’ame
 = 
po
.
	`G‘O±Arg
(5),

259 
Şd_mod–_f’ame
 = 
po
.
	`G‘O±Arg
(6);

261 
CÚ‹xtD•’d’cy
 
ùx_d•
;

262 
	`R—dK®diObjeù
(
Œ“_f’ame
, &
ùx_d•
);

264 
BudT»eStsTy³
 
¡©s
;

266 
boŞ
 
bš¬y_š
;

267 
GaussClu¡”abË
 
gc
;

268 
IÅut
 
	`ki
(
¡©s_f’ame
, &
bš¬y_š
);

269 
	`R—dBudT»eSts
(
ki
.
	`SŒ—m
(), 
bš¬y_š
, 
gc
, &
¡©s
);

271 
KALDI_LOG
 << "Numb” oà£·¿‹ sti¡ic i " << 
¡©s
.
	`size
();

273 
HmmTİŞogy
 
tİo
;

274 
	`R—dK®diObjeù
(
tİo_f’ame
, &
tİo
);

276 cÚ¡ 
Ev’tM­
 &
to_pdf
 = 
ùx_d•
.
	`ToPdfM­
();

278 
T¿ns™iÚMod–
 
	`Œªs_mod–
(
ùx_d•
, 
tİo
);

281 
AmDŸgGmm
 
am_gmm
;

282 ià(
Şd_Œ“_f’ame
.
	`em±y
())

283 
	`In™AmGmm
(
¡©s
, 
to_pdf
, &
am_gmm
, 
Œªs_mod–
, 
v¬_æoÜ
);

285 
	`In™AmGmmFromOld
(
¡©s
, 
to_pdf
,

286 
ùx_d•
.
	`CÚ‹xtWidth
(),

287 
ùx_d•
.
	`C’Œ®Pos™iÚ
(),

288 
Şd_Œ“_f’ame
,

289 
Şd_mod–_f’ame
,

290 
v¬_æoÜ
,

291 &
am_gmm
);

294 ià(!
occs_out_f’ame
.
	`em±y
()) {

295 
VeùÜ
<
Ba£Flßt
> 
occs
;

296 
	`G‘Occs
(
¡©s
, 
to_pdf
, &
occs
);

297 
Ouut
 
	`ko
(
occs_out_f’ame
, 
bš¬y
);

298 
occs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

302 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y
);

303 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

304 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

306 
KALDI_LOG
 << "Wrote model.";

308 
	`D–‘eBudT»eSts
(&
¡©s
);

309 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

310 
¡d
::
û¼
 << 
e
.
	`wh©
();

313 
	}
}

	@gmm-init-mono.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"hmm/hmm-tİŞogy.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
Çme¥aû
 
	gk®di
 {

33 
R—dSh¬edPhÚesLi¡
(
¡d
::
¡ršg
 
rxf’ame
, std::
veùÜ
<¡d::veùÜ<
št32
> > *
li¡_out
) {

34 
li¡_out
->
ş—r
();

35 
IÅut
 
šput
(
rxf’ame
);

36 
	g¡d
::
i¡»am
 &
is
 = 
šput
.
SŒ—m
();

37 
	g¡d
::
¡ršg
 
lše
;

38 
	g¡d
::
g‘lše
(
is
, 
lše
)) {

39 
	gli¡_out
->
push_back
(
¡d
::
veùÜ
<
št32
>());

40 ià(!
S¶™SŒšgToIÁeg”s
(
lše
, " \t\r", 
Œue
, &(
li¡_out
->
back
())))

41 
	gKALDI_ERR
 << "Bad†šš sh¬ed…hÚe li¡: " << 
	glše
 << " (reading "

42 << 
PršbËRxf’ame
(
rxf’ame
) << ")";

43 
	g¡d
::
sÜt
(
li¡_out
->
rbegš
()->
begš
(),†i¡_out->rbegš()->
’d
());

44 ià(!
IsSÜ‹dAndUniq
(*(
li¡_out
->
rbegš
())))

45 
	gKALDI_ERR
 << "Bad†šš sh¬ed…hÚe li¡ (»³©ed…hÚe): " << 
	glše


46 << " (»adšg " << 
PršbËRxf’ame
(
rxf’ame
) << ")";

52 
	$maš
(
¬gc
, *
¬gv
[]) {

53 
Œy
 {

54 
usšg
 
Çme¥aû
 
k®di
;

55 
usšg
 
k®di
::
št32
;

57 cÚ¡ *
u§ge
 =

63 
boŞ
 
bš¬y
 = 
Œue
;

64 
¡d
::
¡ršg
 
Œaš_ã©s
;

65 
¡d
::
¡ršg
 
sh¬ed_phÚes_rxf’ame
;

66 
Ba£Flßt
 
³¹urb_çùÜ
 = 0.0;

67 
P¬£O±iÚs
 
	`po
(
u§ge
);

68 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

69 
po
.
	`Regi¡”
("Œaš-ã©s", &
Œaš_ã©s
,

71 
po
.
	`Regi¡”
("sh¬ed-phÚes", &
sh¬ed_phÚes_rxf’ame
,

73 
po
.
	`Regi¡”
("³¹urb-çùÜ", &
³¹urb_çùÜ
,

75 
po
.
	`R—d
(
¬gc
, 
¬gv
);

77 ià(
po
.
	`NumArgs
() != 4) {

78 
po
.
	`PrštU§ge
();

79 
	`ex™
(1);

83 
¡d
::
¡ršg
 
tİo_f’ame
 = 
po
.
	`G‘Arg
(1);

84 
dim
 = 
	`©oi
(
po
.
	`G‘Arg
(2).
	`c_¡r
());

85 
	`KALDI_ASSERT
(
dim
> 0 && dim < 10000);

86 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(3);

87 
¡d
::
¡ršg
 
Œ“_f’ame
 = 
po
.
	`G‘Arg
(4);

89 
VeùÜ
<
Ba£Flßt
> 
	`glob_šv_v¬
(
dim
);

90 
glob_šv_v¬
.
	`S‘
(1.0);

91 
VeùÜ
<
Ba£Flßt
> 
	`glob_m—n
(
dim
);

92 
glob_m—n
.
	`S‘
(1.0);

94 ià(
Œaš_ã©s
 != "") {

95 
couÁ
 = 0.0;

96 
VeùÜ
<> 
	`v¬_¡©s
(
dim
);

97 
VeùÜ
<> 
	`m—n_¡©s
(
dim
);

98 
Sequ’tŸlDoubËM©rixR—d”
 
	`ã©_»ad”
(
Œaš_ã©s
);

99 ; !
ã©_»ad”
.
	`DÚe
(); f—t_»ad”.
	`Next
()) {

100 cÚ¡ 
M©rix
<> &
m©
 = 
ã©_»ad”
.
	`V®ue
();

101 
št32
 
i
 = 0; i < 
m©
.
	`NumRows
(); i++) {

102 
couÁ
 += 1.0;

103 
v¬_¡©s
.
	`AddVec2
(1.0, 
m©
.
	`Row
(
i
));

104 
m—n_¡©s
.
	`AddVec
(1.0, 
m©
.
	`Row
(
i
));

107 ià(
couÁ
 =ğ0è{ 
KALDI_ERR
 << "no features were seen."; }

108 
v¬_¡©s
.
	`SÿË
(1.0/
couÁ
);

109 
m—n_¡©s
.
	`SÿË
(1.0/
couÁ
);

110 
v¬_¡©s
.
	`AddVec2
(-1.0, 
m—n_¡©s
);

111 ià(
v¬_¡©s
.
	`Mš
() <= 0.0)

112 
KALDI_ERR
 << "bad variance";

113 
v¬_¡©s
.
	`Inv”tEËm’ts
();

114 
glob_šv_v¬
.
	`CİyFromVec
(
v¬_¡©s
);

115 
glob_m—n
.
	`CİyFromVec
(
m—n_¡©s
);

118 
HmmTİŞogy
 
tİo
;

119 
boŞ
 
bš¬y_š
;

120 
IÅut
 
	`ki
(
tİo_f’ame
, &
bš¬y_š
);

121 
tİo
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_š
);

123 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
phÚes
 = 
tİo
.
	`G‘PhÚes
();

125 
¡d
::
veùÜ
<
št32
> 
	`phÚe2num_pdf_şas£s
 (1+
phÚes
.
	`back
());

126 
size_t
 
i
 = 0; i < 
phÚes
.
	`size
(); i++)

127 
phÚe2num_pdf_şas£s
[
phÚes
[
i
]] = 
tİo
.
	`NumPdfCÏs£s
(phones[i]);

130 
CÚ‹xtD•’d’cy
 *
ùx_d•
 = 
NULL
;

131 ià(
sh¬ed_phÚes_rxf’ame
 == "") {

132 
ùx_d•
 = 
	`MÚİhÚeCÚ‹xtD•’d’cy
(
phÚes
, 
phÚe2num_pdf_şas£s
);

134 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > 
sh¬ed_phÚes
;

135 
	`R—dSh¬edPhÚesLi¡
(
sh¬ed_phÚes_rxf’ame
, &
sh¬ed_phÚes
);

137 
ùx_d•
 = 
	`MÚİhÚeCÚ‹xtD•’d’cySh¬ed
(
sh¬ed_phÚes
, 
phÚe2num_pdf_şas£s
);

140 
št32
 
num_pdfs
 = 
ùx_d•
->
	`NumPdfs
();

142 
AmDŸgGmm
 
am_gmm
;

143 
DŸgGmm
 
gmm
;

144 
gmm
.
	`Resize
(1, 
dim
);

146 
M©rix
<
Ba£Flßt
> 
	`šv_v¬
(1, 
dim
);

147 
šv_v¬
.
	`Row
(0).
	`CİyFromVec
(
glob_šv_v¬
);

148 
M©rix
<
Ba£Flßt
> 
	`mu
(1, 
dim
);

149 
mu
.
	`Row
(0).
	`CİyFromVec
(
glob_m—n
);

150 
VeùÜ
<
Ba£Flßt
> 
	`weights
(1);

151 
weights
.
	`S‘
(1.0);

152 
gmm
.
	`S‘InvV¬sAndM—ns
(
šv_v¬
, 
mu
);

153 
gmm
.
	`S‘Weights
(
weights
);

154 
gmm
.
	`Compu‹GcÚ¡s
();

157 
i
 = 0; i < 
num_pdfs
; i++)

158 
am_gmm
.
	`AddPdf
(
gmm
);

160 ià(
³¹urb_çùÜ
 != 0.0) {

161 
i
 = 0; i < 
num_pdfs
; i++)

162 
am_gmm
.
	`G‘Pdf
(
i
).
	`P”turb
(
³¹urb_çùÜ
);

166 
T¿ns™iÚMod–
 
	`Œªs_mod–
(*
ùx_d•
, 
tİo
);

169 
Ouut
 
	`ko
(
mod–_f’ame
, 
bš¬y
);

170 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

171 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

175 
ùx_d•
->
	`Wr™e
(
	`Ouut
(
Œ“_f’ame
, 
bš¬y
).
	`SŒ—m
(),

176 
bš¬y
);

178 
d–‘e
 
ùx_d•
;

180 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

181 
¡d
::
û¼
 << 
e
.
	`wh©
();

184 
	}
}

	@gmm-ismooth-stats.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/ebw-dŸg-gmm.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

39 
boŞ
 
bš¬y_wr™e
 = 
çl£
;

40 
boŞ
 
smoÙh_äom_mod–
 = 
çl£
;

41 
Ba£Flßt
 
u
 = 100;

43 
P¬£O±iÚs
 
	`po
(
u§ge
);

44 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

45 
po
.
	`Regi¡”
("smoÙh-äom-mod–", &
smoÙh_äom_mod–
, "Ifrue, "

47 
po
.
	`Regi¡”
("u", &
u
, "Tau value for I-smoothing");

49 
po
.
	`R—d
(
¬gc
, 
¬gv
);

51 ià(
po
.
	`NumArgs
() != 3) {

52 
po
.
	`PrštU§ge
();

53 
	`ex™
(1);

56 
¡d
::
¡ršg
 
¤c_¡©s_Ü_mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

57 
d¡_¡©s_f’ame
 = 
po
.
	`G‘Arg
(2),

58 
¡©s_out_f’ame
 = 
po
.
	`G‘Arg
(3);

60 
tÙ_couÁ_befÜe
, 
tÙ_couÁ_aá”
;

62 ià(
¤c_¡©s_Ü_mod–_f’ame
 =ğ
d¡_¡©s_f’ame
) {

63 
	`KALDI_ASSERT
(!
smoÙh_äom_mod–
);

64 
VeùÜ
<> 
Œªs™iÚ_accs
;

65 
AccumAmDŸgGmm
 
¡©s
;

67 
boŞ
 
bš¬y
;

68 
IÅut
 
	`ki
(
d¡_¡©s_f’ame
, &
bš¬y
);

69 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

70 
¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

72 
tÙ_couÁ_befÜe
 = 
¡©s
.
	`TÙStsCouÁ
();

73 
	`IsmoÙhStsAmDŸgGmm
(
¡©s
, 
u
, &stats);

74 
tÙ_couÁ_aá”
 = 
¡©s
.
	`TÙStsCouÁ
();

75 
Ouut
 
	`ko
(
¡©s_out_f’ame
, 
bš¬y_wr™e
);

76 
Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

77 
¡©s
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

78 } ià(
smoÙh_äom_mod–
) {

79 
AmDŸgGmm
 
am_gmm
;

80 
T¿ns™iÚMod–
 
Œªs_mod–
;

81 
VeùÜ
<> 
d¡_Œªs™iÚ_accs
;

82 
AccumAmDŸgGmm
 
d¡_¡©s
;

84 
boŞ
 
bš¬y
;

85 
IÅut
 
	`ki
(
¤c_¡©s_Ü_mod–_f’ame
, &
bš¬y
);

86 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

87 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

90 
boŞ
 
bš¬y
;

91 
IÅut
 
	`ki
(
d¡_¡©s_f’ame
, &
bš¬y
);

92 
d¡_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

93 
d¡_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

95 
tÙ_couÁ_befÜe
 = 
d¡_¡©s
.
	`TÙStsCouÁ
();

96 
	`IsmoÙhStsAmDŸgGmmFromMod–
(
am_gmm
, 
u
, &
d¡_¡©s
);

97 
tÙ_couÁ_aá”
 = 
d¡_¡©s
.
	`TÙStsCouÁ
();

98 
Ouut
 
	`ko
(
¡©s_out_f’ame
, 
bš¬y_wr™e
);

99 
d¡_Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

100 
d¡_¡©s
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

102 
VeùÜ
<> 
¤c_Œªs™iÚ_accs
;

103 
VeùÜ
<> 
d¡_Œªs™iÚ_accs
;

104 
AccumAmDŸgGmm
 
¤c_¡©s
;

105 
AccumAmDŸgGmm
 
d¡_¡©s
;

107 
boŞ
 
bš¬y
;

108 
IÅut
 
	`ki
(
¤c_¡©s_Ü_mod–_f’ame
, &
bš¬y
);

109 
¤c_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

110 
¤c_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

113 
boŞ
 
bš¬y
;

114 
IÅut
 
	`ki
(
d¡_¡©s_f’ame
, &
bš¬y
);

115 
d¡_Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

116 
d¡_¡©s
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
, 
Œue
);

118 
tÙ_couÁ_befÜe
 = 
d¡_¡©s
.
	`TÙStsCouÁ
();

119 
	`IsmoÙhStsAmDŸgGmm
(
¤c_¡©s
, 
u
, &
d¡_¡©s
);

120 
tÙ_couÁ_aá”
 = 
d¡_¡©s
.
	`TÙStsCouÁ
();

122 
Ouut
 
	`ko
(
¡©s_out_f’ame
, 
bš¬y_wr™e
);

123 
d¡_Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

124 
d¡_¡©s
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

126 
KALDI_LOG
 << "SmoÙhed st w™hau = " << 
u
 << ", count changed from "

127 << 
tÙ_couÁ_befÜe
 << "Ø" << 
tÙ_couÁ_aá”
;

128 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

129 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

132 
	}
}

	@gmm-latgen-biglm-faster.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"Œ“/cÚ‹xt-d•.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"f¡ext/f¡ext-lib.h
"

29 
	~"decod”/Ï‰iû-biglm-ç¡”-decod”.h
"

30 
	~"gmm/decodabË-am-dŸg-gmm.h
"

31 
	~"ba£/tim”.h
"

34 
Çme¥aû
 
	gk®di
 {

36 
boŞ
 
DecodeU‰”ªû
(
L©tiûBiglmFa¡”Decod”
 &
decod”
,

37 
DecodabËIÁ”çû
 &
decodabË
,

38 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

39 cÚ¡ 
f¡
::
SymbŞTabË
 *
wÜd_syms
,

40 
¡d
::
¡ršg
 
u‰
,

41 
acou¡ic_sÿË
,

42 
boŞ
 
d‘”mšize
,

43 
boŞ
 
®low_·¹Ÿl
,

44 
IÁ32VeùÜWr™”
 *
®ignm’t_wr™”
,

45 
IÁ32VeùÜWr™”
 *
wÜds_wr™”
,

46 
Com·ùL©tiûWr™”
 *
com·ù_Ï‰iû_wr™”
,

47 
L©tiûWr™”
 *
Ï‰iû_wr™”
,

48 *
like_±r
) {

49 
usšg
 
	gf¡
::
VeùÜF¡
;

51 ià(!
	gdecod”
.
Decode
(&
decodabË
)) {

52 
	gKALDI_WARN
 << "FaedØdecodf" << 
	gu‰
;

53  
	gçl£
;

55 ià(!
	gdecod”
.
R—chedFš®
()) {

56 ià(
	g®low_·¹Ÿl
) {

57 
	gKALDI_WARN
 << "Ouu‰šg…¬tŸÈouuˆfÜ u‰”ªû " << 
	gu‰


60 
	gKALDI_WARN
 << "NÙ…roducšg ouuˆfÜ u‰”ªû " << 
	gu‰


63  
	gçl£
;

67 
	glik–ihood
;

68 
L©tiûWeight
 
	gweight
;

69 
št32
 
	gnum_äames
;

71 
	gVeùÜF¡
<
	gL©tiûArc
> 
	gdecoded
;

72 
	gdecod”
.
G‘Be¡P©h
(&
decoded
);

73 ià(
	gdecoded
.
NumS‹s
() == 0)

75 
KALDI_ERR
 << "FaedØg‘¿ûback fÜ u‰”ªû " << 
u‰
;

77 
	g¡d
::
veùÜ
<
št32
> 
®ignm’t
;

78 
	g¡d
::
veùÜ
<
št32
> 
wÜds
;

79 
G‘Lš—rSymbŞSequ’û
(
decoded
, &
®ignm’t
, &
wÜds
, &
weight
);

80 
	gnum_äames
 = 
®ignm’t
.
size
();

81 ià(
	gwÜds_wr™”
->
IsO³n
())

82 
	gwÜds_wr™”
->
Wr™e
(
u‰
, 
wÜds
);

83 ià(
	g®ignm’t_wr™”
->
IsO³n
())

84 
	g®ignm’t_wr™”
->
Wr™e
(
u‰
, 
®ignm’t
);

85 ià(
	gwÜd_syms
 !ğ
NULL
) {

86 
¡d
::
û¼
 << 
u‰
 << ' ';

87 
size_t
 
	gi
 = 0; i < 
	gwÜds
.
size
(); i++) {

88 
	g¡d
::
¡ršg
 
s
 = 
wÜd_syms
->
Fšd
(
wÜds
[
i
]);

89 ià(
	gs
 == "")

90 
KALDI_ERR
 << "WÜd-id " << 
wÜds
[
i
] <<"‚ot in symbolable.";

91 
	g¡d
::
û¼
 << 
s
 << ' ';

93 
	g¡d
::
û¼
 << '\n';

95 
	glik–ihood
 = -(
weight
.
V®ue1
(è+ weight.
V®ue2
());

99 
L©tiû
 
	gÏt
;

100 
	gdecod”
.
G‘RawL©tiû
(&
Ït
);

101 ià(
	gÏt
.
NumS‹s
() == 0)

102 
KALDI_ERR
 << "UÃx³ùed…robËm g‘tšg†©tiû fÜ u‰”ªû " << 
u‰
;

103 
	gf¡
::
CÚÃù
(&
Ït
);

104 ià(
	gd‘”mšize
) {

105 
Com·ùL©tiû
 
	gş©
;

106 ià(!
D‘”mšizeL©tiûPhÚePruÃdW¿µ”
(

107 
Œªs_mod–
,

108 &
Ït
,

109 
decod”
.
G‘O±iÚs
().
Ï‰iû_b—m
,

110 &
ş©
,

111 
decod”
.
G‘O±iÚs
().
d‘_İts
))

112 
	gKALDI_WARN
 << "Determinization finishedƒarlierhanhe beam for "

113 << "u‰”ªû " << 
	gu‰
;

115 ià(
	gacou¡ic_sÿË
 != 0.0)

116 
f¡
::
SÿËL©tiû
(f¡::
Acou¡icL©tiûSÿË
(1.0 / 
acou¡ic_sÿË
), &
ş©
);

117 
	gcom·ù_Ï‰iû_wr™”
->
Wr™e
(
u‰
, 
ş©
);

119 
L©tiû
 
	gf¡
;

120 
	gdecod”
.
G‘RawL©tiû
(&
f¡
);

121 ià(
	gf¡
.
NumS‹s
() == 0)

122 
KALDI_ERR
 << "Unexpected…roblem getting†attice for utterance "

123 << 
u‰
;

124 
	gf¡
::
CÚÃù
(&
f¡
);

126 ià(
	gacou¡ic_sÿË
 != 0.0)

127 
f¡
::
SÿËL©tiû
(f¡::
Acou¡icL©tiûSÿË
(1.0 / 
acou¡ic_sÿË
), &fst);

128 
	gÏ‰iû_wr™”
->
Wr™e
(
u‰
, 
f¡
);

130 
	gKALDI_LOG
 << "Log-lik³¸äamfÜ u‰”ªû " << 
	gu‰
 << " is "

131 << (
	glik–ihood
 / 
	gnum_äames
) << " over "

132 << 
	gnum_äames
 << " frames.";

133 
KALDI_VLOG
(2è<< "Co¡ fÜ u‰”ªû " << 
	gu‰
 << " is "

134 << 
	gweight
.
V®ue1
(è<< " + " << weight.
V®ue2
();

135 *
	glike_±r
 = 
lik–ihood
;

136  
	gŒue
;

143 
	$maš
(
¬gc
, *
¬gv
[]) {

144 
Œy
 {

145 
usšg
 
Çme¥aû
 
k®di
;

146 
k®di
::
	tšt32
 int32;

147 
usšg
 
f¡
::
SymbŞTabË
;

148 
usšg
 
f¡
::
VeùÜF¡
;

149 
usšg
 
f¡
::
F¡
;

150 
usšg
 
f¡
::
StdArc
;

151 
usšg
 
f¡
::
R—dF¡K®di
;

153 cÚ¡ *
u§ge
 =

160 
P¬£O±iÚs
 
	`po
(
u§ge
);

161 
Tim”
 
tim”
;

162 
boŞ
 
®low_·¹Ÿl
 = 
çl£
;

163 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

164 
L©tiûBiglmFa¡”Decod”CÚfig
 
cÚfig
;

166 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

167 
cÚfig
.
	`Regi¡”
(&
po
);

168 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
, "Scaling factor for‡coustic†ikelihoods");

170 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
, "Symbolable for words [for debug output]");

171 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
, "Ifrue,…roduce outputƒven ifƒnd state was‚ot„eached.");

173 
po
.
	`R—d
(
¬gc
, 
¬gv
);

175 ià(
po
.
	`NumArgs
() < 6 ||…o.NumArgs() > 8) {

176 
po
.
	`PrštU§ge
();

177 
	`ex™
(1);

180 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

181 
f¡_š_¡r
 = 
po
.
	`G‘Arg
(2),

182 
Şd_lm_f¡_rxf’ame
 = 
po
.
	`G‘Arg
(3),

183 
Ãw_lm_f¡_rxf’ame
 = 
po
.
	`G‘Arg
(4),

184 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

185 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘Arg
(6),

186 
wÜds_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(7),

187 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(8);

189 
T¿ns™iÚMod–
 
Œªs_mod–
;

190 
AmDŸgGmm
 
am_gmm
;

192 
boŞ
 
bš¬y
;

193 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

194 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

195 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

198 
VeùÜF¡
<
StdArc
> *
Şd_lm_f¡
 = 
f¡
::
	`Ca¡OrCÚv”tToVeùÜF¡
(

199 
f¡
::
	`R—dF¡K®diG’”ic
(
Şd_lm_f¡_rxf’ame
));

200 
	`AµlyProbab™ySÿË
(-1.0, 
Şd_lm_f¡
);

202 
VeùÜF¡
<
StdArc
> *
Ãw_lm_f¡
 = 
f¡
::
	`Ca¡OrCÚv”tToVeùÜF¡
(

203 
f¡
::
	`R—dF¡K®diG’”ic
(
Ãw_lm_f¡_rxf’ame
));

205 
f¡
::
BackoffD‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`Şd_lm_df¡
(*
Şd_lm_f¡
);

206 
f¡
::
BackoffD‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`Ãw_lm_df¡
(*
Ãw_lm_f¡
);

207 
f¡
::
Compo£D‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`compo£_df¡
(&
Şd_lm_df¡
,

208 &
Ãw_lm_df¡
);

209 
f¡
::
CacheD‘”mši¡icOnDemªdF¡
<
StdArc
> 
	`ÿche_df¡
(&
compo£_df¡
);

211 
boŞ
 
d‘”mšize
 = 
cÚfig
.
d‘”mšize_Ï‰iû
;

212 
Com·ùL©tiûWr™”
 
com·ù_Ï‰iû_wr™”
;

213 
L©tiûWr™”
 
Ï‰iû_wr™”
;

214 ià(! (
d‘”mšize
 ? 
com·ù_Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)

215 : 
Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)))

216 
KALDI_ERR
 << "Could‚ot openable for writing†attices: "

217 << 
Ï‰iû_w¥ecif›r
;

219 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

221 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

223 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

224 ià(
wÜd_syms_f’ame
 != "")

225 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

226 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

227 << 
wÜd_syms_f’ame
;

229 
tÙ_like
 = 0.0;

230 
k®di
::
št64
 
äame_couÁ
 = 0;

231 
num_sucûss
 = 0, 
num_ç
 = 0;

234 ià(
	`CÏssifyR¥ecif›r
(
f¡_š_¡r
, 
NULL
, NULLè=ğ
kNoR¥ecif›r
) {

235 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

237 
F¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®diG’”ic
(
f¡_š_¡r
);

240 
L©tiûBiglmFa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
cÚfig
, &
ÿche_df¡
);

242 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

243 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

244 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

245 
ã©u»_»ad”
.
	`F»eCu¼’t
();

246 ià(
ã©u»s
.
	`NumRows
() == 0) {

247 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

248 
num_ç
++;

252 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

253 
acou¡ic_sÿË
);

256 
like
;

257 ià(
	`DecodeU‰”ªû
(
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
,

258 
u‰
, 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
,

259 &
®ignm’t_wr™”
, &
wÜds_wr™”
,

260 &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

261 &
like
)) {

262 
tÙ_like
 +ğ
like
;

263 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

264 
num_sucûss
++;

265 } 
num_ç
++;

268 
d–‘e
 
decode_f¡
;

270 
Sequ’tŸlTabËR—d”
<
f¡
::
VeùÜF¡HŞd”
> 
	`f¡_»ad”
(
f¡_š_¡r
);

271 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

272 ; !
f¡_»ad”
.
	`DÚe
(); f¡_»ad”.
	`Next
()) {

273 
¡d
::
¡ršg
 
u‰
 = 
f¡_»ad”
.
	`Key
();

274 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

275 
KALDI_WARN
 << "NÙ decodšg u‰”ªû " << 
u‰


277 
num_ç
++;

280 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©u»s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

281 ià(
ã©u»s
.
	`NumRows
() == 0) {

282 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

283 
num_ç
++;

286 
L©tiûBiglmFa¡”Decod”
 
	`decod”
(
f¡_»ad”
.
	`V®ue
(), 
cÚfig
,

287 &
ÿche_df¡
);

288 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

289 
acou¡ic_sÿË
);

290 
like
;

291 ià(
	`DecodeU‰”ªû
(
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
,

292 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
,

293 &
®ignm’t_wr™”
, &
wÜds_wr™”
,

294 &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

295 &
like
)) {

296 
tÙ_like
 +ğ
like
;

297 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

298 
num_sucûss
++;

299 } 
num_ç
++;

303 
–­£d
 = 
tim”
.
	`EÏp£d
();

304 
KALDI_LOG
 << "Timk’ "<< 
–­£d


306 << (
–­£d
*100.0/
äame_couÁ
);

307 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

308 << 
num_ç
;

309 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

310 << 
äame_couÁ
<<" frames.";

312 
d–‘e
 
wÜd_syms
;

313 ià(
num_sucûss
 != 0)  0;

315 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

316 
¡d
::
û¼
 << 
e
.
	`wh©
();

319 
	}
}

	@gmm-latgen-faster-parallel.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"Œ“/cÚ‹xt-d•.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"f¡ext/f¡ext-lib.h
"

29 
	~"decod”/decod”-w¿µ”s.h
"

30 
	~"gmm/decodabË-am-dŸg-gmm.h
"

31 
	~"ba£/tim”.h
"

32 
	~"ã©/ã©u»-funùiÚs.h
"

33 
	~"ut/k®di-th»ad.h
"

36 
	$maš
(
¬gc
, *
¬gv
[]) {

37 
Œy
 {

38 
usšg
 
Çme¥aû
 
k®di
;

39 
k®di
::
	tšt32
 int32;

40 
usšg
 
f¡
::
SymbŞTabË
;

41 
usšg
 
f¡
::
VeùÜF¡
;

42 
usšg
 
f¡
::
F¡
;

43 
usšg
 
f¡
::
StdArc
;

45 cÚ¡ *
u§ge
 =

50 
P¬£O±iÚs
 
	`po
(
u§ge
);

51 
Tim”
 
tim”
;

52 
boŞ
 
®low_·¹Ÿl
 = 
çl£
;

53 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

54 
Ba£Flßt
 
log_sum_exp_´uÃ
 = 0.0;

55 
L©tiûFa¡”Decod”CÚfig
 
Ïtg’_cÚfig
;

56 
TaskSequ’ûrCÚfig
 
£qu’ûr_cÚfig
;

58 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

59 
Ïtg’_cÚfig
.
	`Regi¡”
(&
po
);

60 
£qu’ûr_cÚfig
.
	`Regi¡”
(&
po
);

61 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

63 
po
.
	`Regi¡”
("log-sum-exp-´uÃ", &
log_sum_exp_´uÃ
,

66 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

68 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

71 
po
.
	`R—d
(
¬gc
, 
¬gv
);

73 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 6) {

74 
po
.
	`PrštU§ge
();

75 
	`ex™
(1);

78 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

79 
f¡_š_¡r
 = 
po
.
	`G‘Arg
(2),

80 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

81 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘Arg
(4),

82 
wÜds_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(5),

83 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

85 
T¿ns™iÚMod–
 
Œªs_mod–
;

86 
AmDŸgGmm
 
am_gmm
;

88 
boŞ
 
bš¬y
;

89 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

90 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

91 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

94 
boŞ
 
d‘”mšize
 = 
Ïtg’_cÚfig
.
d‘”mšize_Ï‰iû
;

95 
Com·ùL©tiûWr™”
 
com·ù_Ï‰iû_wr™”
;

96 
L©tiûWr™”
 
Ï‰iû_wr™”
;

97 ià(! (
d‘”mšize
 ? 
com·ù_Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)

98 : 
Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)))

99 
KALDI_ERR
 << "Could‚ot openable for writing†attices: "

100 << 
Ï‰iû_w¥ecif›r
;

102 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

104 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

106 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

107 ià(
wÜd_syms_f’ame
 != "")

108 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

109 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

110 << 
wÜd_syms_f’ame
;

112 
tÙ_like
 = 0.0;

113 
k®di
::
št64
 
äame_couÁ
 = 0;

114 
num_dÚe
 = 0, 
num_”r
 = 0;

115 
F¡
<
StdArc
> *
decode_f¡
 = 
NULL
;

118 
TaskSequ’ûr
<
DecodeU‰”ªûL©tiûFa¡”CÏss
> 
	`£qu’ûr
(
£qu’ûr_cÚfig
);

120 ià(
	`CÏssifyR¥ecif›r
(
f¡_š_¡r
, 
NULL
, NULLè=ğ
kNoR¥ecif›r
) {

121 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

124 
decode_f¡
 = 
f¡
::
	`R—dF¡K®diG’”ic
(
f¡_š_¡r
);

125 
tim”
.
	`Re£t
();

128 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

129 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

130 
M©rix
<
Ba£Flßt
> *
ã©u»s
 =

131 
Ãw
 
M©rix
<
Ba£Flßt
>(
ã©u»_»ad”
.
	`V®ue
());

132 
ã©u»_»ad”
.
	`F»eCu¼’t
();

133 ià(
ã©u»s
->
	`NumRows
() == 0) {

134 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

135 
num_”r
++;

136 
d–‘e
 
ã©u»s
;

140 
L©tiûFa¡”Decod”
 *
decod”
 = 
Ãw
 
	`L©tiûFa¡”Decod”
(*
decode_f¡
,

141 
Ïtg’_cÚfig
);

143 
DecodabËAmDŸgGmmSÿËd
 *
gmm_decodabË
 =

144 
Ãw
 
	`DecodabËAmDŸgGmmSÿËd
(
am_gmm
, 
Œªs_mod–
,

145 
acou¡ic_sÿË
,

146 
log_sum_exp_´uÃ
,

147 
ã©u»s
);

149 
DecodeU‰”ªûL©tiûFa¡”CÏss
 *
sk
 =

150 
Ãw
 
	`DecodeU‰”ªûL©tiûFa¡”CÏss
(

151 
decod”
, 
gmm_decodabË
,

152 
Œªs_mod–
, 
wÜd_syms
, 
u‰
, 
acou¡ic_sÿË
, 
d‘”mšize
,

153 
®low_·¹Ÿl
, &
®ignm’t_wr™”
, &
wÜds_wr™”
,

154 &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

155 &
tÙ_like
, &
äame_couÁ
, &
num_dÚe
, &
num_”r
, 
NULL
);

157 
£qu’ûr
.
	`Run
(
sk
);

162 
Sequ’tŸlTabËR—d”
<
f¡
::
VeùÜF¡HŞd”
> 
	`f¡_»ad”
(
f¡_š_¡r
);

163 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

164 ; !
f¡_»ad”
.
	`DÚe
(); f¡_»ad”.
	`Next
()) {

165 
¡d
::
¡ršg
 
u‰
 = 
f¡_»ad”
.
	`Key
();

166 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

167 
KALDI_WARN
 << "NÙ decodšg u‰”ªû " << 
u‰


169 
num_”r
++;

172 
M©rix
<
Ba£Flßt
> *
ã©u»s
 = 
Ãw
 Matrix<BaseFloat>(

173 
ã©u»_»ad”
.
	`V®ue
(
u‰
));

174 ià(
ã©u»s
->
	`NumRows
() == 0) {

175 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

176 
num_”r
++;

177 
d–‘e
 
ã©u»s
;

182 
L©tiûFa¡”Decod”
 *
decod”
 = 
Ãw
 
	`L©tiûFa¡”Decod”
(

183 
Ïtg’_cÚfig
,

184 
Ãw
 
VeùÜF¡
<
StdArc
>(
f¡_»ad”
.
	`V®ue
()));

187 
DecodabËAmDŸgGmmSÿËd
 *
gmm_decodabË
 =

188 
Ãw
 
	`DecodabËAmDŸgGmmSÿËd
(
am_gmm
, 
Œªs_mod–
, 
acou¡ic_sÿË
,

189 
log_sum_exp_´uÃ
, 
ã©u»s
);

191 
DecodeU‰”ªûL©tiûFa¡”CÏss
 *
sk
 =

192 
Ãw
 
	`DecodeU‰”ªûL©tiûFa¡”CÏss
(

193 
decod”
, 
gmm_decodabË
,

194 
Œªs_mod–
, 
wÜd_syms
, 
u‰
, 
acou¡ic_sÿË
, 
d‘”mšize
,

195 
®low_·¹Ÿl
, &
®ignm’t_wr™”
, &
wÜds_wr™”
,

196 &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

197 &
tÙ_like
, &
äame_couÁ
, &
num_dÚe
, &
num_”r
, 
NULL
);

198 
£qu’ûr
.
	`Run
(
sk
);

202 
£qu’ûr
.
	`Wa™
();

204 
d–‘e
 
decode_f¡
;

206 
–­£d
 = 
tim”
.
	`EÏp£d
();

207 
KALDI_LOG
 << "Decoded w™h " << 
£qu’ûr_cÚfig
.
num_th»ads
 << "hreads.";

208 
KALDI_LOG
 << "Timk’ "<< 
–­£d


210 << (
£qu’ûr_cÚfig
.
num_th»ads
 * 
–­£d
 * 100.0 / 
äame_couÁ
);

211 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " utterances, failed for "

212 << 
num_”r
;

213 
KALDI_LOG
 << "Overall†og-likelihood…er frame is "

214 << (
tÙ_like
/
äame_couÁ
) << " over "

215 << 
äame_couÁ
 << " frames.";

217 
d–‘e
 
wÜd_syms
;

218 ià(
num_dÚe
 != 0)  0;

220 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

221 
¡d
::
û¼
 << 
e
.
	`wh©
();

224 
	}
}

	@gmm-latgen-faster-regtree-fmllr.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"Œ“/cÚ‹xt-d•.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"f¡ext/f¡ext-lib.h
"

29 
	~"decod”/decod”-w¿µ”s.h
"

30 
	~"gmm/decodabË-am-dŸg-gmm.h
"

31 
	~"ba£/tim”.h
"

32 
	~"ŒªsfÜm/»g»ssiÚ-Œ“.h
"

33 
	~"ŒªsfÜm/»gŒ“-fmÎr-dŸg-gmm.h
"

34 
	~"ŒªsfÜm/decodabË-am-dŸg-gmm-»gŒ“.h
"

35 
	~"ã©/ã©u»-funùiÚs.h
"

37 
	$maš
(
¬gc
, *
¬gv
[]) {

38 
Œy
 {

39 
usšg
 
Çme¥aû
 
k®di
;

40 
k®di
::
	tšt32
 int32;

41 
usšg
 
f¡
::
SymbŞTabË
;

42 
usšg
 
f¡
::
F¡
;

43 
usšg
 
f¡
::
StdArc
;

45 cÚ¡ *
u§ge
 =

49 
P¬£O±iÚs
 
	`po
(
u§ge
);

50 
Tim”
 
tim”
;

51 
boŞ
 
®low_·¹Ÿl
 = 
çl£
;

52 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

53 
L©tiûFa¡”Decod”CÚfig
 
cÚfig
;

55 
¡d
::
¡ršg
 
wÜd_syms_f’ame
, 
u‰2¥k_r¥ecif›r
;

56 
cÚfig
.
	`Regi¡”
(&
po
);

57 
po
.
	`Regi¡”
("u‰2¥k", &
u‰2¥k_r¥ecif›r
, "rspecifier for utteranceo "

59 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

61 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

63 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

66 
po
.
	`R—d
(
¬gc
, 
¬gv
);

68 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 6) {

69 
po
.
	`PrštU§ge
();

70 
	`ex™
(1);

73 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

74 
»gŒ“_š_¡r
 = 
po
.
	`G‘Arg
(2),

75 
f¡_š_¡r
 = 
po
.
	`G‘Arg
(3),

76 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

77 
xfÜms_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

78 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘Arg
(6),

79 
wÜds_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(7),

80 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(8);

82 
T¿ns™iÚMod–
 
Œªs_mod–
;

83 
AmDŸgGmm
 
am_gmm
;

85 
boŞ
 
bš¬y
;

86 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

87 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

88 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

91 
Reg»ssiÚT»e
 
»gŒ“
;

93 
boŞ
 
bš¬y_»ad
;

94 
IÅut
 
	`š
(
»gŒ“_š_¡r
, &
bš¬y_»ad
);

95 
»gŒ“
.
	`R—d
(
š
.
	`SŒ—m
(), 
bš¬y_»ad
, 
am_gmm
);

98 
RªdomAcûssRegŒ“FmÎrDŸgGmmR—d”M­³d
 
	`fmÎr_»ad”
(
xfÜms_r¥ecif›r
,

99 
u‰2¥k_r¥ecif›r
);

101 
boŞ
 
d‘”mšize
 = 
cÚfig
.
d‘”mšize_Ï‰iû
;

102 
Com·ùL©tiûWr™”
 
com·ù_Ï‰iû_wr™”
;

103 
L©tiûWr™”
 
Ï‰iû_wr™”
;

104 ià(! (
d‘”mšize
 ? 
com·ù_Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)

105 : 
Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)))

106 
KALDI_ERR
 << "Could‚ot openable for writing†attices: "

107 << 
Ï‰iû_w¥ecif›r
;

109 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

111 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

113 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

114 ià(
wÜd_syms_f’ame
 != "")

115 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

116 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

117 << 
wÜd_syms_f’ame
;

119 
tÙ_like
 = 0.0;

120 
k®di
::
št64
 
äame_couÁ
 = 0;

121 
num_dÚe
 = 0, 
num_”r
 = 0;

123 ià(
	`CÏssifyR¥ecif›r
(
f¡_š_¡r
, 
NULL
, NULLè=ğ
kNoR¥ecif›r
) {

124 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

126 
F¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®diG’”ic
(
f¡_š_¡r
);

129 
L©tiûFa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
cÚfig
);

131 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

132 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

133 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

134 
ã©u»_»ad”
.
	`F»eCu¼’t
();

135 ià(
ã©u»s
.
	`NumRows
() == 0) {

136 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

137 
num_”r
++;

140 ià(!
fmÎr_»ad”
.
	`HasKey
(
u‰
)) {

141 
KALDI_WARN
 << "NÙ decodšg u‰”ªû " << 
u‰


143 
num_”r
++;

147 
RegŒ“FmÎrDŸgGmm
 
	`fmÎr
(
fmÎr_»ad”
.
	`V®ue
(
u‰
));

149 
k®di
::
DecodabËAmDŸgGmmRegŒ“FmÎr
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

150 
ã©u»s
, 
fmÎr
,

151 
»gŒ“
,

152 
acou¡ic_sÿË
);

153 
like
;

154 ià(
	`DecodeU‰”ªûL©tiûFa¡”
(

155 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
, 
acou¡ic_sÿË
,

156 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
, &
wÜds_wr™”
,

157 &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
, &
like
)) {

158 
tÙ_like
 +ğ
like
;

159 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

160 
num_dÚe
++;

161 } 
num_”r
++;

164 
d–‘e
 
decode_f¡
;

166 
Sequ’tŸlTabËR—d”
<
f¡
::
VeùÜF¡HŞd”
> 
	`f¡_»ad”
(
f¡_š_¡r
);

167 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

168 ; !
f¡_»ad”
.
	`DÚe
(); f¡_»ad”.
	`Next
()) {

169 
¡d
::
¡ršg
 
u‰
 = 
f¡_»ad”
.
	`Key
();

170 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©u»s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

171 ià(
ã©u»s
.
	`NumRows
() == 0) {

172 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

173 
num_”r
++;

176 ià(!
fmÎr_»ad”
.
	`HasKey
(
u‰
)) {

177 
KALDI_WARN
 << "NÙ decodšg u‰”ªû " << 
u‰


179 
num_”r
++;

183 
RegŒ“FmÎrDŸgGmm
 
	`fmÎr
(
fmÎr_»ad”
.
	`V®ue
(
u‰
));

184 
k®di
::
DecodabËAmDŸgGmmRegŒ“FmÎr
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

185 
ã©u»s
, 
fmÎr
,

186 
»gŒ“
,

187 
acou¡ic_sÿË
);

189 
L©tiûFa¡”Decod”
 
	`decod”
(
f¡_»ad”
.
	`V®ue
(), 
cÚfig
);

190 
like
;

191 ià(
	`DecodeU‰”ªûL©tiûFa¡”
(

192 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
, 
acou¡ic_sÿË
,

193 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
, &
wÜds_wr™”
,

194 &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
, &
like
)) {

195 
tÙ_like
 +ğ
like
;

196 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

197 
num_dÚe
++;

198 } 
num_”r
++;

202 
–­£d
 = 
tim”
.
	`EÏp£d
();

203 
KALDI_LOG
 << "Timk’ "<< 
–­£d


205 << (
–­£d
*100.0/
äame_couÁ
);

206 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " utterances, failed for "

207 << 
num_”r
;

208 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

209 << 
äame_couÁ
 << " frames.";

211 
d–‘e
 
wÜd_syms
;

212 ià(
num_dÚe
 != 0)  0;

214 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

215 
¡d
::
û¼
 << 
e
.
	`wh©
();

218 
	}
}

	@gmm-latgen-faster.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"Œ“/cÚ‹xt-d•.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"f¡ext/f¡ext-lib.h
"

29 
	~"decod”/decod”-w¿µ”s.h
"

30 
	~"gmm/decodabË-am-dŸg-gmm.h
"

31 
	~"ba£/tim”.h
"

32 
	~"ã©/ã©u»-funùiÚs.h
"

34 
	$maš
(
¬gc
, *
¬gv
[]) {

35 
Œy
 {

36 
usšg
 
Çme¥aû
 
k®di
;

37 
k®di
::
	tšt32
 int32;

38 
usšg
 
f¡
::
SymbŞTabË
;

39 
usšg
 
f¡
::
F¡
;

40 
usšg
 
f¡
::
StdArc
;

42 cÚ¡ *
u§ge
 =

46 
P¬£O±iÚs
 
	`po
(
u§ge
);

47 
Tim”
 
tim”
;

48 
boŞ
 
®low_·¹Ÿl
 = 
çl£
;

49 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

50 
L©tiûFa¡”Decod”CÚfig
 
cÚfig
;

52 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

53 
cÚfig
.
	`Regi¡”
(&
po
);

54 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

56 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

58 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

61 
po
.
	`R—d
(
¬gc
, 
¬gv
);

63 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 6) {

64 
po
.
	`PrštU§ge
();

65 
	`ex™
(1);

68 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

69 
f¡_š_¡r
 = 
po
.
	`G‘Arg
(2),

70 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

71 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘Arg
(4),

72 
wÜds_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(5),

73 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

75 
T¿ns™iÚMod–
 
Œªs_mod–
;

76 
AmDŸgGmm
 
am_gmm
;

78 
boŞ
 
bš¬y
;

79 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

80 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

81 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

84 
boŞ
 
d‘”mšize
 = 
cÚfig
.
d‘”mšize_Ï‰iû
;

85 
Com·ùL©tiûWr™”
 
com·ù_Ï‰iû_wr™”
;

86 
L©tiûWr™”
 
Ï‰iû_wr™”
;

87 ià(! (
d‘”mšize
 ? 
com·ù_Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)

88 : 
Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)))

89 
KALDI_ERR
 << "Could‚ot openable for writing†attices: "

90 << 
Ï‰iû_w¥ecif›r
;

92 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

94 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

96 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

97 ià(
wÜd_syms_f’ame
 != "")

98 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

99 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

100 << 
wÜd_syms_f’ame
;

102 
tÙ_like
 = 0.0;

103 
k®di
::
št64
 
äame_couÁ
 = 0;

104 
num_dÚe
 = 0, 
num_”r
 = 0;

106 ià(
	`CÏssifyR¥ecif›r
(
f¡_š_¡r
, 
NULL
, NULLè=ğ
kNoR¥ecif›r
) {

107 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

109 
F¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®diG’”ic
(
f¡_š_¡r
);

110 
tim”
.
	`Re£t
();

113 
L©tiûFa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
cÚfig
);

115 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

116 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

117 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

118 
ã©u»_»ad”
.
	`F»eCu¼’t
();

119 ià(
ã©u»s
.
	`NumRows
() == 0) {

120 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

121 
num_”r
++;

125 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

126 
acou¡ic_sÿË
);

128 
like
;

129 ià(
	`DecodeU‰”ªûL©tiûFa¡”
(

130 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
,

131 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
,

132 &
wÜds_wr™”
, &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

133 &
like
)) {

134 
tÙ_like
 +ğ
like
;

135 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

136 
num_dÚe
++;

137 } 
num_”r
++;

140 
d–‘e
 
decode_f¡
;

142 
Sequ’tŸlTabËR—d”
<
f¡
::
VeùÜF¡HŞd”
> 
	`f¡_»ad”
(
f¡_š_¡r
);

143 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

144 ; !
f¡_»ad”
.
	`DÚe
(); f¡_»ad”.
	`Next
()) {

145 
¡d
::
¡ršg
 
u‰
 = 
f¡_»ad”
.
	`Key
();

146 ià(!
ã©u»_»ad”
.
	`HasKey
(
u‰
)) {

147 
KALDI_WARN
 << "NÙ decodšg u‰”ªû " << 
u‰


149 
num_”r
++;

152 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©u»s
 = 
ã©u»_»ad”
.
	`V®ue
(
u‰
);

153 ià(
ã©u»s
.
	`NumRows
() == 0) {

154 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

155 
num_”r
++;

159 
L©tiûFa¡”Decod”
 
	`decod”
(
f¡_»ad”
.
	`V®ue
(), 
cÚfig
);

160 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

161 
acou¡ic_sÿË
);

162 
like
;

163 ià(
	`DecodeU‰”ªûL©tiûFa¡”
(

164 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
,

165 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
,

166 &
wÜds_wr™”
, &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

167 &
like
)) {

168 
tÙ_like
 +ğ
like
;

169 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

170 
num_dÚe
++;

171 } 
num_”r
++;

175 
–­£d
 = 
tim”
.
	`EÏp£d
();

176 
KALDI_LOG
 << "Timk’ "<< 
–­£d


178 << (
–­£d
*100.0/
äame_couÁ
);

179 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " utterances, failed for "

180 << 
num_”r
;

181 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

182 << 
äame_couÁ
 << " frames.";

184 
d–‘e
 
wÜd_syms
;

185 ià(
num_dÚe
 != 0)  0;

187 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

188 
¡d
::
û¼
 << 
e
.
	`wh©
();

191 
	}
}

	@gmm-latgen-map.cc

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"ba£/k®di-commÚ.h
"

26 
	~"ut/commÚ-uts.h
"

27 
	~"gmm/am-dŸg-gmm.h
"

28 
	~"gmm/mË-am-dŸg-gmm.h
"

29 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
	~"ŒªsfÜm/fmÎr-dŸg-gmm.h
"

31 
	~"f¡ext/f¡ext-lib.h
"

32 
	~"decod”/decod”-w¿µ”s.h
"

33 
	~"gmm/decodabË-am-dŸg-gmm.h
"

34 
	~"ba£/tim”.h
"

35 
	~"Ït/k®di-Ï‰iû.h
"

38 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
Œy
 {

40 
usšg
 
Çme¥aû
 
k®di
;

41 
k®di
::
	tšt32
 int32;

42 
usšg
 
f¡
::
SymbŞTabË
;

43 
usšg
 
f¡
::
F¡
;

44 
usšg
 
f¡
::
StdArc
;

46 cÚ¡ *
u§ge
 = "Decode features using GMM-based model. Note:he input\n"

55 
P¬£O±iÚs
 
	`po
(
u§ge
);

56 
boŞ
 
bš¬y
 = 
Œue
;

57 
boŞ
 
®low_·¹Ÿl
 = 
Œue
;

58 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

60 
¡d
::
¡ršg
 
wÜd_syms_f’ame
, 
u‰2¥k_r¥ecif›r
;

61 
L©tiûFa¡”Decod”CÚfig
 
decod”_İts
;

62 
decod”_İts
.
	`Regi¡”
(&
po
);

63 
po
.
	`Regi¡”
("u‰2¥k", &
u‰2¥k_r¥ecif›r
, "rspecifier for utteranceo "

65 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

66 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

68 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
,

70 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
,

72 
po
.
	`R—d
(
¬gc
, 
¬gv
);

74 ià(
po
.
	`NumArgs
() < 5 ||…o.NumArgs() > 7) {

75 
po
.
	`PrštU§ge
();

76 
	`ex™
(1);

79 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

80 
gmms_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

81 
f¡_š_f’ame
 = 
po
.
	`G‘Arg
(3),

82 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

83 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘Arg
(5),

84 
wÜds_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6),

85 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(7);

87 
T¿ns™iÚMod–
 
Œªs_mod–
;

89 
boŞ
 
bš¬y_»ad
;

90 
IÅut
 
	`is
(
mod–_š_f’ame
, &
bš¬y_»ad
);

91 
Œªs_mod–
.
	`R—d
(
is
.
	`SŒ—m
(), 
bš¬y_»ad
);

93 
RªdomAcûssM­AmDŸgGmmR—d”M­³d
 
	`gmms_»ad”
(
gmms_r¥ecif›r
,

94 
u‰2¥k_r¥ecif›r
);

96 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

97 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

100 
boŞ
 
d‘”mšize
 = 
decod”_İts
.
d‘”mšize_Ï‰iû
;

101 ià(!
d‘”mšize
)

102 
KALDI_WARN
 << "determinize is seto FASLE ...";

103 
Com·ùL©tiûWr™”
 
com·ù_Ï‰iû_wr™”
;

104 
L©tiûWr™”
 
Ï‰iû_wr™”
;

106 ià(
Ï‰iû_w¥ecif›r
 != "") {

107 ià(! (
d‘”mšize
 ? 
com·ù_Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)

108 : 
Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)))

109 
KALDI_ERR
 << "Could‚ot openable for writing†attices: "

110 << 
Ï‰iû_w¥ecif›r
;

113 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

114 ià(
wÜd_syms_f’ame
 != "") {

115 
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
);

116 ià(!
wÜd_syms
) {

117 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

118 << 
wÜd_syms_f’ame
;

122 
Ba£Flßt
 
tÙ_like
 = 0.0;

123 
k®di
::
št64
 
äame_couÁ
 = 0;

124 
num_sucûss
 = 0, 
num_ç
 = 0;

125 
Tim”
 
tim”
;

127 ià(
	`CÏssifyR¥ecif›r
(
f¡_š_f’ame
, 
NULL
, NULLè=ğ
kNoR¥ecif›r
) {

129 
F¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®diG’”ic
(
f¡_š_f’ame
);

131 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

132 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

133 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

135 ià(!
gmms_»ad”
.
	`HasKey
(
u‰
)) {

136 
KALDI_WARN
 << "U‰”ªû " << 
u‰


138 
num_ç
++;

141 
AmDŸgGmm
 
am_gmm
;

142 
am_gmm
.
	`CİyFromAmDŸgGmm
(
gmms_»ad”
.
	`V®ue
(
u‰
));

144 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
(
ã©u»_»ad”
.
	`V®ue
());

145 
ã©u»_»ad”
.
	`F»eCu¼’t
();

146 ià(
ã©u»s
.
	`NumRows
() == 0) {

147 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

148 
num_ç
++;

152 
L©tiûFa¡”Decod”
 
	`decod”
(*
decode_f¡
, 
decod”_İts
);

153 
k®di
::
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

154 
ã©u»s
,

155 
acou¡ic_sÿË
);

156 
like
;

157 ià(
	`DecodeU‰”ªûL©tiûFa¡”
(

158 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
,

159 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
,

160 &
wÜds_wr™”
, &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

161 &
like
)) {

162 
tÙ_like
 +ğ
like
;

163 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

164 
num_sucûss
++;

165 } 
num_ç
++;

168 
RªdomAcûssTabËR—d”
<
f¡
::
VeùÜF¡HŞd”
> 
	`f¡_»ad”
(
f¡_š_f’ame
);

169 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

170 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

171 
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

173 ià(!
f¡_»ad”
.
	`HasKey
(
u‰
)) {

174 
KALDI_WARN
 << "U‰”ªû " << 
u‰
 << " has‚o corresponding FST"

176 
num_ç
++;

180 ià(!
gmms_»ad”
.
	`HasKey
(
u‰
)) {

181 
KALDI_WARN
 << "U‰”ªû " << 
u‰


183 
num_ç
++;

186 
AmDŸgGmm
 
am_gmm
;

187 
am_gmm
.
	`CİyFromAmDŸgGmm
(
gmms_»ad”
.
	`V®ue
(
u‰
));

189 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
(
ã©u»_»ad”
.
	`V®ue
());

190 
ã©u»_»ad”
.
	`F»eCu¼’t
();

191 ià(
ã©u»s
.
	`NumRows
() == 0) {

192 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

193 
num_ç
++;

197 
L©tiûFa¡”Decod”
 
	`decod”
(
f¡_»ad”
.
	`V®ue
(
u‰
), 
decod”_İts
);

198 
k®di
::
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
,

199 
ã©u»s
,

200 
acou¡ic_sÿË
);

201 
like
;

202 ià(
	`DecodeU‰”ªûL©tiûFa¡”
(

203 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
,

204 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
,

205 &
wÜds_wr™”
, &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
,

206 &
like
)) {

207 
tÙ_like
 +ğ
like
;

208 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

209 
num_sucûss
++;

210 } 
num_ç
++;

213 
KALDI_LOG
 << "Average†og-likelihood…er frame is "

214 << (
tÙ_like
 / 
äame_couÁ
) << " over " << frame_count << " frames.";

216 
–­£d
 = 
tim”
.
	`EÏp£d
();

217 
KALDI_LOG
 << "Timk’ [exşudšg in™Ÿliz©iÚ] " << 
–­£d


219 << (
–­£d
 * 100.0 / 
äame_couÁ
);

220 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

221 << 
num_ç
;

223 
d–‘e
 
wÜd_syms
;

224  (
num_sucûss
 != 0 ? 0 : 1);

226 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

227 
¡d
::
û¼
 << 
e
.
	`wh©
();

230 
	}
}

	@gmm-latgen-simple.cc

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/commÚ-uts.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"Œ“/cÚ‹xt-d•.h
"

27 
	~"hmm/Œªs™iÚ-mod–.h
"

28 
	~"f¡ext/f¡ext-lib.h
"

29 
	~"decod”/decod”-w¿µ”s.h
"

30 
	~"gmm/decodabË-am-dŸg-gmm.h
"

31 
	~"ba£/tim”.h
"

35 
	$maš
(
¬gc
, *
¬gv
[]) {

36 
Œy
 {

37 
usšg
 
Çme¥aû
 
k®di
;

38 
k®di
::
	tšt32
 int32;

39 
usšg
 
f¡
::
SymbŞTabË
;

40 
usšg
 
f¡
::
F¡
;

41 
usšg
 
f¡
::
StdArc
;

43 cÚ¡ *
u§ge
 =

47 
P¬£O±iÚs
 
	`po
(
u§ge
);

48 
Tim”
 
tim”
;

49 
boŞ
 
®low_·¹Ÿl
 = 
çl£
;

50 
Ba£Flßt
 
acou¡ic_sÿË
 = 0.1;

51 
L©tiûSim¶eDecod”CÚfig
 
cÚfig
;

53 
¡d
::
¡ršg
 
wÜd_syms_f’ame
;

54 
cÚfig
.
	`Regi¡”
(&
po
);

55 
po
.
	`Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
, "Scaling factor for‡coustic†ikelihoods");

57 
po
.
	`Regi¡”
("wÜd-symbŞ-bË", &
wÜd_syms_f’ame
, "Symbolable for words [for debug output]");

58 
po
.
	`Regi¡”
("®low-·¹Ÿl", &
®low_·¹Ÿl
, "Ifrue,…roduce outputƒven ifƒnd state was‚ot„eached.");

60 
po
.
	`R—d
(
¬gc
, 
¬gv
);

62 ià(
po
.
	`NumArgs
() < 4 ||…o.NumArgs() > 6) {

63 
po
.
	`PrštU§ge
();

64 
	`ex™
(1);

67 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

68 
f¡_š_f’ame
 = 
po
.
	`G‘Arg
(2),

69 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

70 
Ï‰iû_w¥ecif›r
 = 
po
.
	`G‘Arg
(4),

71 
wÜds_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(5),

72 
®ignm’t_w¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

74 
T¿ns™iÚMod–
 
Œªs_mod–
;

75 
AmDŸgGmm
 
am_gmm
;

77 
boŞ
 
bš¬y
;

78 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y
);

79 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

80 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

83 
F¡
<
StdArc
> *
decode_f¡
 = 
f¡
::
	`R—dF¡K®diG’”ic
(
f¡_š_f’ame
);

85 
boŞ
 
d‘”mšize
 = 
cÚfig
.
d‘”mšize_Ï‰iû
;

86 
Com·ùL©tiûWr™”
 
com·ù_Ï‰iû_wr™”
;

87 
L©tiûWr™”
 
Ï‰iû_wr™”
;

88 ià(! (
d‘”mšize
 ? 
com·ù_Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)

89 : 
Ï‰iû_wr™”
.
	`O³n
(
Ï‰iû_w¥ecif›r
)))

90 
KALDI_ERR
 << "Could‚ot openable for writing†attices: "

91 << 
Ï‰iû_w¥ecif›r
;

93 
IÁ32VeùÜWr™”
 
	`wÜds_wr™”
(
wÜds_w¥ecif›r
);

95 
IÁ32VeùÜWr™”
 
	`®ignm’t_wr™”
(
®ignm’t_w¥ecif›r
);

97 
f¡
::
SymbŞTabË
 *
wÜd_syms
 = 
NULL
;

98 ià(
wÜd_syms_f’ame
 != "")

99 ià(!(
wÜd_syms
 = 
f¡
::
SymbŞTabË
::
	`R—dText
(
wÜd_syms_f’ame
)))

100 
KALDI_ERR
 << "Could‚ot„ead symbolable from file "

101 << 
wÜd_syms_f’ame
;

103 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

105 
Ba£Flßt
 
tÙ_like
 = 0.0;

106 
k®di
::
št64
 
äame_couÁ
 = 0;

107 
num_sucûss
 = 0, 
num_ç
 = 0;

108 
L©tiûSim¶eDecod”
 
	`decod”
(*
decode_f¡
, 
cÚfig
);

110 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

111 
¡d
::
¡ršg
 
u‰
 = 
ã©u»_»ad”
.
	`Key
();

112 
M©rix
<
Ba£Flßt
> 
	`ã©u»s
 (
ã©u»_»ad”
.
	`V®ue
());

113 
ã©u»_»ad”
.
	`F»eCu¼’t
();

114 ià(
ã©u»s
.
	`NumRows
() == 0) {

115 
KALDI_WARN
 << "Z”o-Ëngth u‰”ªû: " << 
u‰
;

116 
num_ç
++;

120 
DecodabËAmDŸgGmmSÿËd
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©u»s
,

121 
acou¡ic_sÿË
);

123 
like
;

124 ià(
	`DecodeU‰”ªûL©tiûSim¶e
(

125 
decod”
, 
gmm_decodabË
, 
Œªs_mod–
, 
wÜd_syms
, 
u‰
,

126 
acou¡ic_sÿË
, 
d‘”mšize
, 
®low_·¹Ÿl
, &
®ignm’t_wr™”
,

127 &
wÜds_wr™”
, &
com·ù_Ï‰iû_wr™”
, &
Ï‰iû_wr™”
, &
like
)) {

128 
tÙ_like
 +ğ
like
;

129 
äame_couÁ
 +ğ
ã©u»s
.
	`NumRows
();

130 
num_sucûss
++;

131 } 
num_ç
++;

134 
–­£d
 = 
tim”
.
	`EÏp£d
();

135 
KALDI_LOG
 << "Timk’ "<< 
–­£d


137 << (
–­£d
*100.0/
äame_couÁ
);

138 
KALDI_LOG
 << "DÚ" << 
num_sucûss
 << " utterances, failed for "

139 << 
num_ç
;

140 
KALDI_LOG
 << "Ov”®Èlog-lik–ihood…” f¿mi " << (
tÙ_like
/
äame_couÁ
) << " over "

141 << 
äame_couÁ
<<" frames.";

143 
d–‘e
 
decode_f¡
;

144 
d–‘e
 
wÜd_syms
;

145 ià(
num_sucûss
 != 0)  0;

147 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

148 
¡d
::
û¼
 << 
e
.
	`wh©
();

151 
	}
}

	@gmm-make-regtree.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/k®di-io.h
"

22 
	~"ut/‹xt-uts.h
"

23 
	~"gmm/mË-am-dŸg-gmm.h
"

24 
	~"Œ“/cÚ‹xt-d•.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"ŒªsfÜm/»g»ssiÚ-Œ“.h
"

29 
	$maš
(
¬gc
, *
¬gv
[]) {

30 
Œy
 {

31 
k®di
::
	tšt32
 int32;

32 
k®di
::
	tBa£Flßt
 BaseFloat;

34 cÚ¡ *
u§ge
 =

40 
¡d
::
¡ršg
 
occs_š_f’ame
;

41 
¡d
::
¡ršg
 
s_phÚes_¡r
;

42 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

43 
št32
 
max_Ëaves
 = 1;

44 
k®di
::
P¬£O±iÚs
 
	`po
(
u§ge
);

45 
po
.
	`Regi¡”
("¡©e-occs", &
occs_š_f’ame
, "File containing state occupancies (use --write-occs in gmm-est)");

46 
po
.
	`Regi¡”
("s-phÚes", &
s_phÚes_¡r
, "Colon-separated†ist of integer ids of silence…hones,ƒ.g. 1:2:3; if used, createop-level speech/sil split (only one„eg-class for silence).");

47 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

48 
po
.
	`Regi¡”
("max-Ëaves", &
max_Ëaves
, "Maximum‚umber of†eaves in„egressionree.");

49 
po
.
	`R—d
(
¬gc
, 
¬gv
);

51 ià(
po
.
	`NumArgs
() != 2) {

52 
po
.
	`PrštU§ge
();

53 
	`ex™
(1);

56 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

57 
Œ“_out_f’ame
 = 
po
.
	`G‘Arg
(2);

59 
k®di
::
AmDŸgGmm
 
am_gmm
;

60 
k®di
::
T¿ns™iÚMod–
 
Œªs_mod–
;

62 
boŞ
 
bš¬y_»ad
;

63 
k®di
::
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

64 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

65 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

68 
k®di
::
VeùÜ
<
Ba£Flßt
> 
¡©e_occs
;

69 ià(
occs_š_f’ame
 != "") {

70 
boŞ
 
bš¬y_»ad
;

71 
k®di
::
IÅut
 
	`ki
(
occs_š_f’ame
, &
bš¬y_»ad
);

72 
¡©e_occs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

74 
KALDI_LOG
 << "--state-occs option‚ot…rovided so using constant occupancies.";

75 
¡©e_occs
.
	`Resize
(
am_gmm
.
	`NumPdfs
());

76 
¡©e_occs
.
	`S‘
(1.0);

79 
¡d
::
veùÜ
<
št32
> 
s_pdfs
;

80 ià(
s_phÚes_¡r
 != "") {

81 
¡d
::
veùÜ
<
št32
> 
s_phÚes
;

82 ià(!
k®di
::
	`S¶™SŒšgToIÁeg”s
(
s_phÚes_¡r
, ":", 
çl£
, &
s_phÚes
))

83 
KALDI_ERR
 << "šv®id s-phÚe İtiÚ " << 
s_phÚes_¡r
;

84 
¡d
::
	`sÜt
(
s_phÚes
.
	`begš
(), s_phÚes.
	`’d
());

85 
boŞ
 
ªs
 = 
	`G‘PdfsFÜPhÚes
(
Œªs_mod–
, 
s_phÚes
, &
s_pdfs
);

86 ià(!
ªs
)

87 
KALDI_WARN
 << "Pdfs‡ssociated with silence…hones‡re‚ot only "

92 
k®di
::
Reg»ssiÚT»e
 
»gŒ“
;

93 
»gŒ“
.
	`BudT»e
(
¡©e_occs
, 
s_pdfs
, 
am_gmm
, 
max_Ëaves
);

96 
k®di
::
Ouut
 
	`ko
(
Œ“_out_f’ame
, 
bš¬y_wr™e
);

97 
»gŒ“
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

100 
KALDI_LOG
 << "Wr™‹À»g»ssiÚ»tØ" << 
Œ“_out_f’ame
;

101 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

102 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

105 
	}
}

	@gmm-mixup.cc

20 
	~"ba£/k®di-commÚ.h
"

21 
	~"ut/commÚ-uts.h
"

22 
	~"gmm/am-dŸg-gmm.h
"

23 
	~"Œ“/cÚ‹xt-d•.h
"

24 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	~"gmm/mË-am-dŸg-gmm.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
k®di
::
	tšt32
 int32;

32 cÚ¡ *
u§ge
 =

40 
boŞ
 
bš¬y_wr™e
 = 
Œue
;

41 
št32
 
mixup
 = 0;

42 
št32
 
mixdown
 = 0;

43 
Ba£Flßt
 
³¹urb_çùÜ
 = 0.01;

44 
Ba£Flßt
 
pow”
 = 0.2;

45 
Ba£Flßt
 
mš_couÁ
 = 20.0;

47 
P¬£O±iÚs
 
	`po
(
u§ge
);

48 
po
.
	`Regi¡”
("bš¬y", &
bš¬y_wr™e
, "Write output in binary mode");

49 
po
.
	`Regi¡”
("mix-up", &
mixup
, "Increase‚umber of mixture componentso "

51 
po
.
	`Regi¡”
("mš-couÁ", &
mš_couÁ
,

53 
po
.
	`Regi¡”
("mix-down", &
mixdown
, "If‚onzero, merge mixture componentsohis "

55 
po
.
	`Regi¡”
("pow”", &
pow”
, "If mixing up,…owero‡llocate Gaussianso"

57 
po
.
	`Regi¡”
("³¹urb-çùÜ", &
³¹urb_çùÜ
, "While mixing up,…erturb "

60 
po
.
	`R—d
(
¬gc
, 
¬gv
);

62 ià(
po
.
	`NumArgs
() != 3) {

63 
po
.
	`PrštU§ge
();

64 
	`ex™
(1);

68 
¡d
::
¡ršg
 
mod–_š_f’ame
 = 
po
.
	`G‘Arg
(1),

69 
occs_š_f’ame
 = 
po
.
	`G‘Arg
(2),

70 
mod–_out_f’ame
 = 
po
.
	`G‘Arg
(3);

72 
AmDŸgGmm
 
am_gmm
;

73 
T¿ns™iÚMod–
 
Œªs_mod–
;

75 
boŞ
 
bš¬y_»ad
;

76 
IÅut
 
	`ki
(
mod–_š_f’ame
, &
bš¬y_»ad
);

77 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

78 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

81 ià(
mixup
 !ğ0 || 
mixdown
 != 0) {

83 
VeùÜ
<
Ba£Flßt
> 
occs
;

84 
	`R—dK®diObjeù
(
occs_š_f’ame
, &
occs
);

85 ià(
occs
.
	`Dim
(è!ğ
am_gmm
.
	`NumPdfs
())

86 
KALDI_ERR
 << "Dim’siÚ oà¡©occu·nc› " << 
occs
.
	`Dim
()

87 << " dÛ nÙ m©ch‚um-pdf " << 
am_gmm
.
	`NumPdfs
();

89 ià(
mixdown
 != 0)

90 
am_gmm
.
	`M”geByCouÁ
(
occs
, 
mixdown
, 
pow”
, 
mš_couÁ
);

92 ià(
mixup
 != 0)

93 
am_gmm
.
	`S¶™ByCouÁ
(
occs
, 
mixup
, 
³¹urb_çùÜ
,

94 
pow”
, 
mš_couÁ
);

98 
Ouut
 
	`ko
(
mod–_out_f’ame
, 
bš¬y_wr™e
);

99 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

100 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y_wr™e
);

103 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_f’ame
;

104 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

105 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

108 
	}
}

	@gmm-post-to-gpost.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"hmm/po¡”iÜ.h
"

28 
	$maš
(
¬gc
, *
¬gv
[]) {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
Œy
 {

31 cÚ¡ *
u§ge
 =

38 
P¬£O±iÚs
 
	`po
(
u§ge
);

39 
boŞ
 
bš¬y
 = 
Œue
;

40 
Ba£Flßt
 
¿nd_´uÃ
 = 0.0;

41 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

42 
po
.
	`Regi¡”
("¿nd-´uÃ", &
¿nd_´uÃ
, "Randomized…runing of…osteriors†esshanhis");

43 
po
.
	`R—d
(
¬gc
, 
¬gv
);

45 ià(
po
.
	`NumArgs
() != 4) {

46 
po
.
	`PrštU§ge
();

47 
	`ex™
(1);

50 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

51 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

52 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

53 
gpo¡_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

55 
usšg
 
Çme¥aû
 
k®di
;

56 
k®di
::
	tšt32
 int32;

58 
AmDŸgGmm
 
am_gmm
;

59 
T¿ns™iÚMod–
 
Œªs_mod–
;

61 
boŞ
 
bš¬y
;

62 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

63 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

64 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

67 
tÙ_like
 = 0.0;

68 
tÙ_t
 = 0.0;

70 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

71 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡”iÜs_»ad”
(
po¡”iÜs_r¥ecif›r
);

73 
GaussPo¡Wr™”
 
	`gpo¡_wr™”
(
gpo¡_w¥ecif›r
);

75 
št32
 
num_dÚe
 = 0, 
num_no_po¡”iÜ
 = 0, 
num_Ùh”_”rÜ
 = 0;

76 ; !
ã©u»_»ad”
.
	`DÚe
(); f—tu»_»ad”.
	`Next
()) {

77 
¡d
::
¡ršg
 
key
 = 
ã©u»_»ad”
.
	`Key
();

78 ià(!
po¡”iÜs_»ad”
.
	`HasKey
(
key
)) {

79 
num_no_po¡”iÜ
++;

81 cÚ¡ 
M©rix
<
Ba£Flßt
> &
m©
 = 
ã©u»_»ad”
.
	`V®ue
();

82 cÚ¡ 
Po¡”iÜ
 &
po¡”iÜ
 = 
po¡”iÜs_»ad”
.
	`V®ue
(
key
);

83 
GaussPo¡
 
	`gpo¡
(
po¡”iÜ
.
	`size
());

85 ià(
po¡”iÜ
.
	`size
(è!ğ
m©
.
	`NumRows
()) {

86 
KALDI_WARN
 << "Po¡”iÜ veùÜ ha wrÚg siz"<< (
po¡”iÜ
.
	`size
()è<< " vs. "<< (
m©
.
	`NumRows
());

87 
num_Ùh”_”rÜ
++;

91 
num_dÚe
++;

92 
Ba£Flßt
 
tÙ_like_this_fe
 = 0.0, 
tÙ_weight
 = 0.0;

94 
Po¡”iÜ
 
pdf_po¡”iÜ
;

95 
	`CÚv”tPo¡”iÜToPdfs
(
Œªs_mod–
, 
po¡”iÜ
, &
pdf_po¡”iÜ
);

96 
size_t
 
i
 = 0; i < 
po¡”iÜ
.
	`size
(); i++) {

97 
gpo¡
[
i
].
	`»£rve
(
pdf_po¡”iÜ
[i].
	`size
());

98 
size_t
 
j
 = 0; j < 
pdf_po¡”iÜ
[
i
].
	`size
(); j++) {

99 
št32
 
pdf_id
 = 
pdf_po¡”iÜ
[
i
][
j
].
fœ¡
;

100 
Ba£Flßt
 
weight
 = 
pdf_po¡”iÜ
[
i
][
j
].
£cÚd
;

101 cÚ¡ 
DŸgGmm
 &
gmm
 = 
am_gmm
.
	`G‘Pdf
(
pdf_id
);

102 
VeùÜ
<
Ba£Flßt
> 
this_po¡_vec
;

103 
Ba£Flßt
 
like
 =

104 
gmm
.
	`CompÚ’tPo¡”iÜs
(
m©
.
	`Row
(
i
), &
this_po¡_vec
);

105 
this_po¡_vec
.
	`SÿË
(
weight
);

106 ià(
¿nd_´uÃ
 > 0.0)

107 
št32
 
k
 = 0; k < 
this_po¡_vec
.
	`Dim
(); k++)

108 
	`this_po¡_vec
(
k
èğ
	`RªdPruÃ
(this_post_vec(k),

109 
¿nd_´uÃ
);

110 ià(!
this_po¡_vec
.
	`IsZ”o
())

111 
gpo¡
[
i
].
	`push_back
(
¡d
::
	`make_·œ
(
pdf_id
, 
this_po¡_vec
));

112 
tÙ_like_this_fe
 +ğ
like
 * 
weight
;

113 
tÙ_weight
 +ğ
weight
;

116 
	`KALDI_VLOG
(1) << "Average†ike forhis file is "

117 << (
tÙ_like_this_fe
/
tÙ_weight
) << " over "

118 << 
tÙ_weight
 <<" frames.";

119 
tÙ_like
 +ğ
tÙ_like_this_fe
;

120 
tÙ_t
 +ğ
tÙ_weight
;

121 
gpo¡_wr™”
.
	`Wr™e
(
key
, 
gpo¡
);

124 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << " fes, " << 
num_no_po¡”iÜ


125 << " w™h‚Øpo¡”iÜs, " << 
num_Ùh”_”rÜ


128 
KALDI_LOG
 << "Overall‡vg†ike…er frame (Gaussian only) = "

129 << (
tÙ_like
/
tÙ_t
) << " over " <<ot_t << " frames.";

131 
KALDI_LOG
 << "Done converting…osto gpost";

132 ià(
num_dÚe
 != 0)  0;

134 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

135 
¡d
::
û¼
 << 
e
.
	`wh©
();

138 
	}
}

	@gmm-rescore-lattice.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"ut/¡l-uts.h
"

24 
	~"gmm/am-dŸg-gmm.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"f¡ext/f¡ext-lib.h
"

27 
	~"Ït/k®di-Ï‰iû.h
"

28 
	~"Ït/Ï‰iû-funùiÚs.h
"

29 
	~"gmm/decodabË-am-dŸg-gmm.h
"

31 
	$maš
(
¬gc
, *
¬gv
[]) {

32 
Œy
 {

33 
usšg
 
Çme¥aû
 
k®di
;

34 
k®di
::
	tšt32
 int32;

35 
k®di
::
	tšt64
 int64;

36 
usšg
 
f¡
::
SymbŞTabË
;

37 
usšg
 
f¡
::
VeùÜF¡
;

38 
usšg
 
f¡
::
StdArc
;

40 cÚ¡ *
u§ge
 =

46 
k®di
::
Ba£Flßt
 
Şd_acou¡ic_sÿË
 = 0.0;

47 
k®di
::
P¬£O±iÚs
 
	`po
(
u§ge
);

48 
po
.
	`Regi¡”
("Şd-acou¡ic-sÿË", &
Şd_acou¡ic_sÿË
,

51 
po
.
	`R—d
(
¬gc
, 
¬gv
);

53 ià(
po
.
	`NumArgs
() != 4) {

54 
po
.
	`PrštU§ge
();

55 
	`ex™
(1);

58 
¡d
::
¡ršg
 
mod–_f’ame
 = 
po
.
	`G‘Arg
(1),

59 
Ïts_r¥ecif›r
 = 
po
.
	`G‘Arg
(2),

60 
ã©u»_r¥ecif›r
 = 
po
.
	`G‘Arg
(3),

61 
Ïts_w¥ecif›r
 = 
po
.
	`G‘Arg
(4);

63 
AmDŸgGmm
 
am_gmm
;

64 
T¿ns™iÚMod–
 
Œªs_mod–
;

66 
boŞ
 
bš¬y
;

67 
IÅut
 
	`ki
(
mod–_f’ame
, &
bš¬y
);

68 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

69 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y
);

72 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`ã©u»_»ad”
(
ã©u»_r¥ecif›r
);

74 
Sequ’tŸlCom·ùL©tiûR—d”
 
	`com·ù_Ï‰iû_»ad”
(
Ïts_r¥ecif›r
);

76 
Com·ùL©tiûWr™”
 
	`com·ù_Ï‰iû_wr™”
(
Ïts_w¥ecif›r
);

78 
št32
 
num_dÚe
 = 0, 
num_”r
 = 0;

79 
št64
 
num_äames
 = 0;

80 ; !
com·ù_Ï‰iû_»ad”
.
	`DÚe
(); com·ù_Ï‰iû_»ad”.
	`Next
()) {

81 
¡d
::
¡ršg
 
key
 = 
com·ù_Ï‰iû_»ad”
.
	`Key
();

82 ià(!
ã©u»_»ad”
.
	`HasKey
(
key
)) {

83 
KALDI_WARN
 << "NØã©u» found fÜ u‰”ªû " << 
key
 << ". Skipping";

84 
num_”r
++;

88 
Com·ùL©tiû
 
ş©
 = 
com·ù_Ï‰iû_»ad”
.
	`V®ue
();

89 
com·ù_Ï‰iû_»ad”
.
	`F»eCu¼’t
();

90 ià(
Şd_acou¡ic_sÿË
 != 1.0)

91 
f¡
::
	`SÿËL©tiû
(f¡::
	`Acou¡icL©tiûSÿË
(
Şd_acou¡ic_sÿË
), &
ş©
);

93 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
 = 
ã©u»_»ad”
.
	`V®ue
(
key
);

95 
DecodabËAmDŸgGmm
 
	`gmm_decodabË
(
am_gmm
, 
Œªs_mod–
, 
ã©s
);

96 ià(
k®di
::
	`RescÜeCom·ùL©tiû
(&
gmm_decodabË
, &
ş©
)) {

97 
com·ù_Ï‰iû_wr™”
.
	`Wr™e
(
key
, 
ş©
);

98 
num_dÚe
++;

99 
num_äames
 +ğ
ã©s
.
	`NumRows
();

100 } 
num_”r
++;

103 
KALDI_LOG
 << "DÚ" << 
num_dÚe
 << "†attices withƒrrors on "

104 << 
num_”r
 << ", #äame i " << 
num_äames
;

105  (
num_dÚe
 != 0 ? 0 : 1);

106 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

107 
¡d
::
û¼
 << 
e
.
	`wh©
();

110 
	}
}

	@gmm-sum-accs.cc

20 
	~"ut/commÚ-uts.h
"

21 
	~"gmm/mË-am-dŸg-gmm.h
"

22 
	~"hmm/Œªs™iÚ-mod–.h
"

25 
	$maš
(
¬gc
, *
¬gv
[]) {

26 
Œy
 {

27 
k®di
::
	tšt32
 int32;

29 cÚ¡ *
u§ge
 =

34 
boŞ
 
bš¬y
 = 
Œue
;

35 
k®di
::
P¬£O±iÚs
 
	`po
(
u§ge
);

36 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

37 
po
.
	`R—d
(
¬gc
, 
¬gv
);

39 ià(
po
.
	`NumArgs
() < 2) {

40 
po
.
	`PrštU§ge
();

41 
	`ex™
(1);

44 
¡d
::
¡ršg
 
¡©s_out_f’ame
 = 
po
.
	`G‘Arg
(1);

45 
k®di
::
VeùÜ
<> 
Œªs™iÚ_accs
;

46 
k®di
::
AccumAmDŸgGmm
 
gmm_accs
;

48 
num_accs
 = 
po
.
	`NumArgs
() - 1;

49 
i
 = 2, 
max
 = 
po
.
	`NumArgs
(); i <= max; i++) {

50 
¡d
::
¡ršg
 
¡©s_š_f’ame
 = 
po
.
	`G‘Arg
(
i
);

51 
boŞ
 
bš¬y_»ad
;

52 
k®di
::
IÅut
 
	`ki
(
¡©s_š_f’ame
, &
bš¬y_»ad
);

53 
Œªs™iÚ_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
Œue
 );

54 
gmm_accs
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
, 
Œue
 );

59 
k®di
::
Ouut
 
	`ko
(
¡©s_out_f’ame
, 
bš¬y
);

60 
Œªs™iÚ_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

61 
gmm_accs
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

63 
KALDI_LOG
 << "Summed " << 
num_accs
 << " stats,otal count "

64 << 
gmm_accs
.
	`TÙCouÁ
() << ",‡vg†ike/frame "

65 << (
gmm_accs
.
	`TÙLogLike
(è/ gmm_accs.
	`TÙCouÁ
());

66 
KALDI_LOG
 << "TÙ® couÁ oà¡© i " << 
gmm_accs
.
	`TÙStsCouÁ
();

67 
KALDI_LOG
 << "Wr™‹À¡© tØ" << 
¡©s_out_f’ame
;

68 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

69 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

72 
	}
}

	@gmm-train-lvtln-special.cc

22 
	~"ba£/k®di-commÚ.h
"

23 
	~"ut/commÚ-uts.h
"

24 
	~"ŒªsfÜm/lvn.h
"

25 
	~"hmm/po¡”iÜ.h
"

27 
	$maš
(
¬gc
, *
¬gv
[]) {

28 
Œy
 {

29 
usšg
 
Çme¥aû
 
k®di
;

30 
usšg
 
k®di
::
št32
;

32 cÚ¡ *
u§ge
 =

41 
Ba£Flßt
 
w¬p
 = -1.0;

42 
boŞ
 
bš¬y
 = 
Œue
;

43 
boŞ
 
nÜm®ize_v¬
 = 
çl£
;

44 
boŞ
 
nÜm®ize_cov¬
 = 
çl£
;

45 
¡d
::
¡ršg
 
weights_r¥ecif›r
;

47 
P¬£O±iÚs
 
	`po
(
u§ge
);

48 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

49 
po
.
	`Regi¡”
("w¬p", &
w¬p
, "If supplied, can be usedo set warp factor"

51 
po
.
	`Regi¡”
("nÜm®ize-v¬", &
nÜm®ize_v¬
, "Normalize diagonal of variance "

53 
po
.
	`Regi¡”
("nÜm®ize-cov¬", &
nÜm®ize_cov¬
, "Normalize (matrix-valued) "

55 
po
.
	`Regi¡”
("weights-š", &
weights_r¥ecif›r
,

59 
po
.
	`R—d
(
¬gc
, 
¬gv
);

61 ià(
po
.
	`NumArgs
() < 5 ||…o.NumArgs() > 6) {

62 
po
.
	`PrštU§ge
();

63 
	`ex™
(1);

66 
¡d
::
¡ršg
 
şass_idx_¡r
 = 
po
.
	`G‘Arg
(1);

67 
št32
 
şass_idx
;

68 ià(!
	`CÚv”tSŒšgToIÁeg”
(
şass_idx_¡r
, &
şass_idx
))

69 
KALDI_ERR
 << "Ex³ùed iÁeg” fœ¡‡rgum’t: gÙ " << 
şass_idx_¡r
;

71 
¡d
::
¡ršg
 
lvn_rxf’ame
 = 
po
.
	`G‘Arg
(2),

72 
lvn_wxf’ame
 = 
po
.
	`G‘Arg
(3),

73 
ã©s_Üig_r¥ecif›r
 = 
po
.
	`G‘Arg
(4),

74 
ã©s_ŒªsfÜmed_r¥ecif›r
 = 
po
.
	`G‘Arg
(5),

75 
po¡”iÜs_r¥ecif›r
 = 
po
.
	`G‘O±Arg
(6);

78 
Lš—rVn
 
lvn
;

79 
	`R—dK®diObjeù
(
lvn_rxf’ame
, &
lvn
);

80 
št32
 
dim
 = 
lvn
.
	`Dim
();

83 ià(!
nÜm®ize_cov¬
) {

106 
SpM©rix
<> 
	`Q
(
dim
+1);

107 
M©rix
<> 
	`l
(
dim
, dim+1);

108 
VeùÜ
<> 
	`c
(
dim
);

109 
b‘a
 = 0.0;

110 
VeùÜ
<> 
	`sum_x¶us
(
dim
+1);

111 
VeùÜ
<> 
	`sumsq_x
(
dim
);

112 
VeùÜ
<> 
	`sumsq_diff
(
dim
);

114 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`x_»ad”
(
ã©s_Üig_r¥ecif›r
);

115 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`y_»ad”
(
ã©s_ŒªsfÜmed_r¥ecif›r
);

117 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡”iÜs_r¥ecif›r
);

118 
RªdomAcûssBa£FlßtVeùÜR—d”
 
	`weights_»ad”
(
weights_r¥ecif›r
);

120 ; !
x_»ad”
.
	`DÚe
(); x_»ad”.
	`Next
()) {

121 
¡d
::
¡ršg
 
u‰
 = 
x_»ad”
.
	`Key
();

122 ià(!
y_»ad”
.
	`HasKey
(
u‰
)) {

123 
KALDI_WARN
 << "NØŒªsfÜmed f—tu» fÜ key " << 
u‰
;

126 cÚ¡ 
M©rix
<
Ba£Flßt
> &
x_ã©s
 = 
x_»ad”
.
	`V®ue
();

127 cÚ¡ 
M©rix
<
Ba£Flßt
> &
y_ã©s
 = 
y_»ad”
.
	`V®ue
(
u‰
);

128 ià(
x_ã©s
.
	`NumRows
(è!ğ
y_ã©s
.NumRows() ||

129 
x_ã©s
.
	`NumCŞs
(è!ğ
y_ã©s
.NumCols() ||

130 
x_ã©s
.
	`NumCŞs
(è!ğ
dim
) {

131 
KALDI_ERR
 << "Number of„ows‡nd/or columns differs in features, or features have different dim from†vtln object";

134 
VeùÜ
<
Ba£Flßt
> 
	`weights
(
x_ã©s
.
	`NumRows
());

135 ià(
weights_r¥ecif›r
 =ğ"" && 
po¡”iÜs_r¥ecif›r
 != "") {

136 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

137 
KALDI_WARN
 << "NØpo¡”iÜ fÜ u‰”ªû " << 
u‰
;

140 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

141 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
x_ã©s
.
	`NumRows
())

142 
KALDI_ERR
 << "Mismatch in size of…osterior";

143 
size_t
 
i
 = 0; i < 
po¡
.
	`size
(); i++)

144 
size_t
 
j
 = 0; j < 
po¡
[
i
].
	`size
(); j++)

145 
	`weights
(
i
è+ğ
po¡
[i][
j
].
£cÚd
;

146 } ià(
weights_r¥ecif›r
 != "") {

147 ià(!
weights_»ad”
.
	`HasKey
(
u‰
)) {

148 
KALDI_WARN
 << "NØweight fÜ u‰”ªû " << 
u‰
;

151 
weights
.
	`CİyFromVec
(
weights_»ad”
.
	`V®ue
(
u‰
));

153 
weights
.
	`Add
(1.0);

158 
št32
 
i
 = 0; i < 
x_ã©s
.
	`NumRows
(); i++) {

159 
Ba£Flßt
 
weight
 = 
	`weights
(
i
);

160 
SubVeùÜ
<
Ba£Flßt
> 
	`x_row
(
x_ã©s
, 
i
);

161 
SubVeùÜ
<
Ba£Flßt
> 
	`y_row
(
y_ã©s
, 
i
);

162 
VeùÜ
<> 
	`x¶us_row_dbl
(
dim
+1);

163 
št32
 
j
 = 0; j < 
dim
; j++)

164 
	`x¶us_row_dbl
(
j
èğ
	`x_row
(j);

165 
	`x¶us_row_dbl
(
dim
) = 1.0;

166 
VeùÜ
<> 
	`y_row_dbl
(
y_row
);

167 
Q
.
	`AddVec2
(
weight
, 
x¶us_row_dbl
);

168 
l
.
	`AddVecVec
(
weight
, 
y_row_dbl
, 
x¶us_row_dbl
);

169 
b‘a
 +ğ
weight
;

170 
	`sum_x¶us
(
dim
è+ğ
weight
;

171 
št32
 
j
 = 0; j < 
dim
; j++) {

172 
	`sum_x¶us
(
j
è+ğ
weight
 * 
	`x_row
(j);

173 
	`sumsq_x
(
j
è+ğ
weight
 * 
	`x_row
(j)*x_row(j);

174 
	`sumsq_diff
(
j
è+ğ
weight
 * (
	`x_row
(j)-
	`y_row
(j)) * (x_row(j)-y_row(j));

175 
	`c
(
j
è+ğ
weight
 * 
	`y_row
(j)*y_row(j);

180 
M©rix
<
Ba£Flßt
> 
	`A
(
dim
, dim);

182 
SpM©rix
<> 
	`Qšv
(
Q
);

183 
Qšv
.
	`Inv”t
();

184 
št32
 
i
 = 0; i < 
dim
; i++) {

185 
VeùÜ
<> 
	`w_i
(
dim
+1);

186 
SubVeùÜ
<> 
	`l_i
(
l
, 
i
);

187 
w_i
.
	`AddSpVec
(1.0, 
Qšv
, 
l_i
, 0.0);

188 
SubVeùÜ
<> 
	`a_i
(
w_i
, 0, 
dim
);

189 
A
.
	`Row
(
i
).
	`CİyFromVec
(
a_i
);

191 
Ba£Flßt
 
”rÜ
 = (
	`VecSpVec
(
w_i
, 
Q
, w_iè- 2.0*
	`VecVec
(w_i, 
l_i
è+ 
	`c
(
i
)è/ 
b‘a
,

192 
sqdiff
 = 
	`sumsq_diff
(
i
è/ 
b‘a
,

193 
sÿ‰”
 = 
	`sumsq_x
(
i
è/ 
b‘a
;

195 
KALDI_LOG
 << "FÜ dim’siÚ " << 
i
 << ", sum-squaredƒrror in†inear‡pproximation is "

196 << 
”rÜ
 << ", v”su ã©u»-difã»nû " << 
sqdiff
 << ", orig-sumsq is "

197 << 
sÿ‰”
;

198 ià(
nÜm®ize_v¬
) {

199 
x_v¬
 = 
sÿ‰”
 - 
	`pow
(
	`sum_x¶us
(
i
è/ 
b‘a
, 2.0);

200 
y_v¬
 = 
	`VecSpVec
(
w_i
, 
Q
, w_i)/
b‘a


201 - 
	`pow
(
	`VecVec
(
w_i
, 
sum_x¶us
)/
b‘a
, 2.0);

202 
sÿË
 = 
	`sq¹
(
x_v¬
 / 
y_v¬
);

203 
KALDI_LOG
 << "FÜ dim’siÚ " << 
i


204 << ", v¬Ÿnû oàÜigš®‡nd¿nsfÜmed d©¨i " << 
x_v¬


205 << "‡nd " << 
y_v¬
 << "„espectively; scaling matrix„ow by "

206 << 
sÿË
 << "o makehemƒqual.";

207 
A
.
	`Row
(
i
).
	`SÿË
(
sÿË
);

210 
lvn
.
	`S‘T¿nsfÜm
(
şass_idx
, 
A
);

216 
T
 = 0.0;

217 
SpM©rix
<> 
	`XX
(
dim
);

218 
VeùÜ
<> 
	`x
(
dim
);

219 
VeùÜ
<> 
	`y
(
dim
);

220 
M©rix
<> 
	`XY
(
dim
, dim);

222 
Sequ’tŸlBa£FlßtM©rixR—d”
 
	`x_»ad”
(
ã©s_Üig_r¥ecif›r
);

223 
RªdomAcûssBa£FlßtM©rixR—d”
 
	`y_»ad”
(
ã©s_ŒªsfÜmed_r¥ecif›r
);

225 
RªdomAcûssPo¡”iÜR—d”
 
	`po¡_»ad”
(
po¡”iÜs_r¥ecif›r
);

227 ; !
x_»ad”
.
	`DÚe
(); x_»ad”.
	`Next
()) {

228 
¡d
::
¡ršg
 
u‰
 = 
x_»ad”
.
	`Key
();

229 ià(!
y_»ad”
.
	`HasKey
(
u‰
)) {

230 
KALDI_WARN
 << "NØŒªsfÜmed f—tu» fÜ key " << 
u‰
;

233 cÚ¡ 
M©rix
<
Ba£Flßt
> &
x_ã©s
 = 
x_»ad”
.
	`V®ue
();

234 cÚ¡ 
M©rix
<
Ba£Flßt
> &
y_ã©s
 = 
y_»ad”
.
	`V®ue
(
u‰
);

235 ià(
x_ã©s
.
	`NumRows
(è!ğ
y_ã©s
.NumRows() ||

236 
x_ã©s
.
	`NumCŞs
(è!ğ
y_ã©s
.NumCols() ||

237 
x_ã©s
.
	`NumCŞs
(è!ğ
dim
) {

238 
KALDI_ERR
 << "Number of„ows‡nd/or columns differs in features, or features have different dim from†vtln object";

241 
VeùÜ
<
Ba£Flßt
> 
	`weights
(
x_ã©s
.
	`NumRows
());

242 ià(
po¡”iÜs_r¥ecif›r
 != "") {

243 ià(!
po¡_»ad”
.
	`HasKey
(
u‰
)) {

244 
KALDI_WARN
 << "NØpo¡”iÜ fÜ u‰”ªû " << 
u‰
;

247 cÚ¡ 
Po¡”iÜ
 &
po¡
 = 
po¡_»ad”
.
	`V®ue
(
u‰
);

248 ià(
¡©ic_ÿ¡
<
št32
>(
po¡
.
	`size
()è!ğ
x_ã©s
.
	`NumRows
())

249 
KALDI_ERR
 << "Mismatch in size of…osterior";

250 
size_t
 
i
 = 0; i < 
po¡
.
	`size
(); i++)

251 
size_t
 
j
 = 0; j < 
po¡
[
i
].
	`size
(); j++)

252 
	`weights
(
i
è+ğ
po¡
[i][
j
].
£cÚd
;

253 } 
weights
.
	`Add
(1.0);

255 
št32
 
i
 = 0; i < 
x_ã©s
.
	`NumRows
(); i++) {

256 
Ba£Flßt
 
weight
 = 
	`weights
(
i
);

257 
SubVeùÜ
<
Ba£Flßt
> 
	`x_row
(
x_ã©s
, 
i
);

258 
SubVeùÜ
<
Ba£Flßt
> 
	`y_row
(
y_ã©s
, 
i
);

259 
VeùÜ
<> 
	`x_dbl
(
x_row
);

260 
VeùÜ
<> 
	`y_dbl
(
y_row
);

261 
T
 +ğ
weight
;

262 
XX
.
	`AddVec2
(
weight
, 
x_dbl
);

263 
x
.
	`AddVec
(
weight
, 
x_row
);

264 
y
.
	`AddVec
(
weight
, 
y_row
);

265 
XY
.
	`AddVecVec
(
weight
, 
x_dbl
, 
y_dbl
);

268 
	`KALDI_ASSERT
(
T
 > 0.0);

269 
VeùÜ
<> 
	`xb¬
(
x
); 
xb¬
.
	`SÿË
(1.0/
T
);

271 
SpM©rix
<> 
	`S
(
XX
); 
S
.
	`SÿË
(1.0/
T
);

272 
S
.
	`AddVec2
(-1.0, 
xb¬
);

273 
TpM©rix
<> 
	`C_
(
dim
);

274 
C_
.
	`ChŞesky
(
S
);

275 
TpM©rix
<> 
	`Cšv_
(
C_
);

276 
Cšv_
.
	`Inv”t
();

277 
M©rix
<> 
	`C
(
C_
);

278 
M©rix
<> 
	`Cšv
(
Cšv_
);

279 
M©rix
<> 
	`P0
(
XY
);

280 
P0
.
	`AddVecVec
(-1.0, 
xb¬
, 
y
);

281 
M©rix
<> 
	`P
(
dim
, dim), 
	`tmp
(dim, dim);

282 
tmp
.
	`AddM©M©
(1.0, 
P0
, 
kNoT¿ns
, 
Cšv
, 
kT¿ns
, 0.0);

283 
P
.
	`AddM©M©
(1.0, 
Cšv
, 
kNoT¿ns
, 
tmp
, kNoTrans, 0.0);

284 
VeùÜ
<> 
	`l
(
dim
);

285 
M©rix
<> 
	`U
(
dim
, dim), 
	`Vt
(dim, dim);

286 
P
.
	`Svd
(&
l
, &
U
, &
Vt
);

287 
l
.
	`SÿË
(1.0/
T
);

288 
KALDI_LOG
 << "SšguÏ¸v®ue oàP‡»: " << 
l
;

289 
M©rix
<> 
	`N
(
dim
, dim);

290 
N
.
	`AddM©M©
(1.0, 
Vt
, 
kT¿ns
, 
U
, kTrans, 0.0);

291 
M©rix
<> 
	`M
(
dim
, dim);

292 
tmp
.
	`AddM©M©
(1.0, 
N
, 
kNoT¿ns
, 
Cšv
, kNoTrans, 0.0);

293 
M
.
	`AddM©M©
(1.0, 
C
, 
kNoT¿ns
, 
tmp
, kNoTrans, 0.0);

294 
M©rix
<
Ba£Flßt
> 
	`Mf
(
M
);

295 
lvn
.
	`S‘T¿nsfÜm
(
şass_idx
, 
Mf
);

299 ià(
w¬p
 >= 0.0)

300 
lvn
.
	`S‘W¬p
(
şass_idx
, 
w¬p
);

303 
Ouut
 
	`ko
(
lvn_wxf’ame
, 
bš¬y
);

304 
lvn
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

307 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

308 
¡d
::
û¼
 << 
e
.
	`wh©
();

311 
	}
}

	@gmm-transform-means-global.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/dŸg-gmm.h
"

24 
	~"Œ“/cÚ‹xt-d•.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"ŒªsfÜm/mÎt.h
"

28 
	$maš
(
¬gc
, *
¬gv
[]) {

29 
Œy
 {

30 
usšg
 
Çme¥aû
 
k®di
;

31 
k®di
::
	tšt32
 int32;

33 cÚ¡ *
u§ge
 =

40 
boŞ
 
bš¬y
 = 
Œue
;

42 
P¬£O±iÚs
 
	`po
(
u§ge
);

43 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

45 
po
.
	`R—d
(
¬gc
, 
¬gv
);

47 ià(
po
.
	`NumArgs
() != 3) {

48 
po
.
	`PrštU§ge
();

49 
	`ex™
(1);

52 
¡d
::
¡ršg
 
m©_rxf’ame
 = 
po
.
	`G‘Arg
(1),

53 
gmm_š_rxf’ame
 = 
po
.
	`G‘Arg
(2),

54 
gmm_out_wxf’ame
 = 
po
.
	`G‘Arg
(3);

56 
M©rix
<
Ba£Flßt
> 
m©
;

57 
	`R—dK®diObjeù
(
m©_rxf’ame
, &
m©
);

59 
DŸgGmm
 
gmm
;

60 
	`R—dK®diObjeù
(
gmm_š_rxf’ame
, &
gmm
);

62 
št32
 
dim
 = 
gmm
.
	`Dim
();

63 ià(
m©
.
	`NumRows
(è!ğ
dim
)

64 
KALDI_ERR
 << "T¿nsfÜm m©rix ha " << 
m©
.
	`NumRows
() << "„ows but "

65 "mod– ha dim’siÚ " << 
gmm
.
	`Dim
();

66 ià(
m©
.
	`NumCŞs
(è!ğ
dim


67 && 
m©
.
	`NumCŞs
(è!ğ
dim
+1)

68 
KALDI_ERR
 << "T¿nsfÜm m©rix ha " << 
m©
.
	`NumCŞs
() << " columns but "

69 "mod– ha dim’siÚ " << 
gmm
.
	`Dim
() << " (neither‡†inear‚or‡n "

72 
M©rix
<
Ba£Flßt
> 
m—ns
;

73 
gmm
.
	`G‘M—ns
(&
m—ns
);

74 
M©rix
<
Ba£Flßt
> 
	`Ãw_m—ns
(
m—ns
.
	`NumRows
(), m—ns.
	`NumCŞs
());

75 ià(
m©
.
	`NumCŞs
(è=ğ
dim
) {

78 
Ãw_m—ns
.
	`AddM©M©
(1.0, 
m—ns
, 
kNoT¿ns
, 
m©
, 
kT¿ns
, 0.0);

80 
M©rix
<
Ba£Flßt
> 
	`m—ns_ext
(
m—ns
.
	`NumRows
(), m—ns.
	`NumCŞs
()+1);

81 
m—ns_ext
.
	`S‘
(1.0);

82 
SubM©rix
<
Ba£Flßt
> 
	`m—ns_·¹
(
m—ns_ext
, 0, 
m—ns
.
	`NumRows
(),

83 0, 
m—ns
.
	`NumCŞs
());

84 
m—ns_·¹
.
	`CİyFromM©
(
m—ns
);

85 
Ãw_m—ns
.
	`AddM©M©
(1.0, 
m—ns_ext
, 
kNoT¿ns
, 
m©
, 
kT¿ns
, 0.0);

87 
gmm
.
	`S‘M—ns
(
Ãw_m—ns
);

88 
gmm
.
	`Compu‹GcÚ¡s
();

90 
	`Wr™eK®diObjeù
(
gmm
, 
gmm_out_wxf’ame
, 
bš¬y
);

91 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
gmm_out_wxf’ame
;

93 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

94 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

97 
	}
}

	@gmm-transform-means.cc

21 
	~"ba£/k®di-commÚ.h
"

22 
	~"ut/commÚ-uts.h
"

23 
	~"gmm/am-dŸg-gmm.h
"

24 
	~"Œ“/cÚ‹xt-d•.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"ŒªsfÜm/mÎt.h
"

28 
	$maš
(
¬gc
, *
¬gv
[]) {

29 
Œy
 {

30 
usšg
 
Çme¥aû
 
k®di
;

31 
k®di
::
	tšt32
 int32;

33 cÚ¡ *
u§ge
 =

38 
boŞ
 
bš¬y
 = 
Œue
;

40 
P¬£O±iÚs
 
	`po
(
u§ge
);

41 
po
.
	`Regi¡”
("bš¬y", &
bš¬y
, "Write output in binary mode");

43 
po
.
	`R—d
(
¬gc
, 
¬gv
);

45 ià(
po
.
	`NumArgs
() != 3) {

46 
po
.
	`PrštU§ge
();

47 
	`ex™
(1);

50 
¡d
::
¡ršg
 
m©_rxf’ame
 = 
po
.
	`G‘Arg
(1),

51 
mod–_š_rxf’ame
 = 
po
.
	`G‘Arg
(2),

52 
mod–_out_wxf’ame
 = 
po
.
	`G‘Arg
(3);

54 
M©rix
<
Ba£Flßt
> 
m©
;

55 
	`R—dK®diObjeù
(
m©_rxf’ame
, &
m©
);

57 
AmDŸgGmm
 
am_gmm
;

58 
T¿ns™iÚMod–
 
Œªs_mod–
;

60 
boŞ
 
bš¬y_»ad
;

61 
IÅut
 
	`ki
(
mod–_š_rxf’ame
, &
bš¬y_»ad
);

62 
Œªs_mod–
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

63 
am_gmm
.
	`R—d
(
ki
.
	`SŒ—m
(), 
bš¬y_»ad
);

66 
št32
 
dim
 = 
am_gmm
.
	`Dim
();

67 ià(
m©
.
	`NumRows
(è!ğ
dim
)

68 
KALDI_ERR
 << "T¿nsfÜm m©rix ha " << 
m©
.
	`NumRows
() << "„ows but "

69 "mod– ha dim’siÚ " << 
am_gmm
.
	`Dim
();

70 ià(
m©
.
	`NumCŞs
(è!ğ
dim


71 && 
m©
.
	`NumCŞs
(è!ğ
dim
+1)

72 
KALDI_ERR
 << "T¿nsfÜm m©rix ha " << 
m©
.
	`NumCŞs
() << " columns but "

73 "mod– ha dim’siÚ " << 
am_gmm
.
	`Dim
() << " (neither‡†inear‚or‡n "

76 
št32
 
i
 = 0; i < 
am_gmm
.
	`NumPdfs
(); i++) {

77 
DŸgGmm
 &
gmm
 = 
am_gmm
.
	`G‘Pdf
(
i
);

79 
M©rix
<
Ba£Flßt
> 
m—ns
;

80 
gmm
.
	`G‘M—ns
(&
m—ns
);

81 
M©rix
<
Ba£Flßt
> 
	`Ãw_m—ns
(
m—ns
.
	`NumRows
(), m—ns.
	`NumCŞs
());

82 ià(
m©
.
	`NumCŞs
(è=ğ
dim
) {

85 
Ãw_m—ns
.
	`AddM©M©
(1.0, 
m—ns
, 
kNoT¿ns
, 
m©
, 
kT¿ns
, 0.0);

87 
M©rix
<
Ba£Flßt
> 
	`m—ns_ext
(
m—ns
.
	`NumRows
(), m—ns.
	`NumCŞs
()+1);

88 
m—ns_ext
.
	`S‘
(1.0);

89 
SubM©rix
<
Ba£Flßt
> 
	`m—ns_·¹
(
m—ns_ext
, 0, 
m—ns
.
	`NumRows
(),

90 0, 
m—ns
.
	`NumCŞs
());

91 
m—ns_·¹
.
	`CİyFromM©
(
m—ns
);

92 
Ãw_m—ns
.
	`AddM©M©
(1.0, 
m—ns_ext
, 
kNoT¿ns
, 
m©
, 
kT¿ns
, 0.0);

94 
gmm
.
	`S‘M—ns
(
Ãw_m—ns
);

95 
gmm
.
	`Compu‹GcÚ¡s
();

99 
Ouut
 
	`ko
(
mod–_out_wxf’ame
, 
bš¬y
);

100 
Œªs_mod–
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

101 
am_gmm
.
	`Wr™e
(
ko
.
	`SŒ—m
(), 
bš¬y
);

103 
KALDI_LOG
 << "Wr™‹Àmod–Ø" << 
mod–_out_wxf’ame
;

105 } 
	`ÿtch
(cÚ¡ 
¡d
::
exû±iÚ
 &
e
) {

106 
¡d
::
û¼
 << 
e
.
	`wh©
() << '\n';

109 
	}
}

	@
1
.
1
/usr/include
72
1624
gmm-acc-mllt-global.cc
gmm-acc-mllt.cc
gmm-acc-stats-ali.cc
gmm-acc-stats-twofeats.cc
gmm-acc-stats.cc
gmm-acc-stats2.cc
gmm-adapt-map.cc
gmm-align-compiled.cc
gmm-align.cc
gmm-basis-fmllr-accs-gpost.cc
gmm-basis-fmllr-accs.cc
gmm-basis-fmllr-training.cc
gmm-boost-silence.cc
gmm-compute-likes.cc
gmm-copy.cc
gmm-decode-biglm-faster.cc
gmm-decode-faster-regtree-fmllr.cc
gmm-decode-faster-regtree-mllr.cc
gmm-decode-faster.cc
gmm-decode-simple.cc
gmm-est-basis-fmllr-gpost.cc
gmm-est-basis-fmllr.cc
gmm-est-fmllr-global.cc
gmm-est-fmllr-gpost.cc
gmm-est-fmllr-raw-gpost.cc
gmm-est-fmllr-raw.cc
gmm-est-fmllr.cc
gmm-est-gaussians-ebw.cc
gmm-est-lvtln-trans.cc
gmm-est-map.cc
gmm-est-regtree-fmllr-ali.cc
gmm-est-regtree-fmllr.cc
gmm-est-regtree-mllr.cc
gmm-est-rescale.cc
gmm-est-weights-ebw.cc
gmm-est.cc
gmm-fmpe-acc-stats.cc
gmm-get-stats-deriv.cc
gmm-global-acc-stats-twofeats.cc
gmm-global-acc-stats.cc
gmm-global-copy.cc
gmm-global-est-fmllr.cc
gmm-global-est-lvtln-trans.cc
gmm-global-est.cc
gmm-global-get-frame-likes.cc
gmm-global-get-post.cc
gmm-global-gselect-to-post.cc
gmm-global-info.cc
gmm-global-init-from-feats.cc
gmm-global-sum-accs.cc
gmm-global-to-fgmm.cc
gmm-gselect.cc
gmm-info.cc
gmm-init-lvtln.cc
gmm-init-model-flat.cc
gmm-init-model.cc
gmm-init-mono.cc
gmm-ismooth-stats.cc
gmm-latgen-biglm-faster.cc
gmm-latgen-faster-parallel.cc
gmm-latgen-faster-regtree-fmllr.cc
gmm-latgen-faster.cc
gmm-latgen-map.cc
gmm-latgen-simple.cc
gmm-make-regtree.cc
gmm-mixup.cc
gmm-post-to-gpost.cc
gmm-rescore-lattice.cc
gmm-sum-accs.cc
gmm-train-lvtln-special.cc
gmm-transform-means-global.cc
gmm-transform-means.cc
