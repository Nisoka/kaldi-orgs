cscope 15 /nwork/svn/ai/sr/kaldi/src/nnet2               0000483785
	@am-nnet-test.cc

20 
	~"hmm/Œªs™iÚ-mod–.h
"

21 
	~"hmm/hmm-‹¡-uts.h
"

22 
	~"Â‘2/am-Â‘.h
"

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

29 
Un™Te¡AmNÃt
() {

30 
	g¡d
::
veùÜ
<
št32
> 
phÚes
;

31 
	gphÚes
.
push_back
(1);

32 
št32
 
	gi
 = 2; i < 20; i++)

33 ià(
¿nd
() % 2 == 0)

34 
phÚes
.
push_back
(
i
);

35 
št32
 
	gN
 = 2 + 
¿nd
() % 2,

36 
	gP
 = 
¿nd
(è% 
N
;

38 
	g¡d
::
veùÜ
<
št32
> 
num_pdf_şas£s
;

40 
CÚ‹xtD•’d’cy
 *
	gùx_d•
 =

41 
G’RªdCÚ‹xtD•’d’cyL¬ge
(
phÚes
, 
N
, 
P
,

42 
Œue
, &
num_pdf_şas£s
);

44 
HmmTİŞogy
 
	gtİo
 = 
G‘DeçuÉTİŞogy
(
phÚes
);

46 
T¿ns™iÚMod–
 
Œªs_mod–
(*
ùx_d•
, 
tİo
);

48 
d–‘e
 
	gùx_d•
;

49 
	gùx_d•
 = 
NULL
;

51 
št32
 
	gšput_dim
 = 40, 
	gouut_dim
 = 
Œªs_mod–
.
NumPdfs
();

52 
NÃt
 *
	gÂ‘
 = 
G’RªdomNÃt
(
šput_dim
, 
ouut_dim
);

54 
AmNÃt
 
am_Â‘
(*
Â‘
);

55 
d–‘e
 
	gÂ‘
;

56 
	gÂ‘
 = 
NULL
;

57 
	gVeùÜ
<
	gBa£Flßt
> 
´iÜs
(
ouut_dim
);

58 
	g´iÜs
.
S‘Rªdn
();

59 
	g´iÜs
.
AµlyExp
();

60 
	g´iÜs
.
SÿË
(1.0 / 
´iÜs
.
Sum
());

62 
	gam_Â‘
.
S‘PriÜs
(
´iÜs
);

64 
boŞ
 
	gbš¬y
 = (
¿nd
() % 2 == 0);

65 
	g¡d
::
o¡ršg¡»am
 
os
;

66 
	gam_Â‘
.
Wr™e
(
os
, 
bš¬y
);

67 
AmNÃt
 
	gam_Â‘2
;

68 
	g¡d
::
i¡ršg¡»am
 
is
(
os
.
¡r
());

69 
	gam_Â‘2
.
R—d
(
is
, 
bš¬y
);

71 
	g¡d
::
o¡ršg¡»am
 
os2
;

72 
	gam_Â‘2
.
Wr™e
(
os2
, 
bš¬y
);

74 
KALDI_ASSERT
(
os2
.
¡r
(è=ğ
os
.str());

81 
	$maš
() {

82 
usšg
 
Çme¥aû
 
k®di
;

83 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

85 
	`Un™Te¡AmNÃt
();

87 
	}
}

	@am-nnet.cc

20 
	~"Â‘2/am-Â‘.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

26 
	gAmNÃt
::
In™
(
¡d
::
i¡»am
 &
cÚfig_is
) {

27 
Â‘_
.
In™
(
cÚfig_is
);

31 
	gAmNÃt
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

35 
	gÂ‘_
.
Wr™e
(
os
, 
bš¬y
);

36 
	g´iÜs_
.
Wr™e
(
os
, 
bš¬y
);

39 
	gAmNÃt
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

40 
	gÂ‘_
.
R—d
(
is
, 
bš¬y
);

41 
	g´iÜs_
.
R—d
(
is
, 
bš¬y
);

44 
	gAmNÃt
::
S‘PriÜs
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
´iÜs
) {

45 
´iÜs_
 = 
´iÜs
;

46 ià(
	g´iÜs_
.
Dim
(è> 
NumPdfs
())

47 
	gKALDI_ERR
 << "Dimension of…riors cannotƒxceed‚umber of…dfs.";

49 ià(
	g´iÜs_
.
Dim
(è> 0 &&…riÜs_.Dim(è< 
NumPdfs
()) {

50 
	gKALDI_WARN
 << "Dim’siÚ oà´iÜ i " << 
	g´iÜs_
.
Dim
() << " < "

51 << 
NumPdfs
() << ":ƒxtending with zeros, in case you had "

53 
	g´iÜs_
.
Resize
(
NumPdfs
(), 
kCİyD©a
);

57 
	g¡d
::
¡ršg
 
AmNÃt
::
Info
() const {

58 
¡d
::
o¡ršg¡»am
 
o¡r
;

59 
	go¡r
 << "´iÜ dim’siÚ: " << 
	g´iÜs_
.
Dim
();

60 ià(
	g´iÜs_
.
Dim
() != 0) {

61 
o¡r
 << ",…riÜ sum: " << 
´iÜs_
.
Sum
(è<< ",…riÜ mš: " <<…riÜs_.
Mš
()

64  
	gÂ‘_
.
Info
(è+ 
	go¡r
.
¡r
();

67 
	gAmNÃt
::
In™
(cÚ¡ 
NÃt
 &
Â‘
) {

68 
Â‘_
 = 
Â‘
;

69 ià(
	g´iÜs_
.
Dim
(è!ğ0 && 
´iÜs_
.Dim(è!ğ
Â‘
.
OuutDim
()) {

70 
KALDI_WARN
 << "Initializing‚eural‚et:…rior dimension mismatch, "

72 
	g´iÜs_
.
Resize
(0);

76 
	gAmNÃt
::
ResizeOuutLay”
(
št32
 
Ãw_num_pdfs
) {

77 
Â‘_
.
ResizeOuutLay”
(
Ãw_num_pdfs
);

78 
	g´iÜs_
.
Resize
(
Ãw_num_pdfs
);

79 
	g´iÜs_
.
S‘
(1.0 / 
Ãw_num_pdfs
);

	@am-nnet.h

20 #iâdeà
KALDI_NNET2_AM_NNET_H_


21 
	#KALDI_NNET2_AM_NNET_H_


	)

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"m©rix/m©rix-lib.h
"

25 
	~"Â‘2/Â‘-Â‘.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

38 şas 
	cAmNÃt
 {

39 
	gpublic
:

40 
AmNÃt
() { }

42 
AmNÃt
(cÚ¡ AmNÃˆ&
Ùh”
): 
Â‘_
(Ùh”.Â‘_), 
´iÜs_
(other.priors_) { }

44 
ex¶ic™
 
AmNÃt
(cÚ¡ 
NÃt
 &
Â‘
): 
Â‘_
(nnet) { }

49 
In™
(
¡d
::
i¡»am
 &
cÚfig_is
);

53 
In™
(cÚ¡ 
NÃt
 &
Â‘
);

55 
št32
 
NumPdfs
(ècÚ¡ {  
	gÂ‘_
.
OuutDim
(); }

57 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

59 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

61 cÚ¡ 
	gNÃt
 &
G‘NÃt
(ècÚ¡ {  
	gÂ‘_
; }

63 
	gNÃt
 &
G‘NÃt
(è{  
	gÂ‘_
; }

65 
S‘PriÜs
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
´iÜs
);

67 cÚ¡ 
	gVeùÜBa£
<
	gBa£Flßt
> &
PriÜs
(ècÚ¡ {  
	g´iÜs_
; }

69 
	g¡d
::
¡ršg
 
Info
() const;

73 
ResizeOuutLay”
(
št32
 
Ãw_num_pdfs
);

75 
	g´iv©e
:

76 cÚ¡ 
AmNÃt
 &
İ”©Ü
 = (cÚ¡ AmNÃˆ&
Ùh”
);

77 
NÃt
 
	gÂ‘_
;

78 
	gVeùÜ
<
	gBa£Flßt
> 
	g´iÜs_
;

	@combine-nnet-a.cc

20 
	~"Â‘2/combše-Â‘-a.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

31 
G‘Upd©eDœeùiÚ
(cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

32 
NÃt
 *
dœeùiÚ
) {

33 
KALDI_ASSERT
(
Â‘s
.
size
() > 1);

34 
št32
 
	gnum_Ãw_Â‘s
 = 
Â‘s
.
size
() - 1;

35 
	gVeùÜ
<
	gBa£Flßt
> 
sÿËs
(
Â‘s
[0].
NumUpd©abËCompÚ’ts
());

37 
	gsÿËs
.
S‘
(1.0 / 
num_Ãw_Â‘s
);

39 *
	gdœeùiÚ
 = 
Â‘s
[1];

40 
	gdœeùiÚ
->
SÿËCompÚ’ts
(
sÿËs
);

41 
št32
 
	gn
 = 2;‚ < 1 + 
	gnum_Ãw_Â‘s
;‚++)

42 
	gdœeùiÚ
->
AddNÃt
(
sÿËs
, 
Â‘s
[
n
]);

45 
	gsÿËs
.
S‘
(-1.0);

46 
	gdœeùiÚ
->
AddNÃt
(
sÿËs
, 
Â‘s
[0]);

52 
AddDœeùiÚ
(cÚ¡ 
NÃt
 &
Üig_Â‘
,

53 cÚ¡ 
NÃt
 &
dœeùiÚ
,

54 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sÿËs
,

55 
NÃt
 *
de¡
) {

56 *
	gde¡
 = 
Üig_Â‘
;

57 
	gde¡
->
AddNÃt
(
sÿËs
, 
dœeùiÚ
);

61 
Ba£Flßt
 
Compu‹ObjfAndG¿d›Á
(

62 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

63 cÚ¡ 
VeùÜ
<> &
sÿË_·¿ms
,

64 cÚ¡ 
NÃt
 &
Üig_Â‘
,

65 cÚ¡ 
NÃt
 &
dœeùiÚ
,

66 
VeùÜ
<> *
g¿d›Á
) {

68 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms_æßt
(
sÿË_·¿ms
);

70 
NÃt
 
	gÂ‘_combšed
;

71 
AddDœeùiÚ
(
Üig_Â‘
, 
dœeùiÚ
, 
sÿË_·¿ms_æßt
, &
Â‘_combšed
);

73 
NÃt
 
Â‘_g¿d›Á
(
Â‘_combšed
);

74 
boŞ
 
	gis_g¿d›Á
 = 
Œue
;

75 
	gÂ‘_g¿d›Á
.
S‘Z”o
(
is_g¿d›Á
);

78 
št32
 
	gb©ch_size
 = 1024;

79 
Ba£Flßt
 
	gªs
 = 
Compu‹NÃtG¿d›Á
(
Â‘_combšed
,

80 
v®id©iÚ_£t
,

81 
b©ch_size
,

82 &
Â‘_g¿d›Á
);

84 
Ba£Flßt
 
	gtÙ_couÁ
 = 
v®id©iÚ_£t
.
size
();

85 
št32
 
	gi
 = 0;

86 
št32
 
	gj
 = 0; j < 
	gÂ‘_combšed
.
NumCompÚ’ts
(); j++) {

87 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc_dœeùiÚ
 =

88 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
dœeùiÚ
.
G‘CompÚ’t
(
j
))),

89 *
	guc_g¿d›Á
 =

90 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘_g¿d›Á
.
G‘CompÚ’t
(
j
)));

91 ià(
	guc_dœeùiÚ
 !ğ
NULL
) {

92 
Ba£Flßt
 
dÙ´od
 = 
uc_dœeùiÚ
->
DÙProduù
(*
uc_g¿d›Á
è/ 
tÙ_couÁ
;

93 (*
	gg¿d›Á
)(
	gi
èğ
dÙ´od
;

94 
	gi
++;

97 
KALDI_ASSERT
(
i
 =ğ
sÿË_·¿ms
.
Dim
());

98  
	gªs
;

102 
CombšeNÃtsA
(cÚ¡ 
NÃtCombšeAcÚfig
 &
cÚfig
,

103 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

104 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

105 
NÃt
 *
Â‘_out
) {

107 
NÃt
 
	gdœeùiÚ
;

108 
G‘Upd©eDœeùiÚ
(
Â‘s
, &
dœeùiÚ
);

110 
	gVeùÜ
<> 
sÿË_·¿ms
(
Â‘s
[0].
NumUpd©abËCompÚ’ts
());

113 
št32
 
	gdim
 = 
sÿË_·¿ms
.
Dim
();

114 
KALDI_ASSERT
(
dim
 > 0);

115 
	gVeùÜ
<> 
g¿d›Á
(
dim
);

117 
	gobjf
, 
	gš™Ÿl_objf
, 
	gz”o_objf
;

120 
	gz”o_objf
 = 
Compu‹ObjfAndG¿d›Á
(
v®id©iÚ_£t
,

121 
sÿË_·¿ms
,

122 
Â‘s
[0],

123 
dœeùiÚ
,

124 &
g¿d›Á
);

125 
	gKALDI_LOG
 << "Objective function‡t old…arameters is "

126 << 
	gz”o_objf
;

128 
	gsÿË_·¿ms
.
S‘
(1.0);

130 
LbfgsO±iÚs
 
	glbfgs_İtiÚs
;

131 
	glbfgs_İtiÚs
.
	gmšimize
 = 
çl£
;

132 
	glbfgs_İtiÚs
.
	gm
 = 
dim
;

134 
	glbfgs_İtiÚs
.
	gfœ¡_¡•_Ëngth
 = 
cÚfig
.
š™Ÿl_¡•
;

136 
	gO±imizeLbfgs
<> 
lbfgs
(
sÿË_·¿ms
,

137 
lbfgs_İtiÚs
);

139 
št32
 
	gi
 = 0; i < 
	gcÚfig
.
	gnum_bfgs_™”s
; i++) {

140 
	gsÿË_·¿ms
.
CİyFromVec
(
lbfgs
.
G‘Prİo£dV®ue
());

141 
	gobjf
 = 
Compu‹ObjfAndG¿d›Á
(
v®id©iÚ_£t
,

142 
sÿË_·¿ms
,

143 
Â‘s
[0],

144 
dœeùiÚ
,

145 &
g¿d›Á
);

147 
KALDI_VLOG
(2è<< "I‹¿tiÚ " << 
	gi
 << " sÿË-·¿m ğ" << 
	gsÿË_·¿ms


148 << ", objàğ" << 
	gobjf
 << ", g¿d›Á = " << 
	gg¿d›Á
;

150 ià(
	gi
 =ğ0è
š™Ÿl_objf
 = 
objf
;

151 
	glbfgs
.
DoS‹p
(
objf
, 
g¿d›Á
);

154 
	gsÿË_·¿ms
.
CİyFromVec
(
lbfgs
.
G‘V®ue
(&
objf
));

156 
	gKALDI_LOG
 << "Combining‚nets,‡fter BFGS, validation objf…er frame changed from "

157 << 
	gz”o_objf
 << " (nØchªge), o¸" << 
	gš™Ÿl_objf
 << " (default change), "

158 << "Ø" << 
	gobjf
 << "; scale factors on update direction‡re "

159 << 
	gsÿË_·¿ms
;

161 
Ba£Flßt
 
	gobjf_chªge
 = 
objf
 - 
z”o_objf
;

162 
KALDI_ASSERT
(
objf_chªge
 >= 0.0);

164 ià(
	gobjf_chªge
 < 
	gcÚfig
.
	gv®id_im´_th»sh
) {

167 
Ba£Flßt
 
	gov”shoÙ
 = 
cÚfig
.
ov”shoÙ
,

168 
	gov”shoÙ_max
 = 
cÚfig
.
v®id_im´_th»sh
 / 
objf_chªge
;

169 ià(
	gov”shoÙ_max
 < 
	gov”shoÙ
) {

170 
	gKALDI_LOG
 << "Lim™šg ov”shoÙ from " << 
	gov”shoÙ
 << "Ø" << 
	gov”shoÙ_max


171 << " sšûhobjf-im´ " << 
	gobjf_chªge
 << " is closeo "

172 << "--v®id-im´-th»sh=" << 
	gcÚfig
.
	gv®id_im´_th»sh
;

173 
	gov”shoÙ
 = 
ov”shoÙ_max
;

175 
KALDI_ASSERT
(
ov”shoÙ
 < 2.0 && "--valid-impr-thresh must be < 2.0 or "

177 
	gsÿË_·¿ms
.
SÿË
(
ov”shoÙ
);

179 
Ba£Flßt
 
	gİtimized_objf
 = 
objf
;

180 
	gobjf
 = 
Compu‹ObjfAndG¿d›Á
(
v®id©iÚ_£t
,

181 
sÿË_·¿ms
,

182 
Â‘s
[0],

183 
dœeùiÚ
,

184 &
g¿d›Á
);

186 
	gKALDI_LOG
 << "Combining‚nets,‡fter overshooting, validation objf changed "

187 << "tØ" << 
	gobjf
 << ". Note: (zero, start, optimized) objfs were "

188 << 
	gz”o_objf
 << ", " << 
	gš™Ÿl_objf
 << ", " << 
	gİtimized_objf
;

189 ià(
	gobjf
 < 
	gz”o_objf
) {

192 
	gKALDI_WARN
 << "After overshooting, objf was worsehan‚ot updating;‚ot doinghe "

194 
	gsÿË_·¿ms
.
SÿË
(1.0 / 
ov”shoÙ
);

198 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms_æßt
(
sÿË_·¿ms
);

200 
AddDœeùiÚ
(
Â‘s
[0], 
dœeùiÚ
, 
sÿË_·¿ms_æßt
, 
Â‘_out
);

203 
št32
 
	gi
 = 0;

204 
št32
 
	gj
 = 0; j < 
	gÂ‘_out
->
NumCompÚ’ts
(); j++) {

205 
Upd©abËCompÚ’t
 *
	guc
 =

206 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
Â‘_out
->
G‘CompÚ’t
(
j
)));

207 ià(
	guc
 !ğ
NULL
) {

208 
Ba£Flßt
 
¡•_Ëngth
 = 
sÿË_·¿ms
(
i
), 
	gçùÜ
 = step_length;

211 ià(
	gçùÜ
 < 
	gcÚfig
.
	gmš_Ë¬nšg_¿‹_çùÜ
)

212 
	gçùÜ
 = 
cÚfig
.
mš_Ë¬nšg_¿‹_çùÜ
;

213 ià(
	gçùÜ
 > 
	gcÚfig
.
	gmax_Ë¬nšg_¿‹_çùÜ
)

214 
	gçùÜ
 = 
cÚfig
.
max_Ë¬nšg_¿‹_çùÜ
;

215 
Ba£Flßt
 
	gÃw_Ë¬nšg_¿‹
 = 
çùÜ
 * 
uc
->
L—ºšgR©e
();

216 ià(
	gÃw_Ë¬nšg_¿‹
 < 
	gcÚfig
.
	gmš_Ë¬nšg_¿‹
)

217 
	gÃw_Ë¬nšg_¿‹
 = 
cÚfig
.
mš_Ë¬nšg_¿‹
;

218 
	gKALDI_LOG
 << "FÜ compÚ’ˆ" << 
	gj
 << ", s‹°Ëngth wa " << 
	g¡•_Ëngth


219 << ", upd©šg†—ºšg„©by faùÜ " << 
	gçùÜ
 << ", changing "

220 << "Ë¬nšg„©äom " << 
	guc
->
L—ºšgR©e
() << "o "

221 << 
	gÃw_Ë¬nšg_¿‹
;

222 
	guc
->
S‘L—ºšgR©e
(
Ãw_Ë¬nšg_¿‹
);

223 
	gi
++;

	@combine-nnet-a.h

20 #iâdeà
KALDI_NNET2_COMBINE_NNET_A_H_


21 
	#KALDI_NNET2_COMBINE_NNET_A_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"ut/·r£-İtiÚs.h
"

26 
	~"™f/İtiÚs-™f.h
"

28 
Çme¥aû
 
	gk®di
 {

29 
Çme¥aû
 
	gÂ‘2
 {

31 
	sNÃtCombšeAcÚfig
 {

32 
št32
 
	gnum_bfgs_™”s
;

36 
Ba£Flßt
 
	gš™Ÿl_¡•
;

38 
Ba£Flßt
 
	gv®id_im´_th»sh
;

39 
Ba£Flßt
 
	gov”shoÙ
;

41 
Ba£Flßt
 
	gmš_Ë¬nšg_¿‹_çùÜ
;

42 
Ba£Flßt
 
	gmax_Ë¬nšg_¿‹_çùÜ
;

43 
Ba£Flßt
 
	gmš_Ë¬nšg_¿‹
;

46 
NÃtCombšeAcÚfig
(): 
num_bfgs_™”s
(15), 
š™Ÿl_¡•
(0.1),

47 
v®id_im´_th»sh
(0.5), 
ov”shoÙ
(1.8),

48 
mš_Ë¬nšg_¿‹_çùÜ
(0.5),

49 
max_Ë¬nšg_¿‹_çùÜ
(2.0),

50 
mš_Ë¬nšg_¿‹
(0.0001) { }

52 
Regi¡”
(
O±iÚsItf
 *
İts
) {

53 
	gİts
->
Regi¡”
("num-bfgs-™”s", &
num_bfgs_™”s
, "Maximum‚umber of function "

55 
	gİts
->
Regi¡”
("š™Ÿl-¡•", &
š™Ÿl_¡•
, "Parameter inhe optimization, "

58 
	gİts
->
Regi¡”
("num-bfgs-™”s", &
num_bfgs_™”s
, "Maximum‚umber of function "

60 
	gİts
->
Regi¡”
("v®id-im´-th»sh", &
v®id_im´_th»sh
, "Threshold of improvement "

63 
	gİts
->
Regi¡”
("ov”shoÙ", &
ov”shoÙ
, "Factor by which we overshoothe step "

66 
	gİts
->
Regi¡”
("max-Ë¬nšg-¿‹-çùÜ", &
max_Ë¬nšg_¿‹_çùÜ
,

68 
	gİts
->
Regi¡”
("mš-Ë¬nšg-¿‹-çùÜ", &
mš_Ë¬nšg_¿‹_çùÜ
,

70 
	gİts
->
Regi¡”
("mš-Ë¬nšg-¿‹", &
mš_Ë¬nšg_¿‹
,

75 
CombšeNÃtsA
(cÚ¡ 
NÃtCombšeAcÚfig
 &
combše_cÚfig
,

76 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

77 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s_š
,

78 
NÃt
 *
Â‘_out
);

	@combine-nnet-fast.cc

20 
	~"Â‘2/combše-Â‘-ç¡.h
"

21 
	~"Â‘2/Â‘-upd©e-·¿Î–.h
"

22 
	~"ut/k®di-th»ad.h
"

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

31 şas 
	cFish”ComputiÚCÏss
: 
public
 
MuÉiTh»adabË
 {

32 
public
:

33 
Fish”ComputiÚCÏss
(cÚ¡ 
NÃt
 &
Â‘
,

34 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

35 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
egs
,

36 
št32
 
mšib©ch_size
,

37 
SpM©rix
<> *
sÿ‰”
):

38 
Â‘_
(
Â‘
), 
Â‘s_
(
Â‘s
), 
egs_
(
egs
), 
mšib©ch_size_
(
mšib©ch_size
),

39 
sÿ‰”_±r_
(
sÿ‰”
) { }

43 
Fish”ComputiÚCÏss
(cÚ¡ Fish”ComputiÚCÏs &
Ùh”
):

44 
MuÉiTh»adabË
(
Ùh”
),

45 
Â‘_
(
Ùh”
.Â‘_), 
Â‘s_
(Ùh”.Â‘s_), 
egs_
(other.egs_),

46 
mšib©ch_size_
(
Ùh”
.mšib©ch_size_), 
sÿ‰”_±r_
(other.scatter_ptr_) {

47 
	gsÿ‰”_
.
Resize
(
Â‘s_
.
size
(è* 
Â‘_
.
NumUpd©abËCompÚ’ts
()); }

49 
İ”©Ü
 () () {

51 
št32
 
	gnum_egs
 = 
¡©ic_ÿ¡
<št32>(
egs_
.
size
());

52 
NÃt
 
Â‘_g¿d›Á
(
Â‘_
);

53 
št32
 
	gb
 = 0; 
b
 * 
	gmšib©ch_size_
 < 
	gnum_egs
; b++) {

54 ià(
	gb
 % 
	gnum_th»ads_
 !ğ
th»ad_id_
)

56 
št32
 
	goff£t
 = 
b
 * 
mšib©ch_size_
,

57 
	gËngth
 = 
¡d
::
mš
(
mšib©ch_size_
,

58 
num_egs
 - 
off£t
);

59 
boŞ
 
	gis_g¿d›Á
 = 
Œue
;

60 
	gÂ‘_g¿d›Á
.
S‘Z”o
(
is_g¿d›Á
);

61 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
mšib©ch
(
egs_
.
begš
(è+ 
off£t
,

62 
egs_
.
begš
(è+ 
off£t
 + 
Ëngth
);

63 
DoBack´İ
(
Â‘_
, 
mšib©ch
, &
Â‘_g¿d›Á
);

64 
	gVeùÜ
<> 
g¿d›Á
(
Â‘s_
.
size
(è* 
Â‘_
.
NumUpd©abËCompÚ’ts
());

65 
št32
 
	gi
 = 0;

66 
št32
 
	gn
 = 0;‚ < 
	g¡©ic_ÿ¡
<
	gšt32
>(
	gÂ‘s_
.
size
());‚++) {

67 
št32
 
	gc
 = 0; c < 
	gÂ‘_
.
NumCompÚ’ts
(); c++) {

68 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<const UpdatableComponent*>(

69 &(
Â‘_g¿d›Á
.
G‘CompÚ’t
(
c
))),

70 *
	guc_Ùh”
 = 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(

71 &(
Â‘s_
[
n
].
G‘CompÚ’t
(
c
)));

72 ià(
	guc
 !ğ
NULL
) {

73 
g¿d›Á
(
i
èğ
uc
->
DÙProduù
(*
uc_Ùh”
);

74 
	gi
++;

78 
KALDI_ASSERT
(
i
 =ğ
g¿d›Á
.
Dim
());

79 
	gsÿ‰”_
.
AddVec2
(1.0, 
g¿d›Á
);

82 ~
Fish”ComputiÚCÏss
() {

83 ià(
	gsÿ‰”_
.
NumRows
() != 0) {

84 ià(
sÿ‰”_±r_
->
NumRows
() == 0)

85 
sÿ‰”_±r_
->
Resize
(
sÿ‰”_
.
NumRows
());

86 
	gsÿ‰”_±r_
->
AddSp
(1.0, 
sÿ‰”_
);

90 
	g´iv©e
:

91 cÚ¡ 
NÃt
 &
Â‘_
;

92 cÚ¡ 
	g¡d
::
veùÜ
<
NÃt
> &
Â‘s_
;

94 cÚ¡ 
	g¡d
::
veùÜ
<
NÃtExam¶e
> &
egs_
;

95 
št32
 
	gmšib©ch_size_
;

97 
	gSpM©rix
<> *
	gsÿ‰”_±r_
;

98 
	gSpM©rix
<> 
	gsÿ‰”_
;

102 şas 
	cFa¡NÃtCombš”
 {

103 
	gpublic
:

104 
Fa¡NÃtCombš”
(cÚ¡ 
NÃtCombšeFa¡CÚfig
 &
combše_cÚfig
,

105 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

106 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s_š
,

107 
NÃt
 *
Â‘_out
):

108 
cÚfig_
(
combše_cÚfig
), 
egs_
(
v®id©iÚ_£t
),

109 
Â‘s_
(
Â‘s_š
), 
Â‘_out_
(
Â‘_out
) {

111 
G‘In™ŸlP¬ams
();

112 
Compu‹P»cÚd™iÚ”
();

114 
št32
 
	gdim
 = 
·¿ms_
.
Dim
();

115 
KALDI_ASSERT
(
dim
 > 0);

116 
	gVeùÜ
<> 
g¿d›Á
(
dim
);

118 
	g»guÏriz”_objf
, 
	gš™Ÿl_»guÏriz”_objf
;

119 
	gobjf
, 
	gš™Ÿl_objf
;

121 
LbfgsO±iÚs
 
	glbfgs_İtiÚs
;

122 
	glbfgs_İtiÚs
.
	gmšimize
 = 
çl£
;

123 
	glbfgs_İtiÚs
.
	gm
 = 
¡d
::
mš
(
dim
, 
cÚfig_
.
max_lbfgs_dim
);

124 
	glbfgs_İtiÚs
.
	gfœ¡_¡•_im´
 = 
cÚfig_
.
š™Ÿl_im´
;

126 
	gO±imizeLbfgs
<> 
lbfgs
(
·¿ms_
,

127 
lbfgs_İtiÚs
);

129 
št32
 
	gi
 = 0; i < 
	gcÚfig_
.
	gnum_lbfgs_™”s
; i++) {

130 
	g·¿ms_
.
CİyFromVec
(
lbfgs
.
G‘Prİo£dV®ue
());

131 
	gobjf
 = 
Compu‹ObjfAndG¿d›Á
(&
g¿d›Á
, &
»guÏriz”_objf
);

134 ià(
	gi
 == 0) {

135 
š™Ÿl_objf
 = 
objf
;

136 
	gš™Ÿl_»guÏriz”_objf
 = 
»guÏriz”_objf
;

138 
	glbfgs
.
DoS‹p
(
objf
, 
g¿d›Á
);

140 
	g·¿ms_
 = 
lbfgs
.
G‘V®ue
(&
objf
);

142 
Compu‹Cu¼’tNÃt
(
Â‘_out_
, 
Œue
);

144 ià(
	gcÚfig_
.
	g»guÏriz”
 != 0.0) {

145 
š™Ÿl_·¹
 = 
š™Ÿl_objf
 - 
š™Ÿl_»guÏriz”_objf
,

146 
	g·¹
 = 
objf
 - 
»guÏriz”_objf
;

147 
	gKALDI_LOG
 << "Combining‚nets, objf/frame +„egularizer changed from "

148 << 
	gš™Ÿl_·¹
 << " + " << 
	gš™Ÿl_»guÏriz”_objf


149 << " = " << 
	gš™Ÿl_objf
 << "Ø" << 
	g·¹
 << " + "

150 << 
	g»guÏriz”_objf
 << " = " << 
	gobjf
;

152 
	gKALDI_LOG
 << "Combining‚nets, objf…er frame changed from "

153 << 
	gš™Ÿl_objf
 << "Ø" << 
	gobjf
;

157 
	g´iv©e
:

158 
št32
 
G‘In™ŸlMod–
(

159 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

160 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
) const;

162 
G‘In™ŸlP¬ams
();

164 
Compu‹P»cÚd™iÚ”
();

169 
Compu‹ObjfAndG¿d›Á
(

170 
VeùÜ
<> *
g¿d›Á
,

171 *
»guÏriz”_objf
);

173 
Compu‹Cu¼’tNÃt
(

174 
NÃt
 *
de¡
, 
boŞ
 
debug
 = 
çl£
);

176 
CombšeNÃts
(cÚ¡ 
VeùÜ
<> &
sÿË_·¿ms
,

177 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

178 
NÃt
 *
de¡
);

186 
	gTpM©rix
<> 
	gC_
;

187 
	gTpM©rix
<> 
	gC_šv_
;

188 
	gVeùÜ
<> 
	g·¿ms_
;

193 cÚ¡ 
	gNÃtCombšeFa¡CÚfig
 &
	gcÚfig_
;

194 cÚ¡ 
	g¡d
::
veùÜ
<
NÃtExam¶e
> &
egs_
;

195 cÚ¡ 
	g¡d
::
veùÜ
<
NÃt
> &
Â‘s_
;

196 
NÃt
 *
	gÂ‘_out_
;

201 
	gFa¡NÃtCombš”
::
CombšeNÃts
(cÚ¡ 
VeùÜ
<> &
sÿË_·¿ms
,

202 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

203 
NÃt
 *
de¡
) {

204 
št32
 
	gnum_Â‘s
 = 
Â‘s
.
size
();

205 
KALDI_ASSERT
(
num_Â‘s
 >= 1);

206 
št32
 
	gnum_uc
 = 
Â‘s
[0].
NumUpd©abËCompÚ’ts
();

207 
KALDI_ASSERT
(
num_Â‘s
 * 
Â‘s
[0].
NumUpd©abËCompÚ’ts
());

210 *
	gde¡
 = 
Â‘s
[0];

211 
	gSubVeùÜ
<> 
sÿË_·¿ms0
(
sÿË_·¿ms
, 0, 
num_uc
);

212 
	gde¡
->
SÿËCompÚ’ts
(
VeùÜ
<
Ba£Flßt
>(
sÿË_·¿ms0
));

213 
št32
 
	gn
 = 1;‚ < 
	gnum_Â‘s
;‚++) {

214 
	gSubVeùÜ
<> 
sÿË_·¿ms_n
(
sÿË_·¿ms
, 
n
 * 
num_uc
,‚um_uc);

215 
	gde¡
->
AddNÃt
(
VeùÜ
<
Ba£Flßt
>(
sÿË_·¿ms_n
), 
Â‘s
[
n
]);

220 
	gFa¡NÃtCombš”
::
Compu‹P»cÚd™iÚ”
() {

221 
SpM©rix
<> 
F
;

222 
NÃt
 
	gÂ‘
;

223 
Compu‹Cu¼’tNÃt
(&
Â‘
);

227 
Fish”ComputiÚCÏss
 
fc
(
Â‘
, 
Â‘s_
, 
egs_
,

228 
cÚfig_
.
fish”_mšib©ch_size
,

229 &
F
);

234 
št32
 
	gnum_th»ads
 = 
cÚfig_
.
num_th»ads
 == 1 ? 0 : config_.num_threads;

237 
	gMuÉiTh»ad”
<
	gFish”ComputiÚCÏss
> 
m
(
num_th»ads
, 
fc
);

242 
KALDI_ASSERT
(
F
.
T¿û
() > 0);

243 
	gF
.
SÿË
(
F
.
NumRows
(è/ F.
T¿û
());

247 
KALDI_ASSERT
(
cÚfig_
.
fish”_æoÜ
 > 0.0);

248 
št32
 
	gi
 = 0; i < 
	gF
.
NumRows
(); i++)

249 
F
(
i
, ièğ
¡d
::
max
<
Ba£Flßt
>(F(i, i), 
	gcÚfig_
.
	gfish”_æoÜ
);

253 
št32
 
	gi
 = 0; i < 
	gF
.
NumRows
(); i++)

254 
F
(
i
, iè*ğ(1.0 + 
cÚfig_
.
®pha
);

256 
	gC_
.
Resize
(
F
.
NumRows
());

257 
	gC_
.
ChŞesky
(
F
);

258 
	gC_šv_
 = 
C_
;

259 
	gC_šv_
.
Inv”t
();

262 
	gVeùÜ
<> 
¿w_·¿ms
(
·¿ms_
);

263 
	g·¿ms_
.
AddTpVec
(1.0, 
C_
, 
kT¿ns
, 
¿w_·¿ms
, 0.0);

268 
	gFa¡NÃtCombš”
::
G‘In™ŸlP¬ams
() {

269 
št32
 
š™Ÿl_mod–
 = 
cÚfig_
.initial_model,

270 
	gnum_Â‘s
 = 
¡©ic_ÿ¡
<
št32
>(
Â‘s_
.
size
());

271 ià(
	gš™Ÿl_mod–
 > 
	gnum_Â‘s
)

272 
	gš™Ÿl_mod–
 = 
num_Â‘s
;

273 ià(
	gš™Ÿl_mod–
 < 0)

274 
	gš™Ÿl_mod–
 = 
G‘In™ŸlMod–
(
egs_
, 
Â‘s_
);

276 
KALDI_ASSERT
(
š™Ÿl_mod–
 >ğ0 && in™Ÿl_mod– <ğ
num_Â‘s
);

277 
št32
 
	gnum_uc
 = 
Â‘s_
[0].
NumUpd©abËCompÚ’ts
();

279 
	gVeùÜ
<> 
¿w_·¿ms
(
num_uc
 * 
num_Â‘s
);

281 ià(
	gš™Ÿl_mod–
 < 
	gnum_Â‘s
) {

282 
	gKALDI_LOG
 << "In™Ÿlizšg w™h‚eu¿ÈÃˆw™h index " << 
	gš™Ÿl_mod–
;

284 
	g¿w_·¿ms
.
S‘
(0.0);

288 
	gSubVeùÜ
<> 
be¡_block
(
¿w_·¿ms
, 
num_uc
 * 
š™Ÿl_mod–
,‚um_uc);

289 
	gbe¡_block
.
S‘
(1.0);

291 
	gKALDI_LOG
 << "Initializing with‡ll‚eural‚ets‡veraged.";

292 
	g¿w_·¿ms
.
S‘
(1.0 / 
num_Â‘s
);

294 
KALDI_ASSERT
(
C_
.
NumRows
() == 0);

295 
	g·¿ms_
 = 
¿w_·¿ms
;

299 
	gFa¡NÃtCombš”
::
Compu‹ObjfAndG¿d›Á
(

300 
VeùÜ
<> *
g¿d›Á
,

301 *
»guÏriz”_objf_±r
) {

302 
NÃt
 
	gÂ‘
;

303 
Compu‹Cu¼’tNÃt
(&
Â‘
);

305 
NÃt
 
Â‘_g¿d›Á
(
Â‘
);

306 
boŞ
 
	gis_g¿d›Á
 = 
Œue
;

307 
	gÂ‘_g¿d›Á
.
S‘Z”o
(
is_g¿d›Á
);

308 
	gtÙ_weight
 = 0.0;

309 
	gobjf
 = 
DoBack´İP¬®Ël
(
Â‘
, 
cÚfig_
.
mšib©ch_size
, cÚfig_.
num_th»ads
,

310 
egs_
, &
tÙ_weight
, &
Â‘_g¿d›Á
è/ 
	gegs_
.
size
();

313 
	gVeùÜ
<> 
¿w_g¿d›Á
(
·¿ms_
.
Dim
());

315 
	g»guÏriz”_objf
 = 0.0;

316 
št32
 
	gi
 = 0;

317 
št32
 
	gnum_Â‘s
 = 
Â‘s_
.
size
();

318 
št32
 
	gn
 = 0;‚ < 
	gnum_Â‘s
;‚++) {

319 
št32
 
	gj
 = 0; j < 
	gÂ‘
.
NumCompÚ’ts
(); j++) {

320 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 =

321 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘s_
[
n
].
G‘CompÚ’t
(
j
))),

322 *
	guc_g¿d›Á
 =

323 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘_g¿d›Á
.
G‘CompÚ’t
(
j
))),

324 *
	guc_·¿ms
 =

325 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘
.
G‘CompÚ’t
(
j
)));

326 ià(
	guc
 !ğ
NULL
) {

327 
g¿d›Á
 = 
uc
->
DÙProduù
(*
uc_g¿d›Á
è/ 
tÙ_weight
;

331 ià(
	gcÚfig_
.
	g»guÏriz”
 != 0.0) {

332 
g¿d›Á
 -ğ
cÚfig_
.
»guÏriz”
 * 
uc
->
DÙProduù
(*
uc_·¿ms
);

333 ià(
	gn
 == 0)

334 
»guÏriz”_objf
 +=

335 -0.5 * 
cÚfig_
.
»guÏriz”
 * 
uc_·¿ms
->
DÙProduù
(*uc_params);

337 
¿w_g¿d›Á
(
i
èğ
g¿d›Á
;

338 
	gi
++;

342 ià(
	gcÚfig_
.
	g»guÏriz”
 != 0.0) {

343 
KALDI_VLOG
(2è<< "Objài " << 
objf
 << " +„eguÏriz” " << 
»guÏriz”_objf


344 << " = " << (
objf
 + 
»guÏriz”_objf
) << ",„aw gradient is "

345 << 
¿w_g¿d›Á
;

347 
KALDI_VLOG
(2è<< "Objài " << 
	gobjf
 << ",„aw g¿d›Á i " << 
	g¿w_g¿d›Á
;

349 
KALDI_ASSERT
(
i
 =ğ
¿w_g¿d›Á
.
Dim
());

351 
	gg¿d›Á
->
AddTpVec
(1.0, 
C_šv_
, 
kNoT¿ns
, 
¿w_g¿d›Á
, 0.0);

352 *
	g»guÏriz”_objf_±r
 = 
»guÏriz”_objf
;

353  
	gobjf
 + 
	g»guÏriz”_objf
;

356 
	gFa¡NÃtCombš”
::
Compu‹Cu¼’tNÃt
(

357 
NÃt
 *
de¡
, 
boŞ
 
debug
) {

358 
št32
 
	gnum_Â‘s
 = 
Â‘s_
.
size
();

359 
KALDI_ASSERT
(
num_Â‘s
 >= 1);

360 
KALDI_ASSERT
(
·¿ms_
.
Dim
(è=ğ
num_Â‘s
 * 
Â‘s_
[0].
NumUpd©abËCompÚ’ts
());

361 
	gVeùÜ
<> 
¿w_·¿ms
(
·¿ms_
.
Dim
());

364 ià(
	gC_šv_
.
NumRows
() > 0)

365 
	g¿w_·¿ms
.
AddTpVec
(1.0, 
C_šv_
, 
kT¿ns
, 
·¿ms_
, 0.0);

367 
	g¿w_·¿ms
 = 
·¿ms_
;

369 ià(
	gdebug
) {

370 
	gM©rix
<> 
·¿ms_m©
(
num_Â‘s
,

371 
Â‘s_
[0].
NumUpd©abËCompÚ’ts
());

372 
	g·¿ms_m©
.
CİyRowsFromVec
(
¿w_·¿ms
);

373 
	gKALDI_LOG
 << "SÿË…¬am‘” ¬" << 
	g·¿ms_m©
;

375 
CombšeNÃts
(
¿w_·¿ms
, 
Â‘s_
, 
de¡
);

381 
št32
 
	gFa¡NÃtCombš”
::
G‘In™ŸlMod–
(

382 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

383 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
) const {

384 
št32
 
num_Â‘s
 = 
¡©ic_ÿ¡
<št32>(
Â‘s
.
size
());

385 
KALDI_ASSERT
(!
Â‘s
.
em±y
());

386 
št32
 
	gbe¡_n
 = -1;

387 
	gbe¡_objf
;

388 
	gVeùÜ
<> 
objfs
(
Â‘s
.
size
());

389 
št32
 
	gn
 = 0;‚ < 
	gnum_Â‘s
;‚++) {

390 
	gnum_äames
;

391 
	gobjf
 = 
Compu‹NÃtObjfP¬®Ël
(
Â‘s
[
n
], 
cÚfig_
.
mšib©ch_size
,

392 
cÚfig_
.
num_th»ads
, 
v®id©iÚ_£t
,

393 &
num_äames
);

394 
KALDI_ASSERT
(
num_äames
 != 0);

395 
	gobjf
 /ğ
num_äames
;

397 ià(
	gn
 =ğ0 || 
objf
 > 
be¡_objf
) {

398 
be¡_objf
 = 
objf
;

399 
	gbe¡_n
 = 
n
;

401 
objfs
(
n
èğ
objf
;

403 
	gKALDI_LOG
 << "ObjeùivfunùiÚ fÜhsourû‚eu¿ÈÃt ¬" << 
	gobjfs
;

405 
št32
 
	gnum_uc
 = 
Â‘s
[0].
NumUpd©abËCompÚ’ts
();

407 ià(
	gnum_Â‘s
 > 1) {

410 
	gVeùÜ
<> 
sÿË_·¿ms
(
num_uc
 * 
num_Â‘s
);

411 
	gsÿË_·¿ms
.
S‘
(1.0 / 
num_Â‘s
);

412 
NÃt
 
	gav”age_Â‘
;

413 
CombšeNÃts
(
sÿË_·¿ms
, 
Â‘s
, &
av”age_Â‘
);

414 
	gnum_äames
;

415 
	gobjf
 = 
Compu‹NÃtObjfP¬®Ël
(
av”age_Â‘
, 
cÚfig_
.
mšib©ch_size
,

416 
cÚfig_
.
num_th»ads
, 
v®id©iÚ_£t
,

417 &
num_äames
);

418 
	gobjf
 /ğ
num_äames
;

419 
	gKALDI_LOG
 << "Objàw™h‡Î‚eu¿ÈÃt av”aged i " << 
	gobjf
;

420 ià(
	gobjf
 > 
	gbe¡_objf
) {

421  
	gnum_Â‘s
;

423  
	gbe¡_n
;

426  
	gbe¡_n
;

430 
CombšeNÃtsFa¡
(cÚ¡ 
NÃtCombšeFa¡CÚfig
 &
combše_cÚfig
,

431 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

432 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s_š
,

433 
NÃt
 *
Â‘_out
) {

435 
Fa¡NÃtCombš”
 
combš”
(
combše_cÚfig
,

436 
v®id©iÚ_£t
,

437 
Â‘s_š
,

438 
Â‘_out
);

	@combine-nnet-fast.h

20 #iâdeà
KALDI_NNET2_COMBINE_NNET_FAST_H_


21 
	#KALDI_NNET2_COMBINE_NNET_FAST_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"ut/·r£-İtiÚs.h
"

26 
	~"™f/İtiÚs-™f.h
"

43 
Çme¥aû
 
	gk®di
 {

44 
Çme¥aû
 
	gÂ‘2
 {

50 
	sNÃtCombšeFa¡CÚfig
 {

51 
št32
 
	gš™Ÿl_mod–
;

53 
št32
 
	gnum_lbfgs_™”s
;

54 
št32
 
	gnum_th»ads
;

55 
Ba£Flßt
 
	gš™Ÿl_im´
;

56 
Ba£Flßt
 
	gfish”_æoÜ
;

59 
Ba£Flßt
 
	g®pha
;

60 
št32
 
	gfish”_mšib©ch_size
;

63 
št32
 
	gmšib©ch_size
;

65 
št32
 
	gmax_lbfgs_dim
;

66 
Ba£Flßt
 
	g»guÏriz”
;

68 
NÃtCombšeFa¡CÚfig
(): 
š™Ÿl_mod–
(-1), 
num_lbfgs_™”s
(10),

69 
num_th»ads
(1), 
š™Ÿl_im´
(0.01), 
fish”_æoÜ
(1.0e-20),

70 
®pha
(0.01), 
fish”_mšib©ch_size
(64), 
mšib©ch_size
(1024),

71 
max_lbfgs_dim
(10), 
»guÏriz”
(0.0) {}

73 
Regi¡”
(
O±iÚsItf
 *
İts
) {

74 
	gİts
->
Regi¡”
("š™Ÿl-mod–", &
š™Ÿl_mod–
, "Specifies whereo starthe "

78 
	gİts
->
Regi¡”
("num-lbfgs-™”s", &
num_lbfgs_™”s
, "Maximum‚umber of function "

80 
	gİts
->
Regi¡”
("š™Ÿl-im´", &
š™Ÿl_im´
, "Amount of objective-function change "

82 
	gİts
->
Regi¡”
("num-th»ads", &
num_th»ads
, "Number ofhreadso use in "

84 
	gİts
->
Regi¡”
("fish”-æoÜ", &
fish”_æoÜ
,

86 
	gİts
->
Regi¡”
("®pha", &
®pha
, "Value we use in smoothinghe Fisher matrix "

88 
	gİts
->
Regi¡”
("fish”-mšib©ch-size", &
fish”_mšib©ch_size
, "Size of minibatch "

91 
	gİts
->
Regi¡”
("mšib©ch-size", &
mšib©ch_size
, "Minibatch size used in computing "

93 
	gİts
->
Regi¡”
("max-lbfgs-dim", &
max_lbfgs_dim
, "Maximum dimensiono use in "

96 
	gİts
->
Regi¡”
("»guÏriz”", &
»guÏriz”
, "Addohe objective "

102 
CombšeNÃtsFa¡
(cÚ¡ 
NÃtCombšeFa¡CÚfig
 &
combše_cÚfig
,

103 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

104 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s_š
,

105 
NÃt
 *
Â‘_out
);

	@combine-nnet.cc

20 
	~"Â‘2/combše-Â‘.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

28 
CombšeNÃts
(cÚ¡ 
VeùÜ
<
Ba£Flßt
> &
sÿË_·¿ms
,

29 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

30 
NÃt
 *
de¡
) {

31 
št32
 
	gnum_Â‘s
 = 
Â‘s
.
size
();

32 
KALDI_ASSERT
(
num_Â‘s
 >= 1);

33 
št32
 
	gnum_uc
 = 
Â‘s
[0].
NumUpd©abËCompÚ’ts
();

34 
KALDI_ASSERT
(
num_Â‘s
 * 
Â‘s
[0].
NumUpd©abËCompÚ’ts
());

37 *
	gde¡
 = 
Â‘s
[0];

38 
	gSubVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms0
(
sÿË_·¿ms
, 0, 
num_uc
);

39 
	gde¡
->
SÿËCompÚ’ts
(
sÿË_·¿ms0
);

40 
št32
 
	gn
 = 1;‚ < 
	gnum_Â‘s
;‚++) {

41 
	gSubVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms_n
(
sÿË_·¿ms
, 
n
 * 
num_uc
,‚um_uc);

42 
	gde¡
->
AddNÃt
(
sÿË_·¿ms_n
, 
Â‘s
[
n
]);

49 
št32
 
G‘In™ŸlMod–
(

50 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

51 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
) {

52 
št32
 
mšib©ch_size
 = 1024;

53 
št32
 
	gnum_Â‘s
 = 
¡©ic_ÿ¡
<št32>(
Â‘s
.
size
());

54 
KALDI_ASSERT
(!
Â‘s
.
em±y
());

55 
Ba£Flßt
 
	gtÙ_äames
 = 
v®id©iÚ_£t
.
size
();

56 
št32
 
	gbe¡_n
 = -1;

57 
Ba£Flßt
 
	gbe¡_objf
;

58 
	gVeùÜ
<
	gBa£Flßt
> 
objfs
(
Â‘s
.
size
());

59 
št32
 
	gn
 = 0;‚ < 
	gnum_Â‘s
;‚++) {

60 
Ba£Flßt
 
	gobjf
 = 
Compu‹NÃtObjf
(
Â‘s
[
n
], 
v®id©iÚ_£t
,

61 
mšib©ch_size
è/ 
	gtÙ_äames
;

63 ià(
	gn
 =ğ0 || 
objf
 > 
be¡_objf
) {

64 
be¡_objf
 = 
objf
;

65 
	gbe¡_n
 = 
n
;

67 
objfs
(
n
èğ
objf
;

69 
	gKALDI_LOG
 << "ObjeùivfunùiÚ fÜhsourû‚eu¿ÈÃt ¬" << 
	gobjfs
;

71 
št32
 
	gnum_uc
 = 
Â‘s
[0].
NumUpd©abËCompÚ’ts
();

74 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms
(
num_uc
 * 
num_Â‘s
);

75 
	gsÿË_·¿ms
.
S‘
(1.0 / 
num_Â‘s
);

76 
NÃt
 
	gav”age_Â‘
;

77 
CombšeNÃts
(
sÿË_·¿ms
, 
Â‘s
, &
av”age_Â‘
);

78 
Ba£Flßt
 
	gobjf
 = 
Compu‹NÃtObjf
(
av”age_Â‘
, 
v®id©iÚ_£t
,

79 
mšib©ch_size
è/ 
	gtÙ_äames
;

80 
	gKALDI_LOG
 << "Objàw™h‡Î‚eu¿ÈÃt av”aged i " << 
	gobjf
;

81 ià(
	gobjf
 > 
	gbe¡_objf
) {

82  
	gnum_Â‘s
;

84  
	gbe¡_n
;

91 
G‘In™ŸlSÿËP¬ams
(

92 cÚ¡ 
NÃtCombšeCÚfig
 &
combše_cÚfig
,

93 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

94 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

95 
VeùÜ
<> *
sÿË_·¿ms
) {

97 
št32
 
	gš™Ÿl_mod–
 = 
combše_cÚfig
.
š™Ÿl_mod–
,

98 
	gnum_Â‘s
 = 
¡©ic_ÿ¡
<
št32
>(
Â‘s
.
size
());

99 ià(
	gš™Ÿl_mod–
 < 0 || in™Ÿl_mod– > 
	gnum_Â‘s
)

100 
	gš™Ÿl_mod–
 = 
G‘In™ŸlMod–
(
v®id©iÚ_£t
, 
Â‘s
);

102 
KALDI_ASSERT
(
š™Ÿl_mod–
 >ğ0 && in™Ÿl_mod– <ğ
num_Â‘s
);

103 
št32
 
	gnum_uc
 = 
Â‘s
[0].
NumUpd©abËCompÚ’ts
();

105 
	gsÿË_·¿ms
->
Resize
(
num_uc
 * 
num_Â‘s
);

106 ià(
	gš™Ÿl_mod–
 < 
	gnum_Â‘s
) {

107 
	gKALDI_LOG
 << "In™Ÿlizšg w™h‚eu¿ÈÃˆw™h index " << 
	gš™Ÿl_mod–
;

109 
	gsÿË_·¿ms
->
S‘
(0.0);

113 
	gSubVeùÜ
<> 
be¡_block
(*
sÿË_·¿ms
, 
num_uc
 * 
š™Ÿl_mod–
,‚um_uc);

114 
	gbe¡_block
.
S‘
(1.0);

116 
	gKALDI_LOG
 << "Initializing with‡ll‚eural‚ets‡veraged.";

117 
	gsÿË_·¿ms
->
S‘
(1.0 / 
num_Â‘s
);

124 
Compu‹ObjfAndG¿d›Á
(

125 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

126 cÚ¡ 
VeùÜ
<> &
sÿË_·¿ms
,

127 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

128 
boŞ
 
debug
,

129 
VeùÜ
<> *
g¿d›Á
) {

131 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms_æßt
(
sÿË_·¿ms
);

133 
NÃt
 
	gÂ‘_combšed
;

134 
CombšeNÃts
(
sÿË_·¿ms_æßt
, 
Â‘s
, &
Â‘_combšed
);

136 
NÃt
 
Â‘_g¿d›Á
(
Â‘_combšed
);

137 
boŞ
 
	gis_g¿d›Á
 = 
Œue
;

138 
	gÂ‘_g¿d›Á
.
S‘Z”o
(
is_g¿d›Á
);

141 
št32
 
	gb©ch_size
 = 1024;

142 
	gªs
 = 
Compu‹NÃtG¿d›Á
(
Â‘_combšed
,

143 
v®id©iÚ_£t
,

144 
b©ch_size
,

145 &
Â‘_g¿d›Á
);

147 
	gtÙ_äames
 = 
v®id©iÚ_£t
.
size
();

148 ià(
	gg¿d›Á
 !ğ
NULL
) {

149 
št32
 
i
 = 0;

150 
št32
 
	gn
 = 0;‚ < 
	g¡©ic_ÿ¡
<
	gšt32
>(
	gÂ‘s
.
size
());‚++) {

151 
št32
 
	gj
 = 0; j < 
	gÂ‘_combšed
.
NumCompÚ’ts
(); j++) {

152 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 =

153 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘s
[
n
].
G‘CompÚ’t
(
j
))),

154 *
	guc_g¿d›Á
 =

155 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘_g¿d›Á
.
G‘CompÚ’t
(
j
)));

156 ià(
	guc
 !ğ
NULL
) {

157 
dÙ´od
 = 
uc
->
DÙProduù
(*
uc_g¿d›Á
è/ 
tÙ_äames
;

158 (*
	gg¿d›Á
)(
	gi
èğ
dÙ´od
;

159 
	gi
++;

163 
KALDI_ASSERT
(
i
 =ğ
sÿË_·¿ms
.
Dim
());

166 ià(
	gdebug
) {

167 
	gKALDI_LOG
 << "Double-checking gradient computation";

169 
	gVeùÜ
<
	gBa£Flßt
> 
mªu®_g¿d›Á
(
sÿË_·¿ms
.
Dim
());

170 
št32
 
	gi
 = 0; i < 
	gsÿË_·¿ms
.
Dim
(); i++) {

171 
	gd–
 = 1.0e-04, 
	gfg
 = 
çbs
((*
g¿d›Á
)(
i
));

172 ià(
	gfg
 < 1.0e-07) fg = 1.0e-07;

173 ià(
fg
 * 
	gd–
 < 1.0e-05)

174 
	gd–
 = 1.0e-05 / 
fg
;

176 
	gVeùÜ
<> 
sÿË_·¿ms_‹mp
(
sÿË_·¿ms
);

177 
sÿË_·¿ms_‹mp
(
i
è+ğ
d–
;

178 
	gÃw_ªs
 = 
Compu‹ObjfAndG¿d›Á
(
v®id©iÚ_£t
,

179 
sÿË_·¿ms_‹mp
,

180 
Â‘s
,

181 
çl£
,

182 
NULL
);

183 
mªu®_g¿d›Á
(
i
èğ(
Ãw_ªs
 - 
ªs
è/ 
d–
;

185 
	gKALDI_LOG
 << "Mªu®ly compu‹d g¿d›Á i " << 
	gmªu®_g¿d›Á
;

186 
	gKALDI_LOG
 << "G¿d›Á wcompu‹d i " << *
	gg¿d›Á
;

189  
	gªs
;

193 
CombšeNÃts
(cÚ¡ 
NÃtCombšeCÚfig
 &
combše_cÚfig
,

194 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

195 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s
,

196 
NÃt
 *
Â‘_out
) {

198 
	gVeùÜ
<> 
	gsÿË_·¿ms
;

200 
G‘In™ŸlSÿËP¬ams
(
combše_cÚfig
,

201 
v®id©iÚ_£t
,

202 
Â‘s
,

203 &
sÿË_·¿ms
);

205 
št32
 
	gdim
 = 
sÿË_·¿ms
.
Dim
();

206 
KALDI_ASSERT
(
dim
 > 0);

207 
	gVeùÜ
<> 
g¿d›Á
(
dim
);

209 
	gobjf
, 
	gš™Ÿl_objf
;

211 
LbfgsO±iÚs
 
	glbfgs_İtiÚs
;

212 
	glbfgs_İtiÚs
.
	gmšimize
 = 
çl£
;

213 
	glbfgs_İtiÚs
.
	gm
 = 
dim
;

215 
	glbfgs_İtiÚs
.
	gfœ¡_¡•_im´
 = 
combše_cÚfig
.
š™Ÿl_im´
;

217 
	gO±imizeLbfgs
<> 
lbfgs
(
sÿË_·¿ms
,

218 
lbfgs_İtiÚs
);

220 
št32
 
	gi
 = 0; i < 
	gcombše_cÚfig
.
	gnum_bfgs_™”s
; i++) {

221 
	gsÿË_·¿ms
.
CİyFromVec
(
lbfgs
.
G‘Prİo£dV®ue
());

222 
	gobjf
 = 
Compu‹ObjfAndG¿d›Á
(
v®id©iÚ_£t
,

223 
sÿË_·¿ms
,

224 
Â‘s
,

225 
combše_cÚfig
.
‹¡_g¿d›Á
,

226 &
g¿d›Á
);

228 
KALDI_VLOG
(2è<< "I‹¿tiÚ " << 
	gi
 << " sÿË-·¿m ğ" << 
	gsÿË_·¿ms


229 << ", objàğ" << 
	gobjf
 << ", g¿d›Á = " << 
	gg¿d›Á
;

231 ià(
	gi
 =ğ0è
š™Ÿl_objf
 = 
objf
;

233 
	glbfgs
.
DoS‹p
(
objf
, 
g¿d›Á
);

236 
	gsÿË_·¿ms
.
CİyFromVec
(
lbfgs
.
G‘V®ue
(&
objf
));

238 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms_æßt
(
sÿË_·¿ms
);

240 
	gKALDI_LOG
 << "Combining‚nets, validation objf…er frame changed from "

241 << 
	gš™Ÿl_objf
 << "Ø" << 
	gobjf
;

243 
	gM©rix
<
	gBa£Flßt
> 
sÿË_·¿ms_m©
(
Â‘s
.
size
(),

244 
Â‘s
[0].
NumUpd©abËCompÚ’ts
());

245 
	gsÿË_·¿ms_m©
.
CİyRowsFromVec
(
sÿË_·¿ms_æßt
);

246 
	gKALDI_LOG
 << "Fš® sÿË faùÜ ¬" << 
	gsÿË_·¿ms_m©
;

248 
CombšeNÃts
(
sÿË_·¿ms_æßt
, 
Â‘s
, 
Â‘_out
);

	@combine-nnet.h

20 #iâdeà
KALDI_NNET2_COMBINE_NNET_H_


21 
	#KALDI_NNET2_COMBINE_NNET_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"ut/·r£-İtiÚs.h
"

26 
	~"™f/İtiÚs-™f.h
"

28 
Çme¥aû
 
	gk®di
 {

29 
Çme¥aû
 
	gÂ‘2
 {

35 
	sNÃtCombšeCÚfig
 {

36 
št32
 
	gš™Ÿl_mod–
;

38 
št32
 
	gnum_bfgs_™”s
;

44 
Ba£Flßt
 
	gš™Ÿl_im´
;

45 
boŞ
 
	g‹¡_g¿d›Á
;

46 
NÃtCombšeCÚfig
(): 
š™Ÿl_mod–
(-1), 
num_bfgs_™”s
(30),

47 
š™Ÿl_im´
(0.01),

48 
‹¡_g¿d›Á
(
çl£
) { }

50 
Regi¡”
(
O±iÚsItf
 *
İts
) {

51 
	gİts
->
Regi¡”
("š™Ÿl-mod–", &
š™Ÿl_mod–
, "Specifies whereo starthe "

55 
	gİts
->
Regi¡”
("num-bfgs-™”s", &
num_bfgs_™”s
, "Maximum‚umber of function "

57 
	gİts
->
Regi¡”
("š™Ÿl-im´", &
š™Ÿl_im´
, "Amount of objective-function change "

59 
	gİts
->
Regi¡”
("‹¡-g¿d›Á", &
‹¡_g¿d›Á
, "Ifrue,‡ctivate codehat "

64 
CombšeNÃts
(cÚ¡ 
NÃtCombšeCÚfig
 &
combše_cÚfig
,

65 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

66 cÚ¡ 
¡d
::
veùÜ
<
NÃt
> &
Â‘s_š
,

67 
NÃt
 *
Â‘_out
);

	@decodable-am-nnet.h

20 #iâdeà
KALDI_NNET2_DECODABLE_AM_NNET_H_


21 
	#KALDI_NNET2_DECODABLE_AM_NNET_H_


	)

23 
	~<veùÜ
>

24 
	~"ba£/k®di-commÚ.h
"

25 
	~"gmm/am-dŸg-gmm.h
"

26 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
	~"™f/decodabË-™f.h
"

28 
	~"Â‘2/am-Â‘.h
"

29 
	~"Â‘2/Â‘-compu‹.h
"

31 
Çme¥aû
 
	gk®di
 {

32 
Çme¥aû
 
	gÂ‘2
 {

37 şas 
	cDecodabËAmNÃt
: 
public
 
DecodabËIÁ”çû
 {

38 
public
:

39 
DecodabËAmNÃt
(cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

40 cÚ¡ 
AmNÃt
 &
am_Â‘
,

41 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
ã©s
,

42 
boŞ
 
·d_šput
 = 
Œue
,

44 
Ba£Flßt
 
´ob_sÿË
 = 1.0):

45 
Œªs_mod–_
(
Œªs_mod–
) {

49 
št32
 
num_rows
 = 
ã©s
.
NumRows
() -

50 (
·d_šput
 ? 0 : 
am_Â‘
.
G‘NÃt
().
LeáCÚ‹xt
() +

51 
am_Â‘
.
G‘NÃt
().
RightCÚ‹xt
());

52 ià(
	gnum_rows
 <= 0) {

53 
KALDI_WARN
 << "IÅuˆw™h " << 
ã©s
.
NumRows
() << "„ows will…roduce "

57 
	gCuM©rix
<
	gBa£Flßt
> 
log_´obs
(
num_rows
, 
Œªs_mod–
.
NumPdfs
());

59 
NÃtComputiÚ
(
am_Â‘
.
G‘NÃt
(), 
ã©s
, 
·d_šput
, &
log_´obs
);

60 
	glog_´obs
.
AµlyFloÜ
(1.0e-20);

61 
	glog_´obs
.
AµlyLog
();

62 
	gCuVeùÜ
<
	gBa£Flßt
> 
´iÜs
(
am_Â‘
.
PriÜs
());

63 
KALDI_ASSERT
(
´iÜs
.
Dim
(è=ğ
Œªs_mod–
.
NumPdfs
() &&

65 
	g´iÜs
.
AµlyLog
();

67 
	glog_´obs
.
AddVecToRows
(-1.0, 
´iÜs
);

69 
	glog_´obs
.
SÿË
(
´ob_sÿË
);

72 
	glog_´obs_
.
Sw­
(&
log_´obs
);

77 
vœtu®
 
Ba£Flßt
 
LogLik–ihood
(
št32
 
äame
, iÁ32 
Œªs™iÚ_id
) {

78  
log_´obs_
(
äame
,

79 
Œªs_mod–_
.
T¿ns™iÚIdToPdf
(
Œªs™iÚ_id
));

82 
vœtu®
 
št32
 
NumF¿mesR—dy
(ècÚ¡ {  
	glog_´obs_
.
NumRows
(); }

85 
vœtu®
 
št32
 
NumIndiûs
(ècÚ¡ {  
	gŒªs_mod–_
.
NumT¿ns™iÚIds
(); }

87 
vœtu®
 
boŞ
 
IsLa¡F¿me
(
št32
 
äame
) const {

88 
KALDI_ASSERT
(
äame
 < 
NumF¿mesR—dy
());

89  (
	gäame
 =ğ
NumF¿mesR—dy
() - 1);

92 
	g´Ùeùed
:

93 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–_
;

94 
	gM©rix
<
	gBa£Flßt
> 
	glog_´obs_
;

97 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
DecodabËAmNÃt
);

105 şas 
	cDecodabËAmNÃtP¬®Ël
: 
public
 
DecodabËIÁ”çû
 {

106 
public
:

107 
DecodabËAmNÃtP¬®Ël
(

108 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

109 cÚ¡ 
AmNÃt
 &
am_Â‘
,

110 cÚ¡ 
CuM©rix
<
Ba£Flßt
> *
ã©s
,

111 
boŞ
 
·d_šput
 = 
Œue
,

112 
Ba£Flßt
 
´ob_sÿË
 = 1.0):

113 
Œªs_mod–_
(
Œªs_mod–
), 
am_Â‘_
(
am_Â‘
), 
ã©s_
(
ã©s
),

114 
·d_šput_
(
·d_šput
), 
´ob_sÿË_
(
´ob_sÿË
) {

115 
KALDI_ASSERT
(
ã©s_
 !ğ
NULL
);

118 
Compu‹
() {

119 
	glog_´obs_
.
Resize
(
ã©s_
->
NumRows
(), 
Œªs_mod–_
.
NumPdfs
());

121 
NÃtComputiÚ
(
am_Â‘_
.
G‘NÃt
(), *
ã©s_
,

122 
·d_šput_
, &
log_´obs_
);

123 
	glog_´obs_
.
AµlyFloÜ
(1.0e-20);

124 
	glog_´obs_
.
AµlyLog
();

125 
	gCuVeùÜ
<
	gBa£Flßt
> 
´iÜs
(
am_Â‘_
.
PriÜs
());

126 
KALDI_ASSERT
(
´iÜs
.
Dim
(è=ğ
Œªs_mod–_
.
NumPdfs
() &&

128 
	g´iÜs
.
AµlyLog
();

130 
	glog_´obs_
.
AddVecToRows
(-1.0, 
´iÜs
);

132 
	glog_´obs_
.
SÿË
(
´ob_sÿË_
);

133 
d–‘e
 
	gã©s_
;

134 
	gã©s_
 = 
NULL
;

139 
vœtu®
 
Ba£Flßt
 
LogLik–ihood
(
št32
 
äame
, iÁ32 
Œªs™iÚ_id
) {

140 ià(
	gã©s_
è
Compu‹
();

141  
log_´obs_
(
äame
,

142 
Œªs_mod–_
.
T¿ns™iÚIdToPdf
(
Œªs™iÚ_id
));

145 
št32
 
NumF¿mesR—dy
() const {

146 ià(
	gã©s_
) {

147 ià(
	g·d_šput_
è 
	gã©s_
->
NumRows
();

149 
št32
 
	gªs
 = 
ã©s_
->
NumRows
(è- 
am_Â‘_
.
G‘NÃt
().
LeáCÚ‹xt
() -

150 
am_Â‘_
.
G‘NÃt
().
RightCÚ‹xt
();

151 ià(
	gªs
 < 0)‡ns = 0;

152  
	gªs
;

155  
	glog_´obs_
.
NumRows
();

160 
vœtu®
 
št32
 
NumIndiûs
(ècÚ¡ {  
	gŒªs_mod–_
.
NumT¿ns™iÚIds
(); }

162 
vœtu®
 
boŞ
 
IsLa¡F¿me
(
št32
 
äame
) const {

163 
KALDI_ASSERT
(
äame
 < 
NumF¿mesR—dy
());

164  (
	gäame
 =ğ
NumF¿mesR—dy
() - 1);

166 ~
DecodabËAmNÃtP¬®Ël
() {

167 
d–‘e
 
	gã©s_
;

169 
	g´Ùeùed
:

170 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–_
;

171 cÚ¡ 
	gAmNÃt
 &
	gam_Â‘_
;

172 
	gCuM©rix
<
	gBa£Flßt
> 
	glog_´obs_
;

174 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> *
	gã©s_
;

175 
boŞ
 
	g·d_šput_
;

176 
Ba£Flßt
 
	g´ob_sÿË_
;

177 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
DecodabËAmNÃtP¬®Ël
);

	@get-feature-transform.cc

22 
	~"Â‘2/g‘-ã©u»-ŒªsfÜm.h
"

24 
Çme¥aû
 
	gk®di
 {

28 
	gF—tu»T¿nsfÜmE¡im©e
::
E¡im©e
(cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

29 
M©rix
<
Ba£Flßt
> *
M
,

30 
TpM©rix
<
Ba£Flßt
> *
C
) const {

31 
	gcouÁ
;

32 
	gVeùÜ
<> 
	gtÙ®_m—n
;

33 
	gSpM©rix
<> 
	gtÙ®_cov¬
, 
	gb‘w“n_cov¬
;

34 
G‘Sts
(&
tÙ®_cov¬
, &
b‘w“n_cov¬
, &
tÙ®_m—n
, &
couÁ
);

35 
	gKALDI_LOG
 << "D©¨couÁ i " << 
	gcouÁ
;

36 
E¡im©eIÁ”Çl
(
İts
, 
tÙ®_cov¬
, 
b‘w“n_cov¬
, 
tÙ®_m—n
, 
M
, 
C
);

40 
	gF—tu»T¿nsfÜmE¡im©e
::
E¡im©eIÁ”Çl
(

41 cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

42 cÚ¡ 
SpM©rix
<> &
tÙ®_cov¬
,

43 cÚ¡ 
SpM©rix
<> &
b‘w“n_cov¬
,

44 cÚ¡ 
VeùÜ
<> &
tÙ®_m—n
,

45 
M©rix
<
Ba£Flßt
> *
M
,

46 
TpM©rix
<
Ba£Flßt
> *
C
) {

48 
št32
 
	grg‘_dim
 = 
İts
.
dim
, 
	gdim
 = 
tÙ®_cov¬
.
NumRows
();

50 ià(
	grg‘_dim
 <= 0)

51 
rg‘_dim
 = 
dim
;

53 
KALDI_ASSERT
(
rg‘_dim
 <ğ
dim
);

56 
	gSpM©rix
<> 
wc_cov¬
(
tÙ®_cov¬
);

57 
	gwc_cov¬
.
AddSp
(-1.0, 
b‘w“n_cov¬
);

58 
	gTpM©rix
<> 
wc_cov¬_sq¹
(
dim
);

59 
	gŒy
 {

60 
	gwc_cov¬_sq¹
.
ChŞesky
(
wc_cov¬
);

61 ià(
	gC
 !ğ
NULL
) {

62 
C
->
Resize
(
dim
);

63 
	gC
->
CİyFromTp
(
wc_cov¬_sq¹
);

65 } 
ÿtch
 (...) {

66 
Ba£Flßt
 
	gsmoÙh
 = 1.0e-03 * 
wc_cov¬
.
T¿û
(è/ wc_cov¬.
NumRows
();

67 
	gKALDI_LOG
 << "ChŞesky faed (possibly‚Ù +vdefš™e), sØaddšg " << 
	gsmoÙh


69 
št32
 
	gi
 = 0; i < 
	gwc_cov¬
.
NumRows
(); i++)

70 
wc_cov¬
(
i
, iè+ğ
smoÙh
;

71 
	gwc_cov¬_sq¹
.
ChŞesky
(
wc_cov¬
);

73 
	gM©rix
<> 
wc_cov¬_sq¹_m©
(
wc_cov¬_sq¹
);

74 
	gwc_cov¬_sq¹_m©
.
Inv”t
();

76 
	gSpM©rix
<> 
tmp_¥
(
dim
);

77 
	gtmp_¥
.
AddM©2Sp
(1.0, 
wc_cov¬_sq¹_m©
, 
kNoT¿ns
, 
b‘w“n_cov¬
, 0.0);

78 
	gM©rix
<> 
tmp_m©
(
tmp_¥
);

79 
	gM©rix
<> 
svd_u
(
dim
, dim), 
svd_vt
(dim, dim);

80 
	gVeùÜ
<> 
svd_d
(
dim
);

81 
	gtmp_m©
.
Svd
(&
svd_d
, &
svd_u
, &
svd_vt
);

82 
SÜtSvd
(&
svd_d
, &
svd_u
);

84 
	gKALDI_LOG
 << "LDA sšguÏ¸v®ue ¬" << 
	gsvd_d
;

86 
	gKALDI_LOG
 << "Sum oà®ÈsšguÏ¸v®ue i " << 
	gsvd_d
.
Sum
();

87 
	gKALDI_LOG
 << "Sum of selected singular values is " <<

88 
	gSubVeùÜ
<>(
	gsvd_d
, 0, 
	grg‘_dim
).
Sum
();

90 
	gM©rix
<> 
lda_m©
(
dim
, dim);

91 
	glda_m©
.
AddM©M©
(1.0, 
svd_u
, 
kT¿ns
, 
wc_cov¬_sq¹_m©
, 
kNoT¿ns
, 0.0);

94 
	gM
->
Resize
(
rg‘_dim
, 
dim
);

95 
	gM
->
CİyFromM©
(
lda_m©
.
Rªge
(0, 
rg‘_dim
, 0, 
dim
));

97 ià(
	gİts
.
	gw™hš_şass_çùÜ
 != 1.0) {

98 
št32
 
i
 = 0; 
	gi
 < 
	gsvd_d
.
Dim
(); i++) {

99 
Ba£Flßt
 
	gŞd_v¬
 = 1.0 + 
svd_d
(
i
),

100 
	gÃw_v¬
 = 
İts
.
w™hš_şass_çùÜ
 + 
svd_d
(
i
),

101 
	gsÿË
 = 
sq¹
(
Ãw_v¬
 / 
Şd_v¬
);

102 ià(
	gi
 < 
	gM
->
NumRows
())

103 
	gM
->
Row
(
i
).
SÿË
(
sÿË
);

107 ià(
	gİts
.
	gmax_sšguÏr_v®ue
 > 0.0) {

108 
št32
 
	grows
 = 
M
->
NumRows
(), 
	gcŞs
 = M->
NumCŞs
(),

109 
	gmš_dim
 = 
¡d
::
mš
(
rows
, 
cŞs
);

110 
	gM©rix
<
	gBa£Flßt
> 
U
(
rows
, 
mš_dim
), 
Vt
(mš_dim, 
cŞs
);

111 
	gVeùÜ
<
	gBa£Flßt
> 
s
(
mš_dim
);

112 
	gM
->
Svd
(&
s
, &
U
, &
Vt
);

113 
Ba£Flßt
 
	gmax_s
 = 
s
.
Max
();

114 
št32
 
	gn
 = 
s
.
AµlyCešg
(
İts
.
max_sšguÏr_v®ue
);

115 ià(
	gn
 > 0) {

116 
	gKALDI_LOG
 << "Aµl›d cešgØ" << 
	gn
 << " ouˆoà" << 
	gs
.
Dim
()

118 << 
	gİts
.
	gmax_sšguÏr_v®ue
 << ", max i " << 
	gmax_s
;

119 
	gVt
.
MulRowsVec
(
s
);

121 
	gM
->
AddM©M©
(1.0, 
U
, 
kNoT¿ns
, 
Vt
, kNoTrans, 0.0);

125 ià(
	gİts
.
	g»move_off£t
)

126 
AddM—nOff£t
(
tÙ®_m—n
, 
M
);

129 
	gF—tu»T¿nsfÜmE¡im©eMuÉi
::
E¡im©eT¿nsfÜmP¬t
(

130 cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

131 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
šdexes
,

132 cÚ¡ 
SpM©rix
<> &
tÙ®_cov¬
,

133 cÚ¡ 
SpM©rix
<> &
b‘w“n_cov¬
,

134 cÚ¡ 
VeùÜ
<> &
m—n
,

135 
M©rix
<
Ba£Flßt
> *
M
) const {

137 
št32
 
	gfuÎ_dim
 = 
Dim
(), 
	g´oj_dim
 = 
šdexes
.
size
();

138 
	gM©rix
<> 
ŒªsfÜm
(
´oj_dim
, 
fuÎ_dim
);

139 
št32
 
	gi
 = 0; i < 
	g´oj_dim
; i++)

140 
ŒªsfÜm
(
i
, 
šdexes
[i]) = 1.0;

142 
	gSpM©rix
<> 
tÙ®_cov¬_´oj
(
´oj_dim
), 
b‘w“n_cov¬_´oj
(proj_dim);

143 
	gVeùÜ
<> 
m—n_´oj
(
´oj_dim
);

144 
	gtÙ®_cov¬_´oj
.
AddM©2Sp
(1.0, 
ŒªsfÜm
, 
kNoT¿ns
, 
tÙ®_cov¬
, 0.0);

145 
	gb‘w“n_cov¬_´oj
.
AddM©2Sp
(1.0, 
ŒªsfÜm
, 
kNoT¿ns
, 
b‘w“n_cov¬
, 0.0);

146 
	gm—n_´oj
.
AddM©Vec
(1.0, 
ŒªsfÜm
, 
kNoT¿ns
, 
m—n
, 0.0);

148 
	gM©rix
<
	gBa£Flßt
> 
	gM_´oj
;

149 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 
İts_tmp
(
İts
);

150 
	gİts_tmp
.
	gdim
 = 
´oj_dim
;

151 
E¡im©eIÁ”Çl
(
İts_tmp
, 
tÙ®_cov¬_´oj
, 
b‘w“n_cov¬_´oj
, 
m—n_´oj
,

152 &
M_´oj
, 
NULL
);

153 ià(
	gM_´oj
.
NumCŞs
(è=ğ
´oj_dim
 + 1) {

155 
ŒªsfÜm
.
Resize
(
´oj_dim
 + 1, 
fuÎ_dim
 + 1, 
kCİyD©a
);

156 
ŒªsfÜm
(
´oj_dim
, 
fuÎ_dim
) = 1.0;

158 
	gM
->
Resize
(
´oj_dim
, 
ŒªsfÜm
.
NumCŞs
());

160 
	gM
->
AddM©M©
(1.0, 
M_´oj
, 
kNoT¿ns
, 
M©rix
<
Ba£Flßt
>(
ŒªsfÜm
),

161 
kNoT¿ns
, 0.0);

164 
	gF—tu»T¿nsfÜmE¡im©eMuÉi
::
E¡im©e
(

165 cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

166 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
šdexes
,

167 
M©rix
<
Ba£Flßt
> *
M
) const {

169 
št32
 
	gšput_dim
 = 
Dim
(), 
	gouut_dim
 = 0, 
	gnum_ŒªsfÜms
 = 
šdexes
.
size
();

170 
št32
 
	gi
 = 0; i < 
	gnum_ŒªsfÜms
; i++) {

171 
KALDI_ASSERT
(
šdexes
[
i
].
size
() > 0);

172 
	g¡d
::
veùÜ
<
št32
> 
this_šdexes
(
šdexes
[
i
]);

173 
	g¡d
::
sÜt
(
this_šdexes
.
begš
(),his_šdexes.
’d
());

174 
KALDI_ASSERT
(
IsSÜ‹dAndUniq
(
this_šdexes
));

175 
KALDI_ASSERT
(
this_šdexes
.
äÚt
() >= 0);

176 
KALDI_ASSERT
(
this_šdexes
.
back
(è< 
šput_dim
);

177 
	gouut_dim
 +ğ
this_šdexes
.
size
();

180 
št32
 
	gšput_dim_ext
 = (
İts
.
»move_off£t
 ? 
šput_dim
 + 1 : input_dim);

181 
	gM
->
Resize
(
ouut_dim
, 
šput_dim_ext
);

183 
	gcouÁ
;

184 
	gVeùÜ
<> 
	gtÙ®_m—n
;

185 
	gSpM©rix
<> 
	gtÙ®_cov¬
, 
	gb‘w“n_cov¬
;

186 
G‘Sts
(&
tÙ®_cov¬
, &
b‘w“n_cov¬
, &
tÙ®_m—n
, &
couÁ
);

188 
št32
 
	gcur_ouut_šdex
 = 0;

189 
št32
 
	gi
 = 0; i < 
	gnum_ŒªsfÜms
; i++) {

190 
	gM©rix
<
	gBa£Flßt
> 
	gM_tmp
;

191 
E¡im©eT¿nsfÜmP¬t
(
İts
, 
šdexes
[
i
], 
tÙ®_cov¬
, 
b‘w“n_cov¬
,

192 
tÙ®_m—n
, &
M_tmp
);

193 
št32
 
	gthis_ouut_dim
 = 
šdexes
[
i
].
size
();

194 
	gM
->
Rªge
(
cur_ouut_šdex
, 
this_ouut_dim
, 0, 
M
->
NumCŞs
()).

195 
CİyFromM©
(
M_tmp
);

196 
	gcur_ouut_šdex
 +ğ
this_ouut_dim
;

	@get-feature-transform.h

21 #iâdeà
KALDI_NNET2_GET_FEATURE_TRANSFORM_H_


22 
	#KALDI_NNET2_GET_FEATURE_TRANSFORM_H_


	)

24 
	~"ba£/k®di-commÚ.h
"

25 
	~"ut/commÚ-uts.h
"

26 
	~"m©rix/m©rix-lib.h
"

27 
	~"ŒªsfÜm/lda-e¡im©e.h
"

29 
Çme¥aû
 
	gk®di
 {

39 
	sF—tu»T¿nsfÜmE¡im©eO±iÚs
 {

40 
boŞ
 
	g»move_off£t
;

41 
št32
 
	gdim
;

42 
Ba£Flßt
 
	gw™hš_şass_çùÜ
;

43 
Ba£Flßt
 
	gmax_sšguÏr_v®ue
;

44 
F—tu»T¿nsfÜmE¡im©eO±iÚs
(): 
»move_off£t
(
Œue
), 
dim
(-1),

45 
w™hš_şass_çùÜ
(0.001), 
max_sšguÏr_v®ue
(5.0) { }

47 
Regi¡”
(
O±iÚsItf
 *
İts
) {

48 
	gİts
->
Regi¡”
("»move-off£t", &
»move_off£t
, "Ifrue, output‡n‡ffine "

50 
	gİts
->
Regi¡”
("dim", &
dim
, "Dimensiono…rojecto with LDA");

51 
	gİts
->
Regi¡”
("w™hš-şass-çùÜ", &
w™hš_şass_çùÜ
, "If 1.0, do "

56 
	gİts
->
Regi¡”
("max-sšguÏr-v®ue", &
max_sšguÏr_v®ue
, "If >0, maximum "

133 şas 
	cF—tu»T¿nsfÜmE¡im©e
: 
public
 
LdaE¡im©e
 {

134 
public
:

144 
E¡im©e
(cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

145 
M©rix
<
Ba£Flßt
> *
M
,

146 
TpM©rix
<
Ba£Flßt
> *
w™hš_chŞesky
) const;

147 
	g´Ùeùed
:

148 
E¡im©eIÁ”Çl
(cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

149 cÚ¡ 
SpM©rix
<> &
tÙ®_cov¬
,

150 cÚ¡ 
SpM©rix
<> &
b‘w“n_cov¬
,

151 cÚ¡ 
VeùÜ
<> &
m—n
,

152 
M©rix
<
Ba£Flßt
> *
M
,

153 
TpM©rix
<
Ba£Flßt
> *
C
);

157 şas 
	cF—tu»T¿nsfÜmE¡im©eMuÉi
: 
public
 
F—tu»T¿nsfÜmE¡im©e
 {

158 
public
:

162 
E¡im©e
(cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

163 cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
šdexes
,

164 
M©rix
<
Ba£Flßt
> *
M
) const;

166 
	g´iv©e
:

167 
E¡im©eT¿nsfÜmP¬t
(cÚ¡ 
F—tu»T¿nsfÜmE¡im©eO±iÚs
 &
İts
,

168 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
šdexes
,

169 cÚ¡ 
SpM©rix
<> &
tÙ®_cov¬
,

170 cÚ¡ 
SpM©rix
<> &
b‘w“n_cov¬
,

171 cÚ¡ 
VeùÜ
<> &
m—n
,

172 
M©rix
<
Ba£Flßt
> *
M
) const;

	@mixup-nnet.cc

20 
	~"Â‘2/mixup-Â‘.h
"

21 
	~"gmm/mod–-commÚ.h
"

22 
	~<num”ic
>

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

37 
GiveNÃtCÜ»ùTİŞogy
(
NÃt
 *
Â‘
,

38 
AffšeCompÚ’t
 **
affše_compÚ’t
,

39 
SoámaxCompÚ’t
 **
soámax_compÚ’t
,

40 
SumGroupCompÚ’t
 **
sum_group_compÚ’t
) {

41 
št32
 
	gnc
 = 
Â‘
->
NumCompÚ’ts
();

42 
KALDI_ASSERT
(
nc
 > 0);

43 
CompÚ’t
* 
	gcompÚ’t
 = &(
Â‘
->
G‘CompÚ’t
(
nc
 - 1));

44 ià((*
	gsum_group_compÚ’t
 =

45 
dyÇmic_ÿ¡
<
SumGroupCompÚ’t
*>(
compÚ’t
)è=ğ
NULL
) {

46 
KALDI_LOG
 << "Adding SumGroupComponento‚eural‚et.";

47 
št32
 
	gdim
 = 
compÚ’t
->
OuutDim
();

49 
	g¡d
::
veùÜ
<
št32
> 
sizes
(
dim
, 1);

51 *
	gsum_group_compÚ’t
 = 
Ãw
 
SumGroupCompÚ’t
();

52 (*
	gsum_group_compÚ’t
)->
In™
(
sizes
);

53 
	gÂ‘
->
Aµ’d
(*
sum_group_compÚ’t
);

54 
	gnc
++;

56 
	gcompÚ’t
 = &(
Â‘
->
G‘CompÚ’t
(
nc
 - 2));

57 ià((*
	gsoámax_compÚ’t
 = 
dyÇmic_ÿ¡
<
SoámaxCompÚ’t
*>(
compÚ’t
)è=ğ
NULL
)

58 
KALDI_ERR
 << "Neural‚et has wrongopology:ƒxpected second-to-last "

60 << 
compÚ’t
->
Ty³
();

61 
	gcompÚ’t
 = &(
Â‘
->
G‘CompÚ’t
(
nc
 - 3));

62 ià((*
	gaffše_compÚ’t
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
compÚ’t
)è=ğ
NULL
)

63 
KALDI_ERR
 << "Neural‚et has wrongopology:ƒxpectedhird-to-last "

65 << 
compÚ’t
->
Ty³
();

86 
MixupNÃt
(cÚ¡ 
NÃtMixupCÚfig
 &
mixup_cÚfig
,

87 
NÃt
 *
Â‘
) {

88 
AffšeCompÚ’t
 *
	gaffše_compÚ’t
 = 
NULL
;

89 
SoámaxCompÚ’t
 *
	gsoámax_compÚ’t
 = 
NULL
;

90 
SumGroupCompÚ’t
 *
	gsum_group_compÚ’t
 = 
NULL
;

91 
GiveNÃtCÜ»ùTİŞogy
(
Â‘
,

92 &
affše_compÚ’t
,

93 &
soámax_compÚ’t
,

94 &
sum_group_compÚ’t
);

96 
	gsoámax_compÚ’t
->
MixUp
(
mixup_cÚfig
.
num_mixtu»s
,

97 
mixup_cÚfig
.
pow”
,

98 
mixup_cÚfig
.
mš_couÁ
,

99 
mixup_cÚfig
.
³¹urb_¡ddev
,

100 
affše_compÚ’t
,

101 
sum_group_compÚ’t
);

102 
	gÂ‘
->
Check
();

107 
	gSoámaxCompÚ’t
::
MixUp
(
št32
 
num_mixtu»s
,

108 
Ba£Flßt
 
pow”
,

109 
Ba£Flßt
 
mš_couÁ
,

110 
Ba£Flßt
 
³¹urb_¡ddev
,

111 
AffšeCompÚ’t
 *
ac
,

112 
SumGroupCompÚ’t
 *
sc
) {

114 
	g¡d
::
veùÜ
<
št32
> 
Şd_sizes
;

115 
	gsc
->
G‘Sizes
(&
Şd_sizes
);

116 
	gVeùÜ
<
	gBa£Flßt
> 
couÁs
(
Şd_sizes
.
size
());

117 
št32
 
	gŞd_dim
 = 0;

118 
size_t
 
	gi
 = 0; i < 
	gŞd_sizes
.
size
(); i++) {

119 
št32
 
	gthis_šput_dim
 = 
Şd_sizes
[
i
];

120 
Ba£Flßt
 
	gthis_tÙ_couÁ
 = 0.0;

123 
št32
 
	gd
 = 0; d < 
	gthis_šput_dim
; d++, 
	gŞd_dim
++)

124 
	gthis_tÙ_couÁ
 +ğ
this
->
v®ue_sum_
(
Şd_dim
);

125 
couÁs
(
i
èğ
this_tÙ_couÁ
;

127 
KALDI_ASSERT
(
Şd_dim
 =ğ
v®ue_sum_
.
Dim
());

128 
KALDI_ASSERT
(
couÁs
.
Sum
() > 0 && "Cannot do mixing up without counts.");

130 
	g¡d
::
veùÜ
<
št32
> 
rg‘s
;

134 
G‘S¶™T¬g‘s
(
couÁs
, 
num_mixtu»s
, 
pow”
, 
mš_couÁ
, &
rg‘s
);

135 
KALDI_ASSERT
(
rg‘s
.
size
(è=ğ
Şd_sizes
.size());

136 
	g¡d
::
veùÜ
<
št32
> 
Ãw_sizes
(
Şd_sizes
.
size
());

137 
size_t
 
	gi
 = 0; i < 
	grg‘s
.
size
(); i++)

138 
	gÃw_sizes
[
i
] = 
¡d
::
max
(
rg‘s
[i], 
Şd_sizes
[i]);

139 
št32
 
	gÃw_dim
 = 
¡d
::
accumuÏ‹
(
Ãw_sizes
.
begš
(),‚ew_sizes.
’d
(),

140 
¡©ic_ÿ¡
<
št32
>(0)),

141 
	gaffše_šput_dim
 = 
ac
->
IÅutDim
();

142 
KALDI_ASSERT
(
Ãw_dim
 >ğ
Şd_dim
);

143 
	gsc
->
In™
(
Ãw_sizes
);

146 
	gVeùÜ
<
	gBa£Flßt
> 
Şd_bŸs_‹rm
(
ac
->
bŸs_·¿ms_
);

147 
	gM©rix
<
	gBa£Flßt
> 
Şd_lš—r_‹rm
(
ac
->
lš—r_·¿ms_
);

149 
	gVeùÜ
<
	gBa£Flßt
> 
Ãw_bŸs_‹rm
(
Ãw_dim
);

150 
	gM©rix
<
	gBa£Flßt
> 
Ãw_lš—r_‹rm
(
Ãw_dim
, 
affše_šput_dim
);

151 
	gVeùÜ
<
	gBa£Flßt
> 
Ãw_couÁs
(
Ãw_dim
);

156 
št32
 
	gŞd_off£t
 = 0, 
	gÃw_off£t
 = 0;

157 
	gVeùÜ
<
	gBa£Flßt
> 
Şd_couÁs
(
this
->
v®ue_sum_
);

158 
size_t
 
	gi
 = 0; i < 
	gŞd_sizes
.
size
(); i++) {

159 
št32
 
	gthis_Şd_dim
 = 
Şd_sizes
[
i
],

160 
	gthis_Ãw_dim
 = 
Ãw_sizes
[
i
],

161 
	gthis_cur_dim
 = 
this_Şd_dim
;

163 
	gSubM©rix
<
	gBa£Flßt
> 
this_Şd_lš—r_‹rm
(
Şd_lš—r_‹rm
,

164 
Şd_off£t
, 
this_Şd_dim
,

165 0, 
affše_šput_dim
),

166 
this_Ãw_lš—r_‹rm
(
Ãw_lš—r_‹rm
,

167 
Ãw_off£t
, 
this_Ãw_dim
,

168 0, 
affše_šput_dim
);

169 
	gSubVeùÜ
<
	gBa£Flßt
> 
this_Şd_bŸs_‹rm
(
Şd_bŸs_‹rm
,

170 
Şd_off£t
, 
this_Şd_dim
),

171 
this_Ãw_bŸs_‹rm
(
Ãw_bŸs_‹rm
, 
Ãw_off£t
, 
this_Ãw_dim
),

172 
this_Şd_couÁs
(
Şd_couÁs
,

173 
Şd_off£t
, 
this_Şd_dim
),

174 
this_Ãw_couÁs
(
Ãw_couÁs
,

175 
Ãw_off£t
, 
this_Ãw_dim
);

178 
	gthis_Ãw_lš—r_‹rm
.
Rªge
(0, 
this_Şd_dim
, 0, 
affše_šput_dim
).

179 
CİyFromM©
(
this_Şd_lš—r_‹rm
);

180 
	gthis_Ãw_bŸs_‹rm
.
Rªge
(0, 
this_Şd_dim
).

181 
CİyFromVec
(
this_Şd_bŸs_‹rm
);

182 
	gthis_Ãw_couÁs
.
Rªge
(0, 
this_Şd_dim
).

183 
CİyFromVec
(
this_Şd_couÁs
);

186 ; 
	gthis_cur_dim
 < 
	gthis_Ãw_dim
;his_cur_dim++) {

187 
Ba£Flßt
 *
	gcouÁ_begš
 = 
this_Ãw_couÁs
.
D©a
(),

188 *
	gcouÁ_’d
 = 
couÁ_begš
 + 
this_cur_dim
,

189 *
	gcouÁ_max
 = 
¡d
::
max_–em’t
(
couÁ_begš
, 
couÁ_’d
);

190 
KALDI_ASSERT
(*
couÁ_max
 > 0.0);

191 *
	gcouÁ_max
 *= 0.5;

192 *
	gcouÁ_’d
 = *
couÁ_max
;

193 
št32
 
	gmax_šdex
 = 
¡©ic_ÿ¡
<št32>(
couÁ_max
 - 
couÁ_begš
),

194 
	gÃw_šdex
 = 
this_cur_dim
;

195 
	gSubVeùÜ
<
	gBa£Flßt
> 
cur_vec
(
this_Ãw_lš—r_‹rm
, 
max_šdex
),

196 
Ãw_vec
(
this_Ãw_lš—r_‹rm
, 
Ãw_šdex
);

197 
	gÃw_vec
.
CİyFromVec
(
cur_vec
);

198 
	gVeùÜ
<
	gBa£Flßt
> 
¿nd
(
affše_šput_dim
);

199 
	g¿nd
.
S‘Rªdn
();

200 
	gcur_vec
.
AddVec
(
³¹urb_¡ddev
, 
¿nd
);

201 
	gÃw_vec
.
AddVec
(-
³¹urb_¡ddev
, 
¿nd
);

202 
this_Ãw_bŸs_‹rm
(
max_šdex
è+ğ
Log
(0.5);

203 
this_Ãw_bŸs_‹rm
(
Ãw_šdex
èğthis_Ãw_bŸs_‹rm(
max_šdex
);

205 
	gŞd_off£t
 +ğ
this_Şd_dim
;

206 
	gÃw_off£t
 +ğ
this_Ãw_dim
;

208 
KALDI_ASSERT
(
Şd_off£t
 =ğ
Şd_dim
 && 
Ãw_off£t
 =ğ
Ãw_dim
);

209 
	gac
->
S‘P¬ams
(
Ãw_bŸs_‹rm
, 
Ãw_lš—r_‹rm
);

210 
	gthis
->
	gv®ue_sum_
.
Resize
(
Ãw_couÁs
.
Dim
());

211 
	gthis
->
	gv®ue_sum_
.
CİyFromVec
(
Ãw_couÁs
);

212 
	gthis
->
	gcouÁ_
 = 
this
->
v®ue_sum_
.
Sum
();

213 
	gthis
->
	gdim_
 = 
Ãw_dim
;

214 
	gKALDI_LOG
 << "Mixed u°äom dim’siÚ oà" << 
	gŞd_dim
 << "Ø" << 
	gÃw_dim


	@mixup-nnet.h

20 #iâdeà
KALDI_NNET2_MIXUP_NNET_H_


21 
	#KALDI_NNET2_MIXUP_NNET_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"™f/İtiÚs-™f.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

30 
	sNÃtMixupCÚfig
 {

31 
Ba£Flßt
 
	gpow”
;

32 
Ba£Flßt
 
	gmš_couÁ
;

33 
št32
 
	gnum_mixtu»s
;

34 
Ba£Flßt
 
	g³¹urb_¡ddev
;

37 
NÃtMixupCÚfig
(): 
pow”
(0.25), 
mš_couÁ
(1000.0),

38 
num_mixtu»s
(-1), 
³¹urb_¡ddev
(0.01) { }

40 
Regi¡”
(
O±iÚsItf
 *
İts
) {

41 
	gİts
->
Regi¡”
("pow”", &
pow”
, "Scaling factor used in determininghe "

44 
	gİts
->
Regi¡”
("mš-couÁ", &
mš_couÁ
, "Minimum count for‡ quasi-Gaussian, "

46 
	gİts
->
Regi¡”
("num-mixtu»s", &
num_mixtu»s
, "If specified,otal‚umber of "

49 
	gİts
->
Regi¡”
("³¹urb-¡ddev", &
³¹urb_¡ddev
, "Standard deviation used "

61 
MixupNÃt
(cÚ¡ 
NÃtMixupCÚfig
 &
mixup_cÚfig
,

62 
NÃt
 *
Â‘
);

	@nnet-component-test.cc

21 
	~"Â‘2/Â‘-compÚ’t.h
"

22 
	~"ut/commÚ-uts.h
"

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

28 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(cÚ¡ 
CompÚ’t
 &
compÚ’t
,

29 cÚ¡ 
ChunkInfo
 
š_šfo
,

30 cÚ¡ 
ChunkInfo
 
out_šfo
) {

32 
	gCuM©rix
<
	gBa£Flßt
> 
šput
(
š_šfo
.
NumRows
(), in_šfo.
NumCŞs
()),

33 
ouut
(1, 
out_šfo
.
NumRows
(è* out_šfo.
NumCŞs
());

34 
	gšput
.
S‘Rªdn
();

35 
	gCuVeùÜ
<
	gBa£Flßt
> 
objf_vec
(
out_šfo
.
NumCŞs
());

36 
	gobjf_vec
.
S‘Rªdn
();

38 
št32
 
	g¿nd_£ed
 = 
Rªd
();

40 
RªdomCompÚ’t
 *
	g¿nd_compÚ’t
 =

41 
cÚ¡_ÿ¡
<
RªdomCompÚ’t
*>(
dyÇmic_ÿ¡
<cÚ¡ RªdomCompÚ’t*>(&
compÚ’t
));

42 ià(
	g¿nd_compÚ’t
 !ğ
NULL
) {

43 
¤ªd
(
¿nd_£ed
);

44 
	g¿nd_compÚ’t
->
Re£tG’”©Ü
();

46 
	gcompÚ’t
.
Prİag©e
(
š_šfo
, 
out_šfo
, 
šput
, &
ouut
);

48 
boŞ
 
	gbš¬y
 = (
Rªd
() % 2 == 0);

49 
Ouut
 
ko
("tmpf", 
bš¬y
);

50 
	gcompÚ’t
.
Wr™e
(
ko
.
SŒ—m
(), 
bš¬y
);

52 
CompÚ’t
 *
	gcompÚ’t_cİy
;

54 
boŞ
 
	gbš¬y_š
;

55 
IÅut
 
ki
("tmpf", &
bš¬y_š
);

56 
	gcompÚ’t_cİy
 = 
CompÚ’t
::
R—dNew
(
ki
.
SŒ—m
(), 
bš¬y_š
);

58 
uÆšk
("tmpf");

61 
	gCuVeùÜ
<
	gBa£Flßt
> 
ouut_objfs
(
out_šfo
.
NumRows
());

62 
	gouut_objfs
.
AddM©Vec
(1.0, 
ouut
, 
kNoT¿ns
, 
objf_vec
, 0.0);

63 
Ba£Flßt
 
	gobjf
 = 
ouut_objfs
.
Sum
();

66 
	gCuM©rix
<
	gBa£Flßt
> 
ouut_d”iv
(
ouut
.
NumRows
(), ouut.
NumCŞs
());

67 
št32
 
	gi
 = 0; i < 
	gouut_d”iv
.
NumRows
(); i++)

68 
	gouut_d”iv
.
Row
(
i
).
CİyFromVec
(
objf_vec
);

70 
	gCuM©rix
<
	gBa£Flßt
> 
šput_d”iv
(
šput
.
NumRows
(), iÅut.
NumCŞs
());

73 
	gCuM©rix
<
	gBa£Flßt
> 
	gem±y_m©
;

74 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput_»f
 =

75 (
compÚ’t_cİy
->
Back´İN“dsIÅut
(è? 
šput
 : 
em±y_m©
),

76 &
	gouut_»f
 =

77 (
compÚ’t_cİy
->
Back´İN“dsOuut
(è? 
ouut
 : 
em±y_m©
);

79 
	gcompÚ’t_cİy
->
Back´İ
(
š_šfo
, 
out_šfo
, 
šput_»f
, 
ouut_»f
,

80 
ouut_d”iv
, 
NULL
, &
šput_d”iv
);

82 
št32
 
	gnum_ok
 = 0, 
	gnum_bad
 = 0, 
	gnum_Œ›s
 = 10;

83 
	gKALDI_LOG
 << "Com·ršg f—tu» g¿d›Á " << 
	gnum_Œ›s
 << "imes.";

84 
št32
 
	gi
 = 0; i < 
	gnum_Œ›s
; i++) {

85 
	gCuM©rix
<
	gBa£Flßt
> 
³¹urbed_šput
(
šput
.
NumRows
(), iÅut.
NumCŞs
());

87 
RªdomCompÚ’t
 *
	g¿nd_compÚ’t
 =

88 
cÚ¡_ÿ¡
<
RªdomCompÚ’t
*>(
dyÇmic_ÿ¡
<cÚ¡ RªdomCompÚ’t*>(&
compÚ’t
));

89 ià(
	g¿nd_compÚ’t
 !ğ
NULL
) {

90 
¤ªd
(
¿nd_£ed
);

91 
	g¿nd_compÚ’t
->
Re£tG’”©Ü
();

94 
	g³¹urbed_šput
.
S‘Rªdn
();

95 
	g³¹urbed_šput
.
SÿË
(1.0e-04);

96 
Ba£Flßt
 
	g´ediùed_difã»nû
 = 
T¿ûM©M©
(
³¹urbed_šput
,

97 
šput_d”iv
, 
kT¿ns
);

98 
	g³¹urbed_šput
.
AddM©
(1.0, 
šput
);

101 
	gCuM©rix
<
	gBa£Flßt
> 
³¹urbed_ouut
(
ouut
.
NumRows
(), ouut.
NumCŞs
());

103 
RªdomCompÚ’t
 *
	g¿nd_compÚ’t
 =

104 
cÚ¡_ÿ¡
<
RªdomCompÚ’t
*>(
dyÇmic_ÿ¡
<cÚ¡ RªdomCompÚ’t*>(&
compÚ’t
));

105 ià(
	g¿nd_compÚ’t
 !ğ
NULL
) {

106 
¤ªd
(
¿nd_£ed
);

107 
	g¿nd_compÚ’t
->
Re£tG’”©Ü
();

110 
	gcompÚ’t
.
Prİag©e
(
š_šfo
, 
out_šfo
, 
³¹urbed_šput
, &
³¹urbed_ouut
);

111 
	gCuVeùÜ
<
	gBa£Flßt
> 
³¹urbed_ouut_objfs
(
out_šfo
.
NumRows
());

112 
	g³¹urbed_ouut_objfs
.
AddM©Vec
(1.0, 
³¹urbed_ouut
, 
kNoT¿ns
,

113 
objf_vec
, 0.0);

114 
Ba£Flßt
 
	g³¹urbed_objf
 = 
³¹urbed_ouut_objfs
.
Sum
(),

115 
	gob£rved_difã»nû
 = 
³¹urbed_objf
 - 
objf
;

116 
	gKALDI_LOG
 << "IÅuˆg¿d›Ás: com·ršg " << 
	g´ediùed_difã»nû


117 << "‡nd " << 
	gob£rved_difã»nû
;

118 ià(
çbs
(
´ediùed_difã»nû
 - 
ob£rved_difã»nû
) >

119 0.15 * 
çbs
((
´ediùed_difã»nû
 + 
ob£rved_difã»nû
)/2) &&

120 
çbs
(
´ediùed_difã»nû
 - 
ob£rved_difã»nû
) > 1.0e-06) {

121 
	gKALDI_WARN
 << "Bad difference!";

122 
	gnum_bad
++;

124 
	gnum_ok
++;

128 
	gKALDI_LOG
 << "Sucûeded fÜ " << 
	gnum_ok
 << " ouˆoà" << 
	gnum_Œ›s


130 ià(
	gnum_ok
 <ğ
num_bad
) {

131 
d–‘e
 
compÚ’t_cİy
;

132 
	gKALDI_ERR
 << "Feature-derivative check failed";

136 
Upd©abËCompÚ’t
 *
	gucompÚ’t
 =

137 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(
compÚ’t_cİy
);

139 ià(
	gucompÚ’t
 !ğ
NULL
) {

141 
št32
 
num_ok
 = 0, 
	gnum_bad
 = 0, 
	gnum_Œ›s
 = 10;

142 
	gKALDI_LOG
 << "Com·ršg mod– g¿d›Á " << 
	gnum_Œ›s
 << "imes.";

143 
št32
 
	gi
 = 0; i < 
	gnum_Œ›s
; i++) {

144 
Upd©abËCompÚ’t
 *
	g³¹urbed_ucompÚ’t
 =

145 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(
ucompÚ’t
->
Cİy
()),

146 *
	gg¿d›Á_ucompÚ’t
 =

147 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(
ucompÚ’t
->
Cİy
());

148 
KALDI_ASSERT
(
³¹urbed_ucompÚ’t
 !ğ
NULL
);

149 
	gg¿d›Á_ucompÚ’t
->
S‘Z”o
(
Œue
);

150 
Ba£Flßt
 
	g³¹urb_¡ddev
 = 5.0e-04;

151 
	g³¹urbed_ucompÚ’t
->
P”turbP¬ams
(
³¹urb_¡ddev
);

153 
	gCuVeùÜ
<
	gBa£Flßt
> 
ouut_objfs
(
out_šfo
.
NumRows
());

154 
	gouut_objfs
.
AddM©Vec
(1.0, 
ouut
, 
kNoT¿ns
, 
objf_vec
, 0.0);

155 
Ba£Flßt
 
	gobjf
 = 
ouut_objfs
.
Sum
();

157 
	gCuM©rix
<
	gBa£Flßt
> 
ouut_d”iv
(
ouut
.
NumRows
(), ouut.
NumCŞs
());

158 
št32
 
	gi
 = 0; i < 
	gouut_d”iv
.
NumRows
(); i++)

159 
	gouut_d”iv
.
Row
(
i
).
CİyFromVec
(
objf_vec
);

160 
	gCuM©rix
<
	gBa£Flßt
> 
	gšput_d”iv
;

163 
	gucompÚ’t
->
Back´İ
(
š_šfo
, 
out_šfo
, 
šput
, 
ouut
, 
ouut_d”iv
,

164 
g¿d›Á_ucompÚ’t
, &
šput_d”iv
);

167 
Ba£Flßt
 
	gobjf_³¹urbed
;

169 
	gCuM©rix
<
	gBa£Flßt
> 
	gouut_³¹urbed
;

171 
RªdomCompÚ’t
 *
	g¿nd_compÚ’t
 =

172 
cÚ¡_ÿ¡
<
RªdomCompÚ’t
*>(
dyÇmic_ÿ¡
<cÚ¡ RªdomCompÚ’t*>(&
compÚ’t
));

173 ià(
	g¿nd_compÚ’t
 !ğ
NULL
) {

174 
¤ªd
(
¿nd_£ed
);

175 
	g¿nd_compÚ’t
->
Re£tG’”©Ü
();

178 
	g³¹urbed_ucompÚ’t
->
Prİag©e
(
š_šfo
, 
out_šfo
, 
šput
, &
ouut_³¹urbed
);

179 
	gCuVeùÜ
<
	gBa£Flßt
> 
ouut_objfs_³¹urbed
(
out_šfo
.
NumRows
());

180 
	gouut_objfs_³¹urbed
.
AddM©Vec
(1.0, 
ouut_³¹urbed
,

181 
kNoT¿ns
, 
objf_vec
, 0.0);

182 
	gobjf_³¹urbed
 = 
ouut_objfs_³¹urbed
.
Sum
();

185 
Ba£Flßt
 
	gd–_objf_ob£rved
 = 
objf_³¹urbed
 - 
objf
,

186 
	gd–_objf_´ediùed
 = (
³¹urbed_ucompÚ’t
->
DÙProduù
(*
g¿d›Á_ucompÚ’t
) -

187 
ucompÚ’t
->
DÙProduù
(*
g¿d›Á_ucompÚ’t
));

189 
	gKALDI_LOG
 << "Mod– g¿d›Ás: com·ršg " << 
	gd–_objf_ob£rved


190 << "‡nd " << 
	gd–_objf_´ediùed
;

191 ià(
çbs
(
d–_objf_´ediùed
 - 
d–_objf_ob£rved
) >

192 0.05 * (
çbs
(
d–_objf_´ediùed
 + 
d–_objf_ob£rved
)/2) &&

193 
çbs
(
d–_objf_´ediùed
 - 
d–_objf_ob£rved
) > 1.0e-06) {

194 
	gKALDI_WARN
 << "Bad difference!";

195 
	gnum_bad
++;

197 
	gnum_ok
++;

199 
d–‘e
 
	g³¹urbed_ucompÚ’t
;

200 
d–‘e
 
	gg¿d›Á_ucompÚ’t
;

202 ià(
	gnum_ok
 < 
	gnum_bad
) {

203 
d–‘e
 
	gcompÚ’t_cİy
;

204 
	gKALDI_ERR
 << "model-derivative check failed";

207 
d–‘e
 
	gcompÚ’t_cİy
;

210 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(cÚ¡ 
CompÚ’t
 &
compÚ’t
) {

211 
št32
 
	gšput_dim
 = 
compÚ’t
.
IÅutDim
(),

212 
	gouut_dim
 = 
compÚ’t
.
OuutDim
();

214 
	gKALDI_LOG
 << 
	gcompÚ’t
.
Info
();

215 
št32
 
	gnum_egs
 = 10 + 
Rªd
() % 5;

216 
št32
 
	gnum_chunks
 = 1,

217 
	gfœ¡_off£t
 = 0,

218 
	gÏ¡_off£t
 = 
num_egs
-1;

220 
ChunkInfo
 
š_šfo
(
šput_dim
, 
num_chunks
, 
fœ¡_off£t
, 
Ï¡_off£t
);

221 
ChunkInfo
 
out_šfo
(
ouut_dim
, 
num_chunks
, 
fœ¡_off£t
, 
Ï¡_off£t
);

222 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
, 
š_šfo
, 
out_šfo
);

227 
Un™Te¡SigmoidCompÚ’t
() {

231 
št32
 
	gšput_dim
 = 10 + 
Rªd
() % 50;

233 
SigmoidCompÚ’t
 
sigmoid_compÚ’t
(
šput_dim
);

234 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
sigmoid_compÚ’t
);

237 
SigmoidCompÚ’t
 
	gsigmoid_compÚ’t
;

238 
	gsigmoid_compÚ’t
.
In™FromSŒšg
("dim=15");

239 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
sigmoid_compÚ’t
);

243 
	g‹m¶©e
<
şass
 
	gT
>

244 
Un™Te¡G’”icCompÚ’t
(
¡d
::
¡ršg
 
exŒa_¡r
 = "") {

251 
št32
 
šput_dim
 = 10 + 
Rªd
() % 50;

253 
T
 
compÚ’t
(
šput_dim
);

254 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

257 
T
 
	gcompÚ’t
;

258 
	gcompÚ’t
.
In™FromSŒšg
(
¡©ic_ÿ¡
<
¡d
::
¡ršg
>("dim=15 "è+ 
exŒa_¡r
);

259 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

263 
Un™Te¡MaxoutCompÚ’t
() {

270 
št32
 
	gi
 = 0; i < 5; i++) {

271 
št32
 
	gouut_dim
 = 10 + 
Rªd
() % 20,

272 
	ggroup_size
 = 1 + 
Rªd
() % 10,

273 
	gšput_dim
 = 
ouut_dim
 * 
group_size
;

275 
MaxoutCompÚ’t
 
compÚ’t
(
šput_dim
, 
ouut_dim
);

276 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

280 
MaxoutCompÚ’t
 
	gcompÚ’t
;

281 
	gcompÚ’t
.
In™FromSŒšg
("input-dim=15 output-dim=5");

282 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

286 
Un™Te¡PnÜmCompÚ’t
() {

290 
št32
 
	gnum_ç
 = 0, 
	gnum_Œ›s
 = 4;

291 
št32
 
	gi
 = 0; i < 
	gnum_Œ›s
; i++) {

292 
	gŒy
 {

293 
št32
 
	gouut_dim
 = 10 + 
Rªd
() % 20,

294 
	ggroup_size
 = 1 + 
Rªd
() % 10,

295 
	gšput_dim
 = 
ouut_dim
 * 
group_size
;

296 
Ba£Flßt
 
	gp
 = 1.0 + 0.1 * (
Rªd
() % 20);

298 
PnÜmCompÚ’t
 
compÚ’t
(
šput_dim
, 
ouut_dim
, 
p
);

299 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

300 } 
ÿtch
 (...) {

301 
	gKALDI_WARN
 << "Ignoringest failure in UnitTestPnormComponent().";

302 
	gnum_ç
++;

305 ià(
	gnum_ç
 >ğ
num_Œ›s
/2) {

306 
KALDI_ERR
 << "Too manyest failures.";

310 
Un™Te¡MaxpoŞšgCompÚ’t
() {

316 
št32
 
	gi
 = 0; i < 5; i++) {

317 
št32
 
	gpoŞ_¡ride
 = 5 + 
Rªd
() % 10,

318 
	gpoŞ_size
 = 2 + 
Rªd
() % 3,

319 
	gnum_poŞs
 = 1 + 
Rªd
() % 10;

320 
št32
 
	gouut_dim
 = 
num_poŞs
 * 
poŞ_¡ride
;

321 
št32
 
	gnum_·tches
 = 
num_poŞs
 * 
poŞ_size
;

322 
št32
 
	gšput_dim
 = 
poŞ_¡ride
 * 
num_·tches
;

324 
MaxpoŞšgCompÚ’t
 
compÚ’t
(
šput_dim
, 
ouut_dim
,

325 
poŞ_size
, 
poŞ_¡ride
);

326 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

330 
MaxpoŞšgCompÚ’t
 
	gcompÚ’t
;

331 
	gcompÚ’t
.
In™FromSŒšg
("input-dim=192 output-dim=64…ool-size=3…ool-stride=16");

332 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

337 
Un™Te¡AffšeCompÚ’t
() {

338 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.01,

339 
	g·¿m_¡ddev
 = 0.1, 
	gbŸs_¡ddev
 = 1.0;

340 
št32
 
	gšput_dim
 = 5 + 
Rªd
(è% 10, 
	gouut_dim
 = 5 + Rand() % 10;

342 
AffšeCompÚ’t
 
	gcompÚ’t
;

343 ià(
Rªd
() % 2 == 0) {

344 
compÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

345 
·¿m_¡ddev
, 
bŸs_¡ddev
);

347 
	gM©rix
<
	gBa£Flßt
> 
m©
(
ouut_dim
 + 1, 
šput_dim
);

348 
	gm©
.
S‘Rªdn
();

349 
	gm©
.
SÿË
(
·¿m_¡ddev
);

350 
Wr™eK®diObjeù
(
m©
, "tmpf", 
Œue
);

351 
SË•
(0.5);

352 
	gcompÚ’t
.
In™
(
Ë¬nšg_¿‹
, "tmpf");

353 
uÆšk
("tmpf");

355 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

358 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=10 output-dim=15…aram-stddev=0.1";

359 
AffšeCompÚ’t
 
	gcompÚ’t
;

360 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

361 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

365 
Un™Te¡CÚvŞutiÚ®1dCompÚ’t
() {

366 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.01,

367 
	g·¿m_¡ddev
 = 0.1, 
	gbŸs_¡ddev
 = 1.0;

368 
št32
 
	g·tch_¡ride
 = 10, 
	g·tch_¡•
 = 1, 
	g·tch_dim
 = 4;

369 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride
 - 
·tch_dim
è/ 
·tch_¡•
;

370 
št32
 
	gnum_¥liû
 = 5 + 
Rªd
(è% 10, 
	gnum_f‹rs
 = 5 + Rand() % 10;

371 
št32
 
	gšput_dim
 = 
·tch_¡ride
 * 
num_¥liû
;

372 
št32
 
	gf‹r_dim
 = 
·tch_dim
 * 
num_¥liû
;

373 
št32
 
	gouut_dim
 = 
num_·tches
 * 
num_f‹rs
;

375 
CÚvŞutiÚ®1dCompÚ’t
 
	gcompÚ’t
;

376 ià(
Rªd
() % 2 == 0) {

377 
compÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

378 
·tch_dim
, 
·tch_¡•
, 
·tch_¡ride
,

379 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
Œue
);

381 
	gM©rix
<
	gBa£Flßt
> 
m©
(
num_f‹rs
, 
f‹r_dim
 + 1);

382 
	gm©
.
S‘Rªdn
();

383 
	gm©
.
SÿË
(
·¿m_¡ddev
);

384 
Wr™eK®diObjeù
(
m©
, "tmpf", 
Œue
);

385 
SË•
(0.5);

386 
	gcompÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
·tch_dim
,

387 
·tch_¡•
, 
·tch_¡ride
, "tmpf", 
çl£
);

388 
uÆšk
("tmpf");

390 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

394 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=100 output-dim=70…aram-stddev=0.1…atch-dim=4…atch-step=1…atch-stride=10";

395 
CÚvŞutiÚ®1dCompÚ’t
 
	gcompÚ’t
;

396 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

397 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

400 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=100 output-dim=70…aram-stddev=0.1…atch-dim=4…atch-step=1…atch-stride=10‡ppended-conv=true";

401 
CÚvŞutiÚ®1dCompÚ’t
 
	gcompÚ’t
;

402 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

403 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

407 
Un™Te¡DrİoutCompÚ’t
() {

411 
št32
 
	gnum_ç
 = 0, 
	gnum_Œ›s
 = 4;

412 
št32
 
	gi
 = 0; i < 
	gnum_Œ›s
; i++) {

413 
	gŒy
 {

414 
št32
 
	gšput_dim
 = 10 + 
Rªd
() % 50;

416 
DrİoutCompÚ’t
 
drİout_compÚ’t
(
šput_dim
, 0.5, 0.3);

417 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
drİout_compÚ’t
);

420 
DrİoutCompÚ’t
 
	gdrİout_compÚ’t
;

421 
	gdrİout_compÚ’t
.
In™FromSŒšg
("dim=15 dropout-proportion=0.6 dropout-scale=0.1");

422 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
drİout_compÚ’t
);

424 } 
ÿtch
 (...) {

425 
	gKALDI_WARN
 << "Ignoringest failure in UnitTestDropoutComponent().";

426 
	gnum_ç
++;

429 ià(
	gnum_ç
 >ğ
num_Œ›s
/2) {

430 
KALDI_ERR
 << "Too manyest failures.";

434 
Un™Te¡Add™iveNoi£CompÚ’t
() {

438 
št32
 
	gnum_ç
 = 0, 
	gnum_Œ›s
 = 4;

439 
št32
 
	gi
 = 0; i < 
	gnum_Œ›s
; i++) {

440 
	gŒy
 {

441 
št32
 
	gšput_dim
 = 10 + 
Rªd
() % 50;

443 
Add™iveNoi£CompÚ’t
 
add™ive_noi£_compÚ’t
(
šput_dim
, 0.1);

444 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
add™ive_noi£_compÚ’t
);

447 
Add™iveNoi£CompÚ’t
 
	gadd™ive_noi£_compÚ’t
;

448 
	gadd™ive_noi£_compÚ’t
.
In™FromSŒšg
("dim=15 stddev=0.2");

449 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
add™ive_noi£_compÚ’t
);

451 } 
ÿtch
 (...) {

452 
	gKALDI_WARN
 << "Ignoring failure in AdditiveNoiseComponentest";

453 
	gnum_ç
++;

456 ià(
	gnum_ç
 >ğ
num_Œ›s
/2) {

457 
KALDI_ERR
 << "Too manyest failures.";

461 
Un™Te¡SÿËCompÚ’t
() {

462 
št32
 
	gdim
 = 1 + 
Rªd
() % 10;

463 
Ba£Flßt
 
	gsÿË
 = 0.1 + 
Rªd
() % 3;

465 
SÿËCompÚ’t
 
	gcompÚ’t
;

466 ià(
Rªd
() % 2 == 0) {

467 
compÚ’t
.
In™
(
dim
, 
sÿË
);

469 
	g¡d
::
o¡ršg¡»am
 
¡r
;

470 
	g¡r
 << "dim=" << 
	gdim
 << " sÿË=" << 
	gsÿË
;

471 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
.str());

473 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

478 
Un™Te¡AffšeCompÚ’tP»cÚd™iÚed
() {

479 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.01,

480 
	g·¿m_¡ddev
 = 0.1, 
	gbŸs_¡ddev
 = 1.0, 
	g®pha
 = 0.01,

481 
	gmax_chªge
 = 100.0;

482 
št32
 
	gšput_dim
 = 5 + 
Rªd
(è% 10, 
	gouut_dim
 = 5 + Rand() % 10;

484 
AffšeCompÚ’tP»cÚd™iÚed
 
	gcompÚ’t
;

485 ià(
Rªd
() % 2 == 0) {

486 
compÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

487 
·¿m_¡ddev
, 
bŸs_¡ddev
,

488 
®pha
, 
max_chªge
);

490 
	gM©rix
<
	gBa£Flßt
> 
m©
(
ouut_dim
 + 1, 
šput_dim
);

491 
	gm©
.
S‘Rªdn
();

492 
	gm©
.
SÿË
(
·¿m_¡ddev
);

493 
Wr™eK®diObjeù
(
m©
, "tmpf", 
Œue
);

494 
SË•
(0.5);

495 
	gcompÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
®pha
, 
max_chªge
, "tmpf");

496 
uÆšk
("tmpf");

498 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

501 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=16 output-dim=15…aram-stddev=0.1‡lpha=0.01";

502 
AffšeCompÚ’tP»cÚd™iÚed
 
	gcompÚ’t
;

503 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

504 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

509 
Un™Te¡AffšeCompÚ’tP»cÚd™iÚedOÆše
() {

510 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.01,

511 
	g·¿m_¡ddev
 = 0.1, 
	gbŸs_¡ddev
 = 1.0, 
	gnum_§m¶es_hi¡Üy
 = 2000.0, 
	g®pha
 = 4.0,

512 
	gmax_chªge_³r_§m¶e
 = 0.1, 
	gupd©e_³riod
 = 1;

513 
št32
 
	gšput_dim
 = 5 + 
Rªd
(è% 10, 
	gouut_dim
 = 5 + Rand() % 10,

514 
	g¿nk_š
 = 1 + 
Rªd
(è% 5, 
	g¿nk_out
 = 1 + Rand() % 5;

516 
AffšeCompÚ’tP»cÚd™iÚedOÆše
 
	gcompÚ’t
;

517 ià(
Rªd
() % 2 == 0) {

518 
compÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

519 
·¿m_¡ddev
, 
bŸs_¡ddev
,

520 
¿nk_š
, 
¿nk_out
, 
upd©e_³riod
,

521 
num_§m¶es_hi¡Üy
, 
®pha
,

522 
max_chªge_³r_§m¶e
);

524 
	gM©rix
<
	gBa£Flßt
> 
m©
(
ouut_dim
 + 1, 
šput_dim
);

525 
	gm©
.
S‘Rªdn
();

526 
	gm©
.
SÿË
(
·¿m_¡ddev
);

527 
Wr™eK®diObjeù
(
m©
, "tmpf", 
Œue
);

528 
SË•
(0.5);

529 
	gcompÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
¿nk_š
, 
¿nk_out
,

530 
upd©e_³riod
, 
num_§m¶es_hi¡Üy
, 
®pha
,

531 
max_chªge_³r_§m¶e
, "tmpf");

532 
uÆšk
("tmpf");

534 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

537 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=16 output-dim=15…aram-stddev=0.1‚um-samples-history=3000‡lpha=2.0 update-period=1„ank-in=5„ank-out=6";

538 
AffšeCompÚ’tP»cÚd™iÚedOÆše
 
	gcompÚ’t
;

539 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

540 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

544 
Un™Te¡BlockAffšeCompÚ’t
() {

545 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.01,

546 
	g·¿m_¡ddev
 = 0.1, 
	gbŸs_¡ddev
 = 0.1;

547 
št32
 
	gnum_blocks
 = 1 + 
Rªd
() % 3,

548 
	gšput_dim
 = 
num_blocks
 * (2 + 
Rªd
() % 4),

549 
	gouut_dim
 = 
num_blocks
 * (2 + 
Rªd
() % 4);

552 
BlockAffšeCompÚ’t
 
	gcompÚ’t
;

553 
	gcompÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

554 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
num_blocks
);

555 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

558 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=10 output-dim=15…aram-stddev=0.1‚um-blocks=5";

559 
BlockAffšeCompÚ’t
 
	gcompÚ’t
;

560 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

561 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

565 
Un™Te¡BlockAffšeCompÚ’tP»cÚd™iÚed
() {

566 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.01,

567 
	g·¿m_¡ddev
 = 0.1, 
	gbŸs_¡ddev
 = 1.0, 
	g®pha
 = 3.0;

568 
št32
 
	gnum_blocks
 = 1 + 
Rªd
() % 3,

569 
	gšput_dim
 = 
num_blocks
 * (2 + 
Rªd
() % 4),

570 
	gouut_dim
 = 
num_blocks
 * (2 + 
Rªd
() % 4);

573 
BlockAffšeCompÚ’tP»cÚd™iÚed
 
	gcompÚ’t
;

574 
	gcompÚ’t
.
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

575 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
num_blocks
, 
®pha
);

576 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

579 cÚ¡ *
	g¡r
 = "learning-rate=0.01 input-dim=10 output-dim=15…aram-stddev=0.1‚um-blocks=5‡lpha=3.0";

580 
BlockAffšeCompÚ’tP»cÚd™iÚed
 
	gcompÚ’t
;

581 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

582 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

587 
Un™Te¡SumGroupCompÚ’t
() {

588 
	g¡d
::
veùÜ
<
št32
> 
sizes
;

589 
št32
 
	gnum_sizes
 = 1 + 
Rªd
() % 5;

590 
št32
 
	gi
 = 0; i < 
	gnum_sizes
; i++)

591 
	gsizes
.
push_back
(1 + 
Rªd
() % 5);

594 
SumGroupCompÚ’t
 
	gcompÚ’t
;

595 
	gcompÚ’t
.
In™
(
sizes
);

596 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

599 cÚ¡ *
	g¡r
 = "sizes=3:4:5";

600 
SumGroupCompÚ’t
 
	gcompÚ’t
;

601 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

602 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

607 
Un™Te¡DùCompÚ’t
() {

608 
št32
 
	gm
 = 1 + 
Rªd
(è% 4, 
	gn
 = 1 + Rand() % 4,

609 
	gdù_dim
 = 
m
, 
	gdim
 = m * 
n
;

610 
boŞ
 
	g»Üd”
 = (
Rªd
() % 2 == 0);

612 
DùCompÚ’t
 
	gcompÚ’t
;

613 
	gcompÚ’t
.
In™
(
dim
, 
dù_dim
, 
»Üd”
);

614 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

617 cÚ¡ *
	g¡r
 = "dim=10 dct-dim=5„eorder=true";

618 
DùCompÚ’t
 
	gcompÚ’t
;

619 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

620 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

623 cÚ¡ *
	g¡r
 = "dim=10 dct-dim=5„eorder=true dct-keep-dim=1";

624 
DùCompÚ’t
 
	gcompÚ’t
;

625 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

626 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

629 cÚ¡ *
	g¡r
 = "dim=10 dct-dim=5„eorder=true dct-keep-dim=2";

630 
DùCompÚ’t
 
	gcompÚ’t
;

631 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

632 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

635 cÚ¡ *
	g¡r
 = "dim=10 dct-dim=5„eorder=true dct-keep-dim=3";

636 
DùCompÚ’t
 
	gcompÚ’t
;

637 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

638 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

641 cÚ¡ *
	g¡r
 = "dim=10 dct-dim=5„eorder=true dct-keep-dim=4";

642 
DùCompÚ’t
 
	gcompÚ’t
;

643 
	gcompÚ’t
.
In™FromSŒšg
(
¡r
);

644 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

649 
Un™Te¡FixedLš—rCompÚ’t
() {

650 
št32
 
	gm
 = 1 + 
Rªd
(è% 4, 
	gn
 = 1 + Rand() % 4;

652 
	gCuM©rix
<
	gBa£Flßt
> 
m©
(
m
, 
n
);

653 
	gm©
.
S‘Rªdn
();

654 
FixedLš—rCompÚ’t
 
	gcompÚ’t
;

655 
	gcompÚ’t
.
In™
(
m©
);

656 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

661 
Un™Te¡FixedAffšeCompÚ’t
() {

662 
št32
 
	gm
 = 15 + 
Rªd
(è% 4, 
	gn
 = 15 + Rand() % 4;

664 
	gCuM©rix
<
	gBa£Flßt
> 
m©
(
m
, 
n
);

665 
	gm©
.
S‘Rªdn
();

666 
FixedAffšeCompÚ’t
 
	gcompÚ’t
;

667 
	gcompÚ’t
.
In™
(
m©
);

668 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

672 
Un™Te¡FixedSÿËCompÚ’t
() {

673 
št32
 
	gm
 = 1 + 
Rªd
() % 20;

675 
	gCuVeùÜ
<
	gBa£Flßt
> 
vec
(
m
);

676 
	gvec
.
S‘Rªdn
();

677 
FixedSÿËCompÚ’t
 
	gcompÚ’t
;

678 
	gcompÚ’t
.
In™
(
vec
);

679 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

683 
Un™Te¡FixedBŸsCompÚ’t
() {

684 
št32
 
	gm
 = 1 + 
Rªd
() % 20;

686 
	gCuVeùÜ
<
	gBa£Flßt
> 
vec
(
m
);

687 
	gvec
.
S‘Rªdn
();

688 
FixedBŸsCompÚ’t
 
	gcompÚ’t
;

689 
	gcompÚ’t
.
In™
(
vec
);

690 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(
compÚ’t
);

696 
Un™Te¡P¬sšg
() {

697 
št32
 
	gi
;

698 
Ba£Flßt
 
	gf
;

699 
boŞ
 
	gb
;

700 
	g¡d
::
veùÜ
<
št32
> 
v
;

701 
	g¡d
::
¡ršg
 
s
 = "x=y";

702 
KALDI_ASSERT
(
P¬£FromSŒšg
("foo", &
s
, &
i
è=ğ
çl£


703 && 
s
 == "x=y");

704 
KALDI_ASSERT
(
P¬£FromSŒšg
("foo", &
s
, &
f
è=ğ
çl£


705 && 
s
 == "x=y");

706 
KALDI_ASSERT
(
P¬£FromSŒšg
("foo", &
s
, &
v
è=ğ
çl£


707 && 
s
 == "x=y");

708 
KALDI_ASSERT
(
P¬£FromSŒšg
("foo", &
s
, &
b
è=ğ
çl£


709 && 
s
 == "x=y");

711 
	g¡d
::
¡ršg
 
s
 = "x=1";

712 
KALDI_ASSERT
(
P¬£FromSŒšg
("x", &
s
, &
i
è=ğ
Œue


713 && 
i
 =ğ1 && 
s
 == "");

714 
	gs
 = "a=b x=1";

715 
KALDI_ASSERT
(
P¬£FromSŒšg
("x", &
s
, &
i
è=ğ
Œue


716 && 
i
 =ğ1 && 
s
 == "a=b");

719 
	g¡d
::
¡ršg
 
s
 = "foo=false";

720 
KALDI_ASSERT
(
P¬£FromSŒšg
("foo", &
s
, &
b
è=ğ
Œue


721 && 
b
 =ğ
çl£
 && 
s
 == "");

722 
	gs
 = "x=y foo=true‡=b";

723 
KALDI_ASSERT
(
P¬£FromSŒšg
("foo", &
s
, &
b
è=ğ
Œue


724 && 
b
 =ğ
Œue
 && 
s
 == "x=y‡=b");

728 
	g¡d
::
¡ršg
 
s
 = "foobar x=1";

729 
KALDI_ASSERT
(
P¬£FromSŒšg
("x", &
s
, &
f
è=ğ
Œue


730 && 
f
 =ğ1.0 && 
s
 == "foobar");

731 
	gs
 = "a=b x=1 bxy";

732 
KALDI_ASSERT
(
P¬£FromSŒšg
("x", &
s
, &
f
è=ğ
Œue


733 && 
f
 =ğ1.0 && 
s
 == "a=b bxy");

736 
	g¡d
::
¡ršg
 
s
 = "x=1:2:3";

737 
KALDI_ASSERT
(
P¬£FromSŒšg
("x", &
s
, &
v
è=ğ
Œue


738 && 
v
.
size
() == 3 && v[0] == 1 && v[1] == 2 && v[2] == 3

739 && 
s
 == "");

740 
	gs
 = "a=b x=1:2:3 c=d";

741 
KALDI_ASSERT
(
P¬£FromSŒšg
("x", &
s
, &
v
è=ğ
Œue


742 && 
f
 =ğ1.0 && 
s
 == "a=b c=d");

747 
Un™Te¡S¶iûCompÚ’t
() {

748 
št32
 
	gã©_dim
 = 
RªdIÁ
(1, 20),

749 
	gcÚ¡_dim
 = 
RªdIÁ
(0, 10),

750 
	gËá_cÚ‹xt
 = 
RªdIÁ
(-5, 0),

751 
	gright_cÚ‹xt
 = 
RªdIÁ
(0, 5),

752 
	gnum_chunks
 = 
RªdIÁ
(1, 20);

755 
	gKALDI_LOG
 << " F—t_dim :" << 
	gã©_dim
 << " cÚ¡_dim: " << 
	gcÚ¡_dim
 ;

756 
	g¡d
::
veùÜ
<
boŞ
> 
cÚtiguous
(2);

757 
	gcÚtiguous
[0] = 
Œue
;

758 
	gcÚtiguous
[1] = 
çl£
;

759 
št32
 
	gi
 = 0; i < 
	gcÚtiguous
.
size
(); i++) {

760 
	g¡d
::
veùÜ
<
št32
> 
¥liû_šdexes
;

761 ià(
	gcÚtiguous
[
i
]) {

764 
	gKALDI_LOG
 << "Testing contiguous splice component";

765 
	g¥liû_šdexes
.
»£rve
(
right_cÚ‹xt
 - 
Ëá_cÚ‹xt
 + 1);

766 
št32
 
	gi
 = 
Ëá_cÚ‹xt
; i <ğ
right_cÚ‹xt
; i++)

767 
	g¥liû_šdexes
.
push_back
(
i
);

770 
	gKALDI_LOG
 << "Testing‚on-contiguous splice component";

771 
št32
 
	gnum_Ëá_¥liû_šdexes
 = 
RªdIÁ
(0, -
Ëá_cÚ‹xt
) + 1;

772 
št32
 
	gnum_right_¥liû_šdexes
 = 
RªdIÁ
(0, 
right_cÚ‹xt
);

773 
	g¥liû_šdexes
.
»£rve
(
num_Ëá_¥liû_šdexes
 + 
num_right_¥liû_šdexes
);

774 
	g¥liû_šdexes
.
size
(è< 
	gnum_Ëá_¥liû_šdexes
) {

775 
št32
 
	gÃw_šdex
 = 
RªdIÁ
(
Ëá_cÚ‹xt
, 0);

777 ià(
	g¡d
::
fšd
(
¥liû_šdexes
.
begš
(), s¶iû_šdexes.
’d
(), 
Ãw_šdex
)

778 =ğ
¥liû_šdexes
.
’d
()) {

779 
¥liû_šdexes
.
push_back
(
Ãw_šdex
);

782 
	g¥liû_šdexes
.
size
(è< 
	gnum_Ëá_¥liû_šdexes
 + 
	gnum_right_¥liû_šdexes
) {

783 
št32
 
	gÃw_šdex
 = 
RªdIÁ
(0, 
right_cÚ‹xt
);

785 ià(
	g¡d
::
fšd
(
¥liû_šdexes
.
begš
(), s¶iû_šdexes.
’d
(), 
Ãw_šdex
)

786 =ğ
¥liû_šdexes
.
’d
()) {

787 
¥liû_šdexes
.
push_back
(
Ãw_šdex
);

790 
sÜt
(
¥liû_šdexes
.
begš
(), s¶iû_šdexes.
’d
());

791 ià(
	g¥liû_šdexes
.
back
() < 0)

792 
	g¥liû_šdexes
.
push_back
(0);

794 
	g¡d
::
veùÜ
<
št32
> 
šput_off£ts
;

795 
št32
 
	gi
 = 0; i < 
	g¥liû_šdexes
.
size
(); i++) {

796 
	gšput_off£ts
.
push_back
(
¥liû_šdexes
[
i
] - s¶iû_šdexes.
äÚt
());

797 
	gKALDI_LOG
 << 
	gi
 << " : " << 
	g¥liû_šdexes
[
i
] << " : " << 
	gšput_off£ts
[i] ;

799 
št32
 
	gouut_off£t
 = -
¥liû_šdexes
.
äÚt
();

800 
S¶iûCompÚ’t
 *
	gcompÚ’t
 = 
Ãw
 SpliceComponent();

801 
	gcompÚ’t
->
In™
(
ã©_dim
 + 
cÚ¡_dim
, 
¥liû_šdexes
, const_dim);

802 
ChunkInfo
 
	gš_šfo
 = ChunkInfo(
ã©_dim
 + 
cÚ¡_dim
, 
num_chunks
,

803 
šput_off£ts
),

804 
	gout_šfo
 = 
ChunkInfo
(
ã©_dim
 * 
¥liû_šdexes
.
size
(è+ 
cÚ¡_dim
,

805 
num_chunks
, 
ouut_off£t
, output_offset);

806 
Un™Te¡G’”icCompÚ’tIÁ”Çl
(*
compÚ’t
, 
š_šfo
, 
out_šfo
);

807 
d–‘e
 
	gcompÚ’t
;

811 
BasicDebugTe¡FÜS¶iûMax
(
boŞ
 
ouut
=
çl£
) {

812 
št32
 
C
=5,

813 
	gcÚ‹xt_Ën
=2,

814 
	gR
ğ3 + 2*
cÚ‹xt_Ën
;

816 
S¶iûMaxCompÚ’t
 *
	gc
 = 
Ãw
 SpliceMaxComponent();

817 
	g¡d
::
veùÜ
<
št32
> 
cÚ‹xt
(2 * 
cÚ‹xt_Ën
 + 1);

818 
št32
 
	gi
 = -1 * 
cÚ‹xt_Ën
; i <= context_len; i++)

819 
	gcÚ‹xt
[
i
 + 
cÚ‹xt_Ën
] = i;

820 
	gc
->
In™
(
C
, 
cÚ‹xt
);

821 
	gCuM©rix
<
	gBa£Flßt
> 
š
(
R
, 
C
), 
š_d”iv
(R, C);

822 
	gCuM©rix
<
	gBa£Flßt
> 
out
(
R
, 
c
->
OuutDim
());

823 
ChunkInfo
 
	gš_šfo
 = ChunkInfo(
C
, 1, 0, 
R
 - 1),

824 
	gout_šfo
 = 
ChunkInfo
(
C
, 1, 
cÚ‹xt_Ën
, 
R
 - 1 - context_len);

826 
	gš
.
S‘Rªdn
();

827 ià(
	gouut
)

828 
	gKALDI_LOG
 << 
	gš
;

830 
	gc
->
Prİag©e
(
š_šfo
, 
out_šfo
, 
š
, &
out
);

832 ià(
	gouut
)

833 
	gKALDI_LOG
 << 
	gout
;

835 
	gout
.
S‘
(5.0);

837 ià(
	gouut
)

838 
	gKALDI_LOG
 << 
	gout
;

840 
	gc
->
Back´İ
(
š_šfo
, 
out_šfo
, 
š
, in, 
out
, 
c
, &
š_d”iv
);

842 ià(
	gouut
)

843 
	gKALDI_LOG
 << 
	gš_d”iv
;

845 
d–‘e
 
	gc
;

852 
	~"m©rix/m©rix-funùiÚs.h
"

855 
	$maš
() {

856 
usšg
 
Çme¥aû
 
k®di
;

857 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

859 
št32
 
loİ
 = 0;

860 #ià
HAVE_CUDA
 == 1

861 
loİ
 = 0;†oop < 2;†oop++) {

864 ià(
loİ
 == 0)

865 
CuDeviû
::
	`In¡ªtŸ‹
().
	`S–eùGpuId
("no");

867 
CuDeviû
::
	`In¡ªtŸ‹
().
	`S–eùGpuId
("optional");

870 
	`BasicDebugTe¡FÜS¶iûMax
(
Œue
);

873 
št32
 
i
 = 0; i < 1; i++) {

874 
Un™Te¡G’”icCompÚ’t
<
SigmoidCompÚ’t
>();

875 
Un™Te¡G’”icCompÚ’t
<
TªhCompÚ’t
>();

876 
Un™Te¡G’”icCompÚ’t
<
Pow”CompÚ’t
>("power=1.5");

877 
Un™Te¡G’”icCompÚ’t
<
Pow”CompÚ’t
>("power=1.0");

878 
Un™Te¡G’”icCompÚ’t
<
P”mu‹CompÚ’t
>();

879 
Un™Te¡G’”icCompÚ’t
<
SoámaxCompÚ’t
>();

880 
Un™Te¡G’”icCompÚ’t
<
LogSoámaxCompÚ’t
>();

881 
Un™Te¡G’”icCompÚ’t
<
Reùif›dLš—rCompÚ’t
>();

882 
Un™Te¡G’”icCompÚ’t
<
SoáHšgeCompÚ’t
>();

883 
	`Un™Te¡S¶iûCompÚ’t
();

884 
	`Un™Te¡MaxoutCompÚ’t
();

885 
	`Un™Te¡PnÜmCompÚ’t
();

886 
	`Un™Te¡MaxpoŞšgCompÚ’t
();

887 
Un™Te¡G’”icCompÚ’t
<
NÜm®izeCompÚ’t
>();

888 
	`Un™Te¡SigmoidCompÚ’t
();

889 
	`Un™Te¡AffšeCompÚ’t
();

890 
	`Un™Te¡SÿËCompÚ’t
();

891 
	`Un™Te¡BlockAffšeCompÚ’t
();

892 
	`Un™Te¡BlockAffšeCompÚ’tP»cÚd™iÚed
();

893 
	`Un™Te¡SumGroupCompÚ’t
();

894 
	`Un™Te¡DùCompÚ’t
();

895 
	`Un™Te¡FixedLš—rCompÚ’t
();

896 
	`Un™Te¡FixedAffšeCompÚ’t
();

897 
	`Un™Te¡FixedSÿËCompÚ’t
();

898 
	`Un™Te¡FixedBŸsCompÚ’t
();

899 
	`Un™Te¡AffšeCompÚ’tP»cÚd™iÚed
();

900 
	`Un™Te¡AffšeCompÚ’tP»cÚd™iÚedOÆše
();

901 
	`Un™Te¡CÚvŞutiÚ®1dCompÚ’t
();

902 
	`Un™Te¡DrİoutCompÚ’t
();

903 
	`Un™Te¡Add™iveNoi£CompÚ’t
();

904 
	`Un™Te¡P¬sšg
();

905 ià(
loİ
 == 0)

906 
KALDI_LOG
 << "Tests without GPU use succeeded.";

908 
KALDI_LOG
 << "Tests with GPU use (if‡vailable) succeeded.";

910 #ià
HAVE_CUDA
 == 1

912 
CuDeviû
::
	`In¡ªtŸ‹
().
	`PrštProfe
();

915 
	}
}

	@nnet-component.cc

24 
	~<™”©Ü
>

25 
	~<s¡»am
>

26 
	~"Â‘2/Â‘-compÚ’t.h
"

27 
	~"Â‘2/Â‘-´ecÚd™iÚ.h
"

28 
	~"Â‘2/Â‘-´ecÚd™iÚ-Úlše.h
"

29 
	~"ut/¡l-uts.h
"

30 
	~"ut/‹xt-uts.h
"

31 
	~"ut/k®di-io.h
"

33 
Çme¥aû
 
	gk®di
 {

34 
Çme¥aû
 
	gÂ‘2
 {

37 
CompÚ’t
* 
	gCompÚ’t
::
R—dNew
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

38 
	g¡d
::
¡ršg
 
tok’
;

39 
R—dTok’
(
is
, 
bš¬y
, &
tok’
);

40 
	gtok’
.
”a£
(0, 1);

41 
	gtok’
.
”a£
(
tok’
.
Ëngth
()-1);

42 
CompÚ’t
 *
	gªs
 = 
NewCompÚ’tOfTy³
(
tok’
);

43 ià(!
	gªs
)

44 
	gKALDI_ERR
 << "UnknowÀcompÚ’ˆty³ " << 
	gtok’
;

45 
	gªs
->
R—d
(
is
, 
bš¬y
);

46  
	gªs
;

51 
CompÚ’t
* 
	gCompÚ’t
::
NewCompÚ’tOfTy³
(cÚ¡ 
¡d
::
¡ršg
 &
compÚ’t_ty³
) {

52 
CompÚ’t
 *
ªs
 = 
NULL
;

53 ià(
	gcompÚ’t_ty³
 == "SigmoidComponent") {

54 
ªs
 = 
Ãw
 
SigmoidCompÚ’t
();

55 } ià(
	gcompÚ’t_ty³
 == "TanhComponent") {

56 
ªs
 = 
Ãw
 
TªhCompÚ’t
();

57 } ià(
	gcompÚ’t_ty³
 == "PowerComponent") {

58 
ªs
 = 
Ãw
 
Pow”CompÚ’t
();

59 } ià(
	gcompÚ’t_ty³
 == "SoftmaxComponent") {

60 
ªs
 = 
Ãw
 
SoámaxCompÚ’t
();

61 } ià(
	gcompÚ’t_ty³
 == "LogSoftmaxComponent") {

62 
ªs
 = 
Ãw
 
LogSoámaxCompÚ’t
();

63 } ià(
	gcompÚ’t_ty³
 == "RectifiedLinearComponent") {

64 
ªs
 = 
Ãw
 
Reùif›dLš—rCompÚ’t
();

65 } ià(
	gcompÚ’t_ty³
 == "NormalizeComponent") {

66 
ªs
 = 
Ãw
 
NÜm®izeCompÚ’t
();

67 } ià(
	gcompÚ’t_ty³
 == "SoftHingeComponent") {

68 
ªs
 = 
Ãw
 
SoáHšgeCompÚ’t
();

69 } ià(
	gcompÚ’t_ty³
 == "PnormComponent") {

70 
ªs
 = 
Ãw
 
PnÜmCompÚ’t
();

71 } ià(
	gcompÚ’t_ty³
 == "MaxoutComponent") {

72 
ªs
 = 
Ãw
 
MaxoutCompÚ’t
();

73 } ià(
	gcompÚ’t_ty³
 == "ScaleComponent") {

74 
ªs
 = 
Ãw
 
SÿËCompÚ’t
();

75 } ià(
	gcompÚ’t_ty³
 == "AffineComponent") {

76 
ªs
 = 
Ãw
 
AffšeCompÚ’t
();

77 } ià(
	gcompÚ’t_ty³
 == "AffineComponentPreconditioned") {

78 
ªs
 = 
Ãw
 
AffšeCompÚ’tP»cÚd™iÚed
();

79 } ià(
	gcompÚ’t_ty³
 == "AffineComponentPreconditionedOnline") {

80 
ªs
 = 
Ãw
 
AffšeCompÚ’tP»cÚd™iÚedOÆše
();

81 } ià(
	gcompÚ’t_ty³
 == "SumGroupComponent") {

82 
ªs
 = 
Ãw
 
SumGroupCompÚ’t
();

83 } ià(
	gcompÚ’t_ty³
 == "BlockAffineComponent") {

84 
ªs
 = 
Ãw
 
BlockAffšeCompÚ’t
();

85 } ià(
	gcompÚ’t_ty³
 == "BlockAffineComponentPreconditioned") {

86 
ªs
 = 
Ãw
 
BlockAffšeCompÚ’tP»cÚd™iÚed
();

87 } ià(
	gcompÚ’t_ty³
 == "PermuteComponent") {

88 
ªs
 = 
Ãw
 
P”mu‹CompÚ’t
();

89 } ià(
	gcompÚ’t_ty³
 == "DctComponent") {

90 
ªs
 = 
Ãw
 
DùCompÚ’t
();

91 } ià(
	gcompÚ’t_ty³
 == "FixedLinearComponent") {

92 
ªs
 = 
Ãw
 
FixedLš—rCompÚ’t
();

93 } ià(
	gcompÚ’t_ty³
 == "FixedAffineComponent") {

94 
ªs
 = 
Ãw
 
FixedAffšeCompÚ’t
();

95 } ià(
	gcompÚ’t_ty³
 == "FixedScaleComponent") {

96 
ªs
 = 
Ãw
 
FixedSÿËCompÚ’t
();

97 } ià(
	gcompÚ’t_ty³
 == "FixedBiasComponent") {

98 
ªs
 = 
Ãw
 
FixedBŸsCompÚ’t
();

99 } ià(
	gcompÚ’t_ty³
 == "SpliceComponent") {

100 
ªs
 = 
Ãw
 
S¶iûCompÚ’t
();

101 } ià(
	gcompÚ’t_ty³
 == "SpliceMaxComponent") {

102 
ªs
 = 
Ãw
 
S¶iûMaxCompÚ’t
();

103 } ià(
	gcompÚ’t_ty³
 == "DropoutComponent") {

104 
ªs
 = 
Ãw
 
DrİoutCompÚ’t
();

105 } ià(
	gcompÚ’t_ty³
 == "AdditiveNoiseComponent") {

106 
ªs
 = 
Ãw
 
Add™iveNoi£CompÚ’t
();

107 } ià(
	gcompÚ’t_ty³
 == "Convolutional1dComponent") {

108 
ªs
 = 
Ãw
 
CÚvŞutiÚ®1dCompÚ’t
();

109 } ià(
	gcompÚ’t_ty³
 == "MaxpoolingComponent") {

110 
ªs
 = 
Ãw
 
MaxpoŞšgCompÚ’t
();

112  
	gªs
;

116 
CompÚ’t
* 
	gCompÚ’t
::
NewFromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
š™Ÿliz”_lše
) {

117 
¡d
::
i¡ršg¡»am
 
i¡r
(
š™Ÿliz”_lše
);

118 
	g¡d
::
¡ršg
 
compÚ’t_ty³
;

119 
	gi¡r
 >> 
	gcompÚ’t_ty³
 >> 
	g¡d
::
ws
;

120 
	g¡d
::
¡ršg
 
»¡_of_lše
;

121 
g‘lše
(
i¡r
, 
»¡_of_lše
);

122 
CompÚ’t
 *
	gªs
 = 
NewCompÚ’tOfTy³
(
compÚ’t_ty³
);

123 ià(
	gªs
 =ğ
NULL
)

124 
KALDI_ERR
 << "Bad initializer†ine (no suchype of Component): "

125 << 
š™Ÿliz”_lše
;

126 
	gªs
->
In™FromSŒšg
(
»¡_of_lše
);

127  
	gªs
;

135 
Ex³ùOÃOrTwoTok’s
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
,

136 cÚ¡ 
¡d
::
¡ršg
 &
tok’1
,

137 cÚ¡ 
¡d
::
¡ršg
 &
tok’2
) {

138 
KALDI_ASSERT
(
tok’1
 !ğ
tok’2
);

139 
	g¡d
::
¡ršg
 
‹mp
;

140 
R—dTok’
(
is
, 
bš¬y
, &
‹mp
);

141 ià(
	g‹mp
 =ğ
tok’1
) {

142 
Ex³ùTok’
(
is
, 
bš¬y
, 
tok’2
);

144 ià(
	g‹mp
 !ğ
tok’2
) {

145 
KALDI_ERR
 << "Ex³ùšgok’ " << 
tok’1
 << " o¸" << 
tok’2


146 << " buˆgÙ " << 
‹mp
;

153 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

154 
št32
 *
·¿m
) {

155 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¥l™_¡ršg
;

156 
S¶™SŒšgToVeùÜ
(*
¡ršg
, " \t", 
Œue
,

157 &
¥l™_¡ršg
);

158 
	g¡d
::
¡ršg
 
Çme_equ®s
 = 
Çme
 + "=";

159 
size_t
 
	gËn
 = 
Çme_equ®s
.
Ëngth
();

161 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡ršg
.
size
(); i++) {

162 ià(
	g¥l™_¡ršg
[
i
].
com·»
(0, 
Ën
, 
Çme_equ®s
) == 0) {

163 ià(!
CÚv”tSŒšgToIÁeg”
(
¥l™_¡ršg
[
i
].
sub¡r
(
Ën
), 
·¿m
))

164 
KALDI_ERR
 << "Bad o±iÚ " << 
¥l™_¡ršg
[
i
];

165 *
	g¡ršg
 = "";

167 
size_t
 
	gj
 = 0; j < 
	g¥l™_¡ršg
.
size
(); j++) {

168 ià(
	gj
 !ğ
i
) {

169 ià(!
¡ršg
->
em±y
()) *string += " ";

170 *
	g¡ršg
 +ğ
¥l™_¡ršg
[
j
];

173  
	gŒue
;

176  
	gçl£
;

179 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

180 
boŞ
 *
·¿m
) {

181 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¥l™_¡ršg
;

182 
S¶™SŒšgToVeùÜ
(*
¡ršg
, " \t", 
Œue
,

183 &
¥l™_¡ršg
);

184 
	g¡d
::
¡ršg
 
Çme_equ®s
 = 
Çme
 + "=";

185 
size_t
 
	gËn
 = 
Çme_equ®s
.
Ëngth
();

187 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡ršg
.
size
(); i++) {

188 ià(
	g¥l™_¡ršg
[
i
].
com·»
(0, 
Ën
, 
Çme_equ®s
) == 0) {

189 
¡d
::
¡ršg
 
b
 = 
¥l™_¡ršg
[
i
].
sub¡r
(
Ën
);

190 ià(
	gb
.
em±y
())

191 
	gKALDI_ERR
 << "Bad o±iÚ " << 
	g¥l™_¡ršg
[
i
];

192 ià(
	gb
[0] =ğ'f' || 
b
[0] =ğ'F'è*
·¿m
 = 
çl£
;

193 ià(
	gb
[0] =ğ't' || 
b
[0] =ğ'T'è*
·¿m
 = 
Œue
;

195 
	gKALDI_ERR
 << "Bad o±iÚ " << 
	g¥l™_¡ršg
[
i
];

196 *
	g¡ršg
 = "";

198 
size_t
 
	gj
 = 0; j < 
	g¥l™_¡ršg
.
size
(); j++) {

199 ià(
	gj
 !ğ
i
) {

200 ià(!
¡ršg
->
em±y
()) *string += " ";

201 *
	g¡ršg
 +ğ
¥l™_¡ršg
[
j
];

204  
	gŒue
;

207  
	gçl£
;

210 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

211 
Ba£Flßt
 *
·¿m
) {

212 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¥l™_¡ršg
;

213 
S¶™SŒšgToVeùÜ
(*
¡ršg
, " \t", 
Œue
,

214 &
¥l™_¡ršg
);

215 
	g¡d
::
¡ršg
 
Çme_equ®s
 = 
Çme
 + "=";

216 
size_t
 
	gËn
 = 
Çme_equ®s
.
Ëngth
();

218 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡ršg
.
size
(); i++) {

219 ià(
	g¥l™_¡ršg
[
i
].
com·»
(0, 
Ën
, 
Çme_equ®s
) == 0) {

220 ià(!
CÚv”tSŒšgToR—l
(
¥l™_¡ršg
[
i
].
sub¡r
(
Ën
), 
·¿m
))

221 
KALDI_ERR
 << "Bad o±iÚ " << 
¥l™_¡ršg
[
i
];

222 *
	g¡ršg
 = "";

224 
size_t
 
	gj
 = 0; j < 
	g¥l™_¡ršg
.
size
(); j++) {

225 ià(
	gj
 !ğ
i
) {

226 ià(!
¡ršg
->
em±y
()) *string += " ";

227 *
	g¡ršg
 +ğ
¥l™_¡ršg
[
j
];

230  
	gŒue
;

233  
	gçl£
;

236 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

237 
¡d
::
¡ršg
 *
·¿m
) {

238 
¡d
::
veùÜ
<¡d::
¡ršg
> 
¥l™_¡ršg
;

239 
S¶™SŒšgToVeùÜ
(*
¡ršg
, " \t", 
Œue
,

240 &
¥l™_¡ršg
);

241 
	g¡d
::
¡ršg
 
Çme_equ®s
 = 
Çme
 + "=";

242 
size_t
 
	gËn
 = 
Çme_equ®s
.
Ëngth
();

244 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡ršg
.
size
(); i++) {

245 ià(
	g¥l™_¡ršg
[
i
].
com·»
(0, 
Ën
, 
Çme_equ®s
) == 0) {

246 *
·¿m
 = 
¥l™_¡ršg
[
i
].
sub¡r
(
Ën
);

249 *
	g¡ršg
 = "";

250 
size_t
 
	gj
 = 0; j < 
	g¥l™_¡ršg
.
size
(); j++) {

251 ià(
	gj
 !ğ
i
) {

252 ià(!
¡ršg
->
em±y
()) *string += " ";

253 *
	g¡ršg
 +ğ
¥l™_¡ršg
[
j
];

256  
	gŒue
;

259  
	gçl£
;

262 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

263 
¡d
::
veùÜ
<
št32
> *
·¿m
) {

264 
¡d
::
veùÜ
<¡d::
¡ršg
> 
¥l™_¡ršg
;

265 
S¶™SŒšgToVeùÜ
(*
¡ršg
, " \t", 
Œue
,

266 &
¥l™_¡ršg
);

267 
	g¡d
::
¡ršg
 
Çme_equ®s
 = 
Çme
 + "=";

268 
size_t
 
	gËn
 = 
Çme_equ®s
.
Ëngth
();

270 
size_t
 
	gi
 = 0; i < 
	g¥l™_¡ršg
.
size
(); i++) {

271 ià(
	g¥l™_¡ršg
[
i
].
com·»
(0, 
Ën
, 
Çme_equ®s
) == 0) {

272 ià(!
S¶™SŒšgToIÁeg”s
(
¥l™_¡ršg
[
i
].
sub¡r
(
Ën
), ":",

273 
çl£
, 
·¿m
))

274 
KALDI_ERR
 << "Bad o±iÚ " << 
¥l™_¡ršg
[
i
];

275 *
	g¡ršg
 = "";

277 
size_t
 
	gj
 = 0; j < 
	g¥l™_¡ršg
.
size
(); j++) {

278 ià(
	gj
 !ğ
i
) {

279 ià(!
¡ršg
->
em±y
()) *string += " ";

280 *
	g¡ršg
 +ğ
¥l™_¡ršg
[
j
];

283  
	gŒue
;

286  
	gçl£
;

290 
CompÚ’t
 *
	gP”mu‹CompÚ’t
::
Cİy
() const {

291 
P”mu‹CompÚ’t
 *
ªs
 = 
Ãw
 PermuteComponent();

292 
	gªs
->
	g»Üd”_
 = 
»Üd”_
;

293  
	gªs
;

295 
	gP”mu‹CompÚ’t
::
In™
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
»Üd”
) {

296 
»Üd”_
 = 
»Üd”
;

297 
KALDI_ASSERT
(!
»Üd”
.
em±y
());

298 
	g¡d
::
veùÜ
<
št32
> 
šdexes
(
»Üd”
);

299 
	g¡d
::
sÜt
(
šdexes
.
begš
(), indexes.
’d
());

300 
št32
 
	gi
 = 0; i < 
	g¡©ic_ÿ¡
<
	gšt32
>(
	gšdexes
.
size
()); i++)

301 
KALDI_ASSERT
(
i
 =ğ
šdexes
[i] && "Not‡…ermutation");

305 
	g¡d
::
¡ršg
 
CompÚ’t
::
Info
() const {

306 
¡d
::
¡ršg¡»am
 
¡»am
;

307 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim=" << 
IÅutDim
()

308 << ", ouut-dim=" << 
OuutDim
();

309  
	g¡»am
.
¡r
();

312 
	g¡d
::
¡ršg
 
Upd©abËCompÚ’t
::
Info
() const {

313 
¡d
::
¡ršg¡»am
 
¡»am
;

314 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim=" << 
IÅutDim
()

315 << ", ouut-dim=" << 
OuutDim
() << ",†earning-rate="

316 << 
L—ºšgR©e
();

317  
	g¡»am
.
¡r
();

321 
	gNÚlš—rCompÚ’t
::
S‘Dim
(
št32
 
dim
) {

322 
KALDI_ASSERT
(
dim
 > 0);

323 
	gdim_
 = 
dim
;

324 
	gv®ue_sum_
.
Resize
(
dim
);

325 
	gd”iv_sum_
.
Resize
(
dim
);

326 
	gcouÁ_
 = 0.0;

329 
	gNÚlš—rCompÚ’t
::
Upd©eSts
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

330 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> *
d”iv
) {

331 
KALDI_ASSERT
(
out_v®ue
.
NumCŞs
(è=ğ
IÅutDim
());

333 ià(
	gv®ue_sum_
.
Dim
(è!ğ
IÅutDim
() ||

334 (
d”iv
 !ğ
NULL
 && 
d”iv_sum_
.
Dim
(è!ğ
IÅutDim
())) {

335 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
lock
(
mu‹x_
);

336 ià(
	gv®ue_sum_
.
Dim
(è!ğ
IÅutDim
()) {

337 
v®ue_sum_
.
Resize
(
IÅutDim
());

338 
	gcouÁ_
 = 0.0;

340 ià(
	gd”iv
 !ğ
NULL
 && 
d”iv_sum_
.
Dim
(è!ğ
IÅutDim
()) {

341 
d”iv_sum_
.
Resize
(
IÅutDim
());

342 
	gcouÁ_
 = 0.0;

343 
	gv®ue_sum_
.
S‘Z”o
();

346 
	gcouÁ_
 +ğ
out_v®ue
.
NumRows
();

347 
	gCuVeùÜ
<
	gBa£Flßt
> 
‹mp
(
IÅutDim
());

348 
	g‹mp
.
AddRowSumM©
(1.0, 
out_v®ue
, 0.0);

349 
	gv®ue_sum_
.
AddVec
(1.0, 
‹mp
);

350 ià(
	gd”iv
 !ğ
NULL
) {

351 
‹mp
.
AddRowSumM©
(1.0, *
d”iv
, 0.0);

352 
	gd”iv_sum_
.
AddVec
(1.0, 
‹mp
);

356 
	gNÚlš—rCompÚ’t
::
SÿË
(
Ba£Flßt
 
sÿË
) {

357 
v®ue_sum_
.
SÿË
(
sÿË
);

358 
	gd”iv_sum_
.
SÿË
(
sÿË
);

359 
	gcouÁ_
 *ğ
sÿË
;

362 
	gNÚlš—rCompÚ’t
::
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
NÚlš—rCompÚ’t
 &
Ùh”
) {

363 ià(
	gv®ue_sum_
.
Dim
(è=ğ0 && 
Ùh”
.
v®ue_sum_
.Dim() != 0)

364 
v®ue_sum_
.
Resize
(
Ùh”
.v®ue_sum_.
Dim
());

365 ià(
	gd”iv_sum_
.
Dim
(è=ğ0 && 
Ùh”
.
d”iv_sum_
.Dim() != 0)

366 
d”iv_sum_
.
Resize
(
Ùh”
.d”iv_sum_.
Dim
());

367 ià(
	gÙh”
.
	gv®ue_sum_
.
Dim
() != 0)

368 
v®ue_sum_
.
AddVec
(
®pha
, 
Ùh”
.value_sum_);

369 ià(
	gÙh”
.
	gd”iv_sum_
.
Dim
() != 0)

370 
d”iv_sum_
.
AddVec
(
®pha
, 
Ùh”
.deriv_sum_);

371 
	gcouÁ_
 +ğ
®pha
 * 
Ùh”
.
couÁ_
;

374 
	gNÚlš—rCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

375 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

376 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

377 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

378 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, 
o¡r_beg
.
¡r
(), "<Dim>");

379 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

380 
Ex³ùTok’
(
is
, 
bš¬y
, "<ValueSum>");

381 
	gv®ue_sum_
.
R—d
(
is
, 
bš¬y
);

382 
Ex³ùTok’
(
is
, 
bš¬y
, "<DerivSum>");

383 
	gd”iv_sum_
.
R—d
(
is
, 
bš¬y
);

384 
Ex³ùTok’
(
is
, 
bš¬y
, "<Count>");

385 
R—dBasicTy³
(
is
, 
bš¬y
, &
couÁ_
);

386 
Ex³ùTok’
(
is
, 
bš¬y
, 
o¡r_’d
.
¡r
());

389 
	gNÚlš—rCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

390 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

391 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

392 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

393 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_beg
.
¡r
());

394 
Wr™eTok’
(
os
, 
bš¬y
, "<Dim>");

395 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

396 
Wr™eTok’
(
os
, 
bš¬y
, "<ValueSum>");

397 
	gv®ue_sum_
.
Wr™e
(
os
, 
bš¬y
);

398 
Wr™eTok’
(
os
, 
bš¬y
, "<DerivSum>");

399 
	gd”iv_sum_
.
Wr™e
(
os
, 
bš¬y
);

400 
Wr™eTok’
(
os
, 
bš¬y
, "<Count>");

401 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
couÁ_
);

402 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_’d
.
¡r
());

405 
	gNÚlš—rCompÚ’t
::
NÚlš—rCompÚ’t
(cÚ¡ NÚlš—rCompÚ’ˆ&
Ùh”
):

406 
dim_
(
Ùh”
.dim_), 
v®ue_sum_
(Ùh”.v®ue_sum_), 
d”iv_sum_
(other.deriv_sum_),

407 
couÁ_
(
Ùh”
.count_) { }

409 
	gNÚlš—rCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

410 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

411 
št32
 
	gdim
;

412 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
);

413 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gdim
 <= 0)

414 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

415 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

416 
In™
(
dim
);

419 
	gMaxoutCompÚ’t
::
In™
(
št32
 
šput_dim
, iÁ32 
ouut_dim
) {

420 
	gšput_dim_
 = 
šput_dim
;

421 
	gouut_dim_
 = 
ouut_dim
;

422 ià(
	gšput_dim_
 == 0)

423 
šput_dim_
 = 10 * 
ouut_dim_
;

424 
KALDI_ASSERT
(
šput_dim_
 > 0 && 
ouut_dim_
 >= 0);

425 
KALDI_ASSERT
(
šput_dim_
 % 
ouut_dim_
 == 0);

428 
	gMaxoutCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

429 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

430 
št32
 
	gšput_dim
 = 0;

431 
št32
 
	gouut_dim
 = 0;

432 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
) &&

433 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

434 
	gKALDI_LOG
 << 
	gouut_dim
 << " " << 
	gšput_dim
 << " " << 
	gok
;

435 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gouut_dim
 <= 0)

436 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

437 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

438 
In™
(
šput_dim
, 
ouut_dim
);

442 
	gMaxoutCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

443 cÚ¡ 
ChunkInfo
 &
out_šfo
,

444 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

445 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

446 
	gš_šfo
.
CheckSize
(
š
);

447 
	gout_šfo
.
CheckSize
(*
out
);

448 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

449 
	gout
->
GroupMax
(
š
);

452 
	gMaxoutCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

453 cÚ¡ 
ChunkInfo
 &,

454 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

455 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

456 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

457 
CompÚ’t
 *
to_upd©e
,

458 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

459 
	gš_d”iv
->
Resize
(
š_v®ue
.
NumRows
(), in_v®ue.
NumCŞs
(), 
kS‘Z”o
);

460 
	gš_d”iv
->
GroupMaxD”iv
(
š_v®ue
, 
out_v®ue
);

461 
	gš_d”iv
->
MulRowsGroupM©
(
out_d”iv
);

464 
	gMaxoutCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

465 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<MaxoutComponent>", "<InputDim>");

466 
R—dBasicTy³
(
is
, 
bš¬y
, &
šput_dim_
);

467 
Ex³ùTok’
(
is
, 
bš¬y
, "<OutputDim>");

468 
R—dBasicTy³
(
is
, 
bš¬y
, &
ouut_dim_
);

469 
Ex³ùTok’
(
is
, 
bš¬y
, "</MaxoutComponent>");

472 
	gMaxoutCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

473 
Wr™eTok’
(
os
, 
bš¬y
, "<MaxoutComponent>");

474 
Wr™eTok’
(
os
, 
bš¬y
, "<InputDim>");

475 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
šput_dim_
);

476 
Wr™eTok’
(
os
, 
bš¬y
, "<OutputDim>");

477 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
ouut_dim_
);

478 
Wr™eTok’
(
os
, 
bš¬y
, "</MaxoutComponent>");

481 
	g¡d
::
¡ršg
 
MaxoutCompÚ’t
::
Info
() const {

482 
¡d
::
¡ršg¡»am
 
¡»am
;

483 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim = " << 
	gšput_dim_


484 << ", ouut-dim = " << 
	gouut_dim_
;

485  
	g¡»am
.
¡r
();

488 
	gPnÜmCompÚ’t
::
In™
(
št32
 
šput_dim
, iÁ32 
ouut_dim
, 
Ba£Flßt
 
p
) {

489 
	gšput_dim_
 = 
šput_dim
;

490 
	gouut_dim_
 = 
ouut_dim
;

491 ià(
	gšput_dim_
 == 0)

492 
šput_dim_
 = 10 * 
ouut_dim_
;

493 
	gp_
 = 
p
;

494 
KALDI_ASSERT
(
šput_dim_
 > 0 && 
ouut_dim_
 >ğ0 && 
p_
 >= 0);

495 
KALDI_ASSERT
(
šput_dim_
 % 
ouut_dim_
 == 0);

498 
	gPnÜmCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

499 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

500 
št32
 
	gšput_dim
 = 0;

501 
št32
 
	gouut_dim
 = 0;

502 
Ba£Flßt
 
	gp
 = 2;

503 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
) &&

504 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

505 
P¬£FromSŒšg
("p", &
¬gs
, &
p
);

506 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gouut_dim
 <= 0)

507 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

508 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

509 
In™
(
šput_dim
, 
ouut_dim
, 
p
);

513 
	gPnÜmCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

514 cÚ¡ 
ChunkInfo
 &
out_šfo
,

515 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

516 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

517 
	gš_šfo
.
CheckSize
(
š
);

518 
	gout_šfo
.
CheckSize
(*
out
);

519 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

521 
	gout
->
GroupPnÜm
(
š
, 
p_
);

524 
	gPnÜmCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

525 cÚ¡ 
ChunkInfo
 &,

526 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

527 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

528 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

529 
CompÚ’t
 *
to_upd©e
,

531 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

532 
	gš_d”iv
->
Resize
(
š_v®ue
.
NumRows
(), in_v®ue.
NumCŞs
(), 
kS‘Z”o
);

533 
	gš_d”iv
->
DiffGroupPnÜm
(
š_v®ue
, 
out_v®ue
, 
out_d”iv
, 
p_
);

536 
	gPnÜmCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

537 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<PnormComponent>", "<InputDim>");

538 
R—dBasicTy³
(
is
, 
bš¬y
, &
šput_dim_
);

539 
Ex³ùTok’
(
is
, 
bš¬y
, "<OutputDim>");

540 
R—dBasicTy³
(
is
, 
bš¬y
, &
ouut_dim_
);

541 
Ex³ùTok’
(
is
, 
bš¬y
, "<P>");

542 
R—dBasicTy³
(
is
, 
bš¬y
, &
p_
);

543 
Ex³ùTok’
(
is
, 
bš¬y
, "</PnormComponent>");

546 
	gPnÜmCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

547 
Wr™eTok’
(
os
, 
bš¬y
, "<PnormComponent>");

548 
Wr™eTok’
(
os
, 
bš¬y
, "<InputDim>");

549 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
šput_dim_
);

550 
Wr™eTok’
(
os
, 
bš¬y
, "<OutputDim>");

551 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
ouut_dim_
);

552 
Wr™eTok’
(
os
, 
bš¬y
, "<P>");

553 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
p_
);

554 
Wr™eTok’
(
os
, 
bš¬y
, "</PnormComponent>");

557 
	g¡d
::
¡ršg
 
PnÜmCompÚ’t
::
Info
() const {

558 
¡d
::
¡ršg¡»am
 
¡»am
;

559 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim = " << 
	gšput_dim_


560 << ", ouut-dim = " << 
	gouut_dim_


561 << ",… = " << 
	gp_
;

562  
	g¡»am
.
¡r
();

566 cÚ¡ 
Ba£Flßt
 
	gNÜm®izeCompÚ’t
::
kNÜmFloÜ
 = 
pow
(2.0, -66);

570 
	gNÜm®izeCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

571 cÚ¡ 
ChunkInfo
 &
out_šfo
,

572 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

573 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

574 
	gcu
::
NÜm®izeP”Row
(
š
, 
Ba£Flßt
(1), 
çl£
, 
out
);

599 
	gNÜm®izeCompÚ’t
::
Back´İ
(

600 cÚ¡ 
ChunkInfo
 &,

601 cÚ¡ 
ChunkInfo
 &,

602 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

603 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

604 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
, 
CompÚ’t
 *
to_upd©e
,

606 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

607 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

608 
	gcu
::
DiffNÜm®izeP”Row
(
š_v®ue
, 
out_d”iv
, 
Ba£Flßt
(1), 
çl£
, 
š_d”iv
);

611 
	gSigmoidCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

612 cÚ¡ 
ChunkInfo
 &
out_šfo
,

613 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

614 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

615 
	gš_šfo
.
CheckSize
(
š
);

616 
	gout_šfo
.
CheckSize
(*
out
);

617 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

619 
	gout
->
Sigmoid
(
š
);

622 
	gSigmoidCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

623 cÚ¡ 
ChunkInfo
 &,

624 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

625 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

626 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

627 
CompÚ’t
 *
to_upd©e
,

628 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

635 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

636 
	gš_d”iv
->
S‘
(1.0);

637 
	gš_d”iv
->
AddM©
(-1.0, 
out_v®ue
);

639 
	gš_d”iv
->
MulEËm’ts
(
out_v®ue
);

642 ià(
	gto_upd©e
 !ğ
NULL
)

643 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
to_upd©e
)->
Upd©eSts
(
out_v®ue
,

644 
š_d”iv
);

645 
	gš_d”iv
->
MulEËm’ts
(
out_d”iv
);

650 
	gTªhCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

651 cÚ¡ 
ChunkInfo
 &
out_šfo
,

652 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

653 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

658 
	gš_šfo
.
CheckSize
(
š
);

659 
	gout_šfo
.
CheckSize
(*
out
);

660 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

661 
	gout
->
Tªh
(
š
);

664 
	gTªhCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

665 cÚ¡ 
ChunkInfo
 &,

666 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

667 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

668 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

669 
CompÚ’t
 *
to_upd©e
,

670 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

679 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

680 
	gš_d”iv
->
CİyFromM©
(
out_v®ue
);

681 
	gš_d”iv
->
AµlyPow
(2.0);

682 
	gš_d”iv
->
SÿË
(-1.0);

683 
	gš_d”iv
->
Add
(1.0);

686 ià(
	gto_upd©e
 !ğ
NULL
)

687 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
to_upd©e
)->
Upd©eSts
(
out_v®ue
,

688 
š_d”iv
);

689 
	gš_d”iv
->
MulEËm’ts
(
out_d”iv
);

692 
	gPow”CompÚ’t
::
In™
(
št32
 
dim
, 
Ba£Flßt
 
pow”
) {

693 
	gdim_
 = 
dim
;

694 
	gpow”_
 = 
pow”
;

695 
KALDI_ASSERT
(
dim
 > 0 && 
pow”
 >= 0);

698 
	gPow”CompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

699 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

700 
št32
 
	gdim
;

701 
Ba£Flßt
 
	gpow”
 = 2.0;

702 
P¬£FromSŒšg
("pow”", &
¬gs
, &
pow”
);

705 
boŞ
 
	gok
 = (
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
) ||

706 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
dim
));

707 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gdim
 <= 0)

708 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

709 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

710 
In™
(
dim
, 
pow”
);

713 
	gPow”CompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

714 cÚ¡ 
ChunkInfo
 &
out_šfo
,

715 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

716 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

717 
	gš_šfo
.
CheckSize
(
š
);

718 
	gout_šfo
.
CheckSize
(*
out
);

719 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

722 
	gout
->
CİyFromM©
(
š
);

723 
	gout
->
AµlyPowAbs
(
pow”_
);

726 
	gPow”CompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

727 cÚ¡ 
ChunkInfo
 &,

728 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

729 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

730 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

731 
CompÚ’t
 *
to_upd©e
,

732 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

733 
	gš_d”iv
->
Resize
(
š_v®ue
.
NumRows
(), in_v®ue.
NumCŞs
());

735 
	gš_d”iv
->
CİyFromM©
(
š_v®ue
);

736 
	gš_d”iv
->
AµlyPowAbs
(
pow”_
 - 1.0, 
Œue
);

737 
	gš_d”iv
->
SÿË
(
pow”_
);

738 
	gš_d”iv
->
MulEËm’ts
(
out_d”iv
);

741 
	gPow”CompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

742 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<PowerComponent>", "<InputDim>");

743 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

744 
Ex³ùTok’
(
is
, 
bš¬y
, "<OutputDim>");

745 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

746 
Ex³ùTok’
(
is
, 
bš¬y
, "<Power>");

747 
R—dBasicTy³
(
is
, 
bš¬y
, &
pow”_
);

748 
Ex³ùTok’
(
is
, 
bš¬y
, "</PowerComponent>");

751 
	gPow”CompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

752 
Wr™eTok’
(
os
, 
bš¬y
, "<PowerComponent>");

753 
Wr™eTok’
(
os
, 
bš¬y
, "<InputDim>");

754 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

755 
Wr™eTok’
(
os
, 
bš¬y
, "<OutputDim>");

756 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

757 
Wr™eTok’
(
os
, 
bš¬y
, "<Power>");

758 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
pow”_
);

759 
Wr™eTok’
(
os
, 
bš¬y
, "</PowerComponent>");

762 
	g¡d
::
¡ršg
 
Pow”CompÚ’t
::
Info
() const {

763 
¡d
::
¡ršg¡»am
 
¡»am
;

764 
	g¡»am
 << 
Ty³
(è<< ", dim = " << 
	gdim_


765 << ",…ow” = " << 
	gpow”_
;

766  
	g¡»am
.
¡r
();

769 
	gReùif›dLš—rCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

770 cÚ¡ 
ChunkInfo
 &
out_šfo
,

771 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

772 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

774 
	gout
->
CİyFromM©
(
š
);

775 
	gout
->
AµlyFloÜ
(0.0);

778 
	gReùif›dLš—rCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

779 cÚ¡ 
ChunkInfo
 &,

780 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

781 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

782 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

783 
CompÚ’t
 *
to_upd©e
,

784 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

786 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
(),

787 
kUndefšed
);

788 
	gš_d”iv
->
CİyFromM©
(
out_v®ue
);

789 
	gš_d”iv
->
AµlyH—viside
();

793 ià(
	gto_upd©e
 !ğ
NULL
)

794 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
to_upd©e
)->
Upd©eSts
(
out_v®ue
,

795 
š_d”iv
);

796 
	gš_d”iv
->
MulEËm’ts
(
out_d”iv
);

799 
	gSoáHšgeCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

800 cÚ¡ 
ChunkInfo
 &
out_šfo
,

801 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

802 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

803 
	gš_šfo
.
CheckSize
(
š
);

804 
	gout_šfo
.
CheckSize
(*
out
);

805 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

807 
	gout
->
SoáHšge
(
š
);

810 
	gSoáHšgeCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

811 cÚ¡ 
ChunkInfo
 &,

812 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

813 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

814 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

815 
CompÚ’t
 *
to_upd©e
,

816 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

818 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
(),

819 
kUndefšed
);

828 
	gš_d”iv
->
Sigmoid
(
š_v®ue
);

830 ià(
	gto_upd©e
 !ğ
NULL
)

831 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
to_upd©e
)->
Upd©eSts
(
out_v®ue
,

832 
š_d”iv
);

833 
	gš_d”iv
->
MulEËm’ts
(
out_d”iv
);

837 
	gSÿËCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

838 cÚ¡ 
ChunkInfo
 &
out_šfo
,

839 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

840 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

841 
	gout
->
CİyFromM©
(
š
);

842 
	gout
->
SÿË
(
sÿË_
);

845 
	gSÿËCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

846 cÚ¡ 
ChunkInfo
 &,

847 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

848 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

849 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

850 
CompÚ’t
 *,

851 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

853 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
(),

854 
kUndefšed
);

855 
	gš_d”iv
->
CİyFromM©
(
out_d”iv
);

856 
	gš_d”iv
->
SÿË
(
sÿË_
);

859 
	gSÿËCompÚ’t
::
In™
(
št32
 
dim
, 
Ba£Flßt
 
sÿË
) {

860 
	gdim_
 = 
dim
;

861 
	gsÿË_
 = 
sÿË
;

862 
KALDI_ASSERT
(
dim_
 > 0);

863 
KALDI_ASSERT
(
sÿË_
 != 0.0);

866 
	gSÿËCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

867 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

868 
št32
 
	gdim
;

869 
Ba£Flßt
 
	gsÿË
;

870 ià(!
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
))

871 
	gKALDI_ERR
 << "Dimension‚ot specified for ScaleComponent in config file";

872 ià(!
P¬£FromSŒšg
("sÿË", &
¬gs
, &
sÿË
))

873 
	gKALDI_ERR
 << "Scale‚ot specified for ScaleComponent in config file";

874 
In™
(
dim
, 
sÿË
);

877 
	gSÿËCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

878 
Wr™eTok’
(
os
, 
bš¬y
, "<ScaleComponent>");

879 
Wr™eTok’
(
os
, 
bš¬y
, "<Dim>");

880 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

881 
Wr™eTok’
(
os
, 
bš¬y
, "<Scale>");

882 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
sÿË_
);

883 
Wr™eTok’
(
os
, 
bš¬y
, "</ScaleComponent>");

886 
	gSÿËCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

887 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<ScaleComponent>", "<Dim>");

888 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

889 
Ex³ùTok’
(
is
, 
bš¬y
, "<Scale>");

890 
R—dBasicTy³
(
is
, 
bš¬y
, &
sÿË_
);

891 
Ex³ùTok’
(
is
, 
bš¬y
, "</ScaleComponent>");

894 
	g¡d
::
¡ršg
 
SÿËCompÚ’t
::
Info
() const {

895 
¡d
::
¡ršg¡»am
 
¡»am
;

896 
	g¡»am
 << 
Ty³
(è<< ", dim=" << 
	gdim_
 << ", sÿË=" << 
	gsÿË_
;

897  
	g¡»am
.
¡r
();

900 
	gSoámaxCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

901 cÚ¡ 
ChunkInfo
 &
out_šfo
,

902 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

903 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

904 
	gš_šfo
.
CheckSize
(
š
);

905 
	gout_šfo
.
CheckSize
(*
out
);

906 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

912 
	gout
->
AµlySoáMaxP”Row
(
š
);

916 
	gout
->
AµlyFloÜ
(1.0e-20);

919 
	gSoámaxCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

920 cÚ¡ 
ChunkInfo
 &
out_šfo
,

921 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

922 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

923 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

924 
CompÚ’t
 *
to_upd©e
,

925 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

936 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

937 
	gš_d”iv
->
DiffSoámaxP”Row
(
out_v®ue
, 
out_d”iv
);

942 ià(
	gto_upd©e
 !ğ
NULL
) {

943 
NÚlš—rCompÚ’t
 *
to_upd©e_nÚlš—r
 =

944 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
to_upd©e
);

945 
	gto_upd©e_nÚlš—r
->
Upd©eSts
(
out_v®ue
);

949 
	gLogSoámaxCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

950 cÚ¡ 
ChunkInfo
 &
out_šfo
,

951 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

952 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

953 
	gš_šfo
.
CheckSize
(
š
);

954 
	gout_šfo
.
CheckSize
(*
out
);

955 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

959 
	gout
->
AµlyLogSoáMaxP”Row
(
š
);

962 
	gout
->
AµlyFloÜ
(
Log
(1.0e-20));

965 
	gLogSoámaxCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

966 cÚ¡ 
ChunkInfo
 &
out_šfo
,

967 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

968 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

969 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

970 
CompÚ’t
 *
to_upd©e
,

971 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

983 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

984 
KALDI_ASSERT
(
SameDim
(
out_v®ue
, 
out_d”iv
è&& SameDim(out_v®ue, *
š_d”iv
));

986 
	gš_d”iv
->
DiffLogSoámaxP”Row
(
out_v®ue
, 
out_d”iv
);

989 ià(
	gto_upd©e
 !ğ
NULL
) {

990 
NÚlš—rCompÚ’t
 *
to_upd©e_nÚlš—r
 =

991 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
to_upd©e
);

992 
	gto_upd©e_nÚlš—r
->
Upd©eSts
(
out_v®ue
);

997 
	gAffšeCompÚ’t
::
SÿË
(
Ba£Flßt
 
sÿË
) {

998 
lš—r_·¿ms_
.
SÿË
(
sÿË
);

999 
	gbŸs_·¿ms_
.
SÿË
(
sÿË
);

1003 
	gAffšeCompÚ’t
::
Resize
(
št32
 
šput_dim
, iÁ32 
ouut_dim
) {

1004 
KALDI_ASSERT
(
šput_dim
 > 0 && 
ouut_dim
 > 0);

1005 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1006 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1009 
	gAffšeCompÚ’t
::
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”_š
) {

1010 cÚ¡ 
AffšeCompÚ’t
 *
	gÙh”
 =

1011 
dyÇmic_ÿ¡
<cÚ¡ 
AffšeCompÚ’t
*>(&
Ùh”_š
);

1012 
KALDI_ASSERT
(
Ùh”
 !ğ
NULL
);

1013 
	glš—r_·¿ms_
.
AddM©
(
®pha
, 
Ùh”
->
lš—r_·¿ms_
);

1014 
	gbŸs_·¿ms_
.
AddVec
(
®pha
, 
Ùh”
->
bŸs_·¿ms_
);

1017 
	gAffšeCompÚ’t
::
AffšeCompÚ’t
(cÚ¡ AffšeCompÚ’ˆ&
compÚ’t
):

1018 
Upd©abËCompÚ’t
(
compÚ’t
),

1019 
lš—r_·¿ms_
(
compÚ’t
.linear_params_),

1020 
bŸs_·¿ms_
(
compÚ’t
.bias_params_),

1021 
is_g¿d›Á_
(
compÚ’t
.is_gradient_) { }

1023 
	gAffšeCompÚ’t
::
AffšeCompÚ’t
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
lš—r_·¿ms
,

1024 cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
bŸs_·¿ms
,

1025 
Ba£Flßt
 
Ë¬nšg_¿‹
):

1026 
Upd©abËCompÚ’t
(
Ë¬nšg_¿‹
),

1027 
lš—r_·¿ms_
(
lš—r_·¿ms
),

1028 
bŸs_·¿ms_
(
bŸs_·¿ms
) {

1029 
KALDI_ASSERT
(
lš—r_·¿ms
.
NumRows
(è=ğ
bŸs_·¿ms
.
Dim
()&&

1030 
bŸs_·¿ms
.
Dim
() != 0);

1031 
	gis_g¿d›Á_
 = 
çl£
;

1036 
	gAffšeCompÚ’t
::
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
) {

1037 ià(
Œ—t_as_g¿d›Á
) {

1038 
S‘L—ºšgR©e
(1.0);

1040 
	glš—r_·¿ms_
.
S‘Z”o
();

1041 
	gbŸs_·¿ms_
.
S‘Z”o
();

1042 ià(
	gŒ—t_as_g¿d›Á
)

1043 
	gis_g¿d›Á_
 = 
Œue
;

1046 
	gAffšeCompÚ’t
::
S‘P¬ams
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
bŸs
,

1047 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
lš—r
) {

1048 
	gbŸs_·¿ms_
 = 
bŸs
;

1049 
	glš—r_·¿ms_
 = 
lš—r
;

1050 
KALDI_ASSERT
(
bŸs_·¿ms_
.
Dim
(è=ğ
lš—r_·¿ms_
.
NumRows
());

1053 
	gAffšeCompÚ’t
::
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
) {

1054 
CuM©rix
<
Ba£Flßt
> 
‹mp_lš—r_·¿ms
(
lš—r_·¿ms_
);

1055 
	g‹mp_lš—r_·¿ms
.
S‘Rªdn
();

1056 
	glš—r_·¿ms_
.
AddM©
(
¡ddev
, 
‹mp_lš—r_·¿ms
);

1058 
	gCuVeùÜ
<
	gBa£Flßt
> 
‹mp_bŸs_·¿ms
(
bŸs_·¿ms_
);

1059 
	g‹mp_bŸs_·¿ms
.
S‘Rªdn
();

1060 
	gbŸs_·¿ms_
.
AddVec
(
¡ddev
, 
‹mp_bŸs_·¿ms
);

1063 
	g¡d
::
¡ršg
 
AffšeCompÚ’t
::
Info
() const {

1064 
¡d
::
¡ršg¡»am
 
¡»am
;

1065 
Ba£Flßt
 
	glš—r_·¿ms_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
lš—r_·¿ms_
.
NumRows
())

1066 * 
¡©ic_ÿ¡
<
Ba£Flßt
>(
lš—r_·¿ms_
.
NumCŞs
());

1067 
Ba£Flßt
 
	glš—r_¡ddev
 =

1068 
¡d
::
sq¹
(
T¿ûM©M©
(
lš—r_·¿ms_
,†š—r_·¿ms_, 
kT¿ns
) /

1069 
lš—r_·¿ms_size
),

1070 
	gbŸs_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
bŸs_·¿ms_
, bias_params_) /

1071 
bŸs_·¿ms_
.
Dim
());

1072 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim=" << 
IÅutDim
()

1073 << ", ouut-dim=" << 
OuutDim
()

1074 << ",†š—r-·¿ms-¡ddev=" << 
	glš—r_¡ddev


1075 << ", bŸs-·¿ms-¡ddev=" << 
	gbŸs_¡ddev


1076 << ",†—ºšg-¿‹=" << 
L—ºšgR©e
();

1077  
	g¡»am
.
¡r
();

1080 
CompÚ’t
* 
	gAffšeCompÚ’t
::
Cİy
() const {

1081 
AffšeCompÚ’t
 *
ªs
 = 
Ãw
 AffineComponent();

1082 
	gªs
->
	gË¬nšg_¿‹_
 = 
Ë¬nšg_¿‹_
;

1083 
	gªs
->
	glš—r_·¿ms_
 = 
lš—r_·¿ms_
;

1084 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

1085 
	gªs
->
	gis_g¿d›Á_
 = 
is_g¿d›Á_
;

1086  
	gªs
;

1089 
Ba£Flßt
 
	gAffšeCompÚ’t
::
DÙProduù
(cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”_š
) const {

1090 cÚ¡ 
AffšeCompÚ’t
 *
Ùh”
 =

1091 
dyÇmic_ÿ¡
<cÚ¡ 
AffšeCompÚ’t
*>(&
Ùh”_š
);

1092  
T¿ûM©M©
(
lš—r_·¿ms_
, 
Ùh”
->lš—r_·¿ms_, 
kT¿ns
)

1093 + 
VecVec
(
bŸs_·¿ms_
, 
Ùh”
->bias_params_);

1096 
	gAffšeCompÚ’t
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1097 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1098 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
) {

1099 
	gUpd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

1100 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1101 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1102 
KALDI_ASSERT
(
ouut_dim
 > 0 && 
šput_dim
 > 0 && 
·¿m_¡ddev
 >= 0.0);

1103 
	glš—r_·¿ms_
.
S‘Rªdn
();

1104 
	glš—r_·¿ms_
.
SÿË
(
·¿m_¡ddev
);

1105 
	gbŸs_·¿ms_
.
S‘Rªdn
();

1106 
	gbŸs_·¿ms_
.
SÿË
(
bŸs_¡ddev
);

1109 
	gAffšeCompÚ’t
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1110 
¡d
::
¡ršg
 
m©rix_f’ame
) {

1111 
Upd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

1112 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©
;

1113 
R—dK®diObjeù
(
m©rix_f’ame
, &
m©
);

1114 
KALDI_ASSERT
(
m©
.
NumCŞs
() >= 2);

1115 
št32
 
	gšput_dim
 = 
m©
.
NumCŞs
(è- 1, 
	gouut_dim
 = m©.
NumRows
();

1116 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1117 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1118 
	glš—r_·¿ms_
.
CİyFromM©
(
m©
.
Rªge
(0, 
ouut_dim
, 0, 
šput_dim
));

1119 
	gbŸs_·¿ms_
.
CİyCŞFromM©
(
m©
, 
šput_dim
);

1122 
	gAffšeCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

1123 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

1124 
boŞ
 
	gok
 = 
Œue
;

1125 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 
Ë¬nšg_¿‹_
;

1126 
	g¡d
::
¡ršg
 
m©rix_f’ame
;

1127 
št32
 
	gšput_dim
 = -1, 
	gouut_dim
 = -1;

1128 
P¬£FromSŒšg
("Ë¬nšg-¿‹", &
¬gs
, &
Ë¬nšg_¿‹
);

1129 ià(
P¬£FromSŒšg
("m©rix", &
¬gs
, &
m©rix_f’ame
)) {

1130 
In™
(
Ë¬nšg_¿‹
, 
m©rix_f’ame
);

1131 ià(
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
))

1132 
KALDI_ASSERT
(
šput_dim
 =ğ
IÅutDim
() &&

1134 ià(
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
))

1135 
KALDI_ASSERT
(
ouut_dim
 =ğ
OuutDim
() &&

1138 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

1139 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

1140 
Ba£Flßt
 
	g·¿m_¡ddev
 = 1.0 / 
¡d
::
sq¹
(
šput_dim
),

1141 
	gbŸs_¡ddev
 = 1.0;

1142 
P¬£FromSŒšg
("·¿m-¡ddev", &
¬gs
, &
·¿m_¡ddev
);

1143 
P¬£FromSŒšg
("bŸs-¡ddev", &
¬gs
, &
bŸs_¡ddev
);

1144 
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

1145 
·¿m_¡ddev
, 
bŸs_¡ddev
);

1147 ià(!
	g¬gs
.
em±y
())

1148 
	gKALDI_ERR
 << "Could‚ot…rocessheseƒlements in initializer: "

1149 << 
	g¬gs
;

1150 ià(!
	gok
)

1151 
	gKALDI_ERR
 << "Bad in™Ÿliz” " << 
	gÜig_¬gs
;

1155 
	gAffšeCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1156 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1157 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1158 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

1159 
	gš_šfo
.
CheckSize
(
š
);

1160 
	gout_šfo
.
CheckSize
(*
out
);

1161 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

1164 
	gout
->
CİyRowsFromVec
(
bŸs_·¿ms_
);

1166 
	gout
->
AddM©M©
(1.0, 
š
, 
kNoT¿ns
, 
lš—r_·¿ms_
, 
kT¿ns
, 1.0);

1169 
	gAffšeCompÚ’t
::
Upd©eSim¶e
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1170 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

1171 
	gbŸs_·¿ms_
.
AddRowSumM©
(
Ë¬nšg_¿‹_
, 
out_d”iv
, 1.0);

1172 
	glš—r_·¿ms_
.
AddM©M©
(
Ë¬nšg_¿‹_
, 
out_d”iv
, 
kT¿ns
,

1173 
š_v®ue
, 
kNoT¿ns
, 1.0);

1176 
	gAffšeCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

1177 cÚ¡ 
ChunkInfo
 &,

1178 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1179 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

1180 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1181 
CompÚ’t
 *
to_upd©e_š
,

1182 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

1183 
AffšeCompÚ’t
 *
	gto_upd©e
 = 
dyÇmic_ÿ¡
<AffšeCompÚ’t*>(
to_upd©e_š
);

1184 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), 
IÅutDim
());

1186 
	gš_d”iv
->
AddM©M©
(1.0, 
out_d”iv
, 
kNoT¿ns
, 
lš—r_·¿ms_
, kNoTrans,

1189 ià(
	gto_upd©e
 !ğ
NULL
) {

1192 ià(
to_upd©e
->
is_g¿d›Á_
)

1193 
to_upd©e
->
Upd©eSim¶e
(
š_v®ue
, 
out_d”iv
);

1195 
	gto_upd©e
->
Upd©e
(
š_v®ue
, 
out_d”iv
);

1199 
	gAffšeCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

1200 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

1201 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

1202 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

1205 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, 
o¡r_beg
.
¡r
(), "<LearningRate>");

1206 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ë¬nšg_¿‹_
);

1207 
Ex³ùTok’
(
is
, 
bš¬y
, "<LinearParams>");

1208 
	glš—r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

1209 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

1210 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

1211 
	g¡d
::
¡ršg
 
tok
;

1213 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

1214 ià(
	gtok
 == "<AvgInput>") {

1215 
CuVeùÜ
<
Ba£Flßt
> 
avg_šput
;

1216 
	gavg_šput
.
R—d
(
is
, 
bš¬y
);

1217 
Ba£Flßt
 
	gavg_šput_couÁ
;

1218 
Ex³ùTok’
(
is
, 
bš¬y
, "<AvgInputCount>");

1219 
R—dBasicTy³
(
is
, 
bš¬y
, &
avg_šput_couÁ
);

1220 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

1222 ià(
	gtok
 == "<IsGradient>") {

1223 
R—dBasicTy³
(
is
, 
bš¬y
, &
is_g¿d›Á_
);

1224 
Ex³ùTok’
(
is
, 
bš¬y
, 
o¡r_’d
.
¡r
());

1226 
	gis_g¿d›Á_
 = 
çl£
;

1227 
KALDI_ASSERT
(
tok
 =ğ
o¡r_’d
.
¡r
());

1231 
	gAffšeCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

1232 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

1233 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

1234 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

1235 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_beg
.
¡r
());

1236 
Wr™eTok’
(
os
, 
bš¬y
, "<LearningRate>");

1237 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ë¬nšg_¿‹_
);

1238 
Wr™eTok’
(
os
, 
bš¬y
, "<LinearParams>");

1239 
	glš—r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

1240 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

1241 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

1242 
Wr™eTok’
(
os
, 
bš¬y
, "<IsGradient>");

1243 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
is_g¿d›Á_
);

1244 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_’d
.
¡r
());

1247 
št32
 
	gAffšeCompÚ’t
::
G‘P¬am‘”Dim
() const {

1248  (
IÅutDim
(è+ 1è* 
OuutDim
();

1250 
	gAffšeCompÚ’t
::
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
) const {

1251 
·¿ms
->
Rªge
(0, 
IÅutDim
(è* 
OuutDim
()).
CİyRowsFromM©
(
lš—r_·¿ms_
);

1252 
	g·¿ms
->
Rªge
(
IÅutDim
(è* 
OuutDim
(),

1253 
OuutDim
()).
CİyFromVec
(
bŸs_·¿ms_
);

1255 
	gAffšeCompÚ’t
::
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
) {

1256 
lš—r_·¿ms_
.
CİyRowsFromVec
(
·¿ms
.
Rªge
(0, 
IÅutDim
(è* 
OuutDim
()));

1257 
	gbŸs_·¿ms_
.
CİyFromVec
(
·¿ms
.
Rªge
(
IÅutDim
(è* 
OuutDim
(),

1258 
OuutDim
()));

1261 
	gAffšeCompÚ’t
::
Lim™Rªk
(
št32
 
d
,

1262 
AffšeCompÚ’t
 **
a
, AffšeCompÚ’ˆ**
b
) const {

1263 
KALDI_ASSERT
(
d
 <ğ
IÅutDim
());

1266 
	gM©rix
<
	gBa£Flßt
> 
M
 (
lš—r_·¿ms_
);

1267 
št32
 
	grows
 = 
M
.
NumRows
(), 
	gcŞs
 = M.
NumCŞs
(), 
	grc_mš
 = 
¡d
::
mš
(
rows
, 
cŞs
);

1268 
	gVeùÜ
<
	gBa£Flßt
> 
s
(
rc_mš
);

1269 
	gM©rix
<
	gBa£Flßt
> 
U
(
rows
, 
rc_mš
), 
Vt
Ôc_mš, 
cŞs
);

1271 
	gM
.
De¡ruùiveSvd
(&
s
, &
U
, &
Vt
);

1272 
SÜtSvd
(&
s
, &
U
, &
Vt
);

1273 
Ba£Flßt
 
	gŞd_svd_sum
 = 
s
.
Sum
();

1274 
	gU
.
Resize
(
rows
, 
d
, 
kCİyD©a
);

1275 
	gs
.
Resize
(
d
, 
kCİyD©a
);

1276 
	gVt
.
Resize
(
d
, 
cŞs
, 
kCİyD©a
);

1277 
Ba£Flßt
 
	gÃw_svd_sum
 = 
s
.
Sum
();

1278 
	gKALDI_LOG
 << "Reduced„ank from "

1279 << 
	grc_mš
 << "Ø" << 
	gd
 << ", SVD sum„educed from "

1280 << 
	gŞd_svd_sum
 << "Ø" << 
	gÃw_svd_sum
;

1283 
	gVt
.
MulRowsVec
(
s
);

1285 *
	ga
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
this
->
Cİy
());

1286 *
	gb
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
this
->
Cİy
());

1288 (*
	ga
)->
	gbŸs_·¿ms_
.
Resize
(
d
, 
kS‘Z”o
);

1289 (*
	ga
)->
	glš—r_·¿ms_
 = 
Vt
;

1291 (*
	gb
)->
	gbŸs_·¿ms_
 = 
this
->
bŸs_·¿ms_
;

1292 (*
	gb
)->
	glš—r_·¿ms_
 = 
U
;

1295 
CompÚ’t
 *
	gAffšeCompÚ’t
::
CŞÏp£W™hNext
(

1296 cÚ¡ 
AffšeCompÚ’t
 &
Ãxt_compÚ’t
) const {

1297 
AffšeCompÚ’t
 *
ªs
 = 
dyÇmic_ÿ¡
<AffšeCompÚ’t*>(
this
->
Cİy
());

1298 
KALDI_ASSERT
(
ªs
 !ğ
NULL
);

1303 
	gªs
->
	glš—r_·¿ms_
.
Resize
(
Ãxt_compÚ’t
.
OuutDim
(), 
IÅutDim
());

1304 
	gªs
->
	gbŸs_·¿ms_
 = 
Ãxt_compÚ’t
.
bŸs_·¿ms_
;

1306 
	gªs
->
	glš—r_·¿ms_
.
AddM©M©
(1.0, 
Ãxt_compÚ’t
.
lš—r_·¿ms_
, 
kNoT¿ns
,

1307 
this
->
lš—r_·¿ms_
, 
kNoT¿ns
, 0.0);

1308 
	gªs
->
	gbŸs_·¿ms_
.
AddM©Vec
(1.0, 
Ãxt_compÚ’t
.
lš—r_·¿ms_
, 
kNoT¿ns
,

1309 
this
->
bŸs_·¿ms_
, 1.0);

1310  
	gªs
;

1313 
CompÚ’t
 *
	gAffšeCompÚ’t
::
CŞÏp£W™hNext
(

1314 cÚ¡ 
FixedAffšeCompÚ’t
 &
Ãxt_compÚ’t
) const {

1316 
FixedAffšeCompÚ’t
 *
ªs
 =

1317 
dyÇmic_ÿ¡
<
FixedAffšeCompÚ’t
*>(
Ãxt_compÚ’t
.
Cİy
());

1318 
KALDI_ASSERT
(
ªs
 !ğ
NULL
);

1319 
	gªs
->
	glš—r_·¿ms_
.
Resize
(
Ãxt_compÚ’t
.
OuutDim
(), 
IÅutDim
());

1320 
	gªs
->
	gbŸs_·¿ms_
 = 
Ãxt_compÚ’t
.
bŸs_·¿ms_
;

1322 
	gªs
->
	glš—r_·¿ms_
.
AddM©M©
(1.0, 
Ãxt_compÚ’t
.
lš—r_·¿ms_
, 
kNoT¿ns
,

1323 
this
->
lš—r_·¿ms_
, 
kNoT¿ns
, 0.0);

1324 
	gªs
->
	gbŸs_·¿ms_
.
AddM©Vec
(1.0, 
Ãxt_compÚ’t
.
lš—r_·¿ms_
, 
kNoT¿ns
,

1325 
this
->
bŸs_·¿ms_
, 1.0);

1326  
	gªs
;

1329 
CompÚ’t
 *
	gAffšeCompÚ’t
::
CŞÏp£W™hNext
(

1330 cÚ¡ 
FixedSÿËCompÚ’t
 &
Ãxt_compÚ’t
) const {

1331 
KALDI_ASSERT
(
this
->
OuutDim
(è=ğ
Ãxt_compÚ’t
.
IÅutDim
());

1332 
AffšeCompÚ’t
 *
	gªs
 =

1333 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
this
->
Cİy
());

1334 
KALDI_ASSERT
(
ªs
 !ğ
NULL
);

1335 
	gªs
->
	glš—r_·¿ms_
.
MulRowsVec
(
Ãxt_compÚ’t
.
sÿËs_
);

1336 
	gªs
->
	gbŸs_·¿ms_
.
MulEËm’ts
(
Ãxt_compÚ’t
.
sÿËs_
);

1338  
	gªs
;

1343 
CompÚ’t
 *
	gAffšeCompÚ’t
::
CŞÏp£W™hP»vious
(

1344 cÚ¡ 
FixedAffšeCompÚ’t
 &
´ev_compÚ’t
) const {

1346 
FixedAffšeCompÚ’t
 *
ªs
 =

1347 
dyÇmic_ÿ¡
<
FixedAffšeCompÚ’t
*>(
´ev_compÚ’t
.
Cİy
());

1348 
KALDI_ASSERT
(
ªs
 !ğ
NULL
);

1350 
	gªs
->
	glš—r_·¿ms_
.
Resize
(
this
->
OuutDim
(), 
´ev_compÚ’t
.
IÅutDim
());

1351 
	gªs
->
	gbŸs_·¿ms_
 = 
this
->
bŸs_·¿ms_
;

1353 
	gªs
->
	glš—r_·¿ms_
.
AddM©M©
(1.0, 
this
->
lš—r_·¿ms_
, 
kNoT¿ns
,

1354 
´ev_compÚ’t
.
lš—r_·¿ms_
, 
kNoT¿ns
, 0.0);

1355 
	gªs
->
	gbŸs_·¿ms_
.
AddM©Vec
(1.0, 
this
->
lš—r_·¿ms_
, 
kNoT¿ns
,

1356 
´ev_compÚ’t
.
bŸs_·¿ms_
, 1.0);

1357  
	gªs
;

1360 
	gAffšeCompÚ’tP»cÚd™iÚed
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

1361 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

1362 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

1363 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

1366 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, 
o¡r_beg
.
¡r
(), "<LearningRate>");

1367 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ë¬nšg_¿‹_
);

1368 
Ex³ùTok’
(
is
, 
bš¬y
, "<LinearParams>");

1369 
	glš—r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

1370 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

1371 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

1372 
Ex³ùTok’
(
is
, 
bš¬y
, "<Alpha>");

1373 
R—dBasicTy³
(
is
, 
bš¬y
, &
®pha_
);

1379 
	g¡d
::
¡ršg
 
tok
;

1380 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

1381 ià(
	gtok
 == "<MaxChange>") {

1382 
R—dBasicTy³
(
is
, 
bš¬y
, &
max_chªge_
);

1383 
Ex³ùTok’
(
is
, 
bš¬y
, 
o¡r_’d
.
¡r
());

1385 
	gmax_chªge_
 = 0.0;

1386 
KALDI_ASSERT
(
tok
 =ğ
o¡r_’d
.
¡r
());

1390 
	gAffšeCompÚ’tP»cÚd™iÚed
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

1391 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

1392 
	g¡d
::
¡ršg
 
m©rix_f’ame
;

1393 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 
Ë¬nšg_¿‹_
;

1394 
Ba£Flßt
 
	g®pha
 = 0.1, 
	gmax_chªge
 = 0.0;

1395 
št32
 
	gšput_dim
 = -1, 
	gouut_dim
 = -1;

1396 
P¬£FromSŒšg
("Ë¬nšg-¿‹", &
¬gs
, &
Ë¬nšg_¿‹
);

1397 
P¬£FromSŒšg
("®pha", &
¬gs
, &
®pha
);

1398 
P¬£FromSŒšg
("max-chªge", &
¬gs
, &
max_chªge
);

1400 ià(
P¬£FromSŒšg
("m©rix", &
¬gs
, &
m©rix_f’ame
)) {

1401 
In™
(
Ë¬nšg_¿‹
, 
®pha
, 
max_chªge
, 
m©rix_f’ame
);

1402 ià(
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
))

1403 
KALDI_ASSERT
(
šput_dim
 =ğ
IÅutDim
() &&

1405 ià(
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
))

1406 
KALDI_ASSERT
(
ouut_dim
 =ğ
OuutDim
() &&

1409 
boŞ
 
	gok
 = 
Œue
;

1410 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

1411 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

1412 
Ba£Flßt
 
	g·¿m_¡ddev
 = 1.0 / 
¡d
::
sq¹
(
šput_dim
),

1413 
	gbŸs_¡ddev
 = 1.0;

1414 
P¬£FromSŒšg
("·¿m-¡ddev", &
¬gs
, &
·¿m_¡ddev
);

1415 
P¬£FromSŒšg
("bŸs-¡ddev", &
¬gs
, &
bŸs_¡ddev
);

1416 ià(!
	gok
)

1417 
	gKALDI_ERR
 << "Bad in™Ÿliz” " << 
	gÜig_¬gs
;

1418 
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
, 
·¿m_¡ddev
,

1419 
bŸs_¡ddev
, 
®pha
, 
max_chªge
);

1421 ià(!
	g¬gs
.
em±y
())

1422 
	gKALDI_ERR
 << "Could‚ot…rocessheseƒlements in initializer: "

1423 << 
	g¬gs
;

1426 
	gAffšeCompÚ’tP»cÚd™iÚed
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1427 
Ba£Flßt
 
®pha
, Ba£Flßˆ
max_chªge
,

1428 
¡d
::
¡ršg
 
m©rix_f’ame
) {

1429 
Upd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

1430 
	g®pha_
 = 
®pha
;

1431 
	gmax_chªge_
 = 
max_chªge
;

1432 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©
;

1433 
R—dK®diObjeù
(
m©rix_f’ame
, &
m©
);

1434 
KALDI_ASSERT
(
m©
.
NumCŞs
() >= 2);

1435 
št32
 
	gšput_dim
 = 
m©
.
NumCŞs
(è- 1, 
	gouut_dim
 = m©.
NumRows
();

1436 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1437 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1438 
	glš—r_·¿ms_
.
CİyFromM©
(
m©
.
Rªge
(0, 
ouut_dim
, 0, 
šput_dim
));

1439 
	gbŸs_·¿ms_
.
CİyCŞFromM©
(
m©
, 
šput_dim
);

1442 
	gAffšeCompÚ’tP»cÚd™iÚed
::
In™
(

1443 
Ba£Flßt
 
Ë¬nšg_¿‹
,

1444 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1445 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
,

1446 
Ba£Flßt
 
®pha
, Ba£Flßˆ
max_chªge
) {

1447 
	gUpd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

1448 
KALDI_ASSERT
(
šput_dim
 > 0 && 
ouut_dim
 > 0);

1449 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1450 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1451 
KALDI_ASSERT
(
ouut_dim
 > 0 && 
šput_dim
 > 0 && 
·¿m_¡ddev
 >= 0.0);

1452 
	glš—r_·¿ms_
.
S‘Rªdn
();

1453 
	glš—r_·¿ms_
.
SÿË
(
·¿m_¡ddev
);

1454 
	gbŸs_·¿ms_
.
S‘Rªdn
();

1455 
	gbŸs_·¿ms_
.
SÿË
(
bŸs_¡ddev
);

1456 
	g®pha_
 = 
®pha
;

1457 
KALDI_ASSERT
(
®pha_
 > 0.0);

1458 
	gmax_chªge_
 = 
max_chªge
;

1463 
	gAffšeCompÚ’tP»cÚd™iÚed
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

1464 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

1465 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

1466 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

1467 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_beg
.
¡r
());

1468 
Wr™eTok’
(
os
, 
bš¬y
, "<LearningRate>");

1469 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ë¬nšg_¿‹_
);

1470 
Wr™eTok’
(
os
, 
bš¬y
, "<LinearParams>");

1471 
	glš—r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

1472 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

1473 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

1474 
Wr™eTok’
(
os
, 
bš¬y
, "<Alpha>");

1475 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
®pha_
);

1476 
Wr™eTok’
(
os
, 
bš¬y
, "<MaxChange>");

1477 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
max_chªge_
);

1478 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_’d
.
¡r
());

1481 
	g¡d
::
¡ršg
 
AffšeCompÚ’tP»cÚd™iÚed
::
Info
() const {

1482 
¡d
::
¡ršg¡»am
 
¡»am
;

1483 
Ba£Flßt
 
	glš—r_·¿ms_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
lš—r_·¿ms_
.
NumRows
())

1484 * 
¡©ic_ÿ¡
<
Ba£Flßt
>(
lš—r_·¿ms_
.
NumCŞs
());

1485 
Ba£Flßt
 
	glš—r_¡ddev
 =

1486 
¡d
::
sq¹
(
T¿ûM©M©
(
lš—r_·¿ms_
,†š—r_·¿ms_, 
kT¿ns
) /

1487 
lš—r_·¿ms_size
),

1488 
	gbŸs_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
bŸs_·¿ms_
, bias_params_) /

1489 
bŸs_·¿ms_
.
Dim
());

1490 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim=" << 
IÅutDim
()

1491 << ", ouut-dim=" << 
OuutDim
()

1492 << ",†š—r-·¿ms-¡ddev=" << 
	glš—r_¡ddev


1493 << ", bŸs-·¿ms-¡ddev=" << 
	gbŸs_¡ddev


1494 << ",†—ºšg-¿‹=" << 
L—ºšgR©e
()

1495 << ",‡Íha=" << 
	g®pha_


1496 << ", max-chªge=" << 
	gmax_chªge_
;

1497  
	g¡»am
.
¡r
();

1500 
CompÚ’t
* 
	gAffšeCompÚ’tP»cÚd™iÚed
::
Cİy
() const {

1501 
AffšeCompÚ’tP»cÚd™iÚed
 *
ªs
 = 
Ãw
 AffineComponentPreconditioned();

1502 
	gªs
->
	gË¬nšg_¿‹_
 = 
Ë¬nšg_¿‹_
;

1503 
	gªs
->
	glš—r_·¿ms_
 = 
lš—r_·¿ms_
;

1504 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

1505 
	gªs
->
	g®pha_
 = 
®pha_
;

1506 
	gªs
->
	gmax_chªge_
 = 
max_chªge_
;

1507 
	gªs
->
	gis_g¿d›Á_
 = 
is_g¿d›Á_
;

1508  
	gªs
;

1512 
Ba£Flßt
 
	gAffšeCompÚ’tP»cÚd™iÚed
::
G‘SÿlšgFaùÜ
(

1513 cÚ¡ 
CuM©rix
<
Ba£Flßt
> &
š_v®ue_´ecÚ
,

1514 cÚ¡ 
CuM©rix
<
Ba£Flßt
> &
out_d”iv_´ecÚ
) {

1515 
	gsÿlšg_çùÜ_´š‹d
 = 0;

1517 
KALDI_ASSERT
(
š_v®ue_´ecÚ
.
NumRows
(è=ğ
out_d”iv_´ecÚ
.NumRows());

1518 
	gCuVeùÜ
<
	gBa£Flßt
> 
š_nÜm
(
š_v®ue_´ecÚ
.
NumRows
()),

1519 
out_d”iv_nÜm
(
š_v®ue_´ecÚ
.
NumRows
());

1520 
	gš_nÜm
.
AddDŸgM©2
(1.0, 
š_v®ue_´ecÚ
, 
kNoT¿ns
, 0.0);

1521 
	gout_d”iv_nÜm
.
AddDŸgM©2
(1.0, 
out_d”iv_´ecÚ
, 
kNoT¿ns
, 0.0);

1523 
	gš_nÜm
.
AµlyPow
(0.5);

1524 
	gout_d”iv_nÜm
.
AµlyPow
(0.5);

1525 
Ba£Flßt
 
	gsum
 = 
Ë¬nšg_¿‹_
 * 
VecVec
(
š_nÜm
, 
out_d”iv_nÜm
);

1528 
KALDI_ASSERT
(
sum
 == sum && sum - sum == 0.0 &&

1530 
KALDI_ASSERT
(
sum
 >= 0.0);

1531 ià(
	gsum
 <ğ
max_chªge_
)  1.0;

1533 
Ba£Flßt
 
	gªs
 = 
max_chªge_
 / 
sum
;

1534 ià(
	gsÿlšg_çùÜ_´š‹d
 < 10) {

1535 
	gKALDI_LOG
 << "Lim™šg s‹°siztØ" << 
	gmax_chªge_


1536 << " usšg sÿlšg faùÜ " << 
	gªs
 << ", for component index "

1537 << 
Index
();

1538 
	gsÿlšg_çùÜ_´š‹d
++;

1540  
	gªs
;

1544 
	gAffšeCompÚ’tP»cÚd™iÚed
::
Upd©e
(

1545 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1546 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

1547 
	gCuM©rix
<
	gBa£Flßt
> 
	gš_v®ue_‹mp
;

1549 
	gš_v®ue_‹mp
.
Resize
(
š_v®ue
.
NumRows
(),

1550 
š_v®ue
.
NumCŞs
(è+ 1, 
kUndefšed
);

1551 
	gš_v®ue_‹mp
.
Rªge
(0, 
š_v®ue
.
NumRows
(),

1552 0, 
š_v®ue
.
NumCŞs
()).
CİyFromM©
(in_value);

1555 
	gš_v®ue_‹mp
.
Rªge
(0, 
š_v®ue
.
NumRows
(),

1556 
š_v®ue
.
NumCŞs
(), 1).
S‘
(1.0);

1558 
	gCuM©rix
<
	gBa£Flßt
> 
š_v®ue_´ecÚ
(
š_v®ue_‹mp
.
NumRows
(),

1559 
š_v®ue_‹mp
.
NumCŞs
(), 
kUndefšed
),

1560 
out_d”iv_´ecÚ
(
out_d”iv
.
NumRows
(),

1561 
out_d”iv
.
NumCŞs
(), 
kUndefšed
);

1567 
P»cÚd™iÚDœeùiÚsAÍhaResÿËd
(
š_v®ue_‹mp
, 
®pha_
, &
š_v®ue_´ecÚ
);

1568 
P»cÚd™iÚDœeùiÚsAÍhaResÿËd
(
out_d”iv
, 
®pha_
, &
out_d”iv_´ecÚ
);

1570 
Ba£Flßt
 
	gmšib©ch_sÿË
 = 1.0;

1572 ià(
	gmax_chªge_
 > 0.0)

1573 
	gmšib©ch_sÿË
 = 
G‘SÿlšgFaùÜ
(
š_v®ue_´ecÚ
, 
out_d”iv_´ecÚ
);

1576 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_´ecÚ_·¹
(
š_v®ue_´ecÚ
,

1577 0, 
š_v®ue_´ecÚ
.
NumRows
(),

1578 0, 
š_v®ue_´ecÚ
.
NumCŞs
() - 1);

1581 
	gCuVeùÜ
<
	gBa£Flßt
> 
´ecÚ_Úes
(
š_v®ue_´ecÚ
.
NumRows
());

1583 
	g´ecÚ_Úes
.
CİyCŞFromM©
(
š_v®ue_´ecÚ
, in_v®ue_´ecÚ.
NumCŞs
() - 1);

1585 
Ba£Flßt
 
	gloÿl_Ì©e
 = 
mšib©ch_sÿË
 * 
Ë¬nšg_¿‹_
;

1586 
	gbŸs_·¿ms_
.
AddM©Vec
(
loÿl_Ì©e
, 
out_d”iv_´ecÚ
, 
kT¿ns
,

1587 
´ecÚ_Úes
, 1.0);

1588 
	glš—r_·¿ms_
.
AddM©M©
(
loÿl_Ì©e
, 
out_d”iv_´ecÚ
, 
kT¿ns
,

1589 
š_v®ue_´ecÚ_·¹
, 
kNoT¿ns
, 1.0);

1594 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
Resize
(

1595 
št32
 
šput_dim
, iÁ32 
ouut_dim
) {

1596 
KALDI_ASSERT
(
šput_dim
 > 1 && 
ouut_dim
 > 1);

1597 ià(
	g¿nk_š_
 >ğ
šput_dim
è
¿nk_š_
 = input_dim - 1;

1598 ià(
	g¿nk_out_
 >ğ
ouut_dim
è
¿nk_out_
 = output_dim - 1;

1599 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1600 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1601 
OÆšeP»cÚd™iÚ”
 
	g‹mp
;

1602 
	g´ecÚd™iÚ”_š_
 = 
‹mp
;

1603 
	g´ecÚd™iÚ”_out_
 = 
‹mp
;

1604 
S‘P»cÚd™iÚ”CÚfigs
();

1608 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

1609 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

1610 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

1611 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

1614 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, 
o¡r_beg
.
¡r
(), "<LearningRate>");

1615 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ë¬nšg_¿‹_
);

1616 
Ex³ùTok’
(
is
, 
bš¬y
, "<LinearParams>");

1617 
	glš—r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

1618 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

1619 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

1620 
	g¡d
::
¡ršg
 
tok
;

1621 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

1622 ià(
	gtok
 == "<Rank>") {

1623 
R—dBasicTy³
(
is
, 
bš¬y
, &
¿nk_š_
);

1624 
	g¿nk_out_
 = 
¿nk_š_
;

1626 
KALDI_ASSERT
(
tok
 == "<RankIn>");

1627 
R—dBasicTy³
(
is
, 
bš¬y
, &
¿nk_š_
);

1628 
Ex³ùTok’
(
is
, 
bš¬y
, "<RankOut>");

1629 
R—dBasicTy³
(
is
, 
bš¬y
, &
¿nk_out_
);

1631 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

1632 ià(
	gtok
 == "<UpdatePeriod>") {

1633 
R—dBasicTy³
(
is
, 
bš¬y
, &
upd©e_³riod_
);

1634 
Ex³ùTok’
(
is
, 
bš¬y
, "<NumSamplesHistory>");

1636 
	gupd©e_³riod_
 = 1;

1637 
KALDI_ASSERT
(
tok
 == "<NumSamplesHistory>");

1639 
R—dBasicTy³
(
is
, 
bš¬y
, &
num_§m¶es_hi¡Üy_
);

1640 
Ex³ùTok’
(
is
, 
bš¬y
, "<Alpha>");

1641 
R—dBasicTy³
(
is
, 
bš¬y
, &
®pha_
);

1642 
Ex³ùTok’
(
is
, 
bš¬y
, "<MaxChangePerSample>");

1643 
R—dBasicTy³
(
is
, 
bš¬y
, &
max_chªge_³r_§m¶e_
);

1644 
Ex³ùTok’
(
is
, 
bš¬y
, 
o¡r_’d
.
¡r
());

1645 
S‘P»cÚd™iÚ”CÚfigs
();

1648 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

1649 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

1650 
boŞ
 
	gok
 = 
Œue
;

1651 
	g¡d
::
¡ršg
 
m©rix_f’ame
;

1652 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 
Ë¬nšg_¿‹_
;

1653 
Ba£Flßt
 
	gnum_§m¶es_hi¡Üy
 = 2000.0, 
	g®pha
 = 4.0,

1654 
	gmax_chªge_³r_§m¶e
 = 0.1;

1655 
št32
 
	gšput_dim
 = -1, 
	gouut_dim
 = -1, 
	g¿nk_š
 = 30, 
	g¿nk_out
 = 80,

1656 
	gupd©e_³riod
 = 1;

1657 
P¬£FromSŒšg
("Ë¬nšg-¿‹", &
¬gs
, &
Ë¬nšg_¿‹
);

1658 
P¬£FromSŒšg
("num-§m¶es-hi¡Üy", &
¬gs
, &
num_§m¶es_hi¡Üy
);

1659 
P¬£FromSŒšg
("®pha", &
¬gs
, &
®pha
);

1660 
P¬£FromSŒšg
("max-chªge-³r-§m¶e", &
¬gs
, &
max_chªge_³r_§m¶e
);

1661 
P¬£FromSŒšg
("¿nk-š", &
¬gs
, &
¿nk_š
);

1662 
P¬£FromSŒšg
("¿nk-out", &
¬gs
, &
¿nk_out
);

1663 
P¬£FromSŒšg
("upd©e-³riod", &
¬gs
, &
upd©e_³riod
);

1665 ià(
P¬£FromSŒšg
("m©rix", &
¬gs
, &
m©rix_f’ame
)) {

1666 
In™
(
Ë¬nšg_¿‹
, 
¿nk_š
, 
¿nk_out
, 
upd©e_³riod
,

1667 
num_§m¶es_hi¡Üy
, 
®pha
, 
max_chªge_³r_§m¶e
,

1668 
m©rix_f’ame
);

1669 ià(
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
))

1670 
KALDI_ASSERT
(
šput_dim
 =ğ
IÅutDim
() &&

1672 ià(
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
))

1673 
KALDI_ASSERT
(
ouut_dim
 =ğ
OuutDim
() &&

1676 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

1677 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

1678 
Ba£Flßt
 
	g·¿m_¡ddev
 = 1.0 / 
¡d
::
sq¹
(
šput_dim
),

1679 
	gbŸs_¡ddev
 = 1.0;

1680 
P¬£FromSŒšg
("·¿m-¡ddev", &
¬gs
, &
·¿m_¡ddev
);

1681 
P¬£FromSŒšg
("bŸs-¡ddev", &
¬gs
, &
bŸs_¡ddev
);

1682 
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
, 
·¿m_¡ddev
,

1683 
bŸs_¡ddev
, 
¿nk_š
, 
¿nk_out
, 
upd©e_³riod
,

1684 
num_§m¶es_hi¡Üy
, 
®pha
, 
max_chªge_³r_§m¶e
);

1686 ià(!
	g¬gs
.
em±y
())

1687 
	gKALDI_ERR
 << "Could‚ot…rocessheseƒlements in initializer: "

1688 << 
	g¬gs
;

1689 ià(!
	gok
)

1690 
	gKALDI_ERR
 << "Bad in™Ÿliz” " << 
	gÜig_¬gs
;

1693 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
S‘P»cÚd™iÚ”CÚfigs
() {

1694 
´ecÚd™iÚ”_š_
.
S‘Rªk
(
¿nk_š_
);

1695 
	g´ecÚd™iÚ”_š_
.
S‘NumSam¶esHi¡Üy
(
num_§m¶es_hi¡Üy_
);

1696 
	g´ecÚd™iÚ”_š_
.
S‘AÍha
(
®pha_
);

1697 
	g´ecÚd™iÚ”_š_
.
S‘Upd©eP”iod
(
upd©e_³riod_
);

1698 
	g´ecÚd™iÚ”_out_
.
S‘Rªk
(
¿nk_out_
);

1699 
	g´ecÚd™iÚ”_out_
.
S‘NumSam¶esHi¡Üy
(
num_§m¶es_hi¡Üy_
);

1700 
	g´ecÚd™iÚ”_out_
.
S‘AÍha
(
®pha_
);

1701 
	g´ecÚd™iÚ”_out_
.
S‘Upd©eP”iod
(
upd©e_³riod_
);

1704 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
In™
(

1705 
Ba£Flßt
 
Ë¬nšg_¿‹
, 
št32
 
¿nk_š
, iÁ32 
¿nk_out
,

1706 
št32
 
upd©e_³riod
, 
Ba£Flßt
 
num_§m¶es_hi¡Üy
, Ba£Flßˆ
®pha
,

1707 
Ba£Flßt
 
max_chªge_³r_§m¶e
,

1708 
¡d
::
¡ršg
 
m©rix_f’ame
) {

1709 
Upd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

1710 
	g¿nk_š_
 = 
¿nk_š
;

1711 
	g¿nk_out_
 = 
¿nk_out
;

1712 
	gupd©e_³riod_
 = 
upd©e_³riod
;

1713 
	gnum_§m¶es_hi¡Üy_
 = 
num_§m¶es_hi¡Üy
;

1714 
	g®pha_
 = 
®pha
;

1715 
S‘P»cÚd™iÚ”CÚfigs
();

1716 
KALDI_ASSERT
(
max_chªge_³r_§m¶e
 >= 0.0);

1717 
	gmax_chªge_³r_§m¶e_
 = 
max_chªge_³r_§m¶e
;

1718 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©
;

1719 
R—dK®diObjeù
(
m©rix_f’ame
, &
m©
);

1720 
KALDI_ASSERT
(
m©
.
NumCŞs
() >= 2);

1721 
št32
 
	gšput_dim
 = 
m©
.
NumCŞs
(è- 1, 
	gouut_dim
 = m©.
NumRows
();

1722 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1723 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1724 
	glš—r_·¿ms_
.
CİyFromM©
(
m©
.
Rªge
(0, 
ouut_dim
, 0, 
šput_dim
));

1725 
	gbŸs_·¿ms_
.
CİyCŞFromM©
(
m©
, 
šput_dim
);

1728 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
AffšeCompÚ’tP»cÚd™iÚedOÆše
(

1729 cÚ¡ 
AffšeCompÚ’t
 &
Üig
,

1730 
št32
 
¿nk_š
, iÁ32 
¿nk_out
, iÁ32 
upd©e_³riod
,

1731 
Ba£Flßt
 
num_§m¶es_hi¡Üy
, Ba£Flßˆ
®pha
):

1732 
max_chªge_³r_§m¶e_
(0.1) {

1733 
this
->
lš—r_·¿ms_
 = 
Üig
.linear_params_;

1734 
	gthis
->
	gbŸs_·¿ms_
 = 
Üig
.
bŸs_·¿ms_
;

1735 
	gthis
->
	gË¬nšg_¿‹_
 = 
Üig
.
Ë¬nšg_¿‹_
;

1736 
	gthis
->
	gis_g¿d›Á_
 = 
Üig
.
is_g¿d›Á_
;

1737 
	gthis
->
	g¿nk_š_
 = 
¿nk_š
;

1738 
	gthis
->
	g¿nk_out_
 = 
¿nk_out
;

1739 
	gthis
->
	gupd©e_³riod_
 = 
upd©e_³riod
;

1740 
	gthis
->
	gnum_§m¶es_hi¡Üy_
 = 
num_§m¶es_hi¡Üy
;

1741 
	gthis
->
	g®pha_
 = 
®pha
;

1742 
S‘P»cÚd™iÚ”CÚfigs
();

1745 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
In™
(

1746 
Ba£Flßt
 
Ë¬nšg_¿‹
,

1747 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1748 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
,

1749 
št32
 
¿nk_š
, iÁ32 
¿nk_out
, iÁ32 
upd©e_³riod
,

1750 
Ba£Flßt
 
num_§m¶es_hi¡Üy
, Ba£Flßˆ
®pha
,

1751 
Ba£Flßt
 
max_chªge_³r_§m¶e
) {

1752 
	gUpd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

1753 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
);

1754 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

1755 
KALDI_ASSERT
(
ouut_dim
 > 0 && 
šput_dim
 > 0 && 
·¿m_¡ddev
 >= 0.0 &&

1756 
bŸs_¡ddev
 >= 0.0);

1757 
	glš—r_·¿ms_
.
S‘Rªdn
();

1758 
	glš—r_·¿ms_
.
SÿË
(
·¿m_¡ddev
);

1759 
	gbŸs_·¿ms_
.
S‘Rªdn
();

1760 
	gbŸs_·¿ms_
.
SÿË
(
bŸs_¡ddev
);

1761 
	g¿nk_š_
 = 
¿nk_š
;

1762 
	g¿nk_out_
 = 
¿nk_out
;

1763 
	gupd©e_³riod_
 = 
upd©e_³riod
;

1764 
	gnum_§m¶es_hi¡Üy_
 = 
num_§m¶es_hi¡Üy
;

1765 
	g®pha_
 = 
®pha
;

1766 
S‘P»cÚd™iÚ”CÚfigs
();

1767 
KALDI_ASSERT
(
max_chªge_³r_§m¶e
 >= 0.0);

1768 
	gmax_chªge_³r_§m¶e_
 = 
max_chªge_³r_§m¶e
;

1772 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

1773 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

1774 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

1775 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

1776 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_beg
.
¡r
());

1777 
Wr™eTok’
(
os
, 
bš¬y
, "<LearningRate>");

1778 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ë¬nšg_¿‹_
);

1779 
Wr™eTok’
(
os
, 
bš¬y
, "<LinearParams>");

1780 
	glš—r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

1781 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

1782 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

1783 
Wr™eTok’
(
os
, 
bš¬y
, "<RankIn>");

1784 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
¿nk_š_
);

1785 
Wr™eTok’
(
os
, 
bš¬y
, "<RankOut>");

1786 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
¿nk_out_
);

1787 
Wr™eTok’
(
os
, 
bš¬y
, "<UpdatePeriod>");

1788 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
upd©e_³riod_
);

1789 
Wr™eTok’
(
os
, 
bš¬y
, "<NumSamplesHistory>");

1790 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
num_§m¶es_hi¡Üy_
);

1791 
Wr™eTok’
(
os
, 
bš¬y
, "<Alpha>");

1792 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
®pha_
);

1793 
Wr™eTok’
(
os
, 
bš¬y
, "<MaxChangePerSample>");

1794 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
max_chªge_³r_§m¶e_
);

1795 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_’d
.
¡r
());

1798 
	g¡d
::
¡ršg
 
AffšeCompÚ’tP»cÚd™iÚedOÆše
::
Info
() const {

1799 
¡d
::
¡ršg¡»am
 
¡»am
;

1800 
Ba£Flßt
 
	glš—r_·¿ms_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
lš—r_·¿ms_
.
NumRows
())

1801 * 
¡©ic_ÿ¡
<
Ba£Flßt
>(
lš—r_·¿ms_
.
NumCŞs
());

1802 
Ba£Flßt
 
	glš—r_¡ddev
 =

1803 
¡d
::
sq¹
(
T¿ûM©M©
(
lš—r_·¿ms_
,†š—r_·¿ms_, 
kT¿ns
) /

1804 
lš—r_·¿ms_size
),

1805 
	gbŸs_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
bŸs_·¿ms_
, bias_params_) /

1806 
bŸs_·¿ms_
.
Dim
());

1807 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim=" << 
IÅutDim
()

1808 << ", ouut-dim=" << 
OuutDim
()

1809 << ",†š—r-·¿ms-¡ddev=" << 
	glš—r_¡ddev


1810 << ", bŸs-·¿ms-¡ddev=" << 
	gbŸs_¡ddev


1811 << ",†—ºšg-¿‹=" << 
L—ºšgR©e
()

1812 << ",„ªk-š=" << 
	g¿nk_š_


1813 << ",„ªk-out=" << 
	g¿nk_out_


1814 << ",‚um_§m¶es_hi¡Üy=" << 
	gnum_§m¶es_hi¡Üy_


1815 << ", upd©e_³riod=" << 
	gupd©e_³riod_


1816 << ",‡Íha=" << 
	g®pha_


1817 << ", max-chªge-³r-§m¶e=" << 
	gmax_chªge_³r_§m¶e_
;

1818  
	g¡»am
.
¡r
();

1821 
CompÚ’t
* 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
Cİy
() const {

1822 
AffšeCompÚ’tP»cÚd™iÚedOÆše
 *
ªs
 = 
Ãw
 AffineComponentPreconditionedOnline();

1823 
	gªs
->
	gË¬nšg_¿‹_
 = 
Ë¬nšg_¿‹_
;

1824 
	gªs
->
	g¿nk_š_
 = 
¿nk_š_
;

1825 
	gªs
->
	g¿nk_out_
 = 
¿nk_out_
;

1826 
	gªs
->
	gupd©e_³riod_
 = 
upd©e_³riod_
;

1827 
	gªs
->
	gnum_§m¶es_hi¡Üy_
 = 
num_§m¶es_hi¡Üy_
;

1828 
	gªs
->
	g®pha_
 = 
®pha_
;

1829 
	gªs
->
	glš—r_·¿ms_
 = 
lš—r_·¿ms_
;

1830 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

1831 
	gªs
->
	g´ecÚd™iÚ”_š_
 = 
´ecÚd™iÚ”_š_
;

1832 
	gªs
->
	g´ecÚd™iÚ”_out_
 = 
´ecÚd™iÚ”_out_
;

1833 
	gªs
->
	gmax_chªge_³r_§m¶e_
 = 
max_chªge_³r_§m¶e_
;

1834 
	gªs
->
	gis_g¿d›Á_
 = 
is_g¿d›Á_
;

1835 
	gªs
->
S‘P»cÚd™iÚ”CÚfigs
();

1836  
	gªs
;

1841 
Ba£Flßt
 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
G‘SÿlšgFaùÜ
(

1842 cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
š_´oduùs
,

1843 
Ba£Flßt
 
Ë¬nšg_¿‹_sÿË
,

1844 
CuVeùÜBa£
<
Ba£Flßt
> *
out_´oduùs
) {

1845 
	gsÿlšg_çùÜ_´š‹d
 = 0;

1846 
št32
 
	gmšib©ch_size
 = 
š_´oduùs
.
Dim
();

1848 
	gout_´oduùs
->
MulEËm’ts
(
š_´oduùs
);

1849 
	gout_´oduùs
->
AµlyPow
(0.5);

1850 
Ba£Flßt
 
	g´od_sum
 = 
out_´oduùs
->
Sum
();

1851 
Ba£Flßt
 
	gtÙ_chªge_nÜm
 = 
Ë¬nšg_¿‹_sÿË
 * 
Ë¬nšg_¿‹_
 * 
´od_sum
,

1852 
	gmax_chªge_nÜm
 = 
max_chªge_³r_§m¶e_
 * 
mšib©ch_size
;

1855 
KALDI_ASSERT
(
tÙ_chªge_nÜm
 -ot_change_norm == 0.0 && "NaN in backprop");

1856 
KALDI_ASSERT
(
tÙ_chªge_nÜm
 >= 0.0);

1857 ià(
	gtÙ_chªge_nÜm
 <ğ
max_chªge_nÜm
)  1.0;

1859 
Ba£Flßt
 
	gçùÜ
 = 
max_chªge_nÜm
 / 
tÙ_chªge_nÜm
;

1860 ià(
	gsÿlšg_çùÜ_´š‹d
 < 10) {

1861 
	gKALDI_LOG
 << "Limiting step size using scaling factor "

1862 << 
	gçùÜ
 << ", fÜ compÚ’ˆšdex " << 
Index
();

1863 
	gsÿlšg_çùÜ_´š‹d
++;

1865  
	gçùÜ
;

1869 
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
::
Upd©e
(

1870 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1871 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

1872 
	gCuM©rix
<
	gBa£Flßt
> 
	gš_v®ue_‹mp
;

1874 
	gš_v®ue_‹mp
.
Resize
(
š_v®ue
.
NumRows
(),

1875 
š_v®ue
.
NumCŞs
(è+ 1, 
kUndefšed
);

1876 
	gš_v®ue_‹mp
.
Rªge
(0, 
š_v®ue
.
NumRows
(),

1877 0, 
š_v®ue
.
NumCŞs
()).
CİyFromM©
(in_value);

1880 
	gš_v®ue_‹mp
.
Rªge
(0, 
š_v®ue
.
NumRows
(),

1881 
š_v®ue
.
NumCŞs
(), 1).
S‘
(1.0);

1883 
	gCuM©rix
<
	gBa£Flßt
> 
out_d”iv_‹mp
(
out_d”iv
);

1885 
	gCuM©rix
<
	gBa£Flßt
> 
row_´oduùs
(2,

1886 
š_v®ue
.
NumRows
());

1887 
	gCuSubVeùÜ
<
	gBa£Flßt
> 
š_row_´oduùs
(
row_´oduùs
, 0),

1888 
out_row_´oduùs
(
row_´oduùs
, 1);

1892 
Ba£Flßt
 
	gš_sÿË
, 
	gout_sÿË
;

1894 
	g´ecÚd™iÚ”_š_
.
P»cÚd™iÚDœeùiÚs
(&
š_v®ue_‹mp
, &
š_row_´oduùs
,

1895 &
š_sÿË
);

1896 
	g´ecÚd™iÚ”_out_
.
P»cÚd™iÚDœeùiÚs
(&
out_d”iv_‹mp
, &
out_row_´oduùs
,

1897 &
out_sÿË
);

1902 
Ba£Flßt
 
	gsÿË
 = 
š_sÿË
 * 
out_sÿË
;

1903 
Ba£Flßt
 
	gmšib©ch_sÿË
 = 1.0;

1905 ià(
	gmax_chªge_³r_§m¶e_
 > 0.0)

1906 
	gmšib©ch_sÿË
 = 
G‘SÿlšgFaùÜ
(
š_row_´oduùs
, 
sÿË
,

1907 &
out_row_´oduùs
);

1909 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_´ecÚ_·¹
(
š_v®ue_‹mp
,

1910 0, 
š_v®ue_‹mp
.
NumRows
(),

1911 0, 
š_v®ue_‹mp
.
NumCŞs
() - 1);

1914 
	gCuVeùÜ
<
	gBa£Flßt
> 
´ecÚ_Úes
(
š_v®ue_‹mp
.
NumRows
());

1916 
	g´ecÚ_Úes
.
CİyCŞFromM©
(
š_v®ue_‹mp
, in_v®ue_‹mp.
NumCŞs
() - 1);

1918 
Ba£Flßt
 
	gloÿl_Ì©e
 = 
sÿË
 * 
mšib©ch_sÿË
 * 
Ë¬nšg_¿‹_
;

1919 
	gbŸs_·¿ms_
.
AddM©Vec
(
loÿl_Ì©e
, 
out_d”iv_‹mp
, 
kT¿ns
,

1920 
´ecÚ_Úes
, 1.0);

1921 
	glš—r_·¿ms_
.
AddM©M©
(
loÿl_Ì©e
, 
out_d”iv_‹mp
, 
kT¿ns
,

1922 
š_v®ue_´ecÚ_·¹
, 
kNoT¿ns
, 1.0);

1925 
	gBlockAffšeCompÚ’t
::
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
) {

1926 ià(
Œ—t_as_g¿d›Á
) {

1927 
S‘L—ºšgR©e
(1.0);

1929 
	glš—r_·¿ms_
.
S‘Z”o
();

1930 
	gbŸs_·¿ms_
.
S‘Z”o
();

1933 
	gBlockAffšeCompÚ’t
::
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
) {

1934 
CuM©rix
<
Ba£Flßt
> 
‹mp_lš—r_·¿ms
(
lš—r_·¿ms_
);

1935 
	g‹mp_lš—r_·¿ms
.
S‘Rªdn
();

1936 
	glš—r_·¿ms_
.
AddM©
(
¡ddev
, 
‹mp_lš—r_·¿ms
);

1938 
	gCuVeùÜ
<
	gBa£Flßt
> 
‹mp_bŸs_·¿ms
(
bŸs_·¿ms_
);

1939 
	g‹mp_bŸs_·¿ms
.
S‘Rªdn
();

1940 
	gbŸs_·¿ms_
.
AddVec
(
¡ddev
, 
‹mp_bŸs_·¿ms
);

1943 
Ba£Flßt
 
	gBlockAffšeCompÚ’t
::
DÙProduù
(

1944 cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”_š
) const {

1945 cÚ¡ 
BlockAffšeCompÚ’t
 *
Ùh”
 =

1946 
dyÇmic_ÿ¡
<cÚ¡ 
BlockAffšeCompÚ’t
*>(&
Ùh”_š
);

1947  
T¿ûM©M©
(
lš—r_·¿ms_
, 
Ùh”
->lš—r_·¿ms_, 
kT¿ns
)

1948 + 
VecVec
(
bŸs_·¿ms_
, 
Ùh”
->bias_params_);

1951 
CompÚ’t
* 
	gBlockAffšeCompÚ’t
::
Cİy
() const {

1952 
BlockAffšeCompÚ’t
 *
ªs
 = 
Ãw
 BlockAffineComponent();

1953 
	gªs
->
	gË¬nšg_¿‹_
 = 
Ë¬nšg_¿‹_
;

1954 
	gªs
->
	glš—r_·¿ms_
 = 
lš—r_·¿ms_
;

1955 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

1956 
	gªs
->
	gnum_blocks_
 = 
num_blocks_
;

1957  
	gªs
;

1960 
	gBlockAffšeCompÚ’t
::
SÿË
(
Ba£Flßt
 
sÿË
) {

1961 
lš—r_·¿ms_
.
SÿË
(
sÿË
);

1962 
	gbŸs_·¿ms_
.
SÿË
(
sÿË
);

1965 
	gBlockAffšeCompÚ’t
::
Add
(
Ba£Flßt
 
®pha
,

1966 cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”_š
) {

1967 cÚ¡ 
BlockAffšeCompÚ’t
 *
	gÙh”
 =

1968 
dyÇmic_ÿ¡
<cÚ¡ 
BlockAffšeCompÚ’t
*>(&
Ùh”_š
);

1969 
KALDI_ASSERT
(
Ùh”
 !ğ
NULL
);

1970 
	glš—r_·¿ms_
.
AddM©
(
®pha
, 
Ùh”
->
lš—r_·¿ms_
);

1971 
	gbŸs_·¿ms_
.
AddVec
(
®pha
, 
Ùh”
->
bŸs_·¿ms_
);

1974 
	gBlockAffšeCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1975 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1976 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1977 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

1978 
	gš_šfo
.
CheckSize
(
š
);

1979 
	gout_šfo
.
CheckSize
(*
out
);

1980 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

1990 
št32
 
	gšput_block_dim
 = 
lš—r_·¿ms_
.
NumCŞs
(),

1991 
	gouut_block_dim
 = 
lš—r_·¿ms_
.
NumRows
(è/ 
num_blocks_
,

1992 
	gnum_äames
 = 
š
.
NumRows
();

1993 
KALDI_ASSERT
(
š
.
NumCŞs
(è=ğ
šput_block_dim
 * 
num_blocks_
);

1994 
KALDI_ASSERT
(
out
->
NumCŞs
(è=ğ
ouut_block_dim
 * 
num_blocks_
);

1995 
KALDI_ASSERT
(
š
.
NumRows
(è=ğ
out
->NumRows());

1997 
	gout
->
CİyRowsFromVec
(
bŸs_·¿ms_
);

2000 
št32
 
	gb
 = 0; b < 
	gnum_blocks_
; b++) {

2001 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_block
(
š
, 0, 
num_äames
,

2002 
b
 * 
šput_block_dim
, input_block_dim),

2003 
out_block
(*
out
, 0, 
num_äames
,

2004 
b
 * 
ouut_block_dim
, output_block_dim),

2005 
·¿m_block
(
lš—r_·¿ms_
,

2006 
b
 * 
ouut_block_dim
, output_block_dim,

2007 0, 
šput_block_dim
);

2008 
	gout_block
.
AddM©M©
(1.0, 
š_block
, 
kNoT¿ns
, 
·¿m_block
, 
kT¿ns
, 1.0);

2012 
	gBlockAffšeCompÚ’t
::
Upd©eSim¶e
(

2013 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

2014 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

2015 
št32
 
	gšput_block_dim
 = 
lš—r_·¿ms_
.
NumCŞs
(),

2016 
	gouut_block_dim
 = 
lš—r_·¿ms_
.
NumRows
(è/ 
num_blocks_
,

2017 
	gnum_äames
 = 
š_v®ue
.
NumRows
();

2019 
	gbŸs_·¿ms_
.
AddRowSumM©
(
Ë¬nšg_¿‹_
, 
out_d”iv
, 1.0);

2020 
št32
 
	gb
 = 0; b < 
	gnum_blocks_
; b++) {

2021 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_block
(
š_v®ue
, 0, 
num_äames
,

2022 
b
 * 
šput_block_dim
,

2023 
šput_block_dim
),

2024 
out_d”iv_block
(
out_d”iv
, 0, 
num_äames
,

2025 
b
 * 
ouut_block_dim
, output_block_dim),

2026 
·¿m_block
(
lš—r_·¿ms_
,

2027 
b
 * 
ouut_block_dim
, output_block_dim,

2028 0, 
šput_block_dim
);

2030 
	g·¿m_block
.
AddM©M©
(
Ë¬nšg_¿‹_
, 
out_d”iv_block
, 
kT¿ns
,

2031 
š_v®ue_block
, 
kNoT¿ns
, 1.0);

2035 
	gBlockAffšeCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

2036 cÚ¡ 
ChunkInfo
 &,

2037 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

2038 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

2039 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

2040 
CompÚ’t
 *
to_upd©e_š
,

2041 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

2044 
št32
 
	gnum_äames
 = 
š_v®ue
.
NumRows
();

2045 
BlockAffšeCompÚ’t
 *
	gto_upd©e
 = 
dyÇmic_ÿ¡
<BlockAffineComponent*>(

2046 
to_upd©e_š
);

2047 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), 
IÅutDim
());

2048 
št32
 
	gšput_block_dim
 = 
lš—r_·¿ms_
.
NumCŞs
(),

2049 
	gouut_block_dim
 = 
lš—r_·¿ms_
.
NumRows
(è/ 
num_blocks_
;

2050 
KALDI_ASSERT
(
š_v®ue
.
NumCŞs
(è=ğ
šput_block_dim
 * 
num_blocks_
);

2051 
KALDI_ASSERT
(
out_d”iv
.
NumCŞs
(è=ğ
ouut_block_dim
 * 
num_blocks_
);

2053 
št32
 
	gb
 = 0; b < 
	gnum_blocks_
; b++) {

2054 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_block
(
š_v®ue
, 0, 
num_äames
,

2055 
b
 * 
šput_block_dim
,

2056 
šput_block_dim
),

2057 
š_d”iv_block
(*
š_d”iv
, 0, 
num_äames
,

2058 
b
 * 
šput_block_dim
, input_block_dim),

2059 
out_d”iv_block
(
out_d”iv
, 0, 
num_äames
,

2060 
b
 * 
ouut_block_dim
, output_block_dim),

2061 
·¿m_block
(
lš—r_·¿ms_
,

2062 
b
 * 
ouut_block_dim
, output_block_dim,

2063 0, 
šput_block_dim
);

2066 
	gš_d”iv_block
.
AddM©M©
(1.0, 
out_d”iv_block
, 
kNoT¿ns
,

2067 
·¿m_block
, 
kNoT¿ns
, 0.0);

2069 ià(
	gto_upd©e
 !ğ
NULL
)

2070 
to_upd©e
->
Upd©e
(
š_v®ue
, 
out_d”iv
);

2074 
	gBlockAffšeCompÚ’t
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

2075 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

2076 
Ba£Flßt
 
·¿m_¡ddev
,

2077 
Ba£Flßt
 
bŸs_¡ddev
,

2078 
št32
 
num_blocks
) {

2079 
	gUpd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

2080 
KALDI_ASSERT
(
ouut_dim
 > 0 && 
šput_dim
 > 0 && 
·¿m_¡ddev
 >= 0.0);

2081 
KALDI_ASSERT
(
šput_dim
 % 
num_blocks
 =ğ0 && 
ouut_dim
 %‚um_blocks == 0);

2083 
	glš—r_·¿ms_
.
Resize
(
ouut_dim
, 
šput_dim
 / 
num_blocks
);

2084 
	gbŸs_·¿ms_
.
Resize
(
ouut_dim
);

2086 
	glš—r_·¿ms_
.
S‘Rªdn
();

2087 
	glš—r_·¿ms_
.
SÿË
(
·¿m_¡ddev
);

2088 
	gbŸs_·¿ms_
.
S‘Rªdn
();

2089 
	gbŸs_·¿ms_
.
SÿË
(
bŸs_¡ddev
);

2090 
	gnum_blocks_
 = 
num_blocks
;

2093 
	gBlockAffšeCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

2094 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

2095 
boŞ
 
	gok
 = 
Œue
;

2096 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 
Ë¬nšg_¿‹_
;

2097 
št32
 
	gšput_dim
 = -1, 
	gouut_dim
 = -1, 
	gnum_blocks
 = 1;

2098 
P¬£FromSŒšg
("Ë¬nšg-¿‹", &
¬gs
, &
Ë¬nšg_¿‹
);

2099 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

2100 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

2101 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("num-blocks", &
¬gs
, &
num_blocks
);

2102 
Ba£Flßt
 
	g·¿m_¡ddev
 = 1.0 / 
¡d
::
sq¹
(
šput_dim
),

2103 
	gbŸs_¡ddev
 = 1.0;

2104 
P¬£FromSŒšg
("·¿m-¡ddev", &
¬gs
, &
·¿m_¡ddev
);

2105 
P¬£FromSŒšg
("bŸs-¡ddev", &
¬gs
, &
bŸs_¡ddev
);

2106 ià(!
	g¬gs
.
em±y
())

2107 
	gKALDI_ERR
 << "Could‚ot…rocessheseƒlements in initializer: "

2108 << 
	g¬gs
;

2109 ià(!
	gok
)

2110 
	gKALDI_ERR
 << "Bad in™Ÿliz” " << 
	gÜig_¬gs
;

2111 
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

2112 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
num_blocks
);

2116 
	gBlockAffšeCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

2117 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<BlockAffineComponent>", "<LearningRate>");

2118 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ë¬nšg_¿‹_
);

2119 
Ex³ùTok’
(
is
, 
bš¬y
, "<NumBlocks>");

2120 
R—dBasicTy³
(
is
, 
bš¬y
, &
num_blocks_
);

2121 
Ex³ùTok’
(
is
, 
bš¬y
, "<LinearParams>");

2122 
	glš—r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

2123 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

2124 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

2125 
Ex³ùTok’
(
is
, 
bš¬y
, "</BlockAffineComponent>");

2128 
	gBlockAffšeCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

2129 
Wr™eTok’
(
os
, 
bš¬y
, "<BlockAffineComponent>");

2130 
Wr™eTok’
(
os
, 
bš¬y
, "<LearningRate>");

2131 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ë¬nšg_¿‹_
);

2132 
Wr™eTok’
(
os
, 
bš¬y
, "<NumBlocks>");

2133 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
num_blocks_
);

2134 
Wr™eTok’
(
os
, 
bš¬y
, "<LinearParams>");

2135 
	glš—r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

2136 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

2137 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

2138 
Wr™eTok’
(
os
, 
bš¬y
, "</BlockAffineComponent>");

2142 
št32
 
	gBlockAffšeCompÚ’t
::
G‘P¬am‘”Dim
() const {

2144  
IÅutDim
(è* 
OuutDim
(è/ 
num_blocks_
;

2147 
	gBlockAffšeCompÚ’t
::
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
) const {

2148 
št32
 
l
 = 
lš—r_·¿ms_
.
NumRows
(è*†š—r_·¿ms_.
NumCŞs
(),

2149 
	gb
 = 
bŸs_·¿ms_
.
Dim
();

2150 
	g·¿ms
->
Rªge
(0, 
l
).
CİyRowsFromM©
(
lš—r_·¿ms_
);

2151 
	g·¿ms
->
Rªge
(
l
, 
b
).
CİyFromVec
(
bŸs_·¿ms_
);

2153 
	gBlockAffšeCompÚ’t
::
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
) {

2154 
št32
 
l
 = 
lš—r_·¿ms_
.
NumRows
(è*†š—r_·¿ms_.
NumCŞs
(),

2155 
	gb
 = 
bŸs_·¿ms_
.
Dim
();

2156 
	glš—r_·¿ms_
.
CİyRowsFromVec
(
·¿ms
.
Rªge
(0, 
l
));

2157 
	gbŸs_·¿ms_
.
CİyFromVec
(
·¿ms
.
Rªge
(
l
, 
b
));

2161 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

2162 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

2163 
Ba£Flßt
 
·¿m_¡ddev
,

2164 
Ba£Flßt
 
bŸs_¡ddev
,

2165 
št32
 
num_blocks
,

2166 
Ba£Flßt
 
®pha
) {

2167 
	gBlockAffšeCompÚ’t
::
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

2168 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
num_blocks
);

2169 
	gis_g¿d›Á_
 = 
çl£
;

2170 
KALDI_ASSERT
(
®pha
 > 0.0);

2171 
	g®pha_
 = 
®pha
;

2174 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

2175 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

2176 
boŞ
 
	gok
 = 
Œue
;

2177 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 
Ë¬nšg_¿‹_
;

2178 
Ba£Flßt
 
	g®pha
 = 4.0;

2179 
št32
 
	gšput_dim
 = -1, 
	gouut_dim
 = -1, 
	gnum_blocks
 = 1;

2180 
P¬£FromSŒšg
("Ë¬nšg-¿‹", &
¬gs
, &
Ë¬nšg_¿‹
);

2181 
P¬£FromSŒšg
("®pha", &
¬gs
, &
®pha
);

2182 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

2183 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

2184 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("num-blocks", &
¬gs
, &
num_blocks
);

2186 
Ba£Flßt
 
	g·¿m_¡ddev
 = 1.0 / 
¡d
::
sq¹
(
šput_dim
),

2187 
	gbŸs_¡ddev
 = 1.0;

2188 
P¬£FromSŒšg
("·¿m-¡ddev", &
¬gs
, &
·¿m_¡ddev
);

2189 
P¬£FromSŒšg
("bŸs-¡ddev", &
¬gs
, &
bŸs_¡ddev
);

2190 ià(!
	g¬gs
.
em±y
())

2191 
	gKALDI_ERR
 << "Could‚ot…rocessheseƒlements in initializer: "

2192 << 
	g¬gs
;

2193 ià(!
	gok
)

2194 
	gKALDI_ERR
 << "Bad in™Ÿliz” " << 
	gÜig_¬gs
;

2195 
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
,

2196 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
num_blocks
,

2197 
®pha
);

2200 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
) {

2201 ià(
Œ—t_as_g¿d›Á
)

2202 
is_g¿d›Á_
 = 
Œue
;

2203 
	gBlockAffšeCompÚ’t
::
S‘Z”o
(
Œ—t_as_g¿d›Á
);

2206 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

2207 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<BlockAffineComponentPreconditioned>",

2209 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ë¬nšg_¿‹_
);

2210 
Ex³ùTok’
(
is
, 
bš¬y
, "<NumBlocks>");

2211 
R—dBasicTy³
(
is
, 
bš¬y
, &
num_blocks_
);

2212 
Ex³ùTok’
(
is
, 
bš¬y
, "<LinearParams>");

2213 
	glš—r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

2214 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

2215 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

2216 
Ex³ùTok’
(
is
, 
bš¬y
, "<Alpha>");

2217 
R—dBasicTy³
(
is
, 
bš¬y
, &
®pha_
);

2218 
Ex³ùTok’
(
is
, 
bš¬y
, "<IsGradient>");

2219 
R—dBasicTy³
(
is
, 
bš¬y
, &
is_g¿d›Á_
);

2220 
Ex³ùTok’
(
is
, 
bš¬y
, "</BlockAffineComponentPreconditioned>");

2223 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
Wr™e
(
¡d
::
o¡»am
 &
os
,

2224 
boŞ
 
bš¬y
) const {

2225 
Wr™eTok’
(
os
, 
bš¬y
, "<BlockAffineComponentPreconditioned>");

2226 
Wr™eTok’
(
os
, 
bš¬y
, "<LearningRate>");

2227 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ë¬nšg_¿‹_
);

2228 
Wr™eTok’
(
os
, 
bš¬y
, "<NumBlocks>");

2229 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
num_blocks_
);

2230 
Wr™eTok’
(
os
, 
bš¬y
, "<LinearParams>");

2231 
	glš—r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

2232 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

2233 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

2234 
Wr™eTok’
(
os
, 
bš¬y
, "<Alpha>");

2235 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
®pha_
);

2236 
Wr™eTok’
(
os
, 
bš¬y
, "<IsGradient>");

2237 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
is_g¿d›Á_
);

2238 
Wr™eTok’
(
os
, 
bš¬y
, "</BlockAffineComponentPreconditioned>");

2241 
CompÚ’t
* 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
Cİy
() const {

2242 
BlockAffšeCompÚ’tP»cÚd™iÚed
 *
ªs
 = 
Ãw


2243 
BlockAffšeCompÚ’tP»cÚd™iÚed
();

2244 
	gªs
->
	gË¬nšg_¿‹_
 = 
Ë¬nšg_¿‹_
;

2245 
	gªs
->
	glš—r_·¿ms_
 = 
lš—r_·¿ms_
;

2246 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

2247 
	gªs
->
	gnum_blocks_
 = 
num_blocks_
;

2248 
	gªs
->
	g®pha_
 = 
®pha_
;

2249 
	gªs
->
	gis_g¿d›Á_
 = 
is_g¿d›Á_
;

2250  
	gªs
;

2253 
	gBlockAffšeCompÚ’tP»cÚd™iÚed
::
Upd©e
(

2254 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

2255 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

2256 ià(
	gis_g¿d›Á_
) {

2257 
Upd©eSim¶e
(
š_v®ue
, 
out_d”iv
);

2261 
št32
 
	gšput_block_dim
 = 
lš—r_·¿ms_
.
NumCŞs
(),

2262 
	gouut_block_dim
 = 
lš—r_·¿ms_
.
NumRows
(è/ 
num_blocks_
,

2263 
	gnum_äames
 = 
š_v®ue
.
NumRows
();

2265 
	gCuM©rix
<
	gBa£Flßt
> 
š_v®ue_‹mp
(
num_äames
, 
šput_block_dim
 + 1, 
kUndefšed
),

2266 
š_v®ue_´ecÚ
(
num_äames
, 
šput_block_dim
 + 1, 
kUndefšed
);

2267 
	gš_v®ue_‹mp
.
S‘
(1.0);

2268 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_‹mp_·¹
(
š_v®ue_‹mp
, 0, 
num_äames
,

2269 0, 
šput_block_dim
);

2270 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_´ecÚ_·¹
(
š_v®ue_´ecÚ
, 0, 
num_äames
,

2271 0, 
šput_block_dim
);

2272 
	gCuVeùÜ
<
	gBa£Flßt
> 
´ecÚ_Úes
(
num_äames
);

2273 
	gCuM©rix
<
	gBa£Flßt
> 
out_d”iv_´ecÚ
(
num_äames
, 
ouut_block_dim
, 
kUndefšed
);

2275 
št32
 
	gb
 = 0; b < 
	gnum_blocks_
; b++) {

2276 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_v®ue_block
(
š_v®ue
, 0, 
num_äames
,

2277 
b
 * 
šput_block_dim
,

2278 
šput_block_dim
),

2279 
out_d”iv_block
(
out_d”iv
, 0, 
num_äames
,

2280 
b
 * 
ouut_block_dim
, output_block_dim),

2281 
·¿m_block
(
lš—r_·¿ms_
,

2282 
b
 * 
ouut_block_dim
, output_block_dim,

2283 0, 
šput_block_dim
);

2284 
	gš_v®ue_‹mp_·¹
.
CİyFromM©
(
š_v®ue_block
);

2286 
P»cÚd™iÚDœeùiÚsAÍhaResÿËd
(
š_v®ue_‹mp
, 
®pha_
,

2287 &
š_v®ue_´ecÚ
);

2288 
P»cÚd™iÚDœeùiÚsAÍhaResÿËd
(
out_d”iv_block
, 
®pha_
,

2289 &
out_d”iv_´ecÚ
);

2293 
	g·¿m_block
.
AddM©M©
(
Ë¬nšg_¿‹_
, 
out_d”iv_´ecÚ
, 
kT¿ns
,

2294 
š_v®ue_´ecÚ_·¹
, 
kNoT¿ns
, 1.0);

2295 
	g´ecÚ_Úes
.
CİyCŞFromM©
(
š_v®ue_´ecÚ
, 
šput_block_dim
);

2296 
	gbŸs_·¿ms_
.
Rªge
(
b
 * 
ouut_block_dim
, output_block_dim).

2297 
AddM©Vec
(
Ë¬nšg_¿‹_
, 
out_d”iv_´ecÚ
, 
kT¿ns
,

2298 
´ecÚ_Úes
, 1.0);

2303 
	gP”mu‹CompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

2304 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<PermuteComponent>", "<Reorder>");

2305 
R—dIÁeg”VeùÜ
(
is
, 
bš¬y
, &
»Üd”_
);

2306 
Ex³ùTok’
(
is
, 
bš¬y
, "</PermuteComponent>");

2309 
	gP”mu‹CompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

2310 
Wr™eTok’
(
os
, 
bš¬y
, "<PermuteComponent>");

2311 
Wr™eTok’
(
os
, 
bš¬y
, "<Reorder>");

2312 
Wr™eIÁeg”VeùÜ
(
os
, 
bš¬y
, 
»Üd”_
);

2313 
Wr™eTok’
(
os
, 
bš¬y
, "</PermuteComponent>");

2316 
	gP”mu‹CompÚ’t
::
In™
(
št32
 
dim
) {

2317 
KALDI_ASSERT
(
dim
 > 0);

2318 
	g»Üd”_
.
»size
(
dim
);

2319 
št32
 
	gi
 = 0; i < 
	gdim
; i++è
	g»Üd”_
[
i
] = i;

2320 
	g¡d
::
¿ndom_shufæe
(
»Üd”_
.
begš
(),„eÜd”_.
’d
());

2323 
	gP”mu‹CompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

2324 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

2325 
št32
 
	gdim
;

2326 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
);

2327 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gdim
 <= 0)

2328 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

2329 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

2330 
In™
(
dim
);

2333 
	gP”mu‹CompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2334 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2335 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

2336 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

2337 
	gš_šfo
.
CheckSize
(
š
);

2338 
	gout_šfo
.
CheckSize
(*
out
);

2339 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

2341 
	g¡d
::
veùÜ
<
št32
> 
»v”£_»Üd”
(
»Üd”_
.
size
());

2342 
size_t
 
	gi
 = 0; i < 
	g»Üd”_
.
size
(); i++)

2343 
	g»v”£_»Üd”
[
»Üd”_
[
i
]] = i;

2346 
	gCuA¼ay
<
	gšt32
> 
cu_»v”£_»Üd”
(
»v”£_»Üd”
);

2347 
	gout
->
CİyCŞs
(
š
, 
cu_»v”£_»Üd”
);

2350 
	gP”mu‹CompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

2351 cÚ¡ 
ChunkInfo
 &,

2352 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

2353 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

2354 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

2355 
CompÚ’t
 *
to_upd©e
,

2356 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

2357 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

2358 
KALDI_ASSERT
(
out_d”iv
.
NumCŞs
(è=ğ
OuutDim
());

2361 
	gCuA¼ay
<
	gšt32
> 
cu_»Üd”
(
»Üd”_
);

2362 
	gš_d”iv
->
CİyCŞs
(
out_d”iv
, 
cu_»Üd”
);

2365 
	gSumGroupCompÚ’t
::
In™
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
sizes
) {

2366 
KALDI_ASSERT
(!
sizes
.
em±y
());

2367 
	g¡d
::
veùÜ
<
IÁ32Paœ
> 
ıu_vec
(
sizes
.
size
());

2368 
	g¡d
::
veùÜ
<
št32
> 
»v”£_ıu_vec
;

2369 
št32
 
	gcur_šdex
 = 0;

2370 
size_t
 
	gi
 = 0; i < 
	gsizes
.
size
(); i++) {

2371 
KALDI_ASSERT
(
sizes
[
i
] > 0);

2372 
	gıu_vec
[
i
].
	gfœ¡
 = 
cur_šdex
;

2373 
	gıu_vec
[
i
].
	g£cÚd
 = 
cur_šdex
 + 
sizes
[i];

2374 
	gcur_šdex
 +ğ
sizes
[
i
];

2375 
št32
 
	gj
 = 
ıu_vec
[
i
].
fœ¡
; j < 
	gıu_vec
[i].
	g£cÚd
; j++)

2376 
	g»v”£_ıu_vec
.
push_back
(
i
);

2378 
	gthis
->
	gšdexes_
 = 
ıu_vec
;

2379 
	gthis
->
	g»v”£_šdexes_
 = 
»v”£_ıu_vec
;

2380 
	gthis
->
	gšput_dim_
 = 
cur_šdex
;

2381 
	gthis
->
	gouut_dim_
 = 
sizes
.
size
();

2384 
	gSumGroupCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

2385 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

2386 
	g¡d
::
veùÜ
<
št32
> 
sizes
;

2387 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("sizes", &
¬gs
, &
sizes
);

2389 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gsizes
.empty())

2390 
	gKALDI_ERR
 << "Invalid initializer for†ayer ofype "

2391 << 
Ty³
(è<< ": \"" << 
	gÜig_¬gs
 << "\"";

2392 
	gthis
->
In™
(
sizes
);

2395 
CompÚ’t
* 
	gSumGroupCompÚ’t
::
Cİy
() const {

2396 
SumGroupCompÚ’t
 *
ªs
 = 
Ãw
 SumGroupComponent();

2397 
	gªs
->
	gšdexes_
 = 
šdexes_
;

2398 
	gªs
->
	g»v”£_šdexes_
 = 
»v”£_šdexes_
;

2399 
	gªs
->
	gšput_dim_
 = 
šput_dim_
;

2400 
	gªs
->
	gouut_dim_
 = 
ouut_dim_
;

2401  
	gªs
;

2404 
	gSumGroupCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

2405 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<SumGroupComponent>", "<Sizes>");

2406 
	g¡d
::
veùÜ
<
št32
> 
sizes
;

2407 
R—dIÁeg”VeùÜ
(
is
, 
bš¬y
, &
sizes
);

2409 
	g¡d
::
¡ršg
 
tok’
;

2410 
R—dTok’
(
is
, 
bš¬y
, &
tok’
);

2411 ià(!(
	gtok’
 == "<SumGroupComponent>" ||

2412 
tok’
 == "</SumGroupComponent>")) {

2413 
KALDI_ERR
 << "Ex³ùed </SumGroupCompÚ’t>, gÙ " << 
tok’
;

2415 
	gthis
->
In™
(
sizes
);

2418 
	gSumGroupCompÚ’t
::
G‘Sizes
(
¡d
::
veùÜ
<
št32
> *
sizes
) const {

2419 
¡d
::
veùÜ
<
IÁ32Paœ
> 
šdexes
;

2420 
	gšdexes_
.
CİyToVec
(&
šdexes
);

2421 
	gsizes
->
»size
(
šdexes
.
size
());

2422 
size_t
 
	gi
 = 0; i < 
	gšdexes
.
size
(); i++) {

2423 (*
	gsizes
)[
i
] = 
šdexes
[i].
£cÚd
 - indexes[i].
fœ¡
;

2424 ià(
	gi
 =ğ0è{ 
KALDI_ASSERT
(
šdexes
[
i
].
fœ¡
 == 0); }

2425 { 
KALDI_ASSERT
(
šdexes
[
i
].
fœ¡
 =ğšdexes[i-1].
£cÚd
); }

2426 
KALDI_ASSERT
(
šdexes
[
i
].
£cÚd
 > indexes[i].
fœ¡
);

2427 (*
	gsizes
)[
i
] = 
šdexes
[i].
£cÚd
 - indexes[i].
fœ¡
;

2431 
	gSumGroupCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

2432 
Wr™eTok’
(
os
, 
bš¬y
, "<SumGroupComponent>");

2433 
Wr™eTok’
(
os
, 
bš¬y
, "<Sizes>");

2434 
	g¡d
::
veùÜ
<
št32
> 
sizes
;

2435 
	gthis
->
G‘Sizes
(&
sizes
);

2436 
Wr™eIÁeg”VeùÜ
(
os
, 
bš¬y
, 
sizes
);

2437 
Wr™eTok’
(
os
, 
bš¬y
, "</SumGroupComponent>");

2440 
	gSumGroupCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2441 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2442 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

2443 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

2444 
	gš_šfo
.
CheckSize
(
š
);

2445 
	gout_šfo
.
CheckSize
(*
out
);

2446 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

2448 
	gout
->
SumCŞumnRªges
(
š
, 
šdexes_
);

2451 
	gSumGroupCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2452 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2453 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

2454 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

2455 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

2456 
CompÚ’t
 *
to_upd©e
,

2457 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

2458 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), 
IÅutDim
());

2459 
	gš_d”iv
->
CİyCŞs
(
out_d”iv
, 
»v”£_šdexes_
);

2463 
	g¡d
::
¡ršg
 
S¶iûCompÚ’t
::
Info
() const {

2464 
¡d
::
¡ršg¡»am
 
¡»am
;

2465 
	g¡d
::
o¡ršg¡»am
 
os
;

2466 
	g¡d
::
cİy
(
cÚ‹xt_
.
begš
(), cÚ‹xt_.
’d
(),

2467 
¡d
::
o¡»am_™”©Ü
<
št32
>(
os
, " "));

2468 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ", cÚ‹xt=" << 
os
.
¡r
();

2469 ià(
	gcÚ¡_compÚ’t_dim_
 != 0)

2470 
¡»am
 << ", cÚ¡_compÚ’t_dim=" << 
cÚ¡_compÚ’t_dim_
;

2472  
	g¡»am
.
¡r
();

2475 
	gS¶iûCompÚ’t
::
In™
(
št32
 
šput_dim
, 
¡d
::
veùÜ
<št32> 
cÚ‹xt
,

2476 
št32
 
cÚ¡_compÚ’t_dim
) {

2477 
	gšput_dim_
 = 
šput_dim
;

2478 
	gcÚ¡_compÚ’t_dim_
 = 
cÚ¡_compÚ’t_dim
;

2479 
	gcÚ‹xt_
 = 
cÚ‹xt
;

2480 
KALDI_ASSERT
(
cÚ‹xt_
.
size
() > 0);

2481 
KALDI_ASSERT
(
šput_dim_
 > 0 && 
cÚ‹xt_
.
äÚt
(è<ğ0 && cÚ‹xt_.
back
() >= 0);

2482 
KALDI_ASSERT
(
IsSÜ‹dAndUniq
(
cÚ‹xt
));

2483 
KALDI_ASSERT
(
cÚ¡_compÚ’t_dim_
 >ğ0 && cÚ¡_compÚ’t_dim_ < 
šput_dim_
);

2488 
	gS¶iûCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

2489 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

2490 
št32
 
	gšput_dim
, 
	gËá_cÚ‹xt
, 
	gright_cÚ‹xt
;

2491 
	g¡d
::
veùÜ
 <
št32
> 
cÚ‹xt
;

2492 
boŞ
 
	gš_dim_ok
 = 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

2493 
boŞ
 
	gcÚ‹xt_ok
 = 
P¬£FromSŒšg
("cÚ‹xt", &
¬gs
, &
cÚ‹xt
);

2494 
boŞ
 
	gËá_right_cÚ‹xt_ok
 = 
P¬£FromSŒšg
("Ëá-cÚ‹xt", &
¬gs
,

2495 &
Ëá_cÚ‹xt
) &&

2496 
P¬£FromSŒšg
("right-cÚ‹xt", &
¬gs
,

2497 &
right_cÚ‹xt
);

2498 
št32
 
	gcÚ¡_compÚ’t_dim
 = 0;

2499 
P¬£FromSŒšg
("cÚ¡-compÚ’t-dim", &
¬gs
, &
cÚ¡_compÚ’t_dim
);

2501 ià(!(
	gš_dim_ok
 && (
	gcÚ‹xt_ok
 || 
	gËá_right_cÚ‹xt_ok
)) ||

2502 !
	g¬gs
.
em±y
(è|| 
	gšput_dim
 <= 0)

2503 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

2504 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

2505 ià(
	gËá_right_cÚ‹xt_ok
) {

2506 
KALDI_ASSERT
(
cÚ‹xt
.
size
() == 0);

2507 
št32
 
	gi
 = -
Ëá_cÚ‹xt
; i <ğ
right_cÚ‹xt
; i++)

2508 
	gcÚ‹xt
.
push_back
(
i
);

2510 
In™
(
šput_dim
, 
cÚ‹xt
, 
cÚ¡_compÚ’t_dim
);

2513 
št32
 
	gS¶iûCompÚ’t
::
OuutDim
() const {

2514  (
šput_dim_
 - 
cÚ¡_compÚ’t_dim_
)

2515 * (
cÚ‹xt_
.
size
())

2516 + 
cÚ¡_compÚ’t_dim_
;

2519 
št32
 
	gChunkInfo
::
G‘Index
(št32 
off£t
) const {

2520 ià(
off£ts_
.
em±y
()) {

2521 
KALDI_ASSERT
((
off£t
 <ğ
Ï¡_off£t_
è&& (off£ˆ>ğ
fœ¡_off£t_
));

2522  
	goff£t
 - 
	gfœ¡_off£t_
;

2524 
	g¡d
::
veùÜ
<
št32
>::
cÚ¡_™”©Ü
 
™”
 =

2525 
¡d
::
low”_bound
(
off£ts_
.
begš
(), off£ts_.
’d
(), 
off£t
);

2527 
KALDI_ASSERT
(
™”
 !ğ
off£ts_
.
’d
(è&& *™” =ğ
off£t
);

2528  
	g¡©ic_ÿ¡
<
	gšt32
>(
	g™”
 - 
	goff£ts_
.
begš
());

2532 
št32
 
	gChunkInfo
::
G‘Off£t
(št32 
šdex
) const {

2533 ià(
off£ts_
.
em±y
()) {

2534 
št32
 
off£t
 = 
šdex
 + 
fœ¡_off£t_
;

2535 
KALDI_ASSERT
((
off£t
 <ğ
Ï¡_off£t_
è&& (off£ˆ>ğ
fœ¡_off£t_
));

2536  
	goff£t
;

2538 
KALDI_ASSERT
((
šdex
 >ğ0è&& (šdex < 
off£ts_
.
size
()));

2539  
	goff£ts_
[
šdex
];

2543 
	gChunkInfo
::
Check
() const {

2545 
KALDI_ASSERT
((
ã©_dim_
 > 0è&& (
num_chunks_
 > 0));

2547 ià(! 
	goff£ts_
.
em±y
()) {

2548 
KALDI_ASSERT
((
fœ¡_off£t_
 =ğ
off£ts_
.
äÚt
()) &&

2549 (
Ï¡_off£t_
 =ğ
off£ts_
.
back
()));

2551 
KALDI_ASSERT
((
fœ¡_off£t_
 >ğ0è&& (
Ï¡_off£t_
 >= first_offset_));

2553 
KALDI_ASSERT
 ( 
Ï¡_off£t_
 - 
fœ¡_off£t_
 + 1 > 
off£ts_
.
size
() );

2555 
KALDI_ASSERT
(
NumRows
(è% 
num_chunks_
 == 0);

2559 
	gChunkInfo
::
CheckSize
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
m©
) const {

2560 
KALDI_ASSERT
((
m©
.
NumRows
(è=ğNumRows()è&& (m©.
NumCŞs
() == NumCols()));

2577 
	gS¶iûCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2578 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2579 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

2580 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

2583 
	gš_šfo
.
Check
();

2584 
	gout_šfo
.
Check
();

2585 
	gš_šfo
.
CheckSize
(
š
);

2586 
	gout_šfo
.
CheckSize
(*
out
);

2587 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

2589 
št32
 
	gš_chunk_size
 = 
š_šfo
.
ChunkSize
(),

2590 
	gout_chunk_size
 = 
out_šfo
.
ChunkSize
(),

2591 
	gšput_dim
 = 
š_šfo
.
NumCŞs
();

2593 ià(
	gout_chunk_size
 <= 0)

2594 
KALDI_ERR
 << "Splicing features: output will have zero dimension. "

2599 
št32
 
	gnum_¥liû
 = 
cÚ‹xt_
.
size
();

2600 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
št32
> > 
šdexes
(
num_¥liû
);

2601 
št32
 
	gc
 = 0; c < 
	gnum_¥liû
; c++)

2602 
	gšdexes
[
c
].
»size
(
out
->
NumRows
());

2606 
št32
 
	gcÚ¡_dim
 = 
cÚ¡_compÚ’t_dim_
;

2607 
	g¡d
::
veùÜ
<
št32
> 
cÚ¡_šdexes
(
cÚ¡_dim
 =ğ0 ? 0 : 
out
->
NumRows
());

2609 
št32
 
	gchunk
 = 0; chunk < 
	gš_šfo
.
NumChunks
(); chunk++) {

2610 ià(
	gchunk
 == 0) {

2613 
št32
 
c
 = 0; 
	gc
 < 
	gnum_¥liû
; c++) {

2614 
št32
 
	gout_šdex
 = 0; out_šdex < 
	gout_chunk_size
; out_index++) {

2615 
št32
 
	gout_off£t
 = 
out_šfo
.
G‘Off£t
(
out_šdex
);

2616 
št32
 
	gš_šdex
 = 
š_šfo
.
G‘Index
(
out_off£t
 + 
cÚ‹xt_
[
c
]);

2617 
	gšdexes
[
c
][
chunk
 * 
out_chunk_size
 + 
out_šdex
] =

2618 
chunk
 * 
š_chunk_size
 + 
š_šdex
;

2623 
št32
 
	gc
 = 0; c < 
	gnum_¥liû
; c++) {

2624 
št32
 
	gout_šdex
 = 0; out_šdex < 
	gout_chunk_size
; out_index++) {

2625 
št32
 
	gÏ¡_v®ue
 = 
šdexes
[
c
][(
chunk
-1è* 
out_chunk_size
 + 
out_šdex
];

2626 
	gšdexes
[
c
][
chunk
 * 
out_chunk_size
 + 
out_šdex
] =

2627 (
Ï¡_v®ue
 =ğ-1 ? -1 :†a¡_v®u+ 
š_chunk_size
);

2631 ià(
	gcÚ¡_dim
 != 0) {

2632 
št32
 
out_šdex
 = 0; 
	gout_šdex
 < 
	gout_chunk_size
; out_index++)

2633 
	gcÚ¡_šdexes
[
chunk
 * 
out_chunk_size
 + 
out_šdex
] =

2634 
chunk
 * 
š_chunk_size
 + 
out_šdex
;

2641 
št32
 
	gc
 = 0; c < 
	gnum_¥liû
; c++) {

2642 
št32
 
	gdim
 = 
šput_dim
 - 
cÚ¡_dim
;

2644 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_·¹
(
š
, 0, in.
NumRows
(),

2645 0, 
dim
),

2646 
out_·¹
(*
out
, 0, out->
NumRows
(),

2647 
c
 * 
dim
, dim);

2648 
	gCuA¼ay
<
	gšt32
> 
cu_šdexes
(
šdexes
[
c
]);

2649 
	gout_·¹
.
CİyRows
(
š_·¹
, 
cu_šdexes
);

2651 ià(
	gcÚ¡_dim
 != 0) {

2652 
CuSubM©rix
<
Ba£Flßt
> 
š_·¹
(
š
, 0, in.
NumRows
(),

2653 
š
.
NumCŞs
(è- 
cÚ¡_dim
, const_dim),

2654 
out_·¹
(*
out
, 0, out->
NumRows
(),

2655 
out
->
NumCŞs
(è- 
cÚ¡_dim
, const_dim);

2657 
	gCuA¼ay
<
	gšt32
> 
cu_cÚ¡_šdexes
(
cÚ¡_šdexes
);

2658 
	gout_·¹
.
CİyRows
(
š_·¹
, 
cu_cÚ¡_šdexes
);

2662 
	gS¶iûCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2663 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2664 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

2665 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

2666 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

2667 
CompÚ’t
 *
to_upd©e
,

2668 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

2669 
	gš_šfo
.
Check
();

2670 
	gout_šfo
.
Check
();

2671 
	gout_šfo
.
CheckSize
(
out_d”iv
);

2672 
	gš_d”iv
->
Resize
(
š_šfo
.
NumRows
(), in_šfo.
NumCŞs
(), 
kUndefšed
);

2673 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

2674 
št32
 
	gnum_chunks
 = 
š_šfo
.
NumChunks
();

2677 
št32
 
	gout_chunk_size
 = 
out_šfo
.
ChunkSize
(),

2678 
	gš_chunk_size
 = 
š_šfo
.
ChunkSize
(),

2679 
	gouut_dim
 = 
out_d”iv
.
NumCŞs
(),

2680 
	gšput_dim
 = 
IÅutDim
();

2682 
KALDI_ASSERT
(
OuutDim
(è=ğ
ouut_dim
);

2684 
št32
 
	gnum_¥liû
 = 
cÚ‹xt_
.
size
(),

2685 
	gcÚ¡_dim
 = 
cÚ¡_compÚ’t_dim_
;

2690 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
št32
> > 
šdexes
(
num_¥liû
);

2694 
	g¡d
::
veùÜ
<
št32
> 
cÚ¡_šdexes
(
cÚ¡_dim
 =ğ0 ? 0 : 
š_d”iv
->
NumRows
(), -1);

2696 
št32
 
	gc
 = 0; c < 
	gšdexes
.
size
(); c++)

2697 
	gšdexes
[
c
].
»size
(
š_d”iv
->
NumRows
(), -1);

2701 
št32
 
	gdim
 = 
šput_dim
 - 
cÚ¡_dim
;

2702 
št32
 
	gchunk
 = 0; chunk < 
	gnum_chunks
; chunk++) {

2703 ià(
	gchunk
 == 0) {

2705 
št32
 
c
 = 0; 
	gc
 < 
	gnum_¥liû
; c++) {

2706 
št32
 
	gout_šdex
 = 0; out_šdex < 
	gout_chunk_size
; out_index++) {

2707 
št32
 
	gout_off£t
 = 
out_šfo
.
G‘Off£t
(
out_šdex
);

2708 
št32
 
	gš_šdex
 = 
š_šfo
.
G‘Index
(
out_off£t
 + 
cÚ‹xt_
[
c
]);

2709 
	gšdexes
[
c
][
chunk
 * 
š_chunk_size
 + 
š_šdex
] =

2710 
chunk
 * 
out_chunk_size
 + 
out_šdex
;

2714 
št32
 
	gc
 = 0; c < 
	gnum_¥liû
; c++) {

2715 
št32
 
	gš_šdex
 = 0; in_šdex < 
	gš_chunk_size
; in_index++) {

2716 
št32
 
	gÏ¡_v®ue
 = 
šdexes
[
c
][(
chunk
-1è* 
š_chunk_size
 + 
š_šdex
];

2717 
	gšdexes
[
c
][
chunk
 * 
š_chunk_size
 + 
š_šdex
] =

2718 (
Ï¡_v®ue
 =ğ-1 ? -1 :†a¡_v®u+ 
out_chunk_size
);

2724 ià(
	gcÚ¡_dim
 != 0) {

2725 
št32
 
out_šdex
 = 0; 
	gout_šdex
 < 
	gout_chunk_size
; out_index++) {

2726 
	gcÚ¡_šdexes
[
chunk
 * 
š_chunk_size
 + 
out_šdex
] =

2727 
chunk
 * 
out_chunk_size
 + 
out_šdex
;

2732 
	gCuM©rix
<
	gBa£Flßt
> 
‹mp_m©
(
š_d”iv
->
NumRows
(), 
dim
, 
kUndefšed
);

2734 
št32
 
	gc
 = 0; c < 
	gnum_¥liû
; c++) {

2735 
	gCuA¼ay
<
	gšt32
> 
cu_šdexes
(
šdexes
[
c
]);

2736 
št32
 
	gdim
 = 
šput_dim
 - 
cÚ¡_dim
;

2738 
	gCuSubM©rix
<
	gBa£Flßt
> 
out_d”iv_·¹
(
out_d”iv
, 0, out_d”iv.
NumRows
(),

2739 
c
 * 
dim
, dim),

2740 
š_d”iv_·¹
(*
š_d”iv
, 0, in_d”iv->
NumRows
(),

2741 0, 
dim
);

2742 ià(
	gc
 == 0) {

2743 
š_d”iv_·¹
.
CİyRows
(
out_d”iv_·¹
, 
cu_šdexes
);

2745 
	g‹mp_m©
.
CİyRows
(
out_d”iv_·¹
, 
cu_šdexes
);

2746 
	gš_d”iv_·¹
.
AddM©
(1.0, 
‹mp_m©
);

2749 ià(
	gcÚ¡_dim
 != 0) {

2750 
CuSubM©rix
<
Ba£Flßt
> 
out_d”iv_·¹
(
out_d”iv
, 0, out_d”iv.
NumRows
(),

2751 
out_d”iv
.
NumCŞs
(è- 
cÚ¡_dim
,

2752 
cÚ¡_dim
),

2753 
š_d”iv_·¹
(*
š_d”iv
, 0, in_d”iv->
NumRows
(),

2754 
š_d”iv
->
NumCŞs
(è- 
cÚ¡_dim
, const_dim);

2755 
	gCuA¼ay
<
	gšt32
> 
cu_cÚ¡_šdexes
(
cÚ¡_šdexes
);

2756 
	gš_d”iv_·¹
.
CİyRows
(
out_d”iv_·¹
, 
cu_cÚ¡_šdexes
);

2760 
CompÚ’t
 *
	gS¶iûCompÚ’t
::
Cİy
() const {

2761 
S¶iûCompÚ’t
 *
ªs
 = 
Ãw
 SpliceComponent();

2762 
	gªs
->
	gšput_dim_
 = 
šput_dim_
;

2763 
	gªs
->
	gcÚ‹xt_
 = 
cÚ‹xt_
;

2764 
	gªs
->
	gcÚ¡_compÚ’t_dim_
 = 
cÚ¡_compÚ’t_dim_
;

2765  
	gªs
;

2768 
	gS¶iûCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

2769 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<SpliceComponent>", "<InputDim>");

2770 
R—dBasicTy³
(
is
, 
bš¬y
, &
šput_dim_
);

2771 
	g¡d
::
¡ršg
 
tok’
;

2772 
R—dTok’
(
is
, 
çl£
, &
tok’
);

2773 ià(
	gtok’
 == "<LeftContext>") {

2774 
št32
 
Ëá_cÚ‹xt
=0, 
	gright_cÚ‹xt
=0;

2775 
	g¡d
::
veùÜ
<
št32
> 
cÚ‹xt
;

2776 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ëá_cÚ‹xt
);

2777 
Ex³ùTok’
(
is
, 
bš¬y
, "<RightContext>");

2778 
R—dBasicTy³
(
is
, 
bš¬y
, &
right_cÚ‹xt
);

2779 
št32
 
	gi
 = -1 * 
Ëá_cÚ‹xt
; i <ğ
right_cÚ‹xt
; i++)

2780 
	gcÚ‹xt
.
push_back
(
i
);

2781 
	gcÚ‹xt_
 = 
cÚ‹xt
;

2782 } ià(
	gtok’
 == "<Context>") {

2783 
R—dIÁeg”VeùÜ
(
is
, 
bš¬y
, &
cÚ‹xt_
);

2785 
	gKALDI_ERR
 << "UnknowÀtok’" << 
	gtok’


2788 
Ex³ùTok’
(
is
, 
bš¬y
, "<ConstComponentDim>");

2789 
R—dBasicTy³
(
is
, 
bš¬y
, &
cÚ¡_compÚ’t_dim_
);

2790 
Ex³ùTok’
(
is
, 
bš¬y
, "</SpliceComponent>");

2793 
	gS¶iûCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

2794 
Wr™eTok’
(
os
, 
bš¬y
, "<SpliceComponent>");

2795 
Wr™eTok’
(
os
, 
bš¬y
, "<InputDim>");

2796 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
šput_dim_
);

2797 
Wr™eTok’
(
os
, 
bš¬y
, "<Context>");

2798 
Wr™eIÁeg”VeùÜ
(
os
, 
bš¬y
, 
cÚ‹xt_
);

2799 
Wr™eTok’
(
os
, 
bš¬y
, "<ConstComponentDim>");

2800 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
cÚ¡_compÚ’t_dim_
);

2801 
Wr™eTok’
(
os
, 
bš¬y
, "</SpliceComponent>");

2805 
	g¡d
::
¡ršg
 
S¶iûMaxCompÚ’t
::
Info
() const {

2806 
¡d
::
¡ršg¡»am
 
¡»am
;

2807 
	g¡d
::
o¡ršg¡»am
 
os
;

2808 
	g¡d
::
cİy
(
cÚ‹xt_
.
begš
(), cÚ‹xt_.
’d
(),

2809 
¡d
::
o¡»am_™”©Ü
<
št32
>(
os
, " "));

2810 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ", cÚ‹xt=" << 
os
.
¡r
();

2811  
	g¡»am
.
¡r
();

2814 
	gS¶iûMaxCompÚ’t
::
In™
(
št32
 
dim
,

2815 
¡d
::
veùÜ
<
št32
> 
cÚ‹xt
) {

2816 
dim_
 = 
dim
;

2817 
	gcÚ‹xt_
 = 
cÚ‹xt
;

2818 
KALDI_ASSERT
(
dim_
 > 0 && 
cÚ‹xt_
.
äÚt
(è<ğ0 && cÚ‹xt_.
back
() >= 0);

2823 
	gS¶iûMaxCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

2824 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

2825 
št32
 
	gdim
, 
	gËá_cÚ‹xt
, 
	gright_cÚ‹xt
;

2826 
	g¡d
::
veùÜ
 <
št32
> 
cÚ‹xt
;

2827 
boŞ
 
	gdim_ok
 = 
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
);

2828 
boŞ
 
	gcÚ‹xt_ok
 = 
P¬£FromSŒšg
("cÚ‹xt", &
¬gs
, &
cÚ‹xt
);

2829 
boŞ
 
	gËá_right_cÚ‹xt_ok
 = 
P¬£FromSŒšg
("left-context",

2830 &
¬gs
, &
Ëá_cÚ‹xt
) &&

2831 
P¬£FromSŒšg
("right-cÚ‹xt", &
¬gs
,

2832 &
right_cÚ‹xt
);

2834 ià(!(
	gdim_ok
 && (
	gcÚ‹xt_ok
 || 
	gËá_right_cÚ‹xt_ok
)) ||

2835 !
	g¬gs
.
em±y
(è|| 
	gdim
 <= 0)

2836 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

2837 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

2838 ià(
	gËá_right_cÚ‹xt_ok
) {

2839 
KALDI_ASSERT
(
cÚ‹xt
.
size
() == 0);

2840 
št32
 
	gi
 = -1 * 
Ëá_cÚ‹xt
; i <ğ
right_cÚ‹xt
; i++)

2841 
	gcÚ‹xt
.
push_back
(
i
);

2843 
In™
(
dim
, 
cÚ‹xt
);

2847 
	gS¶iûMaxCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2848 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2849 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

2850 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

2851 
	gš_šfo
.
Check
();

2852 
	gout_šfo
.
Check
();

2853 
	gš_šfo
.
CheckSize
(
š
);

2854 
	gout_šfo
.
CheckSize
(*
out
);

2855 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

2856 
št32
 
	gš_chunk_size
 = 
š_šfo
.
ChunkSize
(),

2857 
	gout_chunk_size
 = 
out_šfo
.
ChunkSize
(),

2858 
	gdim
 = 
š_šfo
.
NumCŞs
();

2860 
	gCuM©rix
<
	gBa£Flßt
> 
šput_chunk_·¹
(
out_chunk_size
, 
dim
);

2861 
št32
 
	gchunk
 = 0; chunk < 
	gš_šfo
.
NumChunks
(); chunk++) {

2862 
	gCuSubM©rix
<
	gBa£Flßt
> 
šput_chunk
(
š
,

2863 
chunk
 * 
š_chunk_size
, in_chunk_size,

2864 0, 
dim
),

2865 
ouut_chunk
(*
out
,

2866 
chunk
 * 
out_chunk_size
,

2867 
out_chunk_size
, 0, 
dim
);

2868 
št32
 
	goff£t
 = 0; off£ˆ< 
	gcÚ‹xt_
.
size
(); offset++) {

2872 
	g¡d
::
veùÜ
<
št32
> 
šput_chunk_šds
(
out_chunk_size
);

2873 
št32
 
	gi
 = 0; i < 
	gout_chunk_size
; i++) {

2874 
št32
 
	gout_chunk_šd
 = 
i
;

2875 
št32
 
	gout_chunk_off£t
 =

2876 
out_šfo
.
G‘Off£t
(
out_chunk_šd
);

2877 
	gšput_chunk_šds
[
i
] =

2878 
š_šfo
.
G‘Index
(
out_chunk_off£t
 + 
cÚ‹xt_
[
off£t
]);

2880 
	gCuA¼ay
<
	gšt32
> 
cu_chunk_šds
(
šput_chunk_šds
);

2881 
	gšput_chunk_·¹
.
CİyRows
(
šput_chunk
, 
cu_chunk_šds
);

2882 ià(
	goff£t
 == 0) {

2883 
ouut_chunk
.
CİyFromM©
(
šput_chunk_·¹
);

2885 
	gouut_chunk
.
Max
(
šput_chunk_·¹
);

2891 
	gS¶iûMaxCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

2892 cÚ¡ 
ChunkInfo
 &
out_šfo
,

2893 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

2894 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

2895 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

2896 
CompÚ’t
 *
to_upd©e
,

2897 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

2898 
	gš_šfo
.
Check
();

2899 
	gout_šfo
.
Check
();

2900 
	gš_šfo
.
CheckSize
(
š_v®ue
);

2901 
	gout_šfo
.
CheckSize
(
out_d”iv
);

2902 
	gš_d”iv
->
Resize
(
š_šfo
.
NumRows
(), in_šfo.
NumCŞs
());

2903 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

2905 
št32
 
	gout_chunk_size
 = 
out_šfo
.
ChunkSize
(),

2906 
	gš_chunk_size
 = 
š_šfo
.
ChunkSize
(),

2907 
	gdim
 = 
out_d”iv
.
NumCŞs
();

2909 
KALDI_ASSERT
(
dim
 =ğ
IÅutDim
());

2911 
št32
 
	gchunk
 = 0; chunk < 
	gš_šfo
.
NumChunks
(); chunk++) {

2912 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_d”iv_chunk
(*
š_d”iv
,

2913 
chunk
 * 
š_chunk_size
,

2914 
š_chunk_size
,

2915 0, 
dim
),

2916 
š_v®ue_chunk
(
š_v®ue
,

2917 
chunk
 * 
š_chunk_size
,

2918 
š_chunk_size
,

2919 0, 
dim
),

2920 
out_d”iv_chunk
(
out_d”iv
,

2921 
chunk
 * 
out_chunk_size
,

2922 
out_chunk_size
,

2923 0, 
dim
);

2924 
št32
 
	gr
 = 0;„ < 
	gout_d”iv_chunk
.
NumRows
();„++) {

2925 
št32
 
	gout_chunk_šd
 = 
r
;

2926 
št32
 
	gout_chunk_off£t
 =

2927 
out_šfo
.
G‘Off£t
(
out_chunk_šd
);

2929 
št32
 
	gc
 = 0; c < 
	gdim
; c++) {

2930 
št32
 
	gš_r_max
 = -1;

2931 
Ba£Flßt
 
	gmax_šput
 = -
¡d
::
num”ic_lim™s
<Ba£Flßt>::
šfš™y
();

2932 
št32
 
	gcÚ‹xt_šd
 = 0;

2933 
	gcÚ‹xt_šd
 < 
	gcÚ‹xt_
.
size
(); context_ind++) {

2934 
št32
 
	gš_r
 =

2935 
š_šfo
.
G‘Index
(
out_chunk_off£t
 + 
cÚ‹xt_
[
cÚ‹xt_šd
]);

2936 
Ba£Flßt
 
	gšput
 = 
š_v®ue_chunk
(
š_r
, 
c
);

2937 ià(
	gšput
 > 
	gmax_šput
) {

2938 
	gmax_šput
 = 
šput
;

2939 
	gš_r_max
 = 
š_r
;

2942 
KALDI_ASSERT
(
š_r_max
 != -1);

2943 (*
	gš_d”iv
)(
	gš_r_max
, 
	gc
è+ğ
out_d”iv_chunk
(
r
, 
c
);

2949 
CompÚ’t
 *
	gS¶iûMaxCompÚ’t
::
Cİy
() const {

2950 
S¶iûMaxCompÚ’t
 *
ªs
 = 
Ãw
 SpliceMaxComponent();

2951 
	gªs
->
In™
(
dim_
, 
cÚ‹xt_
);

2952  
	gªs
;

2955 
	gS¶iûMaxCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

2956 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<SpliceMaxComponent>", "<Dim>");

2957 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

2958 
	g¡d
::
¡ršg
 
tok’
;

2959 
R—dTok’
(
is
, 
çl£
, &
tok’
);

2960 ià(
	gtok’
 == "<LeftContext>") {

2961 
št32
 
Ëá_cÚ‹xt
 = 0, 
	gright_cÚ‹xt
 = 0;

2962 
	g¡d
::
veùÜ
<
št32
> 
cÚ‹xt
;

2963 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ëá_cÚ‹xt
);

2964 
Ex³ùTok’
(
is
, 
bš¬y
, "<RightContext>");

2965 
R—dBasicTy³
(
is
, 
bš¬y
, &
right_cÚ‹xt
);

2966 
št32
 
	gi
 = -1 * 
Ëá_cÚ‹xt
; i <ğ
right_cÚ‹xt
; i++)

2967 
	gcÚ‹xt
.
push_back
(
i
);

2968 
	gcÚ‹xt_
 = 
cÚ‹xt
;

2969 } ià(
	gtok’
 == "<Context>") {

2970 
R—dIÁeg”VeùÜ
(
is
, 
bš¬y
, &
cÚ‹xt_
);

2972 
	gKALDI_ERR
 << "UnknowÀtok’" << 
	gtok’
 << ",he model might be corrupted";

2974 
Ex³ùTok’
(
is
, 
bš¬y
, "</SpliceMaxComponent>");

2977 
	gS¶iûMaxCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

2978 
Wr™eTok’
(
os
, 
bš¬y
, "<SpliceMaxComponent>");

2979 
Wr™eTok’
(
os
, 
bš¬y
, "<Dim>");

2980 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

2981 
Wr™eTok’
(
os
, 
bš¬y
, "<Context>");

2982 
Wr™eIÁeg”VeùÜ
(
os
, 
bš¬y
, 
cÚ‹xt_
);

2983 
Wr™eTok’
(
os
, 
bš¬y
, "</SpliceMaxComponent>");

2986 
	g¡d
::
¡ršg
 
DùCompÚ’t
::
Info
() const {

2987 
¡d
::
¡ršg¡»am
 
¡»am
;

2988 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ", dù_dim=" << 
dù_m©_
.
NumCŞs
();

2989 ià(
	gdù_m©_
.
NumCŞs
(è!ğ
dù_m©_
.
NumRows
())

2990 
¡»am
 << ", dù_k“p_dim=" << 
dù_m©_
.
NumRows
();

2992  
	g¡»am
.
¡r
();

2995 
	gDùCompÚ’t
::
In™
(
št32
 
dim
, iÁ32 
dù_dim
, 
boŞ
 
»Üd”
, iÁ32 
dù_k“p_dim
) {

2996 
	gdù_k“p_dim_
 = (
dù_k“p_dim
 > 0è? dù_k“p_dim : 
dù_dim
;

2998 
KALDI_ASSERT
(
dim
 > 0 && 
dù_dim
 > 0);

2999 
KALDI_ASSERT
(
dim
 % 
dù_dim
 == 0);

3000 
KALDI_ASSERT
(
dù_dim
 >ğ
dù_k“p_dim_
);

3001 
	gdim_
 = 
dim
;

3002 
	gdù_m©_
.
Resize
(
dù_k“p_dim_
, 
dù_dim
);

3003 
	g»Üd”_
 = 
»Üd”
;

3004 
	gM©rix
<
	gBa£Flßt
> 
dù_m©
(
dù_k“p_dim_
, 
dù_dim
);

3005 
Compu‹DùM©rix
(&
dù_m©
);

3006 
	gdù_m©_
 = 
dù_m©
;

3011 
	gDùCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3012 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

3013 
št32
 
	gdim
, 
	gdù_dim
, 
	gdù_k“p_dim
 = 0;

3014 
boŞ
 
	g»Üd”
 = 
çl£
;

3016 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
);

3017 
	gok
 = 
P¬£FromSŒšg
("dù-dim", &
¬gs
, &
dù_dim
) && ok;

3018 
	gok
 = 
P¬£FromSŒšg
("»Üd”", &
¬gs
, &
»Üd”
) && ok;

3019 
P¬£FromSŒšg
("dù-k“p-dim", &
¬gs
, &
dù_k“p_dim
);

3021 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gdim
 <ğ0 || 
dù_dim
 <ğ0 || 
dù_k“p_dim
 < 0)

3022 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

3023 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

3024 
In™
(
dim
, 
dù_dim
, 
»Üd”
, 
dù_k“p_dim
);

3027 
	gDùCompÚ’t
::
ReÜd”
(
CuM©rixBa£
<
Ba£Flßt
> *
m©
, 
boŞ
 
»v”£
) const {

3031 
št32
 
	gdù_dim
 = 
dù_m©_
.
NumCŞs
(),

3032 
	gdù_k“p_dim
 = 
dù_m©_
.
NumRows
(),

3033 
	gblock_size_š
 = 
dim_
 / 
dù_dim
,

3034 
	gblock_size_out
 = 
dù_k“p_dim
;

3038 ià(
	g»v”£
è
	g¡d
::
sw­
(
block_size_š
, 
block_size_out
);

3040 
	gCuVeùÜ
<
	gBa£Flßt
> 
‹mp
(
m©
->
NumCŞs
());

3041 
št32
 
	gi
 = 0; i < 
	gm©
->
NumRows
(); i++) {

3042 
	gCuSubVeùÜ
<
	gBa£Flßt
> 
row
(*
m©
, 
i
);

3043 
št32
 
	gnum_blocks_š
 = 
block_size_out
;

3044 
št32
 
	gb
 = 0; b < 
	gnum_blocks_š
; b++) {

3045 
št32
 
	gj
 = 0; j < 
	gblock_size_š
; j++) {

3046 
‹mp
(
j
 * 
block_size_out
 + 
b
èğ
row
(b * 
block_size_š
 + j);

3049 
	grow
.
CİyFromVec
(
‹mp
);

3053 
	gDùCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3054 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3055 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3056 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3057 
KALDI_ASSERT
(
š
.
NumCŞs
(è=ğ
IÅutDim
());

3058 
št32
 
	gdù_dim
 = 
dù_m©_
.
NumCŞs
(),

3059 
	gdù_k“p_dim
 = 
dù_m©_
.
NumRows
(),

3060 
	gnum_rows
 = 
š
.
NumRows
(),

3061 
	gnum_chunks
 = 
dim_
 / 
dù_dim
;

3063 
	gš_šfo
.
CheckSize
(
š
);

3064 
	gout_šfo
.
CheckSize
(*
out
);

3065 
KALDI_ASSERT
(
num_rows
 =ğ
out_šfo
.
NumRows
());

3066 
KALDI_ASSERT
(
num_chunks
 * 
dù_k“p_dim
 =ğ
out_šfo
.
NumCŞs
());

3068 
	gCuM©rix
<
	gBa£Flßt
> 
	gš_tmp
;

3069 ià(
	g»Üd”_
) {

3070 
	gš_tmp
 = 
š
;

3071 
ReÜd”
(&
š_tmp
, 
çl£
);

3074 
št32
 
	gchunk
 = 0; chunk < 
	gnum_chunks
; chunk++) {

3075 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_m©
(
»Üd”_
 ? 
š_tmp
 : 
š
,

3076 0, 
num_rows
, 
dù_dim
 * 
chunk
, dct_dim),

3077 
out_m©
(*
out
,

3078 0, 
num_rows
, 
dù_k“p_dim
 * 
chunk
, dct_keep_dim);

3080 
	gout_m©
.
AddM©M©
(1.0, 
š_m©
, 
kNoT¿ns
, 
dù_m©_
, 
kT¿ns
, 0.0);

3082 ià(
	g»Üd”_
)

3083 
ReÜd”
(
out
, 
Œue
);

3086 
	gDùCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

3087 cÚ¡ 
ChunkInfo
 &,

3088 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3089 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3090 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3091 
CompÚ’t
 *,

3092 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3093 
KALDI_ASSERT
(
out_d”iv
.
NumCŞs
(è=ğ
OuutDim
());

3095 
št32
 
	gdù_dim
 = 
dù_m©_
.
NumCŞs
(),

3096 
	gdù_k“p_dim
 = 
dù_m©_
.
NumRows
(),

3097 
	gnum_chunks
 = 
dim_
 / 
dù_dim
,

3098 
	gnum_rows
 = 
out_d”iv
.
NumRows
();

3100 
	gš_d”iv
->
Resize
(
num_rows
, 
dim_
);

3102 
	gCuM©rix
<
	gBa£Flßt
> 
	gout_d”iv_tmp
;

3103 ià(
	g»Üd”_
) {

3104 
	gout_d”iv_tmp
 = 
out_d”iv
;

3105 
ReÜd”
(&
out_d”iv_tmp
, 
çl£
);

3107 
št32
 
	gchunk
 = 0; chunk < 
	gnum_chunks
; chunk++) {

3108 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_d”iv_m©
(*
š_d”iv
,

3109 0, 
num_rows
, 
dù_dim
 * 
chunk
, dct_dim),

3110 
out_d”iv_m©
(
»Üd”_
 ? 
out_d”iv_tmp
 : 
out_d”iv
,

3111 0, 
num_rows
, 
dù_k“p_dim
 * 
chunk
, dct_keep_dim);

3117 
	gš_d”iv_m©
.
AddM©M©
(1.0, 
out_d”iv_m©
, 
kNoT¿ns
,

3118 
dù_m©_
, 
kNoT¿ns
, 0.0);

3120 ià(
	g»Üd”_
)

3121 
ReÜd”
(
š_d”iv
, 
Œue
);

3124 
CompÚ’t
* 
	gDùCompÚ’t
::
Cİy
() const {

3125 
DùCompÚ’t
 *
ªs
 = 
Ãw
 DctComponent();

3126 
	gªs
->
	gdù_m©_
 = 
dù_m©_
;

3127 
	gªs
->
	gdim_
 = 
dim_
;

3128 
	gªs
->
	g»Üd”_
 = 
»Üd”_
;

3129  
	gªs
;

3132 
	gDùCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3133 
Wr™eTok’
(
os
, 
bš¬y
, "<DctComponent>");

3134 
Wr™eTok’
(
os
, 
bš¬y
, "<Dim>");

3135 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

3136 
Wr™eTok’
(
os
, 
bš¬y
, "<DctDim>");

3137 
št32
 
	gdù_dim
 = 
dù_m©_
.
NumCŞs
();

3138 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dù_dim
);

3139 
Wr™eTok’
(
os
, 
bš¬y
, "<Reorder>");

3140 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
»Üd”_
);

3141 
Wr™eTok’
(
os
, 
bš¬y
, "<DctKeepDim>");

3142 
št32
 
	gdù_k“p_dim
 = 
dù_m©_
.
NumRows
();

3143 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dù_k“p_dim
);

3144 
Wr™eTok’
(
os
, 
bš¬y
, "</DctComponent>");

3147 
	gDùCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3148 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<DctComponent>", "<Dim>");

3149 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

3151 
Ex³ùTok’
(
is
, 
bš¬y
, "<DctDim>");

3152 
št32
 
	gdù_dim
;

3153 
R—dBasicTy³
(
is
, 
bš¬y
, &
dù_dim
);

3155 
Ex³ùTok’
(
is
, 
bš¬y
, "<Reorder>");

3156 
R—dBasicTy³
(
is
, 
bš¬y
, &
»Üd”_
);

3158 
št32
 
	gdù_k“p_dim
 = 
dù_dim
;

3159 
	g¡d
::
¡ršg
 
tok’
;

3160 
R—dTok’
(
is
, 
bš¬y
, &
tok’
);

3161 ià(
	gtok’
 == "<DctKeepDim>") {

3162 
R—dBasicTy³
(
is
, 
bš¬y
, &
dù_k“p_dim
);

3163 
Ex³ùTok’
(
is
, 
bš¬y
, "</DctComponent>");

3164 } ià(
	gtok’
 != "</DctComponent>") {

3165 
KALDI_ERR
 << "Expectedoken \"</DctComponent>\", got instead \""

3166 << 
tok’
 << "\".";

3169 
KALDI_ASSERT
(
dù_dim
 > 0 && 
dim_
 > 0 && dim_ % dct_dim == 0);

3170 
In™
(
dim_
, 
dù_dim
, 
»Üd”_
, 
dù_k“p_dim
);

3175 
	gFixedLš—rCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3176 
¡d
::
¡ršg
 
Üig_¬gs
 = 
¬gs
;

3177 
	g¡d
::
¡ršg
 
f’ame
;

3178 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("m©rix", &
¬gs
, &
f’ame
);

3180 ià(!
	gok
 || !
	g¬gs
.
em±y
())

3181 
	gKALDI_ERR
 << "Invalid initializer for†ayer ofype "

3182 << 
Ty³
(è<< ": \"" << 
	gÜig_¬gs
 << "\"";

3184 
boŞ
 
	gbš¬y
;

3185 
IÅut
 
ki
(
f’ame
, &
bš¬y
);

3186 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©
;

3187 
	gm©
.
R—d
(
ki
.
SŒ—m
(), 
bš¬y
);

3188 
KALDI_ASSERT
(
m©
.
NumRows
() != 0);

3189 
In™
(
m©
);

3193 
	g¡d
::
¡ršg
 
FixedLš—rCompÚ’t
::
Info
() const {

3194 
¡d
::
¡ršg¡»am
 
¡»am
;

3195 
Ba£Flßt
 
	gm©_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
m©_
.
NumRows
())

3196 * 
¡©ic_ÿ¡
<
Ba£Flßt
>(
m©_
.
NumCŞs
()),

3197 
	gm©_¡ddev
 = 
¡d
::
sq¹
(
T¿ûM©M©
(
m©_
, m©_, 
kT¿ns
) /

3198 
m©_size
);

3199 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ",…¬ams-¡ddev=" << 
m©_¡ddev
;

3200  
	g¡»am
.
¡r
();

3203 
	gFixedLš—rCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3204 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3205 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3206 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3207 
	gš_šfo
.
CheckSize
(
š
);

3208 
	gout_šfo
.
CheckSize
(*
out
);

3209 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

3211 
	gout
->
AddM©M©
(1.0, 
š
, 
kNoT¿ns
, 
m©_
, 
kT¿ns
, 0.0);

3214 
	gFixedLš—rCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

3215 cÚ¡ 
ChunkInfo
 &,

3216 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3217 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3218 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3219 
CompÚ’t
 *,

3220 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3221 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), 
m©_
.
NumCŞs
());

3222 
	gš_d”iv
->
AddM©M©
(1.0, 
out_d”iv
, 
kNoT¿ns
, 
m©_
, kNoTrans, 0.0);

3225 
CompÚ’t
* 
	gFixedLš—rCompÚ’t
::
Cİy
() const {

3226 
FixedLš—rCompÚ’t
 *
ªs
 = 
Ãw
 FixedLinearComponent();

3227 
	gªs
->
In™
(
m©_
);

3228  
	gªs
;

3232 
	gFixedLš—rCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3233 
Wr™eTok’
(
os
, 
bš¬y
, "<FixedLinearComponent>");

3234 
Wr™eTok’
(
os
, 
bš¬y
, "<CuMatrix>");

3235 
	gm©_
.
Wr™e
(
os
, 
bš¬y
);

3236 
Wr™eTok’
(
os
, 
bš¬y
, "</FixedLinearComponent>");

3239 
	gFixedLš—rCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3240 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<FixedLinearComponent>", "<CuMatrix>");

3241 
	gm©_
.
R—d
(
is
, 
bš¬y
);

3242 
Ex³ùTok’
(
is
, 
bš¬y
, "</FixedLinearComponent>");

3245 
	gFixedAffšeCompÚ’t
::
In™
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
m©
) {

3246 
KALDI_ASSERT
(
m©
.
NumCŞs
() > 1);

3247 
	glš—r_·¿ms_
 = 
m©
.
Rªge
(0, m©.
NumRows
(),

3248 0, 
m©
.
NumCŞs
() - 1);

3249 
	gbŸs_·¿ms_
.
Resize
(
m©
.
NumRows
());

3250 
	gbŸs_·¿ms_
.
CİyCŞFromM©
(
m©
, m©.
NumCŞs
() - 1);

3254 
	gFixedAffšeCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3255 
¡d
::
¡ršg
 
Üig_¬gs
 = 
¬gs
;

3256 
	g¡d
::
¡ršg
 
f’ame
;

3257 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("m©rix", &
¬gs
, &
f’ame
);

3259 ià(!
	gok
 || !
	g¬gs
.
em±y
())

3260 
	gKALDI_ERR
 << "Invalid initializer for†ayer ofype "

3261 << 
Ty³
(è<< ": \"" << 
	gÜig_¬gs
 << "\"";

3263 
boŞ
 
	gbš¬y
;

3264 
IÅut
 
ki
(
f’ame
, &
bš¬y
);

3265 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©
;

3266 
	gm©
.
R—d
(
ki
.
SŒ—m
(), 
bš¬y
);

3267 
KALDI_ASSERT
(
m©
.
NumRows
() != 0);

3268 
In™
(
m©
);

3272 
	g¡d
::
¡ršg
 
FixedAffšeCompÚ’t
::
Info
() const {

3273 
¡d
::
¡ršg¡»am
 
¡»am
;

3274 
Ba£Flßt
 
	glš—r_·¿ms_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
lš—r_·¿ms_
.
NumRows
())

3275 * 
¡©ic_ÿ¡
<
Ba£Flßt
>(
lš—r_·¿ms_
.
NumCŞs
()),

3276 
	glš—r_·¿ms_¡ddev
 =

3277 
¡d
::
sq¹
(
T¿ûM©M©
(
lš—r_·¿ms_
,

3278 
lš—r_·¿ms_
, 
kT¿ns
) /

3279 
lš—r_·¿ms_size
),

3280 
	gbŸs_·¿ms_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
bŸs_·¿ms_
, bias_params_) /

3281 
bŸs_·¿ms_
.
Dim
());

3283 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ",†š—r-·¿ms-¡ddev=" << 
lš—r_·¿ms_¡ddev


3284 << ", bŸs-·¿ms-¡ddev=" << 
bŸs_·¿ms_¡ddev
;

3285  
	g¡»am
.
¡r
();

3288 
	gFixedAffšeCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3289 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3290 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3291 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3292 
	gš_šfo
.
CheckSize
(
š
);

3293 
	gout_šfo
.
CheckSize
(*
out
);

3294 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

3296 
	gout
->
AddM©M©
(1.0, 
š
, 
kNoT¿ns
, 
lš—r_·¿ms_
, 
kT¿ns
, 0.0);

3297 
	gout
->
AddVecToRows
(1.0, 
bŸs_·¿ms_
);

3300 
	gFixedAffšeCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

3301 cÚ¡ 
ChunkInfo
 &,

3302 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3303 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3304 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3305 
CompÚ’t
 *,

3306 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3307 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), 
lš—r_·¿ms_
.
NumCŞs
());

3308 
	gš_d”iv
->
AddM©M©
(1.0, 
out_d”iv
, 
kNoT¿ns
, 
lš—r_·¿ms_
, kNoTrans, 0.0);

3311 
CompÚ’t
* 
	gFixedAffšeCompÚ’t
::
Cİy
() const {

3312 
FixedAffšeCompÚ’t
 *
ªs
 = 
Ãw
 FixedAffineComponent();

3313 
	gªs
->
	glš—r_·¿ms_
 = 
lš—r_·¿ms_
;

3314 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

3315  
	gªs
;

3319 
	gFixedAffšeCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3320 
Wr™eTok’
(
os
, 
bš¬y
, "<FixedAffineComponent>");

3321 
Wr™eTok’
(
os
, 
bš¬y
, "<LinearParams>");

3322 
	glš—r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

3323 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

3324 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

3325 
Wr™eTok’
(
os
, 
bš¬y
, "</FixedAffineComponent>");

3328 
	gFixedAffšeCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3329 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<FixedAffineComponent>", "<LinearParams>");

3330 
	glš—r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

3331 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

3332 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

3333 
Ex³ùTok’
(
is
, 
bš¬y
, "</FixedAffineComponent>");

3337 
	gFixedSÿËCompÚ’t
::
In™
(cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
sÿËs
) {

3338 
KALDI_ASSERT
(
sÿËs
.
Dim
() != 0);

3339 
	gsÿËs_
 = 
sÿËs
;

3342 
	gFixedSÿËCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3343 
¡d
::
¡ršg
 
Üig_¬gs
 = 
¬gs
;

3344 
	g¡d
::
¡ršg
 
f’ame
;

3345 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("sÿËs", &
¬gs
, &
f’ame
);

3347 ià(!
	gok
 || !
	g¬gs
.
em±y
())

3348 
	gKALDI_ERR
 << "Invalid initializer for†ayer ofype "

3349 << 
Ty³
(è<< ": \"" << 
	gÜig_¬gs
 << "\"";

3351 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gvec
;

3352 
R—dK®diObjeù
(
f’ame
, &
vec
);

3353 
In™
(
vec
);

3357 
	g¡d
::
¡ršg
 
FixedSÿËCompÚ’t
::
Info
() const {

3358 
¡d
::
¡ršg¡»am
 
¡»am
;

3359 
Ba£Flßt
 
	gsÿËs_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
sÿËs_
.
Dim
()),

3360 
	gsÿËs_m—n
 = 
sÿËs_
.
Sum
(è/ 
sÿËs_size
,

3361 
	gsÿËs_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
sÿËs_
, sÿËs_è/ 
sÿËs_size


3362 - (
sÿËs_m—n
 * scales_mean));

3363 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ", sÿËs-m—n=" << 
sÿËs_m—n


3364 << ", sÿËs-¡ddev=" << 
sÿËs_¡ddev
;

3365  
	g¡»am
.
¡r
();

3368 
	gFixedSÿËCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3369 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3370 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3371 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3372 
	gout
->
CİyFromM©
(
š
);

3373 
	gout
->
MulCŞsVec
(
sÿËs_
);

3376 
	gFixedSÿËCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

3377 cÚ¡ 
ChunkInfo
 &,

3378 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3379 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3380 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3381 
CompÚ’t
 *,

3382 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3383 *
	gš_d”iv
 = 
out_d”iv
;

3384 
	gš_d”iv
->
MulCŞsVec
(
sÿËs_
);

3387 
CompÚ’t
* 
	gFixedSÿËCompÚ’t
::
Cİy
() const {

3388 
FixedSÿËCompÚ’t
 *
ªs
 = 
Ãw
 FixedScaleComponent();

3389 
	gªs
->
	gsÿËs_
 = 
sÿËs_
;

3390  
	gªs
;

3394 
	gFixedSÿËCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3395 
Wr™eTok’
(
os
, 
bš¬y
, "<FixedScaleComponent>");

3396 
Wr™eTok’
(
os
, 
bš¬y
, "<Scales>");

3397 
	gsÿËs_
.
Wr™e
(
os
, 
bš¬y
);

3398 
Wr™eTok’
(
os
, 
bš¬y
, "</FixedScaleComponent>");

3401 
	gFixedSÿËCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3402 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<FixedScaleComponent>", "<Scales>");

3403 
	gsÿËs_
.
R—d
(
is
, 
bš¬y
);

3404 
Ex³ùTok’
(
is
, 
bš¬y
, "</FixedScaleComponent>");

3407 
	gFixedBŸsCompÚ’t
::
In™
(cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
bŸs
) {

3408 
KALDI_ASSERT
(
bŸs
.
Dim
() != 0);

3409 
	gbŸs_
 = 
bŸs
;

3412 
	gFixedBŸsCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3413 
¡d
::
¡ršg
 
Üig_¬gs
 = 
¬gs
;

3414 
	g¡d
::
¡ršg
 
f’ame
;

3415 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("bŸs", &
¬gs
, &
f’ame
);

3417 ià(!
	gok
 || !
	g¬gs
.
em±y
())

3418 
	gKALDI_ERR
 << "Invalid initializer for†ayer ofype "

3419 << 
Ty³
(è<< ": \"" << 
	gÜig_¬gs
 << "\"";

3421 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gvec
;

3422 
R—dK®diObjeù
(
f’ame
, &
vec
);

3423 
In™
(
vec
);

3427 
	g¡d
::
¡ršg
 
FixedBŸsCompÚ’t
::
Info
() const {

3428 
¡d
::
¡ršg¡»am
 
¡»am
;

3429 
Ba£Flßt
 
	gbŸs_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
bŸs_
.
Dim
()),

3430 
	gbŸs_m—n
 = 
bŸs_
.
Sum
(è/ 
bŸs_size
,

3431 
	gbŸs_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
bŸs_
, bŸs_è/ 
bŸs_size
)

3432 - (
bŸs_m—n
 * 
	gbŸs_m—n
);

3433 
	g¡»am
 << 
	gCompÚ’t
::
Info
(è<< ", bŸs-m—n=" << 
bŸs_m—n


3434 << ", bŸs-¡ddev=" << 
bŸs_¡ddev
;

3435  
	g¡»am
.
¡r
();

3438 
	gFixedBŸsCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3439 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3440 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3441 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3442 
	gout
->
CİyFromM©
(
š
);

3443 
	gout
->
AddVecToRows
(1.0, 
bŸs_
, 1.0);

3446 
	gFixedBŸsCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

3447 cÚ¡ 
ChunkInfo
 &,

3448 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3449 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

3450 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3451 
CompÚ’t
 *,

3452 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3453 *
	gš_d”iv
 = 
out_d”iv
;

3456 
CompÚ’t
* 
	gFixedBŸsCompÚ’t
::
Cİy
() const {

3457 
FixedBŸsCompÚ’t
 *
ªs
 = 
Ãw
 FixedBiasComponent();

3458 
	gªs
->
	gbŸs_
 = 
bŸs_
;

3459  
	gªs
;

3463 
	gFixedBŸsCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3464 
Wr™eTok’
(
os
, 
bš¬y
, "<FixedBiasComponent>");

3465 
Wr™eTok’
(
os
, 
bš¬y
, "<Bias>");

3466 
	gbŸs_
.
Wr™e
(
os
, 
bš¬y
);

3467 
Wr™eTok’
(
os
, 
bš¬y
, "</FixedBiasComponent>");

3470 
	gFixedBŸsCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3471 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<FixedBiasComponent>", "<Bias>");

3472 
	gbŸs_
.
R—d
(
is
, 
bš¬y
);

3473 
Ex³ùTok’
(
is
, 
bš¬y
, "</FixedBiasComponent>");

3479 
	g¡d
::
¡ršg
 
DrİoutCompÚ’t
::
Info
() const {

3480 
¡d
::
¡ršg¡»am
 
¡»am
;

3481 
	g¡»am
 << 
	gCompÚ’t
::
Info
() << ", dropout_proportion = "

3482 << 
drİout_´İÜtiÚ_
 << ", dropout_scale = "

3483 << 
drİout_sÿË_
;

3484  
	g¡»am
.
¡r
();

3487 
	gDrİoutCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3488 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

3489 
št32
 
	gdim
;

3490 
Ba£Flßt
 
	gdrİout_´İÜtiÚ
 = 0.5, 
	gdrİout_sÿË
 = 0.0;

3491 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
);

3492 
P¬£FromSŒšg
("drİout-´İÜtiÚ", &
¬gs
, &
drİout_´İÜtiÚ
);

3493 
P¬£FromSŒšg
("drİout-sÿË", &
¬gs
, &
drİout_sÿË
);

3495 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gdim
 <= 0)

3496 
KALDI_ERR
 << "Invalid initializer for†ayer ofype DropoutComponent: \""

3497 << 
Üig_¬gs
 << "\"";

3498 
In™
(
dim
, 
drİout_´İÜtiÚ
, 
drİout_sÿË
);

3501 
	gDrİoutCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3502 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<DropoutComponent>", "<Dim>");

3503 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

3504 
Ex³ùTok’
(
is
, 
bš¬y
, "<DropoutScale>");

3505 
R—dBasicTy³
(
is
, 
bš¬y
, &
drİout_sÿË_
);

3506 
Ex³ùTok’
(
is
, 
bš¬y
, "<DropoutProportion>");

3507 
R—dBasicTy³
(
is
, 
bš¬y
, &
drİout_´İÜtiÚ_
);

3508 
Ex³ùTok’
(
is
, 
bš¬y
, "</DropoutComponent>");

3511 
	gDrİoutCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3512 
Wr™eTok’
(
os
, 
bš¬y
, "<DropoutComponent>");

3513 
Wr™eTok’
(
os
, 
bš¬y
, "<Dim>");

3514 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

3515 
Wr™eTok’
(
os
, 
bš¬y
, "<DropoutScale>");

3516 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
drİout_sÿË_
);

3517 
Wr™eTok’
(
os
, 
bš¬y
, "<DropoutProportion>");

3518 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
drİout_´İÜtiÚ_
);

3519 
Wr™eTok’
(
os
, 
bš¬y
, "</DropoutComponent>");

3523 
	gDrİoutCompÚ’t
::
In™
(
št32
 
dim
,

3524 
Ba£Flßt
 
drİout_´İÜtiÚ
,

3525 
Ba£Flßt
 
drİout_sÿË
){

3526 
	gdim_
 = 
dim
;

3527 
	gdrİout_´İÜtiÚ_
 = 
drİout_´İÜtiÚ
;

3528 
	gdrİout_sÿË_
 = 
drİout_sÿË
;

3531 
	gDrİoutCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3532 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3533 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3534 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3535 
	gš_šfo
.
CheckSize
(
š
);

3536 
	gout_šfo
.
CheckSize
(*
out
);

3537 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

3538 
KALDI_ASSERT
(
š
.
NumCŞs
(è=ğ
this
->
IÅutDim
());

3540 
Ba£Flßt
 
	gdp
 = 
drİout_´İÜtiÚ_
;

3541 
KALDI_ASSERT
(
dp
 < 1.0 && dp >= 0.0);

3542 
KALDI_ASSERT
(
drİout_sÿË_
 <= 1.0 && dropout_scale_ >= 0.0);

3544 
Ba£Flßt
 
	glow_sÿË
 = 
drİout_sÿË_
,

3545 
	ghigh_sÿË
 = (1.0 - (
dp
 * 
low_sÿË
)) / (1.0 - dp),

3546 
	gav”age
 = (
low_sÿË
 * 
dp
) +

3547 (
high_sÿË
 * (1.0 - 
dp
));

3548 
KALDI_ASSERT
(
çbs
(
av”age
 - 1.0) < 0.01);

3552 
	gcÚ¡_ÿ¡
<
	gCuRªd
<
	gBa£Flßt
>&>(
	g¿ndom_g’”©Ü_
).
RªdUnifÜm
(
out
);

3555 
	gout
->
Add
(-
dp
);

3556 
	gout
->
AµlyH—viside
();

3558 ià((
	ghigh_sÿË
 - 
	glow_sÿË
) != 1.0)

3559 
out
->
SÿË
(
high_sÿË
 - 
low_sÿË
);

3560 ià(
	glow_sÿË
 != 0.0)

3561 
out
->
Add
(
low_sÿË
);

3563 
	gout
->
MulEËm’ts
(
š
);

3566 
	gDrİoutCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

3567 cÚ¡ 
ChunkInfo
 &,

3568 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

3569 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

3570 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3571 
CompÚ’t
 *,

3572 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3573 
KALDI_ASSERT
(
SameDim
(
š_v®ue
, 
out_v®ue
è&& SameDim(š_v®ue, 
out_d”iv
));

3574 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), out_d”iv.
NumCŞs
());

3575 
	gš_d”iv
->
S‘M©M©DivM©
(
out_d”iv
, 
out_v®ue
, 
š_v®ue
);

3578 
CompÚ’t
* 
	gDrİoutCompÚ’t
::
Cİy
() const {

3579  
Ãw
 
DrİoutCompÚ’t
(
dim_
,

3580 
drİout_´İÜtiÚ_
,

3581 
drİout_sÿË_
);

3584 
	gAdd™iveNoi£CompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3585 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

3586 
št32
 
	gdim
;

3587 
Ba£Flßt
 
	g¡ddev
 = 1.0;

3588 
boŞ
 
	gok
 = 
P¬£FromSŒšg
("dim", &
¬gs
, &
dim
);

3589 
P¬£FromSŒšg
("¡ddev", &
¬gs
, &
¡ddev
);

3591 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gdim
 <= 0)

3592 
KALDI_ERR
 << "Invalid initializer for†ayer ofype AdditiveNoiseComponent: \""

3593 << 
Üig_¬gs
 << "\"";

3594 
In™
(
dim
, 
¡ddev
);

3597 
	gAdd™iveNoi£CompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

3598 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<AdditiveNoiseComponent>", "<Dim>");

3599 
R—dBasicTy³
(
is
, 
bš¬y
, &
dim_
);

3600 
Ex³ùTok’
(
is
, 
bš¬y
, "<Stddev>");

3601 
R—dBasicTy³
(
is
, 
bš¬y
, &
¡ddev_
);

3602 
Ex³ùTok’
(
is
, 
bš¬y
, "</AdditiveNoiseComponent>");

3605 
	gAdd™iveNoi£CompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

3606 
Wr™eTok’
(
os
, 
bš¬y
, "<AdditiveNoiseComponent>");

3607 
Wr™eTok’
(
os
, 
bš¬y
, "<Dim>");

3608 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
dim_
);

3609 
Wr™eTok’
(
os
, 
bš¬y
, "<Stddev>");

3610 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
¡ddev_
);

3611 
Wr™eTok’
(
os
, 
bš¬y
, "</AdditiveNoiseComponent>");

3614 
	gAdd™iveNoi£CompÚ’t
::
In™
(
št32
 
dim
, 
Ba£Flßt
 
¡ddev
) {

3615 
	gdim_
 = 
dim
;

3616 
	g¡ddev_
 = 
¡ddev
;

3619 
	gAdd™iveNoi£CompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3620 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3621 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3622 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3623 
KALDI_ASSERT
(
š
.
NumCŞs
(è=ğ
this
->
IÅutDim
());

3624 
	gout
->
CİyFromM©
(
š
);

3625 
	gCuM©rix
<
	gBa£Flßt
> 
¿nd
(
š
.
NumRows
(), in.
NumCŞs
());

3626 
	gcÚ¡_ÿ¡
<
	gCuRªd
<
	gBa£Flßt
>&>(
	g¿ndom_g’”©Ü_
).
RªdUnifÜm
(&
¿nd
);

3627 
	gout
->
AddM©
(
¡ddev_
, 
¿nd
);

3630 
	gCÚvŞutiÚ®1dCompÚ’t
::
CÚvŞutiÚ®1dCompÚ’t
():

3631 
Upd©abËCompÚ’t
(),

3632 
·tch_dim_
(0), 
·tch_¡•_
(0), 
·tch_¡ride_
(0),

3633 
­³nded_cÚv_
(
çl£
), 
is_g¿d›Á_
(false) {}

3635 
	gCÚvŞutiÚ®1dCompÚ’t
::
CÚvŞutiÚ®1dCompÚ’t
(cÚ¡ CÚvŞutiÚ®1dCompÚ’ˆ&
compÚ’t
):

3636 
Upd©abËCompÚ’t
(
compÚ’t
),

3637 
f‹r_·¿ms_
(
compÚ’t
.filter_params_),

3638 
bŸs_·¿ms_
(
compÚ’t
.bias_params_),

3639 
­³nded_cÚv_
(
compÚ’t
.appended_conv_),

3640 
is_g¿d›Á_
(
compÚ’t
.is_gradient_) {}

3642 
	gCÚvŞutiÚ®1dCompÚ’t
::
CÚvŞutiÚ®1dCompÚ’t
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
f‹r_·¿ms
,

3643 cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
bŸs_·¿ms
,

3644 
Ba£Flßt
 
Ë¬nšg_¿‹
):

3645 
Upd©abËCompÚ’t
(
Ë¬nšg_¿‹
),

3646 
f‹r_·¿ms_
(
f‹r_·¿ms
),

3647 
bŸs_·¿ms_
(
bŸs_·¿ms
) {

3648 
KALDI_ASSERT
(
f‹r_·¿ms
.
NumRows
(è=ğ
bŸs_·¿ms
.
Dim
() &&

3649 
bŸs_·¿ms
.
Dim
() != 0);

3650 
	g­³nded_cÚv_
 = 
çl£
;

3651 
	gis_g¿d›Á_
 = 
çl£
;

3655 
št32
 
	gCÚvŞutiÚ®1dCompÚ’t
::
IÅutDim
() const {

3656 
št32
 
f‹r_dim
 = 
f‹r_·¿ms_
.
NumCŞs
();

3657 
št32
 
	gnum_¥liû
 = 
f‹r_dim
 / 
·tch_dim_
;

3658  
·tch_¡ride_
 * 
	gnum_¥liû
;

3662 
št32
 
	gCÚvŞutiÚ®1dCompÚ’t
::
OuutDim
() const {

3663 
št32
 
num_f‹rs
 = 
f‹r_·¿ms_
.
NumRows
();

3664 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride_
 - 
·tch_dim_
è/ 
·tch_¡•_
;

3665  
num_·tches
 * 
	gnum_f‹rs
;

3669 
	gCÚvŞutiÚ®1dCompÚ’t
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

3670 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

3671 
št32
 
·tch_dim
, iÁ32 
·tch_¡•
,

3672 
št32
 
·tch_¡ride
, 
Ba£Flßt
 
·¿m_¡ddev
,

3673 
Ba£Flßt
 
bŸs_¡ddev
, 
boŞ
 
­³nded_cÚv
) {

3674 
	gUpd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

3675 
	g·tch_dim_
 = 
·tch_dim
;

3676 
	g·tch_¡•_
 = 
·tch_¡•
;

3677 
	g·tch_¡ride_
 = 
·tch_¡ride
;

3678 
	g­³nded_cÚv_
 = 
­³nded_cÚv
;

3679 
št32
 
	gnum_¥liû
 = 
šput_dim
 / 
·tch_¡ride
;

3680 
št32
 
	gf‹r_dim
 = 
num_¥liû
 * 
·tch_dim
;

3681 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride
 - 
·tch_dim
è/ 
·tch_¡•
;

3682 
št32
 
	gnum_f‹rs
 = 
ouut_dim
 / 
num_·tches
;

3683 
KALDI_ASSERT
(
šput_dim
 % 
·tch_¡ride
 == 0);

3684 
KALDI_ASSERT
((
·tch_¡ride
 - 
·tch_dim
è% 
·tch_¡•
 == 0);

3685 
KALDI_ASSERT
(
ouut_dim
 % 
num_·tches
 == 0);

3687 
	gf‹r_·¿ms_
.
Resize
(
num_f‹rs
, 
f‹r_dim
);

3688 
	gbŸs_·¿ms_
.
Resize
(
num_f‹rs
);

3689 
KALDI_ASSERT
(
·¿m_¡ddev
 >ğ0.0 && 
bŸs_¡ddev
 >= 0.0);

3690 
	gf‹r_·¿ms_
.
S‘Rªdn
();

3691 
	gf‹r_·¿ms_
.
SÿË
(
·¿m_¡ddev
);

3692 
	gbŸs_·¿ms_
.
S‘Rªdn
();

3693 
	gbŸs_·¿ms_
.
SÿË
(
bŸs_¡ddev
);

3697 
	gCÚvŞutiÚ®1dCompÚ’t
::
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
, 
št32
 
·tch_dim
,

3698 
št32
 
·tch_¡•
, iÁ32 
·tch_¡ride
,

3699 
¡d
::
¡ršg
 
m©rix_f’ame
,

3700 
boŞ
 
­³nded_cÚv
) {

3701 
	gUpd©abËCompÚ’t
::
In™
(
Ë¬nšg_¿‹
);

3702 
	g·tch_dim_
 = 
·tch_dim
;

3703 
	g·tch_¡•_
 = 
·tch_¡•
;

3704 
	g·tch_¡ride_
 = 
·tch_¡ride
;

3705 
	g­³nded_cÚv_
 = 
­³nded_cÚv
;

3706 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©
;

3707 
R—dK®diObjeù
(
m©rix_f’ame
, &
m©
);

3708 
KALDI_ASSERT
(
m©
.
NumCŞs
() >= 2);

3709 
št32
 
	gf‹r_dim
 = 
m©
.
NumCŞs
(è- 1, 
	gnum_f‹rs
 = m©.
NumRows
();

3710 
	gf‹r_·¿ms_
.
Resize
(
num_f‹rs
, 
f‹r_dim
);

3711 
	gbŸs_·¿ms_
.
Resize
(
num_f‹rs
);

3712 
	gf‹r_·¿ms_
.
CİyFromM©
(
m©
.
Rªge
(0, 
num_f‹rs
, 0, 
f‹r_dim
));

3713 
	gbŸs_·¿ms_
.
CİyCŞFromM©
(
m©
, 
f‹r_dim
);

3718 
	gCÚvŞutiÚ®1dCompÚ’t
::
Resize
(
št32
 
šput_dim
, iÁ32 
ouut_dim
) {

3719 
KALDI_ASSERT
(
šput_dim
 > 0 && 
ouut_dim
 > 0);

3720 
št32
 
	gnum_¥liû
 = 
šput_dim
 / 
·tch_¡ride_
;

3721 
št32
 
	gf‹r_dim
 = 
num_¥liû
 * 
·tch_dim_
;

3722 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride_
 - 
·tch_dim_
è/ 
·tch_¡•_
;

3723 
št32
 
	gnum_f‹rs
 = 
ouut_dim
 / 
num_·tches
;

3724 
KALDI_ASSERT
(
šput_dim
 % 
·tch_¡ride_
 == 0);

3725 
KALDI_ASSERT
((
·tch_¡ride_
 - 
·tch_dim_
è% 
·tch_¡•_
 == 0);

3726 
KALDI_ASSERT
(
ouut_dim
 % 
num_·tches
 == 0);

3727 
	gf‹r_·¿ms_
.
Resize
(
num_f‹rs
, 
f‹r_dim
);

3728 
	gbŸs_·¿ms_
.
Resize
(
num_f‹rs
);

3732 
	g¡d
::
¡ršg
 
CÚvŞutiÚ®1dCompÚ’t
::
Info
() const {

3733 
¡d
::
¡ršg¡»am
 
¡»am
;

3734 
Ba£Flßt
 
	gf‹r_·¿ms_size
 = 
¡©ic_ÿ¡
<Ba£Flßt>(
f‹r_·¿ms_
.
NumRows
())

3735 * 
¡©ic_ÿ¡
<
Ba£Flßt
>(
f‹r_·¿ms_
.
NumCŞs
());

3736 
Ba£Flßt
 
	gf‹r_¡ddev
 =

3737 
¡d
::
sq¹
(
T¿ûM©M©
(
f‹r_·¿ms_
, f‹r_·¿ms_, 
kT¿ns
) /

3738 
f‹r_·¿ms_size
),

3739 
	gbŸs_¡ddev
 = 
¡d
::
sq¹
(
VecVec
(
bŸs_·¿ms_
, bias_params_) /

3740 
bŸs_·¿ms_
.
Dim
());

3742 
št32
 
	gnum_¥liû
 = 
IÅutDim
(è/ 
·tch_¡ride_
;

3743 
št32
 
	gf‹r_dim
 = 
num_¥liû
 * 
·tch_dim_
;

3744 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride_
 - 
·tch_dim_
è/ 
·tch_¡•_
;

3745 
št32
 
	gnum_f‹rs
 = 
OuutDim
(è/ 
num_·tches
;

3747 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim=" << 
IÅutDim
()

3748 << ", ouut-dim=" << 
OuutDim
()

3749 << ",‚um-¥liû=" << 
	gnum_¥liû


3750 << ",‚um-·tches=" << 
	gnum_·tches


3751 << ",‚um-f‹rs=" << 
	gnum_f‹rs


3752 << ", f‹r-dim=" << 
	gf‹r_dim


3753 << ", f‹r-·¿ms-¡ddev=" << 
	gf‹r_¡ddev


3754 << ", bŸs-·¿ms-¡ddev=" << 
	gbŸs_¡ddev


3755 << ",‡µ’ded-cÚv=" << 
	g­³nded_cÚv_


3756 << ",†—ºšg-¿‹=" << 
L—ºšgR©e
();

3757  
	g¡»am
.
¡r
();

3761 
	gCÚvŞutiÚ®1dCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

3762 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

3763 
boŞ
 
	gok
 = 
Œue
, 
	g­³nded_cÚv
 = 
çl£
;

3764 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 
Ë¬nšg_¿‹_
;

3765 
	g¡d
::
¡ršg
 
m©rix_f’ame
;

3766 
št32
 
	gšput_dim
 = -1, 
	gouut_dim
 = -1;

3767 
št32
 
	g·tch_dim
 = -1, 
	g·tch_¡•
 = -1, 
	g·tch_¡ride
 = -1;

3768 
P¬£FromSŒšg
("Ë¬nšg-¿‹", &
¬gs
, &
Ë¬nšg_¿‹
);

3769 
P¬£FromSŒšg
("­³nded-cÚv", &
¬gs
, &
­³nded_cÚv
);

3770 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("·tch-dim", &
¬gs
, &
·tch_dim
);

3771 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("·tch-¡•", &
¬gs
, &
·tch_¡•
);

3772 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("·tch-¡ride", &
¬gs
, &
·tch_¡ride
);

3773 ià(
P¬£FromSŒšg
("m©rix", &
¬gs
, &
m©rix_f’ame
)) {

3775 
In™
(
Ë¬nšg_¿‹
, 
·tch_dim
, 
·tch_¡•
, 
·tch_¡ride
,

3776 
m©rix_f’ame
, 
­³nded_cÚv
);

3777 ià(
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
))

3778 
KALDI_ASSERT
(
šput_dim
 =ğ
IÅutDim
() &&

3780 ià(
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
))

3781 
KALDI_ASSERT
(
ouut_dim
 =ğ
OuutDim
() &&

3785 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

3786 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

3787 
Ba£Flßt
 
	g·¿m_¡ddev
 = 1.0 / 
¡d
::
sq¹
(
šput_dim
), 
	gbŸs_¡ddev
 = 1.0;

3788 
P¬£FromSŒšg
("·¿m-¡ddev", &
¬gs
, &
·¿m_¡ddev
);

3789 
P¬£FromSŒšg
("bŸs-¡ddev", &
¬gs
, &
bŸs_¡ddev
);

3790 
In™
(
Ë¬nšg_¿‹
, 
šput_dim
, 
ouut_dim
, 
·tch_dim
,

3791 
·tch_¡•
, 
·tch_¡ride
, 
·¿m_¡ddev
, 
bŸs_¡ddev
, 
­³nded_cÚv
);

3793 ià(!
	g¬gs
.
em±y
())

3794 
	gKALDI_ERR
 << "Could‚Ù…roûs the£ƒËm’t š in™Ÿliz”: " << 
	g¬gs
;

3795 ià(!
	gok
)

3796 
	gKALDI_ERR
 << "Bad in™Ÿliz” " << 
	gÜig_¬gs
;

3819 
	gCÚvŞutiÚ®1dCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3820 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3821 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

3822 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

3823 
	gš_šfo
.
CheckSize
(
š
);

3824 
	gout_šfo
.
CheckSize
(*
out
);

3825 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

3828 
št32
 
	gnum_¥liû
 = 
IÅutDim
(è/ 
·tch_¡ride_
;

3829 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride_
 - 
·tch_dim_
è/ 
·tch_¡•_
;

3830 
št32
 
	gnum_f‹rs
 = 
f‹r_·¿ms_
.
NumRows
();

3831 
št32
 
	gnum_äames
 = 
š
.
NumRows
();

3832 
št32
 
	gf‹r_dim
 = 
f‹r_·¿ms_
.
NumCŞs
();

3838 
	gCuM©rix
<
	gBa£Flßt
> 
·tches
(
num_äames
, 
f‹r_dim
 * 
num_·tches
, 
kUndefšed
);

3841 
	g¡d
::
veùÜ
<
št32
> 
cŞumn_m­
(
f‹r_dim
 * 
num_·tches
);

3844 
št32
 
	g·tch
 = 0, 
	gšdex
 = 0;…©ch < 
	gnum_·tches
;…atch++) {

3845 
št32
 
	gf¡ride
 = 
·tch
 * 
·tch_¡•_
;

3846 
št32
 
	g¥liû
 = 0; s¶iû < 
	gnum_¥liû
; splice++) {

3847 
št32
 
	gc¡ride
 = 
¥liû
 * 
·tch_¡ride_
;

3848 
št32
 
	gd
 = 0; d < 
	g·tch_dim_
; d++, 
	gšdex
++) {

3849 ià(
	g­³nded_cÚv_
)

3850 
	gcŞumn_m­
[
šdex
] = (
f¡ride
 + 
d
è* 
num_¥liû
 + 
¥liû
;

3852 
	gcŞumn_m­
[
šdex
] = 
f¡ride
 + 
c¡ride
 + 
d
;

3856 
	gCuA¼ay
<
	gšt32
> 
cu_cŞs
(
cŞumn_m­
);

3857 
	g·tches
.
CİyCŞs
(
š
, 
cu_cŞs
);

3863 
	g¡d
::
veùÜ
<
CuSubM©rix
<
Ba£Flßt
>* > 
tgt_b©ch
, 
	g·tch_b©ch
, 
	gf‹r_·¿ms_b©ch
;

3865 
	gCuSubM©rix
<
	gBa£Flßt
>* 
	gf‹r_·¿ms_–em
 = 
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(

3866 
f‹r_·¿ms_
, 0, 
	gf‹r_·¿ms_
.
NumRows
(), 0, f‹r_·¿ms_.
NumCŞs
());

3869 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

3872 
	gtgt_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(
out
->
CŞRªge
(
p
 * 
num_f‹rs
,

3873 
num_f‹rs
)));

3874 
	g·tch_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(

3875 
·tches
.
CŞRªge
(
p
 * 
f‹r_dim
, filter_dim)));

3876 
	gf‹r_·¿ms_b©ch
.
push_back
(
f‹r_·¿ms_–em
);

3878 
	gtgt_b©ch
[
p
]->
AddVecToRows
(1.0, 
bŸs_·¿ms_
, 0.0);

3882 
	gAddM©M©B©ched
<
	gBa£Flßt
>(1.0, 
	gtgt_b©ch
, 
	g·tch_b©ch
, 
	gkNoT¿ns
,

3883 
	gf‹r_·¿ms_b©ch
, 
	gkT¿ns
, 1.0);

3886 
d–‘e
 
	gf‹r_·¿ms_–em
;

3887 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

3888 
d–‘e
 
	gtgt_b©ch
[
p
];

3889 
d–‘e
 
	g·tch_b©ch
[
p
];

3894 
	gCÚvŞutiÚ®1dCompÚ’t
::
SÿË
(
Ba£Flßt
 
sÿË
) {

3895 
f‹r_·¿ms_
.
SÿË
(
sÿË
);

3896 
	gbŸs_·¿ms_
.
SÿË
(
sÿË
);

3900 
	gCÚvŞutiÚ®1dCompÚ’t
::
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”_š
) {

3901 cÚ¡ 
CÚvŞutiÚ®1dCompÚ’t
 *
	gÙh”
 =

3902 
dyÇmic_ÿ¡
<cÚ¡ 
CÚvŞutiÚ®1dCompÚ’t
*>(&
Ùh”_š
);

3903 
KALDI_ASSERT
(
Ùh”
 !ğ
NULL
);

3904 
	gf‹r_·¿ms_
.
AddM©
(
®pha
, 
Ùh”
->
f‹r_·¿ms_
);

3905 
	gbŸs_·¿ms_
.
AddVec
(
®pha
, 
Ùh”
->
bŸs_·¿ms_
);

3920 
	gCÚvŞutiÚ®1dCompÚ’t
::
Rev”£Indexes
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
fÜw¬d_šdexes
,

3921 
št32
 
šput_dim
,

3922 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > *
backw¬d_šdexes
) {

3923 
št32
 
i
, 
	gsize
 = 
fÜw¬d_šdexes
.
size
();

3924 
št32
 
	g»£rve_size
 = 2 + 
size
 / 
šput_dim
;

3925 
	gbackw¬d_šdexes
->
»size
(
šput_dim
);

3926 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
št32
> >::
™”©Ü
 
™”
 = 
backw¬d_šdexes
->
begš
(),

3927 
	g’d
 = 
backw¬d_šdexes
->
’d
();

3928 ; 
	g™”
 !ğ
’d
; ++iter)

3929 
	g™”
->
»£rve
(
»£rve_size
);

3930 
št32
 
	gj
 = 0; j < 
	gfÜw¬d_šdexes
.
size
(); j++) {

3931 
	gi
 = 
fÜw¬d_šdexes
[
j
];

3932 
KALDI_ASSERT
(
i
 < 
šput_dim
);

3933 (*
	gbackw¬d_šdexes
)[
i
].
push_back
(
j
);

3948 
	gCÚvŞutiÚ®1dCompÚ’t
::
R—¼ªgeIndexes
(cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
š
,

3949 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > *
out
) {

3950 
št32
 
D
 = 
š
.
size
();

3951 
št32
 
	gL
 = 0;

3952 
št32
 
	gi
 = 0; i < 
	gD
; i++)

3953 ià(
	gš
[
i
].
size
(è> 
	gL
)

3954 
	gL
 = 
š
[
i
].
size
();

3955 
	gout
->
»size
(
L
);

3956 
št32
 
	gi
 = 0; i < 
	gL
; i++)

3957 (*
	gout
)[
i
].
»size
(
D
, -1);

3958 
št32
 
	gi
 = 0; i < 
	gD
; i++) {

3959 
št32
 
	gj
 = 0; j < 
	gš
[
i
].
size
(); j++) {

3960 (*
	gout
)[
j
][
i
] = 
š
[i][j];

3966 
	gCÚvŞutiÚ®1dCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

3967 cÚ¡ 
ChunkInfo
 &
out_šfo
,

3968 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

3969 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

3970 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

3971 
CompÚ’t
 *
to_upd©e_š
,

3972 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

3973 
	gš_d”iv
->
Resize
(
out_d”iv
.
NumRows
(), 
IÅutDim
());

3974 
CÚvŞutiÚ®1dCompÚ’t
 *
	gto_upd©e
 = 
dyÇmic_ÿ¡
<CÚvŞutiÚ®1dCompÚ’t*>(
to_upd©e_š
);

3975 
št32
 
	gnum_¥liû
 = 
IÅutDim
(è/ 
·tch_¡ride_
;

3976 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride_
 - 
·tch_dim_
è/ 
·tch_¡•_
;

3977 
št32
 
	gnum_f‹rs
 = 
f‹r_·¿ms_
.
NumRows
();

3978 
št32
 
	gnum_äames
 = 
out_d”iv
.
NumRows
();

3979 
št32
 
	gf‹r_dim
 = 
f‹r_·¿ms_
.
NumCŞs
();

3986 
	gCuM©rix
<
	gBa£Flßt
> 
·tches_d”iv
(
num_äames
, 
f‹r_dim
 * 
num_·tches
, 
kS‘Z”o
);

3992 
	g¡d
::
veùÜ
<
CuSubM©rix
<
Ba£Flßt
>* > 
·tch_d”iv_b©ch
, 
	gout_d”iv_b©ch
,

3993 
	gf‹r_·¿ms_b©ch
;

3995 
	gCuSubM©rix
<
	gBa£Flßt
>* 
	gf‹r_·¿ms_–em
 = 
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(

3996 
f‹r_·¿ms_
, 0, 
	gf‹r_·¿ms_
.
NumRows
(), 0, f‹r_·¿ms_.
NumCŞs
());

3999 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

4002 
	g·tch_d”iv_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(
·tches_d”iv
.
CŞRªge
(

4003 
p
 * 
f‹r_dim
, filter_dim)));

4004 
	gout_d”iv_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(
out_d”iv
.
CŞRªge
(

4005 
p
 * 
num_f‹rs
,‚um_filters)));

4006 
	gf‹r_·¿ms_b©ch
.
push_back
(
f‹r_·¿ms_–em
);

4008 
	gAddM©M©B©ched
<
	gBa£Flßt
>(1.0, 
	g·tch_d”iv_b©ch
, 
	gout_d”iv_b©ch
, 
	gkNoT¿ns
,

4009 
	gf‹r_·¿ms_b©ch
, 
	gkNoT¿ns
, 0.0);

4012 
d–‘e
 
	gf‹r_·¿ms_–em
;

4013 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

4014 
d–‘e
 
	g·tch_d”iv_b©ch
[
p
];

4015 
d–‘e
 
	gout_d”iv_b©ch
[
p
];

4019 
	g¡d
::
veùÜ
<
št32
> 
cŞumn_m­
(
f‹r_dim
 * 
num_·tches
);

4020 
št32
 
	g·tch
 = 0, 
	gšdex
 = 0;…©ch < 
	gnum_·tches
;…atch++) {

4021 
št32
 
	gf¡ride
 = 
·tch
 * 
·tch_¡•_
;

4022 
št32
 
	g¥liû
 = 0; s¶iû < 
	gnum_¥liû
; splice++) {

4023 
št32
 
	gc¡ride
 = 
¥liû
 * 
·tch_¡ride_
;

4024 
št32
 
	gd
 = 0; d < 
	g·tch_dim_
; d++, 
	gšdex
++) {

4025 ià(
	g­³nded_cÚv_
)

4026 
	gcŞumn_m­
[
šdex
] = (
f¡ride
 + 
d
è* 
num_¥liû
 + 
¥liû
;

4028 
	gcŞumn_m­
[
šdex
] = 
f¡ride
 + 
c¡ride
 + 
d
;

4032 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
št32
> > 
»v”£d_cŞumn_m­
;

4033 
Rev”£Indexes
(
cŞumn_m­
, 
IÅutDim
(), &
»v”£d_cŞumn_m­
);

4034 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
št32
> > 
»¬¿nged_cŞumn_m­
;

4035 
R—¼ªgeIndexes
(
»v”£d_cŞumn_m­
, &
»¬¿nged_cŞumn_m­
);

4036 
št32
 
	gp
 = 0;… < 
	g»¬¿nged_cŞumn_m­
.
size
();…++) {

4037 
	gCuA¼ay
<
	gšt32
> 
cu_cŞs
(
»¬¿nged_cŞumn_m­
[
p
]);

4038 
	gš_d”iv
->
AddCŞs
(
·tches_d”iv
, 
cu_cŞs
);

4041 ià(
	gto_upd©e
 !ğ
NULL
) {

4044 
to_upd©e
->
Upd©e
(
š_v®ue
, 
out_d”iv
);

4048 
	gCÚvŞutiÚ®1dCompÚ’t
::
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
) {

4049 ià(
Œ—t_as_g¿d›Á
) {

4050 
S‘L—ºšgR©e
(1.0);

4052 
	gf‹r_·¿ms_
.
S‘Z”o
();

4053 
	gbŸs_·¿ms_
.
S‘Z”o
();

4054 ià(
	gŒ—t_as_g¿d›Á
) {

4055 
	gis_g¿d›Á_
 = 
Œue
;

4059 
	gCÚvŞutiÚ®1dCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

4060 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

4061 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

4062 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

4065 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, 
o¡r_beg
.
¡r
(), "<LearningRate>");

4066 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ë¬nšg_¿‹_
);

4067 
Ex³ùTok’
(
is
, 
bš¬y
, "<PatchDim>");

4068 
R—dBasicTy³
(
is
, 
bš¬y
, &
·tch_dim_
);

4069 
Ex³ùTok’
(
is
, 
bš¬y
, "<PatchStep>");

4070 
R—dBasicTy³
(
is
, 
bš¬y
, &
·tch_¡•_
);

4071 
Ex³ùTok’
(
is
, 
bš¬y
, "<PatchStride>");

4072 
R—dBasicTy³
(
is
, 
bš¬y
, &
·tch_¡ride_
);

4074 
	g¡d
::
¡ršg
 
tok
;

4075 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

4076 ià(
	gtok
 == "<AppendedConv>") {

4077 
R—dBasicTy³
(
is
, 
bš¬y
, &
­³nded_cÚv_
);

4078 
Ex³ùTok’
(
is
, 
bš¬y
, "<FilterParams>");

4080 
	g­³nded_cÚv_
 = 
çl£
;

4081 
KALDI_ASSERT
(
tok
 == "<FilterParams>");

4083 
	gf‹r_·¿ms_
.
R—d
(
is
, 
bš¬y
);

4084 
Ex³ùTok’
(
is
, 
bš¬y
, "<BiasParams>");

4085 
	gbŸs_·¿ms_
.
R—d
(
is
, 
bš¬y
);

4086 
R—dTok’
(
is
, 
bš¬y
, &
tok
);

4087 ià(
	gtok
 == "<IsGradient>") {

4088 
R—dBasicTy³
(
is
, 
bš¬y
, &
is_g¿d›Á_
);

4089 
Ex³ùTok’
(
is
, 
bš¬y
, 
o¡r_’d
.
¡r
());

4091 
	gis_g¿d›Á_
 = 
çl£
;

4092 
KALDI_ASSERT
(
tok
 =ğ
o¡r_’d
.
¡r
());

4096 
	gCÚvŞutiÚ®1dCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

4097 
	g¡d
::
o¡ršg¡»am
 
o¡r_beg
, 
	go¡r_’d
;

4098 
	go¡r_beg
 << "<" << 
Ty³
() << ">";

4099 
	go¡r_’d
 << "</" << 
Ty³
() << ">";

4100 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_beg
.
¡r
());

4101 
Wr™eTok’
(
os
, 
bš¬y
, "<LearningRate>");

4102 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ë¬nšg_¿‹_
);

4103 
Wr™eTok’
(
os
, 
bš¬y
, "<PatchDim>");

4104 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
·tch_dim_
);

4105 
Wr™eTok’
(
os
, 
bš¬y
, "<PatchStep>");

4106 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
·tch_¡•_
);

4107 
Wr™eTok’
(
os
, 
bš¬y
, "<PatchStride>");

4108 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
·tch_¡ride_
);

4109 
Wr™eTok’
(
os
, 
bš¬y
, "<AppendedConv>");

4110 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
­³nded_cÚv_
);

4111 
Wr™eTok’
(
os
, 
bš¬y
, "<FilterParams>");

4112 
	gf‹r_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

4113 
Wr™eTok’
(
os
, 
bš¬y
, "<BiasParams>");

4114 
	gbŸs_·¿ms_
.
Wr™e
(
os
, 
bš¬y
);

4115 
Wr™eTok’
(
os
, 
bš¬y
, "<IsGradient>");

4116 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
is_g¿d›Á_
);

4117 
Wr™eTok’
(
os
, 
bš¬y
, 
o¡r_’d
.
¡r
());

4120 
Ba£Flßt
 
	gCÚvŞutiÚ®1dCompÚ’t
::
DÙProduù
(cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”_š
) const {

4121 cÚ¡ 
CÚvŞutiÚ®1dCompÚ’t
 *
Ùh”
 =

4122 
dyÇmic_ÿ¡
<cÚ¡ 
CÚvŞutiÚ®1dCompÚ’t
*>(&
Ùh”_š
);

4123  
T¿ûM©M©
(
f‹r_·¿ms_
, 
Ùh”
->f‹r_·¿ms_, 
kT¿ns
)

4124 + 
VecVec
(
bŸs_·¿ms_
, 
Ùh”
->bias_params_);

4127 
CompÚ’t
* 
	gCÚvŞutiÚ®1dCompÚ’t
::
Cİy
() const {

4128 
CÚvŞutiÚ®1dCompÚ’t
 *
ªs
 = 
Ãw
 Convolutional1dComponent();

4129 
	gªs
->
	gË¬nšg_¿‹_
 = 
Ë¬nšg_¿‹_
;

4130 
	gªs
->
	g·tch_dim_
 = 
·tch_dim_
;

4131 
	gªs
->
	g·tch_¡•_
 = 
·tch_¡•_
;

4132 
	gªs
->
	g·tch_¡ride_
 = 
·tch_¡ride_
;

4133 
	gªs
->
	gf‹r_·¿ms_
 = 
f‹r_·¿ms_
;

4134 
	gªs
->
	gbŸs_·¿ms_
 = 
bŸs_·¿ms_
;

4135 
	gªs
->
	g­³nded_cÚv_
 = 
­³nded_cÚv_
;

4136 
	gªs
->
	gis_g¿d›Á_
 = 
is_g¿d›Á_
;

4137  
	gªs
;

4140 
	gCÚvŞutiÚ®1dCompÚ’t
::
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
) {

4141 
CuM©rix
<
Ba£Flßt
> 
‹mp_f‹r_·¿ms
(
f‹r_·¿ms_
);

4142 
	g‹mp_f‹r_·¿ms
.
S‘Rªdn
();

4143 
	gf‹r_·¿ms_
.
AddM©
(
¡ddev
, 
‹mp_f‹r_·¿ms
);

4145 
	gCuVeùÜ
<
	gBa£Flßt
> 
‹mp_bŸs_·¿ms
(
bŸs_·¿ms_
);

4146 
	g‹mp_bŸs_·¿ms
.
S‘Rªdn
();

4147 
	gbŸs_·¿ms_
.
AddVec
(
¡ddev
, 
‹mp_bŸs_·¿ms
);

4150 
	gCÚvŞutiÚ®1dCompÚ’t
::
S‘P¬ams
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
bŸs
,

4151 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
f‹r
) {

4152 
	gbŸs_·¿ms_
 = 
bŸs
;

4153 
	gf‹r_·¿ms_
 = 
f‹r
;

4154 
KALDI_ASSERT
(
bŸs_·¿ms_
.
Dim
(è=ğ
f‹r_·¿ms_
.
NumRows
());

4157 
št32
 
	gCÚvŞutiÚ®1dCompÚ’t
::
G‘P¬am‘”Dim
() const {

4158  (
f‹r_·¿ms_
.
NumCŞs
(è+ 1è* f‹r_·¿ms_.
NumRows
();

4162 
	gCÚvŞutiÚ®1dCompÚ’t
::
Upd©e
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

4163 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

4165 
št32
 
	gnum_·tches
 = 1 + (
·tch_¡ride_
 - 
·tch_dim_
è/ 
·tch_¡•_
;

4166 
št32
 
	gnum_f‹rs
 = 
f‹r_·¿ms_
.
NumRows
();

4167 
št32
 
	gf‹r_dim
 = 
f‹r_·¿ms_
.
NumCŞs
();

4168 
št32
 
	gnum_äames
 = 
š_v®ue
.
NumRows
();

4169 
št32
 
	gnum_¥liû
 = 
IÅutDim
(è/ 
·tch_¡ride_
;

4170 
	gCuM©rix
<
	gBa£Flßt
> 
	gf‹rs_g¿d
;

4171 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gbŸs_g¿d
;

4177 
	gCuM©rix
<
	gBa£Flßt
> 
·tches
(
num_äames
, 
f‹r_dim
 * 
num_·tches
, 
kUndefšed
);

4178 
	g¡d
::
veùÜ
<
št32
> 
cŞumn_m­
(
f‹r_dim
 * 
num_·tches
);

4179 
št32
 
	g·tch
 = 0, 
	gšdex
 = 0;…©ch < 
	gnum_·tches
;…atch++) {

4180 
št32
 
	gf¡ride
 = 
·tch
 * 
·tch_¡•_
;

4181 
št32
 
	g¥liû
 = 0; s¶iû < 
	gnum_¥liû
; splice++) {

4182 
št32
 
	gc¡ride
 = 
¥liû
 * 
·tch_¡ride_
;

4183 
št32
 
	gd
 = 0; d < 
	g·tch_dim_
; d++, 
	gšdex
++) {

4184 ià(
	g­³nded_cÚv_
)

4185 
	gcŞumn_m­
[
šdex
] = (
f¡ride
 + 
d
è* 
num_¥liû
 + 
¥liû
;

4187 
	gcŞumn_m­
[
šdex
] = 
f¡ride
 + 
c¡ride
 + 
d
;

4191 
	gCuA¼ay
<
	gšt32
> 
cu_cŞs
(
cŞumn_m­
);

4192 
	g·tches
.
CİyCŞs
(
š_v®ue
, 
cu_cŞs
);

4197 
	gf‹rs_g¿d
.
Resize
(
num_f‹rs
, 
f‹r_dim
, 
kS‘Z”o
);

4198 
	gbŸs_g¿d
.
Resize
(
num_f‹rs
, 
kS‘Z”o
);

4206 
	gCuM©rix
<
	gBa£Flßt
> 
f‹rs_g¿d_blocks_b©ch
(

4207 
num_·tches
 * 
f‹rs_g¿d
.
NumRows
(), f‹rs_g¿d.
NumCŞs
());

4209 
	g¡d
::
veùÜ
<
CuSubM©rix
<
Ba£Flßt
>* > 
f‹rs_g¿d_b©ch
, 
	gdiff_·tch_b©ch
,

4210 
	g·tch_b©ch
;

4211 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

4213 
	gf‹rs_g¿d_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(

4214 
f‹rs_g¿d_blocks_b©ch
.
RowRªge
(

4215 
p
 * 
f‹rs_g¿d
.
NumRows
(),

4216 
f‹rs_g¿d
.
NumRows
())));

4217 
	gdiff_·tch_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(
out_d”iv
.
CŞRªge
(

4218 
p
 * 
num_f‹rs
,‚um_filters)));

4219 
	g·tch_b©ch
.
push_back
(
Ãw
 
CuSubM©rix
<
Ba£Flßt
>(
·tches
.
CŞRªge
(

4220 
p
 * 
f‹r_dim
, filter_dim)));

4223 
	gAddM©M©B©ched
<
	gBa£Flßt
>(1.0, 
	gf‹rs_g¿d_b©ch
, 
	gdiff_·tch_b©ch
,

4224 
	gkT¿ns
, 
	g·tch_b©ch
, 
	gkNoT¿ns
, 1.0);

4227 
	gf‹rs_g¿d
.
AddM©Blocks
(1.0, 
f‹rs_g¿d_blocks_b©ch
);

4230 
	gCuM©rix
<
	gBa£Flßt
> 
out_d”iv_cŞ_blocks_sum
(
out_d”iv
.
NumRows
(), 
num_f‹rs
);

4233 
	gout_d”iv_cŞ_blocks_sum
.
AddM©Blocks
(1.0, 
out_d”iv
);

4235 
	gbŸs_g¿d
.
AddRowSumM©
(1.0, 
out_d”iv_cŞ_blocks_sum
, 1.0);

4238 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

4239 
d–‘e
 
	gf‹rs_g¿d_b©ch
[
p
];

4240 
d–‘e
 
	gdiff_·tch_b©ch
[
p
];

4241 
d–‘e
 
	g·tch_b©ch
[
p
];

4247 
	gf‹r_·¿ms_
.
AddM©
(
Ë¬nšg_¿‹_
, 
f‹rs_g¿d
);

4248 
	gbŸs_·¿ms_
.
AddVec
(
Ë¬nšg_¿‹_
, 
bŸs_g¿d
);

4251 
	gMaxpoŞšgCompÚ’t
::
In™
(
št32
 
šput_dim
, iÁ32 
ouut_dim
,

4252 
št32
 
poŞ_size
, iÁ32 
poŞ_¡ride
) {

4253 
	gšput_dim_
 = 
šput_dim
;

4254 
	gouut_dim_
 = 
ouut_dim
;

4255 
	gpoŞ_size_
 = 
poŞ_size
;

4256 
	gpoŞ_¡ride_
 = 
poŞ_¡ride
;

4260 
KALDI_ASSERT
(
šput_dim_
 % 
poŞ_¡ride_
 == 0);

4261 
št32
 
	gnum_·tches
 = 
šput_dim_
 / 
poŞ_¡ride_
;

4263 
KALDI_ASSERT
(
num_·tches
 % 
poŞ_size_
 == 0);

4264 
št32
 
	gnum_poŞs
 = 
num_·tches
 / 
poŞ_size_
;

4266 
KALDI_ASSERT
(
ouut_dim_
 =ğ
num_poŞs
 * 
poŞ_¡ride_
);

4269 
	gMaxpoŞšgCompÚ’t
::
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) {

4270 
¡d
::
¡ršg
 
Üig_¬gs
(
¬gs
);

4271 
št32
 
	gšput_dim
 = 0;

4272 
št32
 
	gouut_dim
 = 0;

4273 
št32
 
	gpoŞ_size
 = -1, 
	gpoŞ_¡ride
 = -1;

4274 
boŞ
 
	gok
 = 
Œue
;

4276 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("šput-dim", &
¬gs
, &
šput_dim
);

4277 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("ouut-dim", &
¬gs
, &
ouut_dim
);

4278 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("poŞ-size", &
¬gs
, &
poŞ_size
);

4279 
	gok
 = 
ok
 && 
P¬£FromSŒšg
("poŞ-¡ride", &
¬gs
, &
poŞ_¡ride
);

4281 
	gKALDI_LOG
 << 
	gouut_dim
 << " " << 
	gšput_dim
 << " " << 
	gok
;

4282 
	gKALDI_LOG
 << "PoŞ: " << 
	gpoŞ_size
 << " "

4283 << 
	gpoŞ_¡ride
 << " " << 
	gok
;

4284 ià(!
	gok
 || !
	g¬gs
.
em±y
(è|| 
	gouut_dim
 <= 0)

4285 
KALDI_ERR
 << "Invalid initializer for†ayer ofype "

4286 << 
Ty³
(è<< ": \"" << 
Üig_¬gs
 << "\"";

4287 
In™
(
šput_dim
, 
ouut_dim
, 
poŞ_size
, 
poŞ_¡ride
);

4295 
	gMaxpoŞšgCompÚ’t
::
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

4296 cÚ¡ 
ChunkInfo
 &
out_šfo
,

4297 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

4298 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const {

4299 
	gš_šfo
.
CheckSize
(
š
);

4300 
	gout_šfo
.
CheckSize
(*
out
);

4301 
KALDI_ASSERT
(
š_šfo
.
NumChunks
(è=ğ
out_šfo
.NumChunks());

4302 
št32
 
	gnum_·tches
 = 
šput_dim_
 / 
poŞ_¡ride_
;

4303 
št32
 
	gnum_poŞs
 = 
num_·tches
 / 
poŞ_size_
;

4306 
št32
 
	gq
 = 0; q < 
	gnum_poŞs
; q++) {

4308 
	gCuSubM©rix
<
	gBa£Flßt
> 
poŞ
(
out
->
CŞRªge
(
q
 * 
poŞ_¡ride_
,…ool_stride_));

4309 
	gpoŞ
.
S‘
(-1e20);

4310 
št32
 
	gr
 = 0;„ < 
	gpoŞ_size_
;„++) {

4312 
št32
 
	gp
 = 
r
 + 
q
 * 
poŞ_size_
;

4313 
	gpoŞ
.
Max
(
š
.
CŞRªge
(
p
 * 
poŞ_¡ride_
,…ool_stride_));

4318 
	gMaxpoŞšgCompÚ’t
::
Back´İ
(cÚ¡ 
ChunkInfo
 &,

4319 cÚ¡ 
ChunkInfo
 &,

4320 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

4321 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

4322 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

4323 
CompÚ’t
 *
to_upd©e
,

4324 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const {

4325 
št32
 
	gnum_·tches
 = 
šput_dim_
 / 
poŞ_¡ride_
;

4326 
št32
 
	gnum_poŞs
 = 
num_·tches
 / 
poŞ_size_
;

4327 
	g¡d
::
veùÜ
<
št32
> 
·tch_summªds
(
num_·tches
, 0);

4328 
	gš_d”iv
->
Resize
(
š_v®ue
.
NumRows
(), in_v®ue.
NumCŞs
(), 
kS‘Z”o
);

4330 
št32
 
	gq
 = 0; q < 
	gnum_poŞs
; q++) {

4331 
št32
 
	gr
 = 0;„ < 
	gpoŞ_size_
;„++) {

4332 
št32
 
	gp
 = 
r
 + 
q
 * 
poŞ_size_
;

4333 
	gCuSubM©rix
<
	gBa£Flßt
> 
š_p
(
š_v®ue
.
CŞRªge
(
p
 * 
poŞ_¡ride_
,…ool_stride_));

4334 
	gCuSubM©rix
<
	gBa£Flßt
> 
out_q
(
out_v®ue
.
CŞRªge
(
q
 * 
poŞ_¡ride_
,…ool_stride_));

4335 
	gCuSubM©rix
<
	gBa£Flßt
> 
tgt
(
š_d”iv
->
CŞRªge
(
p
 * 
poŞ_¡ride_
,…ool_stride_));

4336 
	gCuM©rix
<
	gBa£Flßt
> 
¤c
(
out_d”iv
.
CŞRªge
(
q
 * 
poŞ_¡ride_
,…ool_stride_));

4338 
	gCuM©rix
<
	gBa£Flßt
> 
	gmask
;

4339 
	gš_p
.
Equ®EËm’tMask
(
out_q
, &
mask
);

4340 
	g¤c
.
MulEËm’ts
(
mask
);

4341 
	gtgt
.
AddM©
(1.0, 
¤c
);

4343 
	g·tch_summªds
[
p
] += 1;

4348 
št32
 
	gp
 = 0;… < 
	gnum_·tches
;…++) {

4349 
	gCuSubM©rix
<
	gBa£Flßt
> 
tgt
(
š_d”iv
->
CŞRªge
(
p
 * 
poŞ_¡ride_
,…ool_stride_));

4350 
KALDI_ASSERT
(
·tch_summªds
[
p
] > 0);

4351 
	gtgt
.
SÿË
(1.0 / 
·tch_summªds
[
p
]);

4355 
	gMaxpoŞšgCompÚ’t
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

4356 
Ex³ùOÃOrTwoTok’s
(
is
, 
bš¬y
, "<MaxpoolingComponent>", "<InputDim>");

4357 
R—dBasicTy³
(
is
, 
bš¬y
, &
šput_dim_
);

4358 
Ex³ùTok’
(
is
, 
bš¬y
, "<OutputDim>");

4359 
R—dBasicTy³
(
is
, 
bš¬y
, &
ouut_dim_
);

4360 
Ex³ùTok’
(
is
, 
bš¬y
, "<PoolSize>");

4361 
R—dBasicTy³
(
is
, 
bš¬y
, &
poŞ_size_
);

4362 
Ex³ùTok’
(
is
, 
bš¬y
, "<PoolStride>");

4363 
R—dBasicTy³
(
is
, 
bš¬y
, &
poŞ_¡ride_
);

4364 
Ex³ùTok’
(
is
, 
bš¬y
, "</MaxpoolingComponent>");

4367 
	gMaxpoŞšgCompÚ’t
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

4368 
Wr™eTok’
(
os
, 
bš¬y
, "<MaxpoolingComponent>");

4369 
Wr™eTok’
(
os
, 
bš¬y
, "<InputDim>");

4370 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
šput_dim_
);

4371 
Wr™eTok’
(
os
, 
bš¬y
, "<OutputDim>");

4372 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
ouut_dim_
);

4373 
Wr™eTok’
(
os
, 
bš¬y
, "<PoolSize>");

4374 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
poŞ_size_
);

4375 
Wr™eTok’
(
os
, 
bš¬y
, "<PoolStride>");

4376 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
poŞ_¡ride_
);

4377 
Wr™eTok’
(
os
, 
bš¬y
, "</MaxpoolingComponent>");

4380 
	g¡d
::
¡ršg
 
MaxpoŞšgCompÚ’t
::
Info
() const {

4381 
¡d
::
¡ršg¡»am
 
¡»am
;

4382 
	g¡»am
 << 
Ty³
(è<< ", iÅut-dim = " << 
	gšput_dim_


4383 << ", ouut-dim = " << 
	gouut_dim_


4384 << ",…oŞ-sizğ" << 
	gpoŞ_size_


4385 << ",…oŞ-¡ridğ" << 
	gpoŞ_¡ride_
;

4386  
	g¡»am
.
¡r
();

	@nnet-component.h

24 #iâdeà
KALDI_NNET2_NNET_COMPONENT_H_


25 
	#KALDI_NNET2_NNET_COMPONENT_H_


	)

27 
	~<mu‹x
>

28 
	~"ba£/k®di-commÚ.h
"

29 
	~"™f/İtiÚs-™f.h
"

30 
	~"m©rix/m©rix-lib.h
"

31 
	~"cudam©rix/cu-m©rix-lib.h
"

32 
	~"Â‘2/Â‘-´ecÚd™iÚ-Úlše.h
"

34 
	~<io¡»am
>

36 
Çme¥aû
 
	gk®di
 {

37 
Çme¥aû
 
	gÂ‘2
 {

72 şas 
	cChunkInfo
 {

73 
	gpublic
:

74 
ChunkInfo
()

75 : 
ã©_dim_
(0), 
num_chunks_
(0),

76 
fœ¡_off£t_
(0), 
Ï¡_off£t_
(0),

77 
off£ts_
() { }

79 
ChunkInfo
(
št32
 
ã©_dim
, iÁ32 
num_chunks
,

80 
št32
 
fœ¡_off£t
, iÁ32 
Ï¡_off£t
 )

81 : 
ã©_dim_
(
ã©_dim
), 
num_chunks_
(
num_chunks
),

82 
fœ¡_off£t_
(
fœ¡_off£t
), 
Ï¡_off£t_
(
Ï¡_off£t
),

83 
off£ts_
(è{ 
Check
(); }

85 
ChunkInfo
(
št32
 
ã©_dim
, iÁ32 
num_chunks
,

86 cÚ¡ 
¡d
::
veùÜ
<
št32
> 
off£ts
)

87 : 
ã©_dim_
(
ã©_dim
), 
num_chunks_
(
num_chunks
),

88 
fœ¡_off£t_
(
off£ts
.
äÚt
()), 
Ï¡_off£t_
(off£ts.
back
()),

89 
off£ts_
(
off£ts
è{ ià(
	gÏ¡_off£t_
 - 
	gfœ¡_off£t_
 + 1 =ğoff£ts_.
size
())

90 
off£ts_
.
ş—r
();

91 
Check
(); }

104 
št32
 
G‘Index
 (št32 
off£t
) const;

107 
št32
 
G‘Off£t
 (št32 
šdex
) const;

111 
MakeOff£tsCÚtiguous
 (è{ 
	goff£ts_
.
ş—r
(); 
Check
(); }

115 
šlše
 
št32
 
ChunkSize
(ècÚ¡ {  
NumRows
(è/ 
	gnum_chunks_
; }

118 
šlše
 
št32
 
NumChunks
(ècÚ¡ {  
	gnum_chunks_
; }

121 
št32
 
NumRows
() const {

122  
	gnum_chunks_
 * (!
	goff£ts_
.
em±y
(è? off£ts_.
size
() :

123 
Ï¡_off£t_
 - 
fœ¡_off£t_
 + 1); }

126 
št32
 
NumCŞs
(ècÚ¡ {  
	gã©_dim_
; }

129 
CheckSize
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
m©
) const;

132 
Check
() const;

134 
	g´iv©e
:

135 
št32
 
ã©_dim_
;

136 
št32
 
	gnum_chunks_
;

137 
št32
 
	gfœ¡_off£t_
;

140 
št32
 
	gÏ¡_off£t_
;

141 
	g¡d
::
veùÜ
<
št32
> 
off£ts_
;

157 şas 
	cCompÚ’t
 {

158 
	gpublic
:

159 
CompÚ’t
(): 
šdex_
(-1) { }

161 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const = 0;

166 
vœtu®
 
št32
 
Index
(ècÚ¡ {  
	gšdex_
; }

168 
vœtu®
 
S‘Index
(
št32
 
šdex
è{ 
	gšdex_
 = index; }

173 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
) = 0;

176 
vœtu®
 
št32
 
IÅutDim
() const = 0;

179 
vœtu®
 
št32
 
OuutDim
() const = 0;

188 
vœtu®
 
	g¡d
::
veùÜ
<
št32
> 
CÚ‹xt
(ècÚ¡ {  
¡d
::vector<int32>(1, 0); }

197 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

198 cÚ¡ 
ChunkInfo
 &
out_šfo
,

199 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

200 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const = 0;

203 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

204 cÚ¡ 
ChunkInfo
 &
out_šfo
,

205 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

206 
CuM©rix
<
Ba£Flßt
> *
out
) const {

207 ià(
	gout
->
NumRows
(è!ğ
out_šfo
.NumRows() ||

208 
out
->
NumCŞs
(è!ğ
out_šfo
.NumCols()) {

209 
out
->
Resize
(
out_šfo
.
NumRows
(), out_šfo.
NumCŞs
());

213 
Prİag©e
(
š_šfo
, 
out_šfo
, 
š
,

214 
¡©ic_ÿ¡
<
CuM©rixBa£
<
Ba£Flßt
>*>(
out
));

227 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

228 cÚ¡ 
ChunkInfo
 &
out_šfo
,

229 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

230 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

231 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

232 
CompÚ’t
 *
to_upd©e
,

233 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const = 0;

235 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

237 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

241 
CompÚ’t
* 
R—dNew
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

244 
vœtu®
 
CompÚ’t
* 
Cİy
() const = 0;

250 
CompÚ’t
 *
NewFromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
š™Ÿliz”_lše
);

254 
CompÚ’t
 *
NewCompÚ’tOfTy³
(cÚ¡ 
¡d
::
¡ršg
 &
ty³
);

256 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) = 0;

260 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const = 0;

262 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

264 
	gvœtu®
 ~
CompÚ’t
() { }

266 
	g´iv©e
:

267 
št32
 
šdex_
;

268 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
CompÚ’t
);

279 şas 
	cUpd©abËCompÚ’t
: 
public
 
CompÚ’t
 {

280 
public
:

281 
Upd©abËCompÚ’t
(cÚ¡ Upd©abËCompÚ’ˆ&
Ùh”
):

282 
Ë¬nšg_¿‹_
(
Ùh”
.learning_rate_){ }

284 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
) {

285 
Ë¬nšg_¿‹_
 = 
Ë¬nšg_¿‹
;

287 
Upd©abËCompÚ’t
(
Ba£Flßt
 
Ë¬nšg_¿‹
) {

288 
In™
(
Ë¬nšg_¿‹
);

295 
vœtu®
 
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
) = 0;

297 
Upd©abËCompÚ’t
(): 
Ë¬nšg_¿‹_
(0.001) { }

299 
vœtu®
 ~
Upd©abËCompÚ’t
() { }

305 
vœtu®
 
Ba£Flßt
 
DÙProduù
(cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
) const = 0;

309 
vœtu®
 
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
) = 0;

313 
vœtu®
 
SÿË
(
Ba£Flßt
 
sÿË
) = 0;

318 
vœtu®
 
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
) = 0;

321 
S‘L—ºšgR©e
(
Ba£Flßt
 
Ì©e
è{ 
	gË¬nšg_¿‹_
 =†rate; }

323 
Ba£Flßt
 
L—ºšgR©e
(ècÚ¡ {  
	gË¬nšg_¿‹_
; }

325 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

333 
vœtu®
 
št32
 
G‘P¬am‘”Dim
(ècÚ¡ { 
KALDI_ASSERT
(0);  0; }

338 
vœtu®
 
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
ècÚ¡ { 
KALDI_ASSERT
(0); }

340 
vœtu®
 
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
) {

341 
KALDI_ASSERT
(0);

344 
	g´Ùeùed
:

345 
Ba£Flßt
 
Ë¬nšg_¿‹_
;

346 
	g´iv©e
:

347 cÚ¡ 
Upd©abËCompÚ’t
 &
İ”©Ü
 = (cÚ¡ Upd©abËCompÚ’ˆ&
Ùh”
);

352 şas 
	cNÚlš—rCompÚ’t
: 
public
 
CompÚ’t
 {

353 
public
:

354 
In™
(
št32
 
dim
è{ 
dim_
 = dim; 
	gcouÁ_
 = 0.0; }

355 
ex¶ic™
 
NÚlš—rCompÚ’t
(
št32
 
dim
è{ 
In™
(dim); }

356 
NÚlš—rCompÚ’t
(): 
dim_
(0) { }

357 
ex¶ic™
 
NÚlš—rCompÚ’t
(cÚ¡ NÚlš—rCompÚ’ˆ&
Ùh”
);

359 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

360 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdim_
; }

363 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

366 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

369 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

371 
SÿË
(
Ba£Flßt
 
sÿË
);

372 
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
NÚlš—rCompÚ’t
 &
Ùh”
);

377 cÚ¡ 
	gCuVeùÜ
<> &
V®ueSum
(ècÚ¡ {  
	gv®ue_sum_
; }

378 cÚ¡ 
	gCuVeùÜ
<> &
D”ivSum
(ècÚ¡ {  
	gd”iv_sum_
; }

379 
CouÁ
(ècÚ¡ {  
	gcouÁ_
; }

382 
S‘Dim
(
št32
 
dim
);

384 
	g´Ùeùed
:

385 
ä›nd
 
şass
 
NÜm®iz©iÚCompÚ’t
;

386 
ä›nd
 
şass
 
	gSigmoidCompÚ’t
;

387 
ä›nd
 
şass
 
	gTªhCompÚ’t
;

388 
ä›nd
 
şass
 
	gSoámaxCompÚ’t
;

389 
ä›nd
 
şass
 
	gLogSoámaxCompÚ’t
;

390 
ä›nd
 
şass
 
	gReùif›dLš—rCompÚ’t
;

391 
ä›nd
 
şass
 
	gSoáHšgeCompÚ’t
;

397 
Upd©eSts
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

398 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> *
d”iv
 = 
NULL
);

401 cÚ¡ 
	gNÚlš—rCompÚ’t
 &
	gİ”©Ü
 = (cÚ¡ 
NÚlš—rCompÚ’t
 &
Ùh”
);

402 
št32
 
	gdim_
;

403 
	gCuVeùÜ
<> 
	gv®ue_sum_
;

404 
	gCuVeùÜ
<> 
	gd”iv_sum_
;

406 
	gcouÁ_
;

408 
	g¡d
::
mu‹x
 
mu‹x_
;

411 şas 
	cMaxoutCompÚ’t
: 
public
 
CompÚ’t
 {

412 
public
:

413 
In™
(
št32
 
šput_dim
, iÁ32 
ouut_dim
);

414 
ex¶ic™
 
MaxoutCompÚ’t
(
št32
 
šput_dim
, iÁ32 
ouut_dim
) {

415 
In™
(
šput_dim
, 
ouut_dim
);

417 
MaxoutCompÚ’t
(): 
šput_dim_
(0), 
ouut_dim_
(0) { }

418 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "MaxoutComponent"; }

419 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

420 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gšput_dim_
; }

421 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gouut_dim_
; }

422 
usšg
 
	gCompÚ’t
::
Prİag©e
;

423 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

424 cÚ¡ 
ChunkInfo
 &
out_šfo
,

425 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

426 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

427 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

428 cÚ¡ 
ChunkInfo
 &
out_šfo
,

429 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

430 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

431 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

432 
CompÚ’t
 *
to_upd©e
,

433 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

434 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

435 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

436 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
MaxoutCompÚ’t
(
šput_dim_
,

437 
ouut_dim_
); }

439 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

443 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

445 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

446 
	g´Ùeùed
:

447 
št32
 
šput_dim_
;

448 
št32
 
	gouut_dim_
;

468 şas 
	cMaxpoŞšgCompÚ’t
: 
public
 
CompÚ’t
 {

469 
public
:

470 
In™
(
št32
 
šput_dim
, iÁ32 
ouut_dim
,

471 
št32
 
poŞ_size
, iÁ32 
poŞ_¡ride
);

472 
ex¶ic™
 
MaxpoŞšgCompÚ’t
(
št32
 
šput_dim
, iÁ32 
ouut_dim
,

473 
št32
 
poŞ_size
, iÁ32 
poŞ_¡ride
) {

474 
In™
(
šput_dim
, 
ouut_dim
, 
poŞ_size
, 
poŞ_¡ride
);

476 
MaxpoŞšgCompÚ’t
(): 
šput_dim_
(0), 
ouut_dim_
(0),

477 
poŞ_size_
(0), 
poŞ_¡ride_
(0) { }

478 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "MaxpoolingComponent"; }

479 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

480 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gšput_dim_
; }

481 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gouut_dim_
; }

482 
usšg
 
	gCompÚ’t
::
Prİag©e
;

483 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

484 cÚ¡ 
ChunkInfo
 &
out_šfo
,

485 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

486 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

487 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

488 cÚ¡ 
ChunkInfo
 &
out_šfo
,

489 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

490 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

491 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

492 
CompÚ’t
 *
to_upd©e
,

493 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

494 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

495 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

496 
vœtu®
 
CompÚ’t
* 
Cİy
() const {

497  
Ãw
 
MaxpoŞšgCompÚ’t
(
šput_dim_
, 
ouut_dim_
,

498 
poŞ_size_
, 
poŞ_¡ride_
); }

500 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

504 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

506 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

507 
	g´Ùeùed
:

508 
št32
 
šput_dim_
;

509 
št32
 
	gouut_dim_
;

510 
št32
 
	gpoŞ_size_
;

511 
št32
 
	gpoŞ_¡ride_
;

514 şas 
	cPnÜmCompÚ’t
: 
public
 
CompÚ’t
 {

515 
public
:

516 
In™
(
št32
 
šput_dim
, iÁ32 
ouut_dim
, 
Ba£Flßt
 
p
);

517 
ex¶ic™
 
PnÜmCompÚ’t
(
št32
 
šput_dim
, iÁ32 
ouut_dim
, 
Ba£Flßt
 
p
) {

518 
In™
(
šput_dim
, 
ouut_dim
, 
p
);

520 
PnÜmCompÚ’t
(): 
šput_dim_
(0), 
ouut_dim_
(0), 
p_
(0) { }

521 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "PnormComponent"; }

522 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

523 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gšput_dim_
; }

524 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gouut_dim_
; }

525 
usšg
 
	gCompÚ’t
::
Prİag©e
;

526 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

527 cÚ¡ 
ChunkInfo
 &
out_šfo
,

528 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

529 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

530 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

531 cÚ¡ 
ChunkInfo
 &
out_šfo
,

532 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

533 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &,

534 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

535 
CompÚ’t
 *
to_upd©e
,

536 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

537 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

538 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

539 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
PnÜmCompÚ’t
(
šput_dim_
,

540 
ouut_dim_
, 
p_
); }

542 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

546 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

548 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

549 
	g´Ùeùed
:

550 
št32
 
šput_dim_
;

551 
št32
 
	gouut_dim_
;

552 
Ba£Flßt
 
	gp_
;

555 şas 
	cNÜm®izeCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

556 
public
:

557 
ex¶ic™
 
NÜm®izeCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

558 
ex¶ic™
 
NÜm®izeCompÚ’t
(cÚ¡ NÜm®izeCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

559 
NÜm®izeCompÚ’t
() { }

560 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "NormalizeComponent"; }

561 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
NÜm®izeCompÚ’t
(*
this
); }

562 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

563 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

564 
usšg
 
	gCompÚ’t
::
Prİag©e
;

565 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

566 cÚ¡ 
ChunkInfo
 &
out_šfo
,

567 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

568 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

569 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

570 cÚ¡ 
ChunkInfo
 &
out_šfo
,

571 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

572 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

573 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

574 
CompÚ’t
 *
to_upd©e
,

575 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

576 
	g´iv©e
:

577 
NÜm®izeCompÚ’t
 &
İ”©Ü
 = (cÚ¡ NÜm®izeCompÚ’ˆ&
Ùh”
);

578 cÚ¡ 
Ba£Flßt
 
	gkNÜmFloÜ
;

585 şas 
	cSigmoidCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

586 
public
:

587 
ex¶ic™
 
SigmoidCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

588 
ex¶ic™
 
SigmoidCompÚ’t
(cÚ¡ SigmoidCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

589 
SigmoidCompÚ’t
() { }

590 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "SigmoidComponent"; }

591 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

592 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

593 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
SigmoidCompÚ’t
(*
this
); }

594 
usšg
 
	gCompÚ’t
::
Prİag©e
;

595 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

596 cÚ¡ 
ChunkInfo
 &
out_šfo
,

597 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

598 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

599 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

600 cÚ¡ 
ChunkInfo
 &
out_šfo
,

601 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

602 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

603 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

604 
CompÚ’t
 *
to_upd©e
,

605 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

606 
	g´iv©e
:

607 
SigmoidCompÚ’t
 &
İ”©Ü
 = (cÚ¡ SigmoidCompÚ’ˆ&
Ùh”
);

610 şas 
	cTªhCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

611 
public
:

612 
ex¶ic™
 
TªhCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

613 
ex¶ic™
 
TªhCompÚ’t
(cÚ¡ TªhCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

614 
TªhCompÚ’t
() { }

615 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "TanhComponent"; }

616 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
TªhCompÚ’t
(*
this
); }

617 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

618 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

619 
usšg
 
	gCompÚ’t
::
Prİag©e
;

620 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

621 cÚ¡ 
ChunkInfo
 &
out_šfo
,

622 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

623 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

624 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

625 cÚ¡ 
ChunkInfo
 &
out_šfo
,

626 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

627 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

628 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

629 
CompÚ’t
 *
to_upd©e
,

630 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

631 
	g´iv©e
:

632 
TªhCompÚ’t
 &
İ”©Ü
 = (cÚ¡ TªhCompÚ’ˆ&
Ùh”
);

637 şas 
	cPow”CompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

638 
public
:

639 
In™
(
št32
 
dim
, 
Ba£Flßt
 
pow”
 = 2);

640 
ex¶ic™
 
Pow”CompÚ’t
(
št32
 
dim
, 
Ba£Flßt
 
pow”
 = 2) {

641 
In™
(
dim
, 
pow”
);

643 
Pow”CompÚ’t
(): 
dim_
(0), 
pow”_
(2) { }

644 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "PowerComponent"; }

645 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

646 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

647 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdim_
; }

648 
usšg
 
	gCompÚ’t
::
Prİag©e
;

649 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

650 cÚ¡ 
ChunkInfo
 &
out_šfo
,

651 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

652 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

653 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

654 cÚ¡ 
ChunkInfo
 &
out_šfo
,

655 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

656 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

657 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

658 
CompÚ’t
 *
to_upd©e
,

659 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

660 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

661 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

662 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
Pow”CompÚ’t
(
dim_
, 
pow”_
); }

663 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

667 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

669 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

671 
	g´iv©e
:

672 
št32
 
dim_
;

673 
Ba£Flßt
 
	gpow”_
;

676 şas 
	cReùif›dLš—rCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

677 
public
:

678 
ex¶ic™
 
Reùif›dLš—rCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

679 
ex¶ic™
 
Reùif›dLš—rCompÚ’t
(cÚ¡ Reùif›dLš—rCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

680 
Reùif›dLš—rCompÚ’t
() { }

681 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "RectifiedLinearComponent"; }

682 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
Reùif›dLš—rCompÚ’t
(*
this
); }

683 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

684 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

685 
usšg
 
	gCompÚ’t
::
Prİag©e
;

686 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

687 cÚ¡ 
ChunkInfo
 &
out_šfo
,

688 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

689 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

690 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

691 cÚ¡ 
ChunkInfo
 &
out_šfo
,

692 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

693 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

694 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

695 
CompÚ’t
 *
to_upd©e
,

696 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

697 
	g´iv©e
:

698 
Reùif›dLš—rCompÚ’t
 &
İ”©Ü
 = (cÚ¡ Reùif›dLš—rCompÚ’ˆ&
Ùh”
);

701 şas 
	cSoáHšgeCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

702 
public
:

703 
ex¶ic™
 
SoáHšgeCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

704 
ex¶ic™
 
SoáHšgeCompÚ’t
(cÚ¡ SoáHšgeCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

705 
SoáHšgeCompÚ’t
() { }

706 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "SoftHingeComponent"; }

707 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
SoáHšgeCompÚ’t
(*
this
); }

708 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

709 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

710 
usšg
 
	gCompÚ’t
::
Prİag©e
;

711 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

712 cÚ¡ 
ChunkInfo
 &
out_šfo
,

713 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

714 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

715 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

716 cÚ¡ 
ChunkInfo
 &
out_šfo
,

717 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

718 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

719 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

720 
CompÚ’t
 *
to_upd©e
,

721 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

722 
	g´iv©e
:

723 
SoáHšgeCompÚ’t
 &
İ”©Ü
 = (cÚ¡ SoáHšgeCompÚ’ˆ&
Ùh”
);

730 şas 
	cSÿËCompÚ’t
: 
public
 
CompÚ’t
 {

731 
public
:

732 
ex¶ic™
 
SÿËCompÚ’t
(
št32
 
dim
, 
Ba£Flßt
 
sÿË
): 
dim_
(dim), 
sÿË_
(scale) { }

733 
ex¶ic™
 
SÿËCompÚ’t
(cÚ¡ SÿËCompÚ’ˆ&
Ùh”
):

734 
dim_
(
Ùh”
.dim_), 
sÿË_
(other.scale_) { }

735 
SÿËCompÚ’t
(): 
dim_
(0), 
sÿË_
(0.0) { }

736 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "ScaleComponent"; }

737 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
SÿËCompÚ’t
(*
this
); }

738 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

739 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

740 
usšg
 
	gCompÚ’t
::
Prİag©e
;

741 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

742 cÚ¡ 
ChunkInfo
 &
out_šfo
,

743 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

744 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

745 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

746 cÚ¡ 
ChunkInfo
 &
out_šfo
,

747 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

748 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

749 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

750 
CompÚ’t
 *
to_upd©e
,

751 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

753 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

754 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdim_
; }

755 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

757 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

759 
In™
(
št32
 
dim
, 
Ba£Flßt
 
sÿË
);

761 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

763 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

765 
	g´iv©e
:

766 
št32
 
dim_
;

767 
Ba£Flßt
 
	gsÿË_
;

768 
	gSÿËCompÚ’t
 &
	gİ”©Ü
 = (cÚ¡ 
SÿËCompÚ’t
 &
Ùh”
);

773 
şass
 
	gSumGroupCompÚ’t
;

774 
şass
 
	gAffšeCompÚ’t
;

775 
şass
 
	gFixedSÿËCompÚ’t
;

777 şas 
	cSoámaxCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

778 
public
:

779 
ex¶ic™
 
SoámaxCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

780 
ex¶ic™
 
SoámaxCompÚ’t
(cÚ¡ SoámaxCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

781 
SoámaxCompÚ’t
() { }

782 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "SoftmaxComponent"; }

783 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

784 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

785 
usšg
 
	gCompÚ’t
::
Prİag©e
;

786 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

787 cÚ¡ 
ChunkInfo
 &
out_šfo
,

788 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

789 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

790 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

791 cÚ¡ 
ChunkInfo
 &
out_šfo
,

792 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

793 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

794 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

795 
CompÚ’t
 *
to_upd©e
,

796 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

798 
MixUp
(
št32
 
num_mixtu»s
,

799 
Ba£Flßt
 
pow”
,

800 
Ba£Flßt
 
mš_couÁ
,

801 
Ba£Flßt
 
³¹urb_¡ddev
,

802 
AffšeCompÚ’t
 *
ac
,

803 
SumGroupCompÚ’t
 *
sc
);

805 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
SoámaxCompÚ’t
(*
this
); }

806 
	g´iv©e
:

807 
SoámaxCompÚ’t
 &
İ”©Ü
 = (cÚ¡ SoámaxCompÚ’ˆ&
Ùh”
);

810 şas 
	cLogSoámaxCompÚ’t
: 
public
 
NÚlš—rCompÚ’t
 {

811 
public
:

812 
ex¶ic™
 
LogSoámaxCompÚ’t
(
št32
 
dim
): 
NÚlš—rCompÚ’t
(dim) { }

813 
ex¶ic™
 
LogSoámaxCompÚ’t
(cÚ¡ LogSoámaxCompÚ’ˆ&
Ùh”
): 
NÚlš—rCompÚ’t
(other) { }

814 
LogSoámaxCompÚ’t
() { }

815 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "LogSoftmaxComponent"; }

816 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

817 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

818 
usšg
 
	gCompÚ’t
::
Prİag©e
;

819 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

820 cÚ¡ 
ChunkInfo
 &
out_šfo
,

821 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

822 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

823 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

824 cÚ¡ 
ChunkInfo
 &
out_šfo
,

825 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

826 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

827 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

828 
CompÚ’t
 *
to_upd©e
,

829 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

831 
vœtu®
 
CompÚ’t
* 
Cİy
(ècÚ¡ {  
Ãw
 
LogSoámaxCompÚ’t
(*
this
); }

832 
	g´iv©e
:

833 
LogSoámaxCompÚ’t
 &
İ”©Ü
 = (cÚ¡ LogSoámaxCompÚ’ˆ&
Ùh”
);

837 
şass
 
	gFixedAffšeCompÚ’t
;

843 şas 
	cAffšeCompÚ’t
: 
public
 
Upd©abËCompÚ’t
 {

844 
ä›nd
 
şass
 
SoámaxCompÚ’t
;

845 
	gpublic
:

846 
AffšeCompÚ’t
(cÚ¡ AffšeCompÚ’ˆ&
Ùh”
);

848 
AffšeCompÚ’t
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
lš—r_·¿ms
,

849 cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
bŸs_·¿ms
,

850 
Ba£Flßt
 
Ë¬nšg_¿‹
);

852 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	glš—r_·¿ms_
.
NumCŞs
(); }

853 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	glš—r_·¿ms_
.
NumRows
(); }

854 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

855 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

856 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
);

857 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

858 
¡d
::
¡ršg
 
m©rix_f’ame
);

862 
vœtu®
 
Resize
(
št32
 
šput_dim
, iÁ32 
ouut_dim
);

868 
CompÚ’t
 *
CŞÏp£W™hNext
(cÚ¡ 
AffšeCompÚ’t
 &
Ãxt
) const ;

869 
CompÚ’t
 *
CŞÏp£W™hNext
(cÚ¡ 
FixedAffšeCompÚ’t
 &
Ãxt
) const;

870 
CompÚ’t
 *
CŞÏp£W™hNext
(cÚ¡ 
FixedSÿËCompÚ’t
 &
Ãxt
) const;

871 
CompÚ’t
 *
CŞÏp£W™hP»vious
(cÚ¡ 
FixedAffšeCompÚ’t
 &
´ev
) const;

873 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

874 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

876 
AffšeCompÚ’t
(): 
is_g¿d›Á_
(
çl£
) { }

877 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "AffineComponent"; }

878 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

879 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

880 
usšg
 
	gCompÚ’t
::
Prİag©e
;

881 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

882 cÚ¡ 
ChunkInfo
 &
out_šfo
,

883 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

884 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

885 
vœtu®
 
SÿË
(
Ba£Flßt
 
sÿË
);

886 
vœtu®
 
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
);

887 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

888 cÚ¡ 
ChunkInfo
 &
out_šfo
,

889 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

890 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

891 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

892 
CompÚ’t
 *
to_upd©e
,

893 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

894 
vœtu®
 
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
);

895 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

896 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

897 
vœtu®
 
Ba£Flßt
 
DÙProduù
(cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
) const;

898 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

899 
vœtu®
 
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
);

901 
vœtu®
 
S‘P¬ams
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
bŸs
,

902 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
lš—r
);

903 cÚ¡ 
	gCuVeùÜ
<
	gBa£Flßt
> &
BŸsP¬ams
(è{  
	gbŸs_·¿ms_
; }

904 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
Lš—rP¬ams
(è{  
	glš—r_·¿ms_
; }

906 
vœtu®
 
št32
 
G‘P¬am‘”Dim
() const;

907 
vœtu®
 
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
) const;

908 
vœtu®
 
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
);

912 
vœtu®
 
Lim™Rªk
(
št32
 
dim’siÚ
,

913 
AffšeCompÚ’t
 **
a
, AffšeCompÚ’ˆ**
b
) const;

916 
Wid’
(
št32
 
Ãw_dim’siÚ
,

917 
Ba£Flßt
 
·¿m_¡ddev
,

918 
Ba£Flßt
 
bŸs_¡ddev
,

919 
¡d
::
veùÜ
<
NÚlš—rCompÚ’t
*> 
c2
,

921 
AffšeCompÚ’t
 *
c3
);

922 
	g´Ùeùed
:

923 
ä›nd
 
şass
 
AffšeCompÚ’tP»cÚd™iÚedOÆše
;

925 
vœtu®
 
Upd©e
(

926 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

927 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

928 
Upd©eSim¶e
(
š_v®ue
, 
out_d”iv
);

932 
vœtu®
 
Upd©eSim¶e
(

933 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

934 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
);

936 cÚ¡ 
	gAffšeCompÚ’t
 &
	gİ”©Ü
 = (cÚ¡ 
AffšeCompÚ’t
 &
Ùh”
);

937 
	gCuM©rix
<
	gBa£Flßt
> 
	glš—r_·¿ms_
;

938 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gbŸs_·¿ms_
;

940 
boŞ
 
	gis_g¿d›Á_
;

948 şas 
	cAffšeCompÚ’tP»cÚd™iÚed
: 
public
 
AffšeCompÚ’t
 {

949 
public
:

950 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "AffineComponentPreconditioned"; }

952 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

953 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

954 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

955 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

956 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
,

957 
Ba£Flßt
 
®pha
, Ba£Flßˆ
max_chªge
);

958 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
, Ba£Flßˆ
®pha
,

959 
Ba£Flßt
 
max_chªge
, 
¡d
::
¡ršg
 
m©rix_f’ame
);

961 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

962 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

963 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

964 
AffšeCompÚ’tP»cÚd™iÚed
(): 
®pha_
(1.0), 
max_chªge_
(0.0) { }

965 
S‘MaxChªge
(
Ba£Flßt
 
max_chªge
è{ 
	gmax_chªge_
 = max_change; }

966 
	g´Ùeùed
:

967 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
AffšeCompÚ’tP»cÚd™iÚed
);

968 
Ba£Flßt
 
	g®pha_
;

969 
Ba£Flßt
 
	gmax_chªge_
;

982 
Ba£Flßt
 
G‘SÿlšgFaùÜ
(cÚ¡ 
CuM©rix
<Ba£Flßt> &
š_v®ue_´ecÚ
,

983 cÚ¡ 
CuM©rix
<
Ba£Flßt
> &
out_d”iv_´ecÚ
);

985 
vœtu®
 
Upd©e
(

986 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

987 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
);

997 şas 
	cAffšeCompÚ’tP»cÚd™iÚedOÆše
: 
public
 
AffšeCompÚ’t
 {

998 
public
:

999 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {

1003 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1004 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1005 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1006 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1007 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
,

1008 
št32
 
¿nk_š
, iÁ32 
¿nk_out
, iÁ32 
upd©e_³riod
,

1009 
Ba£Flßt
 
num_§m¶es_hi¡Üy
, Ba£Flßˆ
®pha
,

1010 
Ba£Flßt
 
max_chªge_³r_§m¶e
);

1011 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
, 
št32
 
¿nk_š
,

1012 
št32
 
¿nk_out
, iÁ32 
upd©e_³riod
,

1013 
Ba£Flßt
 
num_§m¶es_hi¡Üy
,

1014 
Ba£Flßt
 
®pha
, Ba£Flßˆ
max_chªge_³r_§m¶e
,

1015 
¡d
::
¡ršg
 
m©rix_f’ame
);

1017 
vœtu®
 
Resize
(
št32
 
šput_dim
, iÁ32 
ouut_dim
);

1022 
AffšeCompÚ’tP»cÚd™iÚedOÆše
(cÚ¡ 
AffšeCompÚ’t
 &
Üig
,

1023 
št32
 
¿nk_š
, iÁ32 
¿nk_out
,

1024 
št32
 
upd©e_³riod
,

1025 
Ba£Flßt
 
‘a
, Ba£Flßˆ
®pha
);

1027 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1028 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1029 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1030 
AffšeCompÚ’tP»cÚd™iÚedOÆše
(): 
max_chªge_³r_§m¶e_
(0.0) { }

1032 
´iv©e
:

1033 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
AffšeCompÚ’tP»cÚd™iÚedOÆše
);

1038 
št32
 
	g¿nk_š_
;

1039 
št32
 
	g¿nk_out_
;

1040 
št32
 
	gupd©e_³riod_
;

1041 
Ba£Flßt
 
	gnum_§m¶es_hi¡Üy_
;

1042 
Ba£Flßt
 
	g®pha_
;

1044 
OÆšeP»cÚd™iÚ”
 
	g´ecÚd™iÚ”_š_
;

1046 
OÆšeP»cÚd™iÚ”
 
	g´ecÚd™iÚ”_out_
;

1048 
Ba£Flßt
 
	gmax_chªge_³r_§m¶e_
;

1067 
Ba£Flßt
 
G‘SÿlšgFaùÜ
(cÚ¡ 
CuVeùÜBa£
<Ba£Flßt> &
š_´oduùs
,

1068 
Ba£Flßt
 
gamma_´od
,

1069 
CuVeùÜBa£
<
Ba£Flßt
> *
out_´oduùs
);

1073 
S‘P»cÚd™iÚ”CÚfigs
();

1075 
vœtu®
 
Upd©e
(

1076 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1077 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
);

1080 şas 
	cRªdomCompÚ’t
: 
public
 
CompÚ’t
 {

1081 
public
:

1086 
Re£tG’”©Ü
(è{ 
¿ndom_g’”©Ü_
.
S“dGpu
(); }

1087 
	g´Ùeùed
:

1088 
CuRªd
<
Ba£Flßt
> 
¿ndom_g’”©Ü_
;

1092 şas 
	cS¶iûCompÚ’t
: 
public
 
CompÚ’t
 {

1093 
public
:

1094 
S¶iûCompÚ’t
() { }

1098 
In™
(
št32
 
šput_dim
,

1099 
¡d
::
veùÜ
<
št32
> 
cÚ‹xt
,

1100 
št32
 
cÚ¡_compÚ’t_dim
=0);

1101 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "SpliceComponent"; }

1102 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1103 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1104 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gšput_dim_
; }

1105 
vœtu®
 
št32
 
OuutDim
() const;

1106 
vœtu®
 
	g¡d
::
veùÜ
<
št32
> 
CÚ‹xt
(ècÚ¡ {  
cÚ‹xt_
; }

1107 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1108 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1109 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1110 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1111 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1112 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1113 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1114 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1115 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1116 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1117 
CompÚ’t
 *
to_upd©e
,

1118 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1119 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1120 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1121 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1122 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1123 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1124 
	g´iv©e
:

1125 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
S¶iûCompÚ’t
);

1126 
št32
 
	gšput_dim_
;

1127 
	g¡d
::
veùÜ
<
št32
> 
cÚ‹xt_
;

1128 
št32
 
	gcÚ¡_compÚ’t_dim_
;

1133 şas 
	cS¶iûMaxCompÚ’t
: 
public
 
CompÚ’t
 {

1134 
public
:

1135 
S¶iûMaxCompÚ’t
() { }

1136 
In™
(
št32
 
dim
,

1137 
¡d
::
veùÜ
<
št32
> 
cÚ‹xt
);

1138 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "SpliceMaxComponent"; }

1139 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1140 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1141 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

1142 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdim_
; }

1143 
vœtu®
 
	g¡d
::
veùÜ
<
št32
> 
CÚ‹xt
(ècÚ¡ {  
cÚ‹xt_
; }

1144 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1145 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1146 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1147 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1148 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1149 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1150 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1151 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1152 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1153 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1154 
CompÚ’t
 *
to_upd©e
,

1155 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1156 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

1157 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1158 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1159 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1160 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1161 
	g´iv©e
:

1162 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
S¶iûMaxCompÚ’t
);

1163 
št32
 
	gdim_
;

1164 
	g¡d
::
veùÜ
<
št32
> 
cÚ‹xt_
;

1171 şas 
	cBlockAffšeCompÚ’t
: 
public
 
Upd©abËCompÚ’t
 {

1172 
public
:

1173 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
lš—r_·¿ms_
.
NumCŞs
(è* 
num_blocks_
; }

1174 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	glš—r_·¿ms_
.
NumRows
(); }

1175 
vœtu®
 
št32
 
G‘P¬am‘”Dim
() const;

1176 
vœtu®
 
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
) const;

1177 
vœtu®
 
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
);

1180 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1181 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1182 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
,

1183 
št32
 
num_blocks
);

1184 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1186 
BlockAffšeCompÚ’t
() { }

1187 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "BlockAffineComponent"; }

1188 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

1189 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1190 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1191 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1192 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1193 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1194 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1195 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1196 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1197 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1198 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1199 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1200 
CompÚ’t
 *
to_upd©e
,

1201 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1202 
vœtu®
 
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
);

1203 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1204 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1205 
vœtu®
 
Ba£Flßt
 
DÙProduù
(cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
) const;

1206 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1207 
vœtu®
 
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
);

1208 
vœtu®
 
SÿË
(
Ba£Flßt
 
sÿË
);

1209 
vœtu®
 
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
);

1210 
	g´Ùeùed
:

1211 
vœtu®
 
Upd©e
(

1212 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1213 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
) {

1214 
Upd©eSim¶e
(
š_v®ue
, 
out_d”iv
);

1218 
vœtu®
 
Upd©eSim¶e
(

1219 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1220 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
);

1230 
	gCuM©rix
<
	gBa£Flßt
> 
	glš—r_·¿ms_
;

1231 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gbŸs_·¿ms_
;

1232 
št32
 
	gnum_blocks_
;

1233 
	g´iv©e
:

1234 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
BlockAffšeCompÚ’t
);

1242 şas 
	cBlockAffšeCompÚ’tP»cÚd™iÚed
: 
public
 
BlockAffšeCompÚ’t
 {

1243 
public
:

1245 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1246 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1247 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
,

1248 
št32
 
num_blocks
, 
Ba£Flßt
 
®pha
);

1250 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1252 
BlockAffšeCompÚ’tP»cÚd™iÚed
() { }

1253 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "BlockAffineComponentPreconditioned"; }

1254 
vœtu®
 
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
);

1255 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1256 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1257 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1258 
	g´iv©e
:

1259 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
BlockAffšeCompÚ’tP»cÚd™iÚed
);

1260 
vœtu®
 
Upd©e
(

1261 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1262 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
);

1264 
boŞ
 
	gis_g¿d›Á_
;

1265 
Ba£Flßt
 
	g®pha_
;

1274 şas 
	cSumGroupCompÚ’t
: 
public
 
CompÚ’t
 {

1275 
public
:

1276 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
šput_dim_
; }

1277 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gouut_dim_
; }

1278 
In™
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
sizes
);

1280 
G‘Sizes
(
¡d
::
veùÜ
<
št32
> *
sizes
) const;

1283 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1284 
SumGroupCompÚ’t
() { }

1285 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "SumGroupComponent"; }

1286 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1287 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1288 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1289 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1290 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1291 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1292 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1294 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1295 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1296 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1297 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1298 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1299 
CompÚ’t
 *
to_upd©e
,

1300 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1301 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1302 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1303 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1305 
	g´iv©e
:

1306 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
SumGroupCompÚ’t
);

1309 
	gCuA¼ay
<
	gIÁ32Paœ
> 
	gšdexes_
;

1311 
	gCuA¼ay
<
	gšt32
> 
	g»v”£_šdexes_
;

1312 
št32
 
	gšput_dim_
;

1313 
št32
 
	gouut_dim_
;

1320 şas 
	cP”mu‹CompÚ’t
: 
public
 
CompÚ’t
 {

1321 
public
:

1322 
In™
(
št32
 
dim
);

1323 
In™
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
»Üd”
);

1324 
P”mu‹CompÚ’t
(
št32
 
dim
è{ 
In™
(dim); }

1325 
P”mu‹CompÚ’t
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
»Üd”
è{ 
In™
(reorder); }

1327 
P”mu‹CompÚ’t
() { }

1329 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	g»Üd”_
.
size
(); }

1330 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	g»Üd”_
.
size
(); }

1331 
vœtu®
 
CompÚ’t
 *
Cİy
() const;

1333 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1334 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1335 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1336 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "PermuteComponent"; }

1337 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1338 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1339 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1340 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1341 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1342 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1343 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1344 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1345 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1346 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1347 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1348 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1349 
CompÚ’t
 *
to_upd©e
,

1350 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1352 
	g´iv©e
:

1353 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
P”mu‹CompÚ’t
);

1354 
	g¡d
::
veùÜ
<
št32
> 
»Üd”_
;

1361 şas 
	cDùCompÚ’t
: 
public
 
CompÚ’t
 {

1362 
public
:

1363 
DùCompÚ’t
(è{ 
dim_
 = 0; }

1364 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "DctComponent"; }

1365 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1368 
In™
(
št32
 
dim
, iÁ32 
dù_dim
, 
boŞ
 
»Üd”
, iÁ32 
k“p_dù_dim
=0);

1372 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1373 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

1374 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdù_m©_
.
NumRows
(è* (
	gdim_
 / dù_m©_.
NumCŞs
()); }

1375 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1376 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1377 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1378 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1379 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1380 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1381 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1382 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1383 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1384 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1385 
CompÚ’t
 *
to_upd©e
,

1386 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1387 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1388 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1389 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1390 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1391 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1392 
	g´iv©e
:

1393 
ReÜd”
(
CuM©rixBa£
<
Ba£Flßt
> *
m©
, 
boŞ
 
»v”£
) const;

1394 
št32
 
	gdim_
;

1396 
boŞ
 
	g»Üd”_
;

1405 
	gCuM©rix
<
	gBa£Flßt
> 
	gdù_m©_
;

1407 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
DùCompÚ’t
);

1413 şas 
	cFixedLš—rCompÚ’t
: 
public
 
CompÚ’t
 {

1414 
public
:

1415 
FixedLš—rCompÚ’t
() { }

1416 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "FixedLinearComponent"; }

1417 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1419 
In™
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
m©rix
è{ 
	gm©_
 = matrix; }

1423 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1425 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gm©_
.
NumCŞs
(); }

1426 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gm©_
.
NumRows
(); }

1427 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1428 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1429 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1430 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1431 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1432 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1433 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1434 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1435 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1436 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1437 
CompÚ’t
 *
to_upd©e
,

1438 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1439 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1440 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1441 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1442 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1443 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1444 
	g´Ùeùed
:

1445 
ä›nd
 
şass
 
AffšeCompÚ’t
;

1446 
	gCuM©rix
<
	gBa£Flßt
> 
	gm©_
;

1448 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
FixedLš—rCompÚ’t
);

1454 şas 
	cFixedAffšeCompÚ’t
: 
public
 
CompÚ’t
 {

1455 
public
:

1456 
FixedAffšeCompÚ’t
() { }

1457 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "FixedAffineComponent"; }

1458 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1461 
In™
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
m©rix
);

1465 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1467 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	glš—r_·¿ms_
.
NumCŞs
(); }

1468 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	glš—r_·¿ms_
.
NumRows
(); }

1469 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1470 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1471 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1472 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1473 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1474 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1475 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1476 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1477 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1478 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1479 
CompÚ’t
 *
to_upd©e
,

1480 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1481 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1482 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1483 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1484 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1485 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1488 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
Lš—rP¬ams
(ècÚ¡ {  
	glš—r_·¿ms_
; }

1489 
	g´Ùeùed
:

1490 
ä›nd
 
şass
 
AffšeCompÚ’t
;

1491 
	gCuM©rix
<
	gBa£Flßt
> 
	glš—r_·¿ms_
;

1492 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gbŸs_·¿ms_
;

1494 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
FixedAffšeCompÚ’t
);

1501 şas 
	cFixedSÿËCompÚ’t
: 
public
 
CompÚ’t
 {

1502 
public
:

1503 
FixedSÿËCompÚ’t
() { }

1504 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "FixedScaleComponent"; }

1505 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1507 
In™
(cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
sÿËs
);

1511 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1513 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gsÿËs_
.
Dim
(); }

1514 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gsÿËs_
.
Dim
(); }

1515 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1516 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1517 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1518 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1519 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1520 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1521 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1522 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1523 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1524 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1525 
CompÚ’t
 *
to_upd©e
,

1526 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1527 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1528 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1529 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1530 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1531 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1533 
	g´Ùeùed
:

1534 
ä›nd
 
şass
 
AffšeCompÚ’t
;

1535 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gsÿËs_
;

1536 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
FixedSÿËCompÚ’t
);

1542 şas 
	cFixedBŸsCompÚ’t
: 
public
 
CompÚ’t
 {

1543 
public
:

1544 
FixedBŸsCompÚ’t
() { }

1545 
vœtu®
 
¡d
::
¡ršg
 
Ty³
() const {  "FixedBiasComponent"; }

1546 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1548 
In™
(cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
sÿËs
);

1552 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1554 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gbŸs_
.
Dim
(); }

1555 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gbŸs_
.
Dim
(); }

1556 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1557 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1558 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1559 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1560 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1561 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1562 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1563 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1564 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1565 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1566 
CompÚ’t
 *
to_upd©e
,

1567 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const ;

1568 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1569 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1570 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1571 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1572 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1574 
	g´Ùeùed
:

1575 
CuVeùÜ
<
Ba£Flßt
> 
bŸs_
;

1576 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
FixedBŸsCompÚ’t
);

1584 şas 
	cDrİoutCompÚ’t
: 
public
 
RªdomCompÚ’t
 {

1585 
public
:

1592 
In™
(
št32
 
dim
,

1593 
Ba£Flßt
 
drİout_´İÜtiÚ
 = 0.5,

1594 
Ba£Flßt
 
drİout_sÿË
 = 0.0);

1595 
DrİoutCompÚ’t
(
št32
 
dim
, 
Ba£Flßt
 
dp
 = 0.5, Ba£Flßˆ
sc
 = 0.0) {

1596 
In™
(
dim
, 
dp
, 
sc
);

1598 
DrİoutCompÚ’t
(): 
dim_
(0), 
drİout_´İÜtiÚ_
(0.5) { }

1599 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

1600 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdim_
; }

1601 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1603 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1605 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1607 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "DropoutComponent"; }

1609 
S‘DrİoutSÿË
(
Ba£Flßt
 
sÿË
è{ 
	gdrİout_sÿË_
 = scale; }

1610 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

1611 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gŒue
; }

1612 
vœtu®
 
CompÚ’t
* 
Cİy
() const;

1613 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1614 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1615 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1616 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1617 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1618 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1619 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1620 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1621 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1622 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1623 
CompÚ’t
 *
to_upd©e
,

1624 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1625 
vœtu®
 
	g¡d
::
¡ršg
 
Info
() const;

1626 
	g´iv©e
:

1627 
št32
 
dim_
;

1628 
Ba£Flßt
 
	gdrİout_´İÜtiÚ_
;

1629 
Ba£Flßt
 
	gdrİout_sÿË_
;

1635 şas 
	cAdd™iveNoi£CompÚ’t
: 
public
 
RªdomCompÚ’t
 {

1636 
public
:

1637 
In™
(
št32
 
dim
, 
Ba£Flßt
 
noi£_¡ddev
);

1638 
Add™iveNoi£CompÚ’t
(
št32
 
dim
, 
Ba£Flßt
 
¡ddev
è{ 
In™
(dim, stddev); }

1639 
Add™iveNoi£CompÚ’t
(): 
dim_
(0), 
¡ddev_
(1.0) { }

1640 
vœtu®
 
št32
 
IÅutDim
(ècÚ¡ {  
	gdim_
; }

1641 
vœtu®
 
št32
 
OuutDim
(ècÚ¡ {  
	gdim_
; }

1642 
vœtu®
 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1644 
vœtu®
 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1646 
vœtu®
 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1648 
vœtu®
 
	g¡d
::
¡ršg
 
Ty³
() const {  "AdditiveNoiseComponent"; }

1650 
vœtu®
 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gçl£
; }

1651 
vœtu®
 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1652 
vœtu®
 
CompÚ’t
* 
Cİy
() const {

1653  
Ãw
 
Add™iveNoi£CompÚ’t
(
dim_
, 
¡ddev_
);

1655 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1656 
vœtu®
 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1657 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1658 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1659 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1660 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1661 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1662 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1663 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1664 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1665 
CompÚ’t
 *
to_upd©e
,

1666 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
ècÚ¡ { *
	gš_d”iv
 = 
out_d”iv
; }

1667 
	g´iv©e
:

1668 
št32
 
dim_
;

1669 
Ba£Flßt
 
	g¡ddev_
;

1718 şas 
	cCÚvŞutiÚ®1dCompÚ’t
: 
public
 
Upd©abËCompÚ’t
 {

1719 
public
:

1720 
CÚvŞutiÚ®1dCompÚ’t
();

1722 
CÚvŞutiÚ®1dCompÚ’t
(cÚ¡ CÚvŞutiÚ®1dCompÚ’ˆ&
compÚ’t
);

1724 
CÚvŞutiÚ®1dCompÚ’t
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
f‹r_·¿ms
,

1725 cÚ¡ 
CuVeùÜBa£
<
Ba£Flßt
> &
bŸs_·¿ms
,

1726 
Ba£Flßt
 
Ë¬nšg_¿‹
);

1728 
št32
 
IÅutDim
() const;

1729 
št32
 
OuutDim
() const;

1730 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
, 
št32
 
šput_dim
, iÁ32 
ouut_dim
,

1731 
št32
 
·tch_dim
, iÁ32 
·tch_¡•
, iÁ32 
·tch_¡ride
,

1732 
Ba£Flßt
 
·¿m_¡ddev
, Ba£Flßˆ
bŸs_¡ddev
, 
boŞ
 
­³nded_cÚv
);

1733 
In™
(
Ba£Flßt
 
Ë¬nšg_¿‹
,

1734 
št32
 
·tch_dim
, iÁ32 
·tch_¡•
, iÁ32 
·tch_¡ride
,

1735 
¡d
::
¡ršg
 
m©rix_f’ame
, 
boŞ
 
­³nded_cÚv
);

1739 
Resize
(
št32
 
šput_dim
, iÁ32 
ouut_dim
);

1740 
	g¡d
::
¡ršg
 
Info
() const;

1741 
In™FromSŒšg
(
¡d
::
¡ršg
 
¬gs
);

1742 
	g¡d
::
¡ršg
 
Ty³
() const {  "Convolutional1dComponent"; }

1743 
boŞ
 
Back´İN“dsIÅut
(ècÚ¡ {  
	gŒue
; }

1744 
boŞ
 
Back´İN“dsOuut
(ècÚ¡ {  
	gçl£
; }

1745 
usšg
 
	gCompÚ’t
::
Prİag©e
;

1746 
Prİag©e
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1747 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1748 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š
,

1749 
CuM©rixBa£
<
Ba£Flßt
> *
out
) const;

1750 
SÿË
(
Ba£Flßt
 
sÿË
);

1751 
vœtu®
 
Add
(
Ba£Flßt
 
®pha
, cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
);

1752 
vœtu®
 
Back´İ
(cÚ¡ 
ChunkInfo
 &
š_šfo
,

1753 cÚ¡ 
ChunkInfo
 &
out_šfo
,

1754 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1755 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_v®ue
,

1756 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
,

1757 
CompÚ’t
 *
to_upd©e_š
,

1758 
CuM©rix
<
Ba£Flßt
> *
š_d”iv
) const;

1759 
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
);

1760 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

1761 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

1762 
vœtu®
 
Ba£Flßt
 
DÙProduù
(cÚ¡ 
Upd©abËCompÚ’t
 &
Ùh”
) const;

1763 
CompÚ’t
* 
Cİy
() const;

1764 
P”turbP¬ams
(
Ba£Flßt
 
¡ddev
);

1765 
S‘P¬ams
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
bŸs
,

1766 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
f‹r
);

1767 cÚ¡ 
	gCuVeùÜ
<
	gBa£Flßt
> &
BŸsP¬ams
(è{  
	gbŸs_·¿ms_
; }

1768 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
Lš—rP¬ams
(è{  
	gf‹r_·¿ms_
; }

1769 
št32
 
G‘P¬am‘”Dim
() const;

1770 
Upd©e
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
š_v®ue
,

1771 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
out_d”iv
);

1773 
	g´iv©e
:

1774 
št32
 
·tch_dim_
;

1775 
št32
 
	g·tch_¡•_
;

1776 
št32
 
	g·tch_¡ride_
;

1778 
Rev”£Indexes
(cÚ¡ 
¡d
::
veùÜ
<
št32
> &
fÜw¬d_šdexes
,

1779 
št32
 
šput_dim
,

1780 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > *
backw¬d_šdexes
);

1781 
R—¼ªgeIndexes
(cÚ¡ 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > &
š
,

1782 
¡d
::
veùÜ
<¡d::veùÜ<
št32
> > *
out
);

1784 cÚ¡ 
	gCÚvŞutiÚ®1dCompÚ’t
 &
	gİ”©Ü
 = (cÚ¡ 
CÚvŞutiÚ®1dCompÚ’t
 &
Ùh”
);

1785 
	gCuM©rix
<
	gBa£Flßt
> 
	gf‹r_·¿ms_
;

1786 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gbŸs_·¿ms_
;

1789 
boŞ
 
	g­³nded_cÚv_
;

1790 
boŞ
 
	gis_g¿d›Á_
;

1797 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

1798 
št32
 *
·¿m
);

1800 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

1801 
Ba£Flßt
 *
·¿m
);

1804 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

1805 
¡d
::
veùÜ
<
št32
> *
·¿m
);

1808 
boŞ
 
P¬£FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::string *string,

1809 
boŞ
 *
·¿m
);

	@nnet-compute-discriminative-parallel.cc

20 
	~<deque
>

21 
	~<mu‹x
>

22 
	~"Â‘2/Â‘-compu‹-disüimš©ive-·¿Î–.h
"

23 
	~"hmm/po¡”iÜ.h
"

24 
	~"Ït/Ï‰iû-funùiÚs.h
"

25 
	~"ut/k®di-£m­hÜe.h
"

26 
	~"ut/k®di-th»ad.h
"

28 
Çme¥aû
 
	gk®di
 {

29 
Çme¥aû
 
	gÂ‘2
 {

33 şas 
	cDisüimš©iveExam¶esR•os™Üy
 {

34 
	gpublic
:

36 
Acû±Exam¶e
(cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
exam¶e
);

41 
Exam¶esDÚe
();

47 
Disüimš©iveNÃtExam¶e
 *
ProvideExam¶e
();

49 
Disüimš©iveExam¶esR•os™Üy
(): 
bufãr_size_
(4),

50 
em±y_£m­hÜe_
(
bufãr_size_
),

51 
dÚe_
(
çl£
) { }

52 
	g´iv©e
:

53 
št32
 
bufãr_size_
;

54 
Sem­hÜe
 
	gfuÎ_£m­hÜe_
;

55 
Sem­hÜe
 
	gem±y_£m­hÜe_
;

56 
	g¡d
::
mu‹x
 
exam¶es_mu‹x_
;

58 
	g¡d
::
deque
<
Disüimš©iveNÃtExam¶e
*> 
exam¶es_
;

59 
boŞ
 
	gdÚe_
;

60 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
Disüimš©iveExam¶esR•os™Üy
);

64 
	gDisüimš©iveExam¶esR•os™Üy
::
Acû±Exam¶e
(

65 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
exam¶e
) {

66 
em±y_£m­hÜe_
.
Wa™
();

67 
	gexam¶es_mu‹x_
.
lock
();

68 
	gexam¶es_
.
push_back
(
Ãw
 
Disüimš©iveNÃtExam¶e
(
exam¶e
));

69 
	gexam¶es_mu‹x_
.
uÆock
();

70 
	gfuÎ_£m­hÜe_
.
SigÇl
();

73 
	gDisüimš©iveExam¶esR•os™Üy
::
Exam¶esDÚe
() {

74 
št32
 
i
 = 0; 
	gi
 < 
	gbufãr_size_
; i++)

75 
	gem±y_£m­hÜe_
.
Wa™
();

76 
	gexam¶es_mu‹x_
.
lock
();

77 
KALDI_ASSERT
(
exam¶es_
.
em±y
());

78 
	gexam¶es_mu‹x_
.
uÆock
();

79 
	gdÚe_
 = 
Œue
;

80 
	gfuÎ_£m­hÜe_
.
SigÇl
();

83 
Disüimš©iveNÃtExam¶e
*

84 
	gDisüimš©iveExam¶esR•os™Üy
::
ProvideExam¶e
() {

85 
fuÎ_£m­hÜe_
.
Wa™
();

86 ià(
	gdÚe_
) {

87 
KALDI_ASSERT
(
exam¶es_
.
em±y
());

88 
	gfuÎ_£m­hÜe_
.
SigÇl
();

90  
	gNULL
;

92 
	gexam¶es_mu‹x_
.
lock
();

93 
KALDI_ASSERT
(!
exam¶es_
.
em±y
());

94 
Disüimš©iveNÃtExam¶e
 *
	gªs
 = 
exam¶es_
.
äÚt
();

95 
	gexam¶es_
.
pİ_äÚt
();

96 
	gexam¶es_mu‹x_
.
uÆock
();

97 
	gem±y_£m­hÜe_
.
SigÇl
();

98  
	gªs
;

103 şas 
	cDiscT¿šP¬®ËlCÏss
: 
public
 
MuÉiTh»adabË
 {

104 
public
:

107 
DiscT¿šP¬®ËlCÏss
(cÚ¡ 
AmNÃt
 &
am_Â‘
,

108 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

109 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

110 
boŞ
 
¡Üe_£·¿‹_g¿d›Ás
,

111 
Disüimš©iveExam¶esR•os™Üy
 *
»pos™Üy
,

112 
NÃt
 *
Â‘_to_upd©e
,

113 
NÃtDisüimš©iveSts
 *
¡©s
):

114 
am_Â‘_
(
am_Â‘
), 
tmod–_
(
tmod–
), 
İts_
(
İts
),

115 
¡Üe_£·¿‹_g¿d›Ás_
(
¡Üe_£·¿‹_g¿d›Ás
),

116 
»pos™Üy_
(
»pos™Üy
),

117 
Â‘_to_upd©e_
(
Â‘_to_upd©e
),

118 
Â‘_to_upd©e_Üig_
(
Â‘_to_upd©e
),

119 
¡©s_±r_
(
¡©s
) { }

123 
DiscT¿šP¬®ËlCÏss
(cÚ¡ DiscT¿šP¬®ËlCÏs &
Ùh”
):

124 
MuÉiTh»adabË
(
Ùh”
),

125 
am_Â‘_
(
Ùh”
.am_Â‘_), 
tmod–_
(Ùh”.tmod–_), 
İts_
(other.opts_),

126 
¡Üe_£·¿‹_g¿d›Ás_
(
Ùh”
.store_separate_gradients_),

127 
»pos™Üy_
(
Ùh”
.»pos™Üy_), 
Â‘_to_upd©e_
(other.nnet_to_update_),

128 
Â‘_to_upd©e_Üig_
(
Ùh”
.nnet_to_update_orig_),

129 
¡©s_±r_
(
Ùh”
.stats_ptr_) {

130 ià(
	g¡Üe_£·¿‹_g¿d›Ás_
) {

134 ià(
	gÙh”
.
	gÂ‘_to_upd©e_
 !ğ
NULL
) {

135 
Â‘_to_upd©e_
 = 
Ãw
 
NÃt
(*(
Ùh”
.nnet_to_update_));

141 
	gÂ‘_to_upd©e_
->
S‘Z”o
(
Œue
);

143 
	gÂ‘_to_upd©e_
 = 
NULL
;

148 
İ”©Ü
 () () {

149 
Disüimš©iveNÃtExam¶e
 *
	gexam¶e
;

150 (
	gexam¶e
 = 
»pos™Üy_
->
ProvideExam¶e
()è!ğ
NULL
) {

153 
NÃtDisüimš©iveUpd©e
(
am_Â‘_
, 
tmod–_
, 
İts_
,

154 *
exam¶e
, 
Â‘_to_upd©e_
, &
¡©s_
);

155 
d–‘e
 
	gexam¶e
;

157 ià(
G‘V”bo£Lev–
() > 3) {

158 
KALDI_VLOG
(3è<< "Prštšg†oÿÈ¡© fÜh»ad " << 
	gth»ad_id_
;

159 
	g¡©s_
.
Pršt
(
İts_
.
ü™”iÚ
);

164 ~
DiscT¿šP¬®ËlCÏss
() {

165 ià(
	gÂ‘_to_upd©e_Üig_
 !ğ
Â‘_to_upd©e_
) {

170 
Â‘_to_upd©e_Üig_
->
AddNÃt
(1.0, *
Â‘_to_upd©e_
);

171 
d–‘e
 
	gÂ‘_to_upd©e_
;

173 
	g¡©s_±r_
->
Add
(
¡©s_
);

175 
	g´iv©e
:

176 cÚ¡ 
AmNÃt
 &
am_Â‘_
;

177 cÚ¡ 
	gT¿ns™iÚMod–
 &
	gtmod–_
;

178 cÚ¡ 
	gNÃtDisüimš©iveUpd©eO±iÚs
 &
	gİts_
;

179 
boŞ
 
	g¡Üe_£·¿‹_g¿d›Ás_
;

180 
Disüimš©iveExam¶esR•os™Üy
 *
	g»pos™Üy_
;

181 
NÃt
 *
	gÂ‘_to_upd©e_
;

182 
NÃt
 *
	gÂ‘_to_upd©e_Üig_
;

183 
NÃtDisüimš©iveSts
 *
	g¡©s_±r_
;

184 
NÃtDisüimš©iveSts
 
	g¡©s_
;

189 
NÃtDisüimš©iveUpd©eP¬®Ël
(

190 cÚ¡ 
AmNÃt
 &
am_Â‘
,

191 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

192 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

193 
št32
 
num_th»ads
,

194 
Sequ’tŸlDisüimš©iveNÃtExam¶eR—d”
 *
exam¶e_»ad”
,

195 
NÃt
 *
Â‘_to_upd©e
,

196 
NÃtDisüimš©iveSts
 *
¡©s
) {

198 
Disüimš©iveExam¶esR•os™Üy
 
	g»pos™Üy
;

200 cÚ¡ 
boŞ
 
	g¡Üe_£·¿‹_g¿d›Ás
 = (
Â‘_to_upd©e
 !ğ&(
am_Â‘
.
G‘NÃt
()));

202 
DiscT¿šP¬®ËlCÏss
 
c
(
am_Â‘
, 
tmod–
, 
İts
,

203 
¡Üe_£·¿‹_g¿d›Ás
,

204 &
»pos™Üy
, 
Â‘_to_upd©e
, 
¡©s
);

209 
	gMuÉiTh»ad”
<
	gDiscT¿šP¬®ËlCÏss
> 
m
(
num_th»ads
, 
c
);

211 ; !
	gexam¶e_»ad”
->
DÚe
();ƒxam¶e_»ad”->
Next
()) {

212 
	g»pos™Üy
.
Acû±Exam¶e
(
exam¶e_»ad”
->
V®ue
());

214 
	g»pos™Üy
.
Exam¶esDÚe
();

216 
	g¡©s
->
Pršt
(
İts
.
ü™”iÚ
);

	@nnet-compute-discriminative-parallel.h

20 #iâdeà
KALDI_NNET2_NNET_COMPUTE_DISCRIMINATIVE_PARALLEL_H_


21 
	#KALDI_NNET2_NNET_COMPUTE_DISCRIMINATIVE_PARALLEL_H_


	)

23 
	~"Â‘2/am-Â‘.h
"

24 
	~"Â‘2/Â‘-exam¶e.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

26 
	~"Â‘2/Â‘-compu‹-disüimš©ive.h
"

28 
Çme¥aû
 
	gk®di
 {

29 
Çme¥aû
 
	gÂ‘2
 {

36 
NÃtDisüimš©iveUpd©eP¬®Ël
(

37 cÚ¡ 
AmNÃt
 &
am_Â‘
,

38 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

39 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

40 
št32
 
num_th»ads
,

41 
Sequ’tŸlDisüimš©iveNÃtExam¶eR—d”
 *
exam¶e_»ad”
,

42 
NÃt
 *
Â‘_to_upd©e
,

43 
NÃtDisüimš©iveSts
 *
¡©s
);

	@nnet-compute-discriminative.cc

20 
	~"Â‘2/Â‘-compu‹-disüimš©ive.h
"

21 
	~"hmm/po¡”iÜ.h
"

22 
	~"Ït/Ï‰iû-funùiÚs.h
"

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

32 şas 
	cNÃtDisüimš©iveUpd©”
 {

33 
	gpublic
:

35 
NÃtDisüimš©iveUpd©”
(cÚ¡ 
AmNÃt
 &
am_Â‘
,

36 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

37 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

38 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

39 
NÃt
 *
Â‘_to_upd©e
,

40 
NÃtDisüimš©iveSts
 *
¡©s
);

42 
Upd©e
() {

43 
Prİag©e
();

44 
L©tiûComputiÚs
();

45 ià(
	gÂ‘_to_upd©e_
 !ğ
NULL
)

46 
Back´İ
();

50 
Prİag©e
();

54 
L©tiûComputiÚs
();

56 
Back´İ
();

64 
G‘Disüimš©ivePo¡”iÜs
(
Po¡”iÜ
 *
po¡
);

66 
	gSubM©rix
<
	gBa£Flßt
> 
G‘IÅutF—tu»s
() const;

68 
	gCuM©rixBa£
<
	gBa£Flßt
> &
G‘Ouut
(è{  
	gfÜw¬d_d©a_
.
back
(); }

70 
šlše
 
IÁ32Paœ
 
MakePaœ
(
št32
 
fœ¡
, iÁ32 
£cÚd
) {

71 
IÁ32Paœ
 
	gªs
;

72 
	gªs
.
	gfœ¡
 = 
fœ¡
;

73 
	gªs
.
	g£cÚd
 = 
£cÚd
;

74  
	gªs
;

77 
	g´iv©e
:

78 
L©tiûArc
 
	tArc
;

79 
	gArc
::
	tS‹Id
 StateId;

82 cÚ¡ 
	gAmNÃt
 &
	gam_Â‘_
;

83 cÚ¡ 
	gT¿ns™iÚMod–
 &
	gtmod–_
;

84 cÚ¡ 
	gNÃtDisüimš©iveUpd©eO±iÚs
 &
	gİts_
;

85 cÚ¡ 
	gDisüimš©iveNÃtExam¶e
 &
	geg_
;

86 
NÃt
 *
	gÂ‘_to_upd©e_
;

89 
NÃtDisüimš©iveSts
 *
	g¡©s_
;

90 
	g¡d
::
veùÜ
<
ChunkInfo
> 
chunk_šfo_out_
;

93 
	g¡d
::
veùÜ
<
CuM©rix
<
Ba£Flßt
> > 
fÜw¬d_d©a_
;

94 
L©tiû
 
	gÏt_
;

95 
	gCuM©rix
<
	gBa£Flßt
> 
	gbackw¬d_d©a_
;

96 
	g¡d
::
veùÜ
<
št32
> 
s’û_phÚes_
;

101 
	gNÃtDisüimš©iveUpd©”
::
NÃtDisüimš©iveUpd©”
(

102 cÚ¡ 
AmNÃt
 &
am_Â‘
,

103 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

104 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

105 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

106 
NÃt
 *
Â‘_to_upd©e
,

107 
NÃtDisüimš©iveSts
 *
¡©s
):

108 
am_Â‘_
(
am_Â‘
), 
tmod–_
(
tmod–
), 
İts_
(
İts
), 
eg_
(
eg
),

109 
Â‘_to_upd©e_
(
Â‘_to_upd©e
), 
¡©s_
(
¡©s
) {

110 ià(!
S¶™SŒšgToIÁeg”s
(
İts_
.
s’û_phÚes_¡r
, ":", 
çl£
,

111 &
s’û_phÚes_
)) {

112 
	gKALDI_ERR
 << "Bad value for --silence-phones option: "

113 << 
	gİts_
.
	gs’û_phÚes_¡r
;

115 cÚ¡ 
	gNÃt
 &
	gÂ‘
 = 
am_Â‘_
.
G‘NÃt
();

116 
	gÂ‘
.
Compu‹ChunkInfo
(
eg_
.
šput_äames
.
NumRows
(), 1, &
chunk_šfo_out_
);

121 
	gSubM©rix
<
	gBa£Flßt
> 
	gNÃtDisüimš©iveUpd©”
::
G‘IÅutF—tu»s
() const {

122 
št32
 
num_äames_ouut
 = 
eg_
.
num_®i
.
size
();

123 
št32
 
	geg_Ëá_cÚ‹xt
 = 
eg_
.
Ëá_cÚ‹xt
,

124 
	geg_right_cÚ‹xt
 = 
eg_
.
šput_äames
.
NumRows
() -

125 
num_äames_ouut
 - 
eg_Ëá_cÚ‹xt
;

126 
KALDI_ASSERT
(
eg_right_cÚ‹xt
 >= 0);

127 cÚ¡ 
	gNÃt
 &
	gÂ‘
 = 
am_Â‘_
.
G‘NÃt
();

132 
KALDI_ASSERT
(
eg_Ëá_cÚ‹xt
 >ğ
Â‘
.
LeáCÚ‹xt
() &&

133 
eg_right_cÚ‹xt
 >ğ
Â‘
.
RightCÚ‹xt
());

134 
št32
 
	goff£t
 = 
eg_Ëá_cÚ‹xt
 - 
Â‘
.
LeáCÚ‹xt
(),

135 
	gnum_ouut_äames
 =

136 
num_äames_ouut
 + 
Â‘
.
LeáCÚ‹xt
(è+‚Ãt.
RightCÚ‹xt
();

137 
	gSubM©rix
<
	gBa£Flßt
> 
ªs
(
eg_
.
šput_äames
, 
off£t
, 
num_ouut_äames
,

138 0, 
eg_
.
šput_äames
.
NumCŞs
());

139  
	gªs
;

142 
	gNÃtDisüimš©iveUpd©”
::
Prİag©e
() {

143 cÚ¡ 
NÃt
 &
Â‘
 = 
am_Â‘_
.
G‘NÃt
();

144 
	gfÜw¬d_d©a_
.
»size
(
Â‘
.
NumCompÚ’ts
() + 1);

146 
	gSubM©rix
<
	gBa£Flßt
> 
	gšput_ã©s
 = 
G‘IÅutF—tu»s
();

147 
št32
 
	g¥k_dim
 = 
eg_
.
¥k_šfo
.
Dim
();

148 ià(
	g¥k_dim
 == 0) {

149 
fÜw¬d_d©a_
[0] = 
šput_ã©s
;

151 
	gfÜw¬d_d©a_
[0].
Resize
(
šput_ã©s
.
NumRows
(),

152 
šput_ã©s
.
NumCŞs
(è+ 
eg_
.
¥k_šfo
.
Dim
());

153 
	gfÜw¬d_d©a_
[0].
Rªge
(0, 
šput_ã©s
.
NumRows
(),

154 0, 
šput_ã©s
.
NumCŞs
()).
CİyFromM©
(input_feats);

155 
	gfÜw¬d_d©a_
[0].
Rªge
(0, 
šput_ã©s
.
NumRows
(),

156 
šput_ã©s
.
NumCŞs
(), 
¥k_dim
).
CİyRowsFromVec
(

157 
eg_
.
¥k_šfo
);

160 
št32
 
	gc
 = 0; c < 
	gÂ‘
.
NumCompÚ’ts
(); c++) {

161 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘
.
G‘CompÚ’t
(
c
);

162 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput
 = 
fÜw¬d_d©a_
[
c
],

163 &
	gouut
 = 
fÜw¬d_d©a_
[
c
+1];

164 
	gcompÚ’t
.
Prİag©e
(
chunk_šfo_out_
[
c
] , chunk_šfo_out_[c+1], 
šput
, &
ouut
);

165 cÚ¡ 
CompÚ’t
 *
	g´ev_compÚ’t
 = (
c
 =ğ0 ? 
NULL
 :

166 &(
Â‘
.
G‘CompÚ’t
(
c
-1)));

167 
boŞ
 
	gwl_do_back´İ
 = (
Â‘_to_upd©e_
 !ğ
NULL
),

168 
	gk“p_Ï¡_ouut
 = 
wl_do_back´İ
 &&

169 ((
c
>0 && 
´ev_compÚ’t
->
Back´İN“dsOuut
()) ||

170 
compÚ’t
.
Back´İN“dsIÅut
());

171 ià(!
	gk“p_Ï¡_ouut
)

172 
	gfÜw¬d_d©a_
[
c
].
Resize
(0, 0);

178 
	gNÃtDisüimš©iveUpd©”
::
L©tiûComputiÚs
() {

179 
CÚv”tL©tiû
(
eg_
.
d’_Ït
, &
Ït_
);

180 
TİSÜt
(&
Ït_
);

182 ià(
	gİts_
.
	gü™”iÚ
 =ğ"mmi" && 
İts_
.
boo¡
 != 0.0) {

183 
Ba£Flßt
 
max_s’û_”rÜ
 = 0.0;

184 
L©tiûBoo¡
(
tmod–_
, 
eg_
.
num_®i
, 
s’û_phÚes_
,

185 
İts_
.
boo¡
, 
max_s’û_”rÜ
, &
Ït_
);

188 
št32
 
	gnum_äames
 = 
¡©ic_ÿ¡
<št32>(
eg_
.
num_®i
.
size
());

190 
	g¡©s_
->
	gtÙ_t
 +ğ
num_äames
;

191 
	g¡©s_
->
	gtÙ_t_weigh‹d
 +ğ
num_äames
 * 
eg_
.
weight
;

193 cÚ¡ 
	gVeùÜBa£
<
	gBa£Flßt
> &
	g´iÜs
 = 
am_Â‘_
.
PriÜs
();

194 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
	gpo¡”iÜs
 = 
fÜw¬d_d©a_
.
back
();

196 
KALDI_ASSERT
(
po¡”iÜs
.
NumRows
(è=ğ
num_äames
);

197 
št32
 
	gnum_pdfs
 = 
po¡”iÜs
.
NumCŞs
();

198 
KALDI_ASSERT
(
num_pdfs
 =ğ
´iÜs
.
Dim
());

209 
	g¡d
::
veùÜ
<
IÁ32Paœ
> 
»que¡ed_šdexes
;

210 
Ba£Flßt
 
	gwiggË_room
 = 1.3;

211 
	g»que¡ed_šdexes
.
»£rve
(
num_äames
 + 
wiggË_room
 * 
Ït_
.
NumS‹s
());

213 ià(
	gİts_
.
	gü™”iÚ
 == "mmi") {

214 
št32
 
t
 = 0; 
	gt
 < 
	gnum_äames
;++) {

215 
št32
 
	gtid
 = 
eg_
.
num_®i
[
t
], 
	gpdf_id
 = 
tmod–_
.
T¿ns™iÚIdToPdf
(
tid
);

216 
KALDI_ASSERT
(
pdf_id
 >ğ0 &&…df_id < 
num_pdfs
);

217 
	g»que¡ed_šdexes
.
push_back
(
MakePaœ
(
t
, 
pdf_id
));

221 
	g¡d
::
veùÜ
<
št32
> 
¡©e_times
;

222 
št32
 
	gT
 = 
L©tiûS‹Times
(
Ït_
, &
¡©e_times
);

223 
KALDI_ASSERT
(
T
 =ğ
num_äames
);

225 
S‹Id
 
	gnum_¡©es
 = 
Ït_
.
NumS‹s
();

226 
S‹Id
 
	gs
 = 0; s < 
	gnum_¡©es
; s++) {

227 
S‹Id
 
	gt
 = 
¡©e_times
[
s
];

228 
	gf¡
::
ArcI‹¿tÜ
<
L©tiû
> 
a™”
(
Ït_
, 
s
); !
	ga™”
.
DÚe
();‡™”.
Next
()) {

229 cÚ¡ 
	gArc
 &
	g¬c
 = 
a™”
.
V®ue
();

230 ià(
	g¬c
.
	gab–
 != 0) {

231 
št32
 
tid
 = 
¬c
.
ab–
, 
	gpdf_id
 = 
tmod–_
.
T¿ns™iÚIdToPdf
(tid);

232 
	g»que¡ed_šdexes
.
push_back
(
MakePaœ
(
t
, 
pdf_id
));

237 
	g¡d
::
veùÜ
<
Ba£Flßt
> 
ªsw”s
;

238 
	gCuA¼ay
<
	gIÁ32Paœ
> 
cu_»que¡ed_šdexes
(
»que¡ed_šdexes
);

239 
	gªsw”s
.
»size
(
»que¡ed_šdexes
.
size
());

240 
	gpo¡”iÜs
.
Lookup
(
cu_»que¡ed_šdexes
, &(
ªsw”s
[0]));

242 
št32
 
	gnum_æoÜed
 = 0;

244 
Ba£Flßt
 
	gæoÜ_v®
 = 1.0e-20;

245 
size_t
 
	gšdex
;

249 
	gšdex
 = 0; index < 
	gªsw”s
.
size
(); index++) {

250 
Ba£Flßt
 
	gpo¡
 = 
ªsw”s
[
šdex
];

251 ià(
	gpo¡
 < 
	gæoÜ_v®
) {

252 
	gpo¡
 = 
æoÜ_v®
;

253 
	gnum_æoÜed
++;

255 
št32
 
	gpdf_id
 = 
»que¡ed_šdexes
[
šdex
].
£cÚd
;

256 
Ba£Flßt
 
	gp£udo_loglike
 = 
Log
(
po¡
 / 
´iÜs
(
pdf_id
)è* 
İts_
.
acou¡ic_sÿË
;

257 
KALDI_ASSERT
(!
KALDI_ISINF
(
p£udo_loglike
è&& !
KALDI_ISNAN
(pseudo_loglike));

258 
	gªsw”s
[
šdex
] = 
p£udo_loglike
;

260 ià(
	gnum_æoÜed
 > 0) {

261 
	gKALDI_WARN
 << "FloÜed " << 
	gnum_æoÜed
 << "…robabilities from‚net.";

264 
	gšdex
 = 0;

266 ià(
	gİts_
.
	gü™”iÚ
 == "mmi") {

267 
tÙ_num_like
 = 0.0;

268 ; 
	gšdex
 < 
	geg_
.
	gnum_®i
.
size
(); index++)

269 
	gtÙ_num_like
 +ğ
ªsw”s
[
šdex
];

270 
	g¡©s_
->
	gtÙ_num_objf
 +ğ
eg_
.
weight
 * 
tÙ_num_like
;

274 
S‹Id
 
	gs
 = 0; s < 
	gnum_¡©es
; s++) {

275 
	gf¡
::
MubËArcI‹¿tÜ
<
L©tiû
> 
a™”
(&
Ït_
, 
s
);

276 !
	ga™”
.
DÚe
();‡™”.
Next
()) {

277 
Arc
 
	g¬c
 = 
a™”
.
V®ue
();

278 ià(
	g¬c
.
	gab–
 != 0) {

279 
¬c
.
weight
.
S‘V®ue2
(-
ªsw”s
[
šdex
]);

280 
	gšdex
++;

281 
	ga™”
.
S‘V®ue
(
¬c
);

284 
L©tiûWeight
 
	gfš®
 = 
Ït_
.
Fš®
(
s
);

285 ià(
	gfš®
 !ğ
L©tiûWeight
::
Z”o
()) {

286 
fš®
.
S‘V®ue2
(0.0);

287 
	gÏt_
.
S‘Fš®
(
s
, 
fš®
);

290 
KALDI_ASSERT
(
šdex
 =ğ
ªsw”s
.
size
());

293 
Po¡”iÜ
 
	gpo¡
;

294 
	g¡©s_
->
	gtÙ_d’_objf
 +ğ
eg_
.
weight
 * 
G‘Disüimš©ivePo¡”iÜs
(&
po¡
);

296 
SÿËPo¡”iÜ
(
eg_
.
weight
, &
po¡
);

298 
	gtÙ_num_po¡
 = 0.0, 
	gtÙ_d’_po¡
 = 0.0;

299 
	g¡d
::
veùÜ
<
M©rixEËm’t
<
Ba£Flßt
> > 
sv_Ïb–s
;

300 
	gsv_Ïb–s
.
»£rve
(
ªsw”s
.
size
());

301 
št32
 
	gt
 = 0; < 
	gpo¡
.
size
();++) {

302 
št32
 
	gi
 = 0; i < 
	gpo¡
[
t
].
size
(); i++) {

303 
št32
 
	gpdf_id
 = 
po¡
[
t
][
i
].
fœ¡
;

304 
Ba£Flßt
 
	gweight
 = 
po¡
[
t
][
i
].
£cÚd
;

305 ià(
	gweight
 > 0.0è{ 
	gtÙ_num_po¡
 +ğ
weight
; }

306 { 
	gtÙ_d’_po¡
 -ğ
weight
; }

307 
	gM©rixEËm’t
<
	gBa£Flßt
> 
	g–em
 = {
t
, 
pdf_id
, 
weight
};

308 
	gsv_Ïb–s
.
push_back
(
–em
);

311 
	g¡©s_
->
	gtÙ_num_couÁ
 +ğ
tÙ_num_po¡
;

312 
št32
 
	gnum_compÚ’ts
 = 
am_Â‘_
.
G‘NÃt
().
NumCompÚ’ts
();

313 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
ouut
(
fÜw¬d_d©a_
[
num_compÚ’ts
]);

314 
	gbackw¬d_d©a_
.
Resize
(
ouut
.
NumRows
(), ouut.
NumCŞs
());

318 
Ba£Flßt
 
	gtÙ_objf
, 
	gtÙ_weight
;

319 
	gbackw¬d_d©a_
.
CompObjfAndD”iv
(
sv_Ïb–s
, 
ouut
, &
tÙ_objf
, &
tÙ_weight
);

326 
	gNÃtDisüimš©iveUpd©”
::
G‘Disüimš©ivePo¡”iÜs
(
Po¡”iÜ
 *
po¡
) {

327 ià(
İts_
.
ü™”iÚ
 == "mpfe" || opts_.criterion == "smbr") {

328 
Po¡”iÜ
 
tid_po¡
;

329 
	gªs
;

330 
	gªs
 = 
L©tiûFÜw¬dBackw¬dM³V¬ŸÁs
(
tmod–_
, 
s’û_phÚes_
, 
Ït_
,

331 
eg_
.
num_®i
, 
İts_
.
ü™”iÚ
,

332 
İts_
.
Úe_s’û_şass
,

333 &
tid_po¡
);

334 
CÚv”tPo¡”iÜToPdfs
(
tmod–_
, 
tid_po¡
, 
po¡
);

335  
	gªs
;

337 
KALDI_ASSERT
(
İts_
.
ü™”iÚ
 == "mmi");

338 
boŞ
 
	gcÚv”t_to_pdfs
 = 
Œue
, 
	gÿnûl
 =rue;

341  
L©tiûFÜw¬dBackw¬dMmi
(
tmod–_
, 
Ït_
, 
eg_
.
num_®i
,

342 
İts_
.
drİ_äames
, 
cÚv”t_to_pdfs
,

343 
ÿnûl
, 
po¡
);

349 
	gNÃtDisüimš©iveUpd©”
::
Back´İ
() {

350 cÚ¡ 
NÃt
 &
Â‘
 = 
am_Â‘_
.
G‘NÃt
();

351 
št32
 
	gc
 = 
Â‘
.
NumCompÚ’ts
() - 1; c >= 0; c--) {

352 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘
.
G‘CompÚ’t
(
c
);

353 
CompÚ’t
 *
	gcompÚ’t_to_upd©e
 = &(
Â‘_to_upd©e_
->
G‘CompÚ’t
(
c
));

354 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput
 = 
fÜw¬d_d©a_
[
c
],

355 &
	gouut
 = 
fÜw¬d_d©a_
[
c
+1],

356 &
	gouut_d”iv
 = 
backw¬d_d©a_
;

357 
	gCuM©rix
<
	gBa£Flßt
> 
	gšput_d”iv
;

358 
	gcompÚ’t
.
Back´İ
(
chunk_šfo_out_
[
c
], chunk_šfo_out_[c+1], 
šput
, 
ouut
, 
ouut_d”iv
,

359 
compÚ’t_to_upd©e
, &
šput_d”iv
);

360 
	gbackw¬d_d©a_
.
Sw­
(&
šput_d”iv
);

365 
NÃtDisüimš©iveUpd©e
(cÚ¡ 
AmNÃt
 &
am_Â‘
,

366 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

367 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

368 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

369 
NÃt
 *
Â‘_to_upd©e
,

370 
NÃtDisüimš©iveSts
 *
¡©s
) {

371 
NÃtDisüimš©iveUpd©”
 
upd©”
(
am_Â‘
, 
tmod–
, 
İts
, 
eg
,

372 
Â‘_to_upd©e
, 
¡©s
);

373 
	gupd©”
.
Upd©e
();

376 
	gNÃtDisüimš©iveSts
::
Add
(cÚ¡ 
NÃtDisüimš©iveSts
 &
Ùh”
) {

377 
tÙ_t
 +ğ
Ùh”
.tot_t;

378 
	gtÙ_t_weigh‹d
 +ğ
Ùh”
.
tÙ_t_weigh‹d
;

379 
	gtÙ_num_couÁ
 +ğ
Ùh”
.
tÙ_num_couÁ
;

380 
	gtÙ_num_objf
 +ğ
Ùh”
.
tÙ_num_objf
;

381 
	gtÙ_d’_objf
 +ğ
Ùh”
.
tÙ_d’_objf
;

384 
	gNÃtDisüimš©iveSts
::
Pršt
(
¡d
::
¡ršg
 
ü™”iÚ
) {

385 
KALDI_ASSERT
(
ü™”iÚ
 == "mmi" || criterion == "smbr" ||

386 
ü™”iÚ
 == "mpfe");

388 
	gavg_po¡_³r_äame
 = 
tÙ_num_couÁ
 / 
tÙ_t_weigh‹d
;

389 
	gKALDI_LOG
 << "Numb” oàäame i " << 
	gtÙ_t


390 << " (weigh‹d: " << 
	gtÙ_t_weigh‹d


392 << 
	gavg_po¡_³r_äame
;

394 ià(
	gü™”iÚ
 == "mmi") {

395 
num_objf
 = 
tÙ_num_objf
 / 
tÙ_t_weigh‹d
,

396 
	gd’_objf
 = 
tÙ_d’_objf
 / 
tÙ_t_weigh‹d
,

397 
	gobjf
 = 
num_objf
 - 
d’_objf
;

398 
	gKALDI_LOG
 << "MMI objeùivfunùiÚ i " << 
	gnum_objf
 << " - "

399 << 
	gd’_objf
 << " = " << 
	gobjf
 << "…er frame, over "

400 << 
	gtÙ_t_weigh‹d
 << " frames.";

401 } ià(
	gü™”iÚ
 == "mpfe") {

402 
objf
 = 
tÙ_d’_objf
 / 
tÙ_t_weigh‹d
;

404 
	gKALDI_LOG
 << "MPFE objeùivfunùiÚ i " << 
	gobjf


405 << "…” f¿me, ov” " << 
	gtÙ_t_weigh‹d
 << " frames.";

407 
	gobjf
 = 
tÙ_d’_objf
 / 
tÙ_t_weigh‹d
;

409 
	gKALDI_LOG
 << "SMBR objeùivfunùiÚ i " << 
	gobjf


410 << "…” f¿me, ov” " << 
	gtÙ_t_weigh‹d
 << " frames.";

	@nnet-compute-discriminative.h

20 #iâdeà
KALDI_NNET2_NNET_COMPUTE_DISCRIMINATIVE_H_


21 
	#KALDI_NNET2_NNET_COMPUTE_DISCRIMINATIVE_H_


	)

23 
	~"Â‘2/am-Â‘.h
"

24 
	~"Â‘2/Â‘-exam¶e.h
"

25 
	~"hmm/Œªs™iÚ-mod–.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

35 
	sNÃtDisüimš©iveUpd©eO±iÚs
 {

36 
	g¡d
::
¡ršg
 
ü™”iÚ
;

37 
Ba£Flßt
 
	gacou¡ic_sÿË
;

38 
boŞ
 
	gdrİ_äames
;

40 
boŞ
 
	gÚe_s’û_şass
;

41 
Ba£Flßt
 
	gboo¡
;

43 
	g¡d
::
¡ršg
 
s’û_phÚes_¡r
;

46 
NÃtDisüimš©iveUpd©eO±iÚs
(): 
ü™”iÚ
("smbr"), 
acou¡ic_sÿË
(0.1),

47 
drİ_äames
(
çl£
),

48 
Úe_s’û_şass
(
çl£
),

49 
boo¡
(0.0) { }

51 
Regi¡”
(
O±iÚsItf
 *
İts
) {

52 
	gİts
->
Regi¡”
("ü™”iÚ", &
ü™”iÚ
, "Criterion, 'mmi'|'mpfe'|'smbr', "

55 
	gİts
->
Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
, "Weighting factoro "

57 
	gİts
->
Regi¡”
("drİ-äames", &
drİ_äames
, "For MMI, ifrue we drop frames "

59 
	gİts
->
Regi¡”
("boo¡", &
boo¡
, "Boosting factor for boosted MMI (e.g. 0.1)");

60 
	gİts
->
Regi¡”
("Úe-s’û-şass", &
Úe_s’û_şass
, "Ifrue,‚ewer "

62 
	gİts
->
Regi¡”
("s’û-phÚes", &
s’û_phÚes_¡r
,

70 
	sNÃtDisüimš©iveSts
 {

71 
	gtÙ_t
;

72 
	gtÙ_t_weigh‹d
;

73 
	gtÙ_num_couÁ
;

76 
	gtÙ_num_objf
;

78 
	gtÙ_d’_objf
;

80 
NÃtDisüimš©iveSts
(è{ 
	g¡d
::
mem£t
(
this
, 0, (*this)); }

81 
Pršt
(
¡d
::
¡ršg
 
ü™”iÚ
);

82 
Add
(cÚ¡ 
NÃtDisüimš©iveSts
 &
Ùh”
);

104 
NÃtDisüimš©iveUpd©e
(cÚ¡ 
AmNÃt
 &
am_Â‘
,

105 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

106 cÚ¡ 
NÃtDisüimš©iveUpd©eO±iÚs
 &
İts
,

107 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

108 
NÃt
 *
Â‘_to_upd©e
,

109 
NÃtDisüimš©iveSts
 *
¡©s
);

	@nnet-compute-online.cc

22 
	~"Â‘2/Â‘-compu‹-Úlše.h
"

23 
	~<veùÜ
>

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

28 
	gNÃtOÆšeCompu‹r
::
NÃtOÆšeCompu‹r
(cÚ¡ 
NÃt
 &
Â‘
, 
boŞ
 
·d_šput
)

29 : 
Â‘_
(
Â‘
), 
·d_šput_
(
·d_šput
),

30 
is_fœ¡_chunk_
(
Œue
), 
fšished_
(
çl£
) {

31 
	gd©a_
.
»size
(
Â‘_
.
NumCompÚ’ts
() + 1);

32 
	g»u§bË_compÚ’t_šputs_
.
»size
(
Â‘_
.
NumCompÚ’ts
()+1);

35 
	gNÃtOÆšeCompu‹r
::
Compu‹
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput
,

36 
CuM©rix
<
Ba£Flßt
> *
ouut
) {

37 
KALDI_ASSERT
(
ouut
 !ğ
NULL
);

38 
KALDI_ASSERT
(!
fšished_
);

39 
št32
 
	gdim
 = 
šput
.
NumCŞs
();

42 ià(
	gšput
.
NumRows
() == 0) {

43 
ouut
->
Resize
(0, 0);

48 ià(
	gÏ¡_£’_šput_äame_
.
Dim
(è!ğ
šput
.
NumCŞs
())

49 
Ï¡_£’_šput_äame_
.
Resize
(
šput
.
NumCŞs
());

50 
	gÏ¡_£’_šput_äame_
.
CİyFromVec
(
šput
.
Row
(šput.
NumRows
() - 1));

54 ià(
	gdim
 !ğ
Â‘_
.
IÅutDim
()) {

55 
KALDI_ERR
 << "F—tu» dim’siÚ i " << 
dim
 << ", but‚etworkƒxpects "

56 << 
Â‘_
.
IÅutDim
();

63 
št32
 
	gnum_efãùive_šput_rows
 = 0;

65 
	gCuM©rix
<
	gBa£Flßt
> &
šput_d©a
(
d©a_
[0]);

66 ià(
	gis_fœ¡_chunk_
) {

67 
	gis_fœ¡_chunk_
 = 
çl£
;

69 
št32
 
	gi
 = 0; i < 
	g»u§bË_compÚ’t_šputs_
.
size
(); i++)

70 
KALDI_ASSERT
(
»u§bË_compÚ’t_šputs_
[0].
NumRows
() == 0);

72 ià((
	g·d_šput_
è&& (
	gÂ‘_
.
LeáCÚ‹xt
() > 0)) {

73 
	gšput_d©a
.
Resize
(
Â‘_
.
LeáCÚ‹xt
(è+ 
šput
.
NumRows
(), 
dim
);

74 
	gšput_d©a
.
Rªge
(0, 
Â‘_
.
LeáCÚ‹xt
(), 0,

75 
dim
).
CİyRowsFromVec
(
šput
.
Row
(0));

76 
	gšput_d©a
.
Rªge
(
Â‘_
.
LeáCÚ‹xt
(), 
šput
.
NumRows
(),

77 0, 
dim
).
CİyFromM©
(
šput
);

79 
	gšput_d©a
.
Resize
(
šput
.
NumRows
(), iÅut.
NumCŞs
());

80 
	gšput_d©a
.
CİyFromM©
(
šput
);

82 
	gnum_efãùive_šput_rows
 = 
šput_d©a
.
NumRows
();

84 
št32
 
	gexŒa_šput_rows
 = 0;

89 
št32
 
	gi
 = 0; i < 
	g»u§bË_compÚ’t_šputs_
.
size
(); i++) {

90 ià(
	g»u§bË_compÚ’t_šputs_
[
i
].
NumRows
() > 0) {

91 
	gexŒa_šput_rows
 = 
Â‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
();

96 
	gšput_d©a
.
Resize
(
šput
.
NumRows
(è+ 
uÅroûs£d_bufãr_
.NumRows(), 
dim
);

97 ià(
	guÅroûs£d_bufãr_
.
NumRows
() > 0)

98 
	gšput_d©a
.
Rªge
(0, 
uÅroûs£d_bufãr_
.
NumRows
(),

99 0, 
dim
).
CİyFromM©
(
uÅroûs£d_bufãr_
);

100 
	gšput_d©a
.
Rªge
(
uÅroûs£d_bufãr_
.
NumRows
(), 
šput
.NumRows(),

101 0, 
dim
).
CİyFromM©
(
šput
);

102 
	guÅroûs£d_bufãr_
.
Resize
(0, 0);

103 
	gnum_efãùive_šput_rows
 = 
šput_d©a
.
NumRows
(è+ 
exŒa_šput_rows
;

105 ià(
	gnum_efãùive_šput_rows
 >=

106 
Â‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
() + 1) {

108 
Â‘_
.
Compu‹ChunkInfo
(
num_efãùive_šput_rows
, 1, &
chunk_šfo_
);

109 
Prİag©e
();

110 *
	gouut
 = 
d©a_
.
back
();

113 
	guÅroûs£d_bufãr_
 = 
šput_d©a
;

115 
	gouut
->
Resize
(0, 0);

120 
	gNÃtOÆšeCompu‹r
::
Flush
(
CuM©rix
<
Ba£Flßt
> *
ouut
) {

121 
KALDI_ASSERT
(!
fšished_
 && !
is_fœ¡_chunk_
);

122 
št32
 
	gnum_äames_·ddšg
 = (
·d_šput_
 ? 
Â‘_
.
RightCÚ‹xt
() : 0);

123 
št32
 
	gnum_¡Üed_äames
 = 
Â‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
();

124 
št32
 
	gnum_efãùive_šput_rows
 = 
num_¡Üed_äames
 + 
num_äames_·ddšg
;

126 ià(
	gnum_efãùive_šput_rows
 < 
	gÂ‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
() + 1) {

127 
	gouut
->
Resize
(0, 0);

128 
	gfšished_
 = 
Œue
;

132 
št32
 
	gdim
 = 
Â‘_
.
IÅutDim
();

133 
	gCuM©rix
<
	gBa£Flßt
> &
šput_d©a
(
d©a_
[0]);

134 
KALDI_ASSERT
(
num_äames_·ddšg
 > 0);

135 
	gšput_d©a
.
Resize
(
num_äames_·ddšg
, 
dim
);

136 
	gšput_d©a
.
CİyRowsFromVec
(
Ï¡_£’_šput_äame_
);

141 
	gÂ‘_
.
Compu‹ChunkInfo
(
num_efãùive_šput_rows
, 1,

142 &
chunk_šfo_
);

143 
Prİag©e
();

144 *
	gouut
 = 
d©a_
.
back
();

145 
	gfšished_
 = 
Œue
;

148 
	gNÃtOÆšeCompu‹r
::
Prİag©e
() {

152 
št32
 
c
 = 0; 
	gc
 < 
	gÂ‘_
.
NumCompÚ’ts
(); c++) {

154 
	gchunk_šfo_
[
c
].
MakeOff£tsCÚtiguous
();

155 
	gchunk_šfo_
[
c
 + 1].
MakeOff£tsCÚtiguous
();

157 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘_
.
G‘CompÚ’t
(
c
);

158 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput_d©a
 = 
d©a_
[
c
], &
	gouut_d©a
 = data_[c + 1];

159 
	gCuM©rix
<
	gBa£Flßt
> 
	gšput_d©a_‹mp
;

161 ià(
	gcompÚ’t
.
CÚ‹xt
().
size
() > 1) {

162 
št32
 
	gdim
 = 
compÚ’t
.
IÅutDim
();

163 ià(
	g»u§bË_compÚ’t_šputs_
[
c
].
NumRows
() > 0) {

166 
	gšput_d©a_‹mp
.
Resize
(
»u§bË_compÚ’t_šputs_
[
c
].
NumRows
()

167 + 
šput_d©a
.
NumRows
(), 
dim
);

168 
	gšput_d©a_‹mp
.
Rªge
(0, 
»u§bË_compÚ’t_šputs_
[
c
].
NumRows
(),

169 0, 
dim
).
CİyFromM©
(
»u§bË_compÚ’t_šputs_
[
c
]);

170 
	gšput_d©a_‹mp
.
Rªge
(
»u§bË_compÚ’t_šputs_
[
c
].
NumRows
(),

171 
šput_d©a
.
NumRows
(), 0, 
dim
).
CİyFromM©
(

172 
šput_d©a
);

173 
	gšput_d©a
 = 
šput_d©a_‹mp
;

176 
	g»u§bË_compÚ’t_šputs_
[
c
].
Resize
(
compÚ’t
.
CÚ‹xt
().
back
() -

177 
compÚ’t
.
CÚ‹xt
().
äÚt
(), 
dim
);

178 
	g»u§bË_compÚ’t_šputs_
[
c
].
CİyFromM©
(

179 
šput_d©a
.
RowRªge
(šput_d©a.
NumRows
() -

180 
»u§bË_compÚ’t_šputs_
[
c
].
NumRows
(),

181 
»u§bË_compÚ’t_šputs_
[
c
].
NumRows
()));

192 
št32
 
	gchunk_size_assumed
 = 
chunk_šfo_
[
c
].
ChunkSize
();

193 
št32
 
	gÏ¡_off£t
 = 
chunk_šfo_
[
c
].
G‘Off£t
(
chunk_size_assumed
 - 1);

194 
št32
 
	gfœ¡_off£t
 = 
Ï¡_off£t
 - 
šput_d©a
.
NumRows
() + 1;

195 
ChunkInfo
 
šput_chunk_šfo
(
chunk_šfo_
[
c
].
NumCŞs
(),

196 
chunk_šfo_
[
c
].
NumChunks
(),

197 
fœ¡_off£t
,

198 
Ï¡_off£t
);

200 
	gchunk_size_assumed
 = 
chunk_šfo_
[
c
 + 1].
ChunkSize
();

201 
	gÏ¡_off£t
 = 
chunk_šfo_
[
c
 + 1].
G‘Off£t
(
chunk_size_assumed
 - 1);

202 
	gfœ¡_off£t
 = 
Ï¡_off£t
 - (
šput_d©a
.
NumRows
() -

203 (
compÚ’t
.
CÚ‹xt
().
back
() -

204 
compÚ’t
.
CÚ‹xt
().
äÚt
())) + 1;

205 
ChunkInfo
 
ouut_chunk_šfo
(
chunk_šfo_
[
c
 + 1].
NumCŞs
(),

206 
chunk_šfo_
[
c
 + 1].
NumChunks
(),

207 
fœ¡_off£t
,

208 
Ï¡_off£t
);

209 
	gcompÚ’t
.
Prİag©e
(
šput_chunk_šfo
, 
ouut_chunk_šfo
,

210 
šput_d©a
, &
ouut_d©a
);

	@nnet-compute-online.h

22 #iâdeà
KALDI_NNET2_NNET_COMPUTE_ONLINE_H_


23 
	#KALDI_NNET2_NNET_COMPUTE_ONLINE_H_


	)

25 
	~"Â‘2/Â‘-Â‘.h
"

26 
	~<veùÜ
>

28 
Çme¥aû
 
	gk®di
 {

29 
Çme¥aû
 
	gÂ‘2
 {

41 şas 
	cNÃtOÆšeCompu‹r
 {

43 
	gpublic
:

53 
NÃtOÆšeCompu‹r
(cÚ¡ 
NÃt
 &
Â‘
,

54 
boŞ
 
·d_šput
);

64 
Compu‹
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput
,

65 
CuM©rix
<
Ba£Flßt
> *
ouut
);

71 
Flush
(
CuM©rix
<
Ba£Flßt
> *
ouut
);

73 
	g´iv©e
:

74 
Prİag©e
();

76 cÚ¡ 
	gNÃt
 &
	gÂ‘_
;

80 
	g¡d
::
veùÜ
<
CuM©rix
<
Ba£Flßt
> > 
d©a_
;

82 
	g¡d
::
veùÜ
<
ChunkInfo
> 
chunk_šfo_
;

85 
	g¡d
::
veùÜ
<
CuM©rix
<
Ba£Flßt
> > 
»u§bË_compÚ’t_šputs_
;

89 
	gCuM©rix
<
	gBa£Flßt
> 
	guÅroûs£d_bufãr_
;

93 
	gCuVeùÜ
<
	gBa£Flßt
> 
	gÏ¡_£’_šput_äame_
;

97 
boŞ
 
	g·d_šput_
;

99 
boŞ
 
	gis_fœ¡_chunk_
;

101 
boŞ
 
	gfšished_
;

103 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
NÃtOÆšeCompu‹r
);

	@nnet-compute-test.cc

21 
	~"Â‘2/Â‘-Â‘.h
"

22 
	~"Â‘2/Â‘-compu‹.h
"

23 
	~"Â‘2/Â‘-compu‹-Úlše.h
"

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

29 
Un™Te¡NÃtCompu‹
() {

30 
št32
 
	gšput_dim
 = 10 + 
¿nd
(è% 40, 
	gouut_dim
 = 100 +„and() % 500;

31 
boŞ
 
	g·d_šput
 = (
¿nd
() % 2 == 0);

33 
NÃt
 *
	gÂ‘
 = 
G’RªdomNÃt
(
šput_dim
, 
ouut_dim
);

34 
	gKALDI_LOG
 << "Leá cÚ‹xˆğ" << 
	gÂ‘
->
LeáCÚ‹xt
() << ",„ight context = "

35 << 
	gÂ‘
->
RightCÚ‹xt
(è<< ",…ad-špuˆğ" << 
	g·d_šput
;

36 
	gKALDI_LOG
 << "NN‘ infØi " << 
	gÂ‘
->
Info
();

37 
št32
 
	gnum_ã©s
 = 5 + 
¿nd
() % 1000;

38 
	gCuM©rix
<
	gBa£Flßt
> 
šput
(
num_ã©s
, 
šput_dim
);

39 
	gšput
.
S‘Rªdn
();

41 
št32
 
	gnum_ouut_rows
 = 
num_ã©s
 -

42 (
·d_šput
 ? 0 : 
Â‘
->
LeáCÚ‹xt
(è+‚Ãt->
RightCÚ‹xt
());

43 ià(
	gnum_ouut_rows
 <= 0)

45 
	gCuM©rix
<
	gBa£Flßt
> 
ouut1
(
num_ouut_rows
, 
ouut_dim
);

46 
NÃtComputiÚ
(*
Â‘
, 
šput
, 
·d_šput
, &
ouut1
);

48 
	gCuM©rix
<
	gBa£Flßt
> 
ouut2
(
ouut1
.
NumRows
(), ouut1.
NumCŞs
());

49 
št32
 
	gcur_šput_pos
 = 0, 
	gcur_ouut_pos
 = 0;

51 
NÃtOÆšeCompu‹r
 
compu‹r
(*
Â‘
, 
·d_šput
);

52 
	gcur_šput_pos
 <ğ
num_ã©s
) {

53 
št32
 
ã©s_Ëá
 = 
num_ã©s
 - 
cur_šput_pos
;

54 
	gCuM©rix
<
	gBa£Flßt
> 
	gouut_·¹
;

55 ià(
	gã©s_Ëá
 > 0) {

56 
št32
 
	gchunk_size
 = 
¡d
::
mš
<št32>(1 + 
¿nd
(è% 10, 
	gã©s_Ëá
);

57 
	gCuSubM©rix
<
	gBa£Flßt
> 
šput_·¹
(
šput
, 
cur_šput_pos
, 
chunk_size
,

58 0, 
šput_dim
);

59 
	gcompu‹r
.
Compu‹
(
šput_·¹
, &
ouut_·¹
);

60 
	gcur_šput_pos
 +ğ
chunk_size
;

62 
	gcompu‹r
.
Flush
(&
ouut_·¹
);

63 
	gcur_šput_pos
++;

65 ià(
	gouut_·¹
.
NumRows
() != 0) {

66 
ouut2
.
Rªge
(
cur_ouut_pos
, 
ouut_·¹
.
NumRows
(),

67 0, 
ouut_dim
).
CİyFromM©
(
ouut_·¹
);

68 
	gcur_ouut_pos
 +ğ
ouut_·¹
.
NumRows
();

71 
As£¹Equ®
(
ouut1
, 
ouut2
);

72 
št32
 
	gi
 = 0; i < 
	gouut1
.
NumRows
(); i++) {

75 ià(
	gi
 < 10 || 
	gouut1
.
NumRows
() - i < 10) {

76 
	gCuSubVeùÜ
<
	gBa£Flßt
> 
vec1
(
ouut1
, 
i
), 
vec2
(
ouut2
, i);

77 
As£¹Equ®
(
vec1
, 
vec2
);

80 
	gKALDI_LOG
 << "OK";

81 
d–‘e
 
	gÂ‘
;

84 
Un™Te¡NÃtCompu‹Chunked
() {

85 
št32
 
	gšput_dim
 = 10 + 
¿nd
(è% 40, 
	gouut_dim
 = 100 +„and() % 500;

86 
boŞ
 
	g·d_šput
 = 
Œue
;

88 
NÃt
 *
	gÂ‘
 = 
G’RªdomNÃt
(
šput_dim
, 
ouut_dim
);

89 
št32
 
	gnum_ã©s
 = 100 + 
¿nd
() % 500;

90 
št32
 
	gchunk_size
 = 
num_ã©s
 / (2 + 
¿nd
() % 10);

91 
	gCuM©rix
<
	gBa£Flßt
> 
šput
(
num_ã©s
, 
šput_dim
);

92 
	gšput
.
S‘Rªdn
();

94 
	gKALDI_LOG
 << "Leá cÚ‹xˆğ" << 
	gÂ‘
->
LeáCÚ‹xt
()

95 << ",„ighˆcÚ‹xˆğ" << 
	gÂ‘
->
RightCÚ‹xt
()

96 << ", chunk sizğ" << 
	gchunk_size
;

97 
	gKALDI_LOG
 << "NN‘ infØi " << 
	gÂ‘
->
Info
();

99 
št32
 
	gnum_ouut_rows
 = 
num_ã©s
;

100 
	gCuM©rix
<
	gBa£Flßt
> 
cu_ouut1
(
num_ouut_rows
, 
ouut_dim
);

101 
	gM©rix
<
	gBa£Flßt
> 
ouut2
(
num_ouut_rows
, 
ouut_dim
);

102 
NÃtComputiÚ
(*
Â‘
, 
šput
, 
·d_šput
, &
cu_ouut1
);

103 
NÃtComputiÚChunked
(*
Â‘
, 
M©rix
<
Ba£Flßt
>(
šput
), 
chunk_size
,

104 &
ouut2
);

105 
	gM©rix
<
	gBa£Flßt
> 
ouut1
(
cu_ouut1
);

106 
As£¹Equ®
(
ouut1
, 
ouut2
);

107 
št32
 
	gi
 = 0; i < 
	gouut1
.
NumRows
(); i++) {

110 ià(
	gi
 < 10 || 
	gouut1
.
NumRows
() - i < 10) {

111 
	gSubVeùÜ
<
	gBa£Flßt
> 
vec1
(
ouut1
, 
i
), 
vec2
(
ouut2
, i);

112 
As£¹Equ®
(
vec1
, 
vec2
);

115 
	gKALDI_LOG
 << "OK";

116 
d–‘e
 
	gÂ‘
;

122 
	~"m©rix/m©rix-funùiÚs.h
"

125 
	$maš
() {

126 
usšg
 
Çme¥aû
 
k®di
;

127 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

129 
št32
 
i
 = 0; i < 10; i++)

130 
	`Un™Te¡NÃtCompu‹
();

131 
	`Un™Te¡NÃtCompu‹Chunked
();

133 
	}
}

	@nnet-compute.cc

21 
	~"Â‘2/Â‘-compu‹.h
"

22 
	~"hmm/po¡”iÜ.h
"

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

32 şas 
	cNÃtCompu‹r
 {

33 
	gpublic
:

37 
NÃtCompu‹r
(cÚ¡ 
NÃt
 &
Â‘
,

38 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput_ã©s
,

39 
boŞ
 
·d
,

40 
NÃt
 *
Â‘_to_upd©e
 = 
NULL
);

43 
Prİag©e
();

45 
Back´İ
(
CuM©rix
<
Ba£Flßt
> *
tmp_d”iv
);

51 
Ba£Flßt
 
Compu‹La¡Lay”D”iv
(cÚ¡ 
Po¡”iÜ
 &
pdf_po¡
,

52 
CuM©rix
<
Ba£Flßt
> *
d”iv
) const;

54 
	gCuM©rixBa£
<
	gBa£Flßt
> &
G‘Ouut
(è{  
	gfÜw¬d_d©a_
.
back
(); }

56 
	g´iv©e
:

57 cÚ¡ 
NÃt
 &
Â‘_
;

58 
	g¡d
::
veùÜ
<
CuM©rix
<
Ba£Flßt
> > 
fÜw¬d_d©a_
;

59 
NÃt
 *
	gÂ‘_to_upd©e_
;

61 
	g¡d
::
veùÜ
 <
ChunkInfo
> 
chunk_šfo_
;

64 
	gNÃtCompu‹r
::
NÃtCompu‹r
(cÚ¡ 
NÃt
 &
Â‘
,

65 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput_ã©s
,

66 
boŞ
 
·d
,

67 
NÃt
 *
Â‘_to_upd©e
):

68 
Â‘_
(
Â‘
), 
Â‘_to_upd©e_
(
Â‘_to_upd©e
) {

69 
št32
 
	gdim
 = 
šput_ã©s
.
NumCŞs
();

70 ià(
	gdim
 !ğ
Â‘
.
IÅutDim
()) {

71 
KALDI_ERR
 << "F—tu» dim’siÚ i " << 
dim
 << " but‚etworkƒxpects "

72 << 
Â‘
.
IÅutDim
();

74 
	gfÜw¬d_d©a_
.
»size
(
Â‘
.
NumCompÚ’ts
() + 1);

76 
št32
 
	gËá_cÚ‹xt
 = (
·d
 ? 
Â‘_
.
LeáCÚ‹xt
() : 0),

77 
	gright_cÚ‹xt
 = (
·d
 ? 
Â‘_
.
RightCÚ‹xt
() : 0);

79 
št32
 
	gnum_rows
 = 
Ëá_cÚ‹xt
 + 
šput_ã©s
.
NumRows
(è+ 
right_cÚ‹xt
;

80 
	gÂ‘
.
Compu‹ChunkInfo
(
num_rows
, 1, &
chunk_šfo_
);

82 
	gCuM©rix
<
	gBa£Flßt
> &
šput
(
fÜw¬d_d©a_
[0]);

83 
	gšput
.
Resize
(
num_rows
, 
dim
);

84 
	gšput
.
Rªge
(
Ëá_cÚ‹xt
, 
šput_ã©s
.
NumRows
(),

85 0, 
dim
).
CİyFromM©
(
šput_ã©s
);

86 
št32
 
	gi
 = 0; i < 
	gËá_cÚ‹xt
; i++)

87 
	gšput
.
Row
(
i
).
CİyFromVec
(
šput_ã©s
.Row(0));

88 
št32
 
	gÏ¡_row
 = 
šput_ã©s
.
NumRows
() - 1;

89 
št32
 
	gi
 = 0; i < 
	gright_cÚ‹xt
; i++)

90 
	gšput
.
Row
(
num_rows
 - 
i
 - 1).
CİyFromVec
(
šput_ã©s
.Row(
Ï¡_row
));

95 
	gNÃtCompu‹r
::
Prİag©e
() {

96 
št32
 
c
 = 0; 
	gc
 < 
	gÂ‘_
.
NumCompÚ’ts
(); c++) {

97 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘_
.
G‘CompÚ’t
(
c
);

98 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput
 = 
fÜw¬d_d©a_
[
c
],

99 &
	gouut
 = 
fÜw¬d_d©a_
[
c
+1];

100 
	gcompÚ’t
.
Prİag©e
(
chunk_šfo_
[
c
], chunk_šfo_[c+1], 
šput
, &
ouut
);

101 cÚ¡ 
CompÚ’t
 *
	g´ev_compÚ’t
 = (
c
 =ğ0 ? 
NULL
 : &(
Â‘_
.
G‘CompÚ’t
(c-1)));

102 
boŞ
 
	gwl_do_back´İ
 = (
Â‘_to_upd©e_
 !ğ
NULL
),

103 
	gk“p_Ï¡_ouut
 = 
wl_do_back´İ
 &&

104 ((
c
>0 && 
´ev_compÚ’t
->
Back´İN“dsOuut
()) ||

105 
compÚ’t
.
Back´İN“dsIÅut
());

106 ià(!
	gk“p_Ï¡_ouut
)

107 
	gfÜw¬d_d©a_
[
c
].
Resize
(0, 0);

111 
Ba£Flßt
 
	gNÃtCompu‹r
::
Compu‹La¡Lay”D”iv
(cÚ¡ 
Po¡”iÜ
 &
pdf_po¡
,

112 
CuM©rix
<
Ba£Flßt
> *
d”iv
) const {

115 
št32
 
	gnum_compÚ’ts
 = 
Â‘_
.
NumCompÚ’ts
();

116 
	gtÙ_objf
 = 0.0, 
	gtÙ_weight
 = 0.0;

117 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
	gÏ¡_Ïy”_ouut
 = 
fÜw¬d_d©a_
[
num_compÚ’ts
];

118 
št32
 
	gnum_äames
 = 
Ï¡_Ïy”_ouut
.
NumRows
(),

119 
	gnum_pdfs
 = 
Ï¡_Ïy”_ouut
.
NumCŞs
();

120 
KALDI_ASSERT
(
pdf_po¡
.
size
(è=ğ
¡©ic_ÿ¡
<
size_t
>(
num_äames
));

121 
	gd”iv
->
Resize
(
num_äames
, 
num_pdfs
);

122 
št32
 
	gi
 = 0; i < 
	gd”iv
->
NumRows
(); i++) {

123 
size_t
 
	gj
 = 0; j < 
	gpdf_po¡
[
i
].
size
(); j++) {

124 
št32
 
	gÏb–
 = 
pdf_po¡
[
i
][
j
].
fœ¡
;

125 
Ba£Flßt
 
	gweight
 = 
pdf_po¡
[
i
][
j
].
£cÚd
;

126 
KALDI_ASSERT
(
Ïb–
 >ğ0 &&†ab– < 
num_pdfs
);

127 
Ba£Flßt
 
	gthis_´ob
 = 
Ï¡_Ïy”_ouut
(
i
, 
Ïb–
);

128 
KALDI_ASSERT
(
this_´ob
 > 0.99e-20);

129 
	gtÙ_objf
 +ğ
weight
 * 
Log
(
this_´ob
);

130 
	gtÙ_weight
 +ğ
weight
;

131 (*
	gd”iv
)(
	gi
, 
	gÏb–
è+ğ
weight
 / 
this_´ob
;

135 
KALDI_VLOG
(4è<< "ObjeùivfunùiÚ i " << (
	gtÙ_objf
/
	gtÙ_weight
) <<

136 "…” f¿mov” " << 
	gtÙ_weight
 << " samples.";

137  
	gtÙ_objf
;

141 
	gNÃtCompu‹r
::
Back´İ
(
CuM©rix
<
Ba£Flßt
> *
tmp_d”iv
) {

142 
KALDI_ASSERT
(
Â‘_to_upd©e_
 !ğ
NULL
);

147 
št32
 
	gc
 = 
Â‘_
.
NumCompÚ’ts
() - 1; c >= 0; c--) {

148 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘_
.
G‘CompÚ’t
(
c
);

149 
CompÚ’t
 *
	gcompÚ’t_to_upd©e
 = &(
Â‘_to_upd©e_
->
G‘CompÚ’t
(
c
));

150 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput
 = 
fÜw¬d_d©a_
[
c
],

151 &
	gouut
 = 
fÜw¬d_d©a_
[
c
+1],

152 &
	gouut_d”iv
 = *
tmp_d”iv
;

153 
	gCuM©rix
<
	gBa£Flßt
> 
	gšput_d”iv
;

154 
	gcompÚ’t
.
Back´İ
(
chunk_šfo_
[
c
], chunk_šfo_[c+1], 
šput
, 
ouut
, 
ouut_d”iv
,

155 
compÚ’t_to_upd©e
, &
šput_d”iv
);

156 *
	gtmp_d”iv
 = 
šput_d”iv
;

160 
NÃtComputiÚ
(cÚ¡ 
NÃt
 &
Â‘
,

161 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput
,

162 
boŞ
 
·d_šput
,

163 
CuM©rixBa£
<
Ba£Flßt
> *
ouut
) {

164 
NÃtCompu‹r
 
Â‘_compu‹r
(
Â‘
, 
šput
, 
·d_šput
, 
NULL
);

165 
	gÂ‘_compu‹r
.
Prİag©e
();

166 
	gouut
->
CİyFromM©
(
Â‘_compu‹r
.
G‘Ouut
());

169 
NÃtComputiÚChunked
(cÚ¡ 
NÃt
 &
Â‘
,

170 cÚ¡ 
M©rix
<
Ba£Flßt
> &
šput
,

171 
št32
 
chunk_size
,

172 
M©rix
<
Ba£Flßt
> *
ouut
) {

173 
št32
 
	gnum_rows
,

174 
	gnum_chunks
 = 
û
((
Ba£Flßt
)
šput
.
NumRows
(è/ 
chunk_size
),

175 
	gdim
 = 
šput
.
NumCŞs
(),

176 
	gËá_cÚ‹xt
 = 
Â‘
.
LeáCÚ‹xt
(),

177 
	gright_cÚ‹xt
 = 
Â‘
.
RightCÚ‹xt
();

178 
	gM©rix
<
	gBa£Flßt
> 
	gfuÎ_šput
;

179 
	gnum_rows
 = 
Ëá_cÚ‹xt
 + 
šput
.
NumRows
(è+ 
right_cÚ‹xt
;

180 
	gfuÎ_šput
.
Resize
(
num_rows
, 
dim
);

181 
	gfuÎ_šput
.
Rªge
(
Ëá_cÚ‹xt
, 
šput
.
NumRows
(),

182 0, 
dim
).
CİyFromM©
(
šput
);

183 
št32
 
	gi
 = 0; i < 
	gËá_cÚ‹xt
; i++)

184 
	gfuÎ_šput
.
Row
(
i
).
CİyFromVec
(
šput
.Row(0));

185 
št32
 
	gÏ¡_row
 = 
šput
.
NumRows
() - 1;

186 
št32
 
	gi
 = 0; i < 
	gright_cÚ‹xt
; i++)

187 
	gfuÎ_šput
.
Row
(
num_rows
 - 
i
 - 1).
CİyFromVec
(
šput
.Row(
Ï¡_row
));

189 
št32
 
	gi
 = 0; i < 
	gnum_chunks
; i++) {

190 
št32
 
	gšdex
 = 
i
 * 
chunk_size
,

191 
	goff£t
 = 
¡d
::
mš
(
num_rows
 - 
chunk_size
 * 
i
,

192 
Ëá_cÚ‹xt
 + 
chunk_size
 + 
right_cÚ‹xt
);

193 
	gSubM©rix
<
	gBa£Flßt
> 
chunk_šput
(
fuÎ_šput
, 
šdex
, 
off£t
, 0, 
dim
);

194 
	gCuM©rix
<
	gBa£Flßt
> 
cu_chunk_šput
(
chunk_šput
);

198 
NÃtCompu‹r
 
Â‘_compu‹r
(
Â‘
, 
cu_chunk_šput
, 
çl£
, 
NULL
);

199 
	gÂ‘_compu‹r
.
Prİag©e
();

200 
	gCuM©rix
<
	gBa£Flßt
> 
cu_chunk_ouut
(
Â‘_compu‹r
.
G‘Ouut
());

201 
	gSubM©rix
<
	gBa£Flßt
> 
chunk_out
(*
ouut
, 
i
 * 
chunk_size
,

202 
cu_chunk_ouut
.
NumRows
(), 0,

203 
cu_chunk_ouut
.
NumCŞs
());

204 
	gchunk_out
.
CİyFromM©
(
cu_chunk_ouut
);

208 
Ba£Flßt
 
NÃtG¿d›ÁComputiÚ
(cÚ¡ 
NÃt
 &
Â‘
,

209 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput
,

210 
boŞ
 
·d_šput
,

211 cÚ¡ 
Po¡”iÜ
 &
pdf_po¡
,

212 
NÃt
 *
Â‘_to_upd©e
) {

213 
NÃtCompu‹r
 
Â‘_compu‹r
(
Â‘
, 
šput
, 
·d_šput
, 
Â‘_to_upd©e
);

214 
	gÂ‘_compu‹r
.
Prİag©e
();

215 
	gCuM©rix
<
	gBa£Flßt
> 
	gd”iv
;

216 
Ba£Flßt
 
	gªs
;

217 
	gªs
 = 
Â‘_compu‹r
.
Compu‹La¡Lay”D”iv
(
pdf_po¡
, &
d”iv
);

218 
	gÂ‘_compu‹r
.
Back´İ
(&
d”iv
);

219  
	gªs
;

	@nnet-compute.h

21 #iâdeà
KALDI_NNET2_NNET_COMPUTE_H_


22 
	#KALDI_NNET2_NNET_COMPUTE_H_


	)

24 
	~"Â‘2/Â‘-Â‘.h
"

26 
Çme¥aû
 
	gk®di
 {

27 
Çme¥aû
 
	gÂ‘2
 {

45 
NÃtComputiÚ
(cÚ¡ 
NÃt
 &
Â‘
,

46 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
šput
,

47 
boŞ
 
·d_šput
,

48 
CuM©rixBa£
<
Ba£Flßt
> *
ouut
);

58 
NÃtComputiÚChunked
(cÚ¡ 
NÃt
 &
Â‘
,

59 cÚ¡ 
M©rix
<
Ba£Flßt
> &
šput
,

60 
št32
 
chunk_size
,

61 
M©rix
<
Ba£Flßt
> *
ouut
);

73 
Ba£Flßt
 
NÃtG¿d›ÁComputiÚ
(cÚ¡ 
NÃt
 &
Â‘
,

74 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
šput
,

75 
boŞ
 
·d_šput
,

76 
Ba£Flßt
 
u‰”ªû_weight
,

77 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
Ïb–s
,

78 
NÃt
 *
Â‘_to_upd©e
);

	@nnet-example-functions-test.cc

20 
	~"Â‘2/Â‘-exam¶e-funùiÚs.h
"

21 
	~"ut/commÚ-uts.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

29 
Un™Te¡SŞvePackšgProbËm
() {

30 
size_t
 
	gsize
 = 
Rªd
() % 20;

31 
	g¡d
::
veùÜ
<
Ba£Flßt
> 
™em_co¡s
;

32 
size_t
 
	gi
 = 0; i < 
	gsize
; i++) {

33 
	g™em_co¡s
.
push_back
(0.5 * (
Rªd
() % 15));

35 
Ba£Flßt
 
	gmax_co¡
 = 0.66 + 
Rªd
() % 5;

37 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
size_t
> > 
groups
;

38 
SŞvePackšgProbËm
(
max_co¡
, 
™em_co¡s
, &
groups
);

40 
	g¡d
::
veùÜ
<
size_t
> 
®l_šdiûs
;

41 
size_t
 
	gi
 = 0; i < 
	ggroups
.
size
(); i++) {

42 
Ba£Flßt
 
	gthis_group_co¡
 = 0.0;

43 
size_t
 
	gj
 = 0; j < 
	ggroups
[
i
].
size
(); j++) {

44 
size_t
 
	gšdex
 = 
groups
[
i
][
j
];

45 
	g®l_šdiûs
.
push_back
(
šdex
);

46 
	gthis_group_co¡
 +ğ
™em_co¡s
[
šdex
];

48 
KALDI_ASSERT
(!
groups
[
i
].
em±y
());

49 
KALDI_ASSERT
(
groups
[
i
].
size
(è=ğ1 || 
this_group_co¡
 <ğ
max_co¡
);

51 
SÜtAndUniq
(&
®l_šdiûs
);

52 
KALDI_ASSERT
(
®l_šdiûs
.
size
() == size);

53 ià(!
	g®l_šdiûs
.
em±y
())

54 
KALDI_ASSERT
(
®l_šdiûs
.
back
(è+ 1 =ğ
size
);

62 
	$maš
() {

63 
usšg
 
Çme¥aû
 
k®di
;

64 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

65 
usšg
 
k®di
::
št32
;

66 
št32
 
i
 = 0; i < 10; i++)

67 
	`Un™Te¡SŞvePackšgProbËm
();

68 
	}
}

	@nnet-example-functions.cc

20 
	~"Â‘2/Â‘-exam¶e-funùiÚs.h
"

21 
	~"Ït/Ï‰iû-funùiÚs.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

27 
boŞ
 
L©tiûToDisüimš©iveExam¶e
(

28 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
®ignm’t
,

29 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

30 cÚ¡ 
Com·ùL©tiû
 &
ş©
,

31 
Ba£Flßt
 
weight
,

32 
št32
 
Ëá_cÚ‹xt
,

33 
št32
 
right_cÚ‹xt
,

34 
Disüimš©iveNÃtExam¶e
 *
eg
) {

35 
KALDI_ASSERT
(
Ëá_cÚ‹xt
 >ğ0 && 
right_cÚ‹xt
 >= 0);

36 
št32
 
	gnum_äames
 = 
®ignm’t
.
size
();

37 ià(
	gnum_äames
 == 0) {

38 
KALDI_WARN
 << "Empty‡lignment";

39  
	gçl£
;

41 ià(
	gnum_äames
 !ğ
ã©s
.
NumRows
()) {

42 
KALDI_WARN
 << "Dim’siÚ mism©ch:‡lignm’ˆ" << 
num_äames


43 << " v”su ã© " << 
ã©s
.
NumRows
();

44  
	gçl£
;

46 
	g¡d
::
veùÜ
<
št32
> 
times
;

47 
št32
 
	gnum_äames_ş©
 = 
Com·ùL©tiûS‹Times
(
ş©
, &
times
);

48 ià(
	gnum_äames_ş©
 !ğ
num_äames
) {

49 
KALDI_WARN
 << "Numerator/frames versus denlat frames mismatch: "

50 << 
num_äames
 << " v”su " << 
num_äames_ş©
;

51  
	gçl£
;

53 
	geg
->
	gweight
 = 
weight
;

54 
	geg
->
	gnum_®i
 = 
®ignm’t
;

55 
	geg
->
	gd’_Ït
 = 
ş©
;

57 
št32
 
	gã©_dim
 = 
ã©s
.
NumCŞs
();

58 
	geg
->
	gšput_äames
.
Resize
(
Ëá_cÚ‹xt
 + 
num_äames
 + 
right_cÚ‹xt
,

59 
ã©_dim
);

60 
	geg
->
	gšput_äames
.
Rªge
(
Ëá_cÚ‹xt
, 
num_äames
,

61 0, 
ã©_dim
).
CİyFromM©
(
ã©s
);

64 
št32
 
	gt
 = 0; < 
	gËá_cÚ‹xt
;++)

65 
	geg
->
	gšput_äames
.
Row
(
t
).
CİyFromVec
(
ã©s
.Row(0));

66 
št32
 
	gt
 = 0; < 
	gright_cÚ‹xt
;++)

67 
	geg
->
	gšput_äames
.
Row
(
Ëá_cÚ‹xt
 + 
num_äames
 + 
t
).
CİyFromVec
(

68 
ã©s
.
Row
(
num_äames
 - 1));

70 
	geg
->
	gËá_cÚ‹xt
 = 
Ëá_cÚ‹xt
;

71 
	geg
->
Check
();

72  
	gŒue
;

100 şas 
	cDisüimš©iveExam¶eS¶™‹r
 {

101 
	gpublic
:

102 
Disüimš©iveExam¶eS¶™‹r
(

103 cÚ¡ 
S¶™Disüimš©iveExam¶eCÚfig
 &
cÚfig
,

104 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

105 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

106 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
egs_out
):

107 
cÚfig_
(
cÚfig
), 
tmod–_
(
tmod–
), 
eg_
(
eg
), 
egs_out_
(
egs_out
) { }

109 
Exci£
(
S¶™Exam¶eSts
 *
¡©s
) {

110 
	geg_
.
Check
();

111 
P»·»L©tiû
(
çl£
);

112 
Compu‹F¿meInfo
();

113 ià(!
	gcÚfig_
.
	gexci£
) {

114 
	gegs_out_
->
»size
(1);

115 (*
	gegs_out_
)[0] = 
eg_
;

117 
DoExci£
(
¡©s
);

121 
S¶™
(
S¶™Exam¶eSts
 *
¡©s
) {

122 ià(!
	gcÚfig_
.
	g¥l™
) {

123 
	gegs_out_
->
»size
(1);

124 (*
	gegs_out_
)[0] = 
eg_
;

126 
	geg_
.
Check
();

127 
P»·»L©tiû
(
Œue
);

128 
Compu‹F¿meInfo
();

129 
DoS¶™
(
¡©s
);

133 
	g´iv©e
:

134 
L©tiûArc
 
	tArc
;

135 
	gArc
::
	tS‹Id
 StateId;

136 
	gArc
::
	tLab–
 Label;

142 
P»·»L©tiû
(
boŞ
 
fœ¡_time
);

144 
CŞÏp£T¿ns™iÚIds
();

149 
boŞ
 
Compu‹F¿meInfo
();

151 
RemoveAÎOuutSymbŞs
 (
L©tiû
 *
Ït
);

153 
OuutOÃS¶™
(
št32
 
£g_begš
, iÁ32 
£g_’d
);

155 
DoS¶™
(
S¶™Exam¶eSts
 *
¡©s
);

157 
DoExci£
(
S¶™Exam¶eSts
 *
¡©s
);

159 
št32
 
NumF¿mes
(ècÚ¡ {  
	g¡©ic_ÿ¡
<
	gšt32
>(
	geg_
.
	gnum_®i
.
size
()); }

161 
št32
 
RightCÚ‹xt
(è{  
	geg_
.
	gšput_äames
.
NumRows
(è- 
NumF¿mes
(è-ƒg_.
	gËá_cÚ‹xt
; }

166 
C»©eOuutL©tiû
(
št32
 
£g_begš
, iÁ32 
£g_’d
,

167 
Com·ùL©tiû
 *
ş©_out
);

171 
S‹Id
 
G‘OuutS‹Id
(S‹Id 
s
,

172 
unÜd”ed_m­
<
S‹Id
, S‹Id> *
¡©e_m­
,

173 
L©tiû
 *
Ït_out
);

175 
	sF¿meInfo
 {

176 
št32
 
	gd’_¡©e_couÁ
;

177 
št32
 
	gd’_pdf_couÁ
;

178 
boŞ
 
	gmuÉË_Œªs™iÚ_ids
;

181 
boŞ
 
	gnum_d’_ov”Ïp
;

183 
boŞ
 
	gnÚz”o_d”iv©ive
;

185 
boŞ
 
	gÿn_exci£_äame
;

197 
S‹Id
 
	g¡¬t_¡©e
;

203 
S‹Id
 
	g’d_¡©e
;

204 
F¿meInfo
(): 
d’_¡©e_couÁ
(0), 
d’_pdf_couÁ
(0),

205 
muÉË_Œªs™iÚ_ids
(
çl£
),

206 
num_d’_ov”Ïp
(
çl£
), 
nÚz”o_d”iv©ive
(false),

207 
ÿn_exci£_äame
(
çl£
),

208 
¡¬t_¡©e
(
¡d
::
num”ic_lim™s
<
št32
>::
max
()), 
’d_¡©e
(0) { }

213 cÚ¡ 
	gS¶™Disüimš©iveExam¶eCÚfig
 &
	gcÚfig_
;

214 cÚ¡ 
	gT¿ns™iÚMod–
 &
	gtmod–_
;

215 cÚ¡ 
	gDisüimš©iveNÃtExam¶e
 &
	geg_
;

216 
	g¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
egs_out_
;

218 
L©tiû
 
	gÏt_
;

223 
	g¡d
::
veùÜ
<
F¿meInfo
> 
äame_šfo_
;

226 
	g¡d
::
veùÜ
<
št32
> 
¡©e_times_
;

236 
	gDisüimš©iveExam¶eS¶™‹r
::
CŞÏp£T¿ns™iÚIds
() {

237 
¡d
::
veùÜ
<
št32
> 
times
;

238 
TİSÜt
(&
Ït_
);

240 
št32
 
	gnum_äames
 = 
L©tiûS‹Times
(
Ït_
, &
times
);

241 
S‹Id
 
	gnum_¡©es
 = 
Ït_
.
NumS‹s
();

243 
	g¡d
::
veùÜ
<
¡d
::
m­
<
št32
, 
	gšt32
> > 
pdf_to_tid
(
num_äames
);

244 
S‹Id
 
	gs
 = 0; s < 
	gnum_¡©es
; s++) {

245 
št32
 
	gt
 = 
times
[
s
];

246 
	gf¡
::
MubËArcI‹¿tÜ
<
L©tiû
> 
a™”
(&
Ït_
, 
s
);

247 !
	ga™”
.
DÚe
();‡™”.
Next
()) {

248 
KALDI_ASSERT
(
t
 >ğ0 && < 
num_äames
);

249 
Arc
 
	g¬c
 = 
a™”
.
V®ue
();

250 
KALDI_ASSERT
(
¬c
.
ab–
 !ğ0 &&‡rc.ab– =ğ¬c.
Şab–
);

251 
št32
 
	gpdf
 = 
tmod–_
.
T¿ns™iÚIdToPdf
(
¬c
.
ab–
);

252 ià(
	gpdf_to_tid
[
t
].
couÁ
(
pdf
) != 0) {

253 
¬c
.
ab–
 =‡rc.
Şab–
 = 
pdf_to_tid
[
t
][
pdf
];

254 
	ga™”
.
S‘V®ue
(
¬c
);

256 
	gpdf_to_tid
[
t
][
pdf
] = 
¬c
.
ab–
;

263 
	gDisüimš©iveExam¶eS¶™‹r
::
P»·»L©tiû
(
boŞ
 
fœ¡_time
) {

264 ::
f¡
::
CÚv”tL©tiû
(
eg_
.
d’_Ït
, &
Ït_
);

266 
Projeù
(&
Ït_
, 
f¡
::
PROJECT_INPUT
);

269 
RmEpsÚ
(&
Ït_
);

272 ià(
	gfœ¡_time
) {

273 ià(
	gcÚfig_
.
	gcŞÏp£_Œªs™iÚ_ids
 && cÚfig_.
	gü™”iÚ
 != "mpfe")

274 
CŞÏp£T¿ns™iÚIds
();

276 ià(
	gcÚfig_
.
	gd‘”mšize
) {

277 ià(!
	gcÚfig_
.
	gmšimize
) {

278 
L©tiû
 
	gd‘_Ït
;

279 
D‘”mšize
(
Ït_
, &
d‘_Ït
);

280 
	gÏt_
 = 
d‘_Ït
;

282 
L©tiû
 
	gtmp_Ït
;

283 
Rev”£
(
Ït_
, &
tmp_Ït
);

284 
D‘”mšize
(
tmp_Ït
, &
Ït_
);

285 
Rev”£
(
Ït_
, &
tmp_Ït
);

286 
D‘”mšize
(
tmp_Ït
, &
Ït_
);

287 
RmEpsÚ
(&
Ït_
);

294 
TİSÜt
(&
Ït_
);

299 
boŞ
 
	gDisüimš©iveExam¶eS¶™‹r
::
Compu‹F¿meInfo
() {

301 
št32
 
num_äames
 = 
NumF¿mes
();

303 
	gäame_šfo_
.
ş—r
();

304 
	gäame_šfo_
.
»size
(
num_äames
 + 1);

306 
L©tiûS‹Times
(
Ït_
, &
¡©e_times_
);

308 
	g¡d
::
veùÜ
<
¡d
::
£t
<
št32
> > 
pdfs_³r_äame
(
num_äames
),

309 
tids_³r_äame
(
num_äames
);

311 
št32
 
	gnum_¡©es
 = 
Ït_
.
NumS‹s
();

313 
št32
 
	g¡©e
 = 0; s‹ < 
	gnum_¡©es
; state++) {

314 
št32
 
	gt
 = 
¡©e_times_
[
¡©e
];

315 
KALDI_ASSERT
(
t
 >ğ0 && <ğ
num_äames
);

316 
	gäame_šfo_
[
t
].
	gd’_¡©e_couÁ
++;

317 
	gf¡
::
ArcI‹¿tÜ
<
L©tiû
> 
a™”
(
Ït_
, 
¡©e
); !
	ga™”
.
DÚe
();

318 
	ga™”
.
Next
()) {

319 cÚ¡ 
	gL©tiûArc
 &
	g¬c
 = 
a™”
.
V®ue
();

320 
KALDI_ASSERT
(
¬c
.
ab–
 !ğ0 &&‡rc.ab– =ğ¬c.
Şab–
);

321 
št32
 
	gŒªs™iÚ_id
 = 
¬c
.
ab–
,

322 
	gpdf_id
 = 
tmod–_
.
T¿ns™iÚIdToPdf
(
Œªs™iÚ_id
);

323 
	gtids_³r_äame
[
t
].
š£¹
(
Œªs™iÚ_id
);

324 
	gpdfs_³r_äame
[
t
].
š£¹
(
pdf_id
);

326 ià(
	gt
 < 
	gnum_äames
)

327 
	gäame_šfo_
[
t
+1].
	g¡¬t_¡©e
 = 
¡d
::
mš
(
¡©e
,

328 
äame_šfo_
[
t
+1].
¡¬t_¡©e
);

329 
	gäame_šfo_
[
t
].
	g’d_¡©e
 = 
¡d
::
max
(
¡©e
,

330 
äame_šfo_
[
t
].
’d_¡©e
);

333 
št32
 
	gi
 = 1; i <ğ
NumF¿mes
(); i++)

334 
	gäame_šfo_
[
i
].
	g’d_¡©e
 = 
¡d
::
max
(
äame_šfo_
[i-1].
’d_¡©e
,

335 
äame_šfo_
[
i
].
’d_¡©e
);

336 
št32
 
	gi
 = 
NumF¿mes
() - 1; i >= 0; i--)

337 
	gäame_šfo_
[
i
].
	g¡¬t_¡©e
 = 
¡d
::
mš
(
äame_šfo_
[i+1].
¡¬t_¡©e
,

338 
äame_šfo_
[
i
].
¡¬t_¡©e
);

340 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

341 
	gF¿meInfo
 &
	gäame_šfo
 = 
äame_šfo_
[
t
];

342 
št32
 
	gŒªs™iÚ_id
 = 
eg_
.
num_®i
[
t
],

343 
	gpdf_id
 = 
tmod–_
.
T¿ns™iÚIdToPdf
(
Œªs™iÚ_id
);

344 
	gäame_šfo
.
	gnum_d’_ov”Ïp
 = (
pdfs_³r_äame
[
t
].
couÁ
(
pdf_id
) != 0);

345 
	gäame_šfo
.
	gmuÉË_Œªs™iÚ_ids
 = (
tids_³r_äame
[
t
].
size
() > 1);

346 
KALDI_ASSERT
(!
pdfs_³r_äame
[
t
].
em±y
());

347 
	gäame_šfo
.
	gd’_pdf_couÁ
 = 
pdfs_³r_äame
[
t
].
size
();

349 ià(
	gcÚfig_
.
	gü™”iÚ
 =ğ"mpã" || 
cÚfig_
.
ü™”iÚ
 == "smbr") {

350 
äame_šfo
.
nÚz”o_d”iv©ive
 = (äame_šfo.
d’_pdf_couÁ
 > 1);

352 
KALDI_ASSERT
(
cÚfig_
.
ü™”iÚ
 == "mmi");

353 ià(
	gcÚfig_
.
	gdrİ_äames
) {

356 
	gäame_šfo
.
	gnÚz”o_d”iv©ive
 = 
äame_šfo
.
num_d’_ov”Ïp
 &&

357 
äame_šfo
.
d’_¡©e_couÁ
 > 1;

361 
	gäame_šfo
.
	gnÚz”o_d”iv©ive
 = !
äame_šfo
.
num_d’_ov”Ïp
 ||

362 
äame_šfo
.
d’_¡©e_couÁ
 > 1;

369 ià(
	gcÚfig_
.
	gü™”iÚ
 == "mpfe") {

370 
äame_šfo
.
ÿn_exci£_äame
 =

371 !
äame_šfo
.
nÚz”o_d”iv©ive
 && \

372 !
äame_šfo
.
muÉË_Œªs™iÚ_ids
;

378 
	gäame_šfo
.
	gÿn_exci£_äame
 =

379 !
äame_šfo
.
nÚz”o_d”iv©ive
 && f¿me_šfo.
d’_pdf_couÁ
 == 1;

382  
	gŒue
;

398 
	gDisüimš©iveExam¶eS¶™‹r
::
DoExci£
(
S¶™Exam¶eSts
 *
¡©s
) {

399 
št32
 
Ëá_cÚ‹xt
 = 
eg_
.left_context,

400 
	gright_cÚ‹xt
 = 
RightCÚ‹xt
(),

401 
	gnum_äames
 = 
NumF¿mes
();

404 
	g¡d
::
veùÜ
<
boŞ
> 
ÿn_exci£
(
num_äames
, 
çl£
);

406 
boŞ
 
	gÃed_some_äame
 = 
çl£
;

407 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

408 
	gÿn_exci£
[
t
] = 
äame_šfo_
[t].
ÿn_exci£_äame
;

409 ià(!
	gÿn_exci£
[
t
])

410 
	gÃed_some_äame
 = 
Œue
;

412 ià(!
	gÃed_some_äame
) {

414 
	gKALDI_WARN
 << "Example completely„emoved whenƒxcising.";

416 
	gegs_out_
->
ş—r
();

419 
	gegs_out_
->
»size
(1);

420 
	gDisüimš©iveNÃtExam¶e
 &
	geg_out
 = (*
egs_out_
)[0];

424 
št32
 
	g¡¬t_t
, 
	g’d_t
;

425 
	g¡¬t_t
 = 0; 
	gÿn_exci£
[
¡¬t_t
]; start_t++);

426 
	g’d_t
 = 
num_äames
; 
	gÿn_exci£
[
’d_t
-1];ƒnd_t--);

433 
	g¡d
::
veùÜ
<
boŞ
> 
wl_exci£
(
ÿn_exci£
);

434 
št32
 
	gt
 = 
¡¬t_t
; < 
	g’d_t
;++) {

435 
št32
 
	gt2
 = 
t
 - 
right_cÚ‹xt
;2 <ğˆ+ 
Ëá_cÚ‹xt
;2++)

436 ià(
	gt2
 >ğ
¡¬t_t
 && 
t2
 < 
’d_t
 && !
ÿn_exci£
[t2])

437 
wl_exci£
[
t
] = 
çl£
;

444 
št32
 
	gnum_¡©es
 = 
Ït_
.
NumS‹s
();

445 
št32
 
	g¡©e
 = 0; s‹ < 
	gnum_¡©es
; state++) {

446 
št32
 
	gt
 = 
¡©e_times_
[
¡©e
];

447 ::
f¡
::
MubËArcI‹¿tÜ
<
L©tiû
> 
a™”
(&
Ït_
, 
¡©e
); !
	ga™”
.
DÚe
();

448 
	ga™”
.
Next
()) {

449 
Arc
 
	g¬c
 = 
a™”
.
V®ue
();

450 ià(
	gwl_exci£
[
t
]) {

451 
	g¬c
.
	gab–
 = 
¬c
.
Şab–
 = 0;

452 
	ga™”
.
S‘V®ue
(
¬c
);

456 
RmEpsÚ
(&
Ït_
);

457 
RemoveAÎOuutSymbŞs
(&
Ït_
);

458 
CÚv”tL©tiû
(
Ït_
, &
eg_out
.
d’_Ït
);

460 
	geg_out
.
	gnum_®i
.
ş—r
();

461 
št32
 
	gnum_äames_k•t
 = 0;

462 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

463 ià(!
	gwl_exci£
[
t
]) {

464 
	geg_out
.
	gnum_®i
.
push_back
(
eg_
.
num_®i
[
t
]);

465 
	gnum_äames_k•t
++;

469 
	g¡©s
->
	gnum_äames_k•t_aá”_exci£
 +ğ
num_äames_k•t
;

470 
	g¡©s
->
	glÚge¡_£gm’t_aá”_exci£
 = 
¡d
::
max
(
¡©s
->
lÚge¡_£gm’t_aá”_exci£
,

471 
num_äames_k•t
);

473 
št32
 
	gnum_äames_k•t_¶us
 = 
num_äames_k•t
 + 
Ëá_cÚ‹xt
 + 
right_cÚ‹xt
;

474 
	geg_out
.
	gšput_äames
.
Resize
(
num_äames_k•t_¶us
,

475 
eg_
.
šput_äames
.
NumCŞs
());

479 
št32
 
	gi
 = 0; i < 
	gËá_cÚ‹xt
; i++) {

480 
	gSubVeùÜ
<
	gBa£Flßt
> 
d¡
(
eg_out
.
šput_äames
, 
i
);

481 
	gSubVeùÜ
<
	gBa£Flßt
> 
¤c
(
eg_
.
šput_äames
, 
¡¬t_t
 + 
i
);

482 
	gd¡
.
CİyFromVec
(
¤c
);

486 
št32
 
	gi
 = 0; i < 
	gright_cÚ‹xt
; i++) {

487 
	gSubVeùÜ
<
	gBa£Flßt
> 
d¡
(
eg_out
.
šput_äames
,

488 
num_äames_k•t
 + 
Ëá_cÚ‹xt
 + 
i
);

489 
	gSubVeùÜ
<
	gBa£Flßt
> 
¤c
(
eg_
.
šput_äames
,

490 
’d_t
 + 
Ëá_cÚ‹xt
 + 
i
);

491 
	gd¡
.
CİyFromVec
(
¤c
);

494 
št32
 
	gd¡_t
 = 0;

495 
št32
 
	gt
 = 
¡¬t_t
; < 
	g’d_t
;++) {

496 ià(!
	gwl_exci£
[
t
]) {

497 
	gSubVeùÜ
<
	gBa£Flßt
> 
d¡
(
eg_out
.
šput_äames
,

498 
Ëá_cÚ‹xt
 + 
d¡_t
);

499 
	gSubVeùÜ
<
	gBa£Flßt
> 
¤c
(
eg_
.
šput_äames
,

500 
Ëá_cÚ‹xt
 + 
t
);

501 
	gd¡
.
CİyFromVec
(
¤c
);

502 
	gd¡_t
++;

505 
KALDI_ASSERT
(
d¡_t
 =ğ
num_äames_k•t
);

508 
	geg_out
.
	gweight
 = 
eg_
.
weight
;

509 
	geg_out
.
	gËá_cÚ‹xt
 = 
eg_
.
Ëá_cÚ‹xt
;

510 
	geg_out
.
	g¥k_šfo
 = 
eg_
.
¥k_šfo
;

512 
	geg_out
.
Check
();

516 
	gDisüimš©iveExam¶eS¶™‹r
::
DoS¶™
(
S¶™Exam¶eSts
 *
¡©s
) {

517 
¡d
::
veùÜ
<
št32
> 
¥l™_pošts
;

518 
št32
 
	gnum_äames
 = 
NumF¿mes
();

525 
	g¥l™_pošts
.
push_back
(0);

526 
št32
 
	gt
 = 1; < 
	gnum_äames
;++) {

527 ià(
	gäame_šfo_
[
t
].
	gd’_¡©e_couÁ
 == 1 &&

528 
äame_šfo_
[
t
-1].
d’_¡©e_couÁ
 > 1)

529 
¥l™_pošts
.
push_back
(
t
);

531 
	g¥l™_pošts
.
push_back
(
num_äames
);

534 
	g¡d
::
veùÜ
<
boŞ
> 
is_k•t
(
¥l™_pošts
.
size
() - 1);

538 
size_t
 
	gs
 = 0; s < 
	gis_k•t
.
size
(); s++) {

539 
št32
 
	g¡¬t
 = 
¥l™_pošts
[
s
], 
	g’d
 = split_points[s+1];

540 
boŞ
 
	gk“p_this_¥l™
 = 
çl£
;

541 
št32
 
	gt
 = 
¡¬t
; < 
	g’d
;++)

542 ià(
	gäame_šfo_
[
t
].
	gnÚz”o_d”iv©ive
)

543 
	gk“p_this_¥l™
 = 
Œue
;

544 
	gis_k•t
[
s
] = 
k“p_this_¥l™
;

548 
	gegs_out_
->
ş—r
();

549 
	gegs_out_
->
»£rve
(
is_k•t
.
size
());

551 
	g¡©s
->
	gnum_Ï‰iûs
++;

552 
	g¡©s
->
	glÚge¡_Ï‰iû
 = 
¡d
::
max
(
¡©s
->
lÚge¡_Ï‰iû
, 
num_äames
);

553 
	g¡©s
->
	gnum_£gm’ts
 +ğ
is_k•t
.
size
();

554 
	g¡©s
->
	gnum_äames_Üig
 +ğ
num_äames
;

555 
št32
 
	gt
 = 0; < 
	gnum_äames
;++)

556 ià(
	gäame_šfo_
[
t
].
	gnÚz”o_d”iv©ive
)

557 
	g¡©s
->
	gnum_äames_mu¡_k“p
++;

559 
size_t
 
	gs
 = 0; s < 
	gis_k•t
.
size
(); s++) {

560 ià(
	gis_k•t
[
s
]) {

561 
	g¡©s
->
	gnum_k•t_£gm’ts
++;

562 
OuutOÃS¶™
(
¥l™_pošts
[
s
], split_points[s+1]);

563 
št32
 
	g£gm’t_Ën
 = 
¥l™_pošts
[
s
+1] - split_points[s];

564 
	g¡©s
->
	gnum_äames_k•t_aá”_¥l™
 +ğ
£gm’t_Ën
;

565 
	g¡©s
->
	glÚge¡_£gm’t_aá”_¥l™
 =

566 
¡d
::
max
(
¡©s
->
lÚge¡_£gm’t_aá”_¥l™
, 
£gm’t_Ën
);

573 
	gS¶™Exam¶eSts
::
Pršt
() {

574 
KALDI_LOG
 << "S¶™ " << 
num_Ï‰iûs
 << "†attices. Stats:";

575 
	gk•t_£gs_³r_Ït
 = 
num_k•t_£gm’ts
 * 1.0 / 
num_Ï‰iûs
,

576 
	g£gs_³r_Ït
 = 
num_£gm’ts
 * 1.0 / 
num_Ï‰iûs
;

578 
	gKALDI_LOG
 << "MadÚ‡v”ag" << 
	g£gs_³r_Ït
 << " segments…er†attice, "

579 << "oàwhich " << 
	gk•t_£gs_³r_Ït
 << " were kept.";

581 
	g³rûÁ_Ãeded
 = 
num_äames_mu¡_k“p
 * 100.0 / 
num_äames_Üig
,

582 
	g³rûÁ_aá”_¥l™
 = 
num_äames_k•t_aá”_¥l™
 * 100.0 / 
num_äames_Üig
,

583 
	g³rûÁ_aá”_exci£
 = 
num_äames_k•t_aá”_exci£
 * 100.0 / 
num_äames_Üig
;

585 
	gKALDI_LOG
 << "N“dedØk“°" << 
	g³rûÁ_Ãeded
 << "% of frames,‡fter split "

586 << "k•ˆ" << 
	g³rûÁ_aá”_¥l™
 << "%,‡fterƒxcising frames kept "

587 << 
	g³rûÁ_aá”_exci£
 << "%.";

589 
	gKALDI_LOG
 << "LÚge¡†©tiû had " << 
	glÚge¡_Ï‰iû


591 << 
	glÚge¡_£gm’t_aá”_¥l™


593 << 
	glÚge¡_£gm’t_aá”_exci£
;

596 
	gDisüimš©iveExam¶eS¶™‹r
::
OuutOÃS¶™
(
št32
 
£g_begš
,

597 
št32
 
£g_’d
) {

598 
KALDI_ASSERT
(
£g_begš
 >ğ0 && 
£g_’d
 > seg_begš && seg_’d <ğ
NumF¿mes
());

599 
	gegs_out_
->
»size
(
egs_out_
->
size
() + 1);

600 
št32
 
	gËá_cÚ‹xt
 = 
eg_
.
Ëá_cÚ‹xt
, 
	gright_cÚ‹xt
 = 
RightCÚ‹xt
(),

601 
	gtÙ_cÚ‹xt
 = 
Ëá_cÚ‹xt
 + 
right_cÚ‹xt
;

602 
	gDisüimš©iveNÃtExam¶e
 &
	geg_out
 = 
egs_out_
->
back
();

603 
	geg_out
.
	gweight
 = 
eg_
.
weight
;

605 
	geg_out
.
	gnum_®i
.
š£¹
(
eg_out
.
num_®i
.
’d
(),

606 
eg_
.
num_®i
.
begš
(è+ 
£g_begš
,

607 
eg_
.
num_®i
.
begš
(è+ 
£g_’d
);

609 
C»©eOuutL©tiû
(
£g_begš
, 
£g_’d
, &(
eg_out
.
d’_Ït
));

611 
	geg_out
.
	gšput_äames
 = 
eg_
.
šput_äames
.
Rªge
(
£g_begš
, 
£g_’d
 - seg_begin +

612 
tÙ_cÚ‹xt
,

613 0, 
eg_
.
šput_äames
.
NumCŞs
());

615 
	geg_out
.
	gËá_cÚ‹xt
 = 
eg_
.
Ëá_cÚ‹xt
;

617 
	geg_out
.
	g¥k_šfo
 = 
eg_
.
¥k_šfo
;

619 
	geg_out
.
Check
();

623 
	gDisüimš©iveExam¶eS¶™‹r
::
RemoveAÎOuutSymbŞs
(
L©tiû
 *
Ït
) {

624 
S‹Id
 
s
 = 0; 
	gs
 < 
	gÏt
->
NumS‹s
(); s++) {

625 ::
f¡
::
MubËArcI‹¿tÜ
<
L©tiû
> 
a™”
(
Ït
, 
s
); !
	ga™”
.
DÚe
();

626 
	ga™”
.
Next
()) {

627 
Arc
 
	g¬c
 = 
a™”
.
V®ue
();

628 
	g¬c
.
	gŞab–
 = 0;

629 
	ga™”
.
S‘V®ue
(
¬c
);

634 
	gDisüimš©iveExam¶eS¶™‹r
::
S‹Id


635 
Disüimš©iveExam¶eS¶™‹r
::
G‘OuutS‹Id
(

636 
S‹Id
 
s
, 
unÜd”ed_m­
<S‹Id, S‹Id> *
¡©e_m­
, 
L©tiû
 *
Ït_out
) {

637 ià(
	g¡©e_m­
->
couÁ
(
s
) == 0) {

638  ((*
¡©e_m­
)[
s
] = 
Ït_out
->
AddS‹
());

640  (*
	g¡©e_m­
)[
s
];

644 
	gDisüimš©iveExam¶eS¶™‹r
::
C»©eOuutL©tiû
(

645 
št32
 
£g_begš
, iÁ32 
£g_’d
,

646 
Com·ùL©tiû
 *
ş©_out
) {

647 
L©tiû
 
	gÏt_out
;

651 
	gunÜd”ed_m­
<
	gS‹Id
, S‹Id> 
	g¡©e_m­
;

656 
S‹Id
 
	gs
 = 
äame_šfo_
[
£g_begš
].
¡¬t_¡©e
;

657 
	gs
 <ğ
äame_šfo_
[
£g_’d
].
’d_¡©e
; s++) {

658 
št32
 
	gt
 = 
¡©e_times_
[
s
];

660 ià(
	gt
 < 
	g£g_begš
 || > 
	g£g_’d
)

663 
št32
 
	gthis_¡©e
 = 
G‘OuutS‹Id
(
s
, &
¡©e_m­
, &
Ït_out
);

665 ià(
	gt
 =ğ
£g_begš
)

666 
Ït_out
.
S‘S¹
(
this_¡©e
);

668 ià(
	gt
 =ğ
£g_’d
) {

669 ià(
£g_’d
 =ğ
NumF¿mes
()) {

670 
Ït_out
.
S‘Fš®
(
this_¡©e
, 
Ït_
.
Fš®
(
s
));

672 
	gÏt_out
.
S‘Fš®
(
this_¡©e
, 
L©tiûWeight
::
OÃ
());

677 
	gf¡
::
ArcI‹¿tÜ
<
L©tiû
> 
a™”
(
Ït_
, 
s
); !
	ga™”
.
DÚe
();‡™”.
Next
()) {

678 cÚ¡ 
	gArc
 &
	g¬c
 = 
a™”
.
V®ue
();

679 
S‹Id
 
	gÃxt_¡©e
 = 
G‘OuutS‹Id
(
¬c
.
Ãxt¡©e
,

680 &
¡©e_m­
, &
Ït_out
);

681 
KALDI_ASSERT
(
¬c
.
ab–
 !ğ0 &&‡rc.ab– =ğ¬c.
Şab–
);

682 
	gÏt_out
.
AddArc
(
this_¡©e
, 
Arc
(
¬c
.
ab–
,‡rc.
Şab–
,‡rc.
weight
,

683 
Ãxt_¡©e
));

686 
CÚÃù
(&
Ït_out
);

688 
KALDI_ASSERT
(
Ït_out
.
NumS‹s
() > 0);

689 
RemoveAÎOuutSymbŞs
(&
Ït_out
);

690 
CÚv”tL©tiû
(
Ït_out
, 
ş©_out
);

764 
S¶™Disüimš©iveExam¶e
(

765 cÚ¡ 
S¶™Disüimš©iveExam¶eCÚfig
 &
cÚfig
,

766 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

767 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

768 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
egs_out
,

769 
S¶™Exam¶eSts
 *
¡©s_out
) {

770 
Disüimš©iveExam¶eS¶™‹r
 
¥l™‹r
(
cÚfig
, 
tmod–
, 
eg
, 
egs_out
);

771 
	g¥l™‹r
.
S¶™
(
¡©s_out
);

775 
Exci£Disüimš©iveExam¶e
(

776 cÚ¡ 
S¶™Disüimš©iveExam¶eCÚfig
 &
cÚfig
,

777 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

778 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

779 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
egs_out
,

780 
S¶™Exam¶eSts
 *
¡©s_out
) {

781 
Disüimš©iveExam¶eS¶™‹r
 
¥l™‹r
(
cÚfig
, 
tmod–
, 
eg
, 
egs_out
);

782 
	g¥l™‹r
.
Exci£
(
¡©s_out
);

786 
Upd©eHash
(

787 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

788 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

789 
¡d
::
¡ršg
 
ü™”iÚ
,

790 
boŞ
 
drİ_äames
,

791 
boŞ
 
Úe_s’û_şass
,

792 
M©rix
<> *
hash
,

793 *
num_weight
,

794 *
d’_weight
,

795 *
tÙ_t
) {

796 
št32
 
	gã©_dim
 = 
eg
.
šput_äames
.
NumCŞs
(),

797 
	gËá_cÚ‹xt
 = 
eg
.
Ëá_cÚ‹xt
,

798 
	gnum_äames
 = 
eg
.
num_®i
.
size
(),

799 
	gright_cÚ‹xt
 = 
eg
.
šput_äames
.
NumRows
(è- 
num_äames
 - 
Ëá_cÚ‹xt
,

800 
	gcÚ‹xt_width
 = 
Ëá_cÚ‹xt
 + 1 + 
right_cÚ‹xt
;

801 *
	gtÙ_t
 +ğ
num_äames
;

802 
KALDI_ASSERT
(
right_cÚ‹xt
 >= 0);

803 
KALDI_ASSERT
(
hash
 !ğ
NULL
);

804 ià(
	ghash
->
NumRows
() == 0) {

805 
hash
->
Resize
(
tmod–
.
NumPdfs
(), 
ã©_dim
);

807 
KALDI_ASSERT
(
hash
->
NumRows
(è=ğ
tmod–
.
NumPdfs
() &&

808 
hash
->
NumCŞs
(è=ğ
ã©_dim
);

811 
Po¡”iÜ
 
	gpo¡
;

812 
	g¡d
::
veùÜ
<
št32
> 
s’û_phÚes
;

815 
Exam¶eToPdfPo¡
(
tmod–
, 
s’û_phÚes
, 
ü™”iÚ
, 
drİ_äames
,

816 
Úe_s’û_şass
, 
eg
, &
po¡
);

818 
	gVeùÜ
<
	gBa£Flßt
> 
avg_ã©
(
ã©_dim
);

820 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

821 
	gSubM©rix
<
	gBa£Flßt
> 
cÚ‹xt_wšdow
(
eg
.
šput_äames
,

822 
t
, 
cÚ‹xt_width
,

823 0, 
ã©_dim
);

825 
	gavg_ã©
.
AddRowSumM©
(1.0 / 
cÚ‹xt_width
, 
cÚ‹xt_wšdow
, 0.0);

826 
	gVeùÜ
<> 
avg_ã©_dbl
(
avg_ã©
);

827 
size_t
 
	gi
 = 0; i < 
	gpo¡
[
t
].
size
(); i++) {

828 
št32
 
	gpdf_id
 = 
po¡
[
t
][
i
].
fœ¡
;

829 
Ba£Flßt
 
	gweight
 = 
po¡
[
t
][
i
].
£cÚd
;

830 
	ghash
->
Row
(
pdf_id
).
AddVec
(
weight
, 
avg_ã©_dbl
);

831 ià(
	gweight
 > 0.0è*
	gnum_weight
 +ğ
weight
;

832 *
	gd’_weight
 +ğ-
weight
;

838 
Exam¶eToPdfPo¡
(

839 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

840 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
s’û_phÚes
,

841 
¡d
::
¡ršg
 
ü™”iÚ
,

842 
boŞ
 
drİ_äames
,

843 
boŞ
 
Úe_s’û_şass
,

844 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

845 
Po¡”iÜ
 *
po¡
) {

846 
KALDI_ASSERT
(
ü™”iÚ
 == "mpfe" || criterion == "smbr" || criterion == "mmi");

848 
L©tiû
 
	gÏt
;

849 
CÚv”tL©tiû
(
eg
.
d’_Ït
, &
Ït
);

850 
TİSÜt
(&
Ït
);

851 ià(
	gü™”iÚ
 =ğ"mpã" || 
ü™”iÚ
 == "smbr") {

852 
Po¡”iÜ
 
tid_po¡
;

853 
L©tiûFÜw¬dBackw¬dM³V¬ŸÁs
(
tmod–
, 
s’û_phÚes
, 
Ït
, 
eg
.
num_®i
,

854 
ü™”iÚ
, 
Úe_s’û_şass
, &
tid_po¡
);

856 
CÚv”tPo¡”iÜToPdfs
(
tmod–
, 
tid_po¡
, 
po¡
);

858 
boŞ
 
	gcÚv”t_to_pdf_ids
 = 
Œue
, 
	gÿnûl
 =rue;

859 
L©tiûFÜw¬dBackw¬dMmi
(
tmod–
, 
Ït
, 
eg
.
num_®i
,

860 
drİ_äames
, 
cÚv”t_to_pdf_ids
, 
ÿnûl
,

861 
po¡
);

863 
SÿËPo¡”iÜ
(
eg
.
weight
, 
po¡
);

867 
SŞvePackšgProbËm
(
Ba£Flßt
 
max_co¡
,

868 cÚ¡ 
¡d
::
veùÜ
<
Ba£Flßt
> &
co¡s
,

869 
¡d
::
veùÜ
<¡d::veùÜ<
size_t
> > *
groups
) {

870 
groups
->
ş—r
();

871 
	g¡d
::
veùÜ
<
Ba£Flßt
> 
group_co¡s
;

872 
size_t
 
	gi
 = 0; i < 
	gco¡s
.
size
(); i++) {

873 
boŞ
 
	gfound_group
 = 
çl£
;

874 
Ba£Flßt
 
	gthis_co¡
 = 
co¡s
[
i
];

875 
size_t
 
	gj
 = 0; j < 
	ggroups
->
size
(); j++) {

876 ià(
	ggroup_co¡s
[
j
] + 
	gthis_co¡
 <ğ
max_co¡
) {

877 (*
groups
)[
j
].
push_back
(
i
);

878 
	ggroup_co¡s
[
j
] +ğ
this_co¡
;

879 
	gfound_group
 = 
Œue
;

883 ià(!
	gfound_group
) {

884 
	ggroups
->
»size
(
groups
->
size
() + 1);

885 
	ggroups
->
back
().
push_back
(
i
);

886 
	ggroup_co¡s
.
push_back
(
this_co¡
);

891 
Aµ’dDisüimš©iveExam¶es
(

892 cÚ¡ 
¡d
::
veùÜ
<cÚ¡ 
Disüimš©iveNÃtExam¶e
*> &
šput
,

893 
Disüimš©iveNÃtExam¶e
 *
ouut
) {

894 
KALDI_ASSERT
(!
šput
.
em±y
());

895 cÚ¡ 
	gDisüimš©iveNÃtExam¶e
 &
	geg0
 = *(
šput
[0]);

897 
št32
 
	gdim
 = 
eg0
.
šput_äames
.
NumCŞs
(è+ƒg0.
¥k_šfo
.
Dim
(),

898 
	gËá_cÚ‹xt
 = 
eg0
.
Ëá_cÚ‹xt
,

899 
	gnum_äames
 = 
eg0
.
num_®i
.
size
(),

900 
	gright_cÚ‹xt
 = 
eg0
.
šput_äames
.
NumRows
(è- 
num_äames
 - 
Ëá_cÚ‹xt
;

902 
št32
 
	gtÙ_äames
 = 
eg0
.
šput_äames
.
NumRows
();

904 
size_t
 
	gi
 = 1; i < 
	gšput
.
size
(); i++)

905 
	gtÙ_äames
 +ğ
šput
[
i
]->
šput_äames
.
NumRows
();

907 
št32
 
	g¬b™¿ry_tid
 = 1;

913 
	gouut
->
	gd’_Ït
 = 
eg0
.
d’_Ït
;

914 
	gouut
->
	gnum_®i
 = 
eg0
.
num_®i
;

915 
	gouut
->
	gšput_äames
.
Resize
(
tÙ_äames
, 
dim
, 
kUndefšed
);

916 
	gouut
->
	gšput_äames
.
Rªge
(0, 
eg0
.
šput_äames
.
NumRows
(),

917 0, 
eg0
.
šput_äames
.
NumCŞs
()).
CİyFromM©
(eg0.input_frames);

918 ià(
	geg0
.
	g¥k_šfo
.
Dim
() != 0) {

919 
ouut
->
šput_äames
.
Rªge
(0, 
eg0
.šput_äames.
NumRows
(),

920 
eg0
.
šput_äames
.
NumCŞs
(),ƒg0.
¥k_šfo
.
Dim
()).

921 
CİyRowsFromVec
(
eg0
.
¥k_šfo
);

924 
	gouut
->
	gnum_®i
.
»£rve
(
tÙ_äames
 - 
Ëá_cÚ‹xt
 - 
right_cÚ‹xt
);

925 
	gouut
->
	gweight
 = 
eg0
.
weight
;

926 
	gouut
->
	gËá_cÚ‹xt
 = 
eg0
.
Ëá_cÚ‹xt
;

927 
	gouut
->
	g¥k_šfo
.
Resize
(0);

929 
Com·ùL©tiû
 
	gš‹r_£gm’t_ş©
;

930 
št32
 
	gš™Ÿl
 = 
š‹r_£gm’t_ş©
.
AddS‹
();

931 
	gš‹r_£gm’t_ş©
.
S‘S¹
(
š™Ÿl
);

933 
	g¡d
::
veùÜ
<
št32
> 
š‹r_£gm’t_®i
(
Ëá_cÚ‹xt
 + 
right_cÚ‹xt
);

934 
	g¡d
::
fl
(
š‹r_£gm’t_®i
.
begš
(), iÁ”_£gm’t_®i.
’d
(), 
¬b™¿ry_tid
);

936 
Com·ùL©tiûWeight
 
	gfš®_weight
 = Com·ùL©tiûWeight::
OÃ
();

937 
	gfš®_weight
.
S‘SŒšg
(
š‹r_£gm’t_®i
);

938 
	gš‹r_£gm’t_ş©
.
S‘Fš®
(
š™Ÿl
, 
fš®_weight
);

940 
št32
 
	gã©_off£t
 = 
eg0
.
šput_äames
.
NumRows
();

942 
size_t
 
	gi
 = 1; i < 
	gšput
.
size
(); i++) {

943 cÚ¡ 
	gDisüimš©iveNÃtExam¶e
 &
	geg_i
 = *(
šput
[
i
]);

945 
	gouut
->
	gšput_äames
.
Rªge
(
ã©_off£t
, 
eg_i
.
šput_äames
.
NumRows
(),

946 0, 
eg_i
.
šput_äames
.
NumCŞs
()).
CİyFromM©
(

947 
eg_i
.
šput_äames
);

948 ià(
	geg_i
.
	g¥k_šfo
.
Dim
() != 0) {

949 
ouut
->
šput_äames
.
Rªge
(
ã©_off£t
, 
eg_i
.šput_äames.
NumRows
(),

950 
eg_i
.
šput_äames
.
NumCŞs
(),

951 
eg_i
.
¥k_šfo
.
Dim
()).
CİyRowsFromVec
(

952 
eg_i
.
¥k_šfo
);

953 
KALDI_ASSERT
(
eg_i
.
šput_äames
.
NumCŞs
() +

954 
eg_i
.
¥k_šfo
.
Dim
(è=ğ
dim
);

957 
	gouut
->
	gnum_®i
.
š£¹
(
ouut
->
num_®i
.
’d
(),

958 
š‹r_£gm’t_®i
.
begš
(), iÁ”_£gm’t_®i.
’d
());

959 
	gouut
->
	gnum_®i
.
š£¹
(
ouut
->
num_®i
.
’d
(),

960 
eg_i
.
num_®i
.
begš
(),ƒg_i.num_®i.
’d
());

961 
CÚÿt
(&(
ouut
->
d’_Ït
), 
š‹r_£gm’t_ş©
);

962 
CÚÿt
(&(
ouut
->
d’_Ït
), 
eg_i
.den_lat);

963 
KALDI_ASSERT
(
ouut
->
weight
 =ğ
eg_i
.weight);

964 
KALDI_ASSERT
(
ouut
->
Ëá_cÚ‹xt
 =ğ
eg_i
.left_context);

965 
	gã©_off£t
 +ğ
eg_i
.
šput_äames
.
NumRows
();

967 
KALDI_ASSERT
(
ã©_off£t
 =ğ
tÙ_äames
);

970 
CombšeDisüimš©iveExam¶es
(

971 
št32
 
max_Ëngth
,

972 cÚ¡ 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> &
šput
,

973 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
ouut
) {

975 
¡d
::
veùÜ
<
Ba£Flßt
> 
co¡s
(
šput
.
size
());

976 
size_t
 
	gi
 = 0; i < 
	gšput
.
size
(); i++)

977 
	gco¡s
[
i
] = 
¡©ic_ÿ¡
<
Ba£Flßt
>(
šput
[i].
šput_äames
.
NumRows
());

978 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
size_t
> > 
groups
;

979 
SŞvePackšgProbËm
(
max_Ëngth
,

980 
co¡s
,

981 &
groups
);

982 
	gouut
->
ş—r
();

983 
	gouut
->
»size
(
groups
.
size
());

984 
size_t
 
	gi
 = 0; i < 
	ggroups
.
size
(); i++) {

985 
	g¡d
::
veùÜ
<cÚ¡ 
Disüimš©iveNÃtExam¶e
*> 
group_egs
;

986 
size_t
 
	gj
 = 0; j < 
	ggroups
[
i
].
size
(); j++) {

987 
size_t
 
	gšdex
 = 
groups
[
i
][
j
];

988 
	ggroup_egs
.
push_back
(&(
šput
[
šdex
]));

990 
Aµ’dDisüimš©iveExam¶es
(
group_egs
, &((*
ouut
)[
i
]));

	@nnet-example-functions.h

20 #iâdeà
KALDI_NNET2_NNET_EXAMPLE_FUNCTIONS_H_


21 
	#KALDI_NNET2_NNET_EXAMPLE_FUNCTIONS_H_


	)

29 
	~"Â‘2/Â‘-Â‘.h
"

30 
	~"ut/bË-ty³s.h
"

31 
	~"Ït/k®di-Ï‰iû.h
"

32 
	~"Â‘2/Â‘-exam¶e.h
"

33 
	~"hmm/Œªs™iÚ-mod–.h
"

34 
	~"hmm/po¡”iÜ.h
"

36 
Çme¥aû
 
	gk®di
 {

37 
Çme¥aû
 
	gÂ‘2
 {

51 
	sS¶™Disüimš©iveExam¶eCÚfig
 {

58 
št32
 
	gmax_Ëngth
;

66 
	g¡d
::
¡ršg
 
ü™”iÚ
;

68 
boŞ
 
	gcŞÏp£_Œªs™iÚ_ids
;

70 
boŞ
 
	gd‘”mšize
;

72 
boŞ
 
	gmšimize
;

74 
boŞ
 
	g‹¡
;

76 
boŞ
 
	gdrİ_äames
;

83 
boŞ
 
	g¥l™
;

85 
boŞ
 
	gexci£
;

87 
S¶™Disüimš©iveExam¶eCÚfig
():

88 
max_Ëngth
(1024), 
ü™”iÚ
("smbr"), 
cŞÏp£_Œªs™iÚ_ids
(
Œue
),

89 
d‘”mšize
(
Œue
), 
mšimize
Ñrue), 
‹¡
(
çl£
), 
drİ_äames
(false),

90 
¥l™
(
Œue
), 
exci£
(true) { }

92 
Regi¡”
(
O±iÚsItf
 *
İts
) {

94 
	gİts
->
Regi¡”
("max-Ëngth", &
max_Ëngth
, "Maximum†ength‡llowed for‡ny "

98 
	gİts
->
Regi¡”
("ü™”iÚ", &
ü™”iÚ
, "Criterion, 'mmi'|'mpfe'|'smbr'. "

100 
	gİts
->
Regi¡”
("cŞÏp£-Œªs™iÚ-ids", &
cŞÏp£_Œªs™iÚ_ids
,

102 
	gİts
->
Regi¡”
("d‘”mšize", &
d‘”mšize
, "Ifrue, we determinize "

104 
	gİts
->
Regi¡”
("mšimize", &
mšimize
, "Ifrue, we…ush‡nd "

106 
	gİts
->
Regi¡”
("‹¡", &
‹¡
, "Ifrue,‡ctivate self-testing code.");

109 
	gİts
->
Regi¡”
("drİ-äames", &
drİ_äames
, "For MMI, ifrue we drop frames "

111 
	gİts
->
Regi¡”
("¥l™", &
¥l™
, "Seto falseo disable†attice-splitting.");

112 
	gİts
->
Regi¡”
("exci£", &
exci£
, "Seto falseo disableƒxcising un-needed "

121 
	sS¶™Exam¶eSts
 {

122 
št32
 
	gnum_Ï‰iûs
;

123 
št32
 
	glÚge¡_Ï‰iû
;

124 
št32
 
	gnum_£gm’ts
;

125 
št32
 
	gnum_k•t_£gm’ts
;

126 
št64
 
	gnum_äames_Üig
;

127 
št64
 
	gnum_äames_mu¡_k“p
;

128 
št64
 
	gnum_äames_k•t_aá”_¥l™
;

129 
št32
 
	glÚge¡_£gm’t_aá”_¥l™
;

130 
št64
 
	gnum_äames_k•t_aá”_exci£
;

131 
št32
 
	glÚge¡_£gm’t_aá”_exci£
;

133 
S¶™Exam¶eSts
(è{ 
mem£t
(
this
, 0, (*this)); }

134 
Pršt
();

140 
boŞ
 
L©tiûToDisüimš©iveExam¶e
(

141 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
®ignm’t
,

142 cÚ¡ 
M©rix
<
Ba£Flßt
> &
ã©s
,

143 cÚ¡ 
Com·ùL©tiû
 &
ş©
,

144 
Ba£Flßt
 
weight
,

145 
št32
 
Ëá_cÚ‹xt
,

146 
št32
 
right_cÚ‹xt
,

147 
Disüimš©iveNÃtExam¶e
 *
eg
);

153 
S¶™Disüimš©iveExam¶e
(

154 cÚ¡ 
S¶™Disüimš©iveExam¶eCÚfig
 &
cÚfig
,

155 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

156 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

157 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
egs_out
,

158 
S¶™Exam¶eSts
 *
¡©s_out
);

163 
Exci£Disüimš©iveExam¶e
(

164 cÚ¡ 
S¶™Disüimš©iveExam¶eCÚfig
 &
cÚfig
,

165 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

166 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

167 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
egs_out
,

168 
S¶™Exam¶eSts
 *
¡©s_out
);

185 
Aµ’dDisüimš©iveExam¶es
(

186 cÚ¡ 
¡d
::
veùÜ
<cÚ¡ 
Disüimš©iveNÃtExam¶e
*> &
šput
,

187 
Disüimš©iveNÃtExam¶e
 *
ouut
);

209 
CombšeDisüimš©iveExam¶es
(

210 
št32
 
max_Ëngth
,

211 cÚ¡ 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> &
šput
,

212 
¡d
::
veùÜ
<
Disüimš©iveNÃtExam¶e
> *
ouut
);

221 
SŞvePackšgProbËm
(
Ba£Flßt
 
max_co¡
,

222 cÚ¡ 
¡d
::
veùÜ
<
Ba£Flßt
> &
co¡s
,

223 
¡d
::
veùÜ
<¡d::veùÜ<
size_t
> > *
groups
);

245 
Exam¶eToPdfPo¡
(

246 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

247 cÚ¡ 
¡d
::
veùÜ
<
št32
> &
s’û_phÚes
,

248 
¡d
::
¡ršg
 
ü™”iÚ
,

249 
boŞ
 
drİ_äames
,

250 
boŞ
 
Úe_s’û_şass
,

251 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

252 
Po¡”iÜ
 *
po¡
);

284 
Upd©eHash
(

285 cÚ¡ 
T¿ns™iÚMod–
 &
tmod–
,

286 cÚ¡ 
Disüimš©iveNÃtExam¶e
 &
eg
,

287 
¡d
::
¡ršg
 
ü™”iÚ
,

288 
boŞ
 
drİ_äames
,

289 
boŞ
 
Úe_s’û_şass
,

290 
M©rix
<> *
hash
,

291 *
num_weight
,

292 *
d’_weight
,

293 *
tÙ_t
);

	@nnet-example.cc

21 
	~"Â‘2/Â‘-exam¶e.h
"

22 
	~"Ït/Ï‰iû-funùiÚs.h
"

23 
	~"hmm/po¡”iÜ.h
"

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

32 
boŞ
 
HasSim¶eLab–s
(

33 cÚ¡ 
NÃtExam¶e
 &
eg
,

34 
¡d
::
veùÜ
<
št32
> *
sim¶e_Ïb–s
) {

35 
size_t
 
num_äames
 = 
eg
.
Ïb–s
.
size
();

36 
št32
 
	gt
 = 0; < 
	gnum_äames
;++)

37 ià(
	geg
.
	gÏb–s
[
t
].
size
(è!ğ1 || 
eg
.
Ïb–s
[t][0].
£cÚd
 != 1.0)

38  
çl£
;

39 
	gsim¶e_Ïb–s
->
»size
(
num_äames
);

40 
št32
 
	gt
 = 0; < 
	gnum_äames
;++)

41 (*
	gsim¶e_Ïb–s
)[
t
] = 
eg
.
Ïb–s
[t][0].
fœ¡
;

42  
	gŒue
;

46 
	gNÃtExam¶e
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

49 
Wr™eTok’
(
os
, 
bš¬y
, "<NnetExample>");

54 
	g¡d
::
veùÜ
<
št32
> 
sim¶e_Ïb–s
;

55 ià(
HasSim¶eLab–s
(*
this
, &
sim¶e_Ïb–s
)) {

56 
Wr™eTok’
(
os
, 
bš¬y
, "<Lab1>");

57 
Wr™eIÁeg”VeùÜ
(
os
, 
bš¬y
, 
sim¶e_Ïb–s
);

59 
Wr™eTok’
(
os
, 
bš¬y
, "<Lab2>");

60 
št32
 
	gnum_äames
 = 
Ïb–s
.
size
();

61 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
num_äames
);

62 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

63 
št32
 
	gsize
 = 
Ïb–s
[
t
].
size
();

64 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
size
);

65 
št32
 
	gi
 = 0; i < 
	gsize
; i++) {

66 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ïb–s
[
t
][
i
].
fœ¡
);

67 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ïb–s
[
t
][
i
].
£cÚd
);

71 
Wr™eTok’
(
os
, 
bš¬y
, "<InputFrames>");

72 
	gšput_äames
.
Wr™e
(
os
, 
bš¬y
);

73 
Wr™eTok’
(
os
, 
bš¬y
, "<LeftContext>");

74 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ëá_cÚ‹xt
);

75 
Wr™eTok’
(
os
, 
bš¬y
, "<SpkInfo>");

76 
	g¥k_šfo
.
Wr™e
(
os
, 
bš¬y
);

77 
Wr™eTok’
(
os
, 
bš¬y
, "</NnetExample>");

80 
	gNÃtExam¶e
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

83 
Ex³ùTok’
(
is
, 
bš¬y
, "<NnetExample>");

85 
	g¡d
::
¡ršg
 
tok’
;

86 
R—dTok’
(
is
, 
bš¬y
, &
tok’
);

87 ià(!
¡rcmp
(
tok’
.
c_¡r
(), "<Lab1>")) {

88 
	g¡d
::
veùÜ
<
št32
> 
sim¶e_Ïb–s
;

89 
R—dIÁeg”VeùÜ
(
is
, 
bš¬y
, &
sim¶e_Ïb–s
);

90 
	gÏb–s
.
»size
(
sim¶e_Ïb–s
.
size
());

91 
size_t
 
	gi
 = 0; i < 
	gsim¶e_Ïb–s
.
size
(); i++) {

92 
	gÏb–s
[
i
].
»size
(1);

93 
	gÏb–s
[
i
][0].
	gfœ¡
 = 
sim¶e_Ïb–s
[i];

94 
	gÏb–s
[
i
][0].
	g£cÚd
 = 1.0;

96 } ià(!
¡rcmp
(
tok’
.
c_¡r
(), "<Lab2>")) {

97 
št32
 
	gnum_äames
;

98 
R—dBasicTy³
(
is
, 
bš¬y
, &
num_äames
);

99 
KALDI_ASSERT
(
num_äames
 > 0);

100 
	gÏb–s
.
»size
(
num_äames
);

101 
št32
 
	gt
 = 0; < 
	gnum_äames
;++) {

102 
št32
 
	gsize
;

103 
R—dBasicTy³
(
is
, 
bš¬y
, &
size
);

104 
KALDI_ASSERT
(
size
 >= 0);

105 
	gÏb–s
[
t
].
»size
(
size
);

106 
št32
 
	gi
 = 0; i < 
	gsize
; i++) {

107 
R—dBasicTy³
(
is
, 
bš¬y
, &(
Ïb–s
[
t
][
i
].
fœ¡
));

108 
R—dBasicTy³
(
is
, 
bš¬y
, &(
Ïb–s
[
t
][
i
].
£cÚd
));

111 } ià(!
¡rcmp
(
tok’
.
c_¡r
(), "<Labels>")) {

112 
	gÏb–s
.
»size
(1);

113 
št32
 
	gsize
;

114 
R—dBasicTy³
(
is
, 
bš¬y
, &
size
);

115 
	gÏb–s
[0].
»size
(
size
);

116 
št32
 
	gi
 = 0; i < 
	gsize
; i++) {

117 
R—dBasicTy³
(
is
, 
bš¬y
, &(
Ïb–s
[0][
i
].
fœ¡
));

118 
R—dBasicTy³
(
is
, 
bš¬y
, &(
Ïb–s
[0][
i
].
£cÚd
));

121 
	gKALDI_ERR
 << "Ex³ùedok’ <Lab1>, <Lab2> o¸<Lab–s>, gÙ " << 
	gtok’
;

123 
Ex³ùTok’
(
is
, 
bš¬y
, "<InputFrames>");

124 
	gšput_äames
.
R—d
(
is
, 
bš¬y
);

125 
Ex³ùTok’
(
is
, 
bš¬y
, "<LeftContext>");

128 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ëá_cÚ‹xt
);

129 
Ex³ùTok’
(
is
, 
bš¬y
, "<SpkInfo>");

130 
	g¥k_šfo
.
R—d
(
is
, 
bš¬y
);

131 
Ex³ùTok’
(
is
, 
bš¬y
, "</NnetExample>");

134 
	gNÃtExam¶e
::
S‘Lab–SšgË
(
št32
 
äame
, iÁ32 
pdf_id
, 
Ba£Flßt
 
weight
) {

135 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
size_t
>(
äame
è< 
Ïb–s
.
size
());

136 
	gÏb–s
[
äame
].
ş—r
();

137 
	gÏb–s
[
äame
].
push_back
(
¡d
::
make_·œ
(
pdf_id
, 
weight
));

140 
št32
 
	gNÃtExam¶e
::
G‘Lab–SšgË
(št32 
äame
, 
Ba£Flßt
 *
weight
) {

141 
Ba£Flßt
 
	gmax
 = -1.0;

142 
št32
 
	gpdf_id
 = -1;

143 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
size_t
>(
äame
è< 
Ïb–s
.
size
());

144 
št32
 
	gi
 = 0; i < 
	gÏb–s
[
äame
].
size
(); i++) {

145 ià(
	gÏb–s
[
äame
][
i
].
	g£cÚd
 > 
	gmax
) {

146 
	gpdf_id
 = 
Ïb–s
[
äame
][
i
].
fœ¡
;

147 
	gmax
 = 
Ïb–s
[
äame
][
i
].
£cÚd
;

150 ià(
	gweight
 !ğ
NULL
è*
weight
 = 
max
;

151  
	gpdf_id
;

156 
boŞ
 
	gÂ‘_exam¶e_w¬Ãd_Ëá
 = 
çl£
, 
	gÂ‘_exam¶e_w¬Ãd_right
 = false;

159 
	gNÃtExam¶e
::
NÃtExam¶e
(cÚ¡ NÃtExam¶&
šput
,

160 
št32
 
¡¬t_äame
,

161 
št32
 
Ãw_num_äames
,

162 
št32
 
Ãw_Ëá_cÚ‹xt
,

163 
št32
 
Ãw_right_cÚ‹xt
): 
¥k_šfo
(
šput
.spk_info) {

164 
št32
 
num_Ïb–_äames
 = 
šput
.
Ïb–s
.
size
();

165 ià(
	g¡¬t_äame
 < 0) start_frame = 0;

167 
KALDI_ASSERT
(
¡¬t_äame
 < 
num_Ïb–_äames
);

168 ià(
	g¡¬t_äame
 + 
	gÃw_num_äames
 > 
	gnum_Ïb–_äames
 ||‚ew_num_frames == -1)

169 
Ãw_num_äames
 = 
num_Ïb–_äames
 - 
¡¬t_äame
;

171 
št32
 
	gšput_right_cÚ‹xt
 =

172 
šput
.
šput_äames
.
NumRows
(è- iÅut.
Ëá_cÚ‹xt
 - 
num_Ïb–_äames
;

173 ià(
	gÃw_Ëá_cÚ‹xt
 =ğ-1è
Ãw_Ëá_cÚ‹xt
 = 
šput
.
Ëá_cÚ‹xt
;

174 ià(
	gÃw_right_cÚ‹xt
 =ğ-1è
Ãw_right_cÚ‹xt
 = 
šput_right_cÚ‹xt
;

175 ià(
	gÃw_Ëá_cÚ‹xt
 > 
	gšput
.
	gËá_cÚ‹xt
) {

176 ià(!
	gÂ‘_exam¶e_w¬Ãd_Ëá
) {

177 
	gÂ‘_exam¶e_w¬Ãd_Ëá
 = 
Œue
;

178 
	gKALDI_WARN
 << "Reque¡ed†eá-cÚ‹xˆ" << 
	gÃw_Ëá_cÚ‹xt


179 << "ƒxûed špuˆËá-cÚ‹xˆ" << 
	gšput
.
	gËá_cÚ‹xt


182 
	gÃw_Ëá_cÚ‹xt
 = 
šput
.
Ëá_cÚ‹xt
;

184 ià(
	gÃw_right_cÚ‹xt
 > 
	gšput_right_cÚ‹xt
) {

185 ià(!
	gÂ‘_exam¶e_w¬Ãd_right
) {

186 
	gÂ‘_exam¶e_w¬Ãd_right
 = 
Œue
;

187 
	gKALDI_WARN
 << "Reque¡ed„ight-cÚ‹xˆ" << 
	gÃw_right_cÚ‹xt


188 << "ƒxûed špuˆright-cÚ‹xˆ" << 
	gšput_right_cÚ‹xt


191 
	gÃw_right_cÚ‹xt
 = 
šput_right_cÚ‹xt
;

194 
št32
 
	gÃw_tÙ_äames
 = 
Ãw_Ëá_cÚ‹xt
 + 
Ãw_num_äames
 + 
Ãw_right_cÚ‹xt
,

195 
	gËá_äames_lo¡
 = (
šput
.
Ëá_cÚ‹xt
 - 
Ãw_Ëá_cÚ‹xt
è+ 
¡¬t_äame
;

197 
Com´es£dM©rix
 
Ãw_šput_äames
(
šput
.
šput_äames
,

198 
Ëá_äames_lo¡
,

199 
Ãw_tÙ_äames
,

200 0, 
šput
.
šput_äames
.
NumCŞs
());

201 
	gÃw_šput_äames
.
Sw­
(&
šput_äames
);

202 
	gËá_cÚ‹xt
 = 
Ãw_Ëá_cÚ‹xt
;

203 
	gÏb–s
.
ş—r
();

204 
	gÏb–s
.
š£¹
(
Ïb–s
.
’d
(),

205 
šput
.
Ïb–s
.
begš
(è+ 
¡¬t_äame
,

206 
šput
.
Ïb–s
.
begš
(è+ 
¡¬t_äame
 + 
Ãw_num_äames
);

209 
	gExam¶esR•os™Üy
::
Acû±Exam¶es
(

210 
¡d
::
veùÜ
<
NÃtExam¶e
> *
exam¶es
) {

211 
KALDI_ASSERT
(!
exam¶es
->
em±y
());

212 
	gem±y_£m­hÜe_
.
Wa™
();

213 
KALDI_ASSERT
(
exam¶es_
.
em±y
());

214 
	gexam¶es_
.
sw­
(*
exam¶es
);

215 
	gfuÎ_£m­hÜe_
.
SigÇl
();

218 
	gExam¶esR•os™Üy
::
Exam¶esDÚe
() {

219 
em±y_£m­hÜe_
.
Wa™
();

220 
KALDI_ASSERT
(
exam¶es_
.
em±y
());

221 
	gdÚe_
 = 
Œue
;

222 
	gfuÎ_£m­hÜe_
.
SigÇl
();

225 
boŞ
 
	gExam¶esR•os™Üy
::
ProvideExam¶es
(

226 
¡d
::
veùÜ
<
NÃtExam¶e
> *
exam¶es
) {

227 
fuÎ_£m­hÜe_
.
Wa™
();

228 ià(
	gdÚe_
) {

229 
KALDI_ASSERT
(
exam¶es_
.
em±y
());

230 
	gfuÎ_£m­hÜe_
.
SigÇl
();

232  
	gçl£
;

234 
KALDI_ASSERT
(!
exam¶es_
.
em±y
(è&& 
exam¶es
->empty());

235 
	gexam¶es
->
sw­
(
exam¶es_
);

236 
	gem±y_£m­hÜe_
.
SigÇl
();

237  
	gŒue
;

242 
	gDisüimš©iveNÃtExam¶e
::
Wr™e
(
¡d
::
o¡»am
 &
os
,

243 
boŞ
 
bš¬y
) const {

246 
Wr™eTok’
(
os
, 
bš¬y
, "<DiscriminativeNnetExample>");

247 
Wr™eTok’
(
os
, 
bš¬y
, "<Weight>");

248 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
weight
);

249 
Wr™eTok’
(
os
, 
bš¬y
, "<NumAli>");

250 
Wr™eIÁeg”VeùÜ
(
os
, 
bš¬y
, 
num_®i
);

251 ià(!
Wr™eCom·ùL©tiû
(
os
, 
bš¬y
, 
d’_Ït
)) {

254 
	gKALDI_ERR
 << "Error writing CompactLatticeo stream";

256 
Wr™eTok’
(
os
, 
bš¬y
, "<InputFrames>");

258 
Com´es£dM©rix
 
cm
(
šput_äames
);

260 
	gcm
.
Wr™e
(
os
, 
bš¬y
);

262 
Wr™eTok’
(
os
, 
bš¬y
, "<LeftContext>");

263 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
Ëá_cÚ‹xt
);

264 
Wr™eTok’
(
os
, 
bš¬y
, "<SpkInfo>");

265 
	g¥k_šfo
.
Wr™e
(
os
, 
bš¬y
);

266 
Wr™eTok’
(
os
, 
bš¬y
, "</DiscriminativeNnetExample>");

269 
	gDisüimš©iveNÃtExam¶e
::
R—d
(
¡d
::
i¡»am
 &
is
,

270 
boŞ
 
bš¬y
) {

273 
Ex³ùTok’
(
is
, 
bš¬y
, "<DiscriminativeNnetExample>");

274 
Ex³ùTok’
(
is
, 
bš¬y
, "<Weight>");

275 
R—dBasicTy³
(
is
, 
bš¬y
, &
weight
);

276 
Ex³ùTok’
(
is
, 
bš¬y
, "<NumAli>");

277 
R—dIÁeg”VeùÜ
(
is
, 
bš¬y
, &
num_®i
);

278 
Com·ùL©tiû
 *
	gd’_Ït_tmp
 = 
NULL
;

279 ià(!
R—dCom·ùL©tiû
(
is
, 
bš¬y
, &
d’_Ït_tmp
è|| 
	gd’_Ït_tmp
 =ğ
NULL
) {

282 
KALDI_ERR
 << "Error„eading CompactLattice from stream";

284 
	gd’_Ït
 = *
d’_Ït_tmp
;

285 
d–‘e
 
	gd’_Ït_tmp
;

286 
Ex³ùTok’
(
is
, 
bš¬y
, "<InputFrames>");

287 
	gšput_äames
.
R—d
(
is
, 
bš¬y
);

288 
Ex³ùTok’
(
is
, 
bš¬y
, "<LeftContext>");

289 
R—dBasicTy³
(
is
, 
bš¬y
, &
Ëá_cÚ‹xt
);

290 
Ex³ùTok’
(
is
, 
bš¬y
, "<SpkInfo>");

291 
	g¥k_šfo
.
R—d
(
is
, 
bš¬y
);

292 
Ex³ùTok’
(
is
, 
bš¬y
, "</DiscriminativeNnetExample>");

295 
	gDisüimš©iveNÃtExam¶e
::
Check
() const {

296 
KALDI_ASSERT
(
weight
 > 0.0);

297 
KALDI_ASSERT
(!
num_®i
.
em±y
());

298 
št32
 
	gnum_äames
 = 
¡©ic_ÿ¡
<št32>(
num_®i
.
size
());

301 
	g¡d
::
veùÜ
<
št32
> 
times
;

302 
št32
 
	gnum_äames_d’
 = 
Com·ùL©tiûS‹Times
(
d’_Ït
, &
times
);

303 
KALDI_ASSERT
(
num_äames
 =ğ
num_äames_d’
);

304 
KALDI_ASSERT
(
šput_äames
.
NumRows
(è>ğ
Ëá_cÚ‹xt
 + 
num_äames
);

	@nnet-example.h

21 #iâdeà
KALDI_NNET2_NNET_EXAMPLE_H_


22 
	#KALDI_NNET2_NNET_EXAMPLE_H_


	)

24 
	~"Â‘2/Â‘-Â‘.h
"

25 
	~"ut/bË-ty³s.h
"

26 
	~"Ït/k®di-Ï‰iû.h
"

27 
	~"ut/k®di-£m­hÜe.h
"

29 
Çme¥aû
 
	gk®di
 {

30 
Çme¥aû
 
	gÂ‘2
 {

36 
	sNÃtExam¶e
 {

43 
	g¡d
::
veùÜ
<
¡d
::veùÜ<¡d::
·œ
<
št32
, 
	gBa£Flßt
> > > 
	gÏb–s
;

49 
Com´es£dM©rix
 
	gšput_äames
;

53 
št32
 
	gËá_cÚ‹xt
;

58 
	gVeùÜ
<
	gBa£Flßt
> 
	g¥k_šfo
;

60 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

61 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

63 
NÃtExam¶e
() { }

76 
NÃtExam¶e
(cÚ¡ NÃtExam¶&
šput
,

77 
št32
 
¡¬t_äame
,

78 
št32
 
num_äames
,

79 
št32
 
Ëá_cÚ‹xt
,

80 
št32
 
right_cÚ‹xt
);

84 
S‘Lab–SšgË
(
št32
 
äame
, iÁ32 
pdf_id
, 
Ba£Flßt
 
weight
 = 1.0);

88 
št32
 
G‘Lab–SšgË
(št32 
äame
, 
Ba£Flßt
 *
weight
 = 
NULL
);

92 
	gTabËWr™”
<
	tK®diObjeùHŞd”
<
	tNÃtExam¶e
 > > 
	tNÃtExam¶eWr™”
;

93 
	gSequ’tŸlTabËR—d”
<
	tK®diObjeùHŞd”
<
	tNÃtExam¶e
 > > 
	tSequ’tŸlNÃtExam¶eR—d”
;

94 
	gRªdomAcûssTabËR—d”
<
	tK®diObjeùHŞd”
<
	tNÃtExam¶e
 > > 
	tRªdomAcûssNÃtExam¶eR—d”
;

99 şas 
	cExam¶esR•os™Üy
 {

100 
	gpublic
:

103 
Acû±Exam¶es
(
¡d
::
veùÜ
<
NÃtExam¶e
> *
exam¶es
);

107 
Exam¶esDÚe
();

113 
boŞ
 
ProvideExam¶es
(
¡d
::
veùÜ
<
NÃtExam¶e
> *
exam¶es
);

115 
Exam¶esR•os™Üy
(): 
em±y_£m­hÜe_
(1), 
dÚe_
(
çl£
) { }

116 
	g´iv©e
:

117 
Sem­hÜe
 
fuÎ_£m­hÜe_
;

118 
Sem­hÜe
 
	gem±y_£m­hÜe_
;

120 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
exam¶es_
;

121 
boŞ
 
	gdÚe_
;

122 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
Exam¶esR•os™Üy
);

136 
	sDisüimš©iveNÃtExam¶e
 {

140 
Ba£Flßt
 
	gweight
;

143 
	g¡d
::
veùÜ
<
št32
> 
num_®i
;

148 
Com·ùL©tiû
 
	gd’_Ït
;

159 
	gM©rix
<
	gBa£Flßt
> 
	gšput_äames
;

164 
št32
 
	gËá_cÚ‹xt
;

171 
	gVeùÜ
<
	gBa£Flßt
> 
	g¥k_šfo
;

173 
Check
() const;

175 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

176 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

180 
	gTabËWr™”
<
	tK®diObjeùHŞd”
<
	tDisüimš©iveNÃtExam¶e
 > >

181 
	tDisüimš©iveNÃtExam¶eWr™”
;

182 
	gSequ’tŸlTabËR—d”
<
	tK®diObjeùHŞd”
<
	tDisüimš©iveNÃtExam¶e
 > >

183 
	tSequ’tŸlDisüimš©iveNÃtExam¶eR—d”
;

184 
	gRªdomAcûssTabËR—d”
<
	tK®diObjeùHŞd”
<
	tDisüimš©iveNÃtExam¶e
 > >

185 
	tRªdomAcûssDisüimš©iveNÃtExam¶eR—d”
;

	@nnet-fix.cc

20 
	~"Â‘2/Â‘-fix.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

31 
FixNÃt
(cÚ¡ 
NÃtFixCÚfig
 &
cÚfig
, 
NÃt
 *
Â‘
) {

32 
št32
 
	gc
 = 0; c + 1 < 
	gÂ‘
->
NumCompÚ’ts
(); c++) {

33 
AffšeCompÚ’t
 *
	gac
 = 
dyÇmic_ÿ¡
<AffineComponent*>(

34 &(
Â‘
->
G‘CompÚ’t
(
c
)));

35 
NÚlš—rCompÚ’t
 *
	gnc
 = 
dyÇmic_ÿ¡
<NonlinearComponent*>(

36 &(
Â‘
->
G‘CompÚ’t
(
c
 + 1)));

37 ià(
	gac
 =ğ
NULL
 || 
nc
 == NULL) ;

40 
Ba£Flßt
 
	gmax_d”iv
;

41 
boŞ
 
	gis_»lu
 = 
çl£
;

43 
SigmoidCompÚ’t
 *
	gsc
 = 
dyÇmic_ÿ¡
<SigmoidCompÚ’t*>(
nc
);

44 
TªhCompÚ’t
 *
	gtc
 = 
dyÇmic_ÿ¡
<TªhCompÚ’t*>(
nc
);

45 
Reùif›dLš—rCompÚ’t
 *
	grc
 = 
dyÇmic_ÿ¡
<Reùif›dLš—rCompÚ’t*>(
nc
);

46 ià(
	gsc
 !ğ
NULL
è
max_d”iv
 = 0.25;

47 ià(
	gtc
 !ğ
NULL
è
max_d”iv
 = 1.0;

48 ià(
	grc
 !ğ
NULL
è{ 
max_d”iv
 = 1.0; 
	gis_»lu
 = 
Œue
; }

51 
	gcouÁ
 = 
nc
->
CouÁ
();

52 
	gVeùÜ
<> 
d”iv_sum
 (
nc
->
D”ivSum
());

53 ià(
	gcouÁ
 =ğ0.0 || 
d”iv_sum
.
Dim
() == 0) {

54 
KALDI_WARN
 << "Cannot fix‚eural‚et because‚o statistics‡re stored.";

57 
	gVeùÜ
<
	gBa£Flßt
> 
bŸs_·¿ms
(
ac
->
BŸsP¬ams
());

58 
	gM©rix
<
	gBa£Flßt
> 
lš—r_·¿ms
(
ac
->
Lš—rP¬ams
());

59 
št32
 
	gdim
 = 
nc
->
IÅutDim
(), 
	gnum_sm®l_d”iv
 = 0, 
	gnum_Ïrge_d”iv
 = 0;

60 
št32
 
	gd
 = 0; d < 
	gdim
; d++) {

63 
Ba£Flßt
 
	gd”iv_¿tio
 = 
d”iv_sum
(
d
è/ (
couÁ
 * 
max_d”iv
);

64 
KALDI_ASSERT
(
d”iv_¿tio
 >= 0.0 && deriv_ratio < 1.01);

67 ià(
	gd”iv_¿tio
 < 
	gcÚfig
.
	gmš_av”age_d”iv
) {

70 ià(
	gis_»lu
) {

71 
bŸs_·¿ms
(
d
è+ğ
cÚfig
.
»lu_bŸs_chªge
;

73 
Ba£Flßt
 
	g·¿m‘”_çùÜ
 = 
¡d
::
mš
(
cÚfig
.
mš_av”age_d”iv
 /

74 
d”iv_¿tio
,

75 
cÚfig
.
·¿m‘”_çùÜ
);

77 
bŸs_·¿ms
(
d
è*ğ1.0 / 
·¿m‘”_çùÜ
;

78 
	glš—r_·¿ms
.
Row
(
d
).
SÿË
(1.0 / 
·¿m‘”_çùÜ
);

80 
	gnum_sm®l_d”iv
++;

81 } ià(
	gd”iv_¿tio
 > 
	gcÚfig
.
	gmax_av”age_d”iv
) {

84 ià(
	gis_»lu
) {

85 
bŸs_·¿ms
(
d
è-ğ
cÚfig
.
»lu_bŸs_chªge
;

87 
Ba£Flßt
 
	g·¿m‘”_çùÜ
 = 
¡d
::
mš
(
d”iv_¿tio
 / 
cÚfig
.
max_av”age_d”iv
,

88 
cÚfig
.
·¿m‘”_çùÜ
);

90 
bŸs_·¿ms
(
d
è*ğ
·¿m‘”_çùÜ
;

91 
	glš—r_·¿ms
.
Row
(
d
).
SÿË
(
·¿m‘”_çùÜ
);

93 
	gnum_Ïrge_d”iv
++;

96 ià(
	gis_»lu
) {

97 
	gKALDI_LOG
 << "FÜ†ay” " << 
	gc
 << " (ReLU units), increased bias for "

98 << 
	gnum_sm®l_d”iv
 << " indexes‡nd decreased it for "

99 << 
	gnum_Ïrge_d”iv
 << ", ouˆoà¨tÙ® oà" << 
	gdim
;

101 
	gKALDI_LOG
 << "FÜ†ay” " << 
	gc
 << ", decreased…arameters for "

102 << 
	gnum_sm®l_d”iv
 << " indexes,‡nd increasedhem for "

103 << 
	gnum_Ïrge_d”iv
 << " ouˆoà¨tÙ® oà" << 
	gdim
;

105 
	gac
->
S‘P¬ams
(
bŸs_·¿ms
, 
lš—r_·¿ms
);

	@nnet-fix.h

20 #iâdeà
KALDI_NNET2_NNET_FIX_H_


21 
	#KALDI_NNET2_NNET_FIX_H_


	)

23 
	~"Â‘2/Â‘-Â‘.h
"

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

42 
	sNÃtFixCÚfig
 {

43 
Ba£Flßt
 
	gmš_av”age_d”iv
;

46 
Ba£Flßt
 
	gmax_av”age_d”iv
;

48 
Ba£Flßt
 
	g·¿m‘”_çùÜ
;

50 
Ba£Flßt
 
	g»lu_bŸs_chªge
;

52 
NÃtFixCÚfig
(): 
mš_av”age_d”iv
(0.1), 
max_av”age_d”iv
(0.75),

53 
·¿m‘”_çùÜ
(2.0), 
»lu_bŸs_chªge
(1.0) { }

54 
Regi¡”
(
O±iÚsItf
 *
İts
) {

55 
	gİts
->
Regi¡”
("mš-av”age-d”iv", &
mš_av”age_d”iv
, "Miniumum derivative, "

59 
	gİts
->
Regi¡”
("max-av”age-d”iv", &
max_av”age_d”iv
, "Maximum derivative, "

62 
	gİts
->
Regi¡”
("·¿m‘”-çùÜ", &
·¿m‘”_çùÜ
, "Maximum factor by which we change "

64 
	gİts
->
Regi¡”
("»lu-bŸs-chªge", &
»lu_bŸs_chªge
, "For ReLUs, change in bias when "

69 
FixNÃt
(cÚ¡ 
NÃtFixCÚfig
 &
cÚfig
, 
NÃt
 *
Â‘
);

	@nnet-functions.cc

21 
	~"Â‘2/Â‘-Â‘.h
"

22 
	~"ut/¡l-uts.h
"

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

27 
št32
 
IndexOfSoámaxLay”
(cÚ¡ 
NÃt
 &
Â‘
) {

28 
št32
 
	gšdex
 = -1, 
	gnc
 = 
Â‘
.
NumCompÚ’ts
();

29 
št32
 
	gc
 = 0; c < 
	gnc
; c++) {

30 cÚ¡ 
CompÚ’t
 *
	gcompÚ’t
 = &(
Â‘
.
G‘CompÚ’t
(
c
));

31 ià(
	gdyÇmic_ÿ¡
<cÚ¡ 
	gSoámaxCompÚ’t
*>(
	gcompÚ’t
è!ğ
NULL
) {

32 ià(
šdex
 != -1)  -1;

33 
	gšdex
 = 
c
;

36  
	gšdex
;

39 
In£¹CompÚ’ts
(cÚ¡ 
NÃt
 &
¤c_Â‘
,

40 
št32
 
c_to_š£¹
,

41 
NÃt
 *
de¡_Â‘
) {

42 
KALDI_ASSERT
(
c_to_š£¹
 >ğ0 && c_to_š£¹ <ğ
de¡_Â‘
->
NumCompÚ’ts
());

43 
št32
 
	gc_tÙ
 = 
de¡_Â‘
->
NumCompÚ’ts
(è+ 
¤c_Â‘
.NumComponents();

44 
	g¡d
::
veùÜ
<
CompÚ’t
*> 
compÚ’ts
(
c_tÙ
);

45 
št32
 
	gc
 = 0; c < 
	gc_to_š£¹
; c++)

46 
	gcompÚ’ts
[
c
] = 
de¡_Â‘
->
G‘CompÚ’t
(c).
Cİy
();

47 
št32
 
	gc
 = 0; c < 
	g¤c_Â‘
.
NumCompÚ’ts
(); c++)

48 
	gcompÚ’ts
[
c
 + 
c_to_š£¹
] = 
¤c_Â‘
.
G‘CompÚ’t
(c).
Cİy
();

49 
št32
 
	gc
 = 
c_to_š£¹
; c < 
	gde¡_Â‘
->
NumCompÚ’ts
(); c++)

50 
	gcompÚ’ts
[
c
 + 
¤c_Â‘
.
NumCompÚ’ts
()] = 
de¡_Â‘
->
G‘CompÚ’t
(c).
Cİy
();

54 
	gde¡_Â‘
->
In™
(&
compÚ’ts
);

58 
R•ÏûLa¡CompÚ’ts
(cÚ¡ 
NÃt
 &
¤c_Â‘
,

59 
št32
 
num_to_»move
,

60 
NÃt
 *
de¡_Â‘
) {

61 
KALDI_ASSERT
(
num_to_»move
 >ğ0 &&‚um_to_»mov<ğ
de¡_Â‘
->
NumCompÚ’ts
());

62 
št32
 
	gc_Üig
 = 
de¡_Â‘
->
NumCompÚ’ts
(è- 
num_to_»move
;

64 
	g¡d
::
veùÜ
<
CompÚ’t
*> 
compÚ’ts
;

65 
št32
 
	gc
 = 0; c < 
	gc_Üig
; c++)

66 
	gcompÚ’ts
.
push_back
(
de¡_Â‘
->
G‘CompÚ’t
(
c
).
Cİy
());

67 
št32
 
	gc
 = 0; c < 
	g¤c_Â‘
.
NumCompÚ’ts
(); c++)

68 
	gcompÚ’ts
.
push_back
(
¤c_Â‘
.
G‘CompÚ’t
(
c
).
Cİy
());

72 
	gde¡_Â‘
->
In™
(&
compÚ’ts
);

	@nnet-functions.h

20 #iâdeà
KALDI_NNET2_NNET_FUNCTIONS_H_


21 
	#KALDI_NNET2_NNET_FUNCTIONS_H_


	)

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"ut/k®di-io.h
"

25 
	~"m©rix/m©rix-lib.h
"

26 
	~"Â‘2/Â‘-compÚ’t.h
"

27 
	~"Â‘2/Â‘-Â‘.h
"

29 
	~<io¡»am
>

30 
	~<s¡»am
>

31 
	~<veùÜ
>

34 
Çme¥aû
 
	gk®di
 {

35 
Çme¥aû
 
	gÂ‘2
 {

44 
št32
 
IndexOfSoámaxLay”
(cÚ¡ 
NÃt
 &
Â‘
);

51 
In£¹CompÚ’ts
(cÚ¡ 
NÃt
 &
¤c_Â‘
,

52 
št32
 
c
,

53 
NÃt
 *
de¡_Â‘
);

59 
R•ÏûLa¡CompÚ’ts
(cÚ¡ 
NÃt
 &
¤c_Â‘
,

60 
št32
 
num_to_»move
,

61 
NÃt
 *
de¡_Â‘
);

	@nnet-limit-rank.cc

20 
	~"Â‘2/Â‘-lim™-¿nk.h
"

21 
	~"ut/k®di-th»ad.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

26 şas 
	cLim™RªkCÏss
 {

27 
	gpublic
:

28 
Lim™RªkCÏss
(cÚ¡ 
NÃtLim™RªkO±s
 &
İts
,

29 
št32
 
c
,

30 
NÃt
 *
Â‘
): 
İts_
(
İts
), 
c_
(
c
), 
Â‘_
(nnet) { }

31 
İ”©Ü
 () () {

32 
AffšeCompÚ’t
 *
	gac
 = 
dyÇmic_ÿ¡
<AffineComponent*>(

33 &(
Â‘_
->
G‘CompÚ’t
(
c_
)));

34 
KALDI_ASSERT
(
ac
 !ğ
NULL
);

37 
	gM©rix
<
	gBa£Flßt
> 
M
 (
ac
->
Lš—rP¬ams
());

38 
št32
 
	grows
 = 
M
.
NumRows
(), 
	gcŞs
 = M.
NumCŞs
(), 
	grc_mš
 = 
¡d
::
mš
(
rows
, 
cŞs
);

39 
	gVeùÜ
<
	gBa£Flßt
> 
s
(
rc_mš
);

40 
	gM©rix
<
	gBa£Flßt
> 
U
(
rows
, 
rc_mš
), 
Vt
Ôc_mš, 
cŞs
);

42 
	gM
.
De¡ruùiveSvd
(&
s
, &
U
, &
Vt
);

43 
SÜtSvd
(&
s
, &
U
, &
Vt
);

45 
št32
 
	gd
 = 
G‘R‘ašedDim
(
rows
, 
cŞs
);

46 
Ba£Flßt
 
	gŞd_svd_sum
 = 
s
.
Sum
();

47 
	gU
.
Resize
(
rows
, 
d
, 
kCİyD©a
);

48 
	gs
.
Resize
(
d
, 
kCİyD©a
);

49 
	gVt
.
Resize
(
d
, 
cŞs
, 
kCİyD©a
);

50 
Ba£Flßt
 
	gÃw_svd_sum
 = 
s
.
Sum
();

51 
	gKALDI_LOG
 << "FÜ compÚ’ˆ" << 
	gc_
 << " oàdim’siÚ " << 
	grows


52 << " x " << 
	gcŞs
 << ",„educed„ank from "

53 << 
	grc_mš
 << "Ø" << 
	gd
 << ", SVD sum„educed from "

54 << 
	gŞd_svd_sum
 << "Ø" << 
	gÃw_svd_sum
;

55 
	gVt
.
MulRowsVec
(
s
);

56 
	gM
.
AddM©M©
(1.0, 
U
, 
kNoT¿ns
, 
Vt
, kNoTrans, 0.0);

58 
	gVeùÜ
<
	gBa£Flßt
> 
bŸs_·¿ms
(
ac
->
BŸsP¬ams
());

59 
	gac
->
S‘P¬ams
(
bŸs_·¿ms
, 
M
);

62 
št32
 
G‘R‘ašedDim
(št32 
rows
, iÁ32 
cŞs
) {

63 ià(
	gİts_
.
	g·¿m‘”_´İÜtiÚ
 <ğ0.0 || 
İts_
.
·¿m‘”_´İÜtiÚ
 > 1.0)

64 
KALDI_ERR
 << "bad --·¿m‘”-´İÜtiÚ " << 
İts_
.
·¿m‘”_´İÜtiÚ
;

83 
Ba£Flßt
 
	ga
 = 1.0, 
	gb
 = -(
rows
 + 
cŞs
),

84 
	gc
 = 
rows
 * 
cŞs
 * 
İts_
.
·¿m‘”_´İÜtiÚ
;

85 
Ba£Flßt
 
	gx
 = (-
b
 - 
sq¹
(b * b - 4 * 
a
 * 
c
)) / (2.0 *‡);

86 
št32
 
	gªs
 = 
¡©ic_ÿ¡
<št32>(
x
);

87 
KALDI_ASSERT
(
ªs
 > 0 &&‡n <ğ
¡d
::
mš
(
rows
, 
cŞs
));

88  
	gªs
;

91 ~
Lim™RªkCÏss
() { }

92 
	g´iv©e
:

93 cÚ¡ 
NÃtLim™RªkO±s
 &
İts_
;

94 
št32
 
	gc_
;

95 
NÃt
 *
	gÂ‘_
;

99 
Lim™RªkP¬®Ël
(cÚ¡ 
NÃtLim™RªkO±s
 &
İts
,

100 
NÃt
 *
Â‘
) {

101 
TaskSequ’ûrCÚfig
 
	gsk_cÚfig
;

102 
	gsk_cÚfig
.
	gnum_th»ads
 = 
İts
.
num_th»ads
;

103 
	gTaskSequ’ûr
<
	gLim™RªkCÏss
> 
tc
(
sk_cÚfig
);

104 
št32
 
	gc
 = 0; c < 
	gÂ‘
->
NumCompÚ’ts
(); c++) {

105 ià(
	gdyÇmic_ÿ¡
<
	gAffšeCompÚ’t
*>(&(
	gÂ‘
->
G‘CompÚ’t
(
c
))è!ğ
NULL
)

106 
tc
.
Run
(
Ãw
 
Lim™RªkCÏss
(
İts
, 
c
, 
Â‘
));

	@nnet-limit-rank.h

20 #iâdeà
KALDI_NNET2_NNET_LIMIT_RANK_H_


21 
	#KALDI_NNET2_NNET_LIMIT_RANK_H_


	)

23 
	~"Â‘2/Â‘-Â‘.h
"

24 
	~"ut/bË-ty³s.h
"

25 
	~"ut/k®di-£m­hÜe.h
"

26 
	~"ut/k®di-th»ad.h
"

27 
	~"Â‘2/Â‘-upd©e.h
"

29 
Çme¥aû
 
	gk®di
 {

30 
Çme¥aû
 
	gÂ‘2
 {

32 
	sNÃtLim™RªkO±s
 {

33 
št32
 
	gnum_th»ads
;

34 
Ba£Flßt
 
	g·¿m‘”_´İÜtiÚ
;

36 
NÃtLim™RªkO±s
(): 
num_th»ads
(1), 
·¿m‘”_´İÜtiÚ
(0.75) { }

38 
Regi¡”
(
O±iÚsItf
 *
İts
) {

39 
	gİts
->
Regi¡”
("num-th»ads", &
num_th»ads
, "Number ofhreads used for "

42 
	gİts
->
Regi¡”
("·¿m‘”-´İÜtiÚ", &
·¿m‘”_´İÜtiÚ
, "Proportion of "

52 
Lim™RªkP¬®Ël
(cÚ¡ 
NÃtLim™RªkO±s
 &
İts
,

53 
NÃt
 *
Â‘
);

	@nnet-nnet-test.cc

20 
	~"Â‘2/Â‘-Â‘.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

26 
Un™Te¡NÃt
() {

27 
št32
 
	gšput_dim
 = 40, 
	gouut_dim
 = 500;

28 
NÃt
 *
	gÂ‘
 = 
G’RªdomNÃt
(
šput_dim
, 
ouut_dim
);

30 
boŞ
 
	gbš¬y
 = (
¿nd
() % 2 == 0);

31 
	g¡d
::
o¡ršg¡»am
 
os
;

32 
	gÂ‘
->
Wr™e
(
os
, 
bš¬y
);

33 
NÃt
 
	gÂ‘2
;

34 
	g¡d
::
i¡ršg¡»am
 
is
(
os
.
¡r
());

35 
	gÂ‘2
.
R—d
(
is
, 
bš¬y
);

37 
	g¡d
::
o¡ršg¡»am
 
os2
;

38 
	gÂ‘2
.
Wr™e
(
os2
, 
bš¬y
);

40 
KALDI_ASSERT
(
os2
.
¡r
(è=ğ
os
.str());

41 
d–‘e
 
	gÂ‘
;

47 
	~"m©rix/m©rix-funùiÚs.h
"

50 
	$maš
() {

51 
usšg
 
Çme¥aû
 
k®di
;

52 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

54 
	`Un™Te¡NÃt
();

56 
	}
}

	@nnet-nnet.cc

21 
	~<®gÜ™hm
>

22 
	~<£t
>

23 
	~<¡ršg
>

24 
	~"Â‘2/Â‘-Â‘.h
"

25 
	~"ut/¡l-uts.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

31 
št32
 
	gNÃt
::
OuutDim
() const {

32 
KALDI_ASSERT
(!
compÚ’ts_
.
em±y
());

33  
	gcompÚ’ts_
.
back
()->
OuutDim
();

36 
št32
 
	gNÃt
::
IÅutDim
() const {

37 
KALDI_ASSERT
(!
compÚ’ts_
.
em±y
());

38  
	gcompÚ’ts_
.
äÚt
()->
IÅutDim
();

42 
št32
 
	gNÃt
::
LeáCÚ‹xt
() const {

43 
KALDI_ASSERT
(!
compÚ’ts_
.
em±y
());

44 
št32
 
	gªs
 = 0;

45 
size_t
 
	gi
 = 0; i < 
	gcompÚ’ts_
.
size
(); i++) {

46 
	gªs
 +ğ
compÚ’ts_
[
i
]->
CÚ‹xt
().
äÚt
();

48  -1*
	gªs
;

56 
št32
 
	gNÃt
::
RightCÚ‹xt
() const {

57 
KALDI_ASSERT
(!
compÚ’ts_
.
em±y
());

58 
št32
 
	gªs
 = 0;

59 
size_t
 
	gi
 = 0; i < 
	gcompÚ’ts_
.
size
(); i++) {

60 
	gªs
 +ğ
compÚ’ts_
[
i
]->
CÚ‹xt
().
back
();

62  
	gªs
;

65 
	gNÃt
::
Compu‹ChunkInfo
(
št32
 
šput_chunk_size
,

66 
št32
 
num_chunks
,

67 
¡d
::
veùÜ
<
ChunkInfo
> *
chunk_šfo_out
) const {

70 
št32
 
ouut_chunk_size
 = 
šput_chunk_size
 - 
LeáCÚ‹xt
(è- 
RightCÚ‹xt
();

71 
KALDI_ASSERT
(
ouut_chunk_size
 > 0);

72 
	g¡d
::
veùÜ
<
št32
> 
cu¼’t_ouut_šds
;

73 
št32
 
	gi
 = 0; i < 
	gouut_chunk_size
; i++)

74 
	gcu¼’t_ouut_šds
.
push_back
(
i
 + 
LeáCÚ‹xt
());

76 (*
	gchunk_šfo_out
).
»size
(
NumCompÚ’ts
() + 1);

81 (*
	gchunk_šfo_out
)[
NumCompÚ’ts
()] = 
ChunkInfo
(

82 
G‘CompÚ’t
(
NumCompÚ’ts
(è- 1).
OuutDim
(),

83 
num_chunks
, 
cu¼’t_ouut_šds
.
äÚt
(),

84 
cu¼’t_ouut_šds
.
back
());

86 
	g¡d
::
veùÜ
<
št32
> 
cu¼’t_šput_šds
;

87 
št32
 
	gi
 = 
NumCompÚ’ts
() - 1; i >= 0; i--) {

88 
	g¡d
::
veùÜ
<
št32
> 
cu¼’t_cÚ‹xt
 = 
G‘CompÚ’t
(
i
).
CÚ‹xt
();

89 
	g¡d
::
£t
<
št32
> 
cu¼’t_šput_šd_£t
;

90 
size_t
 
	gj
 = 0; j < 
	gcu¼’t_cÚ‹xt
.
size
(); j++)

91 
size_t
 
	gk
 = 0; k < 
	gcu¼’t_ouut_šds
.
size
(); k++)

92 
	gcu¼’t_šput_šd_£t
.
š£¹
(
cu¼’t_cÚ‹xt
[
j
] +

93 
cu¼’t_ouut_šds
[
k
]);

94 
	gcu¼’t_ouut_šds
.
»size
(
cu¼’t_šput_šd_£t
.
size
());

95 
	g¡d
::
cİy
(
cu¼’t_šput_šd_£t
.
begš
(),

96 
cu¼’t_šput_šd_£t
.
’d
(),

97 
cu¼’t_ouut_šds
.
begš
());

101 ià(
	gcu¼’t_ouut_šds
.
size
() !=

102 
cu¼’t_ouut_šds
.
back
(è- cu¼’t_ouut_šds.
äÚt
() + 1) {

103 (*
chunk_šfo_out
)[
i
] = 
ChunkInfo
(
G‘CompÚ’t
(i).
IÅutDim
(),

104 
num_chunks
,

105 
cu¼’t_ouut_šds
);

107 (*
	gchunk_šfo_out
)[
i
] = 
ChunkInfo
(
G‘CompÚ’t
(i).
IÅutDim
(),

108 
num_chunks
,

109 
cu¼’t_ouut_šds
.
äÚt
(),

110 
cu¼’t_ouut_šds
.
back
());

117 cÚ¡ *
	gdš™
[] = {"SpliceComponent", "SpliceMaxComponent"};

118 
	g¡d
::
veùÜ
< 
¡d
::
¡ršg
 > 
d©a_»¬¿nge_compÚ’ts
(
dš™
, dinit + 2);

123 
size_t
 
	gi
 = 0 ; i < 
NumCompÚ’ts
() ; i++) {

124 (*
	gchunk_šfo_out
)[
i
].
MakeOff£tsCÚtiguous
();

127 ià(
	g¡d
::
fšd
(
d©a_»¬¿nge_compÚ’ts
.
begš
(),

128 
d©a_»¬¿nge_compÚ’ts
.
’d
(),

129 
compÚ’ts_
[
i
]->
Ty³
())

130 !ğ
d©a_»¬¿nge_compÚ’ts
.
’d
())

135 
size_t
 
	gi
 = 0; i < 
	gchunk_šfo_out
->
size
(); i++) {

136 (*
	gchunk_šfo_out
)[
i
].
Check
();

141 cÚ¡ 
	gCompÚ’t
& 
	gNÃt
::
G‘CompÚ’t
(
št32
 
compÚ’t
) const {

142 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
size_t
>(
compÚ’t
è< 
compÚ’ts_
.
size
());

143  *(
	gcompÚ’ts_
[
compÚ’t
]);

146 
	gCompÚ’t
& 
	gNÃt
::
G‘CompÚ’t
(
št32
 
compÚ’t
) {

147 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
size_t
>(
compÚ’t
è< 
compÚ’ts_
.
size
());

148  *(
	gcompÚ’ts_
[
compÚ’t
]);

151 
	gNÃt
::
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
) {

152 
size_t
 
i
 = 0; 
	gi
 < 
	gcompÚ’ts_
.
size
(); i++) {

153 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<Upd©abËCompÚ’t*>(
compÚ’ts_
[
i
]);

154 ià(
	guc
 !ğ
NULL
è
uc
->
S‘Z”o
(
Œ—t_as_g¿d›Á
);

155 
NÚlš—rCompÚ’t
 *
	gnc
 = 
dyÇmic_ÿ¡
<NÚlš—rCompÚ’t*>(
compÚ’ts_
[
i
]);

156 ià(
	gnc
 !ğ
NULL
è
nc
->
SÿË
(0.0);

160 
	gNÃt
::
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const {

161 
Check
();

162 
Wr™eTok’
(
os
, 
bš¬y
, "<Nnet>");

163 
št32
 
	gnum_compÚ’ts
 = 
compÚ’ts_
.
size
();

164 
Wr™eTok’
(
os
, 
bš¬y
, "<NumComponents>");

165 
Wr™eBasicTy³
(
os
, 
bš¬y
, 
num_compÚ’ts
);

166 
Wr™eTok’
(
os
, 
bš¬y
, "<Components>");

167 
št32
 
	gc
 = 0; c < 
	gnum_compÚ’ts
; c++) {

168 
	gcompÚ’ts_
[
c
]->
Wr™e
(
os
, 
bš¬y
);

169 ià(!
	gbš¬y
è
	gos
 << 
	g¡d
::
’dl
;

171 
Wr™eTok’
(
os
, 
bš¬y
, "</Components>");

172 
Wr™eTok’
(
os
, 
bš¬y
, "</Nnet>");

175 
	gNÃt
::
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
) {

176 
De¡roy
();

177 
Ex³ùTok’
(
is
, 
bš¬y
, "<Nnet>");

178 
št32
 
	gnum_compÚ’ts
;

179 
Ex³ùTok’
(
is
, 
bš¬y
, "<NumComponents>");

180 
R—dBasicTy³
(
is
, 
bš¬y
, &
num_compÚ’ts
);

181 
Ex³ùTok’
(
is
, 
bš¬y
, "<Components>");

182 
	gcompÚ’ts_
.
»size
(
num_compÚ’ts
);

183 
št32
 
	gc
 = 0; c < 
	gnum_compÚ’ts
; c++)

184 
	gcompÚ’ts_
[
c
] = 
CompÚ’t
::
R—dNew
(
is
, 
bš¬y
);

185 
Ex³ùTok’
(
is
, 
bš¬y
, "</Components>");

186 
Ex³ùTok’
(
is
, 
bš¬y
, "</Nnet>");

187 
S‘Indexes
();

188 
Check
();

192 
	gNÃt
::
Z”oSts
() {

193 
size_t
 
i
 = 0; 
	gi
 < 
	gcompÚ’ts_
.
size
(); i++) {

194 
NÚlš—rCompÚ’t
 *
	gnÚlš—r_compÚ’t
 =

195 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(
compÚ’ts_
[
i
]);

196 ià(
	gnÚlš—r_compÚ’t
 !ğ
NULL
)

197 
nÚlš—r_compÚ’t
->
SÿË
(0.0);

200 
	gNÃt
::
De¡roy
() {

201 !
compÚ’ts_
.
em±y
()) {

202 
d–‘e
 
compÚ’ts_
.
back
();

203 
	gcompÚ’ts_
.
pİ_back
();

207 
	gNÃt
::
CompÚ’tDÙProduùs
(

208 cÚ¡ 
NÃt
 &
Ùh”
,

209 
VeùÜBa£
<
Ba£Flßt
> *
dÙ_´od
) const {

210 
KALDI_ASSERT
(
dÙ_´od
->
Dim
(è=ğ
NumUpd©abËCompÚ’ts
());

211 
št32
 
	gšdex
 = 0;

212 
size_t
 
	gi
 = 0; i < 
	gcompÚ’ts_
.
size
(); i++) {

213 
Upd©abËCompÚ’t
 *
	guc1
 = 
dyÇmic_ÿ¡
<Upd©abËCompÚ’t*>(
compÚ’ts_
[
i
]);

214 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc2
 = 
dyÇmic_ÿ¡
<const UpdatableComponent*>(

215 &(
Ùh”
.
G‘CompÚ’t
(
i
)));

216 
KALDI_ASSERT
((
uc1
 !ğ
NULL
è=ğ(
uc2
 != NULL));

217 ià(
	guc1
 !ğ
NULL
) {

218 (*
dÙ_´od
)(
šdex
èğ
uc1
->
DÙProduù
(*
uc2
);

219 
	gšdex
++;

222 
KALDI_ASSERT
(
šdex
 =ğ
NumUpd©abËCompÚ’ts
());

226 
	gNÃt
::
NÃt
(cÚ¡ NÃˆ&
Ùh”
): 
compÚ’ts_
(Ùh”.compÚ’ts_.
size
()) {

227 
size_t
 
i
 = 0; 
	gi
 < 
	gÙh”
.
	gcompÚ’ts_
.
size
(); i++)

228 
	gcompÚ’ts_
[
i
] = 
Ùh”
.
compÚ’ts_
[i]->
Cİy
();

229 
S‘Indexes
();

230 
Check
();

233 
	gNÃt
::
NÃt
(cÚ¡ NÃˆ&
Ùh”1
, cÚ¡ NÃˆ&
Ùh”2
) {

234 
št32
 
	gdim1
 = 
Ùh”1
.
OuutDim
(), 
	gdim2
 = 
Ùh”2
.
IÅutDim
();

235 ià(
	gdim1
 !ğ
dim2
)

236 
KALDI_ERR
 << "Concatenating‚eural‚ets: dimension mismatch "

237 << 
dim1
 << " vs. " << 
dim2
;

238 
size_t
 
	gi
 = 0; i < 
	gÙh”1
.
	gcompÚ’ts_
.
size
(); i++)

239 
	gcompÚ’ts_
.
push_back
(
Ùh”1
.
compÚ’ts_
[
i
]->
Cİy
());

240 
size_t
 
	gi
 = 0; i < 
	gÙh”2
.
	gcompÚ’ts_
.
size
(); i++)

241 
	gcompÚ’ts_
.
push_back
(
Ùh”2
.
compÚ’ts_
[
i
]->
Cİy
());

242 
S‘Indexes
();

243 
Check
();

247 
	gNÃt
 &NÃt::
İ”©Ü
 = (cÚ¡ 
NÃt
 &
Ùh”
) {

248 
De¡roy
();

249 
	gcompÚ’ts_
.
»size
(
Ùh”
.
compÚ’ts_
.
size
());

250 
size_t
 
	gi
 = 0; i < 
	gÙh”
.
	gcompÚ’ts_
.
size
(); i++)

251 
	gcompÚ’ts_
[
i
] = 
Ùh”
.
compÚ’ts_
[i]->
Cİy
();

252 
S‘Indexes
();

253 
Check
();

254  *
	gthis
;

257 
	g¡d
::
¡ršg
 
NÃt
::
Info
() const {

258 
¡d
::
o¡ršg¡»am
 
o¡r
;

259 
	go¡r
 << "num-compÚ’t " << 
NumCompÚ’ts
(è<< 
	g¡d
::
’dl
;

260 
	go¡r
 << "num-upd©abË-compÚ’t " << 
NumUpd©abËCompÚ’ts
(è<< 
	g¡d
::
’dl
;

261 
	go¡r
 << "Ëá-cÚ‹xˆ" << 
LeáCÚ‹xt
(è<< 
	g¡d
::
’dl
;

262 
	go¡r
 << "right-cÚ‹xˆ" << 
RightCÚ‹xt
(è<< 
	g¡d
::
’dl
;

263 
	go¡r
 << "šput-dim " << 
IÅutDim
(è<< 
	g¡d
::
’dl
;

264 
	go¡r
 << "ouut-dim " << 
OuutDim
(è<< 
	g¡d
::
’dl
;

265 
	go¡r
 << "·¿m‘”-dim " << 
G‘P¬am‘”Dim
(è<< 
	g¡d
::
’dl
;

266 
št32
 
	gi
 = 0; i < 
NumCompÚ’ts
(); i++)

267 
	go¡r
 << "compÚ’ˆ" << 
	gi
 << " : " << 
	gcompÚ’ts_
[
i
]->
Info
(è<< 
	g¡d
::
’dl
;

268  
	go¡r
.
¡r
();

271 
	gNÃt
::
Check
() const {

272 
size_t
 
i
 = 0; 
	gi
 + 1 < 
	gcompÚ’ts_
.
size
(); i++) {

273 
KALDI_ASSERT
(
compÚ’ts_
[
i
] !ğ
NULL
);

274 
št32
 
	gouut_dim
 = 
compÚ’ts_
[
i
]->
OuutDim
(),

275 
	gÃxt_šput_dim
 = 
compÚ’ts_
[
i
+1]->
IÅutDim
();

276 
KALDI_ASSERT
(
ouut_dim
 =ğ
Ãxt_šput_dim
);

277 
KALDI_ASSERT
(
compÚ’ts_
[
i
]->
Index
(è=ğ
¡©ic_ÿ¡
<
št32
>(i));

281 
	gNÃt
::
In™
(
¡d
::
i¡»am
 &
is
) {

282 
De¡roy
();

283 
	g¡d
::
¡ršg
 
lše
;

292 
	gcompÚ’ts_
.
ş—r
();

293 
g‘lše
(
is
, 
lše
)) {

294 
	g¡d
::
i¡ršg¡»am
 
lše_is
(
lše
);

295 
	glše_is
 >> 
	g¡d
::
ws
;

296 ià(
	glše_is
.
³ek
(è=ğ'#' || 
lše_is
.
eof
()) ;

297 
CompÚ’t
 *
	gc
 = CompÚ’t::
NewFromSŒšg
(
lše
);

298 
KALDI_ASSERT
(
c
 !ğ
NULL
);

299 
	gcompÚ’ts_
.
push_back
(
c
);

301 
S‘Indexes
();

302 
Check
();

305 
	gNÃt
::
In™
(
¡d
::
veùÜ
<
CompÚ’t
*> *
compÚ’ts
) {

306 
De¡roy
();

307 
	gcompÚ’ts_
.
sw­
(*
compÚ’ts
);

308 
S‘Indexes
();

309 
Check
();

313 
	gNÃt
::
SÿËL—ºšgR©es
(
Ba£Flßt
 
çùÜ
) {

314 
¡d
::
o¡ršg¡»am
 
o¡r
;

315 
št32
 
	gc
 = 0; c < 
NumCompÚ’ts
(); c++) {

316 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<Upd©abËCompÚ’t*>(
compÚ’ts_
[
c
]);

317 ià(
	guc
 !ğ
NULL
) {

318 
uc
->
S‘L—ºšgR©e
(uc->
L—ºšgR©e
(è* 
çùÜ
);

319 
	go¡r
 << 
	guc
->
L—ºšgR©e
() << " ";

322 
	gKALDI_LOG
 << "SÿËd†—ºšg„©e by " << 
	gçùÜ


324 << 
	go¡r
.
¡r
();

327 
	gNÃt
::
SÿËL—ºšgR©es
(
¡d
::
m­
<¡d::
¡ršg
, 
Ba£Flßt
> 
sÿË_çùÜs
) {

328 
	g¡d
::
o¡ršg¡»am
 
o¡r
;

329 
št32
 
	gc
 = 0; c < 
NumCompÚ’ts
(); c++) {

330 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<Upd©abËCompÚ’t*>(
compÚ’ts_
[
c
]);

331 ià(
	guc
 !ğ
NULL
) {

333 
¡d
::
m­
<¡d::
¡ršg
, 
Ba£Flßt
>::
cÚ¡_™”©Ü
 
Ì_™”©Ü
 =

334 
sÿË_çùÜs
.
fšd
(
uc
->
Ty³
());

335 ià(
	gÌ_™”©Ü
 !ğ
sÿË_çùÜs
.
’d
()) {

336 
uc
->
S‘L—ºšgR©e
(uc->
L—ºšgR©e
(è* 
Ì_™”©Ü
->
£cÚd
);

337 
	go¡r
 << 
	guc
->
L—ºšgR©e
() << " ";

341 
	gKALDI_LOG
 << "Scaled†earning„ates by component-type specific factor, "

343 << 
	go¡r
.
¡r
();

346 
	gNÃt
::
S‘L—ºšgR©es
(
Ba£Flßt
 
Ë¬nšg_¿‹
) {

347 
št32
 
c
 = 0; 
	gc
 < 
NumCompÚ’ts
(); c++) {

348 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<Upd©abËCompÚ’t*>(
compÚ’ts_
[
c
]);

349 ià(
	guc
 !ğ
NULL
) {

350 
uc
->
S‘L—ºšgR©e
(
Ë¬nšg_¿‹
);

353 
	gKALDI_LOG
 << "S‘†—ºšg„©e tØ" << 
	gË¬nšg_¿‹
;

356 
	gNÃt
::
ResizeOuutLay”
(
št32
 
Ãw_num_pdfs
) {

357 
KALDI_ASSERT
(
Ãw_num_pdfs
 > 0);

358 
KALDI_ASSERT
(
NumCompÚ’ts
() > 2);

359 
št32
 
	gnc
 = 
NumCompÚ’ts
();

360 
SumGroupCompÚ’t
 *
	gsgc
 =

361 
dyÇmic_ÿ¡
<
SumGroupCompÚ’t
*>(
compÚ’ts_
[
nc
 - 1]);

362 ià(
	gsgc
 !ğ
NULL
) {

364 
d–‘e
 
sgc
;

365 
	gcompÚ’ts_
.
”a£
(
compÚ’ts_
.
begš
(è+ 
nc
 - 1,

366 
compÚ’ts_
.
begš
(è+ 
nc
);

367 
	gnc
--;

369 
SoámaxCompÚ’t
 *
	gsc
;

370 ià((
	gsc
 = 
dyÇmic_ÿ¡
<
SoámaxCompÚ’t
*>(
compÚ’ts_
[
nc
 - 1])è=ğ
NULL
)

371 
KALDI_ERR
 << "Expected†ast componento be SoftmaxComponent.";

374 
boŞ
 
	ghas_fixed_sÿË_compÚ’t
 = 
çl£
;

375 
št32
 
	gfixed_sÿË_compÚ’t_šdex
 = -1;

376 
št32
 
	gfš®_affše_compÚ’t_šdex
 = 
nc
 - 2;

377 
št32
 
	gsoámax_compÚ’t_šdex
 = 
nc
 - 1;

378 
FixedSÿËCompÚ’t
 *
	gfsc
 =

379 
dyÇmic_ÿ¡
<
FixedSÿËCompÚ’t
*>(

380 
compÚ’ts_
[
fš®_affše_compÚ’t_šdex
]);

381 ià(
	gfsc
 !ğ
NULL
) {

382 
has_fixed_sÿË_compÚ’t
 = 
Œue
;

383 
	gfixed_sÿË_compÚ’t_šdex
 = 
nc
 - 2;

384 
	gfš®_affše_compÚ’t_šdex
 = 
nc
 - 3;

387 
AffšeCompÚ’t
 *
	gac
 = 
dyÇmic_ÿ¡
<AffineComponent*>(

388 
compÚ’ts_
[
fš®_affše_compÚ’t_šdex
]);

389 ià(
	gac
 =ğ
NULL
)

390 
KALDI_ERR
 << "Network doesn't haveƒxpected structure (didn't find final "

392 ià(
	ghas_fixed_sÿË_compÚ’t
) {

394 
AffšeCompÚ’t
 *
	gac_Ãw
 =

395 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
ac
->
CŞÏp£W™hNext
(*
fsc
));

396 
KALDI_ASSERT
(
ac_Ãw
 !ğ
NULL
);

397 
d–‘e
 
	gfsc
;

398 
d–‘e
 
	gac
;

399 
	gcompÚ’ts_
.
”a£
(
compÚ’ts_
.
begš
(è+ 
fixed_sÿË_compÚ’t_šdex
,

400 
compÚ’ts_
.
begš
(è+ (
fixed_sÿË_compÚ’t_šdex
 + 1));

401 
	gcompÚ’ts_
[
fš®_affše_compÚ’t_šdex
] = 
ac_Ãw
;

402 
	gac
 = 
ac_Ãw
;

403 
	gsoámax_compÚ’t_šdex
 = 
soámax_compÚ’t_šdex
 - 1;

405 
	gac
->
Resize
(
ac
->
IÅutDim
(), 
Ãw_num_pdfs
);

407 
d–‘e
 
	gcompÚ’ts_
[
soámax_compÚ’t_šdex
];

408 
	gcompÚ’ts_
[
soámax_compÚ’t_šdex
] = 
Ãw
 
SoámaxCompÚ’t
(
Ãw_num_pdfs
);

409 
	gthis
->
S‘Indexes
();

410 
	gthis
->
Check
();

413 
št32
 
	gNÃt
::
NumUpd©abËCompÚ’ts
() const {

414 
št32
 
ªs
 = 0;

415 
št32
 
	gi
 = 0; i < 
NumCompÚ’ts
(); i++)

416 ià(
	gdyÇmic_ÿ¡
<cÚ¡ 
	gUpd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
i
))è!ğ
NULL
)

417 
ªs
++;

418  
	gªs
;

421 
	gNÃt
::
SÿËCompÚ’ts
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sÿË_·¿ms
) {

422 
KALDI_ASSERT
(
sÿË_·¿ms
.
Dim
(è=ğ
this
->
NumUpd©abËCompÚ’ts
());

423 
št32
 
	gi
 = 0;

424 
št32
 
	gj
 = 0; j < 
NumCompÚ’ts
(); j++) {

425 
Upd©abËCompÚ’t
 *
	guc
 =

426 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
j
)));

427 ià(
	guc
!ğ
NULL
) {

428 
uc
->
SÿË
(
sÿË_·¿ms
(
i
));

429 
	gi
++;

432 
KALDI_ASSERT
(
i
 =ğ
sÿË_·¿ms
.
Dim
());

436 
	gNÃt
::
SÿË
(
Ba£Flßt
 
sÿË
) {

437 
št32
 
i
 = 0; 
	gi
 < 
NumCompÚ’ts
(); i++) {

438 
Upd©abËCompÚ’t
 *
	guc
 =

439 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

440 ià(
	guc
 !ğ
NULL
è
uc
->
SÿË
(
sÿË
);

441 
NÚlš—rCompÚ’t
 *
	gnc
 =

442 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

443 ià(
	gnc
 !ğ
NULL
è
nc
->
SÿË
(
sÿË
);

447 
	gNÃt
::
CİyStsFrom
(cÚ¡ 
NÃt
 &
Ùh”
) {

448 
KALDI_ASSERT
(
NumCompÚ’ts
(è=ğ
Ùh”
.NumComponents());

449 
št32
 
	gi
 = 0; i < 
NumCompÚ’ts
(); i++) {

450 
NÚlš—rCompÚ’t
 *
	gnc
 =

451 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

452 cÚ¡ 
NÚlš—rCompÚ’t
 *
	gnc_Ùh”
 =

453 
dyÇmic_ÿ¡
<cÚ¡ 
NÚlš—rCompÚ’t
*>(&(
Ùh”
.
G‘CompÚ’t
(
i
)));

454 ià(
	gnc
 !ğ
NULL
) {

455 
nc
->
SÿË
(0.0);

456 
	gnc
->
Add
(1.0, *
nc_Ùh”
);

461 
	gNÃt
::
S‘L—ºšgR©es
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
Ë¬nšg_¿‹s
) {

462 
KALDI_ASSERT
(
Ë¬nšg_¿‹s
.
Dim
(è=ğ
this
->
NumUpd©abËCompÚ’ts
());

463 
KALDI_ASSERT
(
Ë¬nšg_¿‹s
.
Mš
() >= 0.0);

464 
št32
 
	gi
 = 0;

465 
št32
 
	gj
 = 0; j < 
NumCompÚ’ts
(); j++) {

466 
Upd©abËCompÚ’t
 *
	guc
 =

467 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
j
)));

468 ià(
	guc
!ğ
NULL
) {

469 
uc
->
S‘L—ºšgR©e
(
Ë¬nšg_¿‹s
(
i
));

470 
	gi
++;

473 
KALDI_ASSERT
(
i
 =ğ
Ë¬nšg_¿‹s
.
Dim
());

476 
	gNÃt
::
G‘L—ºšgR©es
(
VeùÜBa£
<
Ba£Flßt
> *
Ë¬nšg_¿‹s
) const {

477 
KALDI_ASSERT
(
Ë¬nšg_¿‹s
->
Dim
(è=ğ
this
->
NumUpd©abËCompÚ’ts
());

478 
št32
 
	gi
 = 0;

479 
št32
 
	gj
 = 0; j < 
NumCompÚ’ts
(); j++) {

480 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 =

481 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
j
)));

482 ià(
	guc
!ğ
NULL
) {

483 (*
Ë¬nšg_¿‹s
)(
i
èğ
uc
->
L—ºšgR©e
();

484 
	gi
++;

487 
KALDI_ASSERT
(
i
 =ğ
Ë¬nšg_¿‹s
->
Dim
());

490 
	gNÃt
::
Resize
(
št32
 
Ãw_size
) {

491 
KALDI_ASSERT
(
Ãw_size
 <ğ
¡©ic_ÿ¡
<
št32
>(
compÚ’ts_
.
size
()));

492 
size_t
 
	gi
 = 
Ãw_size
; i < 
	gcompÚ’ts_
.
size
(); i++)

493 
d–‘e
 
	gcompÚ’ts_
[
i
];

494 
	gcompÚ’ts_
.
»size
(
Ãw_size
);

497 
	gNÃt
::
RemoveDrİout
() {

498 
¡d
::
veùÜ
<
CompÚ’t
*> 
compÚ’ts
;

499 
št32
 
	g»moved
 = 0;

500 
size_t
 
	gi
 = 0; i < 
	gcompÚ’ts_
.
size
(); i++) {

501 ià(
	gdyÇmic_ÿ¡
<
	gDrİoutCompÚ’t
*>(
	gcompÚ’ts_
[
i
]è!ğ
NULL
 ||

502 
dyÇmic_ÿ¡
<
Add™iveNoi£CompÚ’t
*>(
compÚ’ts_
[
i
]è!ğ
NULL
) {

503 
d–‘e
 
compÚ’ts_
[
i
];

504 
	g»moved
++;

506 
	gcompÚ’ts
.
push_back
(
compÚ’ts_
[
i
]);

509 
	gcompÚ’ts_
 = 
compÚ’ts
;

510 ià(
	g»moved
 > 0)

511 
	gKALDI_LOG
 << "Removed " << 
	g»moved
 << " dropout components.";

512 
S‘Indexes
();

513 
Check
();

516 
	gNÃt
::
S‘DrİoutSÿË
(
Ba£Flßt
 
sÿË
) {

517 
size_t
 
n_£t
 = 0;

518 
size_t
 
	gi
 = 0; i < 
	gcompÚ’ts_
.
size
(); i++) {

519 
DrİoutCompÚ’t
 *
	gdc
 =

520 
dyÇmic_ÿ¡
<
DrİoutCompÚ’t
*>(
compÚ’ts_
[
i
]);

521 ià(
	gdc
 !ğ
NULL
) {

522 
dc
->
S‘DrİoutSÿË
(
sÿË
);

523 
	gn_£t
++;

526 
	gKALDI_LOG
 << "S‘ drİouˆsÿËØ" << 
	gsÿË


527 << " fÜ " << 
	gn_£t
 << " components.";

531 
	gNÃt
::
RemoveP»cÚd™iÚšg
() {

532 
size_t
 
i
 = 0; 
	gi
 < 
	gcompÚ’ts_
.
size
(); i++) {

533 ià(
	gdyÇmic_ÿ¡
<
	gAffšeCompÚ’tP»cÚd™iÚed
*>(
	gcompÚ’ts_
[
i
]è!ğ
NULL
) {

534 
AffšeCompÚ’t
 *
ac
 = 
Ãw
 AffineComponent(

535 *(
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
compÚ’ts_
[
i
])));

536 
d–‘e
 
	gcompÚ’ts_
[
i
];

537 
	gcompÚ’ts_
[
i
] = 
ac
;

538 } ià(
	gdyÇmic_ÿ¡
<
	gAffšeCompÚ’tP»cÚd™iÚedOÆše
*>(

539 
	gcompÚ’ts_
[
i
]è!ğ
NULL
) {

540 
AffšeCompÚ’t
 *
ac
 = 
Ãw
 AffineComponent(

541 *(
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
compÚ’ts_
[
i
])));

542 
d–‘e
 
	gcompÚ’ts_
[
i
];

543 
	gcompÚ’ts_
[
i
] = 
ac
;

546 
S‘Indexes
();

547 
Check
();

551 
	gNÃt
::
Sw™chToOÆšeP»cÚd™iÚšg
(
št32
 
¿nk_š
, iÁ32 
¿nk_out
,

552 
št32
 
upd©e_³riod
,

553 
Ba£Flßt
 
num_§m¶es_hi¡Üy
,

554 
Ba£Flßt
 
®pha
) {

555 
št32
 
	gsw™ched
 = 0;

556 
size_t
 
	gi
 = 0; i < 
	gcompÚ’ts_
.
size
(); i++) {

557 ià(
	gdyÇmic_ÿ¡
<
	gAffšeCompÚ’t
*>(
	gcompÚ’ts_
[
i
]è!ğ
NULL
) {

558 
AffšeCompÚ’tP»cÚd™iÚedOÆše
 *
ac
 =

559 
Ãw
 
AffšeCompÚ’tP»cÚd™iÚedOÆše
(

560 *(
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
compÚ’ts_
[
i
])),

561 
¿nk_š
, 
¿nk_out
, 
upd©e_³riod
, 
num_§m¶es_hi¡Üy
, 
®pha
);

562 
d–‘e
 
	gcompÚ’ts_
[
i
];

563 
	gcompÚ’ts_
[
i
] = 
ac
;

564 
	gsw™ched
++;

567 
	gKALDI_LOG
 << "Sw™ched " << 
	gsw™ched
 << " componentso use online "

569 << 
	g¿nk_š
 << ", " << 
	g¿nk_out
 << "‡nd‚um_samples_history = "

570 << 
	gnum_§m¶es_hi¡Üy
;

571 
S‘Indexes
();

572 
Check
();

576 
	gNÃt
::
AddNÃt
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sÿË_·¿ms
,

577 cÚ¡ 
NÃt
 &
Ùh”
) {

578 
KALDI_ASSERT
(
sÿË_·¿ms
.
Dim
(è=ğ
this
->
NumUpd©abËCompÚ’ts
());

579 
št32
 
	gi
 = 0;

580 
št32
 
	gj
 = 0; j < 
NumCompÚ’ts
(); j++) {

581 
Upd©abËCompÚ’t
 *
	guc
 =

582 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
j
)));

583 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc_Ùh”
 =

584 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Ùh”
.
G‘CompÚ’t
(
j
)));

585 ià(
	guc
 !ğ
NULL
) {

586 
KALDI_ASSERT
(
uc_Ùh”
 !ğ
NULL
);

587 
Ba£Flßt
 
	g®pha
 = 
sÿË_·¿ms
(
i
);

588 
	guc
->
Add
(
®pha
, *
uc_Ùh”
);

589 
	gi
++;

592 
KALDI_ASSERT
(
i
 =ğ
sÿË_·¿ms
.
Dim
());

595 
	gNÃt
::
AddNÃt
(
Ba£Flßt
 
®pha
,

596 cÚ¡ 
NÃt
 &
Ùh”
) {

597 
št32
 
	gi
 = 0; i < 
NumCompÚ’ts
(); i++) {

598 
Upd©abËCompÚ’t
 *
	guc
 =

599 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

600 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc_Ùh”
 =

601 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Ùh”
.
G‘CompÚ’t
(
i
)));

602 ià(
	guc
 !ğ
NULL
) {

603 
KALDI_ASSERT
(
uc_Ùh”
 !ğ
NULL
);

604 
	guc
->
Add
(
®pha
, *
uc_Ùh”
);

606 
NÚlš—rCompÚ’t
 *
	gnc
 =

607 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

608 cÚ¡ 
NÚlš—rCompÚ’t
 *
	gnc_Ùh”
 =

609 
dyÇmic_ÿ¡
<cÚ¡ 
NÚlš—rCompÚ’t
*>(&(
Ùh”
.
G‘CompÚ’t
(
i
)));

610 ià(
	gnc
 !ğ
NULL
) {

611 
KALDI_ASSERT
(
nc_Ùh”
 !ğ
NULL
);

612 
	gnc
->
Add
(
®pha
, *
nc_Ùh”
);

617 
	gNÃt
::
AddNÃt
(
Ba£Flßt
 
®pha
,

618 
NÃt
 *
Ùh”
,

619 
Ba£Flßt
 
b‘a
) {

620 
št32
 
	gi
 = 0; i < 
NumCompÚ’ts
(); i++) {

621 
Upd©abËCompÚ’t
 *
	guc
 =

622 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

623 
Upd©abËCompÚ’t
 *
	guc_Ùh”
 =

624 
dyÇmic_ÿ¡
<
Upd©abËCompÚ’t
*>(&(
Ùh”
->
G‘CompÚ’t
(
i
)));

625 ià(
	guc
 !ğ
NULL
) {

626 
KALDI_ASSERT
(
uc_Ùh”
 !ğ
NULL
);

627 
	guc
->
Add
(
®pha
, *
uc_Ùh”
);

628 
	guc_Ùh”
->
SÿË
(
b‘a
);

630 
NÚlš—rCompÚ’t
 *
	gnc
 =

631 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
G‘CompÚ’t
(
i
)));

632 
NÚlš—rCompÚ’t
 *
	gnc_Ùh”
 =

633 
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
Ùh”
->
G‘CompÚ’t
(
i
)));

634 ià(
	gnc
 !ğ
NULL
) {

635 
KALDI_ASSERT
(
nc_Ùh”
 !ğ
NULL
);

636 
	gnc
->
Add
(
®pha
, *
nc_Ùh”
);

637 
	gnc_Ùh”
->
SÿË
(
b‘a
);

643 
	gNÃt
::
Aµ’d
(
CompÚ’t
 *
Ãw_compÚ’t
) {

644 
compÚ’ts_
.
push_back
(
Ãw_compÚ’t
);

645 
S‘Indexes
();

646 
Check
();

649 
	gNÃt
::
S‘CompÚ’t
(
št32
 
c
, 
CompÚ’t
 *
compÚ’t
) {

650 
KALDI_ASSERT
(
¡©ic_ÿ¡
<
size_t
>(
c
è< 
compÚ’ts_
.
size
());

651 
d–‘e
 
	gcompÚ’ts_
[
c
];

652 
	gcompÚ’ts_
[
c
] = 
compÚ’t
;

653 
S‘Indexes
();

654 
Check
();

657 
št32
 
	gNÃt
::
G‘P¬am‘”Dim
() const {

658 
št32
 
ªs
 = 0;

659 
št32
 
	gc
 = 0; c < 
NumCompÚ’ts
(); c++) {

660 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<const UpdatableComponent*>(

661 &(
G‘CompÚ’t
(
c
)));

662 ià(
	guc
 !ğ
NULL
)

663 
ªs
 +ğ
uc
->
G‘P¬am‘”Dim
();

665  
	gªs
;

668 
	gNÃt
::
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
) const {

669 
št32
 
off£t
 = 0;

670 
št32
 
	gc
 = 0; c < 
NumCompÚ’ts
(); c++) {

671 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<const UpdatableComponent*>(

672 &(
G‘CompÚ’t
(
c
)));

673 ià(
	guc
 !ğ
NULL
) {

674 
št32
 
size
 = 
uc
->
G‘P¬am‘”Dim
();

675 
	gSubVeùÜ
<
	gBa£Flßt
> 
‹mp
(*
·¿ms
, 
off£t
, 
size
);

676 
	guc
->
VeùÜize
(&
‹mp
);

677 
	goff£t
 +ğ
size
;

680 
KALDI_ASSERT
(
off£t
 =ğ
G‘P¬am‘”Dim
());

683 
	gNÃt
::
Re£tG’”©Üs
() {

686 
št32
 
c
 = 0; 
	gc
 < 
NumCompÚ’ts
(); c++) {

687 
RªdomCompÚ’t
 *
	grc
 = 
dyÇmic_ÿ¡
<RandomComponent*>(

688 &(
G‘CompÚ’t
(
c
)));

689 ià(
	grc
 !ğ
NULL
)

690 
rc
->
Re£tG’”©Ü
();

694 
	gNÃt
::
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
) {

695 
št32
 
off£t
 = 0;

696 
št32
 
	gc
 = 0; c < 
NumCompÚ’ts
(); c++) {

697 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<UpdatableComponent*>(

698 &(
G‘CompÚ’t
(
c
)));

699 ià(
	guc
 !ğ
NULL
) {

700 
št32
 
size
 = 
uc
->
G‘P¬am‘”Dim
();

701 
	guc
->
UnVeùÜize
(
·¿ms
.
Rªge
(
off£t
, 
size
));

702 
	goff£t
 +ğ
size
;

705 
KALDI_ASSERT
(
off£t
 =ğ
G‘P¬am‘”Dim
());

708 
	gNÃt
::
Lim™RªkOfLa¡Lay”
(
št32
 
dim
) {

709 
št32
 
i
 = 
compÚ’ts_
.
size
(è- 1; 
	gi
 >= 0; i--) {

710 
AffšeCompÚ’t
 *
	ga
 = 
NULL
, *
	gb
 = NULL,

711 *
	gc
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
compÚ’ts_
[
i
]);

712 ià(
	gc
 !ğ
NULL
) {

713 
c
->
Lim™Rªk
(
dim
, &
a
, &
b
);

714 
d–‘e
 
	gc
;

715 
	gcompÚ’ts_
[
i
] = 
a
;

716 
	gcompÚ’ts_
.
š£¹
(
compÚ’ts_
.
begš
(è+ 
i
 + 1, 
b
);

717 
	gthis
->
S‘Indexes
();

718 
	gthis
->
Check
();

722 
	gKALDI_ERR
 << "No‡ffine component found in‚eural‚et.";

725 
	gNÃt
::
S‘Indexes
() {

726 
size_t
 
i
 = 0; 
	gi
 < 
	gcompÚ’ts_
.
size
(); i++)

727 
	gcompÚ’ts_
[
i
]->
S‘Index
(i);

730 
	gNÃt
::
CŞÏp£
(
boŞ
 
m©ch_upd©abËÃss
) {

731 
št32
 
num_cŞÏp£d
 = 0;

732 
boŞ
 
	gchªged
 = 
Œue
;

733 
	gchªged
) {

734 
	gchªged
 = 
çl£
;

735 
size_t
 
	gi
 = 0; i + 1 < 
	gcompÚ’ts_
.
size
(); i++) {

736 
AffšeCompÚ’t
 *
	ga1
 = 
dyÇmic_ÿ¡
<AffšeCompÚ’t*>(
compÚ’ts_
[
i
]),

737 *
	ga2
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(
compÚ’ts_
[
i
 + 1]);

738 
FixedAffšeCompÚ’t


739 *
	gf1
 = 
dyÇmic_ÿ¡
<
FixedAffšeCompÚ’t
*>(
compÚ’ts_
[
i
]),

740 *
	gf2
 = 
dyÇmic_ÿ¡
<
FixedAffšeCompÚ’t
*>(
compÚ’ts_
[
i
 + 1]);

741 
CompÚ’t
 *
	gc
 = 
NULL
;

742 ià(
	ga1
 !ğ
NULL
 && 
a2
 != NULL) {

743 
c
 = 
a1
->
CŞÏp£W™hNext
(*
a2
);

744 } ià(
	ga1
 !ğ
NULL
 && 
f2
 !ğNULL && !
m©ch_upd©abËÃss
) {

745 
c
 = 
a1
->
CŞÏp£W™hNext
(*
f2
);

746 } ià(
	gf1
 !ğ
NULL
 && 
a2
 !ğNULL && !
m©ch_upd©abËÃss
) {

747 
c
 = 
a2
->
CŞÏp£W™hP»vious
(*
f1
);

749 ià(
	gc
 !ğ
NULL
) {

750 
d–‘e
 
compÚ’ts_
[
i
];

751 
d–‘e
 
	gcompÚ’ts_
[
i
 + 1];

752 
	gcompÚ’ts_
[
i
] = 
c
;

757 
size_t
 
	gj
 = 
i
 + 1; j + 1 < 
	gcompÚ’ts_
.
size
(); j++)

758 
	gcompÚ’ts_
[
j
] = 
compÚ’ts_
[j + 1];

759 
	gcompÚ’ts_
.
pİ_back
();

760 
	gchªged
 = 
Œue
;

761 
	gnum_cŞÏp£d
++;

765 
	gthis
->
S‘Indexes
();

766 
	gthis
->
Check
();

767 
	gKALDI_LOG
 << "CŞÏp£d " << 
	gnum_cŞÏp£d
 << " components."

768 << (
	gnum_cŞÏp£d
 =ğ0 && 
m©ch_upd©abËÃss
 =ğ
Œue
 ?

772 
NÃt
 *
G’RªdomNÃt
(
št32
 
šput_dim
,

773 
št32
 
ouut_dim
) {

774 
	g¡d
::
veùÜ
<
CompÚ’t
*> 
compÚ’ts
;

775 
št32
 
	gcur_dim
 = 
šput_dim
;

777 
size_t
 
	gi
 = 0; i < 10; i++) {

778 ià(
¿nd
() % 2 == 0) {

780 
št32
 
Ãxt_dim
 = 50 + 
¿nd
() % 100;

781 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.0001, 
	g·¿m_¡ddev
 = 0.001,

782 
	gbŸs_¡ddev
 = 0.1;

783 
AffšeCompÚ’t
 *
	gcompÚ’t
 = 
Ãw
 AffineComponent();

784 
	gcompÚ’t
->
In™
(
Ë¬nšg_¿‹
, 
cur_dim
, 
Ãxt_dim
,

785 
·¿m_¡ddev
, 
bŸs_¡ddev
);

786 
	gcompÚ’ts
.
push_back
(
compÚ’t
);

787 
	gcur_dim
 = 
Ãxt_dim
;

788 } ià(
¿nd
() % 2 == 0) {

789 
compÚ’ts
.
push_back
(
Ãw
 
SigmoidCompÚ’t
(
cur_dim
));

790 } ià(
¿nd
(è% 2 =ğ0 && 
cur_dim
 < 200) {

791 
S¶iûCompÚ’t
 *
compÚ’t
 = 
Ãw
 SpliceComponent();

792 
	g¡d
::
veùÜ
<
št32
> 
cÚ‹xt
;

793 
	gŒue
) {

794 
	gcÚ‹xt
.
ş—r
();

795 
št32
 
	gi
 = -3; i <= 3; i++) {

796 ià(
¿nd
() % 3 == 0)

797 
cÚ‹xt
.
push_back
(
i
);

799 ià(!
	gcÚ‹xt
.
em±y
(è&& cÚ‹xt.
äÚt
() <= 0 &&

800 
cÚ‹xt
.
back
() >= 0)

803 
	gcompÚ’t
->
In™
(
cur_dim
, 
cÚ‹xt
);

804 
	gcompÚ’ts
.
push_back
(
compÚ’t
);

805 
	gcur_dim
 = 
cur_dim
 * 
cÚ‹xt
.
size
();

812 
AffšeCompÚ’t
 *
	gcompÚ’t
 = 
Ãw
 AffineComponent();

813 
Ba£Flßt
 
	gË¬nšg_¿‹
 = 0.0001, 
	g·¿m_¡ddev
 = 0.001,

814 
	gbŸs_¡ddev
 = 0.1;

815 
	gcompÚ’t
->
In™
(
Ë¬nšg_¿‹
, 
cur_dim
, 
ouut_dim
,

816 
·¿m_¡ddev
, 
bŸs_¡ddev
);

817 
	gcompÚ’ts
.
push_back
(
compÚ’t
);

818 
	gcur_dim
 = 
ouut_dim
;

821 
	gcompÚ’ts
.
push_back
(
Ãw
 
SoámaxCompÚ’t
(
cur_dim
));

823 
NÃt
 *
	gªs
 = 
Ãw
 Nnet();

824 
	gªs
->
In™
(&
compÚ’ts
);

825  
	gªs
;

828 
št32
 
	gNÃt
::
Fœ¡Upd©abËCompÚ’t
() const {

829 
št32
 
i
 = 0; 
	gi
 < 
NumCompÚ’ts
(); i++) {

830 ià(
	gdyÇmic_ÿ¡
<
	gUpd©abËCompÚ’t
*>(
	gcompÚ’ts_
[
i
]è!ğ
NULL
)

831  
i
;

833  
NumCompÚ’ts
();

837 
št32
 
	gNÃt
::
La¡Upd©abËCompÚ’t
() const {

838 
št32
 
i
 = 
NumCompÚ’ts
(è- 1; 
	gi
 >= 0; i--)

839 ià(
	gdyÇmic_ÿ¡
<
	gUpd©abËCompÚ’t
*>(
	gcompÚ’ts_
[
i
]è!ğ
NULL
)

840  
i
;

	@nnet-nnet.h

21 #iâdeà
KALDI_NNET2_NNET_NNET_H_


22 
	#KALDI_NNET2_NNET_NNET_H_


	)

24 
	~"ba£/k®di-commÚ.h
"

25 
	~"ut/k®di-io.h
"

26 
	~"m©rix/m©rix-lib.h
"

27 
	~"Â‘2/Â‘-compÚ’t.h
"

29 
	~<io¡»am
>

30 
	~<s¡»am
>

31 
	~<veùÜ
>

32 
	~<m­
>

35 
Çme¥aû
 
	gk®di
 {

36 
Çme¥aû
 
	gÂ‘2
 {

63 şas 
	cNÃt
 {

64 
	gpublic
:

69 
št32
 
NumCompÚ’ts
(ècÚ¡ {  
compÚ’ts_
.
size
(); }

71 cÚ¡ 
	gCompÚ’t
 &
G‘CompÚ’t
(
št32
 
c
) const;

73 
	gCompÚ’t
 &
G‘CompÚ’t
(
št32
 
c
);

77 
S‘CompÚ’t
(
št32
 
c
, 
CompÚ’t
 *
compÚ’t
);

81 
št32
 
LeáCÚ‹xt
() const;

85 
št32
 
RightCÚ‹xt
() const;

89 
št32
 
OuutDim
() const;

94 
št32
 
IÅutDim
() const;

103 
Compu‹ChunkInfo
(
št32
 
šput_chunk_size
,

104 
št32
 
num_chunks
,

105 
¡d
::
veùÜ
<
ChunkInfo
> *
chunk_šfo_out
) const;

107 
Z”oSts
();

111 
CİyStsFrom
(cÚ¡ 
NÃt
 &
Â‘
);

115 
št32
 
Fœ¡Upd©abËCompÚ’t
() const;

119 
št32
 
La¡Upd©abËCompÚ’t
() const;

122 
št32
 
NumUpd©abËCompÚ’ts
() const;

127 
SÿËCompÚ’ts
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sÿËs
);

130 
RemoveDrİout
();

133 
S‘DrİoutSÿË
(
Ba£Flßt
 
sÿË
);

137 
RemoveP»cÚd™iÚšg
();

142 
Sw™chToOÆšeP»cÚd™iÚšg
(
št32
 
¿nk_š
, iÁ32 
¿nk_out
,

143 
št32
 
upd©e_³riod
,

144 
Ba£Flßt
 
num_§m¶es_hi¡Üy
,

145 
Ba£Flßt
 
®pha
);

152 
AddNÃt
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sÿËs
,

153 cÚ¡ 
NÃt
 &
Ùh”
);

158 
SÿË
(
Ba£Flßt
 
sÿË
);

164 
AddNÃt
(
Ba£Flßt
 
®pha
,

165 cÚ¡ 
NÃt
 &
Ùh”
);

170 
Lim™RªkOfLa¡Lay”
(
št32
 
dim’siÚ
);

176 
AddNÃt
(
Ba£Flßt
 
®pha
,

177 
NÃt
 *
Ùh”
,

178 
Ba£Flßt
 
b‘a
);

182 
Resize
(
št32
 
num_compÚ’ts
);

192 
CŞÏp£
(
boŞ
 
m©ch_upd©abËÃss
);

196 
S‘Indexes
();

198 
NÃt
(cÚ¡ NÃˆ&
Ùh”
);

200 
NÃt
(cÚ¡ NÃˆ&
Â‘1
, cÚ¡ NÃˆ&
Â‘2
);

203 
NÃt
() {}

205 
	gNÃt
 &
	gİ”©Ü
 = (cÚ¡ 
NÃt
 &
Ùh”
);

213 
In™
(
¡d
::
i¡»am
 &
is
);

219 
In™
(
¡d
::
veùÜ
<
CompÚ’t
*> *
compÚ’ts
);

223 
Aµ’d
(
CompÚ’t
 *
Ãw_compÚ’t
);

225 
	gvœtu®
 ~
NÃt
(è{ 
De¡roy
(); }

227 
	g¡d
::
¡ršg
 
Info
() const;

229 
De¡roy
();

231 
Wr™e
(
¡d
::
o¡»am
 &
os
, 
boŞ
 
bš¬y
) const;

233 
R—d
(
¡d
::
i¡»am
 &
is
, 
boŞ
 
bš¬y
);

235 
S‘Z”o
(
boŞ
 
Œ—t_as_g¿d›Á
);

244 
ResizeOuutLay”
(
št32
 
Ãw_num_pdfs
);

248 
SÿËL—ºšgR©es
(
Ba£Flßt
 
çùÜ
);

252 
SÿËL—ºšgR©es
(
¡d
::
m­
<¡d::
¡ršg
, 
Ba£Flßt
> 
sÿË_çùÜs
);

255 
S‘L—ºšgR©es
(
Ba£Flßt
 
Ë¬nšg_¿‹s
);

259 
S‘L—ºšgR©es
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
Ë¬nšg_¿‹s
);

263 
G‘L—ºšgR©es
(
VeùÜBa£
<
Ba£Flßt
> *
Ë¬nšg_¿‹s
) const;

270 
CompÚ’tDÙProduùs
(

271 cÚ¡ 
NÃt
 &
Ùh”
,

272 
VeùÜBa£
<
Ba£Flßt
> *
dÙ_´od
) const;

274 
Check
() const;

277 
Re£tG’”©Üs
();

283 
vœtu®
 
št32
 
G‘P¬am‘”Dim
() const;

284 
vœtu®
 
VeùÜize
(
VeùÜBa£
<
Ba£Flßt
> *
·¿ms
) const;

285 
vœtu®
 
UnVeùÜize
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
·¿ms
);

287 
ä›nd
 
şass
 
	gNÃtUpd©”
;

288 
ä›nd
 
şass
 
	gDecodabËNÃt
;

289 
	g´iv©e
:

290 
¡d
::
veùÜ
<
CompÚ’t
*> 
compÚ’ts_
;

298 
NÃt
 *
G’RªdomNÃt
(
št32
 
šput_dim
,

299 
št32
 
ouut_dim
);

	@nnet-precondition-online-test.cc

20 
	~"Â‘2/Â‘-´ecÚd™iÚ-Úlše.h
"

21 
	~"ut/commÚ-uts.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

28 şas 
	cOÆšeP»cÚd™iÚ”Sim¶e
 {

29 
	gpublic
:

30 
OÆšeP»cÚd™iÚ”Sim¶e
(): 
¿nk_
(40), 
num_§m¶es_hi¡Üy_
(2000.0), 
®pha_
(4.0),

31 
•sÚ_
(1.0e-10), 
d–_
(5.0e-04) { }

33 
S‘Rªk
(
št32
 
¿nk
è{ 
	g¿nk_
 =„ank; }

35 
P»cÚd™iÚDœeùiÚs
(

36 
CuM©rixBa£
<
Ba£Flßt
> *
R
,

37 
CuVeùÜBa£
<
Ba£Flßt
> *
row_´od
,

38 
Ba£Flßt
 *
sÿË
);

41 
	g´iv©e
:

42 
Ba£Flßt
 
E
(
št32
 
N
) const;

44 
P»cÚd™iÚDœeùiÚsCpu
(

45 
M©rixBa£
<> *
R
,

46 
VeùÜBa£
<> *
row_´od
,

47 
Ba£Flßt
 *
sÿË
);

50 
In™
(cÚ¡ 
M©rixBa£
<> &
R0
);

52 
In™DeçuÉ
(
št32
 
D
);

54 
št32
 
	g¿nk_
;

55 
	gnum_§m¶es_hi¡Üy_
;

56 
	g®pha_
;

57 
	g•sÚ_
;

58 
	gd–_
;

61 
	gVeùÜ
<> 
	gd_t_
;

62 
	gM©rix
<> 
	gR_t_
;

63 
	grho_t_
;

67 
	gOÆšeP»cÚd™iÚ”Sim¶e
::
P»cÚd™iÚDœeùiÚs
(

68 
CuM©rixBa£
<
Ba£Flßt
> *
R
,

69 
CuVeùÜBa£
<
Ba£Flßt
> *
row_´od
,

70 
Ba£Flßt
 *
sÿË
) {

71 
	gM©rix
<
	gBa£Flßt
> 
R_ıu
(*
R
);

72 
	gVeùÜ
<
	gBa£Flßt
> 
row_´od_ıu
(*
row_´od
);

73 
	gM©rix
<> 
R_ıu_dbl
(
R_ıu
);

74 
	gVeùÜ
<> 
row_´od_ıu_dbl
(
row_´od_ıu
);

75 
P»cÚd™iÚDœeùiÚsCpu
(&
R_ıu_dbl
,

76 &
row_´od_ıu_dbl
,

77 
sÿË
);

78 
	grow_´od_ıu
.
CİyFromVec
(
row_´od_ıu_dbl
);

79 
	gR_ıu
.
CİyFromM©
(
R_ıu_dbl
);

80 
	gR
->
CİyFromM©
(
R_ıu
);

81 
	grow_´od
->
CİyFromVec
(
row_´od_ıu
);

84 
	gOÆšeP»cÚd™iÚ”Sim¶e
::
In™DeçuÉ
(
št32
 
D
) {

85 ià(
¿nk_
 >ğ
D
) {

86 
KALDI_WARN
 << "Rªk " << 
¿nk_
 << " oàÚlš´ecÚd™iÚ” i >ğdim " << 
D


88 << (
D
 - 1) << " (buthis is…robably stilloo high)";

89 
	g¿nk_
 = 
D
 - 1;

91 
št32
 
	gR
 = 
¿nk_
;

92 
	gR_t_
.
Resize
(
R
, 
D
);

93 
št32
 
	gr
 = 0;„ < 
	gR
;„++) {

94 
	g¡d
::
veùÜ
<
št32
> 
cŞs
;

95 
št32
 
	gc
 = 
r
; c < 
	gD
; c +ğ
R
)

96 
cŞs
.
push_back
(
c
);

97 
št32
 
	gi
 = 0; i < 
	gcŞs
.
size
(); i++) {

98 
št32
 
	gc
 = 
cŞs
[
i
];

99 
R_t_
(
r
, 
c
èğ(
i
 == 0 ? 1.1 : 1.0) /

100 
sq¹
(1.1 * 1.1 + 
cŞs
.
size
() - 1);

103 
	gd_t_
.
Resize
(
R
);

104 
	gd_t_
.
S‘
(
•sÚ_
);

105 
	grho_t_
 = 
•sÚ_
;

108 
	gOÆšeP»cÚd™iÚ”Sim¶e
::
In™
(cÚ¡ 
M©rixBa£
<> &
R0
) {

109 
št32
 
D
 = 
R0
.
NumCŞs
(), 
	gN
 = R0.
NumRows
();

110 
In™DeçuÉ
(
D
);

111 
št32
 
	gnum_š™_™”s
 = 3;

112 
št32
 
	gi
 = 0; i < 
	gnum_š™_™”s
; i++) {

113 
	gCuM©rix
<
	gBa£Flßt
> 
R0_cİy
(
R0
);

114 
	gCuVeùÜ
<
	gBa£Flßt
> 
row_´oduùs
(
N
);

115 
Ba£Flßt
 
	gsÿË
;

116 
P»cÚd™iÚDœeùiÚs
(&
R0_cİy
, &
row_´oduùs
, &
sÿË
);

120 
Ba£Flßt
 
	gOÆšeP»cÚd™iÚ”Sim¶e
::
E
(
št32
 
N
) const {

121 
KALDI_ASSERT
(
num_§m¶es_hi¡Üy_
 > 0.0);

122 
Ba£Flßt
 
	gªs
 = 1.0 - 
exp
(-
N
 / 
num_§m¶es_hi¡Üy_
);

123 ià(
	gªs
 > 0.9)‡ns = 0.9;

124  
	gªs
;

128 
	gOÆšeP»cÚd™iÚ”Sim¶e
::
P»cÚd™iÚDœeùiÚsCpu
(

129 
M©rixBa£
<> *
X_t
,

130 
VeùÜBa£
<> *
row_´od
,

131 
Ba£Flßt
 *
sÿË
) {

132 ià(
	gR_t_
.
NumRows
() == 0)

133 
In™
(*
X_t
);

134 
št32
 
	gR
 = 
R_t_
.
NumRows
(), 
	gD
 = R_t_.
NumCŞs
(), 
	gN
 = 
X_t
->NumRows();

135 
Ba£Flßt
 
	g‘a
 = 
E
(
N
);

137 
	gSpM©rix
<> 
F_t
(
D
);

139 
	gF_t
.
AddToDŸg
(
rho_t_
);

140 
	gF_t
.
AddM©2Vec
(1.0, 
R_t_
, 
kT¿ns
, 
d_t_
, 1.0);

144 
KALDI_ASSERT
(
d_t_
.
Mš
() > 0);

145 
	gVeùÜ
<> 
eigs
(
D
);

146 
	gF_t
.
Eig
(&
eigs
, 
NULL
);

147 
KALDI_ASSERT
(
eigs
.
Mš
() > 0);

151 
	gSpM©rix
<> 
S_t
(
D
);

152 
	gS_t
.
AddM©2
(1.0 / 
N
, *
X_t
, 
kT¿ns
, 0.0);

155 
	gSpM©rix
<> 
T_t
(
D
);

156 
	gT_t
.
AddSp
(
‘a
, 
S_t
);

157 
	gT_t
.
AddSp
(1.0 - 
‘a
, 
F_t
);

160 
	gM©rix
<> 
Y_t
(
R
, 
D
);

161 
	gY_t
.
AddM©Sp
(1.0, 
R_t_
, 
kNoT¿ns
, 
T_t
, 0.0);

164 
	gSpM©rix
<> 
Z_t
(
R
);

165 
	gZ_t
.
AddM©2
(1.0, 
Y_t
, 
kNoT¿ns
, 0.0);

167 
	gM©rix
<> 
U_t
(
R
, R);

168 
	gVeùÜ
<> 
c_t
(
R
);

170 
	gZ_t
.
Eig
(&
c_t
, &
U_t
);

171 
SÜtSvd
(&
c_t
, &
U_t
);

172 
	gc_t_æoÜ
 = 
pow
(
rho_t_
 * (1.0 - 
‘a
), 2);

173 
št32
 
	gnf
 = 
c_t
.
AµlyFloÜ
(
c_t_æoÜ
);

174 ià(
	gnf
 > 0) {

175 
	gKALDI_WARN
 << "FloÜed " << 
	gnf
 << "ƒlements of c_t.";

181 
	gVeùÜ
<> 
sq¹_c_t
(
c_t
);

182 
	gsq¹_c_t
.
AµlyPow
(0.5);

183 
	gVeùÜ
<> 
šv_sq¹_c_t
(
sq¹_c_t
);

184 
	gšv_sq¹_c_t
.
Inv”tEËm’ts
();

185 
	gM©rix
<> 
R_t1
(
R
, 
D
);

187 
	gR_t1
.
AddM©M©
(1.0, 
U_t
, 
kT¿ns
, 
Y_t
, 
kNoT¿ns
, 0.0);

188 
	gR_t1
.
MulRowsVec
(
šv_sq¹_c_t
);

190 
	grho_t1
 = (1.0 / (
D
 - 
R
)) *

191 (
‘a
 * 
S_t
.
T¿û
(è+ (1.0 -ƒè* (
D
 * 
rho_t_
 + 
d_t_
.
Sum
()è- 
sq¹_c_t
.Sum());

193 
	gVeùÜ
<> 
d_t1
(
sq¹_c_t
);

194 
	gd_t1
.
Add
(-
rho_t1
);

196 
	gæoÜ_v®
 = 
¡d
::
max
(
•sÚ_
, 
d–_
 * 
sq¹_c_t
.
Max
());

197 ià(
	grho_t1
 < 
	gæoÜ_v®
) {

198 
	gKALDI_WARN
 << "æoÜšg„ho_{t+1}Ø" << 
	gæoÜ_v®
 << ", wa " << 
	grho_t1
;

199 
	grho_t1
 = 
æoÜ_v®
;

201 
	gnf
 = 
d_t1
.
AµlyFloÜ
(
æoÜ_v®
);

202 ià(
	gnf
 > 0) {

203 
KALDI_VLOG
(3è<< "d_t1 wa " << 
	gd_t1
;

204 
	gKALDI_WARN
 << "FloÜed " << 
	gnf
 << "ƒlements of d_{t+1}.";

207 ià(
	gnf
 =ğ0 && 
rho_t1
 > 
æoÜ_v®
) {

208 
Œ_F_t1
 = 
D
 * 
rho_t1
 + 
d_t1
.
Sum
(), 
	gŒ_T_t
 = 
T_t
.
T¿û
();

209 
As£¹Equ®
(
Œ_F_t1
, 
Œ_T_t
);

213 
	gSpM©rix
<> 
G_t
(
F_t
);

214 
	gG_t
.
AddToDŸg
(
®pha_
 / 
D
 * 
F_t
.
T¿û
());

215 
	gSpM©rix
<> 
G_t_šv
(
G_t
);

216 
	gG_t_šv
.
Inv”t
();

218 
	gb‘a_t
 = 
rho_t_
 + 
®pha_
/
D
 * 
F_t
.
T¿û
();

220 
	gM©rix
<> 
X_h©_t
(
N
, 
D
);

221 
	gX_h©_t
.
AddM©Sp
(
b‘a_t
, *
X_t
, 
kNoT¿ns
, 
G_t_šv
, 0.0);

223 
	gŒ_x_x
 = 
T¿ûM©M©
(*
X_t
, *X_t, 
kT¿ns
),

224 
	gŒ_Xh©_Xh©
 = 
T¿ûM©M©
(
X_h©_t
, X_h©_t, 
kT¿ns
);

225 
	ggamma
 = (
Œ_Xh©_Xh©
 =ğ0 ? 1.0 : 
sq¹
(
Œ_x_x
 /r_Xhat_Xhat));

227 
	gX_t
->
CİyFromM©
(
X_h©_t
);

228 
	grow_´od
->
AddDŸgM©2
(1.0, *
X_t
, 
kNoT¿ns
, 0.0);

229 *
	gsÿË
 = 
gamma
;

232 
	grho_t_
 = 
rho_t1
;

233 
	gd_t_
.
CİyFromVec
(
d_t1
);

234 
	gR_t_
.
CİyFromM©
(
R_t1
);

236 
KALDI_VLOG
(3è<< "rho_t_ = " << 
	grho_t_
;

237 
KALDI_VLOG
(3è<< "d_t_ = " << 
	gd_t_
;

238 
KALDI_VLOG
(3è<< "R_t_ = " << 
	gR_t_
;

242 
	gSpM©rix
<> 
un™
(
R
);

243 
	gun™
.
AddM©2
(1.0, 
R_t_
, 
kNoT¿ns
, 0.0);

244 ià(!
	gun™
.
IsUn™
(1.0e-03)) {

245 
	gKALDI_WARN
 << "R is‚ot orthogonal,„eorthogonalizing.";

246 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

247 
	gSubVeùÜ
<> 
row
(
R_t_
, 
i
);

248 
št32
 
	gj
 = 0; j < 
	gi
; j++) {

249 
	gSubVeùÜ
<> 
row_j
(
R_t_
, 
j
);

250 
	grow
.
AddVec
(-
VecVec
(
row_j
, 
row
),„ow_j);

252 
	grow
.
SÿË
(1.0 / 
row
.
NÜm
(2.0));

255 
	gun™
.
AddM©2
(1.0, 
R_t_
, 
kNoT¿ns
, 0.0);

256 
KALDI_ASSERT
(
un™
.
IsUn™
(1.0e-03));

261 
Un™Te¡P»cÚd™iÚDœeùiÚsOÆše
() {

262 
M©rixIndexT
 
	gR
 = 1 + 
Rªd
() % 30,

263 
	gN
 = (2 * 
R
è+ 
Rªd
() % 30,

264 
	gD
 = 
R
 + 1 + 
Rªd
() % 20;

268 
boŞ
 
	gz”o
 = 
çl£
;

269 
boŞ
 
	gÚe
 = 
çl£
;

270 ià(
Rªd
(è% 3 =ğ0è
z”o
 = 
Œue
;

273 
	gCuVeùÜ
<
	gBa£Flßt
> 
row_´od1
(
N
), 
row_´od2
(N);

274 
Ba£Flßt
 
	ggamma1
, 
	ggamma2
;

275 
Ba£Flßt
 
	gbig_eig_çùÜ
 = 
RªdIÁ
(1, 20);

276 
	gbig_eig_çùÜ
 = 
big_eig_çùÜ
 * big_eig_factor;

277 
	gVeùÜ
<
	gBa£Flßt
> 
big_eig_veùÜ
(
D
);

278 
	gbig_eig_veùÜ
.
S‘Rªdn
();

279 
	gbig_eig_veùÜ
.
SÿË
(
big_eig_çùÜ
);

281 
OÆšeP»cÚd™iÚ”Sim¶e
 
	g´ecÚd™iÚ”1
;

282 
OÆšeP»cÚd™iÚ”
 
	g´ecÚd™iÚ”2
;

283 
	g´ecÚd™iÚ”1
.
S‘Rªk
(
R
);

284 
	g´ecÚd™iÚ”2
.
S‘Rªk
(
R
);

285 
	g´ecÚd™iÚ”2
.
TuºOnDebug
();

287 
št32
 
	gnum_™”s
 = 100;

288 
št32
 
	g™”
 = 0; i‹¸< 
	gnum_™”s
; iter++) {

289 
	gM©rix
<
	gBa£Flßt
> 
M_ıu
(
N
, 
D
);

290 ià(
	gÚe
è
	gM_ıu
.
S‘
(1.0);

291 ià(!
	gz”o
) {

292 
	gM_ıu
.
S‘Rªdn
();

293 
	gVeùÜ
<
	gBa£Flßt
> 
¿nd_vec
(
N
);

294 
	g¿nd_vec
.
S‘Rªdn
();

295 
	gM_ıu
.
AddVecVec
(1.0, 
¿nd_vec
, 
big_eig_veùÜ
);

297 
	gCuM©rix
<
	gBa£Flßt
> 
M
(
M_ıu
);

299 
	gCuM©rix
<
	gBa£Flßt
> 
Mcİy1
(
M
), 
Mcİy2
(M);

301 
	g´ecÚd™iÚ”1
.
P»cÚd™iÚDœeùiÚs
(&
Mcİy1
, &
row_´od1
, &
gamma1
);

303 
	g´ecÚd™iÚ”2
.
P»cÚd™iÚDœeùiÚs
(&
Mcİy2
, &
row_´od2
, &
gamma2
);

305 
Ba£Flßt
 
	gŒaû1
 = 
T¿ûM©M©
(
M
, M, 
kT¿ns
),

306 
	gŒaû2
 = 
T¿ûM©M©
(
Mcİy1
, Mcİy1, 
kT¿ns
);

307 
As£¹Equ®
(
Œaû1
, 
Œaû2
 * 
gamma2
 * gamma2, 1.0e-02);

309 
As£¹Equ®
(
Mcİy1
, 
Mcİy2
);

310 
	gAs£¹Equ®
<
	gBa£Flßt
>(
	grow_´od1
, 
	grow_´od2
, 1.0e-02);

311 
As£¹Equ®
(
gamma1
, 
gamma2
, 1.0e-02);

314 
	gCuVeùÜ
<
	gBa£Flßt
> 
šÃr_´ods
(
M
.
NumRows
());

315 
	gšÃr_´ods
.
AddDŸgM©M©
(1.0, 
M
, 
kNoT¿ns
, 
Mcİy1
, 
kT¿ns
, 0.0);

316 
KALDI_ASSERT
(
šÃr_´ods
.
Mš
() >= 0.0);

326 
	$maš
() {

327 
usšg
 
Çme¥aû
 
k®di
;

328 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

329 
št32
 
loİ
 = 0;†oop < 2;†oop++) {

330 #ià
HAVE_CUDA
 == 1

331 
CuDeviû
::
	`In¡ªtŸ‹
().
	`S‘DebugSŒideMode
(
Œue
);

332 ià(
loİ
 == 0)

333 
CuDeviû
::
	`In¡ªtŸ‹
().
	`S–eùGpuId
("no");

335 
CuDeviû
::
	`In¡ªtŸ‹
().
	`S–eùGpuId
("optional");

337 
št32
 
i
 = 0; i < 10; i++) {

338 
	`Un™Te¡P»cÚd™iÚDœeùiÚsOÆše
();

341 
	}
}

	@nnet-precondition-online.cc

21 
	~"Â‘2/Â‘-´ecÚd™iÚ-Úlše.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

27 
	gOÆšeP»cÚd™iÚ”
::
OÆšeP»cÚd™iÚ”
():

28 
¿nk_
(40), 
upd©e_³riod_
(1), 
num_§m¶es_hi¡Üy_
(2000.0), 
®pha_
(4.0),

29 
•sÚ_
(1.0e-10), 
d–_
(5.0e-04), 
t_
(-1),

30 
num_upd©es_sk³d_
(0), 
£lf_debug_
(
çl£
) { }

45 
	gOÆšeP»cÚd™iÚ”
::
In™O¹hÚÜm®S³cŸl
(
CuM©rixBa£
<
Ba£Flßt
> *
R
) {

46 
št32
 
num_rows
 = 
R
->
NumRows
(), 
	gnum_cŞs
 = R->
NumCŞs
();

47 
KALDI_ASSERT
(
num_cŞs
 >ğ
num_rows
);

48 
	gR
->
S‘Z”o
();

49 
	g¡d
::
veùÜ
<
M©rixEËm’t
<
Ba£Flßt
> > 
–ems
;

50 
	g–ems
.
»£rve
(
num_cŞs
);

51 
Ba£Flßt
 
	gfœ¡_–em
 = 1.1;

52 
št32
 
	gr
 = 0;„ < 
	gnum_rows
;„++) {

53 
	g¡d
::
veùÜ
<
št32
> 
cŞs
;

54 
št32
 
	gc
 = 
r
; c < 
	gnum_cŞs
; c +ğ
num_rows
)

55 
cŞs
.
push_back
(
c
);

56 
Ba£Flßt
 
	gnÜm®iz”
 = 1.0 / 
sq¹
(
fœ¡_–em
 * first_elem +

57 
cŞs
.
size
() - 1);

58 
size_t
 
	gi
 = 0; i < 
	gcŞs
.
size
(); i++) {

59 
št32
 
	gc
 = 
cŞs
[
i
];

60 
	gM©rixEËm’t
<
	gBa£Flßt
> 
	ge
 = { 
r
, 
c
,

61 
nÜm®iz”
 * (
i
 =ğ0 ? 
fœ¡_–em
 :

62 
Ba£Flßt
(1.0)) };

63 
	g–ems
.
push_back
(
e
);

66 
	gR
->
AddEËm’ts
(1.0, 
–ems
);

68 
	gCuM©rix
<
	gBa£Flßt
> 
´od
(
num_rows
,‚um_rows);

69 
	g´od
.
AddM©M©
(1.0, *
R
, 
kNoT¿ns
, *R, 
kT¿ns
, 0.0);

70 
KALDI_ASSERT
(
´od
.
IsUn™
());

75 
	gOÆšeP»cÚd™iÚ”
::
In™DeçuÉ
(
št32
 
D
) {

76 ià(
¿nk_
 >ğ
D
) {

77 
KALDI_WARN
 << "Rªk " << 
¿nk_
 << " oàÚlš´ecÚd™iÚ” i >ğdim " << 
D


79 << (
D
 - 1) << " (buthis is…robably stilloo high)";

80 
	g¿nk_
 = 
D
 - 1;

82 ià(
	g¿nk_
 == 0) {

88 
KALDI_ASSERT
(
num_§m¶es_hi¡Üy_
 > 0.0 &&‚um_samples_history_ <= 1.0e+6);

89 
KALDI_ASSERT
(
®pha_
 >= 0.0);

90 
KALDI_ASSERT
(
¿nk_
 > 0);

91 
KALDI_ASSERT
(
•sÚ_
 > 0.0 &&ƒpsilon_ <= 1.0e-05);

92 
KALDI_ASSERT
(
d–_
 > 0.0 && delta_ <= 1.0e-02);

110 
Ba£Flßt
 
	g•sÚ
 = 
•sÚ_
;

111 
	grho_t_
 = 
•sÚ
;

112 
	gd_t_
.
Resize
(
¿nk_
, 
kUndefšed
);

113 
	gd_t_
.
S‘
(
•sÚ
);

114 
	gW_t_
.
Resize
(
¿nk_
, 
D
, 
kUndefšed
);

116 
In™O¹hÚÜm®S³cŸl
(&
W_t_
);

117 
Ba£Flßt
 
	gE_tii
 = 1.0 / ( 2.0 + (
D
 + 
¿nk_
è* 
®pha_
 / D );

119 
	gW_t_
.
SÿË
(
sq¹
(
E_tii
));

120 
	gt_
 = 0;

123 
	gOÆšeP»cÚd™iÚ”
::
In™
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R0
) {

124 
št32
 
D
 = 
R0
.
NumCŞs
();

126 
OÆšeP»cÚd™iÚ”
 
this_cİy
(*
this
);

127 
	gthis_cİy
.
In™DeçuÉ
(
D
);

129 
	gCuM©rix
<
	gBa£Flßt
> 
R0_cİy
(
R0
.
NumRows
(), R0.
NumCŞs
(), 
kUndefšed
);

132 
št32
 
	gnum_š™_™”s
 = 3;

133 
št32
 
	gi
 = 0; i < 
	gnum_š™_™”s
; i++) {

134 
Ba£Flßt
 
	gsÿË
;

135 
	gR0_cİy
.
CİyFromM©
(
R0
);

136 
	gthis_cİy
.
P»cÚd™iÚDœeùiÚs
(&
R0_cİy
, 
NULL
, &
sÿË
);

138 
	g¿nk_
 = 
this_cİy
.
¿nk_
;

139 
	gW_t_
.
Sw­
(&
this_cİy
.
W_t_
);

140 
	gd_t_
.
Sw­
(&
this_cİy
.
d_t_
);

141 
	grho_t_
 = 
this_cİy
.
rho_t_
;

142 
	gt_
 = 0;

145 
	gOÆšeP»cÚd™iÚ”
::
P»cÚd™iÚDœeùiÚs
(

146 
CuM©rixBa£
<
Ba£Flßt
> *
X_t
,

147 
CuVeùÜBa£
<
Ba£Flßt
> *
row_´od
,

148 
Ba£Flßt
 *
sÿË
) {

149 ià(
	gX_t
->
NumCŞs
() == 1) {

153 ià(
row_´od
)

154 
row_´od
->
AddDŸgM©2
(1.0, *
X_t
, 
kNoT¿ns
, 0.0);

155 *
	gsÿË
 = 1.0;

159 ià(
	grow_´od
 =ğ
NULL
) {

160 
CuVeùÜ
<
Ba£Flßt
> 
row_´od_tmp
(
X_t
->
NumRows
());

161 
P»cÚd™iÚDœeùiÚs
(
X_t
, &
row_´od_tmp
, 
sÿË
);

165 
	g»ad_wr™e_mu‹x_
.
lock
();

166 ià(
	gt_
 == -1)

167 
In™
(*
X_t
);

174 
št32
 
	gt
 = 
t_
, 
	gR
 = 
W_t_
.
NumRows
(), 
	gD
 = W_t_.
NumCŞs
();

176 
	gCuM©rix
<
	gBa£Flßt
> 
WJKL_t
(2 * 
R
, 
D
 + R);

177 
	gWJKL_t
.
Rªge
(0, 
R
, 0, 
D
).
CİyFromM©
(
W_t_
);

178 
Ba£Flßt
 
rho_t
(
rho_t_
);

179 
	gVeùÜ
<
	gBa£Flßt
> 
d_t
(
d_t_
);

180 
	g»ad_wr™e_mu‹x_
.
uÆock
();

181 
P»cÚd™iÚDœeùiÚsIÁ”Çl
(
t
, 
rho_t
, 
d_t
, &
WJKL_t
, 
X_t
, 
row_´od
, 
sÿË
);

184 
	gOÆšeP»cÚd™iÚ”
::
ReÜthogÚ®izeXt1
(

185 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t1
,

186 
Ba£Flßt
 
rho_t1
,

187 
CuM©rixBa£
<
Ba£Flßt
> *
W_t1
,

188 
CuM©rixBa£
<
Ba£Flßt
> *
‹mp_W
,

189 
CuM©rixBa£
<
Ba£Flßt
> *
‹mp_O
) {

192 cÚ¡ 
Ba£Flßt
 
	gth»shŞd
 = 1.0e-03;

194 
št32
 
	gR
 = 
W_t1
->
NumRows
(), 
	gD
 = W_t1->
NumCŞs
();

195 
Ba£Flßt
 
	gb‘a_t1
 = 
rho_t1
 * (1.0 + 
®pha_
è+‡Íha_ * 
d_t1
.
Sum
(è/ 
D
;

196 
	gVeùÜ
<
	gBa£Flßt
> 
e_t1
(
R
, 
kUndefšed
), 
sq¹_e_t1
(R, kUndefined),

197 
šv_sq¹_e_t1
(
R
, 
kUndefšed
);

198 
Compu‹Et
(
d_t1
, 
b‘a_t1
, &
e_t1
, &
sq¹_e_t1
, &
šv_sq¹_e_t1
);

200 
	g‹mp_O
->
SymAddM©2
(1.0, *
W_t1
, 
kNoT¿ns
, 0.0);

202 
	gM©rix
<
	gBa£Flßt
> 
O_m©
(*
‹mp_O
);

203 
	gSpM©rix
<
	gBa£Flßt
> 
O
(
O_m©
, 
kTakeLow”
);

204 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

205 
Ba£Flßt
 
	gi_çùÜ
 = 
šv_sq¹_e_t1
(
i
);

206 
št32
 
	gj
 = 0; j <ğ
i
; j++) {

207 
Ba£Flßt
 
	gj_çùÜ
 = 
šv_sq¹_e_t1
(
j
);

208 
O
(
i
, 
j
è*ğ
i_çùÜ
 * 
j_çùÜ
;

211 ià(
	gO
.
IsUn™
(
th»shŞd
)) {

212 ià(
	g£lf_debug_
) {

213 
	gKALDI_WARN
 << "NÙ„eÜthogÚ®izšg sšû‡Ì—dy o¹hognßl: " << 
	gO
;

217 
	gTpM©rix
<
	gBa£Flßt
> 
C
(
R
);

218 
	gŒy
 {

219 
	gC
.
ChŞesky
(
O
);

220 
	gC
.
Inv”t
();

221 ià(!(
	gC
.
Max
() < 100.0))

222 
	gKALDI_ERR
 << "Cholesky out ofƒxpected„ange, "

224 } 
ÿtch
 (...) {

227 
	gKALDI_WARN
 << "Cholesky or Invert() failed while„e-orthogonalizing R_t. "

229 
	gM©rix
<
	gBa£Flßt
> 
ıu_W_t1
(*
W_t1
);

230 
	gıu_W_t1
.
O¹hogÚ®izeRows
();

231 
	gW_t1
->
CİyFromM©
(
ıu_W_t1
);

234 
	gCuVeùÜ
<
	gBa£Flßt
> 
sq¹_e_t1_gpu
(
sq¹_e_t1
);

235 
	gW_t1
->
MulRowsVec
(
sq¹_e_t1_gpu
);

240 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

241 
Ba£Flßt
 
	gi_çùÜ
 = 
sq¹_e_t1
(
i
);

242 
št32
 
	gj
 = 0; j < 
	gi
; j++) {

244 
Ba£Flßt
 
	gj_çùÜ
 = 
šv_sq¹_e_t1
(
j
);

245 
C
(
i
, 
j
è*ğ
i_çùÜ
 * 
j_çùÜ
;

248 
	gO_m©
.
CİyFromTp
(
C
);

249 
	g‹mp_O
->
CİyFromM©
(
O_m©
);

250 
	g‹mp_W
->
CİyFromM©
(*
W_t1
);

251 
	gW_t1
->
AddM©M©
(1.0, *
‹mp_O
, 
kNoT¿ns
, *
‹mp_W
, kNoTrans, 0.0);

255 
	gOÆšeP»cÚd™iÚ”
::
S–fTe¡
() const {

256 
KALDI_ASSERT
(
rho_t_
 >ğ
•sÚ_
);

257 
Ba£Flßt
 
	gd_t_max
 = 
d_t_
.
Max
(), 
	gd_t_mš
 = d_t_.
Mš
();

258 
KALDI_ASSERT
(
d_t_mš
 >ğ
•sÚ_
);

259 
KALDI_ASSERT
(
d_t_mš
 > 0.9 * 
d–_
 * 
d_t_max
);

260 
KALDI_ASSERT
(
rho_t_
 > 0.9 * 
d–_
 * 
d_t_max
);

262 
št32
 
	gD
 = 
W_t_
.
NumCŞs
(), 
	gR
 = W_t_.
NumRows
();

263 
Ba£Flßt
 
	gb‘a_t
 = 
rho_t_
 * (1.0 + 
®pha_
è+‡Íha_ * 
d_t_
.
Sum
(è/ 
D
;

264 
	gVeùÜ
<
	gBa£Flßt
> 
e_t
(
R
, 
kUndefšed
), 
sq¹_e_t
(R, kUndefined),

265 
šv_sq¹_e_t
(
R
, 
kUndefšed
);

266 
Compu‹Et
(
d_t_
, 
b‘a_t
, &
e_t
, &
sq¹_e_t
, &
šv_sq¹_e_t
);

268 
	gCuSpM©rix
<
	gBa£Flßt
> 
S
(
R
);

269 
	gS
.
AddM©2
(1.0, 
W_t_
, 
kNoT¿ns
, 0.0);

270 
	gSpM©rix
<
	gBa£Flßt
> 
O
(
S
);

271 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

272 
Ba£Flßt
 
	gi_çùÜ
 = 
šv_sq¹_e_t
(
i
);

273 
št32
 
	gj
 = 0; j <ğ
i
; j++) {

274 
Ba£Flßt
 
	gj_çùÜ
 = 
šv_sq¹_e_t
(
j
);

275 
O
(
i
, 
j
è*ğ
i_çùÜ
 * 
j_çùÜ
;

278 ià(!
	gO
.
IsUn™
(1.0e-04è|| 
O
(0, 0) != O(0, 0)) {

279 
Ba£Flßt
 
	gwÜ¡_”rÜ
 = 0.0;

280 
št32
 
	gwÜ¡_i
 = 0, 
	gwÜ¡_j
 = 0;

281 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

282 
št32
 
	gj
 = 0; j < 
	gR
; j++) {

283 
Ba£Flßt
 
	g–em
 = 
O
(
i
, 
j
);

284 
Ba£Flßt
 
	g”rÜ
 = 
çbs
(
–em
 - (
i
 =ğ
j
 ? 1.0 : 0.0));

285 ià(
	g”rÜ
 > 
	gwÜ¡_”rÜ
 ||ƒ¼Ü !ğ
”rÜ
) {

286 
wÜ¡_”rÜ
 = 
”rÜ
;

287 
	gwÜ¡_i
 = 
i
;

288 
	gwÜ¡_j
 = 
j
;

292 ià(
	gwÜ¡_”rÜ
 > 1.0e-02 || wÜ¡_”rÜ !ğ
wÜ¡_”rÜ
) {

293 
KALDI_WARN
 << "FaedØv”ify W_ˆ(wÜ¡ƒ¼Ü: O[" << 
wÜ¡_i
 << ','

294 << 
wÜ¡_j
 << "] = " << 
O
(
wÜ¡_i
, worst_j)

295 << ", d_ˆğ" << 
d_t_
;

300 
	gOÆšeP»cÚd™iÚ”
::
P»cÚd™iÚDœeùiÚsIÁ”Çl
(

301 cÚ¡ 
št32
 
t
,

302 cÚ¡ 
Ba£Flßt
 
rho_t
,

303 cÚ¡ 
VeùÜ
<
Ba£Flßt
> &
d_t
,

304 
CuM©rixBa£
<
Ba£Flßt
> *
WJKL_t
,

305 
CuM©rixBa£
<
Ba£Flßt
> *
X_t
,

306 
CuVeùÜBa£
<
Ba£Flßt
> *
row_´od
,

307 
Ba£Flßt
 *
sÿË
) {

308 
št32
 
	gN
 = 
X_t
->
NumRows
(),

309 
	gD
 = 
X_t
->
NumCŞs
(),

310 
	gR
 = 
¿nk_
;

311 
KALDI_ASSERT
(
R
 > 0 && R < 
D
);

312 
Ba£Flßt
 
	g‘a
 = 
E
(
N
);

314 
	gCuM©rix
<
	gBa£Flßt
> 
H_t
(
N
, 
R
);

315 cÚ¡ 
	gCuSubM©rix
<
	gBa£Flßt
> 
W_t
(*
WJKL_t
, 0, 
R
, 0, 
D
);

318 
	gCuSubM©rix
<
	gBa£Flßt
> 
J_t
(*
WJKL_t
, 
R
, R, 0, 
D
),

319 
L_t
(*
WJKL_t
, 0, 
R
, 
D
, R),

320 
K_t
(*
WJKL_t
, 
R
, R, 
D
, R),

321 
WJ_t
(*
WJKL_t
, 0, 2 * 
R
, 0, 
D
),

322 
LK_t
(*
WJKL_t
, 0, 2 * 
R
, 
D
, R);

324 
	gH_t
.
AddM©M©
(1.0, *
X_t
, 
kNoT¿ns
, 
W_t
, 
kT¿ns
, 0.0);

326 
boŞ
 
	glocked
 = 
upd©e_mu‹x_
.
Œy_lock
();

327 ià(
	glocked
) {

329 cÚ¡ 
	gnum_š™Ÿl_upd©es
 = 10;

330 ià(
	gt_
 > 
	gt
 || (
	gnum_upd©es_sk³d_
 < 
	gupd©e_³riod_
 - 1 &&

331 
	gt_
 >ğ
num_š™Ÿl_upd©es
)) {

332 
upd©e_mu‹x_
.
uÆock
();

336 
	glocked
 = 
çl£
;

340 ià(!
	glocked
) {

350 
	gnum_upd©es_sk³d_
++;

352 
Ba£Flßt
 
	gŒ_Xt_XtT
 = 
T¿ûM©M©
(*
X_t
, *X_t, 
kT¿ns
);

354 
	gX_t
->
AddM©M©
(-1.0, 
H_t
, 
kNoT¿ns
, 
W_t
, kNoTrans, 1.0);

357 
	grow_´od
->
AddDŸgM©2
(1.0, *
X_t
, 
kNoT¿ns
, 0.0);

358 
Ba£Flßt
 
	gŒ_Xh©_Xh©T
 = 
row_´od
->
Sum
();

359 
KALDI_ASSERT
(
Œ_Xh©_Xh©T
 ==r_Xhat_XhatT);

360 
Ba£Flßt
 
	ggamma_t
 = (
Œ_Xh©_Xh©T
 == 0.0 ? 1.0 :

361 
sq¹
(
Œ_Xt_XtT
 / 
Œ_Xh©_Xh©T
));

362 *
	gsÿË
 = 
gamma_t
;

365 
	gJ_t
.
AddM©M©
(1.0, 
H_t
, 
kT¿ns
, *
X_t
, 
kNoT¿ns
, 0.0);

367 
boŞ
 
	gcompu‹_lk_tog‘h”
 = (
N
 > 
D
);

369 ià(
	gcompu‹_lk_tog‘h”
) {

376 
	gLK_t
.
AddM©M©
(1.0, 
WJ_t
, 
kNoT¿ns
, 
J_t
, 
kT¿ns
, 0.0);

378 
	gK_t
.
SymAddM©2
(1.0, 
J_t
, 
kNoT¿ns
, 0.0);

379 
	gL_t
.
SymAddM©2
(1.0, 
H_t
, 
kT¿ns
, 0.0);

382 
	gM©rix
<
	gBa£Flßt
> 
LK_ıu
(
LK_t
);

383 
	gSubM©rix
<
	gBa£Flßt
> 
L_t_ıu
(
LK_ıu
, 0, 
R
, 0, R),

384 
K_t_ıu
(
LK_ıu
, 
R
, R, 0, R);

385 ià(!
	gcompu‹_lk_tog‘h”
) {

387 
	gL_t_ıu
.
CİyLow”ToUµ”
();

388 
	gK_t_ıu
.
CİyLow”ToUµ”
();

392 
Ba£Flßt
 
	gb‘a_t
 = 
rho_t
 * (1.0 + 
®pha_
è+‡Íha_ * 
d_t
.
Sum
(è/ 
D
;

393 
	gVeùÜ
<
	gBa£Flßt
> 
e_t
(
R
), 
sq¹_e_t
(R), 
šv_sq¹_e_t
(R);

394 
Compu‹Et
(
d_t
, 
b‘a_t
, &
e_t
, &
sq¹_e_t
, &
šv_sq¹_e_t
);

395 
KALDI_VLOG
(5è<< "e_ˆğ" << 
	ge_t
;

399 
	gSpM©rix
<> 
Z_t_doubË
(
R
);

400 
Compu‹Zt
(
N
, 
rho_t
, 
d_t
, 
šv_sq¹_e_t
, 
K_t_ıu
, 
L_t_ıu
, &
Z_t_doubË
);

401 
Ba£Flßt
 
	gz_t_sÿË
 = 
¡d
::
max
<>(1.0, 
	gZ_t_doubË
.
T¿û
());

402 
	gZ_t_doubË
.
SÿË
(1.0 / 
z_t_sÿË
);

403 
	gSpM©rix
<
	gBa£Flßt
> 
Z_t_sÿËd
(
Z_t_doubË
);

405 
	gM©rix
<
	gBa£Flßt
> 
U_t
(
R
, R);

406 
	gVeùÜ
<
	gBa£Flßt
> 
c_t
(
R
);

408 
	gZ_t_sÿËd
.
Eig
(&
c_t
, &
U_t
);

409 
SÜtSvd
(&
c_t
, &
U_t
);

410 
	gc_t
.
SÿË
(
z_t_sÿË
);

412 cÚ¡ 
Ba£Flßt
 
	gcÚd™iÚ_th»shŞd
 = 1.0e+06;

416 
boŞ
 
	gmu¡_»ÜthogÚ®ize
 = (
c_t
(0è> 
cÚd™iÚ_th»shŞd
 * c_t(
R
 - 1));

418 
Ba£Flßt
 
	gc_t_æoÜ
 = 
pow
(
rho_t
 * (1 - 
‘a
), 2);

419 
št32
 
	gnf
 = 
c_t
.
AµlyFloÜ
(
c_t_æoÜ
);

420 ià(
	gnf
 > 0)

421 
	gmu¡_»ÜthogÚ®ize
 = 
Œue
;

422 ià(
	gnf
 > 0 && 
	g£lf_debug_
) {

423 
	gKALDI_WARN
 << "FloÜed " << 
	gnf
 << "ƒlements of C_t.";

425 
Ba£Flßt
 
	gŒ_Xt_XtT_check
;

426 ià(
	g£lf_debug_
)

427 
	gŒ_Xt_XtT_check
 = 
T¿ûM©M©
(*
X_t
, *X_t, 
kT¿ns
);

429 
	gX_t
->
AddM©M©
(-1.0, 
H_t
, 
kNoT¿ns
, 
W_t
, kNoTrans, 1.0);

431 
	grow_´od
->
AddDŸgM©2
(1.0, *
X_t
, 
kNoT¿ns
, 0.0);

433 
Ba£Flßt
 
	gŒ_Xh©_Xh©T
 = 
row_´od
->
Sum
();

435 
	gŒ_Xt_XtT
 = 
Œ_Xh©_Xh©T
;

436 
št32
 
	gi
 = 0; i < 
	gR
; i++)

437 
	gŒ_Xt_XtT
 +ğ
L_t_ıu
(
i
, iè* (2.0 - 
e_t
(i));

438 ià(
	g£lf_debug_
) {

439 
KALDI_ASSERT
(
AµroxEqu®
(
Œ_Xt_XtT
, 
Œ_Xt_XtT_check
));

441 
Ba£Flßt
 
	ggamma_t
 = (
Œ_Xh©_Xh©T
 == 0.0 ? 1.0 :

442 
sq¹
(
Œ_Xt_XtT
 / 
Œ_Xh©_Xh©T
));

443 *
	gsÿË
 = 
gamma_t
;

445 
	gVeùÜ
<
	gBa£Flßt
> 
sq¹_c_t
(
c_t
);

446 
	gsq¹_c_t
.
AµlyPow
(0.5);

449 
Ba£Flßt
 
	grho_t1
 = 1.0 / (
D
 - 
R
è* (
‘a
 / 
N
 * 
Œ_Xt_XtT


450 + (1-
‘a
)*(
D
 * 
rho_t
 + 
d_t
.
Sum
())

451 - 
sq¹_c_t
.
Sum
());

453 
	gVeùÜ
<
	gBa£Flßt
> 
d_t1
(
sq¹_c_t
);

454 
	gd_t1
.
Add
(-
rho_t1
);

455 
Ba£Flßt
 
	gæoÜ_v®
 = 
¡d
::
max
(
•sÚ_
, 
d–_
 * 
sq¹_c_t
.
Max
());

456 ià(
	grho_t1
 < 
	gæoÜ_v®
)

457 
	grho_t1
 = 
æoÜ_v®
;

458 
	gd_t1
.
AµlyFloÜ
(
æoÜ_v®
);

460 
	gCuM©rix
<
	gBa£Flßt
> 
W_t1
(
R
, 
D
);

461 
Compu‹Wt1
(
N
, 
d_t
, 
d_t1
, 
rho_t
, 
rho_t1
, 
U_t
, 
sq¹_c_t
, 
šv_sq¹_e_t
,

462 
W_t
, &
J_t
, &
W_t1
);

464 ià(
	gmu¡_»ÜthogÚ®ize
) {

465 ià(
	g£lf_debug_
) {

466 
	gKALDI_WARN
 << "Reorthogonalizing.";

468 
ReÜthogÚ®izeXt1
(
d_t1
,

469 
rho_t1
,

470 &
W_t1
,

471 &
J_t
,

472 &
L_t
);

476 
	g»ad_wr™e_mu‹x_
.
lock
();

477 
KALDI_ASSERT
(
t_
 =ğ
t
);

478 
	gt_
 = 
t
 + 1;

479 
	gnum_upd©es_sk³d_
 = 0;

480 
	gW_t_
.
Sw­
(&
W_t1
);

481 
	gd_t_
.
CİyFromVec
(
d_t1
);

482 
	grho_t_
 = 
rho_t1
;

484 ià(
	g£lf_debug_
)

485 
S–fTe¡
();

487 
	g»ad_wr™e_mu‹x_
.
uÆock
();

488 
	gupd©e_mu‹x_
.
uÆock
();

491 
Ba£Flßt
 
	gOÆšeP»cÚd™iÚ”
::
E
(
št32
 
N
) const {

492 
KALDI_ASSERT
(
num_§m¶es_hi¡Üy_
 > 0.0);

493 
Ba£Flßt
 
	gªs
 = 1.0 - 
exp
(-
N
 / 
num_§m¶es_hi¡Üy_
);

496 ià(
	gªs
 > 0.9)‡ns = 0.9;

497  
	gªs
;

500 
	gOÆšeP»cÚd™iÚ”
::
Compu‹Wt1
(
št32
 
N
,

501 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t
,

502 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t1
,

503 
Ba£Flßt
 
rho_t
,

504 
Ba£Flßt
 
rho_t1
,

505 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
U_t
,

506 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sq¹_c_t
,

507 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
šv_sq¹_e_t
,

508 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
W_t
,

509 
CuM©rixBa£
<
Ba£Flßt
> *
J_t
,

510 
CuM©rixBa£
<
Ba£Flßt
> *
W_t1
) const {

512 
št32
 
	gR
 = 
d_t
.
Dim
(), 
	gD
 = 
W_t
.
NumCŞs
();

513 
Ba£Flßt
 
	g‘a
 = 
E
(
N
);

516 
Ba£Flßt
 
	gb‘a_t1
 = 
rho_t1
 * (1.0 + 
®pha_
è+‡Íha_ * 
d_t1
.
Sum
(è/ 
D
;

517 
KALDI_ASSERT
(
b‘a_t1
 > 0.0);

518 
	gVeùÜ
<
	gBa£Flßt
> 
e_t1
(
R
, 
kUndefšed
), 
sq¹_e_t1
(R, kUndefined),

519 
šv_sq¹_e_t1
(
R
, 
kUndefšed
);

520 
Compu‹Et
(
d_t1
, 
b‘a_t1
, &
e_t1
, &
sq¹_e_t1
, &
šv_sq¹_e_t1
);

521 
	gVeùÜ
<
	gBa£Flßt
> 
šv_sq¹_c_t
(
sq¹_c_t
);

522 
	gšv_sq¹_c_t
.
Inv”tEËm’ts
();

524 
	gVeùÜ
<
	gBa£Flßt
> 
w_t_cÛff
(
R
);

525 
št32
 
	gi
 = 0; i < 
	gR
; i++)

526 
w_t_cÛff
(
i
èğ(1.0 - 
‘a
è/ (‘a/
N
è* (
d_t
(iè+ 
rho_t
);

527 
	gCuVeùÜ
<
	gBa£Flßt
> 
w_t_cÛff_gpu
(
w_t_cÛff
);

529 
	gJ_t
->
AddDŸgVecM©
(1.0, 
w_t_cÛff_gpu
, 
W_t
, 
kNoT¿ns
, 1.0);

532 
	gM©rix
<
	gBa£Flßt
> 
A_t
(
U_t
, 
kT¿ns
);

533 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

534 
Ba£Flßt
 
	gi_çùÜ
 = (
‘a
 / 
N
è* 
sq¹_e_t1
(
i
è* 
šv_sq¹_c_t
(i);

535 
št32
 
	gj
 = 0; j < 
	gR
; j++) {

536 
Ba£Flßt
 
	gj_çùÜ
 = 
šv_sq¹_e_t
(
j
);

537 
A_t
(
i
, 
j
è*ğ
i_çùÜ
 * 
j_çùÜ
;

541 
	gCuM©rix
<
	gBa£Flßt
> 
A_t_gpu
(
A_t
);

542 
	gW_t1
->
AddM©M©
(1.0, 
A_t_gpu
, 
kNoT¿ns
, *
J_t
, kNoTrans, 0.0);

545 
	gOÆšeP»cÚd™iÚ”
::
Compu‹Zt
(
št32
 
N
,

546 
Ba£Flßt
 
rho_t
,

547 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t
,

548 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
šv_sq¹_e_t
,

549 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
K_t
,

550 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
L_t
,

551 
SpM©rix
<> *
Z_t
) const {

554 
Ba£Flßt
 
	g‘a
 = 
E
(
N
);

555 
	gVeùÜ
<
	gBa£Flßt
> 
d_t_rho_t
(
d_t
);

556 
	gd_t_rho_t
.
Add
(
rho_t
);

557 
	g‘aN
 = 
‘a
 / 
N
, 
	g‘a1
 = 1.0 -ƒta,

558 
	g‘aN_sq
 = 
‘aN
 *ƒN, 
	g‘a1_sq
 = 
‘a1
 *ƒta1,

559 
	g‘aN_‘a1
 = 
‘aN
 * 
‘a1
;

560 
št32
 
	gR
 = 
d_t
.
Dim
();

561 
št32
 
	gi
 = 0; i < 
	gR
; i++) {

562 
	gšv_sq¹_e_t_i
 = 
šv_sq¹_e_t
(
i
), 
	gd_t_rho_t_i
 = 
d_t_rho_t
(i);

563 
št32
 
	gj
 = 0; j <ğ
i
; j++) {

564 
	gšv_sq¹_e_t_j
 = 
šv_sq¹_e_t
(
j
), 
	gd_t_rho_t_j
 = 
d_t_rho_t
(j),

565 
	gL_t_i_j
 = 0.5 * (
L_t
(
i
, 
j
) + L_t(j, i)),

566 
	gK_t_i_j
 = 0.5 * (
K_t
(
i
, 
j
) + K_t(j, i));

568 (*
	gZ_t
)(
	gi
, 
	gj
èğ
‘aN_sq
 * 
šv_sq¹_e_t_i
 * 
K_t_i_j
 * 
šv_sq¹_e_t_j


569 + 
‘aN_‘a1
 * 
šv_sq¹_e_t_i
 * 
L_t_i_j
 * 
šv_sq¹_e_t_j
 * 
d_t_rho_t_j


570 + 
‘aN_‘a1
 * 
d_t_rho_t_i
 * 
šv_sq¹_e_t_i
 * 
L_t_i_j
 * 
šv_sq¹_e_t_j


571 + (
i
 =ğ
j
 ? 
‘a1_sq
 * 
d_t_rho_t_i
 * d_t_rho_t_i : 0.0);

576 
	gOÆšeP»cÚd™iÚ”
::
Compu‹Et
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t
,

577 
Ba£Flßt
 
b‘a_t
,

578 
VeùÜBa£
<
Ba£Flßt
> *
e_t
,

579 
VeùÜBa£
<
Ba£Flßt
> *
sq¹_e_t
,

580 
VeùÜBa£
<
Ba£Flßt
> *
šv_sq¹_e_t
) const {

582 
št32
 
	gD
 = 
d_t
.
Dim
();

583 cÚ¡ 
Ba£Flßt
 *
	gd
 = 
d_t
.
D©a
();

584 
Ba£Flßt
 *
	ge
 = 
e_t
->
D©a
();

585 
št32
 
	gi
 = 0; i < 
	gD
; i++)

586 
	ge
[
i
] = 1.0 / (
b‘a_t
 / 
d
[i] + 1);

587 
	gsq¹_e_t
->
CİyFromVec
(*
e_t
);

588 
	gsq¹_e_t
->
AµlyPow
(0.5);

589 
	gšv_sq¹_e_t
->
CİyFromVec
(*
sq¹_e_t
);

590 
	gšv_sq¹_e_t
->
Inv”tEËm’ts
();

594 
	gOÆšeP»cÚd™iÚ”
::
OÆšeP»cÚd™iÚ”
(cÚ¡ OÆšeP»cÚd™iÚ” &
Ùh”
):

595 
¿nk_
(
Ùh”
.¿nk_), 
upd©e_³riod_
(other.update_period_),

596 
num_§m¶es_hi¡Üy_
(
Ùh”
.num_samples_history_),

597 
®pha_
(
Ùh”
.®pha_), 
•sÚ_
(Ùh”.•sÚ_), 
d–_
(other.delta_),

598 
t_
(
Ùh”
.t_), 
num_upd©es_sk³d_
(other.num_updates_skipped_),

599 
£lf_debug_
(
Ùh”
.£lf_debug_), 
W_t_
(other.W_t_),

600 
rho_t_
(
Ùh”
.rho_t_), 
d_t_
(other.d_t_) {

604 
	gOÆšeP»cÚd™iÚ”
& OÆšeP»cÚd™iÚ”::
İ”©Ü
 = (

605 cÚ¡ 
OÆšeP»cÚd™iÚ”
 &
Ùh”
) {

606 
¿nk_
 = 
Ùh”
.rank_;

607 
	gupd©e_³riod_
 = 
Ùh”
.
upd©e_³riod_
;

608 
	gnum_§m¶es_hi¡Üy_
 = 
Ùh”
.
num_§m¶es_hi¡Üy_
;

609 
	g®pha_
 = 
Ùh”
.
®pha_
;

610 
	g•sÚ_
 = 
Ùh”
.
•sÚ_
;

611 
	gd–_
 = 
Ùh”
.
d–_
;

612 
	gt_
 = 
Ùh”
.
t_
;

613 
	g£lf_debug_
 = 
Ùh”
.
£lf_debug_
;

614 
	gW_t_
 = 
Ùh”
.
W_t_
;

615 
	grho_t_
 = 
Ùh”
.
rho_t_
;

616 
	gd_t_
 = 
Ùh”
.
d_t_
;

617  *
	gthis
;

620 
	gOÆšeP»cÚd™iÚ”
::
S‘Rªk
(
št32
 
¿nk
) {

621 
KALDI_ASSERT
(
¿nk
 > 0);

622 
	g¿nk_
 = 
¿nk
;

624 
	gOÆšeP»cÚd™iÚ”
::
S‘Upd©eP”iod
(
št32
 
upd©e_³riod
) {

625 
KALDI_ASSERT
(
upd©e_³riod
 > 0);

626 
	gupd©e_³riod_
 = 
upd©e_³riod
;

628 
	gOÆšeP»cÚd™iÚ”
::
S‘NumSam¶esHi¡Üy
(
Ba£Flßt
 
num_§m¶es_hi¡Üy
) {

629 
KALDI_ASSERT
(
num_§m¶es_hi¡Üy
 > 0.0 &&

630 
num_§m¶es_hi¡Üy
 < 1.0e+6);

631 
	gnum_§m¶es_hi¡Üy_
 = 
num_§m¶es_hi¡Üy
;

633 
	gOÆšeP»cÚd™iÚ”
::
S‘AÍha
(
Ba£Flßt
 
®pha
) {

634 
KALDI_ASSERT
(
®pha
 >= 0.0);

635 
	g®pha_
 = 
®pha
;

	@nnet-precondition-online.h

21 #iâdeà
KALDI_NNET2_NNET_PRECONDITION_ONLINE_H_


22 
	#KALDI_NNET2_NNET_PRECONDITION_ONLINE_H_


	)

24 
	~<io¡»am
>

25 
	~<mu‹x
>

26 
	~"ba£/k®di-commÚ.h
"

27 
	~"m©rix/m©rix-lib.h
"

28 
	~"cudam©rix/cu-m©rix-lib.h
"

30 
Çme¥aû
 
	gk®di
 {

31 
Çme¥aû
 
	gÂ‘2
 {

413 şas 
	cOÆšeP»cÚd™iÚ”
 {

414 
	gpublic
:

415 
OÆšeP»cÚd™iÚ”
();

417 
S‘Rªk
(
št32
 
¿nk
);

418 
S‘Upd©eP”iod
(
št32
 
upd©e_³riod
);

420 
S‘NumSam¶esHi¡Üy
(
Ba£Flßt
 
num_§m¶es_hi¡Üy
);

421 
S‘AÍha
(
Ba£Flßt
 
®pha
);

422 
TuºOnDebug
(è{ 
	g£lf_debug_
 = 
Œue
; }

423 
Ba£Flßt
 
G‘NumSam¶esHi¡Üy
(ècÚ¡ {  
	gnum_§m¶es_hi¡Üy_
; }

424 
Ba£Flßt
 
G‘AÍha
(ècÚ¡ {  
	g®pha_
; }

425 
št32
 
G‘Rªk
(ècÚ¡ {  
	g¿nk_
; }

426 
št32
 
G‘Upd©eP”iod
(ècÚ¡ {  
	gupd©e_³riod_
; }

435 
P»cÚd™iÚDœeùiÚs
(
CuM©rixBa£
<
Ba£Flßt
> *
R
,

436 
CuVeùÜBa£
<
Ba£Flßt
> *
row_´od
,

437 
Ba£Flßt
 *
sÿË
);

440 
ex¶ic™
 
OÆšeP»cÚd™iÚ”
(cÚ¡ OÆšeP»cÚd™iÚ” &
Ùh”
);

442 
	gOÆšeP»cÚd™iÚ”
 &
	gİ”©Ü
 = (cÚ¡ 
OÆšeP»cÚd™iÚ”
 &
Ùh”
);

443 
	g´iv©e
:

448 
P»cÚd™iÚDœeùiÚsIÁ”Çl
(cÚ¡ 
št32
 
t
,

449 cÚ¡ 
Ba£Flßt
 
rho_t
,

450 cÚ¡ 
VeùÜ
<
Ba£Flßt
> &
d_t
,

451 
CuM©rixBa£
<
Ba£Flßt
> *
WJKL_t
,

452 
CuM©rixBa£
<
Ba£Flßt
> *
X_t
,

453 
CuVeùÜBa£
<
Ba£Flßt
> *
row_´od
,

454 
Ba£Flßt
 *
sÿË
);

456 
Compu‹Et
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t
,

457 
Ba£Flßt
 
b‘a_t
,

458 
VeùÜBa£
<
Ba£Flßt
> *
e_t
,

459 
VeùÜBa£
<
Ba£Flßt
> *
sq¹_e_t
,

460 
VeùÜBa£
<
Ba£Flßt
> *
šv_sq¹_e_t
) const;

462 
Compu‹Zt
(
št32
 
N
,

463 
Ba£Flßt
 
rho_t
,

464 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t
,

465 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
šv_sq¹_e_t
,

466 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
K_t
,

467 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
L_t
,

468 
SpM©rix
<> *
Z_t
) const;

470 
Compu‹Wt1
(
št32
 
N
,

471 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t
,

472 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t1
,

473 
Ba£Flßt
 
rho_t
,

474 
Ba£Flßt
 
rho_t1
,

475 cÚ¡ 
M©rixBa£
<
Ba£Flßt
> &
U_t
,

476 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
sq¹_c_t
,

477 cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
šv_sq¹_e_t
,

478 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
W_t
,

479 
CuM©rixBa£
<
Ba£Flßt
> *
J_t
,

480 
CuM©rixBa£
<
Ba£Flßt
> *
W_t1
) const;

485 
ReÜthogÚ®izeXt1
(cÚ¡ 
VeùÜBa£
<
Ba£Flßt
> &
d_t1
,

486 
Ba£Flßt
 
rho_t1
,

487 
CuM©rixBa£
<
Ba£Flßt
> *
W_t1
,

488 
CuM©rixBa£
<
Ba£Flßt
> *
‹mp_W
,

489 
CuM©rixBa£
<
Ba£Flßt
> *
‹mp_O
);

491 
In™
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R0
);

496 
In™DeçuÉ
(
št32
 
D
);

501 
In™O¹hÚÜm®S³cŸl
(
CuM©rixBa£
<
Ba£Flßt
> *
R
);

507 
Ba£Flßt
 
E
(
št32
 
N
) const;

511 
S–fTe¡
() const;

516 
št32
 
	g¿nk_
;

521 
št32
 
	gupd©e_³riod_
;

527 
Ba£Flßt
 
	gnum_§m¶es_hi¡Üy_
;

531 
Ba£Flßt
 
	g®pha_
;

537 
Ba£Flßt
 
	g•sÚ_
;

543 
Ba£Flßt
 
	gd–_
;

546 
št32
 
	gt_
;

552 
št32
 
	gnum_upd©es_sk³d_
;

555 
boŞ
 
	g£lf_debug_
;

557 
	gCuM©rix
<
	gBa£Flßt
> 
	gW_t_
;

558 
Ba£Flßt
 
	grho_t_
;

559 
	gVeùÜ
<
	gBa£Flßt
> 
	gd_t_
;

563 
	g¡d
::
mu‹x
 
»ad_wr™e_mu‹x_
;

567 
	g¡d
::
mu‹x
 
upd©e_mu‹x_
;

	@nnet-precondition-test.cc

20 
	~"Â‘2/Â‘-´ecÚd™iÚ.h
"

21 
	~"ut/commÚ-uts.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

26 
Un™Te¡P»cÚd™iÚDœeùiÚs
() {

27 
M©rixIndexT
 
	gN
 = 2 + 
Rªd
() % 30,

28 
	gD
 = 1 + 
Rªd
() % 20;

29 
Ba£Flßt
 
	gÏmbda
 = 0.1;

30 
	gCuM©rix
<
	gBa£Flßt
> 
R
(
N
, 
D
), 
P
(N, D);

31 
	gR
.
S‘Rªdn
();

32 
	gP
.
S‘Rªdn
();

34 
P»cÚd™iÚDœeùiÚs
(
R
, 
Ïmbda
, &
P
);

38 
	gCuSpM©rix
<
	gBa£Flßt
> 
G
(
D
);

39 
	gG
.
S‘Un™
();

40 
	gG
.
SÿËDŸg
(
Ïmbda
);

42 
	gG
.
AddM©2
(1.0/(
N
-1), 
R
, 
kT¿ns
, 1.0);

44 
št32
 
	gn
 = 0;‚ < 
	gN
;‚++) {

45 
	gCuSubVeùÜ
<
	gBa£Flßt
> 
º
(
R
, 
n
);

46 
	gCuSpM©rix
<
	gBa£Flßt
> 
Gn
(
G
);

47 
	gGn
.
AddVec2
(-1.0/(
N
-1), 
º
);

49 
	gGn
.
Inv”t
();

50 
	gCuSubVeùÜ
<
	gBa£Flßt
> 
²
(
P
, 
n
);

51 
	gCuVeùÜ
<
	gBa£Flßt
> 
²_com·»
(
D
);

52 
	g²_com·»
.
AddSpVec
(1.0, 
Gn
, 
º
, 0.0);

53 
KALDI_ASSERT
(
²
.
AµroxEqu®
(
²_com·»
, 0.1));

62 
	$maš
() {

63 
usšg
 
Çme¥aû
 
k®di
;

64 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

65 
št32
 
i
 = 0; i < 10; i++)

66 
	`Un™Te¡P»cÚd™iÚDœeùiÚs
();

67 
	}
}

	@nnet-precondition.cc

20 
	~"Â‘2/Â‘-´ecÚd™iÚ.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

26 
P»cÚd™iÚDœeùiÚs
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R
,

27 
Ïmbda
,

28 
CuM©rixBa£
<
Ba£Flßt
> *
P
) {

30 
št32
 
	gN
 = 
R
.
NumRows
(), 
	gD
 = R.
NumCŞs
();

31 
KALDI_ASSERT
(
SameDim
(
R
, *
P
è&& 
N
 > 0);

32 ià(
	gN
 == 1) {

33 
KALDI_WARN
 << "Tryingo…recondition set of only one frames:„eturning "

35 
	gP
->
CİyFromM©
(
R
);

38 
	gCuM©rixBa£
<
	gBa£Flßt
> &
	gQ
 = *
P
;

40 ià(
	gN
 >ğ
D
) {

43 
CuM©rix
<
Ba£Flßt
> 
G
(
D
, D);

44 
	gG
.
AddToDŸg
(
Ïmbda
);

46 
	gG
.
SymAddM©2
(1.0 / (
N
-1), 
R
, 
kT¿ns
, 1.0);

47 
	gG
.
CİyLow”ToUµ”
();

48 ià(
G‘V”bo£Lev–
(è>ğ5 && 
Rªd
() % 20 == 0) {

49 
CuSpM©rix
<
Ba£Flßt
> 
tmp
(
G
, 
kTakeLow”
);

50 
	gSpM©rix
<
	gBa£Flßt
> 
G_ıu
(
tmp
);

51 
	gG_ıu
.
PrštEigs
("G");

53 
	gG
.
SymInv”tPosDef
();

56 
	gQ
.
AddM©M©
(1.0, 
R
, 
kNoT¿ns
, 
G
, 
kT¿ns
, 0.0);

64 
	gCuM©rix
<
	gBa£Flßt
> 
S
(
N
, N);

66 
	gS
.
AddToDŸg
(
Ïmbda
);

69 
	gS
.
SymAddM©2
(1.0 / (
N
-1), 
R
, 
kNoT¿ns
, 1.0);

70 
	gS
.
CİyLow”ToUµ”
();

72 ià(
G‘V”bo£Lev–
(è>ğ5 && 
Rªd
() % 20 == 0) {

73 
CuSpM©rix
<
Ba£Flßt
> 
tmp
(
S
, 
kTakeLow”
);

74 
	gSpM©rix
<
	gBa£Flßt
> 
S_ıu
(
tmp
);

75 
	gS_ıu
.
PrštEigs
("S");

77 
	gS
.
SymInv”tPosDef
();

78 
	gQ
.
AddM©M©
(1.0, 
S
, 
kNoT¿ns
, 
R
, kNoTrans, 0.0);

82 
št32
 
	gn
 = 0;‚ < 
	gN
;‚++) {

83 
	gCuSubVeùÜ
<
	gBa£Flßt
> 
r
(
R
, 
n
), 
q
(
Q
,‚);

84 
Ba£Flßt
 
	ggamma
 = 
VecVec
(
r
, 
q
),

85 
	gb‘a
 = 1 + 
gamma
 / (
N
 - 1 - gamma);

86 ià(!(
	ggamma
 >ğ0.0 && 
b‘a
 > 0.0)) {

87 
KALDI_ERR
 << "Bad v®ue ’couÁ”ed iÀ´ecÚd™iÚšg: gamm¨ğ" << 
gamma


88 << ", b‘¨ğ" << 
b‘a
;

92 
	gq
.
SÿË
(
b‘a
);

95 
	gCuVeùÜ
<
	gBa£Flßt
> 
gamma
(
N
);

96 
	ggamma
.
AddDŸgM©M©
(1.0, 
R
, 
kNoT¿ns
, 
Q
, 
kT¿ns
, 0.0);

99 
	gVeùÜ
<
	gBa£Flßt
> 
ıu_gamma
(
gamma
), 
ıu_b‘a
(
N
, 
kUndefšed
);

100 
št32
 
	gn
 = 0;‚ < 
	gN
;‚++) {

101 
Ba£Flßt
 
	gthis_gamma
 = 
ıu_gamma
(
n
),

102 
	gthis_b‘a
 = 1.0 + 
this_gamma
 / (
N
 - 1 -his_gamma);

103 ià(!(
	gthis_gamma
 >ğ0.0 && 
this_b‘a
 > 0.0))

104 
KALDI_ERR
 << "Bad valuesƒncountered in…reconditioning: gamma = "

105 << 
this_gamma
 << ", b‘¨ğ" << 
this_b‘a
;

106 
ıu_b‘a
(
n
èğ
this_b‘a
;

108 
	gCuVeùÜ
<
	gBa£Flßt
> 
b‘a
(
ıu_b‘a
);

109 
	gP
->
MulRowsVec
(
b‘a
);

114 
P»cÚd™iÚDœeùiÚsAÍha
(

115 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R
,

116 
®pha
,

117 
CuM©rixBa£
<
Ba£Flßt
> *
P
) {

118 
KALDI_ASSERT
(
®pha
 > 0.0);

120 
	gt
 = 
T¿ûM©M©
(
R
, R, 
kT¿ns
), 
	gæoÜ
 = 1.0e-20;

121 ià(
	gt
 < 
	gæoÜ
) {

122 
	gKALDI_WARN
 << "FloÜšg¿û from " << 
	gt


123 << "Ø" << 
	gæoÜ
;

124 
	gt
 = 
æoÜ
;

126 
	gÏmbda
 = 
t
 * 
®pha
 / 
R
.
NumRows
(è/ R.
NumCŞs
();

128 ià(
	gÏmbda
 <= 0.0) {

131 
KALDI_WARN
 << "Zero or‚egative†ambda in PreconditionDirectionsAlpha.";

132 
	gÏmbda
 = 1.0e-10;

134 
P»cÚd™iÚDœeùiÚs
(
R
, 
Ïmbda
, 
P
);

138 
P»cÚd™iÚDœeùiÚsAÍhaResÿËd
(

139 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R
,

140 
®pha
,

141 
CuM©rixBa£
<
Ba£Flßt
> *
P
) {

142 
KALDI_ASSERT
(
®pha
 > 0.0);

144 
	gt
 = 
T¿ûM©M©
(
R
, R, 
kT¿ns
), 
	gæoÜ
 = 1.0e-20;

145 ià(
	gt
 == 0.0) {

146 
P
->
CİyFromM©
(
R
);

149 ià(
	gt
 < 
	gæoÜ
) {

150 
	gKALDI_WARN
 << "FloÜšg¿û from " << 
	gt


151 << "Ø" << 
	gæoÜ
;

152 
	gt
 = 
æoÜ
;

154 
	gÏmbda
 = 
t
 * 
®pha
 / 
R
.
NumRows
(è/ R.
NumCŞs
();

156 
KALDI_ASSERT
(
Ïmbda
 != 0.0);

157 
P»cÚd™iÚDœeùiÚs
(
R
, 
Ïmbda
, 
P
);

158 
	gp_Œaû
 = 
T¿ûM©M©
(*
P
, *P, 
kT¿ns
),

159 
	g»sÿË
 = 
sq¹
(
t
 / 
p_Œaû
);

160 
KALDI_ASSERT
(
p_Œaû
 != 0.0);

161 
	gP
->
SÿË
(
»sÿË
);

	@nnet-precondition.h

20 #iâdeà
KALDI_NNET2_NNET_PRECONDITION_H_


21 
	#KALDI_NNET2_NNET_PRECONDITION_H_


	)

23 
	~"ba£/k®di-commÚ.h
"

24 
	~"m©rix/m©rix-lib.h
"

25 
	~"cudam©rix/cu-m©rix-lib.h
"

27 
	~<io¡»am
>

29 
Çme¥aû
 
	gk®di
 {

30 
Çme¥aû
 
	gÂ‘2
 {

59 
P»cÚd™iÚDœeùiÚs
(cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R
,

60 
Ïmbda
,

61 
CuM©rixBa£
<
Ba£Flßt
> *
P
);

67 
P»cÚd™iÚDœeùiÚsAÍha
(

68 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R
,

69 
®pha
,

70 
CuM©rixBa£
<
Ba£Flßt
> *
P
);

77 
P»cÚd™iÚDœeùiÚsAÍhaResÿËd
(

78 cÚ¡ 
CuM©rixBa£
<
Ba£Flßt
> &
R
,

79 
®pha
,

80 
CuM©rixBa£
<
Ba£Flßt
> *
P
);

	@nnet-stats.cc

20 
	~"Â‘2/Â‘-¡©s.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

25 
	gNÃtSts
::
StsEËm’t
::
PrštSts
(
¡d
::
o¡»am
 &
os
) {

26 
Ba£Flßt
 
c
 = (
couÁ
 == 0 ? 1 : count),

27 
	gd”iv_m—n
 = 
d”iv_sum
/
c
,

28 
	gd”iv_¡ddev
 = 
¡d
::
sq¹
(
d”iv_sumsq
/
c
 - 
d”iv_m—n
*deriv_mean),

29 
	gabs_v®ue_m—n
 = 
abs_v®ue_sum
/
c
,

30 
	gabs_v®ue_¡ddev
 = 
¡d
::
sq¹
(
abs_v®ue_sumsq
/
c
 -

31 
abs_v®ue_m—n
*abs_value_mean);

33 
	gos
 << '[' << 
	gd”iv_begš
 << ':' << 
	gd”iv_’d
 << "] couÁ=" << 
	gcouÁ


34 << ", d”iv m—n,¡ddev=" << 
	gd”iv_m—n
 << ',' << 
	gd”iv_¡ddev


35 << ",‡bs-avg-v®um—n,¡ddev=" << 
	gabs_v®ue_m—n
 << ','

36 << 
	gabs_v®ue_¡ddev
;

39 
	gNÃtSts
::
StsEËm’t
::
AddSts
(
Ba£Flßt
 
avg_d”iv
, Ba£Flßˆ
avg_v®ue
) {

40 
	gcouÁ
++;

41 
	gd”iv_sum
 +ğ
avg_d”iv
;

42 
	gd”iv_sumsq
 +ğ
avg_d”iv
 *‡vg_deriv;

43 
	gabs_v®ue_sum
 +ğ
¡d
::
abs
(
avg_v®ue
);

44 
	gabs_v®ue_sumsq
 +ğ
avg_v®ue
 *‡vg_value;

47 
št32
 
	gNÃtSts
::
Buck‘FÜ
(
Ba£Flßt
 
avg_d”iv
) {

48 
KALDI_ASSERT
(
avg_d”iv
 >= 0.0);

49 
KALDI_ASSERT
(
buck‘_width_
 > 0.0);

51 
št32
 
	gšdex
 = 
¡©ic_ÿ¡
<št32>(
avg_d”iv
 / 
buck‘_width_
 + 0.5);

52 
	gšdex
 >ğ
¡©ic_ÿ¡
<
št32
>(
buck‘s_
.
size
()))

53 
buck‘s_
.
push_back
(
StsEËm’t
(buck‘s_.
size
(è* 
buck‘_width_
,

54 (
buck‘s_
.
size
(è+ 1è* 
buck‘_width_
));

55  
	gšdex
;

58 
	gNÃtSts
::
AddSts
(
Ba£Flßt
 
avg_d”iv
, Ba£Flßˆ
avg_v®ue
) {

59 
	gglob®_
.
AddSts
(
avg_d”iv
, 
avg_v®ue
);

60 
	gbuck‘s_
[
Buck‘FÜ
(
avg_d”iv
)].
AddSts
×vg_d”iv, 
avg_v®ue
);

63 
	gNÃtSts
::
AddStsFromNÃt
(cÚ¡ 
NÃt
 &
Â‘
) {

64 cÚ¡ 
AffšeCompÚ’t
 *
ac
 = 
dyÇmic_ÿ¡
<const AffineComponent*>(

65 &(
Â‘
.
G‘CompÚ’t
(
affše_compÚ’t_šdex_
)));

66 
KALDI_ASSERT
(
ac
 !ğ
NULL
);

67 cÚ¡ 
NÚlš—rCompÚ’t
 *
	gnc
 = 
dyÇmic_ÿ¡
<const NonlinearComponent*>(

68 &(
Â‘
.
G‘CompÚ’t
(
affše_compÚ’t_šdex_
 + 1)));

69 
KALDI_ASSERT
(
nc
 !ğ
NULL
);

71 
	gcouÁ
 = 
nc
->
CouÁ
();

72 ià(
	gcouÁ
 == 0) {

73 
KALDI_WARN
 << "No stats stored with‚onlinear component";

76 cÚ¡ 
	gCuVeùÜ
<> &
	gv®ue_sum
 = 
nc
->
V®ueSum
();

77 cÚ¡ 
	gCuVeùÜ
<> &
	gd”iv_sum
 = 
nc
->
D”ivSum
();

78 ià(
	gv®ue_sum
.
Dim
(è!ğ
d”iv_sum
.Dim())

79 
KALDI_ERR
 << "Error computing‚net stats:…robably you‡re "

81 
št32
 
	gi
 = 0; i < 
	gv®ue_sum
.
Dim
(); i++) {

82 
Ba£Flßt
 
	gavg_v®ue
 = 
v®ue_sum
(
i
è/ 
couÁ
,

83 
	gavg_d”iv
 = 
d”iv_sum
(
i
è/ 
couÁ
;

84 
AddSts
(
avg_d”iv
, 
avg_v®ue
);

88 
	gNÃtSts
::
PrštSts
(
¡d
::
o¡»am
 &
os
) {

89 
os
 << "St fÜ buck‘s:" << 
¡d
::
’dl
;

90 
size_t
 
	gi
 = 0; i < 
	gbuck‘s_
.
size
(); i++) {

91 
	gbuck‘s_
[
i
].
PrštSts
(
os
);

92 
	gos
 << 
	g¡d
::
’dl
;

94 
	gos
 << "Global stats: ";

95 
	gglob®_
.
PrštSts
(
os
);

96 
	gos
 << 
	g¡d
::
’dl
;

99 
G‘NÃtSts
(cÚ¡ 
NÃtStsCÚfig
 &
cÚfig
,

100 cÚ¡ 
NÃt
 &
Â‘
,

101 
¡d
::
veùÜ
<
NÃtSts
> *
¡©s
) {

102 
KALDI_ASSERT
(
¡©s
->
size
() == 0);

103 
št32
 
	gc
 = 0; c + 1 < 
	gÂ‘
.
NumCompÚ’ts
(); c++) {

104 cÚ¡ 
AffšeCompÚ’t
 *
	gac
 = 
dyÇmic_ÿ¡
<const AffineComponent*>(

105 &(
Â‘
.
G‘CompÚ’t
(
c
)));

106 ià(
	gac
 =ğ
NULL
) ;

107 cÚ¡ 
NÚlš—rCompÚ’t
 *
	gnc
 = 
dyÇmic_ÿ¡
<const NonlinearComponent*>(

108 &(
Â‘
.
G‘CompÚ’t
(
c
 + 1)));

109 ià(
	gnc
 =ğ
NULL
) ;

111 cÚ¡ 
SoámaxCompÚ’t
 *
	gsc
 = 
dyÇmic_ÿ¡
<const SoftmaxComponent*>(

112 &(
Â‘
.
G‘CompÚ’t
(
c
 + 1)));

113 ià(
	gsc
 !ğ
NULL
) ;

114 
	g¡©s
->
push_back
(
NÃtSts
(
c
, 
cÚfig
.
buck‘_width
));

115 
	g¡©s
->
back
().
AddStsFromNÃt
(
Â‘
);

	@nnet-stats.h

20 #iâdeà
KALDI_NNET2_NNET_STATS_H_


21 
	#KALDI_NNET2_NNET_STATS_H_


	)

23 
	~"Â‘2/Â‘-Â‘.h
"

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

34 
	sNÃtStsCÚfig
 {

35 
Ba£Flßt
 
	gbuck‘_width
;

36 
NÃtStsCÚfig
(): 
buck‘_width
(0.025) { }

38 
Regi¡”
(
O±iÚsItf
 *
İts
) {

39 
İts
->
Regi¡”
("buck‘-width", &
buck‘_width
, "Width of bucket in‡verage-derivative "

44 şas 
	cNÃtSts
 {

45 
	gpublic
:

46 
NÃtSts
(
št32
 
affše_compÚ’t_šdex
, 
Ba£Flßt
 
buck‘_width
):

47 
affše_compÚ’t_šdex_
(
affše_compÚ’t_šdex
),

48 
buck‘_width_
(
buck‘_width
), 
glob®_
(0, -1) { }

52 
AddSts
(
Ba£Flßt
 
avg_d”iv
, Ba£Flßˆ
avg_v®ue
);

54 
AddStsFromNÃt
(cÚ¡ 
NÃt
 &
Â‘
);

56 
PrštSts
(
¡d
::
o¡»am
 &
os
);

57 
	g´iv©e
:

59 
	sStsEËm’t
 {

60 
Ba£Flßt
 
d”iv_begš
;

61 
Ba£Flßt
 
	gd”iv_’d
;

62 
Ba£Flßt
 
	gd”iv_sum
;

63 
Ba£Flßt
 
	gd”iv_sumsq
;

64 
Ba£Flßt
 
	gabs_v®ue_sum
;

66 
Ba£Flßt
 
	gabs_v®ue_sumsq
;

67 
št32
 
	gcouÁ
;

69 
StsEËm’t
(
Ba£Flßt
 
d”iv_begš
,

70 
Ba£Flßt
 
d”iv_’d
):

71 
d”iv_begš
(d”iv_begš), 
d”iv_’d
(d”iv_’d), 
d”iv_sum
(0.0),

72 
d”iv_sumsq
(0.0), 
abs_v®ue_sum
(0.0), 
abs_v®ue_sumsq
(0.0), 
couÁ
(0) { }

73 
AddSts
(
Ba£Flßt
 
avg_d”iv
, Ba£Flßˆ
avg_v®ue
);

75 
PrštSts
(
¡d
::
o¡»am
 &
os
);

77 
št32
 
Buck‘FÜ
(
Ba£Flßt
 
avg_d”iv
);

80 
št32
 
	gaffše_compÚ’t_šdex_
;

82 
Ba£Flßt
 
	gbuck‘_width_
;

84 
	g¡d
::
veùÜ
<
StsEËm’t
> 
buck‘s_
;

85 
StsEËm’t
 
	gglob®_
;

89 
G‘NÃtSts
(cÚ¡ 
NÃtStsCÚfig
 &
cÚfig
,

90 cÚ¡ 
NÃt
 &
Â‘
,

91 
¡d
::
veùÜ
<
NÃtSts
> *
¡©s
);

	@nnet-update-parallel.cc

20 
	~<num”ic
>

21 
	~"Â‘2/Â‘-upd©e-·¿Î–.h
"

22 
	~"Â‘2/Â‘-upd©e.h
"

23 
	~"ut/k®di-th»ad.h
"

25 
Çme¥aû
 
	gk®di
 {

26 
Çme¥aû
 
	gÂ‘2
 {

29 şas 
	cDoBack´İP¬®ËlCÏss
: 
public
 
MuÉiTh»adabË
 {

30 
public
:

33 
DoBack´İP¬®ËlCÏss
(cÚ¡ 
NÃt
 &
Â‘
,

34 
Exam¶esR•os™Üy
 *
»pos™Üy
,

35 *
tÙ_weight_±r
,

36 *
log_´ob_±r
,

37 
NÃt
 *
Â‘_to_upd©e
,

38 
boŞ
 
¡Üe_£·¿‹_g¿d›Ás
):

39 
Â‘_
(
Â‘
), 
»pos™Üy_
(
»pos™Üy
),

40 
Â‘_to_upd©e_
(
Â‘_to_upd©e
),

41 
Â‘_to_upd©e_Üig_
(
Â‘_to_upd©e
),

42 
¡Üe_£·¿‹_g¿d›Ás_
(
¡Üe_£·¿‹_g¿d›Ás
),

43 
tÙ_weight_±r_
(
tÙ_weight_±r
),

44 
log_´ob_±r_
(
log_´ob_±r
),

45 
tÙ_weight_
(0.0),

46 
log_´ob_
(0.0) { }

50 
DoBack´İP¬®ËlCÏss
(cÚ¡ DoBack´İP¬®ËlCÏs &
Ùh”
):

51 
MuÉiTh»adabË
(
Ùh”
),

52 
Â‘_
(
Ùh”
.nnet_),

53 
»pos™Üy_
(
Ùh”
.repository_),

54 
Â‘_to_upd©e_
(
Ùh”
.nnet_to_update_),

55 
Â‘_to_upd©e_Üig_
(
Ùh”
.nnet_to_update_orig_),

56 
¡Üe_£·¿‹_g¿d›Ás_
(
Ùh”
.store_separate_gradients_),

57 
tÙ_weight_±r_
(
Ùh”
.tot_weight_ptr_),

58 
log_´ob_±r_
(
Ùh”
.log_prob_ptr_),

59 
tÙ_weight_
(0),

60 
log_´ob_
(0.0) {

61 ià(
	g¡Üe_£·¿‹_g¿d›Ás_
) {

65 ià(
	gÙh”
.
	gÂ‘_to_upd©e_
 !ğ
NULL
) {

66 
Â‘_to_upd©e_
 = 
Ãw
 
NÃt
(*(
Ùh”
.nnet_to_update_));

72 
	gÂ‘_to_upd©e_
->
S‘Z”o
(
Œue
);

74 
	gÂ‘_to_upd©e_
 = 
NULL
;

79 
İ”©Ü
 () () {

80 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
exam¶es
;

81 
	g»pos™Üy_
->
ProvideExam¶es
(&
exam¶es
)) {

84 
	gtÙ_loglike
;

85 ià(
	gÂ‘_to_upd©e_
 !ğ
NULL
)

86 
tÙ_loglike
 = 
DoBack´İ
(
Â‘_
, 
exam¶es
, 
Â‘_to_upd©e_
);

88 
	gtÙ_loglike
 = 
Compu‹NÃtObjf
(
Â‘_
, 
exam¶es
);

89 
	gtÙ_weight_
 +ğ
TÙ®NÃtT¿ššgWeight
(
exam¶es
);

90 
	glog_´ob_
 +ğ
tÙ_loglike
;

91 
KALDI_VLOG
(4è<< "Th»ad " << 
	gth»ad_id_
 << " saw "

92 << 
	gtÙ_weight_
 << " frames so far (weighted);†ikelihood "

93 << "³¸äamsØç¸i " << (
	glog_´ob_
 / 
	gtÙ_weight_
);

94 
	gexam¶es
.
ş—r
();

98 ~
DoBack´İP¬®ËlCÏss
() {

99 ià(
	gÂ‘_to_upd©e_Üig_
 !ğ
Â‘_to_upd©e_
) {

104 
Â‘_to_upd©e_Üig_
->
AddNÃt
(1.0, *
Â‘_to_upd©e_
);

105 
d–‘e
 
	gÂ‘_to_upd©e_
;

107 *
	glog_´ob_±r_
 +ğ
log_´ob_
;

108 *
	gtÙ_weight_±r_
 +ğ
tÙ_weight_
;

110 
	g´iv©e
:

111 cÚ¡ 
NÃt
 &
Â‘_
;

112 
Exam¶esR•os™Üy
 *
	g»pos™Üy_
;

113 
NÃt
 *
	gÂ‘_to_upd©e_
;

114 
NÃt
 *
	gÂ‘_to_upd©e_Üig_
;

115 
boŞ
 
	g¡Üe_£·¿‹_g¿d›Ás_
;

116 *
	gtÙ_weight_±r_
;

117 *
	glog_´ob_±r_
;

118 
	gtÙ_weight_
;

119 
	glog_´ob_
;

123 #ià
HAVE_CUDA
 == 1

124 
DoBack´İSšgËTh»aded
(cÚ¡ 
NÃt
 &
Â‘
,

125 
št32
 
mšib©ch_size
,

126 
Sequ’tŸlNÃtExam¶eR—d”
 *
exam¶es_»ad”
,

127 *
tÙ_weight_out
,

128 
NÃt
 *
Â‘_to_upd©e
) {

129 
	gªs
 = 0.0, 
	gtÙ_weight
 = 0.0;

130 
KALDI_ASSERT
(
mšib©ch_size
 > 0);

131 !
	gexam¶es_»ad”
->
DÚe
()) {

132 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
egs
;

133 
	gegs
.
»£rve
(
mšib©ch_size
);

134 
	gegs
.
size
(è< 
	gmšib©ch_size
 && 
	gexam¶es_»ad”
->
DÚe
()) {

135 
	gegs
.
push_back
(
exam¶es_»ad”
->
V®ue
());

136 
	gexam¶es_»ad”
->
Next
();

138 
	gªs
 +ğ
DoBack´İ
(
Â‘
, 
egs
, 
Â‘_to_upd©e
);

139 
	gtÙ_weight
 +ğ
TÙ®NÃtT¿ššgWeight
(
egs
);

141 *
	gtÙ_weight_out
 = 
tÙ_weight
;

142  
	gªs
;

147 
DoBack´İP¬®Ël
(cÚ¡ 
NÃt
 &
Â‘
,

148 
št32
 
mšib©ch_size
,

149 
Sequ’tŸlNÃtExam¶eR—d”
 *
exam¶es_»ad”
,

150 *
tÙ_weight
,

151 
NÃt
 *
Â‘_to_upd©e
) {

152 #ià
HAVE_CUDA
 == 1

156 ià(
	gCuDeviû
::
In¡ªtŸ‹
().
EÇbËd
())

157  
DoBack´İSšgËTh»aded
(
Â‘
, 
mšib©ch_size
, 
exam¶es_»ad”
,

158 
tÙ_weight
, 
Â‘_to_upd©e
);

161 
Exam¶esR•os™Üy
 
	g»pos™Üy
;

163 
	gtÙ_log_´ob
 = 0.0;

164 *
	gtÙ_weight
 = 0.0;

168 cÚ¡ 
boŞ
 
	g¡Üe_£·¿‹_g¿d›Ás
 = (
Â‘_to_upd©e
 !ğ&
Â‘
);

170 
DoBack´İP¬®ËlCÏss
 
c
(
Â‘
, &
»pos™Üy
, 
tÙ_weight
,

171 &
tÙ_log_´ob
, 
Â‘_to_upd©e
,

172 
¡Üe_£·¿‹_g¿d›Ás
);

177 
	gMuÉiTh»ad”
<
	gDoBack´İP¬®ËlCÏss
> 
m
(
g_num_th»ads
, 
c
);

179 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
exam¶es
;

180 ; !
	gexam¶es_»ad”
->
DÚe
();ƒxam¶es_»ad”->
Next
()) {

181 
	gexam¶es
.
push_back
(
exam¶es_»ad”
->
V®ue
());

182 ià(
	gexam¶es
.
size
(è=ğ
mšib©ch_size
)

183 
»pos™Üy
.
Acû±Exam¶es
(&
exam¶es
);

185 ià(!
	gexam¶es
.
em±y
())

186 
	g»pos™Üy
.
Acû±Exam¶es
(&
exam¶es
);

192 
	g»pos™Üy
.
Exam¶esDÚe
();

194 
	gKALDI_LOG
 << "Did back´İ oÀ" << *
	gtÙ_weight
 << "ƒxamples,‡verage†og-prob "

195 << "³¸äami " << (
	gtÙ_log_´ob
 / *
	gtÙ_weight
);

196 
	gKALDI_LOG
 << "[this†ine iso be…arsed by‡ script:]†og-prob-per-frame="

197 << (
	gtÙ_log_´ob
 / *
	gtÙ_weight
);

198  
	gtÙ_log_´ob
;

202 
DoBack´İSšgËTh»aded
(cÚ¡ 
NÃt
 &
Â‘
,

203 
št32
 
mšib©ch_size
,

204 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
egs
,

205 *
tÙ_weight
,

206 
NÃt
 *
Â‘_to_upd©e
) {

207 
	gªs
 = 0.0;

208 *
	gtÙ_weight
 = 
TÙ®NÃtT¿ššgWeight
(
egs
);

209 
size_t
 
	gi
 = 0; i < 
	gegs
.
size
(); i +ğ
mšib©ch_size
) {

210 
¡d
::
veùÜ
<
NÃtExam¶e
>::
cÚ¡_™”©Ü
 
’d_™”
 =

211 (
i
 + 
mšib©ch_size
 > 
egs
.
size
(è?ƒgs.
’d
() :

212 
egs
.
begš
(è+ 
i
 + 
mšib©ch_size
);

213 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
this_egs
(
egs
.
begš
(è+ 
i
,

214 
’d_™”
);

215 
	gªs
 +ğ
DoBack´İ
(
Â‘
, 
this_egs
, 
Â‘_to_upd©e
);

217  
	gªs
;

221 
DoBack´İP¬®Ël
(cÚ¡ 
NÃt
 &
Â‘
,

222 
št32
 
mšib©ch_size
,

223 
št32
 
num_th»ads
,

224 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
egs
,

225 *
tÙ_weight
,

226 
NÃt
 *
Â‘_to_upd©e
) {

227 ià(
	gnum_th»ads
 == 1)

228  
DoBack´İSšgËTh»aded
(
Â‘
, 
mšib©ch_size
, 
egs
,

229 
tÙ_weight
, 
Â‘_to_upd©e
);

231 
Exam¶esR•os™Üy
 
	g»pos™Üy
;

233 
	gtÙ_log_´ob
 = 0.0;

234 *
	gtÙ_weight
 = 0;

235 cÚ¡ 
boŞ
 
	g¡Üe_£·¿‹_g¿d›Ás
 = (
Â‘_to_upd©e
 !ğ&
Â‘
);

237 
DoBack´İP¬®ËlCÏss
 
c
(
Â‘
, &
»pos™Üy
, 
tÙ_weight
,

238 &
tÙ_log_´ob
, 
Â‘_to_upd©e
,

239 
¡Üe_£·¿‹_g¿d›Ás
);

244 
	gMuÉiTh»ad”
<
	gDoBack´İP¬®ËlCÏss
> 
m
(
num_th»ads
, 
c
);

246 
št32
 
	gnum_egs
 = 
egs
.
size
();

247 
št32
 
	goff£t
 = 0; off£ˆ< 
	gnum_egs
; off£ˆ+ğ
mšib©ch_size
) {

248 
št32
 
this_mšib©ch_size
 = 
¡d
::
mš
(
mšib©ch_size
, 
num_egs
 - 
off£t
);

251 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
exam¶es
(
egs
.
begš
(è+ 
off£t
,

252 
egs
.
begš
(è+ 
off£t
 + 
this_mšib©ch_size
);

254 
	g»pos™Üy
.
Acû±Exam¶es
(&
exam¶es
);

262 
	g»pos™Üy
.
Exam¶esDÚe
();

264 
KALDI_VLOG
(2è<< "Did back´İ oÀ" << *
	gtÙ_weight
 << "ƒxamples,‡verage†og-prob "

265 << "³¸äami " << (
	gtÙ_log_´ob
 / *
	gtÙ_weight
);

266  
	gtÙ_log_´ob
;

	@nnet-update-parallel.h

20 #iâdeà
KALDI_NNET2_NNET_UPDATE_PARALLEL_H_


21 
	#KALDI_NNET2_NNET_UPDATE_PARALLEL_H_


	)

23 
	~"Â‘2/Â‘-Â‘.h
"

24 
	~"ut/bË-ty³s.h
"

25 
	~"ut/k®di-£m­hÜe.h
"

26 
	~"ut/k®di-th»ad.h
"

27 
	~"™f/İtiÚs-™f.h
"

28 
	~"Â‘2/Â‘-upd©e.h
"

30 
Çme¥aû
 
	gk®di
 {

31 
Çme¥aû
 
	gÂ‘2
 {

48 
DoBack´İP¬®Ël
(cÚ¡ 
NÃt
 &
Â‘
,

49 
št32
 
mšib©ch_size
,

50 
Sequ’tŸlNÃtExam¶eR—d”
 *
exam¶e_»ad”
,

51 *
tÙ_weight
,

52 
NÃt
 *
Â‘_to_upd©e
);

57 
DoBack´İP¬®Ël
(cÚ¡ 
NÃt
 &
Â‘
,

58 
št32
 
mšib©ch_size
,

59 
št32
 
num_th»ads
,

60 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

61 *
num_äames
,

62 
NÃt
 *
Â‘_to_upd©e
);

71 
šlše
 
Compu‹NÃtObjfP¬®Ël
(

72 cÚ¡ 
NÃt
 &
Â‘
,

73 
št32
 
mšib©ch_size
,

74 
št32
 
num_th»ads
,

75 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

76 *
num_äames
) {

77  
DoBack´İP¬®Ël
(
Â‘
, 
mšib©ch_size
, 
num_th»ads
,

78 
exam¶es
, 
num_äames
, 
NULL
);

	@nnet-update.cc

21 
	~"Â‘2/Â‘-upd©e.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

28 
	gNÃtUpd©”
::
NÃtUpd©”
(cÚ¡ 
NÃt
 &
Â‘
,

29 
NÃt
 *
Â‘_to_upd©e
):

30 
Â‘_
(
Â‘
), 
Â‘_to_upd©e_
(
Â‘_to_upd©e
) {

35 
	gNÃtUpd©”
::
FÜm©IÅut
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
) {

37 
fÜw¬d_d©a_
.
»size
(
Â‘_
.
NumCompÚ’ts
() + 1);

38 
	gM©rix
<
	gBa£Flßt
> 
	gšput
;

39 
FÜm©NÃtIÅut
(
Â‘_
, 
d©a
, &
šput
);

40 
	gfÜw¬d_d©a_
[0].
Resize
(0, 0);

41 
	gfÜw¬d_d©a_
[0].
Sw­
(&
šput
);

42 
	gÂ‘_
.
Compu‹ChunkInfo
(1 + 
Â‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
(),

43 
d©a
.
size
(), &
chunk_šfo_out_
);

46 
	gNÃtUpd©”
::
Compu‹FÜMšib©ch
(

47 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

48 *
tÙ_accu¿cy
) {

50 
FÜm©IÅut
(
d©a
);

51 
Prİag©e
();

52 
	gCuM©rix
<
	gBa£Flßt
> 
	gtmp_d”iv
;

53 
	gªs
 = 
Compu‹ObjfAndD”iv
(
d©a
, &
tmp_d”iv
, 
tÙ_accu¿cy
);

54 ià(
	gÂ‘_to_upd©e_
 !ğ
NULL
)

55 
Back´İ
(&
tmp_d”iv
);

57  
	gªs
;

63 
	gNÃtUpd©”
::
Compu‹FÜMšib©ch
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

64 
M©rix
<
Ba£Flßt
> *
fÜm©‹d_d©a
,

65 *
tÙ_accu¿cy
) {

67 
št32
 
	gnum_chunks
 = 
d©a
.
size
();

68 
KALDI_ASSERT
(
fÜm©‹d_d©a
->
NumRows
() ==

69 
num_chunks
 * (1 + 
Â‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
()) &&

70 
fÜm©‹d_d©a
->
NumCŞs
(è=ğ
Â‘_
.
IÅutDim
());

72 
	gfÜw¬d_d©a_
.
»size
(
Â‘_
.
NumCompÚ’ts
() + 1);

76 
	gfÜw¬d_d©a_
[0].
Resize
(0, 0);

77 
	gfÜw¬d_d©a_
[0].
Sw­
(
fÜm©‹d_d©a
);

78 
	gÂ‘_
.
Compu‹ChunkInfo
(1 + 
Â‘_
.
LeáCÚ‹xt
(è+‚Ãt_.
RightCÚ‹xt
(),

79 
d©a
.
size
(), &
chunk_šfo_out_
);

81 
Prİag©e
();

82 
	gCuM©rix
<
	gBa£Flßt
> 
	gtmp_d”iv
;

83 
	gªs
 = 
Compu‹ObjfAndD”iv
(
d©a
, &
tmp_d”iv
, 
tÙ_accu¿cy
);

84 ià(
	gÂ‘_to_upd©e_
 !ğ
NULL
)

85 
Back´İ
(&
tmp_d”iv
);

87  
	gªs
;

91 
	gNÃtUpd©”
::
G‘Ouut
(
CuM©rix
<
Ba£Flßt
> *
ouut
) {

92 
št32
 
num_compÚ’ts
 = 
Â‘_
.
NumCompÚ’ts
();

93 
KALDI_ASSERT
(
fÜw¬d_d©a_
.
size
(è=ğ
Â‘_
.
NumCompÚ’ts
() + 1);

94 *
	gouut
 = 
fÜw¬d_d©a_
[
num_compÚ’ts
];

97 
	gNÃtUpd©”
::
Prİag©e
() {

98 
št32
 
num_times_´š‹d
 = 0;

100 
št32
 
	gnum_compÚ’ts
 = 
Â‘_
.
NumCompÚ’ts
();

101 
št32
 
	gc
 = 0; c < 
	gnum_compÚ’ts
; c++) {

102 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘_
.
G‘CompÚ’t
(
c
);

103 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput
 = 
fÜw¬d_d©a_
[
c
];

104 
	gCuM©rix
<
	gBa£Flßt
> &
	gouut
 = 
fÜw¬d_d©a_
[
c
+1];

107 
	gcompÚ’t
.
Prİag©e
(
chunk_šfo_out_
[
c
], chunk_šfo_out_[c+1], 
šput
, &
ouut
);

110 
boŞ
 
	gÃed_Ï¡_ouut
 =

111 (
c
>0 && 
Â‘_
.
G‘CompÚ’t
(c-1).
Back´İN“dsOuut
()) ||

112 
compÚ’t
.
Back´İN“dsIÅut
();

113 ià(
	gg_k®di_v”bo£_Ëv–
 >ğ3 && 
num_times_´š‹d
 < 100) {

114 
KALDI_VLOG
(3è<< "Stddev oàd©¨fÜ compÚ’ˆ" << 
c


116 << (
T¿ûM©M©
(
fÜw¬d_d©a_
[
c
], fÜw¬d_d©a_[c], 
kT¿ns
) /

117 (
fÜw¬d_d©a_
[
c
].
NumRows
(è* fÜw¬d_d©a_[c].
NumCŞs
()));

118 
	gnum_times_´š‹d
++;

120 ià(!
	gÃed_Ï¡_ouut
)

121 
	gfÜw¬d_d©a_
[
c
].
Resize
(0, 0);

125 
	gNÃtUpd©”
::
Compu‹ObjfAndD”iv
(

126 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

127 
CuM©rix
<
Ba£Flßt
> *
d”iv
,

128 *
tÙ_accu¿cy
) const {

129 
Ba£Flßt
 
	gtÙ_objf
 = 0.0, 
	gtÙ_weight
 = 0.0;

130 
št32
 
	gnum_compÚ’ts
 = 
Â‘_
.
NumCompÚ’ts
();

131 
št32
 
	gnum_chunks
 = 
d©a
.
size
();

132 
	gd”iv
->
Resize
(
num_chunks
, 
Â‘_
.
OuutDim
());

133 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
ouut
(
fÜw¬d_d©a_
[
num_compÚ’ts
]);

134 
KALDI_ASSERT
(
SameDim
(
ouut
, *
d”iv
));

136 
	g¡d
::
veùÜ
<
M©rixEËm’t
<
Ba£Flßt
> > 
sv_Ïb–s
;

137 
	gsv_Ïb–s
.
»£rve
(
num_chunks
);

138 
št32
 
	gm
 = 0; m < 
	gnum_chunks
; m++) {

139 
KALDI_ASSERT
(
d©a
[
m
].
Ïb–s
.
size
() == 1 &&

141 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
št32
,
	gBa£Flßt
> > &
	gÏb–s
 = 
d©a
[
m
].
Ïb–s
[0];

142 
size_t
 
	gi
 = 0; i < 
	gÏb–s
.
size
(); i++) {

143 
KALDI_ASSERT
(
Ïb–s
[
i
].
fœ¡
 < 
Â‘_
.
OuutDim
() &&

145 
	gM©rixEËm’t
<
	gBa£Flßt
> 
	g–em
 = {
m
, 
Ïb–s
[
i
].
fœ¡
,†ab–s[i].
£cÚd
};

146 
	gsv_Ïb–s
.
push_back
(
–em
);

150 ià(
	gtÙ_accu¿cy
 !ğ
NULL
)

151 *
tÙ_accu¿cy
 = 
Compu‹TÙAccu¿cy
(
d©a
);

153 
	gd”iv
->
CompObjfAndD”iv
(
sv_Ïb–s
, 
ouut
, &
tÙ_objf
, &
tÙ_weight
);

155 
KALDI_VLOG
(4è<< "ObjeùivfunùiÚ i " << (
	gtÙ_objf
/
	gtÙ_weight
) << " over "

156 << 
	gtÙ_weight
 << " samples (weighted).";

157  
	gtÙ_objf
;

161 
	gNÃtUpd©”
::
Compu‹TÙAccu¿cy
(

162 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
) const {

163 
Ba£Flßt
 
tÙ_accu¿cy
 = 0.0;

164 
št32
 
	gnum_compÚ’ts
 = 
Â‘_
.
NumCompÚ’ts
();

165 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
ouut
(
fÜw¬d_d©a_
[
num_compÚ’ts
]);

166 
KALDI_ASSERT
(
ouut
.
NumRows
(è=ğ
¡©ic_ÿ¡
<
št32
>(
d©a
.
size
()));

167 
	gCuA¼ay
<
	gšt32
> 
be¡_pdf
(
ouut
.
NumRows
());

168 
	g¡d
::
veùÜ
<
št32
> 
be¡_pdf_ıu
;

170 
	gouut
.
FšdRowMaxId
(&
be¡_pdf
);

171 
	gbe¡_pdf
.
CİyToVec
(&
be¡_pdf_ıu
);

173 
št32
 
	gi
 = 0; i < 
	gouut
.
NumRows
(); i++) {

174 
KALDI_ASSERT
(
d©a
[
i
].
Ïb–s
.
size
() == 1 &&

176 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
št32
,
	gBa£Flßt
> > &
	gÏb–s
 = 
d©a
[
i
].
Ïb–s
[0];

177 
size_t
 
	gj
 = 0; j < 
	gÏb–s
.
size
(); j++) {

178 
št32
 
	g»f_pdf_id
 = 
Ïb–s
[
j
].
fœ¡
,

179 
	ghyp_pdf_id
 = 
be¡_pdf_ıu
[
i
];

180 
Ba£Flßt
 
	gweight
 = 
Ïb–s
[
j
].
£cÚd
;

181 
	gtÙ_accu¿cy
 +ğ
weight
 * (
hyp_pdf_id
 =ğ
»f_pdf_id
 ? 1.0 : 0.0);

184  
	gtÙ_accu¿cy
;

188 
	gNÃtUpd©”
::
Back´İ
(
CuM©rix
<
Ba£Flßt
> *
d”iv
) const {

190 
št32
 
c
 = 
Â‘_
.
NumCompÚ’ts
() - 1;

191 
	gc
 >ğ
Â‘_
.
Fœ¡Upd©abËCompÚ’t
(); c--) {

192 cÚ¡ 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘_
.
G‘CompÚ’t
(
c
);

193 
CompÚ’t
 *
	gcompÚ’t_to_upd©e
 = (
Â‘_to_upd©e_
 =ğ
NULL
 ? NULL :

194 &(
Â‘_to_upd©e_
->
G‘CompÚ’t
(
c
)));

195 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
	gšput
 = 
fÜw¬d_d©a_
[
c
],

196 &
	gouut
 = 
fÜw¬d_d©a_
[
c
+1];

197 
	gCuM©rix
<
	gBa£Flßt
> 
šput_d”iv
(
šput
.
NumRows
(), iÅut.
NumCŞs
());

198 cÚ¡ 
	gCuM©rix
<
	gBa£Flßt
> &
ouut_d”iv
(*
d”iv
);

199 
	gcompÚ’t
.
Back´İ
(
chunk_šfo_out_
[
c
], chunk_šfo_out_[c+1], 
šput
, 
ouut
,

200 
ouut_d”iv
, 
compÚ’t_to_upd©e
,

201 &
šput_d”iv
);

202 
	gšput_d”iv
.
Sw­
(
d”iv
);

207 
FÜm©NÃtIÅut
(cÚ¡ 
NÃt
 &
Â‘
,

208 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

209 
M©rix
<
Ba£Flßt
> *
šput_m©
) {

210 
KALDI_ASSERT
(
d©a
.
size
() > 0);

211 
št32
 
	gnum_¥liû
 = 1 + 
Â‘
.
RightCÚ‹xt
(è+‚Ãt.
LeáCÚ‹xt
();

212 
KALDI_ASSERT
(
d©a
[0].
šput_äames
.
NumRows
(è>ğ
num_¥liû
);

214 
št32
 
	gã©_dim
 = 
d©a
[0].
šput_äames
.
NumCŞs
(),

215 
	g¥k_dim
 = 
d©a
[0].
¥k_šfo
.
Dim
(),

216 
	gtÙ_dim
 = 
ã©_dim
 + 
¥k_dim
;

218 
KALDI_ASSERT
(
tÙ_dim
 =ğ
Â‘
.
IÅutDim
());

219 
KALDI_ASSERT
(
d©a
[0].
Ëá_cÚ‹xt
 >ğ
Â‘
.
LeáCÚ‹xt
());

220 
št32
 
	gignÜe_äames
 = 
d©a
[0].
Ëá_cÚ‹xt
 - 
Â‘
.
LeáCÚ‹xt
();

225 
št32
 
	gnum_chunks
 = 
d©a
.
size
();

227 
	gšput_m©
->
Resize
(
num_¥liû
 * 
num_chunks
,

228 
tÙ_dim
, 
kUndefšed
);

230 
št32
 
	gchunk
 = 0; chunk < 
	gnum_chunks
; chunk++) {

231 
	gSubM©rix
<
	gBa£Flßt
> 
de¡
(*
šput_m©
,

232 
chunk
 * 
num_¥liû
,‚um_splice,

233 0, 
ã©_dim
);

235 
	gM©rix
<
	gBa£Flßt
> 
fuÎ_¤c
(
d©a
[
chunk
].
šput_äames
);

236 
	gSubM©rix
<
	gBa£Flßt
> 
¤c
(
fuÎ_¤c
, 
ignÜe_äames
, 
num_¥liû
, 0, 
ã©_dim
);

238 
	gde¡
.
CİyFromM©
(
¤c
);

239 ià(
	g¥k_dim
 != 0) {

240 
SubM©rix
<
Ba£Flßt
> 
¥k_de¡
(*
šput_m©
,

241 
chunk
 * 
num_¥liû
,‚um_splice,

242 
ã©_dim
, 
¥k_dim
);

243 
	g¥k_de¡
.
CİyRowsFromVec
(
d©a
[
chunk
].
¥k_šfo
);

248 
Ba£Flßt
 
TÙ®NÃtT¿ššgWeight
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
egs
) {

249 
ªs
 = 0.0;

250 
size_t
 
	gi
 = 0; i < 
	gegs
.
size
(); i++)

251 
size_t
 
	gj
 = 0; j < 
	gegs
[
i
].
	gÏb–s
.
size
(); j++)

252 
size_t
 
	gk
 = 0; k < 
	gegs
[
i
].
	gÏb–s
[
j
].
size
(); k++)

253 
	gªs
 +ğ
egs
[
i
].
Ïb–s
[
j
][
k
].
£cÚd
;

254  
	gªs
;

258 
Compu‹NÃtObjf
(cÚ¡ 
NÃt
 &
Â‘
,

259 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

260 *
tÙ_accu¿cy
) {

261 
NÃtUpd©”
 
upd©”
(
Â‘
, 
NULL
);

262  
	gupd©”
.
Compu‹FÜMšib©ch
(
exam¶es
, 
tÙ_accu¿cy
);

265 
DoBack´İ
(cÚ¡ 
NÃt
 &
Â‘
,

266 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

267 
NÃt
 *
Â‘_to_upd©e
,

268 *
tÙ_accu¿cy
) {

269 ià(
	gÂ‘_to_upd©e
 =ğ
NULL
)

270  
Compu‹NÃtObjf
(
Â‘
, 
exam¶es
, 
tÙ_accu¿cy
);

271 
	gŒy
 {

272 
NÃtUpd©”
 
upd©”
(
Â‘
, 
Â‘_to_upd©e
);

273  
	gupd©”
.
Compu‹FÜMšib©ch
(
exam¶es
, 
tÙ_accu¿cy
);

274 } 
ÿtch
 (...) {

275 
	gKALDI_LOG
 << "E¼Ü došg back´İ,‚ÃˆšfØis: " << 
	gÂ‘
.
Info
();

276 
	gthrow
;

281 
DoBack´İ
(cÚ¡ 
NÃt
 &
Â‘
,

282 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

283 
M©rix
<
Ba£Flßt
> *
exam¶es_fÜm©‹d
,

284 
NÃt
 *
Â‘_to_upd©e
,

285 *
tÙ_accu¿cy
) {

286 ià(
	gÂ‘_to_upd©e
 =ğ
NULL
) {

287 
KALDI_WARN
 << "Was‚otƒxpectingo„eachhis code…ath "

289  
Compu‹NÃtObjf
(
Â‘
, 
exam¶es
, 
tÙ_accu¿cy
);

290 } 
	gŒy
 {

291 
NÃtUpd©”
 
upd©”
(
Â‘
, 
Â‘_to_upd©e
);

292  
	gupd©”
.
Compu‹FÜMšib©ch
(
exam¶es
,

293 
exam¶es_fÜm©‹d
,

294 
tÙ_accu¿cy
);

295 } 
ÿtch
 (...) {

296 
	gKALDI_LOG
 << "E¼Ü došg back´İ,‚ÃˆšfØis: " << 
	gÂ‘
.
Info
();

297 
	gthrow
;

302 
Compu‹NÃtG¿d›Á
(

303 cÚ¡ 
NÃt
 &
Â‘
,

304 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

305 
št32
 
b©ch_size
,

306 
NÃt
 *
g¿d›Á
) {

307 
boŞ
 
	gŒ—t_as_g¿d›Á
 = 
Œue
;

308 
	gg¿d›Á
->
S‘Z”o
(
Œ—t_as_g¿d›Á
);

309 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
b©ch
;

310 
	gb©ch
.
»£rve
(
b©ch_size
);

311 
	gtÙ_objf
 = 0.0;

312 
št32
 
	g¡¬t_pos
 = 0;

313 
	g¡¬t_pos
 < 
	g¡©ic_ÿ¡
<
	gšt32
>(
	gv®id©iÚ_£t
.
size
());

314 
	g¡¬t_pos
 +ğ
b©ch_size
) {

315 
b©ch
.
ş—r
();

316 
št32
 
	gi
 = 
¡¬t_pos
;

317 
	gi
 < 
	g¡d
::
mš
(
¡¬t_pos
 + 
b©ch_size
,

318 
¡©ic_ÿ¡
<
št32
>(
v®id©iÚ_£t
.
size
()));

319 
	gi
++) {

320 
	gb©ch
.
push_back
(
v®id©iÚ_£t
[
i
]);

322 
	gtÙ_objf
 +ğ
DoBack´İ
(
Â‘
,

323 
b©ch
,

324 
g¿d›Á
);

326  
	gtÙ_objf
 / 
	gv®id©iÚ_£t
.
size
();

329 
Compu‹NÃtObjf
(

330 cÚ¡ 
NÃt
 &
Â‘
,

331 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

332 
št32
 
b©ch_size
,

333 *
tÙ_accu¿cy
) {

334 
	gtÙ_accu¿cy_tmp
;

335 ià(
	gtÙ_accu¿cy
)

336 *
	gtÙ_accu¿cy
 = 0.0;

337 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
b©ch
;

338 
	gb©ch
.
»£rve
(
b©ch_size
);

339 
	gtÙ_objf
 = 0.0;

340 
št32
 
	g¡¬t_pos
 = 0;

341 
	g¡¬t_pos
 < 
	g¡©ic_ÿ¡
<
	gšt32
>(
	gv®id©iÚ_£t
.
size
());

342 
	g¡¬t_pos
 +ğ
b©ch_size
) {

343 
b©ch
.
ş—r
();

344 
št32
 
	gi
 = 
¡¬t_pos
;

345 
	gi
 < 
	g¡d
::
mš
(
¡¬t_pos
 + 
b©ch_size
,

346 
¡©ic_ÿ¡
<
št32
>(
v®id©iÚ_£t
.
size
()));

347 
	gi
++) {

348 
	gb©ch
.
push_back
(
v®id©iÚ_£t
[
i
]);

350 
	gtÙ_objf
 +ğ
Compu‹NÃtObjf
(
Â‘
, 
b©ch
,

351 
tÙ_accu¿cy
 !ğ
NULL
 ? &
tÙ_accu¿cy_tmp
 : NULL);

352 ià(
	gtÙ_accu¿cy
)

353 *
	gtÙ_accu¿cy
 +ğ
tÙ_accu¿cy_tmp
;

355  
	gtÙ_objf
;

	@nnet-update.h

21 #iâdeà
KALDI_NNET2_NNET_UPDATE_H_


22 
	#KALDI_NNET2_NNET_UPDATE_H_


	)

24 
	~"Â‘2/Â‘-Â‘.h
"

25 
	~"Â‘2/Â‘-exam¶e.h
"

26 
	~"ut/bË-ty³s.h
"

29 
Çme¥aû
 
	gk®di
 {

30 
Çme¥aû
 
	gÂ‘2
 {

39 
şass
 
	gNÃtEn£mbËT¿š”
;

46 şas 
	cNÃtUpd©”
 {

47 
	gpublic
:

52 
NÃtUpd©”
(cÚ¡ 
NÃt
 &
Â‘
,

53 
NÃt
 *
Â‘_to_upd©e
);

58 
Compu‹FÜMšib©ch
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

59 *
tÙ_accu¿cy
);

67 
Compu‹FÜMšib©ch
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

68 
M©rix
<
Ba£Flßt
> *
fÜm©‹d_d©a
,

69 *
tÙ_accu¿cy
);

71 
G‘Ouut
(
CuM©rix
<
Ba£Flßt
> *
ouut
);

72 
	g´Ùeùed
:

74 
Prİag©e
();

78 
FÜm©IÅut
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
);

86 
Compu‹ObjfAndD”iv
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

87 
CuM©rix
<
Ba£Flßt
> *
d”iv
,

88 *
tÙ_accu¿cy
 = 
NULL
) const;

96 
Back´İ
(
CuM©rix
<
Ba£Flßt
> *
d”iv
) const;

98 
ä›nd
 
şass
 
	gNÃtEn£mbËT¿š”
;

99 
	g´iv©e
:

101 
Compu‹TÙAccu¿cy
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
) const;

103 cÚ¡ 
	gNÃt
 &
	gÂ‘_
;

104 
NÃt
 *
	gÂ‘_to_upd©e_
;

105 
št32
 
	gnum_chunks_
;

106 
	g¡d
::
veùÜ
<
ChunkInfo
> 
chunk_šfo_out_
;

108 
	g¡d
::
veùÜ
<
CuM©rix
<
Ba£Flßt
> > 
fÜw¬d_d©a_
;

121 
FÜm©NÃtIÅut
(cÚ¡ 
NÃt
 &
Â‘
,

122 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

123 
M©rix
<
Ba£Flßt
> *
m©
);

135 
DoBack´İ
(cÚ¡ 
NÃt
 &
Â‘
,

136 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

137 
NÃt
 *
Â‘_to_upd©e
,

138 *
tÙ_accu¿cy
 = 
NULL
);

147 
DoBack´İ
(cÚ¡ 
NÃt
 &
Â‘
,

148 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

149 
M©rix
<
Ba£Flßt
> *
exam¶es_fÜm©‹d
,

150 
NÃt
 *
Â‘_to_upd©e
,

151 *
tÙ_accu¿cy
 = 
NULL
);

157 
Ba£Flßt
 
TÙ®NÃtT¿ššgWeight
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
egs
);

163 
Compu‹NÃtObjf
(cÚ¡ 
NÃt
 &
Â‘
,

164 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

165 *
tÙ_accu¿cy
ğ
NULL
);

172 
Compu‹NÃtObjf
(cÚ¡ 
NÃt
 &
Â‘
,

173 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

174 
št32
 
mšib©ch_size
,

175 *
tÙ_accu¿cy
ğ
NULL
);

181 
Compu‹NÃtG¿d›Á
(

182 cÚ¡ 
NÃt
 &
Â‘
,

183 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

184 
št32
 
b©ch_size
,

185 
NÃt
 *
g¿d›Á
);

	@online-nnet2-decodable-test.cc

20 
	~"hmm/Œªs™iÚ-mod–.h
"

21 
	~"Â‘2/Â‘-compÚ’t.h
"

22 
	~"Â‘2/decodabË-am-Â‘.h
"

23 
	~"Â‘2/Úlše-Â‘2-decodabË.h
"

24 
	~"ã©/Úlše-ã©u».h
"

25 
	~"hmm/hmm-‹¡-uts.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

31 
Un™Te¡NÃtDecodabË
() {

32 
	g¡d
::
veùÜ
<
št32
> 
phÚes
;

33 
	gphÚes
.
push_back
(1);

34 
št32
 
	gi
 = 2; i < 20; i++)

35 ià(
¿nd
() % 2 == 0)

36 
phÚes
.
push_back
(
i
);

37 
št32
 
	gN
 = 2 + 
¿nd
() % 2,

38 
	gP
 = 
¿nd
(è% 
N
;

40 
	g¡d
::
veùÜ
<
št32
> 
num_pdf_şas£s
;

42 
CÚ‹xtD•’d’cy
 *
	gùx_d•
 =

43 
G’RªdCÚ‹xtD•’d’cyL¬ge
(
phÚes
, 
N
, 
P
,

44 
Œue
, &
num_pdf_şas£s
);

46 
HmmTİŞogy
 
	gtİo
 = 
G‘DeçuÉTİŞogy
(
phÚes
);

48 
T¿ns™iÚMod–
 
Œªs_mod–
(*
ùx_d•
, 
tİo
);

50 
d–‘e
 
	gùx_d•
;

51 
	gùx_d•
 = 
NULL
;

53 
št32
 
	gšput_dim
 = 40, 
	gouut_dim
 = 
Œªs_mod–
.
NumPdfs
();

54 
NÃt
 *
	gÂ‘
 = 
G’RªdomNÃt
(
šput_dim
, 
ouut_dim
);

56 
AmNÃt
 
am_Â‘
(*
Â‘
);

57 
d–‘e
 
	gÂ‘
;

58 
	gÂ‘
 = 
NULL
;

59 
	gVeùÜ
<
	gBa£Flßt
> 
´iÜs
(
ouut_dim
);

60 
	g´iÜs
.
S‘Rªdn
();

61 
	g´iÜs
.
AµlyExp
();

62 
	g´iÜs
.
SÿË
(1.0 / 
´iÜs
.
Sum
());

64 
	gam_Â‘
.
S‘PriÜs
(
´iÜs
);

66 
DecodabËNÃt2OÆšeO±iÚs
 
	gİts
;

67 
	gİts
.
	gmax_Â‘_b©ch_size
 = 20;

68 
	gİts
.
	gacou¡ic_sÿË
 = 0.1;

70 
	gİts
.
	g·d_šput
 = (
¿nd
() % 2 == 0);

72 
št32
 
	gnum_šput_äames
 = 400;

73 
	gM©rix
<
	gBa£Flßt
> 
šput_ã©s
(
num_šput_äames
, 
šput_dim
);

74 
	gšput_ã©s
.
S‘Rªdn
();

76 
OÆšeM©rixF—tu»
 
m©rix_ã©u»
(
šput_ã©s
);

78 
DecodabËNÃt2OÆše
 
Úlše_decodabË
(
am_Â‘
, 
Œªs_mod–
,

79 
İts
, &
m©rix_ã©u»
);

81 
DecodabËAmNÃt
 
ofæše_decodabË
(
Œªs_mod–
, 
am_Â‘
,

82 
CuM©rix
<
Ba£Flßt
>(
šput_ã©s
),

83 
İts
.
·d_šput
,

84 
İts
.
acou¡ic_sÿË
);

86 
KALDI_ASSERT
(
Úlše_decodabË
.
NumF¿mesR—dy
() ==

87 
ofæše_decodabË
.
NumF¿mesR—dy
());

88 
št32
 
	gnum_äames
 = 
Úlše_decodabË
.
NumF¿mesR—dy
(),

89 
	gnum_tids
 = 
Œªs_mod–
.
NumT¿ns™iÚIds
();

91 
št32
 
	gi
 = 0; i < 50; i++) {

93 
št32
 
	gt
 = 
¿nd
(è% 
num_äames
, 
	gtid
 = 1 +„ªd(è% 
num_tids
;

94 
Ba£Flßt
 
	gl1
 = 
Úlše_decodabË
.
LogLik–ihood
(
t
, 
tid
),

95 
	gl2
 = 
ofæše_decodabË
.
LogLik–ihood
(
t
, 
tid
);

96 
KALDI_ASSERT
(
AµroxEqu®
(
l1
, 
l2
));

104 
	$maš
() {

105 
usšg
 
Çme¥aû
 
k®di
;

106 
usšg
 
Çme¥aû
 
k®di
::
Â‘2
;

107 
usšg
 
k®di
::
št32
;

109 
št32
 
i
 = 0; i < 3; i++)

110 
	`Un™Te¡NÃtDecodabË
();

112 
	}
}

	@online-nnet2-decodable.cc

20 
	~"Â‘2/Úlše-Â‘2-decodabË.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

25 
	gDecodabËNÃt2OÆše
::
DecodabËNÃt2OÆše
(

26 cÚ¡ 
AmNÃt
 &
Â‘
,

27 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

28 cÚ¡ 
DecodabËNÃt2OÆšeO±iÚs
 &
İts
,

29 
OÆšeF—tu»IÁ”çû
 *
šput_ã©s
):

30 
ã©u»s_
(
šput_ã©s
),

31 
Â‘_
(
Â‘
),

32 
Œªs_mod–_
(
Œªs_mod–
),

33 
İts_
(
İts
),

34 
ã©_dim_
(
šput_ã©s
->
Dim
()),

35 
Ëá_cÚ‹xt_
(
Â‘
.
G‘NÃt
().
LeáCÚ‹xt
()),

36 
right_cÚ‹xt_
(
Â‘
.
G‘NÃt
().
RightCÚ‹xt
()),

37 
num_pdfs_
(
Â‘
.
G‘NÃt
().
OuutDim
()),

38 
begš_äame_
(-1) {

39 
KALDI_ASSERT
(
İts_
.
max_Â‘_b©ch_size
 > 0);

40 
	glog_´iÜs_
 = 
Â‘_
.
PriÜs
();

41 
KALDI_ASSERT
(
log_´iÜs_
.
Dim
(è=ğ
Œªs_mod–_
.
NumPdfs
() &&

44 
	glog_´iÜs_
.
AµlyLog
();

49 
Ba£Flßt
 
	gDecodabËNÃt2OÆše
::
LogLik–ihood
(
št32
 
äame
, iÁ32 
šdex
) {

50 
Compu‹FÜF¿me
(
äame
);

51 
št32
 
	gpdf_id
 = 
Œªs_mod–_
.
T¿ns™iÚIdToPdf
(
šdex
);

52 
KALDI_ASSERT
(
äame
 >ğ
begš_äame_
 &&

53 
äame
 < 
begš_äame_
 + 
sÿËd_loglikes_
.
NumRows
());

54  
sÿËd_loglikes_
(
äame
 - 
begš_äame_
, 
pdf_id
);

58 
boŞ
 
	gDecodabËNÃt2OÆše
::
IsLa¡F¿me
(
št32
 
äame
) const {

59 ià(
İts_
.
·d_šput
) {

60  
ã©u»s_
->
IsLa¡F¿me
(
äame
);

62  
	gã©u»s_
->
IsLa¡F¿me
(
äame
 + 
Ëá_cÚ‹xt_
 + 
right_cÚ‹xt_
);

66 
št32
 
	gDecodabËNÃt2OÆše
::
NumF¿mesR—dy
() const {

67 
št32
 
ã©u»s_»ady
 = 
ã©u»s_
->
NumF¿mesR—dy
();

68 ià(
	gã©u»s_»ady
 == 0)

70 
boŞ
 
	gšput_fšished
 = 
ã©u»s_
->
IsLa¡F¿me
(
ã©u»s_»ady
 - 1);

71 ià(
	gİts_
.
	g·d_šput
) {

74 ià(
	gšput_fšished
è 
	gã©u»s_»ady
;

75  
	g¡d
::
max
<
št32
>(0, 
	gã©u»s_»ady
 - 
	gright_cÚ‹xt_
);

77  
	g¡d
::
max
<
št32
>(0, 
	gã©u»s_»ady
 - 
	gright_cÚ‹xt_
 - 
	gËá_cÚ‹xt_
);

81 
	gDecodabËNÃt2OÆše
::
Compu‹FÜF¿me
(
št32
 
äame
) {

82 
št32
 
ã©u»s_»ady
 = 
ã©u»s_
->
NumF¿mesR—dy
();

83 
boŞ
 
	gšput_fšished
 = 
ã©u»s_
->
IsLa¡F¿me
(
ã©u»s_»ady
 - 1);

84 
KALDI_ASSERT
(
äame
 >= 0);

85 ià(
	gäame
 >ğ
begš_äame_
 &&

86 
äame
 < 
begš_äame_
 + 
sÿËd_loglikes_
.
NumRows
())

88 
KALDI_ASSERT
(
äame
 < 
NumF¿mesR—dy
());

90 
št32
 
	gšput_äame_begš
;

91 ià(
	gİts_
.
	g·d_šput
)

92 
	gšput_äame_begš
 = 
äame
 - 
Ëá_cÚ‹xt_
;

94 
	gšput_äame_begš
 = 
äame
;

95 
št32
 
	gmax_possibË_šput_äame_’d
 = 
ã©u»s_»ady
;

96 ià(
	gšput_fšished
 && 
	gİts_
.
	g·d_šput
)

97 
	gmax_possibË_šput_äame_’d
 +ğ
right_cÚ‹xt_
;

98 
št32
 
	gšput_äame_’d
 = 
¡d
::
mš
<št32>(
max_possibË_šput_äame_’d
,

99 
	gšput_äame_begš
 +

100 
	gËá_cÚ‹xt_
 + 
	gright_cÚ‹xt_
 +

101 
	gİts_
.
	gmax_Â‘_b©ch_size
);

102 
KALDI_ASSERT
(
šput_äame_’d
 > 
šput_äame_begš
);

103 
	gM©rix
<
	gBa£Flßt
> 
ã©u»s
(
šput_äame_’d
 - 
šput_äame_begš
,

104 
ã©_dim_
);

105 
št32
 
	gt
 = 
šput_äame_begš
; < 
	gšput_äame_’d
;++) {

106 
	gSubVeùÜ
<
	gBa£Flßt
> 
row
(
ã©u»s
, 
t
 - 
šput_äame_begš
);

107 
št32
 
	gt_modif›d
 = 
t
;

109 ià(
	gt_modif›d
 < 0)

110 
	gt_modif›d
 = 0;

111 ià(
	gt_modif›d
 >ğ
ã©u»s_»ady
)

112 
t_modif›d
 = 
ã©u»s_»ady
 - 1;

113 
	gã©u»s_
->
G‘F¿me
(
t_modif›d
, &
row
);

115 
	gCuM©rix
<
	gBa£Flßt
> 
	gcu_ã©u»s
;

116 
	gcu_ã©u»s
.
Sw­
(&
ã©u»s
);

119 
št32
 
	gnum_äames_out
 = 
šput_äame_’d
 - 
šput_äame_begš
 -

120 
Ëá_cÚ‹xt_
 - 
right_cÚ‹xt_
;

122 
	gCuM©rix
<
	gBa£Flßt
> 
cu_po¡”iÜs
(
num_äames_out
, 
num_pdfs_
);

126 
NÃtComputiÚ
(
Â‘_
.
G‘NÃt
(), 
cu_ã©u»s
,

127 
çl£
, &
cu_po¡”iÜs
);

129 
	gcu_po¡”iÜs
.
AµlyFloÜ
(1.0e-20);

130 
	gcu_po¡”iÜs
.
AµlyLog
();

132 
	gcu_po¡”iÜs
.
AddVecToRows
(-1.0, 
log_´iÜs_
);

134 
	gcu_po¡”iÜs
.
SÿË
(
İts_
.
acou¡ic_sÿË
);

138 
	gsÿËd_loglikes_
.
Resize
(0, 0);

139 
	gcu_po¡”iÜs
.
Sw­
(&
sÿËd_loglikes_
);

141 
	gbegš_äame_
 = 
äame
;

	@online-nnet2-decodable.h

21 #iâdeà
KALDI_NNET2_ONLINE_NNET2_DECODABLE_H_


22 
	#KALDI_NNET2_ONLINE_NNET2_DECODABLE_H_


	)

24 
	~"™f/Úlše-ã©u»-™f.h
"

25 
	~"™f/decodabË-™f.h
"

26 
	~"Â‘2/am-Â‘.h
"

27 
	~"Â‘2/Â‘-compu‹.h
"

28 
	~"hmm/Œªs™iÚ-mod–.h
"

30 
Çme¥aû
 
	gk®di
 {

31 
Çme¥aû
 
	gÂ‘2
 {

37 
	sDecodabËNÃt2OÆšeO±iÚs
 {

38 
Ba£Flßt
 
	gacou¡ic_sÿË
;

39 
boŞ
 
	g·d_šput
;

40 
št32
 
	gmax_Â‘_b©ch_size
;

42 
DecodabËNÃt2OÆšeO±iÚs
():

43 
acou¡ic_sÿË
(0.1),

44 
·d_šput
(
Œue
),

45 
max_Â‘_b©ch_size
(256) { }

47 
Regi¡”
(
O±iÚsItf
 *
İts
) {

48 
	gİts
->
Regi¡”
("acou¡ic-sÿË", &
acou¡ic_sÿË
,

50 
	gİts
->
Regi¡”
("·d-šput", &
·d_šput
,

53 
	gİts
->
Regi¡”
("max-Â‘-b©ch-size", &
max_Â‘_b©ch_size
,

68 şas 
	cDecodabËNÃt2OÆše
: 
public
 
DecodabËIÁ”çû
 {

69 
public
:

70 
DecodabËNÃt2OÆše
(cÚ¡ 
AmNÃt
 &
Â‘
,

71 cÚ¡ 
T¿ns™iÚMod–
 &
Œªs_mod–
,

72 cÚ¡ 
DecodabËNÃt2OÆšeO±iÚs
 &
İts
,

73 
OÆšeF—tu»IÁ”çû
 *
šput_ã©s
);

77 
vœtu®
 
Ba£Flßt
 
LogLik–ihood
(
št32
 
äame
, iÁ32 
šdex
);

79 
vœtu®
 
boŞ
 
IsLa¡F¿me
(
št32
 
äame
) const;

81 
vœtu®
 
št32
 
NumF¿mesR—dy
() const;

84 
vœtu®
 
št32
 
NumIndiûs
(ècÚ¡ {  
	gŒªs_mod–_
.
NumT¿ns™iÚIds
(); }

86 
	g´iv©e
:

90 
Compu‹FÜF¿me
(
št32
 
äame
);

92 
OÆšeF—tu»IÁ”çû
 *
	gã©u»s_
;

93 cÚ¡ 
	gAmNÃt
 &
	gÂ‘_
;

94 cÚ¡ 
	gT¿ns™iÚMod–
 &
	gŒªs_mod–_
;

95 
DecodabËNÃt2OÆšeO±iÚs
 
	gİts_
;

96 
	gCuVeùÜ
<
	gBa£Flßt
> 
	glog_´iÜs_
;

97 
št32
 
	gã©_dim_
;

98 
št32
 
	gËá_cÚ‹xt_
;

99 
št32
 
	gright_cÚ‹xt_
;

100 
št32
 
	gnum_pdfs_
;

103 
št32
 
	gbegš_äame_
;

114 
	gM©rix
<
	gBa£Flßt
> 
	gsÿËd_loglikes_
;

116 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
DecodabËNÃt2OÆše
);

	@rescale-nnet.cc

20 
	~"Â‘2/»sÿË-Â‘.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

26 şas 
	cNÃtResÿËr
 {

27 
	gpublic
:

28 
NÃtResÿËr
(cÚ¡ 
NÃtResÿËCÚfig
 &
cÚfig
,

29 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

30 
NÃt
 *
Â‘
):

31 
cÚfig_
(
cÚfig
), 
exam¶es_
(
exam¶es
), 
Â‘_
(
Â‘
) {}

33 
ResÿË
();

35 
	g´iv©e
:

37 
FÜm©IÅut
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

38 
CuM©rix
<
Ba£Flßt
> *
šput
);

39 
ResÿËCompÚ’t
(
št32
 
c
, iÁ32 
num_chunks
,

40 
CuM©rixBa£
<
Ba£Flßt
> *
cur_d©a_š
,

41 
CuM©rix
<
Ba£Flßt
> *
Ãxt_d©a
);

43 
Compu‹R–evªtIndexes
();

45 
Ba£Flßt
 
G‘T¬g‘AvgD”iv
(
št32
 
c
);

47 cÚ¡ 
	gNÃtResÿËCÚfig
 &
	gcÚfig_
;

48 cÚ¡ 
	g¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es_
;

49 
NÃt
 *
	gÂ‘_
;

50 
	g¡d
::
veùÜ
 <
ChunkInfo
> 
chunk_šfo_out_
;

51 
	g¡d
::
£t
<
št32
> 
»Ëvªt_šdexes_
;

56 
	gNÃtResÿËr
::
FÜm©IÅut
(cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
d©a
,

57 
CuM©rix
<
Ba£Flßt
> *
šput
) {

58 
KALDI_ASSERT
(
d©a
.
size
() > 0);

59 
št32
 
	gnum_¥liû
 = 
Â‘_
->
LeáCÚ‹xt
(è+ 1 +‚Ãt_->
RightCÚ‹xt
();

60 
KALDI_ASSERT
(
d©a
[0].
šput_äames
.
NumRows
(è=ğ
num_¥liû
);

62 
št32
 
	gã©_dim
 = 
d©a
[0].
šput_äames
.
NumCŞs
(),

63 
	g¥k_dim
 = 
d©a
[0].
¥k_šfo
.
Dim
(),

64 
	gtÙ_dim
 = 
ã©_dim
 + 
¥k_dim
;

66 
KALDI_ASSERT
(
tÙ_dim
 =ğ
Â‘_
->
IÅutDim
());

67 
št32
 
	gnum_chunks
 = 
d©a
.
size
();

69 
	gšput
->
Resize
(
num_¥liû
 * 
num_chunks
,

70 
tÙ_dim
);

71 
št32
 
	gchunk
 = 0; chunk < 
	gnum_chunks
; chunk++) {

72 
	gCuSubM©rix
<
	gBa£Flßt
> 
de¡
(*
šput
,

73 
chunk
 * 
num_¥liû
,‚um_splice,

74 0, 
ã©_dim
);

75 
	gM©rix
<
	gBa£Flßt
> 
¤c
(
d©a
[
chunk
].
šput_äames
);

76 
	gde¡
.
CİyFromM©
(
¤c
);

77 ià(
	g¥k_dim
 != 0) {

78 
CuSubM©rix
<
Ba£Flßt
> 
¥k_de¡
(*
šput
,

79 
chunk
 * 
num_¥liû
,‚um_splice,

80 
ã©_dim
, 
¥k_dim
);

81 
	g¥k_de¡
.
CİyRowsFromVec
(
d©a
[
chunk
].
¥k_šfo
);

85 
	gÂ‘_
->
Compu‹ChunkInfo
(
num_¥liû
, 
num_chunks
, &
chunk_šfo_out_
);

89 
	gNÃtResÿËr
::
Compu‹R–evªtIndexes
() {

90 
št32
 
c
 = 0; 
	gc
 + 1 < 
	gÂ‘_
->
NumCompÚ’ts
(); c++)

91 ià(
	gdyÇmic_ÿ¡
<
	gAffšeCompÚ’t
*>(&
	gÂ‘_
->
G‘CompÚ’t
(
c
)è!ğ
NULL
 &&

92 (
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&
Â‘_
->
G‘CompÚ’t
(
c
+1)è!ğ
NULL
 &&

93 
dyÇmic_ÿ¡
<
SoámaxCompÚ’t
*>(&
Â‘_
->
G‘CompÚ’t
(
c
+1)è=ğ
NULL
))

94 
»Ëvªt_šdexes_
.
š£¹
(
c
);

98 
Ba£Flßt
 
	gNÃtResÿËr
::
G‘T¬g‘AvgD”iv
(
št32
 
c
) {

99 
KALDI_ASSERT
(
»Ëvªt_šdexes_
.
couÁ
(
c
) == 1);

100 
Ba£Flßt
 
	gçùÜ
;

101 ià(
	gdyÇmic_ÿ¡
<
	gSigmoidCompÚ’t
*>(&(
	gÂ‘_
->
G‘CompÚ’t
(
c
 + 1))è!ğ
NULL
)

102 
çùÜ
 = 0.25;

103 ià(
	gdyÇmic_ÿ¡
<
	gTªhCompÚ’t
*>(&(
	gÂ‘_
->
G‘CompÚ’t
(
c
 + 1))è!ğ
NULL
)

104 
çùÜ
 = 1.0;

106 
	gKALDI_ERR
 << "Thi ty³ oànÚlš—¸compÚ’ˆi nÙ hªdËd: index " << 
	gc
;

108 
št32
 
	gÏ¡_c
 = *
¡d
::
max_–em’t
(
»Ëvªt_šdexes_
.
begš
(),„–evªt_šdexes_.
’d
()),

109 
	gfœ¡_c
 = *
¡d
::
mš_–em’t
(
»Ëvªt_šdexes_
.
begš
(),„–evªt_šdexes_.
’d
());

110 ià(
	gc
 =ğ
fœ¡_c
)

111  
çùÜ
 * 
cÚfig_
.
rg‘_fœ¡_Ïy”_avg_d”iv
;

112 ià(
	gc
 =ğ
Ï¡_c
)

113  
çùÜ
 * 
cÚfig_
.
rg‘_Ï¡_Ïy”_avg_d”iv
;

115  
çùÜ
 * 
	gcÚfig_
.
	grg‘_avg_d”iv
;

121 
	gNÃtResÿËr
::
ResÿËCompÚ’t
(

122 
št32
 
c
,

123 
št32
 
num_chunks
,

124 
CuM©rixBa£
<
Ba£Flßt
> *
cur_d©a_š
,

125 
CuM©rix
<
Ba£Flßt
> *
Ãxt_d©a
) {

126 
št32
 
	grows
 = 
cur_d©a_š
->
NumRows
(), 
	gcŞs
 = cur_d©a_š->
NumCŞs
();

128 ià(
	gdyÇmic_ÿ¡
<
	gSigmoidCompÚ’t
*>(&(
	gÂ‘_
->
G‘CompÚ’t
(
c
 + 1))è=ğ
NULL
 &&

129 
dyÇmic_ÿ¡
<
TªhCompÚ’t
*>(&(
Â‘_
->
G‘CompÚ’t
(
c
 + 1))è=ğ
NULL
)

130 
KALDI_ERR
 << "Thi ty³ oànÚlš—¸compÚ’ˆi nÙ hªdËd: index " << 
c
;

131 
KALDI_ASSERT
(
chunk_šfo_out_
[0].
NumChunks
(è=ğ
num_chunks
);

136 
	gNÚlš—rCompÚ’t
 &
	gnc
 =

137 *(
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
Â‘_
->
G‘CompÚ’t
(
c
 + 1))));

138 
ChunkInfo
 
	gš_šfo
, 
	gout_šfo
;

139 
	gš_šfo
 = 
chunk_šfo_out_
[
c
+1];

140 
	gout_šfo
 = 
chunk_šfo_out_
[
c
+2];

142 
Ba£Flßt
 
	gÜig_avg_d”iv
, 
	grg‘_avg_d”iv
 = 
G‘T¬g‘AvgD”iv
(
c
);

143 
Ba£Flßt
 
	gcur_sÿlšg
 = 1.0;

144 
št32
 
	gnum_™”s
 = 10;

146 
	gCuM©rix
<
	gBa£Flßt
> 
cur_d©a
(*
cur_d©a_š
),

147 
Úes
(
rows
, 
cŞs
), 
š_d”iv
(rows, cols);

149 
	gÚes
.
S‘
(1.0);

150 
	gnc
.
Prİag©e
(
š_šfo
, 
out_šfo
, 
cur_d©a
, 
Ãxt_d©a
);

151 
	gnc
.
Back´İ
(
š_šfo
, 
out_šfo
, 
cur_d©a
, *
Ãxt_d©a
, 
Úes
, 
NULL
, &
š_d”iv
);

152 
Ba£Flßt
 
	gcur_avg_d”iv
;

153 
	gcur_avg_d”iv
 = 
š_d”iv
.
Sum
(è/ (
rows
 * 
cŞs
);

154 
	gÜig_avg_d”iv
 = 
cur_avg_d”iv
;

155 
št32
 
	g™”
 = 0; i‹¸< 
	gnum_™”s
; iter++) {

158 
	gcur_d©a
.
CİyFromM©
(*
cur_d©a_š
);

159 
	gcur_d©a
.
SÿË
(
cur_sÿlšg
 + 
cÚfig_
.
d–
);

160 
	gnc
.
Prİag©e
(
š_šfo
, 
out_šfo
, 
cur_d©a
, 
Ãxt_d©a
);

161 
	gnc
.
Back´İ
(
š_šfo
, 
out_šfo
, 
cur_d©a
, *
Ãxt_d©a
, 
Úes
, 
NULL
, &
š_d”iv
);

162 
Ba£Flßt
 
	gÃxt_avg_d”iv
 = 
š_d”iv
.
Sum
(è/ (
rows
 * 
cŞs
);

163 
KALDI_ASSERT
(
Ãxt_avg_d”iv
 < 
cur_avg_d”iv
);

166 
Ba£Flßt
 
	gg¿d›Á
 = (
Ãxt_avg_d”iv
 - 
cur_avg_d”iv
è/ 
cÚfig_
.
d–
;

167 
KALDI_ASSERT
(
g¿d›Á
 < 0.0);

168 
Ba£Flßt
 
	g´İo£d_chªge
 = (
rg‘_avg_d”iv
 - 
cur_avg_d”iv
è/ 
g¿d›Á
;

169 
KALDI_VLOG
(2è<< "cur_avg_d”iv = " << 
	gcur_avg_d”iv
 << ",arget_avg_deriv = "

170 << 
	grg‘_avg_d”iv
 << ", g¿d›Á = " << 
	gg¿d›Á


171 << ",…rİo£d_chªg" << 
	g´İo£d_chªge
;

173 ià(
çbs
(
´İo£d_chªge
 / 
cur_sÿlšg
è> 
	gcÚfig_
.
	gmax_chªge
)

174 
	g´İo£d_chªge
 = 
cur_sÿlšg
 * 
cÚfig_
.
max_chªge
 *

175 (
´İo£d_chªge
 > 0.0 ? 1.0 : -1.0);

176 
	gcur_sÿlšg
 +ğ
´İo£d_chªge
;

178 
	gcur_d©a
.
CİyFromM©
(*
cur_d©a_š
);

179 
	gcur_d©a
.
SÿË
(
cur_sÿlšg
);

180 
	gnc
.
Prİag©e
(
š_šfo
, 
out_šfo
, 
cur_d©a
, 
Ãxt_d©a
);

181 
	gnc
.
Back´İ
(
š_šfo
, 
out_šfo
, 
cur_d©a
, *
Ãxt_d©a
, 
Úes
, 
NULL
, &
š_d”iv
);

182 
	gcur_avg_d”iv
 = 
š_d”iv
.
Sum
(è/ (
rows
 * 
cŞs
);

183 ià(
çbs
(
´İo£d_chªge
è< 
	gcÚfig_
.
	gmš_chªge
) ;

186 
Upd©abËCompÚ’t
 *
	guc
 = 
dyÇmic_ÿ¡
<UpdatableComponent*>(

187 &
Â‘_
->
G‘CompÚ’t
(
c
));

188 
KALDI_ASSERT
(
uc
 !ğ
NULL
);

189 
	guc
->
SÿË
(
cur_sÿlšg
);

192 
	gKALDI_LOG
 << "FÜ compÚ’ˆ" << 
	gc
 << ", scaling…arameters by "

193 << 
	gcur_sÿlšg
 << ";‡verage "

194 << "d”iv©ivchªged from " << 
	gÜig_avg_d”iv
 << "o "

195 << 
	gcur_avg_d”iv
 << ";¬g‘ wa " << 
	grg‘_avg_d”iv
;

200 
	gNÃtResÿËr
::
ResÿË
() {

201 
Compu‹R–evªtIndexes
();

202 
	gCuM©rix
<
	gBa£Flßt
> 
	gcur_d©a
, 
	gÃxt_d©a
;

203 
FÜm©IÅut
(
exam¶es_
, &
cur_d©a
);

204 
št32
 
	gnum_chunks
 = 
exam¶es_
.
size
();

205 
št32
 
	gc
 = 0; c < 
	gÂ‘_
->
NumCompÚ’ts
(); c++) {

206 
	gCompÚ’t
 &
	gcompÚ’t
 = 
Â‘_
->
G‘CompÚ’t
(
c
);

207 ià(
	g»Ëvªt_šdexes_
.
couÁ
(
c
 - 1) == 1) {

210 
ResÿËCompÚ’t
(
c
 - 1, 
num_chunks
, &
cur_d©a
, &
Ãxt_d©a
);

212 
	gcompÚ’t
.
Prİag©e
(
chunk_šfo_out_
[
c
], chunk_šfo_out_[c+1], 
cur_d©a
, &
Ãxt_d©a
);

214 
	gcur_d©a
.
Sw­
(&
Ãxt_d©a
);

218 
ResÿËNÃt
(cÚ¡ 
NÃtResÿËCÚfig
 &
»sÿË_cÚfig
,

219 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

220 
NÃt
 *
Â‘
) {

221 
NÃtResÿËr
 
»sÿËr
(
»sÿË_cÚfig
, 
exam¶es
, 
Â‘
);

222 
	g»sÿËr
.
ResÿË
();

	@rescale-nnet.h

20 #iâdeà
KALDI_NNET2_RESCALE_NNET_H_


21 
	#KALDI_NNET2_RESCALE_NNET_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"™f/İtiÚs-™f.h
"

32 
Çme¥aû
 
	gk®di
 {

33 
Çme¥aû
 
	gÂ‘2
 {

36 
	sNÃtResÿËCÚfig
 {

37 
Ba£Flßt
 
	grg‘_avg_d”iv
;

38 
Ba£Flßt
 
	grg‘_fœ¡_Ïy”_avg_d”iv
;

39 
Ba£Flßt
 
	grg‘_Ï¡_Ïy”_avg_d”iv
;

43 
Ba£Flßt
 
	gnum_™”s
;

44 
Ba£Flßt
 
	gd–
;

45 
Ba£Flßt
 
	gmax_chªge
;

47 
Ba£Flßt
 
	gmš_chªge
;

50 
NÃtResÿËCÚfig
(): 
rg‘_avg_d”iv
(0.2),

51 
rg‘_fœ¡_Ïy”_avg_d”iv
(0.3),

52 
rg‘_Ï¡_Ïy”_avg_d”iv
(0.1),

53 
num_™”s
(10),

54 
d–
(0.01),

55 
max_chªge
(0.2), 
mš_chªge
(1.0e-05) { }

57 
Regi¡”
(
O±iÚsItf
 *
İts
) {

58 
	gİts
->
Regi¡”
("rg‘-avg-d”iv", &
rg‘_avg_d”iv
, "Target‡verage derivative "

61 
	gİts
->
Regi¡”
("rg‘-fœ¡-Ïy”-avg-d”iv", &
rg‘_fœ¡_Ïy”_avg_d”iv
,

64 
	gİts
->
Regi¡”
("rg‘-Ï¡-Ïy”-avg-d”iv", &
rg‘_Ï¡_Ïy”_avg_d”iv
,

71 
ResÿËNÃt
(cÚ¡ 
NÃtResÿËCÚfig
 &
»sÿË_cÚfig
,

72 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
exam¶es
,

73 
NÃt
 *
Â‘
);

	@shrink-nnet.cc

20 
	~"Â‘2/shršk-Â‘.h
"

22 
Çme¥aû
 
	gk®di
 {

23 
Çme¥aû
 
	gÂ‘2
 {

25 
Ba£Flßt
 
Compu‹ObjfAndG¿d›Á
(

26 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

27 cÚ¡ 
VeùÜ
<> &
log_sÿË_·¿ms
,

28 cÚ¡ 
NÃt
 &
Â‘
,

29 
VeùÜ
<> *
g¿d›Á
) {

30 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË_·¿ms
(
log_sÿË_·¿ms
);

31 
	gsÿË_·¿ms
.
AµlyExp
();

32 
NÃt
 
Â‘_sÿËd
(
Â‘
);

33 
	gÂ‘_sÿËd
.
SÿËCompÚ’ts
(
sÿË_·¿ms
);

35 
NÃt
 
Â‘_g¿d›Á
(
Â‘
);

36 
boŞ
 
	gis_g¿d›Á
 = 
Œue
;

37 
	gÂ‘_g¿d›Á
.
S‘Z”o
(
is_g¿d›Á
);

40 
št32
 
	gb©ch_size
 = 1024;

41 
Ba£Flßt
 
	gªs
 = 
Compu‹NÃtG¿d›Á
(
Â‘_sÿËd
,

42 
v®id©iÚ_£t
,

43 
b©ch_size
,

44 &
Â‘_g¿d›Á
);

46 
Ba£Flßt
 
	gtÙ_couÁ
 = 
v®id©iÚ_£t
.
size
();

47 
št32
 
	gi
 = 0;

48 
št32
 
	gj
 = 0; j < 
	gÂ‘_sÿËd
.
NumCompÚ’ts
(); j++) {

49 cÚ¡ 
Upd©abËCompÚ’t
 *
	guc
 =

50 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘
.
G‘CompÚ’t
(
j
))),

51 *
	guc_g¿d›Á
 =

52 
dyÇmic_ÿ¡
<cÚ¡ 
Upd©abËCompÚ’t
*>(&(
Â‘_g¿d›Á
.
G‘CompÚ’t
(
j
)));

53 ià(
	guc
 !ğ
NULL
) {

54 
Ba£Flßt
 
dÙ´od
 = 
uc
->
DÙProduù
(*
uc_g¿d›Á
è/ 
tÙ_couÁ
;

55 (*
	gg¿d›Á
)(
	gi
èğ
dÙ´od
 * 
sÿË_·¿ms
(
i
);

58 
	gi
++;

61 
KALDI_ASSERT
(
i
 =ğ
log_sÿË_·¿ms
.
Dim
());

62  
	gªs
;

66 
ShrškNÃt
(cÚ¡ 
NÃtShrškCÚfig
 &
shršk_cÚfig
,

67 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

68 
NÃt
 *
Â‘
) {

70 
št32
 
	gdim
 = 
Â‘
->
NumUpd©abËCompÚ’ts
();

71 
KALDI_ASSERT
(
dim
 > 0);

72 
	gVeùÜ
<> 
log_sÿË
(
dim
), 
g¿d›Á
(dim);

75 
	gobjf
, 
	gš™Ÿl_objf
;

78 
LbfgsO±iÚs
 
	glbfgs_İtiÚs
;

79 
	glbfgs_İtiÚs
.
	gmšimize
 = 
çl£
;

80 
	glbfgs_İtiÚs
.
	gm
 = 
dim
;

82 
	glbfgs_İtiÚs
.
	gfœ¡_¡•_Ëngth
 = 
shršk_cÚfig
.
š™Ÿl_¡•
;

84 
	gO±imizeLbfgs
<> 
lbfgs
(
log_sÿË
,

85 
lbfgs_İtiÚs
);

87 
št32
 
	gi
 = 0; i < 
	gshršk_cÚfig
.
	gnum_bfgs_™”s
; i++) {

88 
	glog_sÿË
.
CİyFromVec
(
lbfgs
.
G‘Prİo£dV®ue
());

89 
	gobjf
 = 
Compu‹ObjfAndG¿d›Á
(
v®id©iÚ_£t
, 
log_sÿË
,

90 *
Â‘
,

91 &
g¿d›Á
);

93 
KALDI_VLOG
(2è<< "log-sÿË = " << 
	glog_sÿË
 << ", objàğ" << 
	gobjf


94 << ", g¿d›Á = " << 
	gg¿d›Á
;

95 ià(
	gi
 =ğ0è
š™Ÿl_objf
 = 
objf
;

97 
	glbfgs
.
DoS‹p
(
objf
, 
g¿d›Á
);

100 
	glog_sÿË
.
CİyFromVec
(
lbfgs
.
G‘V®ue
(&
objf
));

102 
	gVeùÜ
<
	gBa£Flßt
> 
sÿË
(
log_sÿË
);

103 
	gsÿË
.
AµlyExp
();

104 
	gKALDI_LOG
 << "Shrinking‚net, validation objf…er frame changed from "

105 << 
	gš™Ÿl_objf
 << "Ø" << 
	gobjf
 << ", scale factors…er†ayer‡re "

106 << 
	gsÿË
;

107 
	gÂ‘
->
SÿËCompÚ’ts
(
sÿË
);

	@shrink-nnet.h

20 #iâdeà
KALDI_NNET2_SHRINK_NNET_H_


21 
	#KALDI_NNET2_SHRINK_NNET_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"™f/İtiÚs-™f.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

33 
	sNÃtShrškCÚfig
 {

34 
št32
 
	gnum_bfgs_™”s
;

39 
Ba£Flßt
 
	gš™Ÿl_¡•
;

41 
NÃtShrškCÚfig
(): 
num_bfgs_™”s
(10), 
š™Ÿl_¡•
(0.1) { }

42 
Regi¡”
(
O±iÚsItf
 *
İts
) {

43 
	gİts
->
Regi¡”
("num-bfgs-™”s", &
num_bfgs_™”s
, "Number of iterations of "

45 
	gİts
->
Regi¡”
("š™Ÿl-¡•", &
š™Ÿl_¡•
, "Parameter inhe optimization, "

50 
ShrškNÃt
(cÚ¡ 
NÃtShrškCÚfig
 &
shršk_cÚfig
,

51 cÚ¡ 
¡d
::
veùÜ
<
NÃtExam¶e
> &
v®id©iÚ_£t
,

52 
NÃt
 *
Â‘
);

	@train-nnet-ensemble.cc

21 
	~"Â‘2/Œaš-Â‘-’£mbË.h
"

22 
	~<num”ic
>

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

27 
šlše
 
IÁ32Paœ
 
MakePaœ
(
št32
 
fœ¡
, iÁ32 
£cÚd
) {

28 
IÁ32Paœ
 
	gªs
;

29 
	gªs
.
	gfœ¡
 = 
fœ¡
;

30 
	gªs
.
	g£cÚd
 = 
£cÚd
;

31  
	gªs
;

34 
	gNÃtEn£mbËT¿š”
::
NÃtEn£mbËT¿š”
(

35 cÚ¡ 
NÃtEn£mbËT¿š”CÚfig
 &
cÚfig
,

36 
¡d
::
veùÜ
<
NÃt
*> 
Â‘_’£mbË
):

37 
cÚfig_
(
cÚfig
), 
Â‘_’£mbË_
(
Â‘_’£mbË
) {

38 
	gb‘a_
 = 
cÚfig_
.
b‘a
;

39 
	gnum_pha£s_
 = 0;

40 
boŞ
 
	gfœ¡_time
 = 
Œue
;

41 
BegšNewPha£
(
fœ¡_time
);

44 
	gNÃtEn£mbËT¿š”
::
T¿šOnExam¶e
(cÚ¡ 
NÃtExam¶e
 &
v®ue
) {

45 
bufãr_
.
push_back
(
v®ue
);

46 ià(
	g¡©ic_ÿ¡
<
	gšt32
>(
	gbufãr_
.
size
()è=ğ
cÚfig_
.
mšib©ch_size
)

47 
T¿šOÃMšib©ch
();

50 
	gNÃtEn£mbËT¿š”
::
T¿šOÃMšib©ch
() {

51 
KALDI_ASSERT
(!
bufãr_
.
em±y
());

53 
št32
 
	gnum_¡©es
 = 
Â‘_’£mbË_
[0]->
G‘CompÚ’t
ÒÃt_’£mbË_[0]->
NumCompÚ’ts
(è- 1).
OuutDim
();

55 
	gCuM©rix
<
	gBa£Flßt
> 
po¡_avg
(
bufãr_
.
size
(), 
num_¡©es
);

56 
	gupd©”_’£mbË_
.
»£rve
(
Â‘_’£mbË_
.
size
());

57 
	g¡d
::
veùÜ
<
CuM©rix
<
Ba£Flßt
> > 
po¡_m©
;

58 
	gpo¡_m©
.
»size
(
Â‘_’£mbË_
.
size
());

59 
št32
 
	gi
 = 0; i < 
	gÂ‘_’£mbË_
.
size
(); i++) {

60 
	gupd©”_’£mbË_
.
push_back
(
Ãw
 
NÃtUpd©”
(*(
Â‘_’£mbË_
[
i
]),‚net_ensemble_[i]));

61 
	gupd©”_’£mbË_
[
i
]->
FÜm©IÅut
(
bufãr_
);

62 
	gupd©”_’£mbË_
[
i
]->
Prİag©e
();

64 
	gupd©”_’£mbË_
[
i
]->
G‘Ouut
(&
po¡_m©
[i]);

65 
	gCuVeùÜ
<
	gBa£Flßt
> 
row_sum
(
po¡_m©
[
i
].
NumRows
());

66 
	gpo¡_avg
.
AddM©
(1.0, 
po¡_m©
[
i
]);

71 
	g¡d
::
veùÜ
<
M©rixEËm’t
<
Ba£Flßt
> > 
sv_Ïb–s
;

72 
	g¡d
::
veùÜ
<
IÁ32Paœ
 > 
sv_Ïb–s_šd
;

73 
	gsv_Ïb–s
.
»£rve
(
bufãr_
.
size
());

74 
	gsv_Ïb–s_šd
.
»£rve
(
bufãr_
.
size
());

75 
št32
 
	gm
 = 0; m < 
	gbufãr_
.
size
(); m++) {

76 
KALDI_ASSERT
(
bufãr_
[
m
].
Ïb–s
.
size
() == 1 &&

78 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
št32
,
	gBa£Flßt
> > &
	gÏb–s
 = 
bufãr_
[
m
].
Ïb–s
[0];

79 
size_t
 
	gi
 = 0; i < 
	gÏb–s
.
size
(); i++) {

80 
	gM©rixEËm’t
<
	gBa£Flßt
>

81 
	gtmp
 = {
m
, 
Ïb–s
[
i
].
fœ¡
,†ab–s[i].
£cÚd
};

82 
	gsv_Ïb–s
.
push_back
(
tmp
);

83 
	gsv_Ïb–s_šd
.
push_back
(
MakePaœ
(
m
, 
Ïb–s
[
i
].
fœ¡
));

86 
	gpo¡_avg
.
SÿË
(1.0 / 
Â‘_’£mbË_
.
size
());

87 
	gpo¡_avg
.
SÿË
(
b‘a_
);

88 
	gpo¡_avg
.
AddEËm’ts
(1.0, 
sv_Ïb–s
);

91 
št32
 
	gi
 = 0; i < 
	gÂ‘_’£mbË_
.
size
(); i++) {

92 
	gCuM©rix
<
	gBa£Flßt
> 
tmp_d”iv
(
po¡_m©
[
i
]);

93 
	gpo¡_m©
[
i
].
AµlyLog
();

94 
	g¡d
::
veùÜ
<
Ba£Flßt
> 
log_po¡_cÜ»ù
;

95 
	glog_po¡_cÜ»ù
.
»size
(
sv_Ïb–s_šd
.
size
());

96 
	gpo¡_m©
[
i
].
Lookup
(
sv_Ïb–s_šd
, &(
log_po¡_cÜ»ù
[0]));

97 
Ba£Flßt
 
	glog_´ob_this_Ãt
 = 
¡d
::
accumuÏ‹
(
log_po¡_cÜ»ù
.
begš
(),

98 
log_po¡_cÜ»ù
.
’d
(),

99 
¡©ic_ÿ¡
<
Ba£Flßt
>(0));

100 
	gavg_log´ob_this_pha£_
 +ğ
log_´ob_this_Ãt
;

101 
	gtmp_d”iv
.
Inv”tEËm’ts
();

102 
	gtmp_d”iv
.
MulEËm’ts
(
po¡_avg
);

103 
	gupd©”_’£mbË_
[
i
]->
Back´İ
(&
tmp_d”iv
);

105 
	gcouÁ_this_pha£_
 +ğ
bufãr_
.
size
();

106 
	gbufãr_
.
ş—r
();

107 
	gmšib©ches_£’_this_pha£_
++;

108 ià(
	gmšib©ches_£’_this_pha£_
 =ğ
cÚfig_
.
mšib©ches_³r_pha£
) {

109 
avg_log´ob_this_pha£_
 /ğ
¡©ic_ÿ¡
<
Ba£Flßt
>(
Â‘_’£mbË_
.
size
());

110 
boŞ
 
	gfœ¡_time
 = 
çl£
;

111 
BegšNewPha£
(
fœ¡_time
);

115 
	gNÃtEn£mbËT¿š”
::
BegšNewPha£
(
boŞ
 
fœ¡_time
) {

116 ià(!
fœ¡_time
)

117 
KALDI_LOG
 << "Averaged cross-entropy betweenhe supervision†abels‡ndhe output is "

118 << (
avg_log´ob_this_pha£_
/
couÁ_this_pha£_
) << " over "

119 << 
couÁ_this_pha£_
 << " frames, duringhis…hase";

120 
	gavg_log´ob_this_pha£_
 = 0.0;

121 
	gcouÁ_this_pha£_
 = 0.0;

122 
	gmšib©ches_£’_this_pha£_
 = 0;

123 
	gnum_pha£s_
++;

127 
	gNÃtEn£mbËT¿š”
::~
NÃtEn£mbËT¿š”
() {

128 ià(!
bufãr_
.
em±y
()) {

129 
KALDI_LOG
 << "Doing…artial minibatch of size "

130 << 
bufãr_
.
size
();

131 
T¿šOÃMšib©ch
();

132 ià(
	gmšib©ches_£’_this_pha£_
 != 0) {

133 
boŞ
 
fœ¡_time
 = 
çl£
;

134 
BegšNewPha£
(
fœ¡_time
);

	@train-nnet-ensemble.h

21 #iâdeà
KALDI_NNET2_TRAIN_NNET_ENSEMBLE_H_


22 
	#KALDI_NNET2_TRAIN_NNET_ENSEMBLE_H_


	)

24 
	~"Â‘2/Â‘-upd©e.h
"

25 
	~"Â‘2/Â‘-compu‹.h
"

26 
	~"™f/İtiÚs-™f.h
"

28 
Çme¥aû
 
	gk®di
 {

29 
Çme¥aû
 
	gÂ‘2
 {

32 
	sNÃtEn£mbËT¿š”CÚfig
 {

33 
št32
 
	gmšib©ch_size
;

34 
št32
 
	gmšib©ches_³r_pha£
;

35 
	gb‘a
;

37 
NÃtEn£mbËT¿š”CÚfig
(): 
mšib©ch_size
(500),

38 
mšib©ches_³r_pha£
(50),

39 
b‘a
(0.5) { }

41 
Regi¡”
 (
O±iÚsItf
 *
İts
) {

42 
	gİts
->
Regi¡”
("mšib©ch-size", &
mšib©ch_size
,

44 
	gİts
->
Regi¡”
("mšib©ches-³r-pha£", &
mšib©ches_³r_pha£
,

47 
	gİts
->
Regi¡”
("b‘a", &
b‘a
,

64 şas 
	cNÃtEn£mbËT¿š”
 {

65 
	gpublic
:

66 
NÃtEn£mbËT¿š”
(cÚ¡ 
NÃtEn£mbËT¿š”CÚfig
 &
cÚfig
,

67 
¡d
::
veùÜ
<
NÃt
*> 
Â‘_’£mbË
);

71 
T¿šOnExam¶e
(cÚ¡ 
NÃtExam¶e
 &
v®ue
);

73 ~
NÃtEn£mbËT¿š”
();

74 
	g´iv©e
:

75 
KALDI_DISALLOW_COPY_AND_ASSIGN
(
NÃtEn£mbËT¿š”
);

77 
T¿šOÃMšib©ch
();

81 
BegšNewPha£
(
boŞ
 
fœ¡_time
);

84 
NÃtEn£mbËT¿š”CÚfig
 
	gcÚfig_
;

86 
	g¡d
::
veùÜ
<
NÃt
*> 
Â‘_’£mbË_
;

87 
	g¡d
::
veùÜ
<
NÃtUpd©”
*> 
upd©”_’£mbË_
;

90 
št32
 
	gnum_pha£s_
;

91 
št32
 
	gmšib©ches_£’_this_pha£_
;

92 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
bufãr_
;

95 
	gb‘a_
;

96 
	gavg_log´ob_this_pha£_
;

97 
	gcouÁ_this_pha£_
;

	@train-nnet.cc

20 
	~"Â‘2/Œaš-Â‘.h
"

21 
	~"ut/k®di-th»ad.h
"

23 
Çme¥aû
 
	gk®di
 {

24 
Çme¥aû
 
	gÂ‘2
 {

27 şas 
	cNÃtExam¶eBackgroundR—d”
 {

28 
	gpublic
:

29 
NÃtExam¶eBackgroundR—d”
(
št32
 
mšib©ch_size
,

30 
NÃt
 *
Â‘
,

31 
Sequ’tŸlNÃtExam¶eR—d”
 *
»ad”
):

32 
mšib©ch_size_
(
mšib©ch_size
), 
Â‘_
(
Â‘
), 
»ad”_
(
»ad”
),

33 
fšished_
(
çl£
) {

36 
	gth»ad_
 = 
¡d
::
th»ad
(
Run
, 
this
);

39 
	gcÚsum”_£m­hÜe_
.
SigÇl
();

41 ~
NÃtExam¶eBackgroundR—d”
() {

42 ià(!
	gth»ad_
.
jošabË
())

43 
	gKALDI_ERR
 << "Nohreado join.";

44 
	gth»ad_
.
još
();

49 
R—dExam¶es
() {

50 
KALDI_ASSERT
(
mšib©ch_size_
 > 0);

51 
št32
 
	gmšib©ch_size
 = 
mšib©ch_size_
;

55 
	gŒue
) {

58 
	gcÚsum”_£m­hÜe_
.
Wa™
();

60 
	gexam¶es_
.
ş—r
();

61 
	gexam¶es_
.
»£rve
(
mšib©ch_size
);

63 ; 
	gexam¶es_
.
size
(è< 
	gmšib©ch_size
 && !
	g»ad”_
->
DÚe
();„—d”_->
Next
())

64 
	gexam¶es_
.
push_back
(
»ad”_
->
V®ue
());

71 ià(
	gexam¶es_
.
em±y
()) {

72 
	gfÜm©‹d_exam¶es_
.
Resize
(0, 0);

73 
	gtÙ®_weight_
 = 0.0;

75 
FÜm©NÃtIÅut
(*
Â‘_
, 
exam¶es_
, &
fÜm©‹d_exam¶es_
);

76 
	gtÙ®_weight_
 = 
TÙ®NÃtT¿ššgWeight
(
exam¶es_
);

79 
boŞ
 
	gfšished
 = 
exam¶es_
.
em±y
();

84 
	g´oduûr_£m­hÜe_
.
SigÇl
();

88 ià(
	gfšished
)

94 * 
Run
(*
±r_š
) {

95 
NÃtExam¶eBackgroundR—d”
 *
	g±r
 =

96 
»š‹½»t_ÿ¡
<
NÃtExam¶eBackgroundR—d”
*>(
±r_š
);

97 
	g±r
->
R—dExam¶es
();

98  
	gNULL
;

104 
boŞ
 
G‘NextMšib©ch
(
¡d
::
veùÜ
<
NÃtExam¶e
> *
exam¶es
,

105 
M©rix
<
Ba£Flßt
> *
fÜm©‹d_exam¶es
,

106 *
tÙ®_weight
) {

107 
KALDI_ASSERT
(!
fšished_
);

110 
	g´oduûr_£m­hÜe_
.
Wa™
();

112 
	gexam¶es_
.
sw­
(*
exam¶es
);

113 
	gfÜm©‹d_exam¶es_
.
Sw­
(
fÜm©‹d_exam¶es
);

114 *
	gtÙ®_weight
 = 
tÙ®_weight_
;

118 
	gcÚsum”_£m­hÜe_
.
SigÇl
();

120 ià(
	gexam¶es
->
em±y
()) {

121 
	gfšished_
 = 
Œue
;

122  
	gçl£
;

124  
	gŒue
;

128 
	g´iv©e
:

129 
št32
 
mšib©ch_size_
;

130 
NÃt
 *
	gÂ‘_
;

131 
Sequ’tŸlNÃtExam¶eR—d”
 *
	g»ad”_
;

132 
	g¡d
::
th»ad
 
th»ad_
;

134 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
exam¶es_
;

135 
	gM©rix
<
	gBa£Flßt
> 
	gfÜm©‹d_exam¶es_
;

136 
	gtÙ®_weight_
;

139 
Sem­hÜe
 
	g´oduûr_£m­hÜe_
;

140 
Sem­hÜe
 
	gcÚsum”_£m­hÜe_
;

142 
boŞ
 
	gfšished_
;

147 
št64
 
T¿šNÃtSim¶e
(cÚ¡ 
NÃtSim¶eT¿š”CÚfig
 &
cÚfig
,

148 
NÃt
 *
Â‘
,

149 
Sequ’tŸlNÃtExam¶eR—d”
 *
»ad”
,

150 *
tÙ_weight_±r
,

151 *
tÙ_log´ob_±r
) {

152 
št64
 
	gnum_egs_´oûs£d
 = 0;

153 
	gtÙ_weight
 = 0.0, 
	gtÙ_log´ob
 = 0.0;

154 
NÃtExam¶eBackgroundR—d”
 
background_»ad”
(
cÚfig
.
mšib©ch_size
,

155 
Â‘
, 
»ad”
);

156 
KALDI_ASSERT
(
cÚfig
.
mšib©ches_³r_pha£
 > 0);

157 
	gŒue
) {

161 
	gtÙ_weight_this_pha£
 = 0.0, 
	gtÙ_log´ob_this_pha£
 = 0.0;

163 
št32
 
	gi
;

164 
	gi
 = 0; i < 
	gcÚfig
.
	gmšib©ches_³r_pha£
; i++) {

165 
	g¡d
::
veùÜ
<
NÃtExam¶e
> 
exam¶es
;

166 
	gM©rix
<
	gBa£Flßt
> 
	gexam¶es_fÜm©‹d
;

167 
	gmšib©ch_tÙ®_weight
;

168 ià(!
	gbackground_»ad”
.
G‘NextMšib©ch
(&
exam¶es
, &
exam¶es_fÜm©‹d
,

169 &
mšib©ch_tÙ®_weight
))

171 
	gtÙ_log´ob_this_pha£
 +ğ
DoBack´İ
(*
Â‘
, 
exam¶es
, &
exam¶es_fÜm©‹d
,

172 
Â‘
, 
NULL
);

173 
	gtÙ_weight_this_pha£
 +ğ
mšib©ch_tÙ®_weight
;

174 
	gnum_egs_´oûs£d
 +ğ
exam¶es
.
size
();

176 ià(
	gi
 != 0) {

177 
KALDI_LOG
 << "Training objective function (this…hase) is "

178 << (
tÙ_log´ob_this_pha£
 / 
tÙ_weight_this_pha£
) << " over "

179 << 
tÙ_weight_this_pha£
 << " frames.";

181 
	gtÙ_weight
 +ğ
tÙ_weight_this_pha£
;

182 
	gtÙ_log´ob
 +ğ
tÙ_log´ob_this_pha£
;

183 ià(
	gi
 !ğ
cÚfig
.
mšib©ches_³r_pha£
) {

189 ià(
	gtÙ_weight
 == 0.0) {

190 
KALDI_WARN
 << "No data seen.";

192 
	gKALDI_LOG
 << "Did back´İ oÀ" << 
	gtÙ_weight


194 << (
	gtÙ_log´ob
 / 
	gtÙ_weight
);

195 
	gKALDI_LOG
 << "[this†ine iso be…arsed by‡ script:]†og-prob-per-frame="

196 << (
	gtÙ_log´ob
 / 
	gtÙ_weight
);

198 ià(
	gtÙ_weight_±r
è*tÙ_weight_±¸ğ
tÙ_weight
;

199 ià(
	gtÙ_log´ob_±r
è*tÙ_log´ob_±¸ğ
tÙ_log´ob
;

200  
	gnum_egs_´oûs£d
;

	@train-nnet.h

20 #iâdeà
KALDI_NNET2_TRAIN_NNET_H_


21 
	#KALDI_NNET2_TRAIN_NNET_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"™f/İtiÚs-™f.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

31 
	sNÃtSim¶eT¿š”CÚfig
 {

32 
št32
 
	gmšib©ch_size
;

33 
št32
 
	gmšib©ches_³r_pha£
;

35 
NÃtSim¶eT¿š”CÚfig
(): 
mšib©ch_size
(500),

36 
mšib©ches_³r_pha£
(50) { }

38 
Regi¡”
 (
O±iÚsItf
 *
İts
) {

39 
	gİts
->
Regi¡”
("mšib©ch-size", &
mšib©ch_size
,

41 
	gİts
->
Regi¡”
("mšib©ches-³r-pha£", &
mšib©ches_³r_pha£
,

55 
št64
 
T¿šNÃtSim¶e
(cÚ¡ 
NÃtSim¶eT¿š”CÚfig
 &
cÚfig
,

56 
NÃt
 *
Â‘
,

57 
Sequ’tŸlNÃtExam¶eR—d”
 *
»ad”
,

58 *
tÙ_weight
 = 
NULL
,

59 *
tÙ_log´ob
 = 
NULL
);

	@widen-nnet.cc

20 
	~"Â‘2/wid’-Â‘.h
"

21 
	~"gmm/mod–-commÚ.h
"

22 
	~<num”ic
>

24 
Çme¥aû
 
	gk®di
 {

25 
Çme¥aû
 
	gÂ‘2
 {

28 
	gAffšeCompÚ’t
::
Wid’
(
št32
 
Ãw_dim
,

29 
Ba£Flßt
 
·¿m_¡ddev
,

30 
Ba£Flßt
 
bŸs_¡ddev
,

31 
¡d
::
veùÜ
<
NÚlš—rCompÚ’t
*> 
c2
,

34 
AffšeCompÚ’t
 *
c3
) {

35 
št32
 
	gŞd_dim
 = 
this
->
OuutDim
(), 
	gexŒa_dim
 = 
Ãw_dim
 - 
Şd_dim
;

36 
KALDI_ASSERT
(!
c2
.
em±y
());

37 ià(
	gÃw_dim
 <ğ
Şd_dim
) {

38 
KALDI_WARN
 << "Not widening component because‚ew dim "

39 << 
Ãw_dim
 << " <ğŞd dim " << 
Şd_dim
;

43 
	gthis
->
	gbŸs_·¿ms_
.
Resize
(
Ãw_dim
,

44 
kCİyD©a
);

45 
	gthis
->
	gbŸs_·¿ms_
.
Rªge
(
Şd_dim
, 
exŒa_dim
).
S‘Rªdn
();

46 
	gthis
->
	gbŸs_·¿ms_
.
Rªge
(
Şd_dim
, 
exŒa_dim
).
SÿË
(
bŸs_¡ddev
);

48 
	gthis
->
	glš—r_·¿ms_
.
Resize
(
Ãw_dim
, 
IÅutDim
(), 
kCİyD©a
);

49 
	gthis
->
	glš—r_·¿ms_
.
Rªge
(
Şd_dim
, 
exŒa_dim
,

50 0, 
IÅutDim
()).
S‘Rªdn
();

51 
	gthis
->
	glš—r_·¿ms_
.
Rªge
(
Şd_dim
, 
exŒa_dim
,

52 0, 
IÅutDim
()).
SÿË
(
·¿m_¡ddev
);

54 
size_t
 
	gi
 = 0; i < 
	gc2
.
size
(); i++)

55 
	gc2
[
i
]->
S‘Dim
(
Ãw_dim
);

59 
	gc3
->
	glš—r_·¿ms_
.
Resize
(
c3
->
OuutDim
(), 
Ãw_dim
, 
kCİyD©a
);

62 
Wid’NÃt
(cÚ¡ 
NÃtWid’CÚfig
 &
wid’_cÚfig
,

63 
NÃt
 *
Â‘
) {

65 
št32
 
	gC
 = 
Â‘
->
NumCompÚ’ts
();

66 
št32
 
	gnum_wid’ed
 = 0;

68 
št32
 
	gc
 = 0; c < 
	gC
 - 3; c++) {

69 
AffšeCompÚ’t
 *
	gc1
 = 
dyÇmic_ÿ¡
<AffšeCompÚ’t*>(&(
Â‘
->
G‘CompÚ’t
(
c
)));

70 ià(
	gc1
 =ğ
NULL
) ;

71 
	g¡d
::
veùÜ
<
NÚlš—rCompÚ’t
*> 
c2
;

72 
	gc2
.
push_back
(
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
Â‘
->
G‘CompÚ’t
(
c
+1))));

73 ià(
	gc2
.
back
(è=ğ
NULL
) ;

74 
	gc2
.
push_back
(
dyÇmic_ÿ¡
<
NÚlš—rCompÚ’t
*>(&(
Â‘
->
G‘CompÚ’t
(
c
+2))));

75 
AffšeCompÚ’t
 *
	gc3
;

76 ià(
	gc2
.
back
(è=ğ
NULL
) {

77 
c2
.
pİ_back
();

78 
	gc3
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(&(
Â‘
->
G‘CompÚ’t
(
c
+2)));

80 ià(
	gc
 + 3 >ğ
C
) ;

81 
	gc3
 = 
dyÇmic_ÿ¡
<
AffšeCompÚ’t
*>(&(
Â‘
->
G‘CompÚ’t
(
c
+3)));

83 ià(
	gc3
 =ğ
NULL
) ;

84 
Ba£Flßt
 
	g·¿m_¡ddev
 = 
wid’_cÚfig
.
·¿m_¡ddev_çùÜ
 /

85 
sq¹
(1.0 * 
c1
->
IÅutDim
());

86 
	gKALDI_LOG
 << "Wid’šg compÚ’ˆ" << 
	gc
 << " from "

87 << 
	gc1
->
OuutDim
(è<< "Ø" << 
	gwid’_cÚfig
.
	ghidd’_Ïy”_dim
;

89 
	gc1
->
Wid’
(
wid’_cÚfig
.
hidd’_Ïy”_dim
,

90 
·¿m_¡ddev
, 
wid’_cÚfig
.
bŸs_¡ddev
,

91 
c2
, 
c3
);

92 
	gnum_wid’ed
++;

94 
	gÂ‘
->
Check
();

95 
	gKALDI_LOG
 << "Wid’ed " << 
	gnum_wid’ed
 << " components.";

	@widen-nnet.h

20 #iâdeà
KALDI_NNET2_WIDEN_NNET_H_


21 
	#KALDI_NNET2_WIDEN_NNET_H_


	)

23 
	~"Â‘2/Â‘-upd©e.h
"

24 
	~"Â‘2/Â‘-compu‹.h
"

25 
	~"™f/İtiÚs-™f.h
"

27 
Çme¥aû
 
	gk®di
 {

28 
Çme¥aû
 
	gÂ‘2
 {

33 
	sNÃtWid’CÚfig
 {

34 
št32
 
	ghidd’_Ïy”_dim
;

35 
Ba£Flßt
 
	g·¿m_¡ddev_çùÜ
;

36 
Ba£Flßt
 
	gbŸs_¡ddev
;

38 
NÃtWid’CÚfig
(): 
hidd’_Ïy”_dim
(-1),

39 
·¿m_¡ddev_çùÜ
(1.0),

40 
bŸs_¡ddev
(0.5) { }

42 
Regi¡”
(
O±iÚsItf
 *
İts
) {

43 
	gİts
->
Regi¡”
("hidd’-Ïy”-dim", &
hidd’_Ïy”_dim
, "[required option]: "

45 
	gİts
->
Regi¡”
("·¿m-¡ddev-çùÜ", &
·¿m_¡ddev_çùÜ
, "Factor in "

48 
	gİts
->
Regi¡”
("bŸs-¡ddev", &
bŸs_¡ddev
, "Standard deviation of‡dded "

57 
Wid’NÃt
(cÚ¡ 
NÃtWid’CÚfig
 &
wid’_cÚfig
,

58 
NÃt
 *
Â‘
);

	@
1
.
1
/usr/include
65
1285
am-nnet-test.cc
am-nnet.cc
am-nnet.h
combine-nnet-a.cc
combine-nnet-a.h
combine-nnet-fast.cc
combine-nnet-fast.h
combine-nnet.cc
combine-nnet.h
decodable-am-nnet.h
get-feature-transform.cc
get-feature-transform.h
mixup-nnet.cc
mixup-nnet.h
nnet-component-test.cc
nnet-component.cc
nnet-component.h
nnet-compute-discriminative-parallel.cc
nnet-compute-discriminative-parallel.h
nnet-compute-discriminative.cc
nnet-compute-discriminative.h
nnet-compute-online.cc
nnet-compute-online.h
nnet-compute-test.cc
nnet-compute.cc
nnet-compute.h
nnet-example-functions-test.cc
nnet-example-functions.cc
nnet-example-functions.h
nnet-example.cc
nnet-example.h
nnet-fix.cc
nnet-fix.h
nnet-functions.cc
nnet-functions.h
nnet-limit-rank.cc
nnet-limit-rank.h
nnet-nnet-test.cc
nnet-nnet.cc
nnet-nnet.h
nnet-precondition-online-test.cc
nnet-precondition-online.cc
nnet-precondition-online.h
nnet-precondition-test.cc
nnet-precondition.cc
nnet-precondition.h
nnet-stats.cc
nnet-stats.h
nnet-update-parallel.cc
nnet-update-parallel.h
nnet-update.cc
nnet-update.h
online-nnet2-decodable-test.cc
online-nnet2-decodable.cc
online-nnet2-decodable.h
rescale-nnet.cc
rescale-nnet.h
shrink-nnet.cc
shrink-nnet.h
train-nnet-ensemble.cc
train-nnet-ensemble.h
train-nnet.cc
train-nnet.h
widen-nnet.cc
widen-nnet.h
